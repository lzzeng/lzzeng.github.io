<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="viewport" content="width=device-width">
<meta name="google-site-verification" content="V4j2XKWJOKRE9YZT6Bh0vioT5VWrnimuwjmS6cyIuJ8">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="ELK,">










<meta name="description" content="为了将测试环境、仿真环境和生产环境的ELK合并为一个部署到K8s中管理，作一些测试验证，并尝试集成STS单点登录。  测试NFS可用性  测试应用使用的MySQL数据目录是通过NFS挂载的，每GET请求一次 http://192.168.100.157:9000/visit/add/ 会新增一条记录到数据库。通过脚本每0.01秒请求一次，共请求10000次的过程中：当人为停止NFS服务时，MyS">
<meta name="keywords" content="ELK">
<meta property="og:type" content="article">
<meta property="og:title" content="ELK整改部署">
<meta property="og:url" content="https://lzzeng.github.io/log-analysis/k8s-elk-improvement/index.html">
<meta property="og:site_name" content="Zeng&#39;s Page">
<meta property="og:description" content="为了将测试环境、仿真环境和生产环境的ELK合并为一个部署到K8s中管理，作一些测试验证，并尝试集成STS单点登录。  测试NFS可用性  测试应用使用的MySQL数据目录是通过NFS挂载的，每GET请求一次 http://192.168.100.157:9000/visit/add/ 会新增一条记录到数据库。通过脚本每0.01秒请求一次，共请求10000次的过程中：当人为停止NFS服务时，MyS">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582856249817.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582772220081.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582772345348.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582773231870.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582774172498.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582774922290.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582775406309.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582785238406.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582786894380.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582786693455.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582787118597.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582881482944.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582881659083.png">
<meta property="og:updated_time" content="2022-02-20T15:52:53.680Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ELK整改部署">
<meta name="twitter:description" content="为了将测试环境、仿真环境和生产环境的ELK合并为一个部署到K8s中管理，作一些测试验证，并尝试集成STS单点登录。  测试NFS可用性  测试应用使用的MySQL数据目录是通过NFS挂载的，每GET请求一次 http://192.168.100.157:9000/visit/add/ 会新增一条记录到数据库。通过脚本每0.01秒请求一次，共请求10000次的过程中：当人为停止NFS服务时，MyS">
<meta name="twitter:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582856249817.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lzzeng.github.io/log-analysis/k8s-elk-improvement/">





  <title>ELK整改部署 | Zeng's Page</title>
  








  <script src="/js/src/photoswipe.js?v=5.1.4"></script>
  <script src="/js/src/photoswipe-ui-default.js?v=5.1.4"></script>
</head>

<body itemscope itemtype="https://schema.org/WebPage" lang="default">

  

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="https://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zeng's Page</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-photos">
          <a href="/photos/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-photo"></i> <br>
            
            相册
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="https://schema.org/Article">
  
  
  
  <div class="post-block" id="container">
    <link itemprop="mainEntityOfPage" href="https://lzzeng.github.io/log-analysis/k8s-elk-improvement/">

    <span hidden itemprop="author" itemscope itemtype="https://schema.org/Person">
      <meta itemprop="name" content="Lz. Zeng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
      <meta itemprop="name" content="Zeng's Page">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ELK整改部署</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-02-28T23:00:00+00:00">
                2020-02-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/ELK/" itemprop="url" rel="index">
                    <span itemprop="name">ELK</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          		 

        </div>
      </header>
    	
	
	
		<script type="text/javascript">
			function showToc(){
				var toc_article = document.getElementById("toc-article");
				var show_toc_btn = document.getElementById("show-toc-btn");			
				toc_article.setAttribute("style","display:block");
				show_toc_btn.setAttribute("style","display:none");
			};
			function showBtn(){
				var toc_article = document.getElementById("toc-article");
				var show_toc_btn = document.getElementById("show-toc-btn");
				toc_article.setAttribute("style","display:none");
				show_toc_btn.setAttribute("style","display:block");
			};
		</script>
		
		<div id="my-toc">
			<p class="show-toc-btn" id="show-toc-btn" onclick="showToc();">
				<span class="btn-bg"></span>
				<span class="btn-text">目录</span>
			</p>
			<div id="toc-article" class="toc-article" style="display:none">
				<span id="toc-close" class="toc-close" title="隐藏" onclick="showBtn();">×</span>
				<strong class="toc-title">文章目录</strong>
				<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试NFS可用性"><span class="toc-number">1.</span> <span class="toc-text">测试NFS可用性</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#NFS供应节点"><span class="toc-number">1.1.</span> <span class="toc-text">NFS供应节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试节点"><span class="toc-number">1.2.</span> <span class="toc-text">测试节点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查看数据库"><span class="toc-number">1.3.</span> <span class="toc-text">查看数据库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PV数据恢复验证"><span class="toc-number">2.</span> <span class="toc-text">PV数据恢复验证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#文档写入、更新"><span class="toc-number">2.1.</span> <span class="toc-text">文档写入、更新</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改请求的容量"><span class="toc-number">2.2.</span> <span class="toc-text">修改请求的容量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#不删PV仅修改编排的容量需求"><span class="toc-number">2.2.1.</span> <span class="toc-text">不删PV仅修改编排的容量需求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删PV重建ES"><span class="toc-number">2.2.2.</span> <span class="toc-text">删PV重建ES</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据迁移到新的集群"><span class="toc-number">2.3.</span> <span class="toc-text">数据迁移到新的集群</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建一个新ELK环境"><span class="toc-number">2.3.1.</span> <span class="toc-text">创建一个新ELK环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#复制迁移数据"><span class="toc-number">2.3.2.</span> <span class="toc-text">复制迁移数据</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ES账号设置"><span class="toc-number">3.</span> <span class="toc-text">ES账号设置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#用户组权限设置"><span class="toc-number">3.1.</span> <span class="toc-text">用户组权限设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#设置指定用户的权限"><span class="toc-number">3.2.</span> <span class="toc-text">设置指定用户的权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引名称规范"><span class="toc-number">3.3.</span> <span class="toc-text">索引名称规范</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ELK集成STS登录调试过程记录"><span class="toc-number">4.</span> <span class="toc-text">ELK集成STS登录调试过程记录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用配置字典的方式"><span class="toc-number">4.1.</span> <span class="toc-text">使用配置字典的方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用环境变量-保密字典的方式"><span class="toc-number">4.2.</span> <span class="toc-text">使用环境变量+保密字典的方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#initContainers方式"><span class="toc-number">4.3.</span> <span class="toc-text">initContainers方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接修改es镜像的方式"><span class="toc-number">4.4.</span> <span class="toc-text">直接修改es镜像的方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#postStart方式"><span class="toc-number">4.5.</span> <span class="toc-text">postStart方式</span></a></li></ol></li></ol>
			</div>
		</div>
	

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>为了将测试环境、仿真环境和生产环境的ELK合并为一个部署到K8s中管理，作一些测试验证，并尝试集成STS单点登录。</p>
</blockquote>
<h2 id="测试NFS可用性"><a href="#测试NFS可用性" class="headerlink" title="测试NFS可用性"></a>测试NFS可用性</h2><blockquote>
<p> 测试应用使用的MySQL数据目录是通过NFS挂载的，每GET请求一次 <code>http://192.168.100.157:9000/visit/add/</code> 会新增一条记录到数据库。通过脚本每0.01秒请求一次，共请求10000次的过程中：当人为停止NFS服务时，MySQL数据目录挂载失效，导致请求接口无法访问；重新开启NFS服务后，恢复正常，并且最终记录总数一致。</p>
</blockquote>
<a id="more"></a>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582856249817.png" alt="1582856249817"></p>
<h3 id="NFS供应节点"><a href="#NFS供应节点" class="headerlink" title="NFS供应节点"></a>NFS供应节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 elk]<span class="comment"># cat /etc/exports</span></span><br><span class="line">/testPV *(rw,sync)</span><br><span class="line">/helloPV *(rw,no_root_squash,async)</span><br></pre></td></tr></table></figure>
<h3 id="测试节点"><a href="#测试节点" class="headerlink" title="测试节点"></a>测试节点</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@157-xxl-job testPV]<span class="comment"># df -h</span></span><br><span class="line">Filesystem                Size  Used Avail Use% Mounted on</span><br><span class="line">...</span><br><span class="line">192.168.100.150:/helloPV  292G   42G  250G  15% /helloPV</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">'Asia/Shanghai'</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">qwerasdf</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">testpv</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">['mysqld',</span> <span class="string">'--character-set-server=utf8'</span><span class="string">]</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"/helloPV/db:/var/lib/mysql"</span></span><br></pre></td></tr></table></figure>
<h3 id="查看数据库"><a href="#查看数据库" class="headerlink" title="查看数据库"></a>查看数据库</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select count(id) from visit_record;</span><br><span class="line">+-----------+</span><br><span class="line">| count(id) |</span><br><span class="line">+-----------+</span><br><span class="line">|      9999 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from visit_record <span class="built_in">limit</span> 1;</span><br><span class="line">+----+----------------------+----------------------------+</span><br><span class="line">| id | ip_addr              | visit_date                 |</span><br><span class="line">+----+----------------------+----------------------------+</span><br><span class="line">|  1 | 192.168.100.157:9000 | 2020-02-28 01:13:38.370327 |</span><br><span class="line">+----+----------------------+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from visit_record order by id desc <span class="built_in">limit</span> 1;</span><br><span class="line">+------+----------------------+----------------------------+</span><br><span class="line">| id   | ip_addr              | visit_date                 |</span><br><span class="line">+------+----------------------+----------------------------+</span><br><span class="line">| 9999 | 192.168.100.157:9000 | 2020-02-28 01:18:10.755606 |</span><br><span class="line">+------+----------------------+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="PV数据恢复验证"><a href="#PV数据恢复验证" class="headerlink" title="PV数据恢复验证"></a>PV数据恢复验证</h2><h3 id="文档写入、更新"><a href="#文档写入、更新" class="headerlink" title="文档写入、更新"></a>文档写入、更新</h3><ul>
<li>初始写入2个文档</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/1?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:50:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/2?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:51:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green2"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>更新文档</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/1?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:54:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green3"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/2?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:54:02",</span></span><br><span class="line"><span class="string">  "name": "Jim Green4"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582772220081.png" alt="1582772220081"></p>
<ul>
<li>增加2个文档</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/3?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:58:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green5"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/4?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:58:02",</span></span><br><span class="line"><span class="string">  "name": "Jim Green6"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582772345348.png" alt="1582772345348"></p>
<h3 id="修改请求的容量"><a href="#修改请求的容量" class="headerlink" title="修改请求的容量"></a>修改请求的容量</h3><p>NFS StorageClass Provider自动为ES创建的PV目录为：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 ~]<span class="comment"># ls /testPV/</span></span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<h4 id="不删PV仅修改编排的容量需求"><a href="#不删PV仅修改编排的容量需求" class="headerlink" title="不删PV仅修改编排的容量需求"></a>不删PV仅修改编排的容量需求</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 原先20Gi</span></span><br><span class="line"><span class="attr">volumeClaimTemplates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">es-data</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">storageClassName:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">storage:</span> <span class="string">40Gi</span></span><br></pre></td></tr></table></figure>
<p>重新部署ES</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl apply -f es-ss.yml </span></span><br><span class="line">The StatefulSet <span class="string">"elasticsearch"</span> is invalid: spec: Forbidden: updates to statefulset spec <span class="keyword">for</span> fields other than <span class="string">'replicas'</span>, <span class="string">'template'</span>, and <span class="string">'updateStrategy'</span> are forbidden</span><br></pre></td></tr></table></figure>
<p>因为是statefulset.apps，提示不能直接apply，先delete再apply</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl delete -f es-ss.yml </span></span><br><span class="line">statefulset.apps <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl apply -f es-ss.yml </span></span><br><span class="line">statefulset.apps/elasticsearch created</span><br></pre></td></tr></table></figure>
<p>PV目录未变化，并且从Kibana查看数据还是容量变更前的样子</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582773231870.png" alt="1582773231870"></p>
<p>说明不删除已创建的PV情况下，修改请求PV容量值<code>resources.requests.storage</code>，不影响已有数据。</p>
<h4 id="删PV重建ES"><a href="#删PV重建ES" class="headerlink" title="删PV重建ES"></a>删PV重建ES</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># sh run-es.sh down</span></span><br><span class="line">ingress.extensions <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">service <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">statefulset.apps <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">configmap <span class="string">"es-config"</span> deleted</span><br><span class="line">secret <span class="string">"rp-client-secret"</span> deleted</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl delete pvc -n yhelk es-data-elasticsearch-0</span></span><br><span class="line">persistentvolumeclaim <span class="string">"es-data-elasticsearch-0"</span> deleted</span><br><span class="line"></span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># sh run-es.sh</span></span><br><span class="line">namespace/yhelk unchanged</span><br><span class="line">secret/rp-client-secret created</span><br><span class="line">configmap/es-config created</span><br><span class="line">statefulset.apps/elasticsearch created</span><br><span class="line">service/elasticsearch created</span><br><span class="line">ingress.extensions/elasticsearch created</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582774172498.png" alt="1582774172498"></p>
<p>删除PV后，PV目录被归档</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<p>重建后，生成了新的PV目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<p>显然，之前的保存的文档不在新目录中，查看Kibana也显示没有任何索引：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582774922290.png" alt="1582774922290"></p>
<p>尝试恢复旧数据如下：</p>
<p>通过移动归档的PV目录替换现在使用的PV目录，并删除es的pod以使其被重新调度：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># mv /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1/ /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1.old</span></span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1.old</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># mv /testPV/archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1/ /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1</span></span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1</span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1.old</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl get pod -n yhelk</span></span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">elasticsearch-0           1/1     Running   0          7m17s</span><br><span class="line">kibana-6564b7c688-bvmf4   1/1     Running   0          61m</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl delete pod -n yhelk elasticsearch-0 </span></span><br><span class="line">pod <span class="string">"elasticsearch-0"</span> deleted</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl get pod -n yhelk</span></span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">elasticsearch-0           1/1     Running   0          16s</span><br><span class="line">kibana-6564b7c688-bvmf4   1/1     Running   0          62m</span><br></pre></td></tr></table></figure>
<p>待kibana重新连接es后，显示旧文档已恢复：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582775406309.png" alt="1582775406309"></p>
<hr>
<h3 id="数据迁移到新的集群"><a href="#数据迁移到新的集群" class="headerlink" title="数据迁移到新的集群"></a>数据迁移到新的集群</h3><h4 id="创建一个新ELK环境"><a href="#创建一个新ELK环境" class="headerlink" title="创建一个新ELK环境"></a>创建一个新ELK环境</h4><p>在另一个名称空间 yhelk2 再创建一个ELK环境：</p>
<p>对应的PV目录：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582785238406.png" alt="1582785238406"></p>
<h4 id="复制迁移数据"><a href="#复制迁移数据" class="headerlink" title="复制迁移数据"></a>复制迁移数据</h4><p>先删除刚创建出来的ES，仅保留PVC和PV。如果删除PVC（和PV），原数据（目录）会被归档，重新部署后会重建PV。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582786894380.png" alt="1582786894380"></p>
<p>再将对应yhelk空间的原有ELK环境的PV目录复制一份替换新ELK环境的PV目录</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv /testPV/yhelk2-es-data-elasticsearch-0-pvc-a2488669-5929-11ea-ac5d-005056a941c1&#123;,.old&#125;</span><br><span class="line"></span><br><span class="line">cp -rp /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1  /testPV/yhelk2-es-data-elasticsearch-0-pvc-a2488669-5929-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582786693455.png" alt="1582786693455"></p>
<p>重建yhelk2空间的ES，因对应的PV目录名称不变，将会加载该目录中的数据。在Kibana中可以看到，新、旧环境ELK中的索引、文档是相同的：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582787118597.png" alt="1582787118597"></p>
<blockquote>
<p>这说明两个不同名称空间的ELK集群的数据，可以通过复制数据目录的方式从一个环境迁移到另一个。可以作出合理推测：1. 如果两个ES集群的节点数一样（对应的PV目录数一样），数据可以通过直接复制的方式迁移。2. ES对供应PV的NFS文件系统是无感知的，NFS文件系统自身扩容、缩容，只要满足pod需求，数据就可以正常使用。</p>
</blockquote>
<hr>
<h2 id="ES账号设置"><a href="#ES账号设置" class="headerlink" title="ES账号设置"></a>ES账号设置</h2><p>启用了AD认证后，除了几个内置的用户和已授权的AD账号外，新创建的用户（未被AD管理的）无法使用：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"error"</span> : &#123;</span><br><span class="line">    <span class="string">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">        <span class="string">"reason"</span> : <span class="string">"unable to authenticate user [etms_dev] for REST request [/dev.etms.abc/_doc/1?pretty]"</span>,</span><br><span class="line">        <span class="string">"header"</span> : &#123;</span><br><span class="line">          <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"security\" charset=\"UTF-8\""</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">    <span class="string">"reason"</span> : <span class="string">"unable to authenticate user [etms_dev] for REST request [/dev.etms.abc/_doc/1?pretty]"</span>,</span><br><span class="line">    <span class="string">"header"</span> : &#123;</span><br><span class="line">      <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"security\" charset=\"UTF-8\""</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"status"</span> : 401</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="用户组权限设置"><a href="#用户组权限设置" class="headerlink" title="用户组权限设置"></a>用户组权限设置</h3><p>只能设置两类权限</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">PUT /_security/role_mapping/admins</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"roles"</span> : [ <span class="string">"superuser"</span> ],</span><br><span class="line">  <span class="string">"rules"</span> : &#123;</span><br><span class="line">    <span class="string">"field"</span> : &#123;</span><br><span class="line">      <span class="string">"groups"</span> : <span class="string">"CN=elk_admin,OU=Elasticsearch,OU=系统帐号,DC=keep,DC=com"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT  /_security/role_mapping/basic_users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"enabled"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"roles"</span> : [</span><br><span class="line">      <span class="string">"kibana_user"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"rules"</span> : &#123;</span><br><span class="line">      <span class="string">"any"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field"</span> : &#123;</span><br><span class="line">            <span class="string">"groups"</span> : <span class="string">"CN=elk_user,OU=Elasticsearch,OU=系统帐号,DC=keep,DC=com"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="设置指定用户的权限"><a href="#设置指定用户的权限" class="headerlink" title="设置指定用户的权限"></a>设置指定用户的权限</h3><blockquote>
<p>刚开始所有用户要么属于elk_admin组，要么属于elk_user组，并具有对应的两类权限。如果要进一步单独设置组内某个用户的权限，可按以下步骤进行：</p>
</blockquote>
<ul>
<li>先按传统方法添加一个包含所需权限的角色</li>
<li>在kibana手动创建一个与AD账号同名的用户，密码随意设置，并与刚刚创建的角色绑定</li>
<li>以该用户名及相应的AD密码登录Kibana即可发现权限已变更</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看、删除admins的role_mapping</span></span><br><span class="line">GET /_security/role_mapping/admins</span><br><span class="line">DELETE /_security/role_mapping/admins</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看、删除basic_users的role_mapping</span></span><br><span class="line">GET /_security/role_mapping/basic_users</span><br><span class="line">DELETE /_security/role_mapping/basic_users</span><br><span class="line"></span><br><span class="line">PUT /_security/role_mapping/admins</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"roles"</span> : [ <span class="string">"superuser"</span> ],</span><br><span class="line">  <span class="string">"rules"</span> : &#123;</span><br><span class="line">    <span class="string">"field"</span> : &#123;</span><br><span class="line">      <span class="string">"groups"</span> : <span class="string">"CN=elk_admin,OU=Elasticsearch,OU=系统帐号,DC=keep,DC=com"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT  /_security/role_mapping/basic_users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"enabled"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"roles"</span> : [</span><br><span class="line">      <span class="string">"kibana_user"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"rules"</span> : &#123;</span><br><span class="line">      <span class="string">"any"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field"</span> : &#123;</span><br><span class="line">            <span class="string">"groups"</span> : <span class="string">"CN=elk_user,OU=Elasticsearch,OU=系统帐号,DC=keep,DC=com"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="索引名称规范"><a href="#索引名称规范" class="headerlink" title="索引名称规范"></a>索引名称规范</h3><p><strong>建议按</strong></p>
<p><code>&lt;环境名称&gt;.&lt;系统&gt;[.&lt;应用&gt;][.&lt;日志类型&gt;]_&lt;YYYY.MM.dd&gt;</code></p>
<p>的形式取索引名称，例如：</p>
<p><code>dev.etms.webhost.error-log_2020.02.28</code></p>
<p>据以上，可以针对 项目组及个人设置ELK权限。比如设置ETMS组成员dev环境的权限：</p>
<ol>
<li>创建角色<code>role_etms_dev</code></li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">PUT /_security/role/role_etms_dev</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"cluster"</span> : [ ],</span><br><span class="line">    <span class="string">"indices"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"names"</span> : [</span><br><span class="line">          <span class="string">"dev.etms.*"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"privileges"</span> : [</span><br><span class="line">          <span class="string">"all"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"field_security"</span> : &#123;</span><br><span class="line">          <span class="string">"grant"</span> : [</span><br><span class="line">            <span class="string">"*"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">"except"</span> : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"allow_restricted_indices"</span> : <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"applications"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"application"</span> : <span class="string">"kibana-.kibana"</span>,</span><br><span class="line">        <span class="string">"privileges"</span> : [</span><br><span class="line">          <span class="string">"feature_discover.all"</span>,</span><br><span class="line">          <span class="string">"feature_visualize.all"</span>,</span><br><span class="line">          <span class="string">"feature_dashboard.all"</span>,</span><br><span class="line">          <span class="string">"feature_dev_tools.all"</span>,</span><br><span class="line">          <span class="string">"feature_indexPatterns.all"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"resources"</span> : [</span><br><span class="line">          <span class="string">"space:default"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"run_as"</span> : [ ],</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">"transient_metadata"</span> : &#123;</span><br><span class="line">      <span class="string">"enabled"</span> : <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建etms组成员AD账号同名的ES账号并绑定角色</li>
</ol>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582881482944.png" alt="1582881482944"></p>
<ol start="3">
<li>登录查看效果</li>
</ol>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582881659083.png" alt="1582881659083"></p>
<hr>
<h2 id="ELK集成STS登录调试过程记录"><a href="#ELK集成STS登录调试过程记录" class="headerlink" title="ELK集成STS登录调试过程记录"></a>ELK集成STS登录调试过程记录</h2><blockquote>
<p>因为ES不支持在配置文件中直接配置：rp.client_secret ，以及其它一些集成OpenID的参数设置不清晰，作了如下大量尝试：</p>
</blockquote>
<h3 id="使用配置字典的方式"><a href="#使用配置字典的方式" class="headerlink" title="使用配置字典的方式"></a>使用配置字典的方式</h3><p>OIDC realm配置到es-cm.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment">#role_mapping.yml: |-</span></span><br><span class="line">  <span class="comment">#  kibana_user:</span></span><br><span class="line">  <span class="comment">#    - "CN=elk_user,OU=系统帐号,DC=keep,DC=com"</span></span><br><span class="line">  <span class="comment">#    - "CN=堡垒机,CN=Users,DC=keep,DC=com"</span></span><br><span class="line">  <span class="comment">#  superuser:</span></span><br><span class="line">  <span class="comment">#    - "CN=elk_admin,OU=系统帐号,DC=keep,DC=com"</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">elasticsearch.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">cluster.name:</span> <span class="string">"docker-cluster"</span></span><br><span class="line">    <span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line">    <span class="attr">xpack.security.authc.realms.active_directory:</span></span><br><span class="line">      <span class="attr">my_ad:</span></span><br><span class="line">        <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">domain_name:</span> <span class="string">keep.com</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">ldap://192.168.100.120:389,</span> <span class="string">ldap://192.168.100.129:389</span></span><br><span class="line">        <span class="attr">bind_dn:</span> <span class="string">xxx@keep.com</span></span><br><span class="line">        <span class="attr">bind_password:</span> <span class="string">******</span></span><br><span class="line">        <span class="attr">load_balance:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">"round_robin"</span></span><br><span class="line">        <span class="attr">user_search:</span></span><br><span class="line">          <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">          <span class="attr">filter:</span> <span class="string">"(&amp;(objectClass=user)(sAMAccountName=&#123;0&#125;))"</span></span><br><span class="line">        <span class="attr">group_search:</span></span><br><span class="line">          <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">        <span class="comment">#files:</span></span><br><span class="line">        <span class="comment">#  role_mapping: "/usr/share/elasticsearch/config/role_mapping.yml"</span></span><br><span class="line">        <span class="comment">#unmapped_groups_as_roles: true</span></span><br><span class="line">    <span class="attr">xpack.security.authc.realms.oidc.oidc1:</span></span><br><span class="line">      <span class="attr">order:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">rp.client_id:</span> <span class="string">"kibana"</span></span><br><span class="line">      <span class="comment"># rp.client_secret: "secret"  # rp.client_secret 不能这样写在配置文件，有下面报错信息</span></span><br><span class="line">      <span class="attr">rp.response_type:</span> <span class="string">code</span></span><br><span class="line">      <span class="attr">rp.requested_scopes:</span> <span class="string">[openid,profile]</span></span><br><span class="line">      <span class="attr">rp.redirect_uri:</span> <span class="string">"http://kibana.staging.keep.com/api/security/v1/oidc"</span></span><br><span class="line">      <span class="attr">rp.post_logout_redirect_uri:</span> <span class="string">"http://kibana.staging.keep.com/logged_out"</span></span><br><span class="line">      <span class="attr">op.issuer:</span> <span class="string">"https://sts.keep.cn"</span></span><br><span class="line">      <span class="attr">op.authorization_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/authorize"</span></span><br><span class="line">      <span class="attr">op.token_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/token"</span></span><br><span class="line">      <span class="comment">#op.userinfo_endpoint: "http://sts.staging.keep.com/connect/userinfo"</span></span><br><span class="line">      <span class="comment">#op.end_session_endpoint: "http://sts.staging.keep.com/connect/endsession"</span></span><br><span class="line">      <span class="attr">claims.principal:</span> <span class="string">email_verified</span></span><br><span class="line">      <span class="attr">claim_patterns.principal:</span> <span class="string">"^([^@]+)@keep\\.com$"</span></span><br></pre></td></tr></table></figure>
<p>kb-cm.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xpack.security.authc.providers:</span> <span class="string">[oidc,</span> <span class="string">basic]</span></span><br><span class="line"><span class="attr">xpack.security.authc.oidc.realm:</span> <span class="string">"oidc1"</span></span><br><span class="line"><span class="attr">server.xsrf.whitelist:</span> <span class="string">[/api/security/v1/oidc,</span> <span class="string">/logged_out]</span></span><br></pre></td></tr></table></figure>
<p>错误信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;Caused by: java.lang.IllegalArgumentException: unknown setting [xpack.security.authc.realms.oidc.oidc1.op.end_session_endpoint] please check that any required plugins are installed, or check the breaking changes documentation for removed settings&quot;,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is a secure setting and must be stored inside the Elasticsearch keystore, but was found inside elasticsearch.yml&quot;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>遇到的异常主要有：</p>
<ul>
<li><p>[xpack.security.authc.realms.oidc.oidc1.op.end_session_endpoint] please check that any required plugins are installed, or check the breaking changes documentation for removed settings”</p>
</li>
<li><p>Setting [xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is a secure setting and must be stored inside the Elasticsearch keystore, but was found inside elasticsearch.yml</p>
</li>
<li><p>java.lang.IllegalStateException: security initialization failed”</p>
<p>The configuration setting [xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is required”</p>
</li>
</ul>
<h3 id="使用环境变量-保密字典的方式"><a href="#使用环境变量-保密字典的方式" class="headerlink" title="使用环境变量+保密字典的方式"></a>使用环境变量+保密字典的方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rp-client-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">xpack.security.authc.realms.oidc.oidc1.rp.client_secret:</span> <span class="string">c2VjcmV0Cg==</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"xpack.security.authc.realms.oidc.oidc1.rp.client_secret"</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">secretKeyRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">rp-client-secret</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret</span></span><br></pre></td></tr></table></figure>
<p>报错同上，失败</p>
<h3 id="initContainers方式"><a href="#initContainers方式" class="headerlink" title="initContainers方式"></a>initContainers方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">lzzeng/es-xpack:7.5.1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">inites</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span>                </span><br><span class="line">        <span class="string">echo</span> <span class="string">-e</span> <span class="string">"y\nsecret"</span> <span class="string">|</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">add</span> <span class="string">--stdin</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret</span></span><br><span class="line">        <span class="string">exit</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">subPath:</span> <span class="string">elasticsearch.keystore</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/config/elasticsearch.keystore</span></span><br></pre></td></tr></table></figure>
<p>企图通过initContainer与es共享配置的方式设置rp.client_secret，initContainer正常初始化后，es pod异常退出，主要错误原因如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@zabbix02 4cp-err]<span class="comment"># kubectl logs -f -n yhelk elasticsearch-0 </span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.IllegalStateException: unable to <span class="built_in">read</span> from standard input; is standard input open and a tty attached?</span><br><span class="line">	at org.elasticsearch.cli.Terminal<span class="variable">$SystemTerminal</span>.readText(Terminal.java:207)</span><br><span class="line">	at org.elasticsearch.cli.Terminal.promptYesNo(Terminal.java:140)</span><br><span class="line">	at org.elasticsearch.common.settings.CreateKeyStoreCommand.execute(CreateKeyStoreCommand.java:43)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:125)</span><br><span class="line">	at org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:77)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:125)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:90)</span><br><span class="line">	at org.elasticsearch.common.settings.KeyStoreCli.main(KeyStoreCli.java:41)</span><br></pre></td></tr></table></figure>
<p>失败</p>
<h3 id="直接修改es镜像的方式"><a href="#直接修改es镜像的方式" class="headerlink" title="直接修改es镜像的方式"></a>直接修改es镜像的方式</h3><p>直接修改es镜像，在镜像中生成elasticsearch.keystore，并完成其它配置。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">lzzeng/es-xpack:7.5.1</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENV</span> <span class="string">RP_CLIENT_SECRET</span> <span class="string">secret</span></span><br><span class="line"></span><br><span class="line"><span class="string">ADD</span> <span class="string">elasticsearch.yml</span> <span class="string">/usr/share/elasticsearch/config/</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">-e</span> <span class="string">"y\n$&#123;RP_CLIENT_SECRET&#125;"</span> <span class="string">|</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">add</span> <span class="string">--stdin</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret;</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">list</span> <span class="string">&gt;</span> <span class="string">/opt/elasticsearch.keystore</span></span><br></pre></td></tr></table></figure>
<p>elasticsearch.yml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">"docker-cluster"</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line"><span class="attr">xpack.security.authc.realms.active_directory:</span></span><br><span class="line">  <span class="attr">my_ad:</span></span><br><span class="line">    <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">domain_name:</span> <span class="string">keep.com</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">ldap://192.168.100.120:389,</span> <span class="string">ldap://192.168.100.129:389</span></span><br><span class="line">    <span class="attr">bind_dn:</span> <span class="string">xxx@keep.com</span></span><br><span class="line">    <span class="attr">bind_password:</span> <span class="string">xxxxxx</span></span><br><span class="line">    <span class="attr">load_balance:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">"round_robin"</span></span><br><span class="line">    <span class="attr">user_search:</span></span><br><span class="line">      <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">      <span class="attr">filter:</span> <span class="string">"(&amp;(objectClass=user)(sAMAccountName=&#123;0&#125;))"</span></span><br><span class="line">    <span class="attr">group_search:</span></span><br><span class="line">      <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">    <span class="comment">#files:</span></span><br><span class="line">    <span class="comment">#  role_mapping: "/usr/share/elasticsearch/config/role_mapping.yml"</span></span><br><span class="line">    <span class="comment">#unmapped_groups_as_roles: true</span></span><br><span class="line"><span class="attr">xpack.security.authc.realms.oidc.oidc1:</span></span><br><span class="line">  <span class="attr">order:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">rp.client_id:</span> <span class="string">"kibana"</span></span><br><span class="line">  <span class="attr">rp.response_type:</span> <span class="string">code</span></span><br><span class="line">  <span class="attr">rp.requested_scopes:</span> <span class="string">[openid,</span> <span class="string">profile]</span></span><br><span class="line">  <span class="attr">rp.redirect_uri:</span> <span class="string">"http://kibana.staging.keep.com/api/security/v1/oidc"</span></span><br><span class="line">  <span class="attr">op.issuer:</span> <span class="string">"https://sts.keep.cn"</span></span><br><span class="line">  <span class="attr">op.authorization_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/authorize"</span></span><br><span class="line">  <span class="attr">op.token_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/token"</span></span><br><span class="line">  <span class="attr">claims.principal:</span> <span class="string">email_verified</span></span><br><span class="line">  <span class="attr">claim_patterns.principal:</span> <span class="string">"^([^@]+)@keep\\.com$"</span></span><br></pre></td></tr></table></figure>
<p>重新部署，报错如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Caused by: org.elasticsearch.common.settings.SettingsException: found settings for the realm [oidc1] (with type [oidc]) in the secure settings (elasticsearch.keystore), but this realm does not have any settings in elasticsearch.yml. Please remove these settings from the keystore, or update their names to match one of the realms that are defined in elasticsearch.yml - [xpack.security.authc.realms.oidc.oidc1.rp.client_secret]"</span>,</span><br></pre></td></tr></table></figure>
<p>失败</p>
<h3 id="postStart方式"><a href="#postStart方式" class="headerlink" title="postStart方式"></a>postStart方式</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">              <span class="string">rm</span> <span class="string">-f</span> <span class="string">/usr/share/elasticsearch/config/elasticsearch.keystore*</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">-e</span> <span class="string">"y\nsecret"</span> <span class="string">|</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">add</span> <span class="string">--stdin</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret</span></span><br><span class="line">              <span class="string">exit</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>再反复根据错误提示修改配置字典，报错信息有：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Caused by: org.elasticsearch.common.settings.SettingsException: The configuration setting [xpack.security.authc.realms.oidc.oidc1.op.jwkset_path] is required"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.require(OpenIdConnectRealm.java:329) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.buildOpenIdConnectProviderConfiguration(OpenIdConnectRealm.java:283) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:105) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.InternalRealms.lambda<span class="variable">$getFactories</span><span class="variable">$7</span>(InternalRealms.java:119) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Caused by: org.elasticsearch.common.settings.SettingsException: The configuration setting [xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is required"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.buildRelyingPartyConfiguration(OpenIdConnectRealm.java:259) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:104) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.InternalRealms.lambda<span class="variable">$getFactories</span><span class="variable">$7</span>(InternalRealms.java:119) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.Realms.initRealms(Realms.java:218) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.Realms.&lt;init&gt;(Realms.java:72) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: OpenID Connect Realm requires that the token service be enabled (xpack.security.authc.token.enabled)"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:114) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.InternalRealms.lambda<span class="variable">$getFactories</span><span class="variable">$7</span>(InternalRealms.java:119) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"type"</span>: <span class="string">"server"</span>, <span class="string">"timestamp"</span>: <span class="string">"2020-02-27T01:47:32,863Z"</span>, <span class="string">"level"</span>: <span class="string">"WARN"</span>, <span class="string">"component"</span>: <span class="string">"o.e.b.ElasticsearchUncaughtExceptionHandler"</span>, <span class="string">"cluster.name"</span>: <span class="string">"docker-cluster"</span>, <span class="string">"node.name"</span>: <span class="string">"elasticsearch-0"</span>, <span class="string">"message"</span>: <span class="string">"uncaught exception in thread [main]"</span>, </span><br><span class="line"><span class="string">"stacktrace"</span>: [<span class="string">"org.elasticsearch.bootstrap.StartupException: java.lang.IllegalStateException: security initialization failed"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:163) ~[elasticsearch-7.5.1.jar:7.5.1]"</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: Unable to create a IDTokenValidator instance"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectAuthenticator.createIdTokenValidator(OpenIdConnectAuthenticator.java:619) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectAuthenticator.&lt;init&gt;(OpenIdConnectAuthenticator.java:143) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:116) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: security initialization failed"</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: Unable to create a IDTokenValidator instance"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectAuthenticator.createIdTokenValidator(OpenIdConnectAuthenticator.java:619) ~[?:?]"</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">"Caused by: java.nio.file.NoSuchFileException: /usr/share/elasticsearch/config/oidc/jwkset.json"</span>,</span><br><span class="line"><span class="string">"at sun.nio.fs.UnixException.translateToIOException(UnixException.java:92) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>op.jwkset_path</strong></p>
<p>The path to a file or a URL containing a JSON Web Key Set with the key material that the OpenID Connect Provider uses for signing tokens and claims responses.</p>
</blockquote>
<p><strong>当前错误原因：缺少JSON Web密钥集的文件或URL，需由STS提供 op.jwkset_path 信息，以进一步尝试。</strong></p>

      
    </div>
    
    
    

    

    

    
      <div>
        

      </div>
    	

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ELK/" rel="tag"><i class="fa fa-tag"></i> ELK</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/log-analysis/k8s-elk-auth-kibana-via-ad/" rel="next" title="ELK部署至K8s并启用AD认证">
                <i class="fa fa-chevron-left"></i> ELK部署至K8s并启用AD认证
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/Django-note/" rel="prev" title="Django笔记">
                Django笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MjA1NC8xODYwMQ=="></div>
    </div>

  
  

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="https://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/avatar.jpg" alt="Lz. Zeng">
            
              <p class="site-author-name" itemprop="name">Lz. Zeng</p>
              <p class="site-description motion-element" itemprop="description">Continuous Self-Improvement</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">104</span>
                  <span class="site-state-item-name">发布</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#测试NFS可用性"><span class="nav-number">1.</span> <span class="nav-text">测试NFS可用性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NFS供应节点"><span class="nav-number">1.1.</span> <span class="nav-text">NFS供应节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试节点"><span class="nav-number">1.2.</span> <span class="nav-text">测试节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看数据库"><span class="nav-number">1.3.</span> <span class="nav-text">查看数据库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#PV数据恢复验证"><span class="nav-number">2.</span> <span class="nav-text">PV数据恢复验证</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#文档写入、更新"><span class="nav-number">2.1.</span> <span class="nav-text">文档写入、更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改请求的容量"><span class="nav-number">2.2.</span> <span class="nav-text">修改请求的容量</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#不删PV仅修改编排的容量需求"><span class="nav-number">2.2.1.</span> <span class="nav-text">不删PV仅修改编排的容量需求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删PV重建ES"><span class="nav-number">2.2.2.</span> <span class="nav-text">删PV重建ES</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据迁移到新的集群"><span class="nav-number">2.3.</span> <span class="nav-text">数据迁移到新的集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一个新ELK环境"><span class="nav-number">2.3.1.</span> <span class="nav-text">创建一个新ELK环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#复制迁移数据"><span class="nav-number">2.3.2.</span> <span class="nav-text">复制迁移数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ES账号设置"><span class="nav-number">3.</span> <span class="nav-text">ES账号设置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#用户组权限设置"><span class="nav-number">3.1.</span> <span class="nav-text">用户组权限设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置指定用户的权限"><span class="nav-number">3.2.</span> <span class="nav-text">设置指定用户的权限</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#索引名称规范"><span class="nav-number">3.3.</span> <span class="nav-text">索引名称规范</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ELK集成STS登录调试过程记录"><span class="nav-number">4.</span> <span class="nav-text">ELK集成STS登录调试过程记录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用配置字典的方式"><span class="nav-number">4.1.</span> <span class="nav-text">使用配置字典的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用环境变量-保密字典的方式"><span class="nav-number">4.2.</span> <span class="nav-text">使用环境变量+保密字典的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#initContainers方式"><span class="nav-number">4.3.</span> <span class="nav-text">initContainers方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#直接修改es镜像的方式"><span class="nav-number">4.4.</span> <span class="nav-text">直接修改es镜像的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#postStart方式"><span class="nav-number">4.5.</span> <span class="nav-text">postStart方式</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lz. Zeng</span>
  
  
</div>






  <div class="theme-info"><i class="fa fa-life-ring" aria-hidden="true"></i><span></span>  NexT.Pisces</div>




<div class="theme-info">
  <span>&nbsp;|&nbsp;</span>
  <i class="fa fa-eye" aria-hidden="true"></i><span id="busuanzi_container_site_pv">&nbsp;<span id="busuanzi_value_site_pv">
  </span>&nbsp;</span>
  <i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">&nbsp;<span id="busuanzi_value_site_uv"></span>&nbsp;</span>
  <i class="fa fa-area-chart" aria-hidden="true"></i>
  <span class="post-count">Words: 97.2k</span>
</div>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/photoswipe.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/photoswipe-ui-default.js?v=5.1.4"></script>


  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  



  









  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
