<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>ä¸€ä¸ªç”¨Excelå®ç°çš„ä¸‡å¹´å†</title>
    <url>/a-perpetual-calendar-implemented-by-excel/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>Excelç‰ˆæœ¬ï¼šV2007ä»¥ä¸Šï¼Œä¸ä½¿ç”¨VBA</p>
<h3 id="æ•ˆæœå›¾"><a href="#æ•ˆæœå›¾" class="headerlink" title="æ•ˆæœå›¾"></a>æ•ˆæœå›¾</h3><p><strong>2019å¹´</strong></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546527646465.png" alt="1546527646465"></p>
<a id="more"></a>
<p><strong>å—å®‹æœ«æœŸå…¬å…ƒ1234å¹´ï¼Œè’™å¤ç­é‡‘ï¼Œæ¬¡å¹´éº¾å…µå—ä¸‹ï¼Œå…¥ä¾µå—å®‹ â€¦</strong></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546527761384.png" alt="1546527761384"></p>
<p><strong>â€œåœ°çƒå¹´ï¼š18903729</strong><br><strong>ç¨‹å¿ƒæŠŠæœ€åä¸€ä¸ªæ•°å­—çš„ä½æ•°æ•°äº†ä¸‰éï¼Œç„¶åé»˜é»˜è½¬èº«èµ°å‡ºç©¿æ¢­æœº â€¦â€¦â€ â€”â€” ã€Šä¸‰ä½“ - æ­»ç¥æ°¸ç”Ÿã€‹</strong></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546527786540.png" alt="1546527786540"></p>
<h3 id="å®ç°æ–¹æ³•"><a href="#å®ç°æ–¹æ³•" class="headerlink" title="å®ç°æ–¹æ³•"></a>å®ç°æ–¹æ³•</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546527883211.png" alt="1546527883211"></p>
<p><strong>ä¸€å…±ä½¿ç”¨äº†17ä¸ªè‡ªå®šä¹‰åç§°ï¼Œä¸ä¾èµ–ä¸€è¡ŒVBAä»£ç ã€‚</strong></p>
<p>è¿™17ä¸ªåç§°ä¸­ï¼Œæœ‰2ä¸ªç›¸å½“äºæ¥æ”¶è¾“å…¥çš„å‚æ•°ï¼š_yå¯¹åº”å¹´ï¼Œ_må¯¹åº”æœˆã€‚_unit0æ˜¯å•å…ƒæ ¼B5çš„åˆ«åã€‚å…¶ä½™14ä¸ªåç§°ï¼ˆå…¬å¼ï¼‰åŸºäºè¾“å…¥çš„å¹´æœˆï¼Œç›¸äº’å…³è”åœ°å®Œæˆäº†è‡ªåŠ¨è®¡ç®—å€¼çš„è¿‡ç¨‹ã€‚</p>
<p><a href="/assets/files/calendar.xlsx">é™„ä»¶ï¼šcalendar.xlsx</a></p>
<hr>
<p>ï¼ˆEnd)</p>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitlab CI/CD Practice â€”â€” Gitlab Runner in Docker/K8s</title>
    <url>/gitlab-cicd-gitlab-runner/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>GitLab Runner is the open source project that is used to run your jobs and send the results back to GitLab. It is used in conjunction with <a href="https://about.gitlab.com/product/continuous-integration/" rel="external nofollow noopener noreferrer" target="_blank">GitLab CI</a>, the open-source continuous integration service included with GitLab that coordinates the jobs</p>
</blockquote>
<a id="more"></a>
<h3 id="gitlab-runner-in-Docker"><a href="#gitlab-runner-in-Docker" class="headerlink" title="gitlab-runner in Docker"></a>gitlab-runner in Docker</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zlz srv]<span class="comment"># docker exec -it gitlab-runner /bin/bash</span></span><br><span class="line"></span><br><span class="line">root@9e069893788a:/<span class="comment"># gitlab-runner register</span></span><br><span class="line">Runtime platform                                    arch=amd64 os=linux pid=33 revision=fa86510e version=11.9.2</span><br><span class="line">Running <span class="keyword">in</span> system-mode.</span><br><span class="line">Please enter the gitlab-ci coordinator URL (e.g. https://gitlab.com/):</span><br><span class="line">http://xxx.com/</span><br><span class="line">Please enter the gitlab-ci token <span class="keyword">for</span> this runner:</span><br><span class="line">peWrQo7zxksbVhsuTncq</span><br><span class="line">Please enter the gitlab-ci description <span class="keyword">for</span> this runner:</span><br><span class="line">[9e069893788a]: <span class="built_in">test</span> gitlab cid^H^H</span><br><span class="line">Please enter the gitlab-ci tags <span class="keyword">for</span> this runner (comma separated):</span><br><span class="line"><span class="built_in">test</span>,zlztest</span><br><span class="line">Registering runner... succeeded                     runner=peWrQo7z</span><br><span class="line">Please enter the executor: docker-ssh, parallels, virtualbox, kubernetes, docker, shell, ssh, docker+machine, docker-ssh+machine:</span><br><span class="line">docker</span><br><span class="line">Please enter the default Docker image (e.g. ruby:2.1):</span><br><span class="line">alpine:latest</span><br><span class="line">Runner registered successfully. Feel free to start it, but <span class="keyword">if</span> it<span class="string">'s running already the config should be automatically reloaded! </span></span><br><span class="line"><span class="string">root@9e069893788a:/#</span></span><br></pre></td></tr></table></figure>
<h3 id="gitlab-runner-in-k8s"><a href="#gitlab-runner-in-k8s" class="headerlink" title="gitlab-runner in k8s"></a>gitlab-runner in k8s</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">helm repo add gitlab https://charts.gitlab.io</span><br><span class="line">helm install --name gitlab-runner -f values.yml gitlab/gitlab-runner</span><br></pre></td></tr></table></figure>
<p>values.ymlï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="attr">gitlabUrl:</span> <span class="string">http://xxx.com/</span></span><br><span class="line"><span class="attr">runnerRegistrationToken:</span> <span class="string">"peWrQo7zxksbVhsuTncq"</span></span><br><span class="line"><span class="attr">unregisterRunners:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">concurrent:</span> <span class="number">10</span></span><br><span class="line"><span class="attr">checkInterval:</span> <span class="number">30</span></span><br><span class="line"><span class="attr">rbac:</span></span><br><span class="line">  <span class="attr">create:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">clusterWideAccess:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">metrics:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">runners:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">ubuntu:16.04</span></span><br><span class="line">  <span class="attr">privileged:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">cache:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">builds:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">services:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">helpers:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">resources:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">affinity:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">nodeSelector:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"><span class="attr">tolerations:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">hostAliases:</span> <span class="string">[]</span></span><br><span class="line"><span class="attr">podAnnotations:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner</span><br><span class="line">  namespace: default</span><br><span class="line">data:</span><br><span class="line">  config.toml: |</span><br><span class="line">    concurrent = 2</span><br><span class="line"></span><br><span class="line">    [[runners]]</span><br><span class="line">      name = <span class="string">"Kubernetes Runner"</span></span><br><span class="line">      url = <span class="string">"http://xxx.com/"</span></span><br><span class="line">      token = <span class="string">"peWrQo7zxksbVhsuTncq"</span></span><br><span class="line">      executor = <span class="string">"kubernetes"</span></span><br><span class="line">      [runners.kubernetes]</span><br><span class="line">        namespace = <span class="string">"default"</span></span><br><span class="line">        image = <span class="string">"busybox"</span></span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: extensions/v1beta1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: gitlab-runner</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      name: gitlab-runner</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        name: gitlab-runner</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - run</span><br><span class="line">        image: gitlab/gitlab-runner:latest</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: gitlab-runner</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/gitlab-runner</span><br><span class="line">          name: config</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      volumes:</span><br><span class="line">      - configMap:</span><br><span class="line">          name: gitlab-runner</span><br><span class="line">        name: config</span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºrunnerç„¶åè¿›å…¥å®¹å™¨æ‰‹åŠ¨æ³¨å†Œã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl apply -f &lt;yaml&gt;</span><br><span class="line">gitlab-ci-multi-runner register</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">gitlab-runner register</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl create -f gitlab-sc.yml</span><br><span class="line">helm install --name gitlab-runner --namespace gitlabci -f values.yml gitlab/gitlab-runner</span><br></pre></td></tr></table></figure>
<p>ç›¸å…³yamlï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Namespace</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlabci</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">gitlabci</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: gitlab-runner/templates/service-account.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-runner-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlabci</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: gitlab-runner/templates/role.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">"ClusterRole"</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-runner-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlabci</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["*"]</span></span><br><span class="line">  <span class="attr">resources:</span> <span class="string">["*"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["*"]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># Source: gitlab-runner/templates/role-binding.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">"ClusterRoleBinding"</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-runner-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlabci</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">"ClusterRole"</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-runner-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gitlab-runner-admin</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">gitlabci</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
      </tags>
  </entry>
  <entry>
    <title>æ­å»ºApache HTTPæœåŠ¡</title>
    <url>/how-to-use-apache-httpd/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>ç³»ç»Ÿï¼šCentOS 7.2</p>
<h3 id="æ›´æ–°EPELæº"><a href="#æ›´æ–°EPELæº" class="headerlink" title="æ›´æ–°EPELæº"></a>æ›´æ–°EPELæº</h3><p>   <strong><a href="https://fedoraproject.org/wiki/EPEL?rd=EPEL/en#What_is_Extra_Packages_for_Enterprise_Linux_.28or_EPEL.29.3F" rel="external nofollow noopener noreferrer" target="_blank">ğŸ”—</a> What is Extra Packages for Enterprise Linux (or EPEL)?</strong></p>
<p>Extra Packages for Enterprise Linux (or EPEL) is a Fedora Special Interest Group that creates, maintains, and manages a high quality set of additional packages for Enterprise Linux, including, but not limited to, <a href="https://fedoraproject.org/wiki/Red_Hat_Enterprise_Linux" rel="external nofollow noopener noreferrer" target="_blank">Red Hat Enterprise Linux</a> (RHEL), CentOS and Scientific Linux (SL), Oracle Linux (OL).</p>
<p><strong>EPEL</strong>ï¼ˆExtra Packages for Enterprise Linuxï¼‰æ˜¯ç”± Fedora ç¤¾åŒºæ‰“é€ ï¼Œä¸º RHEL åŠè¡ç”Ÿå‘è¡Œç‰ˆå¦‚ CentOSç­‰æä¾›é«˜è´¨é‡è½¯ä»¶åŒ…çš„é¡¹ç›®ã€‚</p>
<a id="more"></a>
  <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœä¸èƒ½ç›´æ¥yumæ›´æ–°epel</span></span><br><span class="line">yum install epel-release -y</span><br><span class="line"><span class="comment"># å°è¯•</span></span><br><span class="line">yum install https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…httpd"><a href="#å®‰è£…httpd" class="headerlink" title="å®‰è£…httpd"></a>å®‰è£…httpd</h3>  <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install -y httpd</span><br></pre></td></tr></table></figure>
<h3 id="å¼€æ”¾80ç«¯å£"><a href="#å¼€æ”¾80ç«¯å£" class="headerlink" title="å¼€æ”¾80ç«¯å£"></a>å¼€æ”¾80ç«¯å£</h3>  <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœç›´æ¥å…³é—­é˜²ç«å¢™ï¼Œåˆ™æ— éœ€é’ˆå¯¹80ç«¯å£çš„ç‰¹æ®Šè®¾ç½®</span></span><br><span class="line"><span class="comment"># systemctl stop firewall.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¼€å¯é˜²ç«å¢™</span></span><br><span class="line"><span class="comment"># systemctl start firewall.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœè¦ä½¿ç”¨iptablesä½œé˜²ç«å¢™</span></span><br><span class="line"><span class="comment"># yum -y install iptables-services</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ˜¯firewallä½œé˜²ç«å¢™ï¼Œåˆ™</span></span><br><span class="line">firewall-cmd --zone public --add-port 80/tcp --pernerment</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ˜¯iptablesä½œé˜²ç«å¢™</span></span><br><span class="line">/sbin/iptables -I INPUT -p tcp --dport 80 -j ACCEPT</span><br><span class="line">/sbin/iptables save</span><br><span class="line"><span class="comment"># ä¹Ÿå¯å°è¯•ç”¨ /etc/init.d/iptables æˆ– /etc/rc.d/init.d/iptables</span></span><br></pre></td></tr></table></figure>
<p>  å¦‚æœè¦è®©Apacheä½¿ç”¨å…¶å®ƒç«¯å£ï¼Œä¿®æ”¹<code>/etc/httpd/conf/httpd.conf</code> :</p>
  <figure class="highlight"><table><tr><td class="code"><pre><span class="line">Listen &lt;port&gt;</span><br></pre></td></tr></table></figure>
<p>  ä¿®æ”¹é»˜è®¤ç½‘ç«™æ ¹ç›®å½•ä¹Ÿæ˜¯åœ¨æ­¤æ–‡ä»¶ï¼Œé»˜è®¤ç›®å½•æ˜¯<code>/var/www/html</code>ã€‚</p>
<h3 id="è‡ªå®šä¹‰index-html"><a href="#è‡ªå®šä¹‰index-html" class="headerlink" title="è‡ªå®šä¹‰index.html"></a>è‡ªå®šä¹‰index.html</h3>  <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mkdir -p /var/www/html/&#123;hello,mydoc&#125;  	<span class="comment">#æµ‹è¯•åˆ›å»º2ä¸ªç›®å½•</span></span><br><span class="line">chmod 755 /var/www/html/&#123;hello,mydoc&#125;</span><br></pre></td></tr></table></figure>
<p>   æ·»åŠ <code>/var/www/html/index.html</code>ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
  <figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">"text/css"</span>&gt;</span></span><br><span class="line">        a:link, a:visited &#123;</span><br><span class="line">            text-decoration: none;</span><br><span class="line">        &#125;</span><br><span class="line">        a:hover &#123;</span><br><span class="line">            text-decoration: underline;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>Your page title<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"hello/"</span> <span class="attr">style</span>=<span class="string">"font-size:32px"</span>&gt;</span>Hello<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"mydoc/"</span> <span class="attr">style</span>=<span class="string">"font-size:32px"</span>&gt;</span>mydoc<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>  é¦–é¡µæ•ˆæœï¼š</p>
<p>  <img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2018/1546087466767.png" alt="å›¾ç‰‡1"></p>
<h3 id="è°ƒæ•´æ˜¾ç¤ºè®¾ç½®"><a href="#è°ƒæ•´æ˜¾ç¤ºè®¾ç½®" class="headerlink" title="è°ƒæ•´æ˜¾ç¤ºè®¾ç½®"></a>è°ƒæ•´æ˜¾ç¤ºè®¾ç½®</h3><p>  æ·»åŠ åˆ°<code>/etc/httpd/conf/httpd.conf</code>ï¼š</p>
  <figure class="highlight"><table><tr><td class="code"><pre><span class="line">IndexOptions NameWidth=60	#Nameåˆ—å®½60</span><br><span class="line">IndexOptions IconHeight=16	#å›¾æ ‡é«˜16</span><br><span class="line">IndexOptions IconWidth=16	#ï¼Œå®½16</span><br><span class="line">IndexOptions FoldersFirst	#ç›®å½•åœ¨å‰</span><br><span class="line">IndexOptions VersionSort	#ç‰ˆæœ¬æ’åº</span><br></pre></td></tr></table></figure>
  <figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">service httpd restart</span><br></pre></td></tr></table></figure>
<p>  è°ƒæ•´åç›®å½•æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p>  <img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2018/1546086571624.png" alt="å›¾ç‰‡2"></p>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨PyCharmè¿œç¨‹è°ƒè¯•</title>
    <url>/how-to-use-remote-interpreter-in-pycharm-md/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>è½¯ä»¶ï¼šPyCharm Professional Edition 2018.3</p>
<p>å¦‚æœæƒ³åœ¨Windowsç³»ç»Ÿä¸­ä½¿ç”¨PyCharmè¿›è¡ŒPythonä»£ç å¼€å‘ï¼Œè€Œåœ¨Linuxæœºå™¨ä¸Šéƒ¨ç½²è¿è¡Œï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨PyCharmçš„è¿œç¨‹è°ƒè¯•åŠŸèƒ½ã€‚è¿™æ ·å¯ä»¥é¿å…å› ä½¿ç”¨ä¸åŒç³»ç»Ÿä¸‹çš„Pythonç¯å¢ƒï¼Œåœ¨Windowsä¸Šæ­£å¸¸è¿è¡Œï¼Œè€Œåœ¨Linuxä¸ŠæŠ¥é”™ï¼Œéœ€è¦å†æ¬¡ä¿®æ”¹ä»£ç æ‰èƒ½è¿è¡Œã€‚</p>
<a id="more"></a>
<p>ä»ä»¥ä¹‹å‰çš„mysite2è¿™ä¸ªdjango demoä¸ºä¾‹ï¼Œæ­¥éª¤å¦‚ä¸‹ï¼š</p>
<h3 id="é…ç½®Deployment"><a href="#é…ç½®Deployment" class="headerlink" title="é…ç½®Deployment"></a>é…ç½®Deployment</h3><p>ã€Toolsã€‘&gt;&gt; ã€Deploymentã€‘&gt;&gt;ã€Configurationâ€¦ã€‘ï¼Œæ–°å»ºä¸€ä¸ªDeploymentã€‚é…ç½®è¿æ¥ã€ç›®å½•æ˜ å°„ï¼Œå¹¶æ’é™¤ä¸ä½œåŒæ­¥çš„ç›®å½•ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/pycharm/1550042018420.png" alt="1550042018420"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/pycharm/1550045540775.png" alt="1550045540775"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/pycharm/1550045568720.png" alt="1550045568720"></p>
<p>é…ç½®å®Œæˆåï¼Œæ‰‹åŠ¨ç‚¹å‡»ã€Toolsã€‘&gt;&gt; ã€Deploymentã€‘ &gt;&gt; ã€Upload toâ€¦ã€‘ï¼Œå°†é¡¹ç›®ä»£ç åŒæ­¥åˆ°æ‰€è®¾ç½®çš„Linuxä¸»æœºä¸Šã€‚</p>
<p>ç„¶åï¼Œç™»å½•Linuxä¸»æœºï¼Œåˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /srv</span><br><span class="line">virtualenv venv</span><br><span class="line"><span class="built_in">source</span> venv/bin/activate</span><br><span class="line"><span class="comment"># å®‰è£…djangoå’ŒMySQL-python</span></span><br><span class="line">pip install django==1.11</span><br><span class="line">pip install MySQL-python</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä¸€ä¸‹ï¼Œä»æµè§ˆå™¨è®¿é—®æ­£å¸¸å³å¯ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å·²activateè™šæ‹Ÿç¯å¢ƒ</span></span><br><span class="line">python /srv/mysite2/manage.py runserver 0.0.0.0:8000</span><br></pre></td></tr></table></figure>
<h3 id="é…ç½®Interpreter"><a href="#é…ç½®Interpreter" class="headerlink" title="é…ç½®Interpreter"></a>é…ç½®Interpreter</h3><p>æ ¹æ®ä¸Šé¢é…ç½®å¥½çš„éƒ¨ç½²æ¥é…ç½®è¿œç¨‹è§£é‡Šå™¨ï¼Œå¹¶é€‰æ‹©åœ¨Linuxä¸»æœºä¸Šåˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒvenvä½œè¿œç¨‹è§£é‡Šå™¨ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/pycharm/1550043819067.png" alt="1550043819067"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/pycharm/1550044379484.png" alt="1550044379484"></p>
<h3 id="é…ç½®Run-Debug"><a href="#é…ç½®Run-Debug" class="headerlink" title="é…ç½®Run/Debug"></a>é…ç½®Run/Debug</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/pycharm/1550044673006.png" alt="1550044673006"></p>
<p>è‡³æ­¤ï¼ŒDeploymentã€Remote Interpreterå’ŒRunä¸‰å¤„é…ç½®å‡å®Œæˆï¼Œå¯ä»¥ç›´æ¥ä»PyCharmè¿è¡Œè°ƒè¯•äº†ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/pycharm/1550044955274.png" alt="1550044955274"></p>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>å®ç”¨æ–‡æ¡£æ±‡æ€»</title>
    <url>/ref-docs/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>æ±‡æ€»éƒ¨åˆ†å®ç”¨æ–‡æ¡£ï¼Œä»¥ä¾¿ä¸‹è½½å–ç”¨ã€å­¦ä¹ </p>
</blockquote>
<a id="more"></a>
<h1 id="A"><a href="#A" class="headerlink" title="A"></a>A</h1><ul>
<li><a href="/assets/files/docs/Ali-java-handbook.pdf">é˜¿é‡ŒJavaå¼€å‘æ‰‹å†Œæ­£å¼ç‰ˆPDF</a></li>
<li><a href="/assets/files/docs/ASCIIç å¯¹ç…§è¡¨.pdf">ASCIIç å¯¹ç…§è¡¨</a></li>
</ul>
<h1 id="D"><a href="#D" class="headerlink" title="D"></a>D</h1><ul>
<li><a href="/assets/files/docs/Docker-basic.pptx">DockeråŸºç¡€æ€»ç»“PPT</a></li>
</ul>
<h1 id="J"><a href="#J" class="headerlink" title="J"></a>J</h1><ul>
<li><a href="/assets/files/docs/Javaç¼–ç¨‹æ€æƒ³ï¼ˆç¬¬äºŒç‰ˆï¼‰.chm">Javaç¼–ç¨‹æ€æƒ³ï¼ˆç¬¬äºŒç‰ˆï¼‰</a></li>
<li><a href="/assets/files/docs/ç»å…¸SQLè¯­å¥å¤§å…¨.doc">ç»å…¸SQLè¯­å¥å¤§å…¨</a></li>
</ul>
<h1 id="P"><a href="#P" class="headerlink" title="P"></a>P</h1><ul>
<li><a href="/assets/files/docs/Python_3.4_å…¥é—¨æŒ‡å—ï¼ˆå®˜æ–¹ä¸­æ–‡ç‰ˆï¼‰.pdf">Python_3.4_å…¥é—¨æŒ‡å—ï¼ˆå®˜æ–¹ä¸­æ–‡ç‰ˆï¼‰</a>)</li>
</ul>
<h1 id="R"><a href="#R" class="headerlink" title="R"></a>R</h1><ul>
<li><a href="/assets/files/docs/Rediså®æˆ˜.pdf">Rediså®æˆ˜</a></li>
<li><a href="/assets/files/replay-tools.zip">replay-tools</a></li>
</ul>
<h1 id="S"><a href="#S" class="headerlink" title="S"></a>S</h1><ul>
<li><a href="/assets/files/docs/the-art-of-sql.pdf">SQLè¯­è¨€è‰ºæœ¯</a></li>
<li><a href="/assets/files/docs/æ·±å…¥æµ…å‡ºMySQLï¼ˆåˆ å‡ç‰ˆï¼‰.pdf">æ·±å…¥æµ…å‡ºMySQLï¼ˆåˆ å‡ç‰ˆï¼‰</a></li>
<li><a href="/assets/files/docs/spring-boot-reference.pdf">Springbootå‚è€ƒ</a></li>
</ul>
]]></content>
      <categories>
        <category>else</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>å•ä¾‹æ¨¡å¼-å®éªŒ</title>
    <url>/singleton-test/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h3 id="é¥¿æ±‰å¼"><a href="#é¥¿æ±‰å¼" class="headerlink" title="é¥¿æ±‰å¼"></a>é¥¿æ±‰å¼</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é¥¿æ±‰å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonType1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonType1 singletonType1 = <span class="keyword">new</span> SingletonType1();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonType1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonType1 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> singletonType1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        List&lt;Thread&gt; threadList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        Set&lt;Singleton&gt; singletonSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> SET_MAXSIZE = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; SET_MAXSIZE; i++) &#123;</span><br><span class="line">            Thread th = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    SingletonType1 singleton = SingletonType1.getInstance();</span><br><span class="line">                    singletonSet.add(singleton);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">":"</span> + singleton);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            threadList.add(th);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Thread thread : threadList) &#123;</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">500</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(singletonSet.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŸæ¬¡è¿è¡Œç»“æœï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Thread-59:cn.lzzeng.home.singleton.SingletonType1@e0614d</span><br><span class="line">Thread-61:cn.lzzeng.home.singleton.SingletonType1@e0614d</span><br><span class="line">Thread-62:cn.lzzeng.home.singleton.SingletonType1@e0614d</span><br><span class="line">Thread-63:cn.lzzeng.home.singleton.SingletonType1@e0614d</span><br><span class="line">3</span><br></pre></td></tr></table></figure>
<p>æœ€åä¸€è¡Œæ‰“å°å‡ºæ¥çš„sizeæ˜¯3ï¼Œéš¾é“<strong>é¥¿æ±‰å¼</strong>å•ä¾‹æ¨¡å¼éçº¿ç¨‹å®‰å…¨ï¼Ÿå†æŸ¥çœ‹å‰é¢100è¡Œæ‰“å°çš„æ˜¾ç¤ºå¯¹è±¡åœ°å€ï¼Œå‡ç›¸åŒã€‚å…¶å®ï¼Œsizeè®¡æ•°ä¸æ­£ç¡®æ˜¯<code>HashSet</code>å¯¼è‡´çš„ã€‚<code>HashSet</code>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥ç”¨<code>ConcurrentHashMap</code>æ¥æ›¿ä»£ç›¸å…³ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Set&lt;Singleton&gt; singletonSet = new HashSet&lt;&gt;();</span></span><br><span class="line">Map&lt;String, String&gt; singletonMap = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"><span class="comment">// singletonSet.add(singleton);</span></span><br><span class="line">singletonMap.put(singleton.toString(), <span class="string">""</span>);</span><br></pre></td></tr></table></figure>
<h3 id="æ‡’æ±‰å¼"><a href="#æ‡’æ±‰å¼" class="headerlink" title="æ‡’æ±‰å¼"></a>æ‡’æ±‰å¼</h3><ol>
<li><strong>æ‡’æ±‰å¼-éçº¿ç¨‹åŒæ­¥</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‡’æ±‰å¼-éçº¿ç¨‹åŒæ­¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonType2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonType2 singtonType2;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonType2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonType2 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == singtonType2) &#123;</span><br><span class="line">            singtonType2 = <span class="keyword">new</span> SingletonType2();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singtonType2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å†ä¿®æ”¹æµ‹è¯•ä»£ç çš„è¿™ä¸€è¡Œåå†æµ‹è¯•ï¼š</p>
   <figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// SingletonType1 singleton = SingletonType1.getInstance();</span></span><br><span class="line">SingletonType2 singleton = SingletonType2.getInstance();</span><br></pre></td></tr></table></figure>
<p>æŸæ¬¡ç»“æœå¦‚ä¸‹ï¼š</p>
   <figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">Thread-2:cn.lzzeng.home.singleton.SingletonType2@11f7d35</span><br><span class="line">Thread-5:cn.lzzeng.home.singleton.SingletonType2@1e9b76c</span><br><span class="line">...</span><br><span class="line">Thread-0:cn.lzzeng.home.singleton.SingletonType2@1e9b76c</span><br><span class="line">2</span><br></pre></td></tr></table></figure>
<p>ä»æ‰“å°çš„å‰2è¡Œæ¥çœ‹ï¼Œç¡®å®å‡ºç°äº†è·å–å®ä¾‹ä¸å”¯ä¸€çš„ç°è±¡ï¼Œå¯è§æ˜¯éçº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<ol start="2">
<li><strong>æ‡’æ±‰å¼-çº¿ç¨‹åŒæ­¥</strong></li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‡’æ±‰å¼-çº¿ç¨‹åŒæ­¥</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonType3</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonType3 singtonType3;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonType3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> SingletonType3 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == singtonType3) &#123;</span><br><span class="line">            singtonType3 = <span class="keyword">new</span> SingletonType3();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singtonType3;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ­¤æ³•ä½¿ç”¨<code>synchronized</code>ä¿®é¥°staticæ–¹æ³•<code>getInstance</code>ï¼Œå®æµ‹æœªè§å¼‚å¸¸ã€‚</p>
<p>å¦‚æœæ”¹ç”¨ç±»çš„classå¯¹è±¡ä½œä¸ºåŒæ­¥ç›‘è§†å™¨å¯¹è±¡ï¼Œå³å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * synchronizedç±»å.class</span></span><br><span class="line"><span class="comment"> * synchronizedä¸­ä¸åŠ if (null == singtonType3)ï¼Œæµ‹è¯•</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonType3 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == singtonType3) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SingletonType3<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            singtonType3 = <span class="keyword">new</span> SingletonType3();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singtonType3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çœ‹èµ·æ¥ä¼¼ä¹æ²¡é—®é¢˜ï¼Œä½†å®æµ‹å‡ºç°å¦‚ä¸‹ç»“æœï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546591780472.png" alt="1546591780472"></p>
<p>è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿä¸Šä¸€ç§synchronizedä¿®é¥°æ–¹æ³•çš„æ–¹å¼ä¸­ï¼ŒåŠ é”åï¼Œè¿›å…¥æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œé¦–å…ˆä¼šåˆ¤æ–­ä¸€æ¬¡æ˜¯å¦å·²å­˜åœ¨å•ç±»çš„å®ä¾‹ï¼Œè€Œåä¸€ç§æ–¹å¼synchronizedåæ²¡æœ‰è¿™ä¸ªåˆ¤æ–­æ­¥éª¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¦æƒ³åªåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œ<strong>åŠ é”çš„åŒºåŸŸå¿…é¡»åŒ…å«åˆ¤æ–­æ˜¯å¦å·²å®ä¾‹åŒ–çš„æ­¥éª¤</strong>ã€‚å¦åˆ™ï¼Œä»…ä»…æ˜¯ä¿è¯äº†å¤šä¸ªçº¿ç¨‹é€šè¿‡newåˆ›å»ºå®ä¾‹çš„è¿‡ç¨‹åœ¨æ—¶åºä¸Šä¸ä¼šå‘ç”Ÿé‡å ã€‚</p>
<p>æ­£ç¡®çš„å†™æ³•ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonType3 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == singtonType3) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SingletonType3<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == singtonType3) &#123;</span><br><span class="line">                singtonType3 = <span class="keyword">new</span> SingletonType3();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singtonType3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åŒé‡æ ¡éªŒé”"><a href="#åŒé‡æ ¡éªŒé”" class="headerlink" title="åŒé‡æ ¡éªŒé”"></a>åŒé‡æ ¡éªŒé”</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * åŒé‡æ ¡éªŒé”</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonType5</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> SingletonType5 SingletonType5;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonType5</span> <span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonType5 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (SingletonType5 == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SingletonType5<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (SingletonType5 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    SingletonType5 = <span class="keyword">new</span> SingletonType5();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SingletonType5;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŒé‡æ ¡éªŒé”æ–¹å¼é‡‡ç”¨åŒé”æœºåˆ¶ï¼Œå®‰å…¨ä¸”åœ¨å¤šçº¿ç¨‹æƒ…å†µä¸‹èƒ½ä¿æŒé«˜æ€§èƒ½ã€‚ä¸ç¬¬äºŒç§æ‡’æ±‰å¼çš„åŒºåˆ«åªåœ¨äºå¤šäº†ä¸€ä¸ª<code>volatile</code>ã€‚</p>
<h3 id="é™æ€å†…éƒ¨ç±»å¼"><a href="#é™æ€å†…éƒ¨ç±»å¼" class="headerlink" title="é™æ€å†…éƒ¨ç±»å¼"></a>é™æ€å†…éƒ¨ç±»å¼</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * é™æ€å†…éƒ¨ç±»å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SingletonType4</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SingletonType4 INSTANCE = <span class="keyword">new</span> SingletonType4();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonType4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SingletonType4 <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> SingletonHolder.INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ç§æ–¹å¼åŒæ ·åˆ©ç”¨äº†ç±»åŠ è½½æœºåˆ¶æ¥ä¿è¯åˆå§‹åŒ–å®ä¾‹æ—¶åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œå®ƒè·Ÿ<strong>é¥¿æ±‰å¼</strong>ä¸åŒçš„æ˜¯ï¼šé¥¿æ±‰å¼åªè¦ Singletonç±»ï¼ˆå³<code>SingletonType1</code>ï¼‰è¢«åŠ è½½äº†ï¼Œå°±ä¼šå®ä¾‹åŒ–<code>instance</code>ï¼Œæ²¡æœ‰è¾¾åˆ°æ‡’åŠ è½½çš„æ•ˆæœã€‚è€Œè¿™ç§æ–¹å¼æ˜¯Singletonç±»è¢«åŠ è½½åï¼Œåªæœ‰æ˜¾å¼åœ°è°ƒç”¨<code>getInstance</code>æ–¹æ³•æ—¶ï¼Œæ‰ä¼šåŠ è½½<code>SingletonHolder</code>ç±»ï¼Œä»è€Œå®ä¾‹åŒ–<code>instance</code>ã€‚</p>
<h3 id="æšä¸¾å¼"><a href="#æšä¸¾å¼" class="headerlink" title="æšä¸¾å¼"></a>æšä¸¾å¼</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ä¼ è¯´ä¸­çš„æœ€å®Œç¾çš„å•ä¾‹æ¨¡å¼</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MySingleton</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">enum</span> MyEnumSingle &#123;</span><br><span class="line">        INSTANCE;</span><br><span class="line">        <span class="keyword">private</span> MySingleton singleOne;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="title">MyEnumSingle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            singleOne = <span class="keyword">new</span> MySingleton();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> singleOne;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">MySingleton</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MySingleton <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyEnumSingle.INSTANCE.getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æšä¸¾æ–¹å¼æ˜¯Effective Javaä½œè€…Josh Blochæå€¡çš„æ–¹å¼ã€‚ç‰¹ç‚¹ï¼š</p>
<ul>
<li>é¿å…äº†å¤šçº¿ç¨‹åŒæ­¥é—®é¢˜ï¼Œçº¿ç¨‹å®‰å…¨</li>
<li>æ”¯æŒåºåˆ—åŒ–æœºåˆ¶ï¼Œé˜²æ­¢ååºåˆ—åŒ–é‡æ–°åˆ›å»ºæ–°çš„å¯¹è±¡ï¼Œç»å¯¹é˜²æ­¢å¤šæ¬¡å®ä¾‹åŒ–</li>
<li>å¯ä»¥é˜²æ­¢åˆ©ç”¨åå°„å¼ºè¡Œæ„å»ºå•ä¾‹å¯¹è±¡</li>
<li>åˆ©ç”¨å†…éƒ¨ç±»å®ç°æ‡’åŠ è½½</li>
</ul>
<hr>
<p>ï¼ˆEnd)</p>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>è‚¡ä»·æŸ¥è¯¢å°å·¥å…·ä¸€æš</title>
    <url>/tools-stock-price/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>åªèƒ½æŸ¥è¯¢Aè‚¡ï¼Œç”¨åˆ°äº†3ä¸ªæ–°æµªè‚¡ç¥¨æ•°æ®æ¥å£ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">http://money.finance.sina.com.cn/quotes_service/api/json_v2.php/CN_MarketData.getKLineData</span><br><span class="line">http://hq.sinajs.cn/?list=sz000002</span><br><span class="line">https://suggest3.sinajs.cn/suggest/key=ä¸‡ç§‘A</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æŒ‰è‚¡ç¥¨åç§°æŸ¥è¯¢æœ€æ–°è‚¡ä»·ã€æŸ¥è¯¢ ç¬¬å‰3äº¤æ˜“æ—¥ã€æŸ¥è¯¢ å‰3ä¸ªäº¤æ˜“æ—¥ï¼ŒæŒ‰è‚¡ç¥¨ä»£ç æŸ¥è¯¢ å‰3ä¸ªäº¤æ˜“æ—¥ æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/image-20200928004218980.png" alt="image-20200928004218980" style="zoom:67%;"></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ï¼š</span></span><br><span class="line">[root@VM_0_13_centos ~]<span class="comment"># cp stock-price.py /usr/local/bin/stock-price</span></span><br><span class="line">[root@VM_0_13_centos ~]<span class="comment"># chmod +x /usr/local/bin/stock-price</span></span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos ~]<span class="comment"># stock-price -h</span></span><br><span class="line">usage: stock-price [-h] [-C] [-Z] stock_code [day]</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  stock_code      the stock code or the stock name, e.g. sz000002 or ä¸‡ç§‘A</span><br><span class="line">  day             <span class="built_in">which</span> day(s), use the number of days before today, e.g.</span><br><span class="line">                  <span class="string">"3,1"</span> or <span class="string">"1,3"</span> or <span class="string">"3,"</span> or <span class="string">",1"</span> or <span class="string">"3"</span>, by default <span class="string">","</span> is the</span><br><span class="line">                  same as <span class="string">"10,1"</span>, and the quotes are not necessary. Maximum</span><br><span class="line">                  days: 137</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --<span class="built_in">help</span>      show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  -C, --no-color  cancel color</span><br><span class="line">  -Z, --en        cancel zh-CN</span><br></pre></td></tr></table></figure>
<p><a href="/assets/files/stock-price.py">é™„ä»¶ï¼šstock-price.py</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ä½¿ç”¨Dockeréƒ¨ç½²ä¸€ä¸ªDjango Demo</title>
    <url>/test-docker-01/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>ç³»ç»Ÿï¼šCentOS 7.2</p>
</blockquote>
<p>å‡†å¤‡ä¸€ä¸ªDjango Demoï¼Œè¿è¡Œåæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547641817316.png" alt="1547641817316"></p>
<a id="more"></a>
<p>è¿™æ˜¯Djangoå®˜ç½‘ä¸Šçš„ä¸€ä¸ªç®€å•çš„æŠ•ç¥¨demoï¼Œæ˜¯ä½¿ç”¨NginX + supervisord + gunicorn + venvæ¥éƒ¨ç½²çš„ã€‚ç°åœ¨è¦åšçš„æ˜¯æŠŠå®ƒåˆ¶ä½œæˆdockeré•œåƒï¼Œç„¶åä»¥å®¹å™¨çš„æ–¹å¼è¿è¡Œå®ƒã€‚</p>
<hr>
<p><strong>æ­¥éª¤å¦‚ä¸‹ï¼š</strong></p>
<h3 id="å®‰è£…docker"><a href="#å®‰è£…docker" class="headerlink" title="å®‰è£…docker"></a>å®‰è£…docker</h3><p>æˆ‘ä½¿ç”¨çš„æ˜¯äº‘ä¸»æœºï¼Œå·²é…ç½®yumæºï¼Œå¯ä»¥ç›´æ¥</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum install docker</span><br></pre></td></tr></table></figure>
<p>å› å·²å®‰è£…dockerï¼Œæç¤ºæ›´æ–°å¦‚ä¸‹ï¼ˆæ›´æ–°ååŸæœ‰é•œåƒè¢«åˆ é™¤äº†ï¼‰ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547633107189.png" alt="1547633107189"></p>
<p>yumæºé…ç½®å¦‚ä¸‹ï¼š</p>
<p>/etc/yum.repos.d/CentOS-Base.repoæ–‡ä»¶ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[extras]</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=http://mirrors.tencentyun.com/centos/RPM-GPG-KEY-CentOS-<span class="number">7</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">baseurl</span>=http://mirrors.tencentyun.com/centos/<span class="variable">$releasever</span>/extras/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="attr">name</span>=Qcloud centos extras - <span class="variable">$basearch</span></span><br><span class="line"><span class="section">[os]</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=http://mirrors.tencentyun.com/centos/RPM-GPG-KEY-CentOS-<span class="number">7</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">baseurl</span>=http://mirrors.tencentyun.com/centos/<span class="variable">$releasever</span>/os/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="attr">name</span>=Qcloud centos os - <span class="variable">$basearch</span></span><br><span class="line"><span class="section">[updates]</span></span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=http://mirrors.tencentyun.com/centos/RPM-GPG-KEY-CentOS-<span class="number">7</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">baseurl</span>=http://mirrors.tencentyun.com/centos/<span class="variable">$releasever</span>/updates/<span class="variable">$basearch</span>/</span><br><span class="line"><span class="attr">name</span>=Qcloud centos updates - <span class="variable">$basearch</span></span><br></pre></td></tr></table></figure>
<p>/etc/yum.repos.d/CentOS-Epel.repoæ–‡ä»¶ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[epel]</span></span><br><span class="line"><span class="attr">name</span>=EPEL for redhat/centos <span class="variable">$releasever</span> - <span class="variable">$basearch</span></span><br><span class="line"><span class="attr">failovermethod</span>=priority</span><br><span class="line"><span class="attr">gpgcheck</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">gpgkey</span>=http://mirrors.tencentyun.com/epel/RPM-GPG-KEY-EPEL-<span class="number">7</span></span><br><span class="line"><span class="attr">enabled</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">baseurl</span>=http://mirrors.tencentyun.com/epel/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/</span><br></pre></td></tr></table></figure>
<hr>
<p>ç¤ºä¾‹åº”ç”¨æ ¹ç›®å½•æ˜¯<code>mysite2</code>ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">|   |-- mysite2</span><br><span class="line">|   |   |-- fixtures</span><br><span class="line">|   |   |-- manage.py</span><br><span class="line">|   |   |-- mysite2</span><br><span class="line">|   |   |-- polls</span><br><span class="line">|   |   `-- templates</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†æ–¹ä¾¿åˆ¶ä½œdockeré•œåƒï¼Œé‡æ–°ç»„ç»‡æˆäº†ä¸‹é¢çš„æ ·å­ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@lzzeng docker_demo]<span class="comment"># tree -L 3 .</span></span><br><span class="line">.</span><br><span class="line">|-- application</span><br><span class="line">|   |-- docker-compose.yml</span><br><span class="line">|   |-- Dockerfile</span><br><span class="line">|   |-- mysite2</span><br><span class="line">|   |   |-- fixtures</span><br><span class="line">|   |   |-- manage.py</span><br><span class="line">|   |   |-- mysite2</span><br><span class="line">|   |   |-- polls</span><br><span class="line">|   |   `-- templates</span><br><span class="line">|   |-- mysite2_nginx.conf</span><br><span class="line">|   |-- mysite2_supervisord.ini</span><br><span class="line">|   |-- requirements.txt</span><br><span class="line">|   |-- start_script</span><br><span class="line">|   `-- <span class="built_in">wait</span>-for-it.sh</span><br><span class="line">`-- readMe.md</span><br></pre></td></tr></table></figure>
<p><code>application</code>ç›®å½•ä¸‹çš„æ–‡ä»¶<code>docker-compose.yml</code>ã€<code>Dockerfile</code>ç­‰7ä¸ªæ–‡ä»¶æ˜¯æ–°å¢çš„ã€‚ä½œç”¨å¦‚ä¸‹ï¼š</p>
<p><strong>docker-compose.yml</strong>ï¼šé€šè¿‡docker-composeå¯åŠ¨å®¹å™¨çš„é…ç½®ï¼Œå®šä¹‰äº†å¤šä¸ªå®¹å™¨çš„å¯åŠ¨å‚æ•°ï¼ŒåŠå®¹å™¨å…³è”ç­‰<br><strong>Dockerfile</strong>ï¼šåˆ¶ä½œDockeré•œåƒçš„è„šæœ¬ç¼–æ’ï¼Œç±»ä¼¼äºMakefileã€SPECæ–‡ä»¶ç­‰<br><strong>mysite2_nginx.conf</strong>ï¼šäº‹å…ˆå†™å¥½çš„NginXé…ç½®æ–‡ä»¶<br><strong>mysite2_supervisord.ini</strong>ï¼šäº‹å…ˆå†™å¥½çš„Supervisordé…ç½®æ–‡ä»¶<br><strong>requirements.txt</strong>ï¼šè®°å½•åˆ¶ä½œdockeré•œåƒéœ€è¦å®‰è£…çš„ä¾èµ–ï¼ŒDockerfileä¸­ç”¨åˆ°<br><strong>start_script</strong>ï¼š å®¹å™¨å¯åŠ¨å…¥å£ï¼ŒDockerfileä¸­å®šä¹‰äº†æ­¤è„šæœ¬ä¸ºå¯åŠ¨å…¥å£<br><strong>wait-for-it.sh</strong>ï¼šç­‰å¾…å…¶å®ƒå®¹å™¨ï¼ˆæœåŠ¡ï¼‰å¯åŠ¨å®Œæ¯•çš„è„šæœ¬</p>
<hr>
<h3 id="ç¼–å†™Dockerfile"><a href="#ç¼–å†™Dockerfile" class="headerlink" title="ç¼–å†™Dockerfile"></a>ç¼–å†™Dockerfile</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŸºäºcentos:7</span></span><br><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER zeng &lt;zeng@abc.com&gt;</span><br><span class="line">ENV TZ <span class="string">"Asia/Shanghai"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®è‹¥å¹²ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="comment"># Local directory with project source</span></span><br><span class="line">ENV DOCKER_SRC=mysite2</span><br><span class="line"><span class="comment"># Directory in container for all project files</span></span><br><span class="line">ENV DOCKER_HOME=/srv</span><br><span class="line"><span class="comment"># Directory in container for project source files</span></span><br><span class="line">ENV DOCKER_PROJECT=/srv/webapp  <span class="comment"># mysite2ä¸‹é¢çš„æ–‡ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…åŸºç¡€é•œåƒä¸­ç¼ºå¤±çš„è½¯ä»¶</span></span><br><span class="line"><span class="comment"># Install required packages and remove the apt packages cache when done.</span></span><br><span class="line">RUN yum -y install epel-release &amp;&amp; \</span><br><span class="line">    yum -y install <span class="built_in">which</span> &amp;&amp; \</span><br><span class="line">    yum -y install python-pip &amp;&amp; \</span><br><span class="line">    yum -y install supervisor-3.1.4 &amp;&amp; \</span><br><span class="line">    yum -y install git nginx gcc gcc-c++ python-devel &amp;&amp; \</span><br><span class="line">    yum -y install mysql &amp;&amp; \</span><br><span class="line">    yum -y install mysql-devel &amp;&amp; \</span><br><span class="line">    yum -y install nc &amp;&amp; \</span><br><span class="line">    yum clean all &amp;&amp; \</span><br><span class="line">    pip install -U pip</span><br><span class="line"></span><br><span class="line"><span class="comment"># cd $DOCKER_PROJECT</span></span><br><span class="line">WORKDIR <span class="variable">$DOCKER_PROJECT</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># COPYæŒ‡ä»¤å°†ä»æ„å»ºä¸Šä¸‹æ–‡ç›®å½•ä¸­ &lt;æºè·¯å¾„&gt; çš„æ–‡ä»¶/ç›®å½•å¤åˆ¶åˆ°æ–°çš„ä¸€å±‚çš„é•œåƒå†…çš„ &lt;ç›®æ ‡è·¯å¾„&gt; ä½ç½®</span></span><br><span class="line"><span class="comment"># å³Dockerfileæ‰€åœ¨ç›®å½•ä¸‹çš„æ–‡ä»¶å¤åˆ¶åˆ°$DOCKER_PROJECT</span></span><br><span class="line">COPY ./ ./</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create application subdirectories</span></span><br><span class="line">WORKDIR <span class="variable">$DOCKER_PROJECT</span></span><br><span class="line">RUN mkdir static <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨ Dockerfile ä¸­ï¼Œå¯ä»¥äº‹å…ˆæŒ‡å®šæŸäº›ç›®å½•æŒ‚è½½ä¸ºåŒ¿åå·ï¼Œè¿™æ ·åœ¨è¿è¡Œæ—¶å¦‚æœç”¨æˆ·ä¸æŒ‡å®šæŒ‚è½½ï¼Œå…¶åº”ç”¨ä¹Ÿå¯ä»¥æ­£å¸¸è¿è¡Œï¼Œä¸ä¼šå‘å®¹å™¨å­˜å‚¨å±‚å†™å…¥å¤§é‡æ•°æ®</span></span><br><span class="line">VOLUME [<span class="string">"<span class="variable">$DOCKER_HOME</span>/media/"</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN pip install -r requirements.txt</span></span><br><span class="line">RUN pip install -i https://pypi.tuna.tsinghua.edu.cn/simple -r requirements.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš´éœ²æŸäº›ç«¯å£</span></span><br><span class="line">EXPOSE 8000</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šå®¹å™¨å¯åŠ¨å…¥å£</span></span><br><span class="line">RUN chmod u+x start_script</span><br><span class="line">ENTRYPOINT [<span class="string">"./start_script"</span>]</span><br></pre></td></tr></table></figure>
<p>æ„å»ºé•œåƒï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547635956715.png" alt="1547635956715"></p>
<p>æ„å»ºæˆåŠŸï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547636296801.png" alt="1547636296801"></p>
<p>æµ‹è¯•å®¹å™¨ï¼š</p>
<p><code>mysite2</code>åº”ç”¨ä¸­ç”¨åˆ°äº†æ•°æ®åº“ï¼Œéœ€è¦å…ˆå¯åŠ¨mysqlå®¹å™¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run --name db -d -e MYSQL_ROOT_PASSWORD=qwerasdf -e MYSQL_DATABASE=mysite2_db -v /root/mysite2_db:/var/lib/mysql mysql:5.7</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡<code>mysql:5.7</code>é•œåƒåˆ›å»ºmysqlå®¹å™¨æ—¶ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºåä¸º<code>mysite2_db</code>çš„æ•°æ®åº“ï¼Œå¹¶è®¾ç½®æ•°æ®åº“å¯†ç ä¸º<code>qwerasdf</code>,ä»¥å¤‡è¿æ¥ã€‚å®¹å™¨ä¸­çš„<code>/var/lib/mysql</code>ç›®å½•ä¼šåŒæ­¥åˆ°æ•°æ®å·<code>/root/mysite2_db</code>ã€‚</p>
<p>æ‰§è¡Œåå¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547637360611.png" alt="1547637360611"></p>
<p>ç„¶åï¼Œé€šè¿‡å·²åˆ¶ä½œå¥½çš„é•œåƒ<code>zeng/docker_demo_gunicorn:0.3</code>æ¥å¯åŠ¨<code>mysite2</code>ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547637610068.png" alt="1547637610068"></p>
<p>å¯åŠ¨æˆåŠŸï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547637646260.png" alt="1547637646260"></p>
<p>æµè§ˆå™¨è®¿é—®ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547637779496.png" alt="1547637779496"></p>
<p>å› ä¸º<code>mysite2</code>æ²¡æœ‰å¤„ç†è¿™ä¸ªè¯·æ±‚è·¯å¾„ï¼Œæ”¹ä¸ºï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547637911779.png" alt="1547637911779"></p>
<p>å¯¹æ¥mysqlæ—¶ï¼Œç”¨æˆ·åã€å¯†ç æ˜¯åœ¨django settingsé‡Œæœ‰å¦‚ä¸‹é…ç½®ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>:&#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>:<span class="string">'mysite2_db'</span>,</span><br><span class="line">        <span class="string">'USER'</span>:<span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: os.environ.get(<span class="string">'DB_ENV_MYSQL_ROOT_PASSWORD'</span>),</span><br><span class="line">        <span class="string">'HOST'</span>:os.environ.get(<span class="string">'DB_PORT_3306_TCP_ADDR'</span>),</span><br><span class="line">        <span class="string">'PORT'</span>:<span class="number">3306</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>start_script</code>ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># nginx settings</span></span><br><span class="line">sed -i <span class="string">'/user/&#123;s/nginx/root/&#125;'</span> /etc/nginx/nginx.conf</span><br><span class="line">ln -s /srv/webapp/mysite2_nginx.conf /etc/nginx/conf.d/</span><br><span class="line">nginx</span><br><span class="line"></span><br><span class="line">chmod u+x <span class="built_in">wait</span>-for-it.sh</span><br><span class="line">./<span class="built_in">wait</span>-for-it.sh <span class="variable">$DB_PORT_3306_TCP_ADDR</span>:<span class="variable">$DB_PORT_3306_TCP_PORT</span> &amp;</span><br><span class="line"><span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># application settings</span></span><br><span class="line"><span class="built_in">export</span> DJANGO_SETTINGS_MODULE=mysite2.settings.server</span><br><span class="line"><span class="built_in">cd</span> mysite2</span><br><span class="line">./manage.py migrate --noinput</span><br><span class="line">./manage.py loaddata ./fixtures/superuser.json  <span class="comment"># åŠ è½½rootç”¨æˆ·ä¿¡æ¯ï¼Œè§ä¸‹</span></span><br><span class="line">./manage.py collectstatic --noinput</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®¹å™¨ä¸­å¯åŠ¨mysite2</span></span><br><span class="line">ln -s /srv/webapp/mysite2_supervisord.ini /etc/supervisord.d/</span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>mysite2/fixtures/superuser.jsonï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123; <span class="attr">"model"</span>: <span class="string">"auth.user"</span>,</span><br><span class="line">        <span class="attr">"pk"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">"fields"</span>: &#123;</span><br><span class="line">            <span class="attr">"username"</span>: <span class="string">"root"</span>,</span><br><span class="line">            <span class="attr">"password"</span>: <span class="string">"pbkdf2_sha256$36000$jEzTV4h887Ze$zQQMAMraWN9suHPapbb7LOP6pZ3ADc7KxCUv2oR8Px4="</span>,</span><br><span class="line">            <span class="attr">"is_superuser"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"is_staff"</span>: <span class="literal">true</span>,</span><br><span class="line">            <span class="attr">"is_active"</span>: <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­çš„passwordç”Ÿæˆæ–¹å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@lzzeng mysite2]<span class="comment"># export DJANGO_SETTINGS_MODULE=mysite2.settings.server</span></span><br><span class="line">[root@lzzeng mysite2]<span class="comment"># python</span></span><br><span class="line">Python 2.7.5 (default, Oct 30 2018, 23:45:53) </span><br><span class="line">[GCC 4.8.5 20150623 (Red Hat 4.8.5-36)] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> or <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line">&gt;&gt;&gt; from django.contrib.auth.hashers import make_password</span><br><span class="line">&gt;&gt;&gt; make_password(<span class="string">'qwerasdf'</span>)</span><br><span class="line">u<span class="string">'pbkdf2_sha256$36000$jEzTV4h887Ze$zQQMAMraWN9suHPapbb7LOP6pZ3ADc7KxCUv2oR8Px4='</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>ä»¥<code>root:qwerasdf</code>ç™»å½•adminé¡µé¢æ·»åŠ pollsè®°å½•åï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547639904076.png" alt="1547639904076"></p>
<p>ä»¥ä¸Šå®Œæˆäº†dockeré•œåƒåˆ¶ä½œï¼ˆæœªä¸Šä¼ åˆ°è¿œç¨‹é•œåƒåº“ï¼‰ï¼Œç„¶åä½¿ç”¨é•œåƒè¿è¡Œmysite2çš„è¿‡ç¨‹ã€‚</p>
<hr>
<h3 id="ä½¿ç”¨docker-compose"><a href="#ä½¿ç”¨docker-compose" class="headerlink" title="ä½¿ç”¨docker-compose"></a>ä½¿ç”¨docker-compose</h3><p>ä¸Šé¢å¯åŠ¨äº†ä¸¤ä¸ªå®¹å™¨ï¼Œæ¯”è¾ƒéº»çƒ¦ã€‚å¯ä»¥ä½¿ç”¨docker-composeæ¥ç¼–æ’å®¹å™¨ï¼Œå®ç°å¾®æœåŠ¡æ¶æ„éƒ¨ç½²æ–¹å¼ã€‚</p>
<p>ç¼–å†™<code>docker-compose.yml</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">web:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">zeng/docker_demo_gunicorn:0.3</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"db"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"8100:8000"</span></span><br><span class="line"><span class="comment">#    volumes:</span></span><br><span class="line"><span class="comment">#      - "$&#123;DOCKER_VOLUME_PATH&#125;/docker_demo/media:/root/media"</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">'Asia/Shanghai'</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">qwerasdf</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">mysite2_db</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">['mysqld',</span> <span class="string">'--character-set-server=utf8'</span><span class="string">]</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"$&#123;DOCKER_VOLUME_PATH&#125;/docker_demo/db:/var/lib/mysql"</span></span><br></pre></td></tr></table></figure>
<p>å…ˆåœæ­¢ã€åˆ é™¤æ­£åœ¨è¿è¡Œçš„å®¹å™¨ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547640333927.png" alt="1547640333927"></p>
<p><code>docker-compose up</code>ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547640687934.png" alt="1547640687934"></p>
<p>å¯åŠ¨æˆåŠŸï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1547640743179.png" alt="1547640743179"></p>
<p>åœæ­¢ï¼š<code>docker-compose stop</code></p>
<hr>
<h3 id="å‚è€ƒæ–‡æ¡£"><a href="#å‚è€ƒæ–‡æ¡£" class="headerlink" title="å‚è€ƒæ–‡æ¡£"></a>å‚è€ƒæ–‡æ¡£</h3><ul>
<li><a href="https://yeasy.gitbooks.io/docker_practice/" rel="external nofollow noopener noreferrer" target="_blank">Docker â€” ä»å…¥é—¨åˆ°å®è·µ</a></li>
</ul>
<p>(End)</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Djangoç¬”è®°</title>
    <url>/2020/Django-note/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="django1-11-å’Œdjango2-2çš„ç‰ˆæœ¬æ¯”è¾ƒ"><a href="#django1-11-å’Œdjango2-2çš„ç‰ˆæœ¬æ¯”è¾ƒ" class="headerlink" title="django1.11 å’Œdjango2.2çš„ç‰ˆæœ¬æ¯”è¾ƒ"></a>django1.11 å’Œdjango2.2çš„ç‰ˆæœ¬æ¯”è¾ƒ</h2><p>Django2.<em>ç‰ˆæœ¬å’ŒDjango1.</em>ç‰ˆæœ¬ç›¸æ¯”ï¼Œè™½ç„¶æœ‰å¾ˆå¤šç»†å°åœ°æ–¹çš„æ”¹åŠ¨ï¼Œä½†å°±å…¶å¹³å¸¸å’Œå¼€å‘è€…ä½¿ç”¨æ¯”è¾ƒå¯†åˆ‡ç›¸å…³çš„åœ°æ–¹æ¥è¯´ï¼Œä¸»è¦æœ‰å¦‚ä¸‹ä¸‰ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>urlé…ç½®æ–¹å¼(ä¸»è¦å·®å¼‚)</li>
<li>æ•°æ®åº“æ“ä½œ</li>
<li>ç”¨æˆ·è®¤è¯æ“ä½œ</li>
</ul>
<a id="more"></a>
<h3 id="urlé…ç½®æ–¹å¼"><a href="#urlé…ç½®æ–¹å¼" class="headerlink" title="urlé…ç½®æ–¹å¼"></a>urlé…ç½®æ–¹å¼</h3><ul>
<li>Django1.<em>ä¸­é…ç½®urlåœ°å€ä½¿ç”¨çš„æ˜¯ï¼š<code>urlå‡½æ•°</code>ï¼Œè€ŒDjango2.</em>ä¸­é…ç½®urlåœ°å€ä½¿ç”¨çš„æ˜¯ï¼š<code>pathå‡½æ•°</code></li>
<li>Django1.*ä»urlåœ°å€ä¸­æå–å‚æ•°æ˜¯ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ¥æ¥æå–ï¼Œæ ¼å¼ä¸ºï¼š<code>(?P&lt;å‚æ•°å&gt;æ­£åˆ™è¡¨è¾¾å¼)</code></li>
<li>Django2.*ä»urlåœ°å€ä¸­æå–å‚æ•°æ˜¯ä½¿ç”¨è·¯ç”±è½¬æ¢å™¨æ¥æå–ï¼Œæ ¼å¼ä¸ºï¼š<code>&lt;è·¯ç”±è½¬æ¢å™¨:å‚æ•°å&gt;</code></li>
</ul>
<p>Django2.<em>å¯¹äºæå–å‚æ•°çš„é™åˆ¶å¹¶ä¸å¦‚Django1.</em>çš„æ­£åˆ™æ–¹å¼æ§åˆ¶çš„çµæ´»å’Œä¸¥æ ¼</p>
<p>å¯ä»¥åˆ°django.urls.convertersæ¨¡å—ä¸­è¿›è¡ŒæŸ¥çœ‹ï¼Œæ¯”å¦‚intè·¯ç”±è½¬æ¢å™¨å¯¹åº”çš„æºç </p>
<p>è‡ªå®šä¹‰è·¯ç”±è½¬æ¢å™¨åˆ†ä¸ºä¸¤æ­¥ï¼š</p>
<p>â‘  è‡ªå®šä¹‰è·¯ç”±è½¬æ¢å™¨ç±»ï¼Œåœ¨è½¬æ¢å™¨ç±»ä¸­ï¼Œéœ€è¦é€šè¿‡regexç±»å±æ€§æŒ‡æ˜æå–å‚æ•°æ‰€å¯¹åº”çš„æ­£åˆ™è¡¨è¾¾å¼</p>
<p>â‘¡ è°ƒç”¨register_converteræ–¹æ³•æ³¨å†Œè‡ªå®šä¹‰çš„è·¯ç”±è½¬æ¢å™¨ï¼Œæ³¨å†Œä¹‹åæ‰èƒ½è¿›è¡Œä½¿ç”¨</p>
<p>2.2ä¸­çš„<code>re_path</code>å…¶å®å°±ç›¸å½“äºDjango1.*ä¸­çš„<code>url</code>å‡½æ•°</p>
<h3 id="æ•°æ®åº“è®¾ç½®"><a href="#æ•°æ®åº“è®¾ç½®" class="headerlink" title="æ•°æ®åº“è®¾ç½®"></a>æ•°æ®åº“è®¾ç½®</h3><p>mysqlæ•°æ®åº“é»˜è®¤çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸ºï¼šrepeatable read(å¯é‡å¤è¯»)</p>
<p>Django2.*ä¼šæŠŠmysqlæ•°æ®åº“äº‹åŠ¡çš„éš”ç¦»çº§åˆ«é»˜è®¤è®¾ç½®ä¸ºï¼šread committed(è¯»å–å·²æäº¤)</p>
<p>ForeignKeyå’ŒOneToOneFieldå…³ç³»ä¸­çš„on_deleteå‚æ•°</p>
<h3 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h3><p><strong>is_authenticatedå’Œis_anonymousçš„ä½¿ç”¨</strong></p>
<p>åœ¨Djangoæ¡†æ¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡<code>request.user</code>è·å–è¯·æ±‚çš„ç”¨æˆ·å¯¹è±¡ï¼Œç„¶åé€šè¿‡<code>request.user.is_authenticated</code>åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦æ˜¯è®¤è¯ç”¨æˆ·ï¼Œæˆ–é€šè¿‡<code>request.user.is_anonymous</code>åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦æ˜¯åŒ¿åç”¨æˆ·ï¼Œ<code>is_authenticated</code>å’Œ<code>is_anonymous</code>åœ¨Django1.<em>ä¸­å¯ä»¥å½“åšæ–¹æ³•ä¸€æ ·ä½¿ç”¨ï¼Œä½†æ˜¯åœ¨Django2.</em>ä¸­åªèƒ½å½“åšå±æ€§æ¥ç”¨</p>
<p>æ¥æºï¼šâ€ä¸€æ–‡å¼„æ‡‚Django1.<em>å’ŒDjango2.</em>çš„å·®å¼‚â€œ</p>
<hr>
<p><strong>ç‰ˆæœ¬åŒ¹é…</strong><br>Django 1.11 requires Python 2.7, 3.4, 3.5, 3.6, or 3.7 (as of 1.11.17).<br>Django 2.0 supports Python 3.4, 3.5, 3.6, and 3.7.<br>Django 2.2 supports Python 3.5, 3.6, 3.7, and 3.8 (as of 2.2.8).<br>Django 3.1 supports Python 3.6, 3.7, and 3.8. </p>
<p><a href="https://www.djangoproject.com/download/" rel="external nofollow noopener noreferrer" target="_blank">https://www.djangoproject.com/download/</a><br><a href="https://docs.djangoproject.com/en/3.1/releases/" rel="external nofollow noopener noreferrer" target="_blank">https://docs.djangoproject.com/en/3.1/releases/</a></p>
<hr>
<p><strong>ORM</strong></p>
<p>ORMå°†pythonä»£ç è½¬æ¢æˆSQLè¯­å¥ï¼Œpymysqlç­‰æ•°æ®åº“è¿æ¥åº“å°†SQLè¯­å¥å‘é€ç»™æ•°æ®åº“ï¼Œå¹¶è¿”å›ç»“æœã€‚</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li><p>é¢å‘å¯¹è±¡çš„æ–¹å¼æ“ä½œæ•°æ®ï¼Œæå‡äº†æ•ˆç‡</p>
</li>
<li><p>ä½¿pythonä»£ç ä¸æ•°æ®åº“æ— å…³</p>
</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li><p>ä¼šç‰ºç‰²ä»£ç æ‰§è¡Œæ•ˆç‡</p>
</li>
<li><p>é•¿æœŸä½¿ç”¨ORMï¼Œä¼šé™ä½ç¼–å†™SQLè¯­å¥èƒ½åŠ›</p>
</li>
</ul>
<p><strong>MVC</strong></p>
<p>MVC æ¨¡å¼ï¼ˆModelâ€“viewâ€“controllerï¼‰æ˜¯è½¯ä»¶å·¥ç¨‹ä¸­çš„ä¸€ç§è½¯ä»¶æ¶æ„æ¨¡å¼ï¼ŒæŠŠè½¯ä»¶ç³»ç»Ÿåˆ†ä¸ºä¸‰ä¸ªåŸºæœ¬éƒ¨åˆ†ï¼šæ¨¡å‹ï¼ˆModelï¼‰ã€è§†å›¾ï¼ˆViewï¼‰å’Œæ§åˆ¶å™¨ï¼ˆControllerï¼‰</p>
<p>ä½“ç°äº†æ¨¡å—åŒ–ã€åˆ†å±‚è®¾è®¡æ€æƒ³ï¼š<br>M â€”â€” æ•°æ®å±‚ã€æŒä¹…å±‚<br>V â€”â€” è§†å›¾å±‚ã€è¡¨ç¤ºå±‚<br>C â€”â€” æ§åˆ¶å±‚ã€é€»è¾‘å±‚</p>
<p>ä¸<strong>MTV</strong>æ¨¡å‹çš„åŒºåˆ«ï¼Œä¸»è¦åœ¨äº<strong>MVC</strong>ä¸­çš„CåŒ…å«äº†URLè·¯ç”±çš„åŠŸèƒ½ã€‚</p>
<p>ä»¥springMVCæ¡†æ¶ä¸ºä¾‹è¯´æ˜ï¼š</p>
<p>1ã€ç”¨æˆ·å‘é€è¯·æ±‚è‡³å‰ç«¯æ§åˆ¶å™¨DispatcherServletã€‚</p>
<p>2ã€DispatcherServletæ”¶åˆ°è¯·æ±‚è°ƒç”¨HandlerMappingå¤„ç†å™¨æ˜ å°„å™¨ã€‚</p>
<p>3ã€å¤„ç†å™¨æ˜ å°„å™¨æ‰¾åˆ°å…·ä½“çš„å¤„ç†å™¨(å¯ä»¥æ ¹æ®xmlé…ç½®ã€æ³¨è§£è¿›è¡ŒæŸ¥æ‰¾)ï¼Œç”Ÿæˆå¤„ç†å™¨å¯¹è±¡åŠå¤„ç†å™¨æ‹¦æˆªå™¨(å¦‚æœæœ‰åˆ™ç”Ÿæˆ)ä¸€å¹¶è¿”å›ç»™DispatcherServletã€‚</p>
<p>4ã€DispatcherServletè°ƒç”¨HandlerAdapterå¤„ç†å™¨é€‚é…å™¨ã€‚</p>
<p>5ã€HandlerAdapterç»è¿‡é€‚é…è°ƒç”¨å…·ä½“çš„å¤„ç†å™¨(Controllerï¼Œä¹Ÿå«åç«¯æ§åˆ¶å™¨)ã€‚</p>
<p>6ã€Controlleræ‰§è¡Œå®Œæˆè¿”å›ModelAndViewã€‚</p>
<p>7ã€HandlerAdapterå°†controlleræ‰§è¡Œç»“æœModelAndViewè¿”å›ç»™DispatcherServletã€‚</p>
<p>8ã€DispatcherServletå°†ModelAndViewä¼ ç»™ViewResolverè§†å›¾è§£æå™¨ã€‚</p>
<p>9ã€ViewResolverè§£æåè¿”å›å…·ä½“Viewã€‚</p>
<p>10ã€DispatcherServletæ ¹æ®Viewè¿›è¡Œæ¸²æŸ“è§†å›¾ï¼ˆå³å°†æ¨¡å‹æ•°æ®å¡«å……è‡³è§†å›¾ä¸­ï¼‰ã€‚</p>
<p>11ã€DispatcherServletå“åº”ç”¨æˆ·ã€‚</p>
<p>å…¶ä¸­ï¼Œ4+5é€šè¿‡HandlerAdapteræ‰§è¡Œå¤„ç†å™¨æ˜¯<strong>é€‚é…å™¨æ¨¡å¼</strong>ã€‚</p>
<p><strong>SpringMVCå·¥ä½œåŸç†</strong></p>
<p>ç¬¬ä¸€æ­¥:ç”¨æˆ·å‘èµ·è¯·æ±‚åˆ°å‰ç«¯æ§åˆ¶å™¨ï¼ˆDispatcherServletï¼‰</p>
<p>ç¬¬äºŒæ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨è¯·æ±‚å¤„ç†å™¨æ˜ å°„å™¨ï¼ˆHandlerMapperingï¼‰å»æŸ¥æ‰¾å¤„ç†å™¨ï¼ˆHandleï¼‰ï¼šé€šè¿‡xmlé…ç½®æˆ–è€…æ³¨è§£è¿›è¡ŒæŸ¥æ‰¾</p>
<p>ç¬¬ä¸‰æ­¥ï¼šæ‰¾åˆ°ä»¥åå¤„ç†å™¨æ˜ å°„å™¨ï¼ˆHandlerMapperingï¼‰åƒå‰ç«¯æ§åˆ¶å™¨è¿”å›æ‰§è¡Œé“¾ï¼ˆHandlerExecutionChainï¼‰</p>
<p>ç¬¬å››æ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨ï¼ˆDispatcherServletï¼‰è°ƒç”¨å¤„ç†å™¨é€‚é…å™¨ï¼ˆHandlerAdapterï¼‰å»æ‰§è¡Œå¤„ç†å™¨ï¼ˆHandlerï¼‰</p>
<p>ç¬¬äº”æ­¥ï¼šå¤„ç†å™¨é€‚é…å™¨å»æ‰§è¡ŒHandler</p>
<p>ç¬¬å…­æ­¥ï¼šHandleræ‰§è¡Œå®Œç»™å¤„ç†å™¨é€‚é…å™¨è¿”å›ModelAndView</p>
<p>ç¬¬ä¸ƒæ­¥ï¼šå¤„ç†å™¨é€‚é…å™¨å‘å‰ç«¯æ§åˆ¶å™¨è¿”å›ModelAndView</p>
<p>ç¬¬å…«æ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨è¯·æ±‚è§†å›¾è§£æå™¨ï¼ˆViewResolverï¼‰å»è¿›è¡Œè§†å›¾è§£æ</p>
<p>ç¬¬ä¹æ­¥ï¼šè§†å›¾è§£æå™¨åƒå‰ç«¯æ§åˆ¶å™¨è¿”å›View</p>
<p>ç¬¬åæ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨å¯¹è§†å›¾è¿›è¡Œæ¸²æŸ“</p>
<p>ç¬¬åä¸€æ­¥ï¼šå‰ç«¯æ§åˆ¶å™¨å‘ç”¨æˆ·å“åº”ç»“æœ</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerç¬”è®°</title>
    <url>/2020/Docker-learning/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h1 id="Docker"><a href="#Docker" class="headerlink" title="Docker"></a>Docker</h1><ol>
<li><a href="https://docs.docker.com/engine/docker-overview/" rel="external nofollow noopener noreferrer" target="_blank"><strong>Docker</strong></a> æ˜¯ä¸€ç§<a href="https://en.wikipedia.org/wiki/Operating-system-level_virtualization" rel="external nofollow noopener noreferrer" target="_blank">æ“ä½œç³»ç»Ÿå±‚é¢çš„è™šæ‹ŸåŒ–æŠ€æœ¯</a>ï¼ŒåŸºäº <code>Linux</code> å†…æ ¸çš„ <a href="https://zh.wikipedia.org/wiki/Cgroups" rel="external nofollow noopener noreferrer" target="_blank">cgroup</a>ï¼Œ<a href="https://en.wikipedia.org/wiki/Linux_namespaces" rel="external nofollow noopener noreferrer" target="_blank">namespace</a>ï¼Œä»¥åŠ <a href="https://docs.docker.com/storage/storagedriver/overlayfs-driver/" rel="external nofollow noopener noreferrer" target="_blank">OverlayFS</a> ç±»çš„ <a href="https://en.wikipedia.org/wiki/Union_mount" rel="external nofollow noopener noreferrer" target="_blank">Union FS</a> ç­‰æŠ€æœ¯å¯¹è¿›ç¨‹è¿›è¡Œå°è£…éš”ç¦» ã€‚<a id="more"></a></li>
<li>Dockeræ˜¯ C/Sï¼ˆå®¢æˆ·ç«¯/æœåŠ¡å™¨ï¼‰æ¶æ„ã€‚</li>
<li>Dockerå®¢æˆ·ç«¯ä¸Dockerå®ˆæŠ¤è¿›ç¨‹é€šä¿¡ï¼Œåè€…è´Ÿè´£æ„å»ºï¼Œè¿è¡Œå’Œåˆ†å‘Dockerå®¹å™¨ã€‚</li>
<li>Dockerå®¢æˆ·ç«¯å’Œå®ˆæŠ¤ç¨‹åºä½¿ç”¨REST APIï¼Œé€šè¿‡UNIXå¥—æ¥å­—æˆ–ç½‘ç»œæ¥å£è¿›è¡Œé€šä¿¡ã€‚</li>
</ol>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/architecture.svg" alt="Docker Architecture Diagram" style="zoom:60%;"></p>
<h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨Docker"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨Docker" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨Docker"></a>ä¸ºä»€ä¹ˆä½¿ç”¨Docker</h2><blockquote>
<ul>
<li><strong>æ›´é«˜æ•ˆçš„åˆ©ç”¨ç³»ç»Ÿèµ„æº</strong></li>
<li><strong>æ›´å¿«é€Ÿçš„å¯åŠ¨æ—¶é—´</strong></li>
<li><strong>ä¸€è‡´çš„è¿è¡Œç¯å¢ƒ</strong></li>
<li><strong>æŒç»­äº¤ä»˜å’Œéƒ¨ç½²</strong></li>
<li><strong>æ›´è½»æ¾çš„è¿ç§»</strong></li>
<li><strong>æ›´è½»æ¾çš„ç»´æŠ¤å’Œæ‰©å±•</strong></li>
</ul>
</blockquote>
<p>ç”±äºå®¹å™¨ä¸éœ€è¦è¿›è¡Œç¡¬ä»¶è™šæ‹Ÿä»¥åŠè¿è¡Œå®Œæ•´æ“ä½œç³»ç»Ÿç­‰é¢å¤–å¼€é”€ï¼ŒDockerå¯¹ç³»ç»Ÿèµ„æºçš„åˆ©ç”¨ç‡æ›´é«˜ã€‚æ— è®ºæ˜¯åº”ç”¨æ‰§è¡Œé€Ÿåº¦ã€å†…å­˜æŸè€—æˆ–è€…æ–‡ä»¶å­˜å‚¨é€Ÿåº¦ï¼Œéƒ½è¦æ¯”ä¼ ç»Ÿè™šæ‹ŸæœºæŠ€æœ¯æ›´é«˜æ•ˆã€‚å› æ­¤ï¼Œç›¸æ¯”è™šæ‹ŸæœºæŠ€æœ¯ï¼Œä¸€ä¸ªç›¸åŒé…ç½®çš„ä¸»æœºï¼Œå¾€å¾€å¯ä»¥è¿è¡Œæ›´å¤šæ•°é‡çš„åº”ç”¨ã€‚</p>
<p>ä¼ ç»Ÿçš„è™šæ‹ŸæœºæŠ€æœ¯å¯åŠ¨åº”ç”¨æœåŠ¡å¾€å¾€éœ€è¦æ•°åˆ†é’Ÿï¼Œè€Œ Dockerå®¹å™¨åº”ç”¨ï¼Œç”±äºç›´æ¥è¿è¡Œäºå®¿ä¸»å†…æ ¸ï¼Œæ— éœ€å¯åŠ¨å®Œæ•´çš„æ“ä½œç³»ç»Ÿï¼Œå› æ­¤å¯ä»¥åšåˆ°ç§’çº§ã€ç”šè‡³æ¯«ç§’çº§çš„å¯åŠ¨æ—¶é—´ã€‚å¤§å¤§çš„èŠ‚çº¦äº†å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²çš„æ—¶é—´ã€‚</p>
<p>Dockerçš„é•œåƒæä¾›äº†é™¤å†…æ ¸å¤–å®Œæ•´çš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œç¡®ä¿äº†åº”ç”¨è¿è¡Œç¯å¢ƒä¸€è‡´æ€§ã€‚ä¸€æ¬¡åˆ›å»ºã€é…ç½®ï¼Œä»»æ„åœ°æ–¹æ­£å¸¸è¿è¡Œã€‚</p>
<p><code>Docker</code> ä½¿ç”¨çš„åˆ†å±‚å­˜å‚¨ä»¥åŠé•œåƒçš„æŠ€æœ¯ï¼Œä½¿å¾—åº”ç”¨é‡å¤éƒ¨åˆ†çš„å¤ç”¨æ›´ä¸ºå®¹æ˜“ï¼Œä¹Ÿä½¿å¾—åº”ç”¨çš„ç»´æŠ¤æ›´æ–°æ›´åŠ ç®€å•ï¼ŒåŸºäºåŸºç¡€é•œåƒè¿›ä¸€æ­¥æ‰©å±•é•œåƒä¹Ÿå˜å¾—éå¸¸ç®€å•ã€‚</p>
<h2 id="Docker-ä¸-VM-æ¯”è¾ƒ"><a href="#Docker-ä¸-VM-æ¯”è¾ƒ" class="headerlink" title="Docker ä¸ VM æ¯”è¾ƒ"></a>Docker ä¸ VM æ¯”è¾ƒ</h2><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1561264737939.png" alt="1561264737939" style="zoom:45%;"></p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>å®¹å™¨</th>
<th>è™šæ‹Ÿæœº</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯åŠ¨</td>
<td>ç§’çº§</td>
<td>åˆ†é’Ÿçº§</td>
</tr>
<tr>
<td>ç¡¬ç›˜ä½¿ç”¨</td>
<td>ä¸€èˆ¬ä¸º <code>MB</code>ï¼ˆæœ‰çš„å°åˆ°ä»…å‡ ç™¾KBï¼Œå¦‚K8sçš„pauseé•œåƒï¼‰</td>
<td>ä¸€èˆ¬ä¸º <code>GB</code></td>
</tr>
<tr>
<td>æ€§èƒ½</td>
<td>æ¥è¿‘åŸç”Ÿ</td>
<td>å¼±äº</td>
</tr>
<tr>
<td>ç³»ç»Ÿæ”¯æŒé‡</td>
<td>å•æœºæ”¯æŒä¸Šåƒä¸ªå®¹å™¨</td>
<td>ä¸€èˆ¬å‡ åä¸ª</td>
</tr>
</tbody>
</table>
<h1 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h1><h2 id="é•œåƒ"><a href="#é•œåƒ" class="headerlink" title="é•œåƒ"></a>é•œåƒ</h2><ol>
<li><strong>Docker é•œåƒæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œé™¤äº†æä¾›å®¹å™¨è¿è¡Œæ—¶æ‰€éœ€çš„ç¨‹åºã€åº“ã€èµ„æºã€é…ç½®ç­‰æ–‡ä»¶å¤–ï¼Œè¿˜åŒ…å«äº†ä¸€äº›ä¸ºè¿è¡Œæ—¶å‡†å¤‡çš„ä¸€äº›é…ç½®å‚æ•°ï¼ˆå¦‚åŒ¿åå·ã€ç¯å¢ƒå˜é‡ã€ç”¨æˆ·ç­‰ï¼‰ã€‚é•œåƒä¸åŒ…å«ä»»ä½•åŠ¨æ€æ•°æ®ï¼Œå…¶å†…å®¹åœ¨æ„å»ºä¹‹åä¹Ÿä¸ä¼šè¢«æ”¹å˜ã€‚</li>
<li>é•œåƒé‡‡ç”¨åˆ†å±‚å­˜å‚¨ï¼Œå®é™…ä½“ç°å¹¶éç”±ä¸€ä¸ªæ–‡ä»¶ç»„æˆï¼Œè€Œæ˜¯ç”±ä¸€ç»„æ–‡ä»¶ç³»ç»Ÿç»„æˆï¼Œæˆ–è€…è¯´ï¼Œç”±å¤šå±‚æ–‡ä»¶ç³»ç»Ÿè”åˆç»„æˆã€‚è¿™ä¸ªç‰¹ç‚¹ä¹Ÿä½¿å¾—é•œåƒçš„å¤ç”¨ã€å®šåˆ¶å˜çš„æ›´ä¸ºå®¹æ˜“</li>
<li>é•œåƒåœ¨æ„å»ºæ—¶ï¼Œä¼šä¸€å±‚å±‚æ„å»ºï¼Œå‰ä¸€å±‚æ˜¯åä¸€å±‚çš„åŸºç¡€ã€‚æ¯ä¸€å±‚æ„å»ºå®Œå°±ä¸ä¼šå†å‘ç”Ÿæ”¹å˜ï¼Œåä¸€å±‚ä¸Šçš„ä»»ä½•æ”¹å˜åªå‘ç”Ÿåœ¨è‡ªå·±è¿™ä¸€å±‚ã€‚</li>
</ol>
<h2 id="å®¹å™¨"><a href="#å®¹å™¨" class="headerlink" title="å®¹å™¨"></a>å®¹å™¨</h2><ol>
<li>é•œåƒï¼ˆ<code>Image</code>ï¼‰å’Œå®¹å™¨ï¼ˆ<code>Container</code>ï¼‰çš„å…³ç³»ï¼Œå¥½æ¯”é¢å‘å¯¹è±¡ç¨‹åºè®¾è®¡ä¸­çš„ <code>ç±»</code> å’Œ <code>å®ä¾‹</code> ã€‚</li>
<li>å®¹å™¨çš„å®è´¨æ˜¯è¿›ç¨‹ï¼Œä½†ä¸ç›´æ¥åœ¨å®¿ä¸»æ‰§è¡Œçš„è¿›ç¨‹ä¸åŒï¼Œå®¹å™¨è¿›ç¨‹è¿è¡Œäºå±äºè‡ªå·±çš„ç‹¬ç«‹çš„ <a href="https://en.wikipedia.org/wiki/Linux_namespaces" rel="external nofollow noopener noreferrer" target="_blank">å‘½åç©ºé—´</a>ã€‚</li>
<li>æ¯ä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶ï¼Œæ˜¯ä»¥é•œåƒä¸ºåŸºç¡€å±‚ï¼Œåœ¨å…¶ä¸Šåˆ›å»ºä¸€ä¸ªå½“å‰å®¹å™¨çš„å­˜å‚¨å±‚ï¼Œè¿™ä¸ªä¸ºå®¹å™¨è¿è¡Œæ—¶è¯»å†™è€Œå‡†å¤‡çš„å­˜å‚¨å±‚å« <strong>å®¹å™¨å­˜å‚¨å±‚</strong>ã€‚</li>
<li>å®¹å™¨å­˜å‚¨å±‚çš„ç”Ÿå­˜å‘¨æœŸå’Œå®¹å™¨ä¸€æ ·ã€‚</li>
<li>ä¸éšå®¹å™¨é”€æ¯çš„æ•°æ®çš„è¯»å†™ï¼Œåº”è¯¥ä½¿ç”¨ <strong>æ•°æ®å·</strong>ï¼ˆVolumeï¼‰ã€æˆ–è€…ç»‘å®šå®¿ä¸»ç›®å½•ã€‚</li>
</ol>
<h2 id="ä»“åº“"><a href="#ä»“åº“" class="headerlink" title="ä»“åº“"></a>ä»“åº“</h2><p>ä»“åº“æ˜¯é•œåƒçš„ç‰ˆæœ¬åº“ï¼Œä¸åŒçš„é•œåƒæ ‡ç­¾ä»£è¡¨è¯¥é•œåƒçš„ä¸åŒç‰ˆæœ¬ã€‚Dockeræä¾›äº†<strong>Docker Registry</strong>ä½œä¸ºé•œåƒä»“åº“ç®¡ç†æœåŠ¡ï¼Œç”±äºæ²¡æœ‰å›¾å½¢ç•Œé¢ç­‰åŸå› ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨Docker Hub ï¼ˆå¤–éƒ¨ä¸ªäººç¯å¢ƒï¼‰æˆ– Harborï¼ˆç§æœï¼‰æ‰˜ç®¡Dockeré•œåƒã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1149398-20190917180200231-1649134988.png" alt="img" style="zoom:50%;"></p>
<h1 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h1><p>å½“å‰ä½¿ç”¨çš„dockerç‰ˆæœ¬ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos ~]<span class="comment"># docker version</span></span><br><span class="line">Client:</span><br><span class="line"> Version:           18.09.6</span><br><span class="line"> API version:       1.39</span><br><span class="line"> Go version:        go1.10.8</span><br><span class="line"> Git commit:        481bc77156</span><br><span class="line"> Built:             Sat May  4 02:34:58 2019</span><br><span class="line"> OS/Arch:           linux/amd64</span><br><span class="line"> Experimental:      <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server: Docker Engine - Community</span><br><span class="line"> Engine:</span><br><span class="line">  Version:          18.09.6</span><br><span class="line">  API version:      1.39 (minimum version 1.12)</span><br><span class="line">  Go version:       go1.10.8</span><br><span class="line">  Git commit:       481bc77</span><br><span class="line">  Built:            Sat May  4 02:02:43 2019</span><br><span class="line">  OS/Arch:          linux/amd64</span><br><span class="line">  Experimental:     <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h2 id="é•œåƒæ“ä½œ"><a href="#é•œåƒæ“ä½œ" class="headerlink" title="é•œåƒæ“ä½œ"></a>é•œåƒæ“ä½œ</h2><table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>å‘½ä»¤</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ‹‰å–é•œåƒ</td>
<td><code>docker pull [é€‰é¡¹] [ä»“åº“åœ°å€[:ç«¯å£å·]/]ä»“åº“å[:æ ‡ç­¾]</code></td>
</tr>
<tr>
<td>åˆ—å‡ºé•œåƒ</td>
<td><code>docker images</code> æˆ–è€… <code>docker image ls</code></td>
</tr>
<tr>
<td>æ„å»º</td>
<td>docker build  -t  &lt;é•œåƒåç§°]&gt;  .   [-f Dockerfileè·¯å¾„]</td>
</tr>
<tr>
<td>é‡å‘½å</td>
<td>docker tag   &lt;åŸé•œåƒ&gt;   &lt;æ–°é•œåƒ&gt;</td>
</tr>
<tr>
<td>æ¨é€</td>
<td>docker push   &lt;é•œåƒ&gt;</td>
</tr>
<tr>
<td>åˆ é™¤é•œåƒ</td>
<td><code>docker image rm [é€‰é¡¹] &lt;é•œåƒ1&gt; [&lt;é•œåƒ2&gt; ...]</code> æˆ– <code>docker rmi ...</code></td>
</tr>
<tr>
<td>æŸ¥çœ‹é•œåƒä¿¡æ¯</td>
<td><code>docker inspect  &lt;é•œåƒ&gt;</code></td>
</tr>
</tbody>
</table>
<p>éƒ¨åˆ†ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker pull alpine:latest</span></span><br><span class="line"><span class="comment"># docker image ls</span></span><br><span class="line"><span class="comment"># docker inspect alpine:latest |jq ".[0].RootFS"</span></span><br><span class="line"><span class="comment"># docker rmi alpine:latest</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114182505135.png" alt="image-20201114182505135"></p>
<h2 id="å®¹å™¨æ“ä½œ"><a href="#å®¹å™¨æ“ä½œ" class="headerlink" title="å®¹å™¨æ“ä½œ"></a>å®¹å™¨æ“ä½œ</h2><table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>å‘½ä»¤</th>
</tr>
</thead>
<tbody>
<tr>
<td>è¿è¡Œå®¹å™¨</td>
<td><code>docker run [é€‰é¡¹] &lt;é•œåƒ&gt; [å‘½ä»¤]</code></td>
</tr>
<tr>
<td>åœæ­¢å®¹å™¨</td>
<td><code>docker stop &lt;å®¹å™¨&gt;</code></td>
</tr>
<tr>
<td>åˆ—å‡ºè¿è¡Œä¸­çš„å®¹å™¨</td>
<td><code>docker ps</code></td>
</tr>
<tr>
<td>åˆ é™¤å®¹å™¨</td>
<td><code>docker  rm  &lt;å®¹å™¨&gt;</code></td>
</tr>
</tbody>
</table>
<p>éƒ¨åˆ†ç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker run -it --rm --name test_a  alpine:3 sh   # -iäº¤äº’ï¼Œ-tç»ˆç«¯ï¼Œ--rmé€€å‡ºå³åˆ é™¤</span></span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">/ <span class="comment"># exit</span></span><br><span class="line"><span class="comment"># åœ¨exitä¹‹å‰ï¼Œå¦å¼€ä¸€ä¸ªsshçª—å£æŸ¥çœ‹</span></span><br><span class="line"><span class="comment"># docker ps |grep test_a</span></span><br><span class="line"><span class="comment"># é€€å‡ºåå†æŸ¥çœ‹ï¼Œä¸Šé¢è¿™ä¸ªå®¹å™¨å·²æ¶ˆå¤±</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114182805493.png" alt="image-20201114182805493"></p>
<h2 id="ç£ç›˜ç©ºé—´ç®¡ç†"><a href="#ç£ç›˜ç©ºé—´ç®¡ç†" class="headerlink" title="ç£ç›˜ç©ºé—´ç®¡ç†"></a>ç£ç›˜ç©ºé—´ç®¡ç†</h2><p><code>docker system</code> å‘½ä»¤ç”¨äºç®¡ç†ç£ç›˜ç©ºé—´ã€‚</p>
<h3 id="æŸ¥çœ‹dockerç£ç›˜å ç”¨"><a href="#æŸ¥çœ‹dockerç£ç›˜å ç”¨" class="headerlink" title="æŸ¥çœ‹dockerç£ç›˜å ç”¨"></a>æŸ¥çœ‹dockerç£ç›˜å ç”¨</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker system df</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114182958747.png" alt="image-20201114182958747" style="zoom:50%;"></p>
<h3 id="æ¸…ç†dockerç£ç›˜ç©ºé—´"><a href="#æ¸…ç†dockerç£ç›˜ç©ºé—´" class="headerlink" title="æ¸…ç†dockerç£ç›˜ç©ºé—´"></a>æ¸…ç†dockerç£ç›˜ç©ºé—´</h3><p><code>docker system prune</code> å‘½ä»¤å¯ä»¥ç”¨äºæ¸…ç†ç£ç›˜ï¼Œåˆ é™¤å…³é—­çš„å®¹å™¨ã€æ— ç”¨çš„æ•°æ®å·å’Œç½‘ç»œï¼Œä»¥åŠdanglingé•œåƒ(å³æ— tagçš„é•œåƒ)ã€‚<br><code>docker system prune -a</code> å‘½ä»¤æ¸…ç†å¾—æ›´åŠ å½»åº•ï¼Œå¯ä»¥å°†æ²¡æœ‰å®¹å™¨ä½¿ç”¨Dockeré•œåƒéƒ½åˆ æ‰ã€‚<br>æ³¨æ„ï¼Œè¿™ä¸¤ä¸ªå‘½ä»¤ä¼šæŠŠä½ æš‚æ—¶å…³é—­çš„å®¹å™¨ï¼Œä»¥åŠæš‚æ—¶æ²¡æœ‰ç”¨åˆ°çš„Dockeré•œåƒéƒ½åˆ æ‰ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker system prune </span></span><br><span class="line">WARNING! This will remove:</span><br><span class="line">        - all stopped containers</span><br><span class="line">        - all networks not used by at least one container</span><br><span class="line">        - all dangling images</span><br><span class="line">        - all dangling build cache</span><br><span class="line">Are you sure you want to <span class="built_in">continue</span>? [y/N] y</span><br><span class="line">Deleted Containers:</span><br><span class="line">ï¼ˆç•¥ï¼‰</span><br><span class="line">Deleted Networks:</span><br><span class="line">ï¼ˆç•¥ï¼‰</span><br><span class="line">Total reclaimed space: 2.627GB</span><br></pre></td></tr></table></figure>
<h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><p>Dockerfile æ˜¯ä¸€ä¸ªæè¿°å¦‚ä½•æ„å»ºé•œåƒçš„æ–‡æœ¬æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«å¤šæ¡<strong>æŒ‡ä»¤(Instruction)</strong>ï¼Œæ¯æ¡æŒ‡ä»¤æ„å»ºä¸€å±‚é•œåƒã€‚<br>éƒ¨åˆ†å¸¸ç”¨æŒ‡ä»¤ï¼š</p>
<ul>
<li>FROMï¼šæŒ‡å®šåŸºç¡€é•œåƒï¼Œå¦‚ <code>FROM apline:latest</code>ï¼Œalpineæ˜¯ä¸€ä¸ªç²¾ç®€çš„Linuxç³»ç»Ÿé•œåƒã€‚</li>
<li>MAINTAINERï¼šè®¾ç½®é•œåƒçš„ç»´æŠ¤è€…ä¿¡æ¯</li>
<li>ARGï¼šå‚æ•°è®¾ç½®</li>
<li>ENVï¼šç¯å¢ƒå˜é‡è®¾ç½®</li>
<li>ADDï¼šæ·»åŠ æ„å»ºä¸Šä¸‹æ–‡ï¼ŒADDæ·»åŠ tar.gzåŒ…ä¼šè‡ªåŠ¨è§£å‹ã€‚</li>
<li>COPYï¼šå¤åˆ¶æ–‡ä»¶</li>
<li>RUNï¼šç¼–å†™ä¸€äº›shellå‘½ä»¤</li>
<li>EXPOSEï¼šæš´éœ²å®¹å™¨éœ€ç›‘å¬çš„ç«¯å£</li>
<li>CMDï¼šå®¹å™¨å¯åŠ¨åæ‰§è¡Œçš„å‘½ä»¤</li>
<li>ENTRYPOINTï¼šå…¥å£æŒ‡ä»¤</li>
</ul>
<font color="red">é—®é¢˜ï¼šæœ‰äº† <code>CMD</code> åï¼Œä¸ºä»€ä¹ˆè¿˜è¦æœ‰ <code>ENTRYPOINT</code> ï¼Ÿ</font>

<p>å½“å­˜åœ¨ <code>ENTRYPOINT</code> åï¼Œ<code>CMD</code> çš„å†…å®¹å°†ä¼šä½œä¸ºå‚æ•°ä¼ ç»™ <code>ENTRYPOINT</code></p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos demo]<span class="comment"># cat Dockerfile-curl</span></span><br><span class="line">FROM alpine:latest</span><br><span class="line"></span><br><span class="line">RUN apk add curl --no-cache</span><br><span class="line">CMD [<span class="string">"curl"</span>, <span class="string">"-s"</span>, <span class="string">"https://baidu.com/"</span>]</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos demo]<span class="comment"># cat Dockerfile-curl2 </span></span><br><span class="line">FROM alpine:latest</span><br><span class="line"></span><br><span class="line">RUN apk add curl --no-cache</span><br><span class="line">ENTRYPOINT [<span class="string">"curl"</span>, <span class="string">"-s"</span>, <span class="string">"https://baidu.com/"</span>]</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114164336012.png" alt="image-20201114164336012" style="zoom:50%;"></p>
<p>åŠ CMDå‚æ•° <code>-I</code> æ—¶ï¼Œåªæœ‰ mycurl2 æ”¯æŒï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114164149433.png" alt="image-20201114164149433" style="zoom:50%;"></p>
<p>æœ‰äº›æ—¶å€™ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹å‰ï¼Œéœ€è¦ä¸€äº›å‡†å¤‡å·¥ä½œï¼Œè¿™äº›å‡†å¤‡å·¥ä½œæ˜¯å’Œå®¹å™¨ <code>CMD</code> æ— å…³çš„ï¼Œæ— è®º <code>CMD</code> ä¸ºä»€ä¹ˆï¼Œéƒ½éœ€è¦äº‹å…ˆè¿›è¡Œä¸€ä¸ªé¢„å¤„ç†çš„å·¥ä½œã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥å†™ä¸€ä¸ªè„šæœ¬ï¼Œç„¶åæ”¾å…¥ <code>ENTRYPOINT</code> ä¸­å»æ‰§è¡Œï¼Œè€Œè¿™ä¸ªè„šæœ¬ä¼šå°†æ¥åˆ°çš„å‚æ•°ï¼ˆä¹Ÿå°±æ˜¯CMDï¼‰ä½œä¸ºå‘½ä»¤ï¼Œåœ¨è„šæœ¬æœ€åæ‰§è¡Œã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos demo]<span class="comment"># cat start.sh</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># begin: do sth</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"do sth ..."</span></span><br><span class="line"><span class="comment"># end: do sth</span></span><br><span class="line"></span><br><span class="line">cmd=<span class="string">"curl -s https://baidu.com/"</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">which</span> <span class="string">"<span class="variable">$1</span>"</span> 1&gt;/dev/null 2&gt;&amp;1; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"exec 1:"</span></span><br><span class="line">    <span class="built_in">exec</span> <span class="variable">$@</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"exec 2:"</span></span><br><span class="line">    <span class="built_in">exec</span> <span class="variable">$cmd</span> <span class="variable">$@</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"end."</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#########################################################</span></span><br><span class="line">[root@VM_0_13_centos demo]<span class="comment"># cat Dockerfile-curl3</span></span><br><span class="line">FROM alpine:latest</span><br><span class="line"></span><br><span class="line">WORKDIR /opt</span><br><span class="line">ADD start.sh start.sh</span><br><span class="line">RUN chmod +x start.sh &amp;&amp; apk add curl --no-cache</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"/opt/start.sh"</span>]</span><br><span class="line">CMD [<span class="string">"curl"</span>, <span class="string">"-s"</span>, <span class="string">"https://baidu.com/"</span>]</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114174831869.png"></p>
<ul>
<li><p>VOLUMEæŒ‡ä»¤</p>
<p>å¯ä»¥é€šè¿‡ <code>docker run</code> å‘½ä»¤çš„ <code>-v</code> å‚æ•°åˆ›å»º volume æŒ‚è½½ç‚¹ã€‚å¦‚æœé€šè¿‡ dockerfile çš„ VOLUME æŒ‡ä»¤å¯ä»¥åœ¨é•œåƒä¸­åˆ›å»ºæŒ‚è½½ç‚¹ï¼Œé‚£ä¹ˆé€šè¿‡è¯¥é•œåƒåˆ›å»ºå®¹å™¨æ—¶ä¸æŒ‡å®š -v å‚æ•°æ—¶ï¼Œä¼šåœ¨å®¿ä¸»æœºä¸Šéšæœºç”Ÿæˆä¸€ä¸ªæ•°æ®ç›®å½•ç»‘å®šåˆ° VOLUME æ‰€æŒ‡å®šçš„å®¹å™¨å†…ç›®å½•ã€‚</p>
<p>ä»¥Wordpressçš„volumeä¸ºä¾‹ï¼š</p>
</li>
</ul>
<p><strong>wordpress</strong></p>
<p>ç¼ºçœæƒ…å†µä¸‹ï¼Œwordpresså®¹å™¨å†…çš„/var/www/htmlç›®å½•ä¼šè¢«éšæœºæŒ‚è½½åˆ°å®¿ä¸»æœºdockeræ•°æ®ç›®å½•ä¸‹ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114191120752.png" alt="image-20201114191120752"></p>
<p><strong>wordpress mysql</strong></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114191512336.png" alt="image-20201114191512336"></p>
<h2 id="Dockerfileç¤ºä¾‹"><a href="#Dockerfileç¤ºä¾‹" class="headerlink" title="Dockerfileç¤ºä¾‹"></a>Dockerfileç¤ºä¾‹</h2><h3 id="ç¤ºä¾‹-â€“-nginx"><a href="#ç¤ºä¾‹-â€“-nginx" class="headerlink" title="ç¤ºä¾‹ â€“ nginx"></a>ç¤ºä¾‹ â€“ nginx</h3><p>å‡è®¾nginxæ²¡æœ‰æä¾›dockeré•œåƒï¼Œä½¿ç”¨ç²¾ç®€çš„Linuxç³»ç»Ÿé•œåƒalpineæ¥åˆ¶ä½œnginxå®¹å™¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FROM alpine:latest</span><br><span class="line">MAINTAINER  tom  tom@abc.com</span><br><span class="line"> </span><br><span class="line"><span class="comment"># install nginx</span></span><br><span class="line">RUN apk --update add nginx</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"> </span><br><span class="line">CMD [ <span class="string">"nginx"</span> ,  <span class="string">"-g"</span> ,  <span class="string">"daemon off;"</span> ]</span><br></pre></td></tr></table></figure>
<h3 id="ç¤ºä¾‹-â€“-myweb"><a href="#ç¤ºä¾‹-â€“-myweb" class="headerlink" title="ç¤ºä¾‹ â€“ myweb"></a>ç¤ºä¾‹ â€“ myweb</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FROM python:2.7-alpine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ARG APP_HOME</span><br><span class="line">ENV APP_HOME=<span class="variable">$&#123;APP_HOME:-/opt/apps&#125;</span></span><br><span class="line"></span><br><span class="line">WORKDIR <span class="variable">$APP_HOME</span></span><br><span class="line">COPY ./myweb  myweb</span><br><span class="line"></span><br><span class="line">RUN <span class="built_in">echo</span> <span class="string">"https://mirror.tuna.tsinghua.edu.cn/alpine/v3.11/main/"</span> &gt; /etc/apk/repositories &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"https://mirror.tuna.tsinghua.edu.cn/alpine/v3.11/community/"</span> &gt;&gt; /etc/apk/repositories &amp;&amp; \</span><br><span class="line">    apk add gcc g++ make mysql-dev --no-cache &amp;&amp; \</span><br><span class="line">    pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple &amp;&amp; \</span><br><span class="line">    pip install -U pip &amp;&amp; \</span><br><span class="line">    pip install supervisor==4.2.0 &amp;&amp; \</span><br><span class="line">    /usr/<span class="built_in">local</span>/bin/echo_supervisord_conf &gt; /etc/supervisord.conf &amp;&amp; \</span><br><span class="line">    mkdir /etc/supervisord.d &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[include]"</span> &gt;&gt; /etc/supervisord.conf &amp;&amp; \</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"files = supervisord.d/*.conf"</span> &gt;&gt; /etc/supervisord.conf &amp;&amp; \</span><br><span class="line">    pip install -r <span class="variable">$APP_HOME</span>/myweb/requirements.txt &amp;&amp; \</span><br><span class="line">    cp <span class="variable">$APP_HOME</span>/myweb/myweb_supervisord.conf  /etc/supervisord.d/</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="variable">$PORT</span></span><br><span class="line">CMD [<span class="string">"supervisord"</span>, <span class="string">"-n"</span>, <span class="string">"-c"</span>, <span class="string">"/etc/supervisord.conf"</span>]</span><br></pre></td></tr></table></figure>
<h2 id="æ„å»ºã€è¿è¡Œ"><a href="#æ„å»ºã€è¿è¡Œ" class="headerlink" title="æ„å»ºã€è¿è¡Œ"></a>æ„å»ºã€è¿è¡Œ</h2><blockquote>
<p>å‘å‡º <code>docker build</code> å‘½ä»¤æ—¶ï¼Œå½“å‰å·¥ä½œç›®å½•ç§°ä¸ºbuild contextã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒDockerfileå‡å®šä½äºæ­¤å¤„ï¼Œä½†å¯ä»¥ä½¿ç”¨æ–‡ä»¶æ ‡å¿—ï¼ˆ-fï¼‰æŒ‡å®šå…¶ä»–ä½ç½®ã€‚ä¸ç®¡Dockerfileå®é™…ä½äºä½•å¤„ï¼Œå½“å‰ç›®å½•ä¸­æ–‡ä»¶å’Œç›®å½•çš„æ‰€æœ‰é€’å½’å†…å®¹éƒ½å°†ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡å‘é€åˆ°Dockerå®ˆæŠ¤è¿›ç¨‹ã€‚</p>
</blockquote>
<h3 id="ç¤ºä¾‹-â€“-nginx-1"><a href="#ç¤ºä¾‹-â€“-nginx-1" class="headerlink" title="ç¤ºä¾‹ â€“ nginx"></a>ç¤ºä¾‹ â€“ nginx</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114130107466.png" alt="image-20201114130107466"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114130305997.png" alt="image-20201114130305997"></p>
<p>å¯ä»¥çœ‹å‡º nginx:tom æ¯”å®˜æ–¹æä¾›çš„ nginx:alpine è¿˜æ›´å°ã€‚</p>
<h3 id="ç¤ºä¾‹-â€“-myweb-1"><a href="#ç¤ºä¾‹-â€“-myweb-1" class="headerlink" title="ç¤ºä¾‹ â€“ myweb"></a>ç¤ºä¾‹ â€“ myweb</h3><p>Dockerfileæ–‡ä»¶åç§°ä¸æ˜¯ <code>Dockerfile</code> æ—¶ï¼Œéœ€é€šè¿‡ <code>-f</code> å‚æ•°æŒ‡å®šï¼Œç‚¹å· <code>.</code> è¡¨ç¤ºå½“å‰ç›®å½•ä½œä¸ºæ„å»ºä¸Šä¸‹æ–‡ã€‚å¦‚æœåœ¨demoçš„ä¸Šä¸€çº§ç›®å½•æ‰§è¡Œæ„å»ºï¼Œåˆ™å‘½ä»¤å¯ä»¥è¿™æ ·å†™ï¼š</p>
<p><code>docker build -f demo/Dockerfile-myweb -t myweb:0.1 demo</code></p>
<p>æ„å»ºæ—¶æ‰“å°çš„å†…å®¹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos demo]<span class="comment"># docker build -f Dockerfile-myweb -t myweb:0.1 .</span></span><br><span class="line">Sending build context to Docker daemon  1.117MB</span><br><span class="line">Step 1/9 : FROM python:2.7-alpine</span><br><span class="line"> ---&gt; 8579e446340f</span><br><span class="line">Step 2/9 : ARG APP_HOME</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 9c173fd3707d</span><br><span class="line">Step 3/9 : ENV APP_HOME=<span class="variable">$&#123;APP_HOME:-/opt/apps&#125;</span></span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 721207dba6e7</span><br><span class="line">Step 4/9 : WORKDIR <span class="variable">$APP_HOME</span></span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 99a3b8ce16a1</span><br><span class="line">Step 5/9 : COPY ./myweb  myweb</span><br><span class="line"> ---&gt; 2e9790a1fa90</span><br><span class="line">Step 6/9 : VOLUME [<span class="string">"<span class="variable">$APP_HOME</span>/myweb"</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 1e647a4987d7</span><br><span class="line">Removing intermediate container 1e647a4987d7</span><br><span class="line"> ---&gt; dd03f21e2aa6</span><br><span class="line"><span class="comment">############### ç¬¬7æ­¥ æ„å»ºRUNå‘½ä»¤ï¼Œæ›´æ–°è½¯ä»¶æºï¼Œæ›´æ–°è½¯ä»¶ï¼Œå®‰è£…è½¯ä»¶åŠå…¶ä¾èµ–ç­‰ï¼Œæ­¥éª¤æœ€å¤š</span></span><br><span class="line">Step 7/9 : RUN <span class="built_in">echo</span> <span class="string">"https://mirror.tuna.tsinghua.edu.cn/alpine/v3.11/main/"</span> &gt; /etc/apk/repositories &amp;&amp;     <span class="built_in">echo</span> <span class="string">"https://mirror.tuna.tsinghua.edu.cn/alpine/v3.11/community/"</span> &gt;&gt; /etc/apk/repositories &amp;&amp;     apk add gcc g++ make mysql-dev --no-cache &amp;&amp;     pip config <span class="built_in">set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple &amp;&amp;     pip install -U pip &amp;&amp;     pip install supervisor==4.2.0 &amp;&amp;     /usr/<span class="built_in">local</span>/bin/echo_supervisord_conf &gt; /etc/supervisord.conf &amp;&amp;     mkdir /etc/supervisord.d &amp;&amp;     <span class="built_in">echo</span> <span class="string">"[include]"</span> &gt;&gt; /etc/supervisord.conf &amp;&amp;     <span class="built_in">echo</span> <span class="string">"files = supervisord.d/*.conf"</span> &gt;&gt; /etc/supervisord.conf &amp;&amp;     <span class="built_in">cd</span> <span class="variable">$APP_HOME</span>/myweb &amp;&amp;     pip install -r requirements.txt &amp;&amp;     cp <span class="variable">$APP_HOME</span>/myweb/myweb_supervisord.conf  /etc/supervisord.d/</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> 3b58653054de</span><br><span class="line">fetch https://mirror.tuna.tsinghua.edu.cn/alpine/v3.11/main/x86_64/APKINDEX.tar.gz</span><br><span class="line">fetch https://mirror.tuna.tsinghua.edu.cn/alpine/v3.11/community/x86_64/APKINDEX.tar.gz</span><br><span class="line">(1/27) Upgrading libcrypto1.1 (1.1.1d-r3 -&gt; 1.1.1g-r0)</span><br><span class="line">ï¼ˆæ­¤å¤„çœç•¥è‹¥å¹²è¡Œï¼‰</span><br><span class="line">(27/27) Installing mariadb-dev (10.4.15-r0)</span><br><span class="line">Executing busybox-1.31.1-r9.trigger</span><br><span class="line">Executing ca-certificates-20191127-r1.trigger</span><br><span class="line">OK: 206 MiB <span class="keyword">in</span> 57 packages</span><br><span class="line">Writing to /root/.config/pip/pip.conf</span><br><span class="line">ï¼ˆæ­¤å¤„çœç•¥è‹¥å¹²è¡Œï¼‰</span><br><span class="line">Successfully installed pip-20.2.4</span><br><span class="line">ï¼ˆæ­¤å¤„çœç•¥è‹¥å¹²è¡Œï¼‰</span><br><span class="line">Successfully installed supervisor-4.2.0</span><br><span class="line">ï¼ˆæ­¤å¤„çœç•¥è‹¥å¹²è¡Œï¼‰</span><br><span class="line">Successfully built mysqlclient</span><br><span class="line">Installing collected packages: pytz, django, mysqlclient</span><br><span class="line">Successfully installed django-1.11 mysqlclient-1.3.12 pytz-2020.4</span><br><span class="line">Removing intermediate container 3b58653054de</span><br><span class="line"> ---&gt; 74221bc92419</span><br><span class="line"><span class="comment">############### ç¬¬8æ­¥ æš´éœ²ç›‘å¬ç«¯å£</span></span><br><span class="line">Step 8/9 : EXPOSE <span class="variable">$PORT</span></span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> bc109d388ec3</span><br><span class="line">Removing intermediate container bc109d388ec3</span><br><span class="line"> ---&gt; 7f45f5e2be2c</span><br><span class="line">Step 9/9 : CMD [<span class="string">"supervisord"</span>, <span class="string">"-n"</span>, <span class="string">"-c"</span>, <span class="string">"/etc/supervisord.conf"</span>]</span><br><span class="line"> ---&gt; Running <span class="keyword">in</span> f0f4f867b879</span><br><span class="line">Removing intermediate container f0f4f867b879</span><br><span class="line"> ---&gt; 4eede34e1dad</span><br><span class="line">Successfully built 4eede34e1dad</span><br><span class="line">Successfully tagged myweb:0.1</span><br></pre></td></tr></table></figure>
<p><strong>è¿è¡Œmyweb</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos opt]<span class="comment"># docker run -d --name myweb -p 8009:8000 myweb:0.1</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114145718759.png" alt="image-20201114145718759" style="zoom:67%;"></p>
<p><strong>æŸ¥çœ‹å®¹å™¨è¿›ç¨‹</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos demo]<span class="comment"># docker ps |grep myweb</span></span><br></pre></td></tr></table></figure>
<p><strong>æŸ¥çœ‹volume</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker inspect 9ad3a7949611 |jq ".[0].Mounts"</span></span><br><span class="line">æˆ–è€…</span><br><span class="line"><span class="comment"># docker inspect myweb |jq ".[0].Mounts"</span></span><br></pre></td></tr></table></figure>
<p><strong>æŸ¥çœ‹env</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos demo]<span class="comment"># docker inspect myweb |jq ".[0].Config.Env"</span></span><br></pre></td></tr></table></figure>
<p><strong>è¿›å…¥å®¹å™¨æŸ¥çœ‹</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos demo]<span class="comment"># docker exec -it myweb sh</span></span><br><span class="line">/opt/apps <span class="comment"># hostname</span></span><br><span class="line">/opt/apps <span class="comment"># env</span></span><br><span class="line">/opt/apps <span class="comment"># ps -ef</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114193616082.png" alt="image-20201114193616082"></p>
<h2 id="Dockerfileæœ€ä½³å®è·µ"><a href="#Dockerfileæœ€ä½³å®è·µ" class="headerlink" title="Dockerfileæœ€ä½³å®è·µ"></a>Dockerfileæœ€ä½³å®è·µ</h2><p>ç²¾ç®€Dockeré•œåƒçš„å¥½å¤„ï¼š</p>
<ol>
<li>å‡å°‘æ„å»ºæ—¶é—´</li>
<li>å‡å°‘ç£ç›˜ä½¿ç”¨é‡</li>
<li>å‡å°‘ä¸‹è½½æ—¶é—´</li>
<li>å› ä¸ºåŒ…å«æ–‡ä»¶å°‘ï¼Œæ”»å‡»é¢å‡å°ï¼Œæé«˜äº†å®‰å…¨æ€§</li>
<li>æé«˜éƒ¨ç½²é€Ÿåº¦</li>
</ol>
<h3 id="é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ"><a href="#é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ" class="headerlink" title="é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ"></a>é€‰æ‹©åˆé€‚çš„åŸºç¡€é•œåƒ</h3><p><code>alpine</code> æ˜¯ä¸€ä¸ªç²¾ç®€çš„Linuxå‘è¡Œç‰ˆï¼Œåªæœ‰5MBå·¦å³ã€‚å„å¼€å‘è¯­è¨€å’Œæ¡†æ¶ä¸€èˆ¬éƒ½æœ‰åŸºäºalpineçš„é•œåƒç‰ˆæœ¬ï¼Œå¦‚ <code>python:3-alpine</code>ï¼Œå¯ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨alpineç‰ˆæœ¬çš„é•œåƒã€‚</p>
<p><code>scratch</code> æ˜¯ä¸€ä¸ªç©ºé•œåƒã€‚</p>
<p>å¯¹äº Linux ä¸‹é™æ€ç¼–è¯‘çš„ç¨‹åºæ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æœ‰æ“ä½œç³»ç»Ÿæä¾›è¿è¡Œæ—¶æ”¯æŒï¼Œæ‰€éœ€çš„ä¸€åˆ‡åº“éƒ½å·²ç»åœ¨å¯æ‰§è¡Œæ–‡ä»¶é‡Œäº†ï¼Œå› æ­¤ç›´æ¥ <code>FROM scratch</code> ä¼šè®©é•œåƒä½“ç§¯æ›´åŠ å°å·§ã€‚ä½¿ç”¨Goè¯­è¨€å¼€å‘çš„åº”ç”¨å¾ˆå¤šä¼šä½¿ç”¨è¿™ç§æ–¹å¼æ¥åˆ¶ä½œé•œåƒã€‚</p>
<p>Google K8sçš„ <code>pause</code> é•œåƒæ­£æ˜¯ä½¿ç”¨äº†scratchä½œä¸ºåŸºç¡€é•œåƒï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FROM scratch</span><br><span class="line">ARG ARCH</span><br><span class="line">ADD bin/pause-<span class="variable">$&#123;ARCH&#125;</span> /pause</span><br><span class="line">ENTRYPOINT [<span class="string">"/pause"</span>]</span><br></pre></td></tr></table></figure>
<p>å…¶å¤§å°ä¸åˆ°1MBã€‚</p>
<p>å¦‚æœå¸Œæœ›é•œåƒé‡Œå¯ä»¥åŒ…å«ä¸€äº›å¸¸ç”¨çš„Linuxå·¥å…·ï¼Œå¯ä»¥ä½¿ç”¨ <code>busybox</code>ã€‚</p>
<h3 id="å¤šé˜¶æ®µæ„å»º"><a href="#å¤šé˜¶æ®µæ„å»º" class="headerlink" title="å¤šé˜¶æ®µæ„å»º"></a>å¤šé˜¶æ®µæ„å»º</h3><p>ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œå¯ä»¥åœ¨Dockerfileä¸­ä½¿ç”¨å¤šä¸ªFROMè¯­å¥ï¼Œæ¯æ¡FROMæŒ‡ä»¤å¯ä»¥ä½¿ç”¨ä¸åŒçš„åŸºç¡€é•œåƒï¼Œç„¶åé€‰æ‹©æ€§åœ°å°†æœåŠ¡ç»„ä»¶ä»ä¸€ä¸ªé˜¶æ®µCOPYåˆ°å¦ä¸€ä¸ªé˜¶æ®µï¼Œåœ¨æœ€ç»ˆé•œåƒä¸­åªä¿ç•™éœ€è¦çš„å†…å®¹ã€‚ç»“åˆä»¥ä¸‹</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FROM &lt;base_image&gt; AS &lt;tmp_image&gt;</span><br><span class="line">COPY --from=&lt;tmp_image&gt; &lt;src&gt; &lt;dest&gt;</span><br></pre></td></tr></table></figure>
<p>ä¸¤æ¡è¯­å¥æ¥ä½¿ç”¨å¤šé˜¶æ®µæ„å»ºã€‚å‡è®¾æœ‰ä¸€ä¸ªspringboot demoï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FROM maven:3.5-jdk-8-alpine AS builder</span><br><span class="line">WORKDIR /opt</span><br><span class="line">COPY . /opt/</span><br><span class="line">RUN mvn clean package</span><br><span class="line"></span><br><span class="line">FROM java:8-alpine AS filnal</span><br><span class="line">WORKDIR /opt</span><br><span class="line">COPY --from=builder /opt/target/demo.jar .</span><br><span class="line">EXPOSE 8080</span><br><span class="line">CMD [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"demo.jar"</span>]</span><br></pre></td></tr></table></figure>
<h3 id="å…¶å®ƒå»ºè®®"><a href="#å…¶å®ƒå»ºè®®" class="headerlink" title="å…¶å®ƒå»ºè®®"></a>å…¶å®ƒå»ºè®®</h3><ul>
<li>å¯ä»¥åœ¨æ‰§è¡Œ <code>apt-get install -y</code> æ—¶å¢åŠ é€‰é¡¹ <code>--no-install-recommends</code> ï¼Œä¸å®‰è£…å»ºè®®æ€§ï¼ˆéå¿…é¡»ï¼‰çš„ä¾èµ–ã€‚</li>
<li>å¯ä»¥åœ¨æ‰§è¡Œ <code>apk add</code> æ—¶æ·»åŠ é€‰é¡¹ <code>--no-cache</code>ã€‚</li>
<li>Ubuntuæˆ–Debianå¯ä»¥ä½¿ç”¨ <code>rm -rf /var/lib/apt/lists/*</code> æ¸…ç†é•œåƒä¸­ç¼“å­˜æ–‡ä»¶ã€‚</li>
<li>CentOSç­‰ç³»ç»Ÿä½¿ç”¨ <code>yum clean all</code> å‘½ä»¤æ¸…ç†ã€‚</li>
</ul>
<h1 id="docker-compose"><a href="#docker-compose" class="headerlink" title="docker-compose"></a>docker-compose</h1><p>Compose é¡¹ç›®æ˜¯ Docker å®˜æ–¹çš„å¼€æºé¡¹ç›®ï¼Œè´Ÿè´£å®ç°å¯¹ Docker å®¹å™¨é›†ç¾¤çš„å¿«é€Ÿç¼–æ’ã€‚<br>Composeç”¨äºå®šä¹‰å’Œè¿è¡Œå¤šä¸ª Docker å®¹å™¨çš„åº”ç”¨ï¼ˆDefining and running multi-container Docker applicationsï¼‰ã€‚</p>
<p>Compose ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</p>
<ul>
<li>æœåŠ¡ (<code>service</code>)ï¼šä¸€ä¸ªåº”ç”¨çš„å®¹å™¨ï¼Œå®é™…ä¸Šå¯ä»¥åŒ…æ‹¬è‹¥å¹²è¿è¡Œç›¸åŒé•œåƒçš„å®¹å™¨å®ä¾‹ã€‚</li>
<li>é¡¹ç›® (<code>project</code>)ï¼šç”±ä¸€ç»„å…³è”çš„åº”ç”¨å®¹å™¨ç»„æˆçš„ä¸€ä¸ªå®Œæ•´ä¸šåŠ¡å•å…ƒï¼Œåœ¨ <code>docker-compose.yml</code> æ–‡ä»¶ä¸­å®šä¹‰ã€‚</li>
</ul>
<p>Compose çš„é»˜è®¤ç®¡ç†å¯¹è±¡æ˜¯<strong>é¡¹ç›®</strong>ï¼Œé€šè¿‡<strong>å­å‘½ä»¤</strong>å¯¹é¡¹ç›®ä¸­çš„ä¸€ç»„å®¹å™¨è¿›è¡Œä¾¿æ·åœ°ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚</p>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ sudo curl -L https://github.com/docker/compose/releases/download/1.25.5/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"></span><br><span class="line">$ sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…é€šè¿‡pipå®‰è£…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ sudo pip install -U docker-compose</span><br></pre></td></tr></table></figure>
<h2 id="docker-composeç¤ºä¾‹-â€”â€”-WordPress"><a href="#docker-composeç¤ºä¾‹-â€”â€”-WordPress" class="headerlink" title="docker-composeç¤ºä¾‹ â€”â€” WordPress"></a>docker-composeç¤ºä¾‹ â€”â€” WordPress</h2><p>docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">"3"</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">db:</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">mysql:8.0</span></span><br><span class="line">     <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--default_authentication_plugin=mysql_native_password</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--character-set-server=utf8mb4</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">--collation-server=utf8mb4_unicode_ci</span>     </span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">db_data:/var/lib/mysql</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">       <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">somewordpress</span></span><br><span class="line">       <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"></span><br><span class="line">   <span class="attr">wordpress:</span></span><br><span class="line">     <span class="attr">depends_on:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">     <span class="attr">image:</span> <span class="string">wordpress:latest</span></span><br><span class="line">     <span class="attr">ports:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">"8020:80"</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db:3306</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">       <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">db_data:</span></span><br></pre></td></tr></table></figure>
<p><strong>å¯åŠ¨</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos wordpress-demo]<span class="comment"># docker-compose up -d		# ä¿æŒåœ¨åå°è¿è¡Œ</span></span><br><span class="line">[root@VM_0_13_centos wordpress-demo]<span class="comment"># docker-compose ps			# æŸ¥çœ‹å®¹å™¨ç»„çŠ¶æ€</span></span><br><span class="line">[root@VM_0_13_centos wordpress-demo]<span class="comment"># docker-compose down		# åˆ é™¤å®¹å™¨ç»„</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114195043551.png" alt="image-20201114195043551" style="zoom: 67%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201107174243776.png" alt="image-20201107174243776" style="zoom: 67%;"></p>
<p><strong>æŸ¥çœ‹dbæ•°æ®å·</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos wordpress-demo]<span class="comment"># docker inspect wordpress-demo_db_1 |jq ".[0].Mounts"</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114191512336.png" alt="image-20201114191512336"></p>
<p><strong>è¿›å…¥å®¹å™¨æŸ¥çœ‹</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos wordpress-demo]<span class="comment"># docker-compose exec db sh</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="comment"># hostname</span></span><br><span class="line"><span class="comment"># env</span></span><br><span class="line"><span class="comment"># which mysqld</span></span><br><span class="line"><span class="comment"># ls /var/lib/mysql</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201107174911101.png" alt="image-20201107174911101"></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ul>
<li><a href="https://docs.docker.com/engine/docker-overview/" rel="external nofollow noopener noreferrer" target="_blank">https://docs.docker.com/engine/docker-overview/</a></li>
<li><a href="https://yeasy.gitbook.io/docker_practice" rel="external nofollow noopener noreferrer" target="_blank">https://yeasy.gitbook.io/docker_practice</a></li>
</ul>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€Šæ·±å…¥æµ…å‡ºMySQLã€‹å­¦ä¹ ç¬”è®°</title>
    <url>/2020/ShenRuQianChuMySQL/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æƒé™"><a href="#æƒé™" class="headerlink" title="æƒé™"></a>æƒé™</h2><p>åˆ†é…select,insertæƒé™</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">grant select,insert on sakila.* to &apos;z1&apos;@&apos;localhost&apos; identified by &apos;123&apos;;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æ”¶å›insertæƒé™</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">revoke insert on sakila.* from &apos;z1&apos;@&apos;localhost&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="æŸ¥çœ‹å¸®åŠ©"><a href="#æŸ¥çœ‹å¸®åŠ©" class="headerlink" title="æŸ¥çœ‹å¸®åŠ©"></a>æŸ¥çœ‹å¸®åŠ©</h2><p>æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯</p>
<p>å¯ä»¥ç”¨<code>? contents</code>å‘½ä»¤æ¥æ˜¾ç¤ºæ‰€æœ‰å¯ä¾›æŸ¥è¯¢çš„åˆ†ç±»</p>
<p>æŸ¥çœ‹showå…³é”®å­—ç”¨æ³•ï¼š<code>? show</code></p>
<p>æŸ¥çœ‹create tableç”¨æ³•ï¼š<code>? create table</code></p>
<hr>
<p>MySQL 5.0ä¹‹åï¼Œæä¾›äº†ä¸€ä¸ªæ–°çš„æ•°æ®åº“information_schemaï¼Œç”¨æ¥è®°å½•MySQLä¸­çš„å…ƒæ•°æ®ä¿¡æ¯ã€‚</p>
<p>é€šè¿‡æŸ¥è¯¢å…ƒæ•°æ® æ¥è·å–æ‰¹é‡æ“ä½œè¡¨çš„SQLè¯­å¥ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select concat(&apos;drop table test1.&apos;,table_name,&apos;;&apos;) from tables where table_schema=&apos;test1&apos; and table_name like &apos;tmp%&apos;;</span><br></pre></td></tr></table></figure>
<h2 id="æ•°å€¼ç±»å‹"><a href="#æ•°å€¼ç±»å‹" class="headerlink" title="æ•°å€¼ç±»å‹"></a>æ•°å€¼ç±»å‹</h2><p>MySQL æ”¯æŒæ‰€æœ‰æ ‡å‡† SQL ä¸­çš„æ•°å€¼ç±»å‹ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸¥æ ¼æ•°å€¼ç±»å‹ï¼ˆ INTEGERã€SMALLINTã€DECIMALå’ŒNUMERICï¼‰ï¼Œä»¥åŠè¿‘ä¼¼æ•°å€¼æ•°æ®ç±»å‹ï¼ˆFLOATã€REALå’ŒDOUBLE PRECISIONï¼‰ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šåšäº†æ‰©å±•ã€‚æ‰©å±•åå¢åŠ äº†TINYINTã€MEDIUMINTå’ŒBIGINTè¿™3ç§é•¿åº¦ä¸åŒçš„æ•´å‹ï¼Œå¹¶å¢åŠ äº†BITç±»å‹ï¼Œç”¨æ¥å­˜æ”¾ä½æ•°æ®ã€‚</p>
<p><strong>æµ®ç‚¹æ•°ã€å®šç‚¹æ•°</strong></p>
<p>ç²¾åº¦å’Œæ ‡åº¦ è®¡æ•°æ³• (M,D)</p>
<p>float(5,2)ã€double(5,2)ã€decimal(5,2)</p>
<p>ä¸æŒ‡å®šM,Dçš„è¯</p>
<p>é»˜è®¤ï¼šfloat, double, decimal(10,0)</p>
<p>å¦‚æœä¸å†™ç²¾åº¦å’Œæ ‡åº¦ï¼Œåˆ™ä¼šæŒ‰ç…§å®é™…ç²¾åº¦å€¼æ˜¾ç¤ºï¼Œå¦‚æœæœ‰ç²¾åº¦å’Œæ ‡åº¦ï¼Œåˆ™ä¼šè‡ªåŠ¨å°†å››èˆäº”å…¥åçš„ç»“æœæ’å…¥ï¼Œç³»ç»Ÿä¸ä¼šæŠ¥é”™ï¼›å®šç‚¹æ•°å¦‚æœä¸å†™ç²¾åº¦å’Œæ ‡åº¦ï¼Œåˆ™æŒ‰ç…§é»˜è®¤å€¼decimal(10,0)æ¥è¿›è¡Œæ“ä½œï¼Œå¹¶ä¸”å¦‚æœæ•°æ®è¶…è¶Šäº†ç²¾åº¦å’Œæ ‡åº¦å€¼ï¼Œç³»ç»Ÿåˆ™ä¼šæŠ¥é”™ã€‚</p>
<pre><code>Query OK, 1 row affected, 1 warning (0.00 sec)
mysql&gt; show warnings;
</code></pre><p><strong>BIT ç±»å‹</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">select bin(id),hex(id) from t2;</span><br><span class="line"></span><br><span class="line">alter table t2 modify id bit(2);</span><br><span class="line"></span><br><span class="line">insert into t2 values(2);</span><br></pre></td></tr></table></figure>
<p>è½¬æ¢åçš„äºŒè¿›åˆ¶æ•°ä¸èƒ½è¶…è¿‡é¢„å®šä¹‰çš„bitç±»å‹çš„é•¿åº¦</p>
<h2 id="æ—¥æœŸæ—¶é—´ç±»å‹"><a href="#æ—¥æœŸæ—¶é—´ç±»å‹" class="headerlink" title="æ—¥æœŸæ—¶é—´ç±»å‹"></a>æ—¥æœŸæ—¶é—´ç±»å‹</h2><p><strong>timestampç±»å‹</strong></p>
<p>MySQLåªç»™è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªTIMESTAMPå­—æ®µè®¾ç½®é»˜è®¤å€¼ä¸ºç³»ç»Ÿæ—¥æœŸï¼Œå¦‚æœæœ‰ç¬¬äºŒä¸ªTIMESTAMPç±»å‹ï¼Œåˆ™é»˜è®¤å€¼è®¾ç½®ä¸º0å€¼</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">show create table t \G;</span><br><span class="line"></span><br><span class="line">mysql&gt; alter table t modify id2 timestamp default current_timestamp;</span><br><span class="line">ERROR 1293 (HY000): Incorrect table definition; there can be only one TIMESTAMP column with CURRENT_TIMESTAMP in DEFAULT or ON UPDATE clause</span><br></pre></td></tr></table></figure>
<p>timestampå’Œæ—¶åŒºæœ‰å…³ç³»ï¼š</p>
<pre><code>mysql&gt; show variables like &apos;time_zone&apos;;
+---------------+--------+
| Variable_name | Value |
+---------------+--------+
| time_zone | SYSTEM |
+---------------+--------+
</code></pre><p>æœ€å¤§2038-01-19 11:14:07  +08:00æ—¶åŒº</p>
<p>æœ€å°1970-01-01 08:00:01</p>
<p>TIMESTAMPæ”¯æŒçš„æ—¶é—´èŒƒå›´è¾ƒå°ï¼Œå…¶å–å€¼èŒƒå›´ä»19700101080001åˆ°2038å¹´çš„æŸä¸ªæ—¶é—´ï¼Œè€ŒDATETIMEæ˜¯ä» 1000-01-01 00:00:00åˆ° 9999-12-31 23:59:59ï¼ŒèŒƒå›´æ›´å¤§ã€‚</p>
<h2 id="å­—ç¬¦å‹"><a href="#å­—ç¬¦å‹" class="headerlink" title="å­—ç¬¦å‹"></a>å­—ç¬¦å‹</h2><p>MySQLåŒ…æ‹¬äº†CHARã€VARCHARã€BINARYã€VARBINARYã€BLOBã€TEXTã€ENUMå’ŒSETç­‰å¤šç§å­—ç¬¦ä¸²ç±»å‹ã€‚</p>
<h3 id="binary-ç±»å‹"><a href="#binary-ç±»å‹" class="headerlink" title="binary ç±»å‹"></a>binary ç±»å‹</h3><pre><code>CREATE TABLE t (c BINARY(3));
</code></pre><p>å½“ä¿å­˜BINARYå€¼æ—¶ï¼Œåœ¨å€¼çš„æœ€åé€šè¿‡å¡«å……â€œ0x00â€ï¼ˆé›¶å­—èŠ‚ï¼‰ä»¥è¾¾åˆ°æŒ‡å®šçš„å­—æ®µå®šä¹‰é•¿åº¦ã€‚</p>
<h3 id="æšä¸¾ç±»å‹-enum"><a href="#æšä¸¾ç±»å‹-enum" class="headerlink" title="æšä¸¾ç±»å‹ enum"></a>æšä¸¾ç±»å‹ enum</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; create table t2 (gender enum(&apos;M&apos;, &apos;F&apos;));</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; desc t2;</span><br><span class="line">+--------+---------------+------+-----+---------+-------+</span><br><span class="line">| Field  | Type          | Null | Key | Default | Extra |</span><br><span class="line">+--------+---------------+------+-----+---------+-------+</span><br><span class="line">| gender | enum(&apos;M&apos;,&apos;F&apos;) | YES  |     | NULL    |       |</span><br><span class="line">+--------+---------------+------+-----+---------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into t2 values(&apos;M&apos;),(&apos;1&apos;),(2),(&apos;f&apos;),(null);</span><br><span class="line">Query OK, 5 rows affected (0.00 sec)</span><br><span class="line">Records: 5  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t2;</span><br><span class="line">+--------+</span><br><span class="line">| gender |</span><br><span class="line">+--------+</span><br><span class="line">| M      |</span><br><span class="line">| M      |</span><br><span class="line">| F      |</span><br><span class="line">| F      |</span><br><span class="line">| NULL   |</span><br><span class="line">+--------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="set-ç±»å‹"><a href="#set-ç±»å‹" class="headerlink" title="set ç±»å‹"></a>set ç±»å‹</h3><pre><code>Create table t (col set(&apos;a&apos;,&apos;b&apos;,&apos;c&apos;,&apos;d&apos;));
insert into t values(&apos;a,b&apos;),(&apos;a,d,a&apos;),(&apos;a,b&apos;),(&apos;a,c&apos;),(&apos;a&apos;);

1ï½8æˆå‘˜çš„é›†åˆï¼Œå 1ä¸ªå­—èŠ‚ã€‚??????
9ï½16æˆå‘˜çš„é›†åˆï¼Œå 2ä¸ªå­—èŠ‚ã€‚
17ï½24æˆå‘˜çš„é›†åˆï¼Œå 3ä¸ªå­—èŠ‚ã€‚
25ï½32æˆå‘˜çš„é›†åˆï¼Œå 4ä¸ªå­—èŠ‚ã€‚
33ï½64æˆå‘˜çš„é›†åˆï¼Œå 8ä¸ªå­—èŠ‚ã€‚
</code></pre>]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘Elasticsearchå’ŒSolr</title>
    <url>/2021/Elasticsearch-Solr/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><strong>Elasticsearch</strong>æ˜¯ä¸€ä¸ªå®æ—¶åˆ†å¸ƒå¼æœç´¢å’Œåˆ†æå¼•æ“ã€‚å®ƒè®©ä½ ä»¥å‰æ‰€æœªæœ‰çš„é€Ÿåº¦å¤„ç†å¤§æ•°æ®æˆä¸ºå¯èƒ½ã€‚Elasticsearchæ˜¯ä¸€ä¸ªåŸºäºApache Lucene(TM)çš„å¼€æºæœç´¢å¼•æ“ã€‚æ— è®ºåœ¨å¼€æºè¿˜æ˜¯ä¸“æœ‰é¢†åŸŸï¼ŒLuceneå¯ä»¥è¢«è®¤ä¸ºæ˜¯è¿„ä»Šä¸ºæ­¢æœ€å…ˆè¿›ã€æ€§èƒ½æœ€å¥½çš„ã€åŠŸèƒ½æœ€å…¨çš„æœç´¢å¼•æ“åº“ã€‚Elasticsearchä¹Ÿä½¿ç”¨Javaå¼€å‘å¹¶ä½¿ç”¨Luceneä½œä¸ºå…¶æ ¸å¿ƒæ¥å®ç°æ‰€æœ‰ç´¢å¼•å’Œæœç´¢çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒçš„ç›®çš„æ˜¯é€šè¿‡ç®€å•çš„ RESTful API æ¥éšè—Luceneçš„å¤æ‚æ€§ï¼Œä»è€Œè®©å…¨æ–‡æœç´¢å˜å¾—ç®€å•ã€‚</p>
<a id="more"></a>
<p><em>StackOverflowç»“åˆå…¨æ–‡æœç´¢ä¸åœ°ç†ä½ç½®æŸ¥è¯¢ï¼Œä»¥åŠmore-like-thisåŠŸèƒ½æ¥æ‰¾åˆ°ç›¸å…³çš„é—®é¢˜å’Œç­”æ¡ˆã€‚Githubä½¿ç”¨Elasticsearchæ£€ç´¢åƒäº¿è¡Œä»£ç ã€‚</em></p>
<p><strong>Solr</strong>æ˜¯Apacheä¸‹çš„ä¸€ä¸ªé¡¶çº§å¼€æºé¡¹ç›®ï¼Œé‡‡ç”¨Javaå¼€å‘ï¼Œå®ƒæ˜¯åŸºäºLuceneçš„å…¨æ–‡æœç´¢æœåŠ¡å™¨ã€‚Solræä¾›äº†æ¯”Luceneæ›´ä¸ºä¸°å¯Œçš„æŸ¥è¯¢è¯­è¨€ï¼ŒåŒæ—¶å®ç°äº†å¯é…ç½®ã€å¯æ‰©å±•ï¼Œå¹¶å¯¹ç´¢å¼•ã€æœç´¢æ€§èƒ½è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p>
<p>Solrå¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œè¿è¡Œåœ¨Jettyã€Tomcatç­‰è¿™äº›Servletå®¹å™¨ä¸­ï¼ŒSolr ç´¢å¼•çš„å®ç°æ–¹æ³•å¾ˆç®€å•ï¼Œç”¨ POST æ–¹æ³•å‘ Solr æœåŠ¡å™¨å‘é€ä¸€ä¸ªæè¿° Field åŠå…¶å†…å®¹çš„ XML æ–‡æ¡£ï¼ŒSolræ ¹æ®xmlæ–‡æ¡£æ·»åŠ ã€åˆ é™¤ã€æ›´æ–°ç´¢å¼• ã€‚Solr æœç´¢åªéœ€è¦å‘é€ HTTP GET è¯·æ±‚ï¼Œç„¶åå¯¹ Solr è¿”å›Xmlã€jsonç­‰æ ¼å¼çš„æŸ¥è¯¢ç»“æœè¿›è¡Œè§£æï¼Œç»„ç»‡é¡µé¢å¸ƒå±€ã€‚Solrä¸æä¾›æ„å»ºUIçš„åŠŸèƒ½ï¼ŒSolræä¾›äº†ä¸€ä¸ªç®¡ç†ç•Œé¢ï¼Œé€šè¿‡ç®¡ç†ç•Œé¢å¯ä»¥æŸ¥è¯¢Solrçš„é…ç½®å’Œè¿è¡Œæƒ…å†µã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/es-solr/solr-1.jpg" alt="img" style="zoom: 80%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/es-solr/solr-2.jpg" alt="img" style="zoom: 80%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/es-solr/solr-3.jpg" alt="img" style="zoom: 80%;"></p>
<p><strong>ESå’ŒSolrçš„éƒ¨åˆ†åŒºåˆ«ï¼š</strong></p>
<p>Solr åˆ©ç”¨ Zookeeper è¿›è¡Œåˆ†å¸ƒå¼ç®¡ç†ï¼›Elasticsearchå†…ç½®Zenï¼Œéœ€è¦ä¸“ç”¨çš„ä¸»èŠ‚ç‚¹æ‰èƒ½è¿›è¡Œåˆ†è£‚è„‘ä¿æŠ¤ã€‚solrä¸€èˆ¬éƒ¨ç½²åˆ°webæœåŠ¡å™¨ä¸Šï¼Œæ¯”å¦‚tomcatï¼Œsolrçš„æœ¬è´¨æ˜¯ä¸€ä¸ªåŠ¨æ€webé¡¹ç›®ã€‚</p>
<p>Solr æ”¯æŒæ›´å¤šæ ¼å¼çš„æ•°æ®(JSON/XML/CSV)ï¼ŒElasticsearch ä»…æ”¯æŒjsonæ–‡ä»¶æ ¼å¼ã€‚<br>Solr å®˜æ–¹æä¾›çš„åŠŸèƒ½æ›´å¤šï¼Œè€Œ Elasticsearch æœ¬èº«æ›´æ³¨é‡äºæ ¸å¿ƒåŠŸèƒ½ï¼Œé«˜çº§åŠŸèƒ½å¤šæœ‰ç¬¬ä¸‰æ–¹æ’ä»¶æä¾›ï¼Œä¾‹å¦‚å›¾å½¢åŒ–ç•Œé¢éœ€è¦kibanaå‹å¥½æ”¯æ’‘ã€‚<br>Solr æŸ¥è¯¢å¿«ï¼Œä½†æ›´æ–°ç´¢å¼•æ—¶æ…¢ï¼ˆå³æ’å…¥åˆ é™¤æ…¢ï¼‰ï¼Œç”¨äºç”µå•†ç­‰æŸ¥è¯¢å¤šçš„åº”ç”¨ï¼›ESå»ºç«‹ç´¢å¼•å¿«ï¼ˆå³æŸ¥è¯¢æ…¢ï¼‰ï¼Œå³å®æ—¶æ€§æŸ¥è¯¢å¿«ã€‚Solræ˜¯ä¼ ç»Ÿæœç´¢åº”ç”¨çš„æœ‰åŠ›è§£å†³æ–¹æ¡ˆï¼Œä½† Elasticsearch æ›´é€‚ç”¨äºæ–°å…´çš„å®æ—¶æœç´¢åº”ç”¨ã€‚<br>Solræ‹¥æœ‰æ›´å¤§ï¼Œæ›´æˆç†Ÿçš„ç”¨æˆ·ï¼Œå¼€å‘è€…å’Œè´¡çŒ®è€…ç¤¾åŒºã€‚ESæ‹¥æœ‰çš„è§„æ¨¡è¾ƒå°ä½†æ´»è·ƒçš„ç”¨æˆ·ç¤¾åŒºä»¥åŠä¸æ–­å¢é•¿çš„è´¡çŒ®è€…ç¤¾åŒºã€‚<br>Solræ›´åŠ é¢å‘æ–‡æœ¬æœç´¢ï¼ŒElasticsearché€šå¸¸ç”¨äºè¿‡æ»¤å’Œåˆ†ç»„ - åˆ†ææŸ¥è¯¢å·¥ä½œè´Ÿè½½ - è€Œä¸ä¸€å®šæ˜¯æ–‡æœ¬æœç´¢ã€‚</p>
<p><strong>Lucene</strong>æ›¾ç»æ˜¯Apache Jakartaé¡¹ç›®ï¼ˆJakarta has been retired on 2011/12/21ï¼‰çš„ä¸€ä¸ªå­é¡¹ç›®ï¼ˆMaven, POIä¹Ÿæ˜¯ï¼‰ï¼Œæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„å…¨æ–‡æ£€ç´¢å¼•æ“å·¥å…·åŒ…ï¼Œä½†å®ƒä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å…¨æ–‡æ£€ç´¢å¼•æ“ï¼Œè€Œæ˜¯ä¸€ä¸ª<strong>å…¨æ–‡æ£€ç´¢å¼•æ“çš„æ¶æ„</strong>ï¼Œæä¾›äº†å®Œæ•´çš„æŸ¥è¯¢å¼•æ“å’Œç´¢å¼•å¼•æ“ï¼Œéƒ¨åˆ†æ–‡æœ¬åˆ†æå¼•æ“ï¼ˆè‹±æ–‡ä¸å¾·æ–‡ä¸¤ç§è¥¿æ–¹è¯­è¨€ï¼‰ã€‚Luceneçš„ç›®çš„æ˜¯ä¸ºè½¯ä»¶å¼€å‘äººå‘˜æä¾›ä¸€ä¸ªç®€å•æ˜“ç”¨çš„å·¥å…·åŒ…ï¼Œä»¥æ–¹ä¾¿åœ¨ç›®æ ‡ç³»ç»Ÿä¸­å®ç°å…¨æ–‡æ£€ç´¢çš„åŠŸèƒ½ï¼Œæˆ–è€…æ˜¯ä»¥æ­¤ä¸ºåŸºç¡€å»ºç«‹èµ·å®Œæ•´çš„å…¨æ–‡æ£€ç´¢å¼•æ“ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/es-solr/lucene.jpg" alt="img"></p>
<p>æ•°æ®æ€»ä½“åˆ†ä¸ºä¸¤ç§ï¼š<strong>ç»“æ„åŒ–æ•°æ®</strong>å’Œ<strong>éç»“æ„åŒ–æ•°æ®</strong>ã€‚<br><strong>ç»“æ„åŒ–æ•°æ®</strong>ï¼š æŒ‡å…·æœ‰å›ºå®šæ ¼å¼æˆ–æœ‰é™é•¿åº¦çš„æ•°æ®ï¼Œå¦‚æ•°æ®åº“ï¼Œå…ƒæ•°æ®ç­‰ã€‚<br><strong>éç»“æ„åŒ–æ•°æ®</strong>ï¼š éç»“æ„åŒ–æ•°æ®åˆå¯ç§°ä¸ºå…¨æ–‡æ•°æ®ï¼ŒæŒ‡ä¸å®šé•¿æˆ–æ— å›ºå®šæ ¼å¼çš„æ•°æ®ï¼Œå¦‚é‚®ä»¶ï¼Œwordæ–‡æ¡£ç­‰ã€‚</p>
<p>éç»“æ„åŒ–æ•°æ®æŸ¥è¯¢æ–¹æ³•åŒ…æ‹¬ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š<br><strong>é¡ºåºæ‰«æ</strong>(Serial Scanning)<br><strong>å…¨æ–‡æœç´¢</strong>(Full-text Search)</p>
<p>å°†éç»“æ„åŒ–æ•°æ®ä¸­çš„ä¸€éƒ¨åˆ†ä¿¡æ¯æå–å‡ºæ¥ï¼Œé‡æ–°ç»„ç»‡ï¼Œä½¿å…¶å˜å¾—æœ‰ä¸€å®šç»“æ„ï¼Œç„¶åå¯¹æ­¤æœ‰ä¸€å®šç»“æ„çš„æ•°æ®è¿›è¡Œæœç´¢ï¼Œä»è€Œè¾¾åˆ°æœç´¢ç›¸å¯¹è¾ƒå¿«çš„ç›®çš„ã€‚è¿™éƒ¨åˆ†ä»éç»“æ„åŒ–æ•°æ®ä¸­æå–å‡ºçš„ç„¶åé‡æ–°ç»„ç»‡çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹<strong>ç´¢å¼•</strong>ã€‚</p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘Elasticsearchç¬”è®°</title>
    <url>/2021/Elasticsearch/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h2><p>PBçº§ ç»“æ„åŒ–å’Œéç»“æ„åŒ–æ•°æ®<br>å¼€æº<br>å…¨æ–‡æœç´¢å¼•æ“<br>éè§„èŒƒåŒ–ï¼Œæé«˜æœç´¢æ€§èƒ½<br><a id="more"></a></p>
<h2 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h2><p>åˆ†å¸ƒå¼<br>å®æ—¶<br>åŸºäºJavaï¼Œè·¨å¹³å°<br>jsonå¯¹è±¡ä½œç›¸åº”ï¼Œå¤§éƒ¨åˆ†è¯­è¨€æ”¯æŒ<br>å’Œsolrç›¸æ¯”ï¼Œå¤šç”¨æˆ·ç®¡ç†å®¹æ˜“</p>
<h2 id="ç¼ºç‚¹"><a href="#ç¼ºç‚¹" class="headerlink" title="ç¼ºç‚¹"></a>ç¼ºç‚¹</h2><p>å’Œsolrç›¸æ¯”ï¼Œä¸æ”¯æŒcsvã€xmlæ ¼å¼çš„æ•°æ®<br>è„‘è£‚é—®é¢˜</p>
<h2 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h2><h3 id="èŠ‚ç‚¹"><a href="#èŠ‚ç‚¹" class="headerlink" title="èŠ‚ç‚¹"></a>èŠ‚ç‚¹</h3><p>å®ƒæŒ‡çš„æ˜¯Elasticsearchçš„å•ä¸ªæ­£åœ¨è¿è¡Œçš„å®ä¾‹ã€‚å•ä¸ªç‰©ç†å’Œè™šæ‹ŸæœåŠ¡å™¨å®¹çº³å¤šä¸ªèŠ‚ç‚¹ï¼Œè¿™å–å†³äºå…¶ç‰©ç†èµ„æºçš„èƒ½åŠ›ï¼Œå¦‚RAMï¼Œå­˜å‚¨å’Œå¤„ç†èƒ½åŠ›ã€‚</p>
<h3 id="é›†ç¾¤"><a href="#é›†ç¾¤" class="headerlink" title="é›†ç¾¤"></a>é›†ç¾¤</h3><p>å®ƒæ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªèŠ‚ç‚¹çš„é›†åˆã€‚ é›†ç¾¤ä¸ºæ•´ä¸ªæ•°æ®æä¾›è·¨æ‰€æœ‰èŠ‚ç‚¹çš„é›†åˆç´¢å¼•å’Œæœç´¢åŠŸèƒ½ã€‚</p>
<h3 id="ç´¢å¼•"><a href="#ç´¢å¼•" class="headerlink" title="ç´¢å¼•"></a>ç´¢å¼•</h3><p>å®ƒæ˜¯ä¸åŒç±»å‹çš„æ–‡æ¡£å’Œæ–‡æ¡£å±æ€§çš„é›†åˆã€‚ç´¢å¼•è¿˜ä½¿ç”¨åˆ†ç‰‡çš„æ¦‚å¿µæ¥æé«˜æ€§èƒ½ã€‚ ä¾‹å¦‚ï¼Œä¸€ç»„æ–‡æ¡£åŒ…å«ç¤¾äº¤ç½‘ç»œåº”ç”¨çš„æ•°æ®ã€‚</p>
<h3 id="ç±»å‹-æ˜ å°„"><a href="#ç±»å‹-æ˜ å°„" class="headerlink" title="ç±»å‹/æ˜ å°„"></a>ç±»å‹/æ˜ å°„</h3><p>å®ƒæ˜¯å…±äº«åŒä¸€ç´¢å¼•ä¸­å­˜åœ¨çš„ä¸€ç»„å…¬å…±å­—æ®µçš„æ–‡æ¡£çš„é›†åˆã€‚ ä¾‹å¦‚ï¼Œç´¢å¼•åŒ…å«ç¤¾äº¤ç½‘ç»œåº”ç”¨çš„æ•°æ®ï¼Œç„¶åå®ƒå¯ä»¥å­˜åœ¨ç”¨äºç”¨æˆ·ç®€æ¡£æ•°æ®çš„ç‰¹å®šç±»å‹ï¼Œå¦ä¸€ç±»å‹å¯ç”¨äºæ¶ˆæ¯çš„æ•°æ®ï¼Œä»¥åŠå¦ä¸€ç±»å‹å¯ç”¨äºè¯„è®ºçš„æ•°æ®ã€‚</p>
<h3 id="æ–‡æ¡£"><a href="#æ–‡æ¡£" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h3><p>å®ƒæ˜¯ä»¥JSONæ ¼å¼å®šä¹‰çš„ç‰¹å®šæ–¹å¼çš„å­—æ®µé›†åˆã€‚æ¯ä¸ªæ–‡æ¡£éƒ½å±äºä¸€ä¸ªç±»å‹å¹¶é©»ç•™åœ¨ç´¢å¼•ä¸­ã€‚æ¯ä¸ªæ–‡æ¡£éƒ½ä¸å”¯ä¸€æ ‡è¯†ç¬¦(ç§°ä¸ºUID)ç›¸å…³è”ã€‚</p>
<h3 id="ç¢ç‰‡"><a href="#ç¢ç‰‡" class="headerlink" title="ç¢ç‰‡"></a>ç¢ç‰‡</h3><p>ç´¢å¼•è¢«æ°´å¹³ç»†åˆ†ä¸ºç¢ç‰‡ã€‚è¿™æ„å‘³ç€æ¯ä¸ªç¢ç‰‡åŒ…å«æ–‡æ¡£çš„æ‰€æœ‰å±æ€§ï¼Œä½†åŒ…å«çš„æ•°é‡æ¯”ç´¢å¼•å°‘ã€‚æ°´å¹³åˆ†éš”ä½¿ç¢ç‰‡æˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„èŠ‚ç‚¹ï¼Œå¯ä»¥å­˜å‚¨åœ¨ä»»ä½•èŠ‚ç‚¹ä¸­ã€‚ä¸»ç¢ç‰‡æ˜¯ç´¢å¼•çš„åŸå§‹æ°´å¹³éƒ¨åˆ†ï¼Œç„¶åè¿™äº›ä¸»ç¢ç‰‡è¢«å¤åˆ¶åˆ°å‰¯æœ¬ç¢ç‰‡ä¸­ã€‚</p>
<h3 id="å‰¯æœ¬"><a href="#å‰¯æœ¬" class="headerlink" title="å‰¯æœ¬"></a>å‰¯æœ¬</h3><p>Elasticsearchå…è®¸ç”¨æˆ·åˆ›å»ºå…¶ç´¢å¼•å’Œåˆ†ç‰‡çš„å‰¯æœ¬ã€‚ å¤åˆ¶ä¸ä»…æœ‰åŠ©äºåœ¨æ•…éšœæƒ…å†µä¸‹å¢åŠ æ•°æ®çš„å¯ç”¨æ€§ï¼Œè€Œä¸”è¿˜é€šè¿‡åœ¨è¿™äº›å‰¯æœ¬ä¸­æ‰§è¡Œå¹¶è¡Œæœç´¢æ“ä½œæ¥æé«˜æœç´¢çš„æ€§èƒ½ã€‚</p>
<h2 id="Elasticsearchå’ŒRDBMSä¹‹é—´çš„æ¯”è¾ƒ"><a href="#Elasticsearchå’ŒRDBMSä¹‹é—´çš„æ¯”è¾ƒ" class="headerlink" title="Elasticsearchå’ŒRDBMSä¹‹é—´çš„æ¯”è¾ƒ"></a>Elasticsearchå’ŒRDBMSä¹‹é—´çš„æ¯”è¾ƒ</h2><table>
<thead>
<tr>
<th>Elasticsearch</th>
<th>å…³ç³»å‹æ•°æ®åº“</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç´¢å¼•</td>
<td>æ•°æ®åº“</td>
</tr>
<tr>
<td>ç¢ç‰‡</td>
<td>ç¢ç‰‡</td>
</tr>
<tr>
<td>æ˜ å°„</td>
<td>è¡¨</td>
</tr>
<tr>
<td>å­—æ®µ</td>
<td>å­—æ®µ</td>
</tr>
<tr>
<td>JSONå¯¹è±¡</td>
<td>å…ƒç»„</td>
</tr>
</tbody>
</table>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="å¤šç´¢å¼•"><a href="#å¤šç´¢å¼•" class="headerlink" title="å¤šç´¢å¼•"></a>å¤šç´¢å¼•</h3><ul>
<li>é€—å·<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/index1,index2,index3/_search</span><br><span class="line">  &#123;</span><br><span class="line">   &quot;query&quot;:&#123;</span><br><span class="line">    &quot;query_string&quot;:&#123;</span><br><span class="line">       &quot;query&quot;:&quot;any_string&quot;</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>é€šé…ç¬¦ * + -</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/school*/_search</span><br><span class="line">POST http://localhost:9200/school*,-schools_gov/_search</span><br></pre></td></tr></table></figure>
</li>
<li><p>_all</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/_all/_search</span><br></pre></td></tr></table></figure>
</li>
<li><p>ignore_unavailable</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/school*,book_shops/_search?ignore_unavailable=true</span><br><span class="line">#å‡è®¾book_shopsä¸å­˜åœ¨ï¼Œå“åº”ä¹Ÿä¸ä¼šæŠ¥404é”™è¯¯</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>allow_no_indices</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/schools_pri*/_search?allow_no_indices=true</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="æ–‡æ¡£-1"><a href="#æ–‡æ¡£-1" class="headerlink" title="æ–‡æ¡£"></a>æ–‡æ¡£</h3><ul>
<li><p>åˆ›å»º</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /schools/school/4</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ›´æ–°</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç‰ˆæœ¬æ§åˆ¶</p>
<ul>
<li>å†…éƒ¨æ§åˆ¶ï¼ˆé»˜è®¤ï¼‰<ul>
<li>æ›´æ–°ã€åˆ é™¤ã€æ–°å¢ç­‰æ“ä½œæ—¶ï¼Œè‡ªåŠ¨+1ï¼Œä»1å¼€å§‹</li>
</ul>
</li>
<li>å¤–éƒ¨æ§åˆ¶ version_type: external<ul>
<li>?version=2</li>
</ul>
</li>
</ul>
</li>
<li><p>æ“ä½œç±»å‹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/tutorials/chapter/1?op_type=create</span><br></pre></td></tr></table></figure>
<p>æ˜¯ä¸€ç§æ˜ç¡®æ“ä½œç±»å‹çš„æ“ä½œï¼Œé˜²æ­¢æ›´æ–°å·²æœ‰æ–‡æ¡£ã€‚æŒ‡æ˜createåï¼Œå¦‚æœå·²æœ‰è¯¥index/type/idåˆ™æŠ¥é”™version conflict</p>
</li>
<li><p>æŒ‡å®šæ‰€éœ€çš„å­—æ®µ</p>
</li>
<li><p>?fields = name,fees</p>
</li>
<li><p>æŒ‡å®šè¶…æ—¶</p>
<ul>
<li>?timeout = 3m</li>
</ul>
</li>
</ul>
<h2 id="æ˜ å°„"><a href="#æ˜ å°„" class="headerlink" title="æ˜ å°„"></a>æ˜ å°„</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/_mapping?pretty&quot; -H &apos;Content-Type: application/json&apos; -d&apos;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &#123; </span><br><span class="line">      &quot;type&quot;:     &quot;text&quot;,</span><br><span class="line">      &quot;fielddata&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="èšåˆæœç´¢"><a href="#èšåˆæœç´¢" class="headerlink" title="èšåˆæœç´¢"></a>èšåˆæœç´¢</h2><h3 id="å¹³å‡èšåˆ-avg"><a href="#å¹³å‡èšåˆ-avg" class="headerlink" title="å¹³å‡èšåˆ avg"></a>å¹³å‡èšåˆ avg</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/schools/_search</span><br><span class="line">&#123;</span><br><span class="line"> &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;avg_fees&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123;</span><br><span class="line">        &quot;field&quot;: &quot;fees&quot;</span><br><span class="line">        &quot;missing&quot;: 0</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åŸºæ•°èšåˆ-cardinality"><a href="#åŸºæ•°èšåˆ-cardinality" class="headerlink" title="åŸºæ•°èšåˆ cardinality"></a>åŸºæ•°èšåˆ cardinality</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST http://localhost:9200/schools*/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;distinct_name_count&quot;: &#123;&quot;cardinality&quot;: &#123;&quot;field&quot;: &quot;name&quot;&#125;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">#ç‰¹å®šå­—æ®µçš„ä¸åŒå€¼çš„è®¡æ•°</span><br></pre></td></tr></table></figure>
<h3 id="æ‰©å±•ç»Ÿè®¡-extended-stats"><a href="#æ‰©å±•ç»Ÿè®¡-extended-stats" class="headerlink" title="æ‰©å±•ç»Ÿè®¡ extended_stats"></a>æ‰©å±•ç»Ÿè®¡ extended_stats</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot; : &#123;</span><br><span class="line">    &quot;fees_stats&quot;: &#123; &quot;extended_stats&quot;: &#123; &quot;field&quot;: &quot;fees&quot; &#125; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æœ€å€¼èšåˆ-max-min"><a href="#æœ€å€¼èšåˆ-max-min" class="headerlink" title="æœ€å€¼èšåˆ max/min"></a>æœ€å€¼èšåˆ max/min</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;min_fees&quot;: &#123;</span><br><span class="line">      &quot;min&quot;: &#123;&quot;field&quot;: &quot;fees&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ±‚å’Œ-sum"><a href="#æ±‚å’Œ-sum" class="headerlink" title="æ±‚å’Œ sum"></a>æ±‚å’Œ sum</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;sum_fees&quot;: &#123;</span><br><span class="line">      &quot;sum&quot;: &#123;&quot;field&quot;: &quot;fees&quot; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="meta"><a href="#meta" class="headerlink" title="meta"></a>meta</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot; : &#123;</span><br><span class="line">    &quot;min_fees&quot;: &#123;</span><br><span class="line">      &quot;avg&quot;: &#123; &quot;field&quot;: &quot;fees&quot; &#125; ,</span><br><span class="line">      &quot;meta&quot;: &#123;&quot;dsc&quot;: &quot;Lowest Fees&quot;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">å“åº”å¦‚ä¸‹ï¼š</span><br><span class="line">&#123;</span><br><span class="line">   &quot;aggregations&quot;:&#123;&quot;min_fees&quot;:&#123;&quot;meta&quot;:&#123;&quot;dsc&quot;:&quot;Lowest Fees&quot;&#125;, &quot;value&quot;:2180.0&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ¡¶èšåˆ-bucket"><a href="#æ¡¶èšåˆ-bucket" class="headerlink" title="æ¡¶èšåˆ bucket"></a>æ¡¶èšåˆ bucket</h3><p>åŒ…å«ï¼š<br><strong>å­èšé›†</strong><br>æ­¤å­˜å‚¨æ¡¶èšåˆä¼šç”Ÿæˆæ˜ å°„åˆ°çˆ¶å­˜å‚¨æ¡¶çš„æ–‡æ¡£é›†åˆã€‚ç±»å‹å‚æ•°ç”¨äºå®šä¹‰çˆ¶ç´¢å¼•ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªå“ç‰ŒåŠå…¶ä¸åŒçš„æ¨¡å‹ï¼Œç„¶åæ¨¡å‹ç±»å‹å°†æœ‰ä»¥ä¸‹_parentå­—æ®µ</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   &quot;model&quot; : &#123;</span><br><span class="line">      &quot;_parent&quot; : &#123;</span><br><span class="line">         &quot;type&quot; : &quot;brand&quot;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰è®¸å¤šå…¶ä»–ç‰¹æ®Šçš„æ¡¶èšåˆï¼Œè¿™åœ¨è®¸å¤šå…¶ä»–æƒ…å†µä¸‹æ˜¯æœ‰ç”¨çš„ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ï¼š<br>æ—¥æœŸç›´æ–¹å›¾æ±‡æ€»/èšåˆ<br>æ—¥æœŸèŒƒå›´æ±‡æ€»/èšåˆ<br>è¿‡æ»¤èšåˆ<br>è¿‡æ»¤å™¨èšåˆ<br>åœ°ç†è·ç¦»èšåˆ<br>GeoHashç½‘æ ¼èšåˆ<br>å…¨å±€æ±‡æ€»<br>ç›´æ–¹å›¾èšåˆ<br>IPv4èŒƒå›´èšåˆ<br>å¤±è¸ªèšåˆ<br>åµŒå¥—èšåˆ<br>èŒƒå›´èšåˆ<br>åå‘åµŒå¥—èšåˆ<br>é‡‡æ ·å™¨èšåˆ<br>é‡è¦æ¡æ¬¾èšåˆ<br>æœ¯è¯­èšåˆ</p>
<h2 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h2><h3 id="è‡ªåŠ¨åˆ›å»ºç´¢å¼•"><a href="#è‡ªåŠ¨åˆ›å»ºç´¢å¼•" class="headerlink" title="è‡ªåŠ¨åˆ›å»ºç´¢å¼•"></a>è‡ªåŠ¨åˆ›å»ºç´¢å¼•</h3><p><strong>elasticsearch.yml</strong><br>å½“è¯·æ±‚å°†JSONå¯¹è±¡æ·»åŠ åˆ°ç‰¹å®šç´¢å¼•æ—¶ï¼Œå¦‚æœè¯¥ç´¢å¼•ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆæ­¤APIä¼šè‡ªåŠ¨åˆ›å»ºè¯¥ç´¢å¼•ä»¥åŠè¯¥ç‰¹å®šJSONå¯¹è±¡çš„åŸºç¡€æ˜ å°„ã€‚ å¯ä»¥é€šè¿‡å°†ä»¥ä¸‹å‚æ•°çš„å€¼æ›´æ”¹ä¸ºfalseæ¥ç¦ç”¨æ­¤åŠŸèƒ½ï¼Œè¿™ä¸ªå€¼æ˜¯å­˜åœ¨äºelasticsearch.ymlæ–‡ä»¶ä¸­ï¼Œæ‰“å¼€elasticsearch.ymlæ–‡ä»¶è®¾ç½®å¦‚ä¸‹ï¼š<br>action.auto_create_index:false<br>index.mapper.dynamic:false</p>
<p>è¿˜å¯ä»¥é™åˆ¶è‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼Œå…¶ä¸­é€šè¿‡æ›´æ”¹ä»¥ä¸‹å‚æ•°çš„å€¼åªå…è®¸æŒ‡å®šæ¨¡å¼çš„ç´¢å¼•åç§°ï¼š<br>action.auto_create_index:+acc<em>,-bank</em> (å…¶ä¸­+è¡¨ç¤ºå…è®¸ï¼Œ - è¡¨ç¤ºä¸å…è®¸)</p>
<hr>
<p><em>æ¥æºï¼š<a href="https://www.yiibai.com/elasticsearch/elasticsearch_aggregations.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.yiibai.com/elasticsearch/elasticsearch_aggregations.html</a></em></p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>K8så°çŸ¥è¯†</title>
    <url>/2021/K8s-FAQ/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h3 id="Kubelet-è°ƒç”¨çš„å¤„ç†æ£€æŸ¥å®¹å™¨çš„IPåœ°å€æ˜¯å¦æ‰“å¼€çš„ç¨‹åºæ˜¯ï¼Ÿ"><a href="#Kubelet-è°ƒç”¨çš„å¤„ç†æ£€æŸ¥å®¹å™¨çš„IPåœ°å€æ˜¯å¦æ‰“å¼€çš„ç¨‹åºæ˜¯ï¼Ÿ" class="headerlink" title="Kubelet è°ƒç”¨çš„å¤„ç†æ£€æŸ¥å®¹å™¨çš„IPåœ°å€æ˜¯å¦æ‰“å¼€çš„ç¨‹åºæ˜¯ï¼Ÿ"></a>Kubelet è°ƒç”¨çš„å¤„ç†æ£€æŸ¥å®¹å™¨çš„IPåœ°å€æ˜¯å¦æ‰“å¼€çš„ç¨‹åºæ˜¯ï¼Ÿ</h3><p>TCPSocketAction</p>
<h3 id="1-8ç‰ˆæœ¬çš„Kuberneteså¼•å…¥äº†ä»€ä¹ˆï¼Ÿ"><a href="#1-8ç‰ˆæœ¬çš„Kuberneteså¼•å…¥äº†ä»€ä¹ˆï¼Ÿ" class="headerlink" title="1.8ç‰ˆæœ¬çš„Kuberneteså¼•å…¥äº†ä»€ä¹ˆï¼Ÿ"></a>1.8ç‰ˆæœ¬çš„Kuberneteså¼•å…¥äº†ä»€ä¹ˆï¼Ÿ</h3><p>Taints and Tolerations</p>
<a id="more"></a>
<h3 id="å¦‚ä½•åœ¨æ²¡æœ‰é€‰æ‹©å™¨çš„æƒ…å†µä¸‹å®šä¹‰æœåŠ¡ï¼Ÿ"><a href="#å¦‚ä½•åœ¨æ²¡æœ‰é€‰æ‹©å™¨çš„æƒ…å†µä¸‹å®šä¹‰æœåŠ¡ï¼Ÿ" class="headerlink" title="å¦‚ä½•åœ¨æ²¡æœ‰é€‰æ‹©å™¨çš„æƒ…å†µä¸‹å®šä¹‰æœåŠ¡ï¼Ÿ"></a>å¦‚ä½•åœ¨æ²¡æœ‰é€‰æ‹©å™¨çš„æƒ…å†µä¸‹å®šä¹‰æœåŠ¡ï¼Ÿ</h3><p>æŒ‡å®šå¤–éƒ¨åç§°</p>
<h3 id="ä»€ä¹ˆæ˜¯Kubernetesé›†ç¾¤ä¸­çš„minionsï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Kubernetesé›†ç¾¤ä¸­çš„minionsï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Kubernetesé›†ç¾¤ä¸­çš„minionsï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Kubernetesé›†ç¾¤ä¸­çš„minionsï¼Ÿ</h3><p>å®ƒä»¬æ˜¯é›†ç¾¤çš„å·¥ä½œèŠ‚ç‚¹</p>
<h3 id="ReplicaSetå’ŒReplicationControllerçš„åŒºåˆ«ï¼Ÿ"><a href="#ReplicaSetå’ŒReplicationControllerçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="ReplicaSetå’ŒReplicationControllerçš„åŒºåˆ«ï¼Ÿ"></a>ReplicaSetå’ŒReplicationControllerçš„åŒºåˆ«ï¼Ÿ</h3><p>åœ¨æ—§ç‰ˆæœ¬çš„Kubernetesä¸­ï¼Œåªæœ‰ReplicationControllerå¯¹è±¡ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ç¡®ä¿Podä»¥ä½ æŒ‡å®šçš„å‰¯æœ¬æ•°è¿è¡Œï¼Œå³å¦‚æœæœ‰å®¹å™¨å¼‚å¸¸é€€å‡ºï¼Œä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod æ¥æ›¿ä»£ï¼›è€Œå¼‚å¸¸å¤šå‡ºæ¥çš„å®¹å™¨ä¹Ÿä¼šè‡ªåŠ¨å›æ”¶ã€‚</p>
<p>ReplicaSetæ˜¯ReplicationControllerçš„æ›¿ä»£ã€‚ReplicaSetæ”¯æŒé›†åˆå¼çš„selectorã€‚å®˜æ–¹å¼ºçƒˆå»ºè®®é¿å…ç›´æ¥ä½¿ç”¨ReplicaSetï¼Œè€Œåº”è¯¥é€šè¿‡Deploymentæ¥åˆ›å»ºRSå’ŒPodã€‚</p>
<h3 id="Headless-Serviceï¼Ÿ"><a href="#Headless-Serviceï¼Ÿ" class="headerlink" title="Headless Serviceï¼Ÿ"></a>Headless Serviceï¼Ÿ</h3><p>spec.clusterIPä¸ºNoneã€‚ä¸ä¼šè¢«åˆ†é…cluster IPï¼Œkube-proxyä¸å¤„ç†ï¼Œä¸ä¼šå¯¹è¿™ç±»æœåŠ¡è¿›è¡Œè´Ÿè½½å‡è¡¡å’Œè·¯ç”±ã€‚</p>
<p><code>ClusterIP</code>çš„åŸç†ï¼šä¸€ä¸ª<code>Service</code>å¯èƒ½å¯¹åº”å¤šä¸ª<code>EndPoint(Pod)</code>ï¼Œ<code>client</code>è®¿é—®çš„æ˜¯<code>Cluster IP</code>ï¼Œé€šè¿‡<code>iptables</code>è§„åˆ™è½¬åˆ°<code>Real Server</code>ï¼Œä»è€Œè¾¾åˆ°è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</p>
<p>ClusterIPæ–¹å¼ï¼ŒdnsæŸ¥è¯¢æ—¶åªä¼šè¿”å›<code>Service</code>çš„åœ°å€ã€‚è€Œheadlessæ–¹å¼ä¼šè¿”å›endpointçš„IPã€‚</p>
<p>headlessä½¿ç”¨åœºæ™¯:</p>
<p>ç¬¬ä¸€ç§ï¼šè‡ªä¸»é€‰æ‹©æƒï¼Œæœ‰æ—¶å€™<code>client</code>æƒ³è‡ªå·±æ¥å†³å®šä½¿ç”¨å“ªä¸ª<code>Real Server</code>ï¼Œå¯ä»¥é€šè¿‡æŸ¥è¯¢<code>DNS</code>æ¥è·å–<code>Real Server</code>çš„ä¿¡æ¯ã€‚</p>
<p>ç¬¬äºŒç§ï¼š<code>Headless Service</code>çš„å¯¹åº”çš„æ¯ä¸€ä¸ª<code>Endpoints</code>ï¼Œå³æ¯ä¸€ä¸ª<code>Pod</code>ï¼Œéƒ½ä¼šæœ‰å¯¹åº”çš„<code>DNS</code>åŸŸåï¼›è¿™æ ·<code>Pod</code>ä¹‹é—´å°±èƒ½äº’ç›¸è®¿é—®ï¼Œé›†ç¾¤ä¹Ÿèƒ½å•ç‹¬è®¿é—®podã€‚</p>
<p>K8sä¸­èµ„æºçš„å…¨å±€FQDNæ ¼å¼:<br>ã€€ã€€Service_NAME.NameSpace_NAME.Domain.LTD.<br>ã€€ã€€Domain.LTD.=svc.cluster.local.ã€€ã€€ã€€ã€€ # è¿™æ˜¯é»˜è®¤k8sé›†ç¾¤çš„åŸŸå</p>
<p>å‡è®¾nginxæ˜¯ä¸€ä¸ªserviceï¼š<br><code>nslookup nginx.default.svc.cluster.local 10.200.2.10</code></p>
<p>å¦‚æœåç«¯podåä¸ºweb-0,web-1:<br><code>nslookup web-0.nginx.default.svc.cluster.local 10.200.2.11</code></p>
<h3 id="Kubernetes-Architectureçš„ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ"><a href="#Kubernetes-Architectureçš„ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="Kubernetes Architectureçš„ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ"></a>Kubernetes Architectureçš„ç»„ä»¶æœ‰å“ªäº›ï¼Ÿ</h3><p>Kubernetes ArchitectureåŒ…å«ä¸»èŠ‚ç‚¹å’Œå·¥ä½œèŠ‚ç‚¹ã€‚è¿è¡Œåœ¨ä¸»èŠ‚ç‚¹ä¸Šçš„ç»„ä»¶æœ‰ï¼škube-controller-managerï¼Œkube-apiserverï¼Œkube-schedulerã€‚å·¥ä½œèŠ‚ç‚¹ä¸Šçš„ç»„ä»¶æœ‰ï¼škubeletå’Œkube-proxyã€‚</p>
<h3 id="ingressçš„æ„ä¹‰ï¼Ÿ"><a href="#ingressçš„æ„ä¹‰ï¼Ÿ" class="headerlink" title="ingressçš„æ„ä¹‰ï¼Ÿ"></a>ingressçš„æ„ä¹‰ï¼Ÿ</h3><p>åŠ¨æ€é…ç½®æœåŠ¡ï¼Œå‡å°‘ä¸å¿…è¦çš„ç«¯å£æš´éœ²</p>
<p>k8så¯¹å¤–æš´éœ²æœåŠ¡çš„æ–¹å¼ï¼Ÿ</p>
<ul>
<li>NodePort</li>
<li>LoadBalancer</li>
<li>Ingress</li>
</ul>
<p>ingress controlleré€šè¿‡å’Œkubernetes apiäº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ingressè§„åˆ™å˜åŒ–ï¼Œç”Ÿæˆç›¸åº”çš„nginxé…ç½®æ–‡ä»¶ã€‚</p>
<h3 id="æ— é€‰æ‹©å™¨çš„service"><a href="#æ— é€‰æ‹©å™¨çš„service" class="headerlink" title="æ— é€‰æ‹©å™¨çš„service?"></a>æ— é€‰æ‹©å™¨çš„service?</h3><p>service å…¶å®æ˜¯ä¸€ä¸ªTCP/UDP ä»£ç†ï¼Œä¸ä»…å¯ä»¥ä»£ç†Podä¹Ÿå¯ä»¥ä»£ç†å…¶ä»–çš„éPodèµ„æºï¼Œä¾‹å¦‚å¤–ç½‘çš„æ•°æ®åº“ï¼Œæˆ–è€…å…¶ä»–çš„èµ„æºã€‚æ²¡æœ‰é…ç½®é€‰æ‹©å™¨çš„service ï¼Œendpointsä¸ºç©ºï¼Œå¯ä»¥ç»™è¿™ä¸ªservice æ·»åŠ æˆ–ä¿®æ”¹ endpoint</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynoselector-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">50000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Endpoints</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mynoselector-service</span></span><br><span class="line"><span class="attr">subsets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">addresses:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">13.75</span><span class="number">.107</span><span class="number">.151</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>
<h3 id="K8sç‰ˆæœ¬å˜åŒ–"><a href="#K8sç‰ˆæœ¬å˜åŒ–" class="headerlink" title="K8sç‰ˆæœ¬å˜åŒ–"></a>K8sç‰ˆæœ¬å˜åŒ–</h3><p>Alphaï¼ˆå†…éƒ¨æµ‹è¯•ç‰ˆï¼‰-&gt;Betaï¼ˆæµ‹è¯•ç‰ˆï¼‰-&gt; GAï¼ˆæ­£å¼å‘å¸ƒçš„ç‰ˆæœ¬ï¼‰</p>
<p><strong>v1.13 2018å¹´12æœˆ04æ—¥</strong><br>kubeadmè¿›å…¥GAï¼Œå®¹å™¨å­˜å‚¨æ¥å£ï¼ˆCSIï¼‰è¿›å…¥GAï¼ŒCoreDNSæˆä¸ºé»˜è®¤DNSæœåŠ¡å™¨</p>
<p><strong>v1.14 2019å¹´03æœˆ26æ—¥</strong><br>ç”Ÿäº§çº§æ”¯æŒWindowsèŠ‚ç‚¹ï¼Œkubectlå…¨æ–°æ–‡æ¡£ä¸kustomizeé›†æˆï¼ŒæŒä¹…æœ¬åœ°å·è¿›å…¥GA</p>
<p><strong>v1.15 2019å¹´06æœˆ19æ—¥</strong><br>æ ¸å¿ƒAPIå¯æ‰©å±•æ€§ï¼Œkubeadmé«˜å¯ç”¨è¿›å…¥Betaï¼Œkubeadmæ— ç¼å‡çº§æ‰€æœ‰è¯ä¹¦ï¼ŒæŒç»­æ”¹è¿›CSIã€‚</p>
<p><strong>v1.16 2019å¹´09æœˆ18æ—¥</strong><br>CRDè¿›å…¥GAï¼Œå‡†å…¥æ§åˆ¶Webhooksè¿›å…¥GAï¼ŒIPv4/IPv6åŒæ ˆåè®®æ”¯æŒï¼ŒCSIè§„èŒƒå·å¤§å°è°ƒæ•´ã€‚</p>
<p><strong>v1.17 2019 å¹´12æœˆ10æ—¥</strong></p>
<ul>
<li>äº‘ä¾›åº”å•†æ ‡ç­¾ GAï¼šæ—©åœ¨ v1.2 ç‰ˆæœ¬ä¸­å°±ä½œä¸ºæµ‹è¯•ç‰ˆåŠŸèƒ½æ·»åŠ ï¼Œv1.17 ç‰ˆæœ¬ä¸­çš„äº‘ä¾›åº”å•†æ ‡ç­¾æ™®éå¯ç”¨ã€‚</li>
<li>Volume Snapshot è¿›å…¥ bata ç‰ˆï¼šKubernetes Volume SnapshotåŠŸèƒ½ç°åœ¨æ˜¯Kubernetes v1.17ä¸­çš„æµ‹è¯•ç‰ˆã€‚è¯¥åŠŸèƒ½åœ¨ Kubernetes v1.12 ä¸­ä½œä¸º alpha å¼•å…¥çš„ï¼Œåœ¨ Kubernetes v1.13 ä¸­è¿›è¡Œäº†ç¬¬äºŒæ¬¡ alphaï¼Œå¹¶è¿›è¡Œäº†çªç ´æ€§ä¿®æ”¹ã€‚</li>
<li>CSI è¿ç§»ï¼ˆMigrationï¼‰è¿›å…¥ beata ç‰ˆï¼šKubernetes æ ‘å†…ï¼ˆin-treeï¼‰å­˜å‚¨æ’ä»¶åˆ°å®¹å™¨å­˜å‚¨æ¥å£ï¼ˆCSIï¼‰è¿ç§»åŸºç¡€æ¶æ„ç°åœ¨æ˜¯ Kubernetes v1.17 ä¸­çš„ beata ç‰ˆã€‚CSI è¿ç§»åœ¨ Kubernetes v1.14 ä¸­ä½œä¸º alpha å¼•å…¥ã€‚</li>
</ul>
<p><strong>v1.18 2020å¹´3æœˆ26æ—¥</strong><br><a href="https://v1-18.docs.kubernetes.io/blog/2020/03/25/kubernetes-1-18-release-announcement/" rel="external nofollow noopener noreferrer" target="_blank">https://v1-18.docs.kubernetes.io/blog/2020/03/25/kubernetes-1-18-release-announcement/</a></p>
<p>Taint Based Evictionï¼Œkubectl diff ç­‰</p>
<p><strong>v1.19 2020å¹´8æœˆ27æ—¥</strong><br>ä» Kubernetes 1.19 ç‰ˆæœ¬å¼€å§‹ï¼Œæ”¯æŒçª—å£å°†å»¶é•¿åˆ°ä¸€å¹´ã€‚<br>Ingress å‡çº§ä¸º GAï¼Œç»“æ„åŒ–æ—¥å¿—ç­‰</p>
<p><strong>v1.20</strong><br>Dockershimå¼ƒç”¨</p>
<p><strong>v1.21</strong><br>PodSecurityPolicy å¼ƒç”¨<br>ä¸å¯å˜ ConfigMap/Secret è¿›å…¥ç¨³å®šç‰ˆ</p>
<p>å½“é›†ç¾¤åŒ…å«å¤§é‡ ConfigMap å’Œ Secret æ—¶ï¼Œå¤§é‡çš„ watch äº‹ä»¶ä¼šæ€¥å‰§å¢åŠ  kube-apiserver çš„è´Ÿè½½ï¼Œå¹¶ä¼šå¯¼è‡´é”™è¯¯é…ç½®è¿‡å¿«ä¼ æ’­åˆ°æ•´ä¸ªé›†ç¾¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸­ï¼Œç»™ä¸éœ€è¦ç»å¸¸ä¿®æ”¹çš„ ConfigMap å’Œ Secret è®¾ç½® <code>immutable: true</code> å°±å¯ä»¥é¿å…ç±»ä¼¼çš„é—®é¢˜ã€‚</p>
<p>æ³¨æ„ï¼Œè®¾ç½® <code>immutable: true</code> ä¹‹åï¼ŒConfigMap å’Œ Secret å†…å®¹æ›´æ–°æ—¶éœ€è¦åˆ é™¤å¹¶é‡æ–°åˆ›å»ºï¼Œä¸”ä½¿ç”¨å®ƒä»¬çš„ Pod ä¹Ÿéœ€è¦åˆ é™¤é‡å»ºã€‚</p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>Kafkaç¬”è®°</title>
    <url>/2021/Kafka-learning/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸»é¢˜</span></span><br><span class="line">bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 1 --partitions 1 --topic topic-1</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºtopic</span></span><br><span class="line">bin/kafka-topics.sh  --list --zookeeper localhost:2181</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹topicä¿¡æ¯</span></span><br><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-topics.sh --topic test --describe --zookeeper localhost:2181</span></span><br><span class="line">Topic: <span class="built_in">test</span>	TopicId: qmyHki2JRAmbHssyAaGNqw	PartitionCount: 1	ReplicationFactor: 1	Configs: </span><br><span class="line">	Topic: <span class="built_in">test</span>	Partition: 0	Leader: 1	Replicas: 1	Isr: 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤topic</span></span><br><span class="line">bin/kafka-topics.sh --delete --topic topic-01 --zookeeper localhost:2181</span><br><span class="line">Note: This will have no impact <span class="keyword">if</span> delete.topic.enable is not <span class="built_in">set</span> to <span class="literal">true</span>.</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‘é€æ¶ˆæ¯ï¼ˆé€šè¿‡consoleï¼‰</span></span><br><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-console-producer.sh --broker-list 192.168.19.208:9092 --topic test</span></span><br><span class="line">&gt;abc</span><br><span class="line">&gt;123 456</span><br><span class="line">&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¢é˜…æ¶ˆæ¯</span></span><br><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-console-consumer.sh --bootstrap-server 192.168.19.208:9092 --topic test --from-beginning</span></span><br><span class="line">abc</span><br><span class="line">123 456</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿäº§è€…å‹æµ‹-æ‰¹é‡åˆ›å»ºæ¶ˆæ¯</span></span><br><span class="line">bin/kafka-producer-perf-test.sh --topic topic-1 --num-records 10000 --record-size 1024 --throughput -1 --producer-props bootstrap.servers=192.168.19.208:9092 acks=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¶ˆè´¹è€…å‹æµ‹</span></span><br><span class="line">bin/kafka-consumer-perf-test.sh --bootstrap-server 127.0.0.1:9092 --topic perf_test --messages 1000000 --threads 8 --reporting-interval 1000</span><br></pre></td></tr></table></figure>
<p><font color="red">é—®é¢˜1</font>ï¼šproduceré€šè¿‡ <code>--broker-list localhost:9092</code> æˆ– <code>--bootstrap-server 127.0.0.1:9092</code> è¿æ¥brokerå¤±è´¥ï¼Œè€Œä¸ä½¿ç”¨localhostã€127.0.0.1æ”¹ç”¨brokerèŠ‚ç‚¹IPåˆ™å¯ä»¥ï¼Œæ˜¯å¦æ˜¯é…ç½®é”™äº†ï¼Ÿ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-console-producer.sh --topic test --bootstrap-server 127.0.0.1:9092</span></span><br><span class="line">&gt;[2021-10-28 11:45:36,517] WARN [Producer clientId=console-producer] Connection to node -1 (/127.0.0.1:9092) could not be established. Broker may not be available. (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">[2021-10-28 11:45:36,517] WARN [Producer clientId=console-producer] Bootstrap broker 127.0.0.1:9092 (id: -1 rack: null) disconnected (org.apache.kafka.clients.NetworkClient)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆï¼Œ<code>--broker-list</code> é€‰é¡¹æ˜¯è¿‡æ—¶çš„ï¼Œä¸å»ºè®®ç»§ç»­ä½¿ç”¨ã€‚consumeræ— æ­¤é€‰é¡¹ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-console-producer.sh --help</span></span><br><span class="line">This tool helps to <span class="built_in">read</span> data from standard input and publish it to Kafka.</span><br><span class="line">Option                                   Description                            </span><br><span class="line">------                                   -----------                            </span><br><span class="line">--batch-size &lt;Integer: size&gt;             Number of messages to send <span class="keyword">in</span> a single </span><br><span class="line">                                           batch <span class="keyword">if</span> they are not being sent     </span><br><span class="line">                                           synchronously. (default: 200)        </span><br><span class="line">--bootstrap-server &lt;String: server to    REQUIRED unless --broker-list          </span><br><span class="line">  connect to&gt;                              (deprecated) is specified. The server</span><br><span class="line">                                           (s) to connect to. The broker list   </span><br><span class="line">                                           string <span class="keyword">in</span> the form HOST1:PORT1,HOST2:</span><br><span class="line">                                           PORT2.                               </span><br><span class="line">--broker-list &lt;String: broker-list&gt;      DEPRECATED, use --bootstrap-server     </span><br><span class="line">                                           instead; ignored <span class="keyword">if</span> --bootstrap-     </span><br><span class="line">                                           server is specified.  The broker     </span><br><span class="line">                                           list string <span class="keyword">in</span> the form HOST1:PORT1, </span><br><span class="line">                                           HOST2:PORT2.</span><br></pre></td></tr></table></figure>
<p><code>server.properties</code> é…ç½®å¦‚ä¸‹ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">############################# Socket Server Settings #############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The address the socket server listens on. It will get the value returned from</span></span><br><span class="line"><span class="comment"># java.net.InetAddress.getCanonicalHostName() if not configured.</span></span><br><span class="line"><span class="comment">#   FORMAT:</span></span><br><span class="line"><span class="comment">#     listeners = listener_name://host_name:port</span></span><br><span class="line"><span class="comment">#   EXAMPLE:</span></span><br><span class="line"><span class="comment">#     listeners = PLAINTEXT://your.host.name:9092</span></span><br><span class="line"><span class="comment">#listeners=PLAINTEXT://:9092</span></span><br><span class="line"><span class="comment">##listeners=PLAINTEXT://localhost:9092</span></span><br><span class="line"><span class="attr">listeners</span>=PLAINTEXT://<span class="number">192.168</span>.<span class="number">19.208</span>:<span class="number">9092</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hostname and port the broker will advertise to producers and consumers. If not set,</span></span><br><span class="line"><span class="comment"># it uses the value for "listeners" if configured.  Otherwise, it will use the value</span></span><br><span class="line"><span class="comment"># returned from java.net.InetAddress.getCanonicalHostName().</span></span><br><span class="line"><span class="comment">#advertised.listeners=PLAINTEXT://your.host.name:9092</span></span><br><span class="line"><span class="comment">##advertised.listeners=PLAINTEXT://localhost:9092</span></span><br><span class="line"><span class="attr">advertised.listeners</span>=PLAINTEXT://<span class="number">192.168</span>.<span class="number">19.208</span>:<span class="number">9092</span></span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œæ˜¯listeners å’Œadvertised.listenersé…ç½®çš„é—®é¢˜ï¼Œèƒ½ä½¿ç”¨å·²æ³¨å†Œåˆ°zookeeperçš„åœ°å€ã€‚æŒ‰é»˜è®¤é…ç½®çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨localhostæˆ–127.0.0.1ï¼Œä¸æŒ‡å®šå…·ä½“IPçš„è¯ï¼Œåœ¨å®¢æˆ·ç«¯ä»£ç ä¸­é€šè¿‡APIå»è¿æ¥Kafkaå°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºæ²¡æœ‰è·å–åˆ°æœåŠ¡ç«¯çš„IPï¼Œåªèƒ½ä»æœåŠ¡å™¨ä½¿ç”¨localhostè¿æ¥ã€‚</p>
<p><font color="red">é—®é¢˜2</font>ï¼šï¼špsshæ‰§è¡Œ <code>bin/kafka-server-stop.sh</code> æœªèƒ½åœæ­¢Kafkaï¼Ÿ</p>
<p>æŸ¥çœ‹stopè„šæœ¬ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">OSNAME=$(uname -s)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="string">"<span class="variable">$OSNAME</span>"</span> == <span class="string">"OS/390"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -z <span class="variable">$JOBNAME</span> ]; <span class="keyword">then</span></span><br><span class="line">        JOBNAME=<span class="string">"KAFKSTRT"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    PIDS=$(ps -A -o pid,jobname,comm | grep -i <span class="variable">$JOBNAME</span> | grep java | grep -v grep | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"><span class="keyword">elif</span> [[ <span class="string">"<span class="variable">$OSNAME</span>"</span> == <span class="string">"OS400"</span> ]]; <span class="keyword">then</span></span><br><span class="line">    PIDS=$(ps -Af | grep -i <span class="string">'kafka\.Kafka'</span> | grep java | grep -v grep | awk <span class="string">'&#123;print $2&#125;'</span>)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    PIDS=$(ps ax | grep <span class="string">' kafka\.Kafka '</span> | grep java | grep -v grep | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>è„šæœ¬æ‰‹åŠ¨æ‰§è¡Œè·å–PIDæ²¡é—®é¢˜ï¼Œå¯èƒ½æ˜¯ç¯å¢ƒå˜é‡çš„åŸå› ï¼Œsourceåæ‰§è¡Œäº†ä¸€æ¬¡æ­£å¸¸åœæ­¢äº†ã€‚ä½†startæ—¶å´ä¸éœ€è¦sourceã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost zlz]<span class="comment"># pssh -h kafka.ips -i "cd /opt/kafka/kafka_2.12-2.8.0; source ~/.bashrc; sh run-kafka.sh stop"</span></span><br></pre></td></tr></table></figure>
<p>å†æ¢å¤é‡è¯•æ—¶ä¸åŠ sourceä¹Ÿèƒ½æ­£å¸¸åœæ­¢äº†ã€‚æœ€åå‘ç°å‘½ä»¤æ²¡é—®é¢˜ï¼Œä¸éœ€è¦sourceã€‚pssh æ‰¹é‡åœæ­¢Kafka serveræ—¶ï¼Œä¸ä¼šé©¬ä¸Šåœæ­¢ï¼Œæ˜¯é™†ç»­åœæ­¢çš„ï¼Œå¯èƒ½æœ‰å‡ ç§’çš„å»¶è¿Ÿã€‚å³ä¾¿åœ¨å„serverä¸Šæ‰‹åŠ¨æ‰§è¡Œstopï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚<br>å› æ­¤æ²¡é—®é¢˜ã€‚</p>
<p><font color="red">é—®é¢˜3</font>ï¼šadvertised.listenerså’Œlistenersé…ç½®éƒ½æ³¨é‡Šæ‰ï¼ŒKafka serverä¸èƒ½æŒ‰é»˜è®¤localhost:9092å¯åŠ¨ï¼Ÿ<br>ä»…æ”¾å¼€<code>listeners=PLAINTEXT://:9092</code>ä¹Ÿä¸è¡Œã€‚ç»æµ‹è®¾ç½® <code>listeners=PLAINTEXT://localhost:9092</code> å¯ä»¥å¯åŠ¨ï¼Œä½†æ˜¯produceræˆ–consumerè¿æ¥æ—¶ä¼šæŠ¥é”™ã€‚<br>å¦‚æœç»§ç»­è®¾ç½® <code>advertised.listeners=PLAINTEXT://localhost:9092</code>  çš„è¯ï¼Œå°±åˆä¼šæ— æ³•å¯åŠ¨serveräº†!<br>å¯èƒ½éœ€è¦é›†ç¾¤çŠ¶æ€æ•°æ®å§ï¼ŒæŒ‰localhostè¿æ¥æ²¡è¯•æˆï¼Œä¸æŠ˜è…¾äº†ï¼Œæ”¹å›é…ç½®IPåŠ ç«¯å£çš„æ–¹å¼ã€‚</p>
<h2 id="æ€§èƒ½æµ‹è¯•"><a href="#æ€§èƒ½æµ‹è¯•" class="headerlink" title="æ€§èƒ½æµ‹è¯•"></a>æ€§èƒ½æµ‹è¯•</h2><h3 id="ç”Ÿäº§è€…æ€§èƒ½æµ‹è¯•"><a href="#ç”Ÿäº§è€…æ€§èƒ½æµ‹è¯•" class="headerlink" title="ç”Ÿäº§è€…æ€§èƒ½æµ‹è¯•"></a>ç”Ÿäº§è€…æ€§èƒ½æµ‹è¯•</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 2 --partitions 2 --topic topic-2</span></span><br><span class="line">Created topic topic-2.</span><br><span class="line">...</span><br><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-topics.sh --create --zookeeper localhost:2181 --replication-factor 2 --partitions 64 --topic topic-64</span></span><br><span class="line">Created topic topic-64.</span><br><span class="line"></span><br><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-producer-perf-test.sh --topic topic-2 --num-records 10000 --record-size 1024 --throughput -1 --producer-props bootstrap.servers=192.168.19.208:9092 acks=1</span></span><br><span class="line">...</span><br><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-producer-perf-test.sh --topic topic-64 --num-records 10000 --record-size 1024 --throughput -1 --producer-props bootstrap.servers=192.168.19.208:9092 acks=1</span></span><br><span class="line">10000 records sent, 5614.823133 records/sec (5.48 MB/sec), 611.42 ms avg latency, 1299.00 ms max latency, 551 ms 50th, 1189 ms 95th, 1266 ms 99th, 1299 ms 99.9th.</span><br></pre></td></tr></table></figure>
<h3 id="æ¶ˆè´¹è€…æ€§èƒ½æµ‹è¯•"><a href="#æ¶ˆè´¹è€…æ€§èƒ½æµ‹è¯•" class="headerlink" title="æ¶ˆè´¹è€…æ€§èƒ½æµ‹è¯•"></a>æ¶ˆè´¹è€…æ€§èƒ½æµ‹è¯•</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-consumer-perf-test.sh --bootstrap-server 192.168.19.208:9092 --topic topic-2 --messages 10000</span></span><br><span class="line">...</span><br><span class="line">[root@kafka-1 kafka_2.12-2.8.0]<span class="comment"># bin/kafka-consumer-perf-test.sh --bootstrap-server 192.168.19.208:9092 --topic topic-64 --messages 10000</span></span><br><span class="line">start.time, end.time, data.consumed.in.MB, MB.sec, data.consumed.in.nMsg, nMsg.sec, rebalance.time.ms, fetch.time.ms, fetch.MB.sec, fetch.nMsg.sec</span><br><span class="line">2021-09-19 11:23:23:801, 2021-09-19 11:23:24:480, 9.7656, 14.3824, 10000, 14727.5405, 428, 251, 38.9069, 39840.6375</span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>åˆ†åŒºæ•°ï¼ˆå‰¯æœ¬å› å­=2ï¼‰</th>
<th>ç”Ÿäº§é€Ÿåº¦ï¼ˆç¬¬äºŒæ¬¡æµ‹è¯•ï¼‰</th>
<th>ç”Ÿäº§é€Ÿåº¦</th>
<th>æ¶ˆè´¹é€Ÿåº¦</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>9.53 MB/sec</td>
<td>6.90 MB/sec</td>
<td>41.21 MB/sec</td>
</tr>
<tr>
<td>4</td>
<td>8.74 MB/sec</td>
<td>5.92 MB/sec</td>
<td>35.03 MB/sec</td>
</tr>
<tr>
<td>8</td>
<td>8.99 MB/sec</td>
<td>7.59 MB/sec</td>
<td>39.23 MB/sec</td>
</tr>
<tr>
<td>16</td>
<td>11.37 MB/sec</td>
<td>8.43 MB/sec</td>
<td><font color="red">46.81 MB/sec</font></td>
</tr>
<tr>
<td>32</td>
<td><font color="red">12.19 MB/sec</font></td>
<td><font color="red">10.34 MB/sec</font></td>
<td>43.03 MB/sec</td>
</tr>
<tr>
<td>64</td>
<td>10.90 MB/sec</td>
<td>5.48 MB/sec</td>
<td>38.90 MB/sec</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>Hadoop</category>
      </categories>
      <tags>
        <tag>Kafka</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘Linuxæ—¥å¿—</title>
    <url>/2021/Linux-logs/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œæœ‰ä¸‰ä¸ªä¸»è¦çš„æ—¥å¿—å­ç³»ç»Ÿï¼š<strong>è¿æ¥æ—¶é—´æ—¥å¿—ï¼Œè¿›ç¨‹ç»Ÿè®¡æ—¥å¿—ï¼Œé”™è¯¯æ—¥å¿—</strong></p>
<a id="more"></a>
<p><strong>è¿æ¥æ—¶é—´æ—¥å¿—</strong></p>
<p>ç”±å¤šä¸ªç¨‹åºæ‰§è¡Œï¼ŒæŠŠè®°å½•å†™å…¥åˆ°/var/log/wtmpå’Œ/var/run/utmpï¼Œloginç­‰ç¨‹åºæ›´æ–°wtmpå’Œutmpæ–‡ä»¶ï¼Œä½¿ç³»ç»Ÿç®¡ç†å‘˜èƒ½å¤Ÿè·Ÿè¸ªè°åœ¨ä½•æ—¶ç™»å½•åˆ°ç³»ç»Ÿã€‚</p>
<p><strong>è¿›ç¨‹ç»Ÿè®¡æ—¥å¿—</strong></p>
<p>è¿›ç¨‹ç»Ÿè®¡æ—¥å¿—ç”±ç³»ç»Ÿå†…æ ¸æ‰§è¡Œã€‚å½“ä¸€ä¸ªè¿›ç¨‹ç»ˆæ­¢æ—¶ï¼Œä¸ºæ¯ä¸ªè¿›ç¨‹å¾€è¿›ç¨‹ç»Ÿè®¡æ–‡ä»¶ï¼ˆpacctæˆ–acctï¼‰ä¸­å†™ä¸€ä¸ªè®°å½•ã€‚è¿›ç¨‹ç»Ÿè®¡çš„ç›®çš„æ˜¯ä¸ºç³»ç»Ÿä¸­çš„åŸºæœ¬æœåŠ¡æä¾›å‘½ä»¤ä½¿ç”¨ç»Ÿè®¡ã€‚</p>
<p><strong>é”™è¯¯æ—¥å¿—</strong></p>
<p>é”™è¯¯æ—¥å¿—ç”±syslogdæ‰§è¡Œã€‚å„ç§ç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ã€ç”¨æˆ·ç¨‹åºå’Œå†…æ ¸é€šè¿‡syslogå‘æ–‡ä»¶/var/log/messagesæŠ¥å‘Šå€¼å¾—æ³¨æ„çš„äº‹ä»¶ã€‚å¦å¤–æœ‰è®¸å¤šUNIXç¨‹åºåˆ›å»ºæ—¥å¿—ã€‚åƒHTTPå’ŒFTPè¿™æ ·æä¾›ç½‘ç»œæœåŠ¡çš„æœåŠ¡å™¨ä¹Ÿä¿æŒè¯¦ç»†çš„æ—¥å¿—ã€‚</p>
<p>æ–‡æœ¬ç±»å‹çš„æ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/var/log/messages  </span><br><span class="line">/var/log/dmesg</span><br><span class="line">/var/log/secure</span><br><span class="line">/var/log/cron</span><br><span class="line">/var/log/maillog</span><br><span class="line">/var/log/yum.log</span><br></pre></td></tr></table></figure>
<p>/var/log/messagesæ—¥å¿—æ ¼å¼ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Dec 19 17:39:06 localhost sz[17833]: [root] ConfigActivity.xml/ZMODEM: 287531 Bytes, 343933 BPS</span><br><span class="line">1. äº§ç”Ÿè¿™ä¸ªäº‹ä»¶çš„æ—¶é—´æ˜¯ï¼šDec 19 17:39:06</span><br><span class="line">2. äº‹ä»¶çš„æ¥æºä¸»æœºä¸ºï¼šlocalhost</span><br><span class="line">3. äº§ç”Ÿè¿™ä¸ªäº‹ä»¶çš„ç¨‹åºå’Œè¿›ç¨‹å·ä¸ºï¼šsz[17833]</span><br><span class="line">4. è¿™ä¸ªäº‹ä»¶å®é™…çš„æ—¥å¿—ä¿¡æ¯ä¸ºï¼š[root] ConfigActivity.xml/ZMODEM: 287531 Bytes, 343933 BPS</span><br></pre></td></tr></table></figure>
<p>äºŒè¿›åˆ¶æ—¥å¿—ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/var/log/wtmp</span><br><span class="line">/var/log/lastlog</span><br><span class="line">/var/run/utmp</span><br><span class="line">è¿™ä¸‰ä¸ªæ–‡ä»¶ä¸­ä¿å­˜äº†ç³»ç»Ÿç”¨æˆ·ç™»å½•ã€é€€å‡ºç­‰ç›¸å…³äº‹ä»¶çš„äº‹ä»¶ä¿¡æ¯ï¼Œä¸èƒ½ç›´æ¥ä½¿ç”¨tailã€lessç­‰æ–‡æœ¬æŸ¥çœ‹å·¥å…·è¿›è¡Œæµè§ˆï¼Œéœ€è¦ä½¿ç”¨who/w/users/finger/id/last/lastlogå’Œacç­‰ç”¨æˆ·æŸ¥è¯¢å‘½ä»¤æ¥è·å–æ—¥å¿—ä¿¡æ¯</span><br></pre></td></tr></table></figure>
<p>ç³»ç»Ÿæ—¥å¿—ï¼š</p>
<p>/var/log/lastlogï¼šè®°å½•æœ€åä¸€æ¬¡ç”¨æˆ·æˆåŠŸç™»é™†çš„æ—¶é—´ã€ç™»é™†IPç­‰ä¿¡æ¯<br>/var/log/messagesï¼šè®°å½•Linuxæ“ä½œç³»ç»Ÿå¸¸è§çš„ç³»ç»Ÿå’ŒæœåŠ¡é”™è¯¯ä¿¡æ¯<br>/var/log/secureï¼šLinuxç³»ç»Ÿå®‰å…¨æ—¥å¿—ï¼Œè®°å½•ç”¨æˆ·å’Œå·¥ä½œç»„å˜åæƒ…å†µã€ç”¨æˆ·ç™»é™†è®¤è¯æƒ…å†µ<br>/var/log/btmpï¼šè®°å½•Linuxç™»é™†å¤±è´¥çš„ç”¨æˆ·ã€æ—¶é—´ä»¥åŠè¿œç¨‹IPåœ°å€<br>/var/log/cronï¼šè®°å½•crondè®¡åˆ’ä»»åŠ¡æœåŠ¡æ‰§è¡Œæƒ…å†µ<br>auth.logï¼šç™»å½•è®¤è¯çš„ä¿¡æ¯è®°å½•<br>boot.logï¼šç³»ç»Ÿå¯åŠ¨æ—¶çš„ç¨‹åºæœåŠ¡çš„æ—¥å¿—ä¿¡æ¯<br>dmesgï¼šå¯åŠ¨æ—¶æ˜¾ç¤ºåœ¨å±å¹•ä¸Šçš„å†…æ ¸ç¼“å†²ä¿¡æ¯å’Œç¡¬ä»¶ä¿¡æ¯, dmesgå‘½ä»¤ç”¨äºæ˜¾ç¤ºå¼€æœºä¿¡æ¯<br>faillogï¼šç”¨æˆ·ç™»å½•å¤±è´¥è¯¦ç»†ä¿¡æ¯è®°å½•<br>kern.logï¼šå†…æ ¸äº§ç”Ÿçš„ä¿¡æ¯è®°å½•</p>
<p>rsyslogç®¡ç†çš„æ—¥å¿—ï¼š</p>
<table>
<thead>
<tr>
<th>æ—¥å¿—</th>
<th style="text-align:left">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>/var/log/message</td>
<td style="text-align:left">ç³»ç»Ÿå¯åŠ¨åçš„ä¿¡æ¯å’Œé”™è¯¯æ—¥å¿—ï¼Œæ˜¯Red Hat Linuxä¸­æœ€å¸¸ç”¨çš„æ—¥å¿—ä¹‹ä¸€</td>
</tr>
<tr>
<td>/var/log/secure</td>
<td style="text-align:left">å®‰å…¨ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</td>
</tr>
<tr>
<td>/var/log/maillog</td>
<td style="text-align:left">é‚®ä»¶ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</td>
</tr>
<tr>
<td>/var/log/cron</td>
<td style="text-align:left">å®šæ—¶ä»»åŠ¡ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</td>
</tr>
<tr>
<td>/var/log/spooler</td>
<td style="text-align:left">UUCPå’Œnewsè®¾å¤‡ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯</td>
</tr>
<tr>
<td>/var/log/boot.log</td>
<td style="text-align:left">å®ˆæŠ¤è¿›ç¨‹å¯åŠ¨å’Œåœæ­¢ç›¸å…³çš„æ—¥å¿—æ¶ˆæ¯</td>
</tr>
</tbody>
</table>
<p><strong>rsyslog</strong> æ˜¯ä¸€ä¸ªå¿«é€Ÿå¤„ç†æ”¶é›†ç³»ç»Ÿæ—¥å¿—çš„ç¨‹åºï¼Œæä¾›äº†é«˜æ€§èƒ½ã€å®‰å…¨åŠŸèƒ½å’Œæ¨¡å—åŒ–è®¾è®¡ã€‚rsyslog æ˜¯syslog çš„å‡çº§ç‰ˆï¼Œå®ƒå°†å¤šç§æ¥æºè¾“å…¥è¾“å‡ºè½¬æ¢ç»“æœåˆ°ç›®çš„åœ°ã€‚</p>
<p>ç›¸å…³é…ç½®æ–‡ä»¶ï¼š/etc/rsyslog.conf, /etc/rsyslog.d/, /etc/sysconfig/rsyslog</p>
<p>æ—¥å¿—è½®è½¬é…ç½®æ–‡ä»¶ï¼š<strong>/etc/logrotate.conf</strong></p>
<p>è‡ªå®šä¹‰æ—¥å¿—è½¬å‚¨ï¼š<strong>/etc/logrotate.d/</strong></p>
<p>ç¤ºä¾‹ï¼šå°†æ‰€æœ‰ç±»å‹é”™è¯¯çº§åˆ«ä¸ºinfoçš„æ—¥å¿—è½¬å‚¨åˆ°/var/log/test.logæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå¹¶è®¾ç½®/var/log/test.logè¾¾åˆ°1KBåè¿›è¡Œè½¬å‚¨ï¼Œè½¬å‚¨10æ¬¡ï¼Œå‹ç¼©ï¼Œè½¬å‚¨åé‡å¯rsyslogæœåŠ¡ã€‚</p>
<p>åœ¨/etc/rsyslog.confæ·»åŠ ä¸€è¡Œé…ç½®ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# tail /etc/rsyslog.conf</span><br><span class="line">#$ActionQueueSaveOnShutdown on # save messages to disk on shutdown</span><br><span class="line">#$ActionQueueType LinkedList   # run asynchronously</span><br><span class="line">#$ActionResumeRetryCount -1    # infinite retries if host is down</span><br><span class="line"># remote host is: name/ip:port, e.g. 192.168.0.1:514, port optional</span><br><span class="line">#*.* @@remote-host:514</span><br><span class="line"># ### end of the forwarding rule ###</span><br><span class="line"></span><br><span class="line">## custom ...</span><br><span class="line">*.info /var/log/test.log</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# cat /etc/logrotate.d/test.log</span><br><span class="line">/var/log/test.log &#123;</span><br><span class="line"> rotate 10</span><br><span class="line"> size = 1k</span><br><span class="line"> compress</span><br><span class="line"> postrotate</span><br><span class="line">  killall -HUP rsyslogd</span><br><span class="line"> endscript</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘RESTfulä»‹ç»</title>
    <url>/2021/RESTful/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>Representational State Transferï¼Œå…·è±¡çŠ¶æ€ä¼ è¾“ï¼ˆè½¬æ¢ï¼‰ï¼Œè¡¨ç°å±‚çŠ¶æ€è½¬ç§»ã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="æ˜¯WebæœåŠ¡çš„ä¸€ç§æ–°çš„æ¶æ„é£æ ¼ï¼ˆä¸€ç§æ€æƒ³ï¼‰"><a href="#æ˜¯WebæœåŠ¡çš„ä¸€ç§æ–°çš„æ¶æ„é£æ ¼ï¼ˆä¸€ç§æ€æƒ³ï¼‰" class="headerlink" title="æ˜¯WebæœåŠ¡çš„ä¸€ç§æ–°çš„æ¶æ„é£æ ¼ï¼ˆä¸€ç§æ€æƒ³ï¼‰"></a>æ˜¯WebæœåŠ¡çš„ä¸€ç§æ–°çš„æ¶æ„é£æ ¼ï¼ˆä¸€ç§æ€æƒ³ï¼‰</h2><p>é¢å‘èµ„æº<br>ä¸€ç§è½¯ä»¶æ¶æ„é£æ ¼<br>URLå®šä½èµ„æºï¼Œç”¨HTTPåŠ¨è¯ï¼ˆGET,POST,DELETE,DETCï¼‰æè¿°æ“ä½œï¼Œä»status codeè·çŸ¥ç»“æœ</p>
<h2 id="RESTæ¶æ„çš„ä¸»è¦åŸåˆ™"><a href="#RESTæ¶æ„çš„ä¸»è¦åŸåˆ™" class="headerlink" title="RESTæ¶æ„çš„ä¸»è¦åŸåˆ™"></a>RESTæ¶æ„çš„ä¸»è¦åŸåˆ™</h2><p>å¯¹ç½‘ç»œä¸Šæ‰€æœ‰çš„èµ„æºéƒ½æœ‰ä¸€ä¸ªèµ„æºæ ‡å¿—ç¬¦<br>å¯¹èµ„æºçš„æ“ä½œä¸ä¼šæ”¹å˜æ ‡è¯†ç¬¦<br>åŒä¸€èµ„æºæœ‰å¤šç§è¡¨ç°å½¢å¼ï¼ˆxmlã€jsonï¼‰<br>æ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— çŠ¶æ€çš„ï¼ˆStatelessï¼‰</p>
<h2 id="RESTfulè®¾è®¡å‡†åˆ™"><a href="#RESTfulè®¾è®¡å‡†åˆ™" class="headerlink" title="RESTfulè®¾è®¡å‡†åˆ™"></a>RESTfulè®¾è®¡å‡†åˆ™</h2><p>å®¾è¯­å¿…é¡»æ˜¯åè¯<br>å¤æ•°URL<br>é¿å…å¤šçº§URL</p>
<ul>
<li>æ›´å¥½çš„åšæ³•æ˜¯ï¼Œé™¤äº†ç¬¬ä¸€çº§ï¼Œå…¶ä»–çº§åˆ«éƒ½ç”¨æŸ¥è¯¢å­—ç¬¦ä¸²è¡¨è¾¾<br>GET /authors/12?categories=2<br>GET /articles?published=true</li>
</ul>
<p>ä¼ ç»Ÿ vs RESTé£æ ¼</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/user/query/1 GET</span><br><span class="line">http://127.0.0.1/user/save POST </span><br><span class="line">http://127.0.0.1/user/update POST</span><br><span class="line">http://127.0.0.1/user/delete GET/POST</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http://127.0.0.1/user/&#123;id&#125; GET</span><br><span class="line">http://127.0.0.1/user POST</span><br><span class="line">http://127.0.0.1/user PUT</span><br><span class="line">http://127.0.0.1/user DELETE</span><br><span class="line"></span><br><span class="line">PATCH/collections/identityï¼šè¿”å›è¢«ä¿®æ”¹çš„å±æ€§</span><br></pre></td></tr></table></figure>
<p>ç½‘ç»œä¸Šçš„æ‰€æœ‰äº‹ç‰©éƒ½å¯ä»¥è¢«æŠ½è±¡ä¸ºèµ„æºã€‚<br>æ¯ä¸€ä¸ªèµ„æºéƒ½æœ‰å”¯ä¸€çš„èµ„æºæ ‡è¯†ï¼Œå¯¹èµ„æºçš„æ“ä½œä¸ä¼šæ”¹å˜è¿™äº›æ ‡è¯†ã€‚<br>æ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— çŠ¶æ€çš„ã€‚</p>
<h2 id="çŠ¶æ€ç "><a href="#çŠ¶æ€ç " class="headerlink" title="çŠ¶æ€ç "></a>çŠ¶æ€ç </h2><p><strong>GET</strong><br>å®‰å…¨ä¸”å¹‚ç­‰<br>è·å–è¡¨ç¤º<br>å˜æ›´æ—¶è·å–è¡¨ç¤ºï¼ˆç¼“å­˜ï¼‰<br>200ï¼ˆOKï¼‰ - è¡¨ç¤ºå·²åœ¨å“åº”ä¸­å‘å‡º<br>204ï¼ˆæ— å†…å®¹ï¼‰ - èµ„æºæœ‰ç©ºè¡¨ç¤º<br>301ï¼ˆMoved Permanentlyï¼‰ - èµ„æºçš„URIå·²è¢«æ›´æ–°<br>303ï¼ˆSee Otherï¼‰ - å…¶ä»–ï¼ˆå¦‚ï¼Œè´Ÿè½½å‡è¡¡ï¼‰<br>304ï¼ˆnot modifiedï¼‰- èµ„æºæœªæ›´æ”¹ï¼ˆç¼“å­˜ï¼‰<br>400 ï¼ˆbad requestï¼‰- æŒ‡ä»£åè¯·æ±‚ï¼ˆå¦‚ï¼Œå‚æ•°é”™è¯¯ï¼‰<br>404 ï¼ˆnot foundï¼‰- èµ„æºä¸å­˜åœ¨<br>406 ï¼ˆnot acceptableï¼‰- æœåŠ¡ç«¯ä¸æ”¯æŒæ‰€éœ€è¡¨ç¤º<br>500 ï¼ˆinternal server errorï¼‰- é€šç”¨é”™è¯¯å“åº”<br>503 ï¼ˆService Unavailableï¼‰- æœåŠ¡ç«¯å½“å‰æ— æ³•å¤„ç†è¯·æ±‚</p>
<p><strong>POST</strong><br>ä¸å®‰å…¨ä¸”ä¸å¹‚ç­‰<br>ä½¿ç”¨æœåŠ¡ç«¯ç®¡ç†çš„ï¼ˆè‡ªåŠ¨äº§ç”Ÿï¼‰çš„å®ä¾‹å·åˆ›å»ºèµ„æº<br>åˆ›å»ºå­èµ„æº<br>éƒ¨åˆ†æ›´æ–°èµ„æº<br>å¦‚æœæ²¡æœ‰è¢«ä¿®æ”¹ï¼Œåˆ™ä¸è¿‡æ›´æ–°èµ„æºï¼ˆä¹è§‚é”ï¼‰<br>200ï¼ˆOKï¼‰- å¦‚æœç°æœ‰èµ„æºå·²è¢«æ›´æ”¹<br>201ï¼ˆcreatedï¼‰- å¦‚æœæ–°èµ„æºè¢«åˆ›å»º<br>202ï¼ˆacceptedï¼‰- å·²æ¥å—å¤„ç†è¯·æ±‚ä½†å°šæœªå®Œæˆï¼ˆå¼‚æ­¥å¤„ç†ï¼‰<br>301ï¼ˆMoved Permanentlyï¼‰- èµ„æºçš„URIè¢«æ›´æ–°<br>303ï¼ˆSee Otherï¼‰- å…¶ä»–ï¼ˆå¦‚ï¼Œè´Ÿè½½å‡è¡¡ï¼‰<br>400ï¼ˆbad requestï¼‰- æŒ‡ä»£åè¯·æ±‚<br>404 ï¼ˆnot foundï¼‰- èµ„æºä¸å­˜åœ¨<br>406 ï¼ˆnot acceptableï¼‰- æœåŠ¡ç«¯ä¸æ”¯æŒæ‰€éœ€è¡¨ç¤º<br>409 ï¼ˆconflictï¼‰- é€šç”¨å†²çª<br>412 ï¼ˆPrecondition Failedï¼‰- å‰ç½®æ¡ä»¶å¤±è´¥ï¼ˆå¦‚æ‰§è¡Œæ¡ä»¶æ›´æ–°æ—¶çš„å†²çªï¼‰<br>415 ï¼ˆunsupported media typeï¼‰- æ¥å—åˆ°çš„è¡¨ç¤ºä¸å—æ”¯æŒ<br>500 ï¼ˆinternal server errorï¼‰- é€šç”¨é”™è¯¯å“åº”<br>503 ï¼ˆService Unavailableï¼‰- æœåŠ¡å½“å‰æ— æ³•å¤„ç†è¯·æ±‚</p>
<p><strong>PUT</strong><br>ä¸å®‰å…¨ä½†å¹‚ç­‰<br>ç”¨å®¢æˆ·ç«¯ç®¡ç†çš„å®ä¾‹å·åˆ›å»ºä¸€ä¸ªèµ„æº<br>é€šè¿‡æ›¿æ¢çš„æ–¹å¼æ›´æ–°èµ„æº<br>å¦‚æœæœªè¢«ä¿®æ”¹ï¼Œåˆ™æ›´æ–°èµ„æºï¼ˆä¹è§‚é”ï¼‰<br>200 ï¼ˆOKï¼‰- å¦‚æœå·²å­˜åœ¨èµ„æºè¢«æ›´æ”¹<br>201 ï¼ˆcreatedï¼‰- å¦‚æœæ–°èµ„æºè¢«åˆ›å»º<br>301ï¼ˆMoved Permanentlyï¼‰- èµ„æºçš„URIå·²æ›´æ”¹<br>303 ï¼ˆSee Otherï¼‰- å…¶ä»–ï¼ˆå¦‚ï¼Œè´Ÿè½½å‡è¡¡ï¼‰<br>400 ï¼ˆbad requestï¼‰- æŒ‡ä»£åè¯·æ±‚<br>404 ï¼ˆnot foundï¼‰- èµ„æºä¸å­˜åœ¨<br>406 ï¼ˆnot acceptableï¼‰- æœåŠ¡ç«¯ä¸æ”¯æŒæ‰€éœ€è¡¨ç¤º<br>409 ï¼ˆconflictï¼‰- é€šç”¨å†²çª<br>412 ï¼ˆPrecondition Failedï¼‰- å‰ç½®æ¡ä»¶å¤±è´¥ï¼ˆå¦‚æ‰§è¡Œæ¡ä»¶æ›´æ–°æ—¶çš„å†²çªï¼‰<br>415 ï¼ˆunsupported media typeï¼‰- æ¥å—åˆ°çš„è¡¨ç¤ºä¸å—æ”¯æŒ<br>500 ï¼ˆinternal server errorï¼‰- é€šç”¨é”™è¯¯å“åº”<br>503 ï¼ˆService Unavailableï¼‰- æœåŠ¡å½“å‰æ— æ³•å¤„ç†è¯·æ±‚</p>
<p><strong>DELETE</strong><br>ä¸å®‰å…¨ä½†å¹‚ç­‰<br>åˆ é™¤èµ„æº<br>200 ï¼ˆOKï¼‰- èµ„æºå·²è¢«åˆ é™¤<br>301 ï¼ˆMoved Permanentlyï¼‰- èµ„æºçš„URIå·²æ›´æ”¹<br>303 ï¼ˆSee Otherï¼‰- å…¶ä»–ï¼Œå¦‚è´Ÿè½½å‡è¡¡<br>400 ï¼ˆbad requestï¼‰- æŒ‡ä»£åè¯·æ±‚<br>404 ï¼ˆnot foundï¼‰- èµ„æºä¸å­˜åœ¨<br>409 ï¼ˆconflictï¼‰- é€šç”¨å†²çª<br>500 ï¼ˆinternal server errorï¼‰- é€šç”¨é”™è¯¯å“åº”<br>503 ï¼ˆService Unavailableï¼‰- æœåŠ¡ç«¯å½“å‰æ— æ³•å¤„ç†è¯·æ±‚</p>
<h2 id="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Restful"><a href="#ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Restful" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Restful"></a>ä¸ºä»€ä¹ˆè¦ä½¿ç”¨Restful</h2><p>RESTfulæ¶æ„ä¸å…¶ä»–æ¶æ„çš„åŒºåˆ«</p>
<ul>
<li>SOAP WebService</li>
<li>RESTful Webservice</li>
<li>æ•ˆç‡å’Œæ˜“ç”¨æ€§<ul>
<li>SOAPç”±äºå„ç§éœ€æ±‚ä¸æ–­æ‰©å……æœ¬èº«åè®®çš„å†…å®¹ï¼Œå¯¼è‡´åœ¨SOAPå¤„ç†æ–¹é¢çš„æ€§èƒ½æœ‰æ‰€ä¸‹é™ã€‚åŒæ—¶åœ¨æ˜“ç”¨æ€§æ–¹é¢ä»¥åŠå­¦ä¹ æˆæœ¬ä¸Šä¹Ÿæœ‰æ‰€å¢åŠ ã€‚</li>
<li>RESTfulç”±äºå…¶é¢å‘èµ„æºæ¥å£è®¾è®¡ä»¥åŠæ“ä½œæŠ½è±¡ç®€åŒ–äº†å¼€å‘è€…çš„ä¸è‰¯è®¾è®¡,åŒæ—¶ä¹Ÿæœ€å¤§é™åº¦çš„åˆ©ç”¨äº†Httpæœ€åˆçš„åº”ç”¨åè®®è®¾è®¡ç†å¿µã€‚</li>
</ul>
</li>
<li>å®‰å…¨<ul>
<li>RESTfulå¯¹äºèµ„æºå‹æœåŠ¡æ¥å£æ¥è¯´å¾ˆåˆé€‚,åŒæ—¶ç‰¹åˆ«é€‚åˆæ•ˆç‡è¦æ±‚å¾ˆé«˜,ä½†æ˜¯å¯¹äºå®‰å…¨è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚</li>
<li>SOAPçš„æˆç†Ÿæ€§å¯ä»¥ç»™éœ€è¦æä¾›ç»™å¤šå¼€å‘è¯­è¨€çš„, å¯¹äºå®‰å…¨æ€§<br>è¦æ±‚è¾ƒé«˜çš„æ¥å£è®¾è®¡å¸¦æ¥ä¾¿åˆ©ã€‚<br>RESTfulå‡å°‘äº†ä¼ ç»Ÿè¯·æ±‚çš„æ‹†è£…ç®±æ“ä½œï¼Œç»“æ„æ¸…æ™°ã€‚</li>
</ul>
</li>
</ul>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘broker/agent/proxy/delegateçš„åŒºåˆ«</title>
    <url>/2021/broker-agent-proxy-delegate/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Brokerï¼šä¸­ä»‹å¼ä»£ç†"><a href="#Brokerï¼šä¸­ä»‹å¼ä»£ç†" class="headerlink" title="Brokerï¼šä¸­ä»‹å¼ä»£ç†"></a>Brokerï¼šä¸­ä»‹å¼ä»£ç†</h2><p>Broker æ˜¯ä¸€ç§ä¸­ä»‹å¼ä»£ç†ã€‚åœ¨ç½‘ç»œä¸åˆ†å¸ƒè®¡ç®—ä¸­, ä¸¤ä¸ªå±‚æ¬¡ä¸Šçš„å¯¹ç­‰å®ä½“, è‹¥ä¸ä¾¿å½¼æ­¤ç›´æ¥äº¤å¾€, åˆ™å¯é€šè¿‡Brokerå®ç°é€šä¿¡ã€‚è¿™äº›å¯ä»¥æœ‰å„ç§å„æ ·çš„å®šä¹‰å’Œå®ç°, ä¹Ÿè¡¨ç°åœ¨ä¸åŒçš„å±‚æ¬¡ä¸Šã€‚ç®€å•ä¸€ç‚¹ï¼Œ Brokeræä¾›äº†åˆ†å¸ƒå¼æœåŠ¡å’Œèµ„æºçš„é€æ˜è®¿é—®ï¼Œå±è”½äº†å¼‚æ„ç»„ä»¶ä¹‹é—´çš„å·®å¼‚ã€‚<br><a id="more"></a><br>åˆ†å¸ƒå¼å¼‚æ„å¹³å°ä¹‹é—´, ä¸ºäº†å®ç°äº’æ“ä½œæ€§, é‡‡ç”¨ä¸­é—´ä»¶ä¹ƒæ˜¯æœ€å¸¸ç”¨çš„æ–¹æ³•. ä¾‹å¦‚ï¼Œåœ¨ä¸åŒç±»å‹æ“ä½œç³»ç»Ÿä¹‹é—´, ä¸åŒå‚å•†æ•°æ®åº“ä¹‹é—´, ä¸åŒåº”ç”¨ç³»ç»Ÿä¹‹é—´, å‡å¯ç”¨å„ç§ä¸­é—´ä»¶è§£å†³ã€‚ä¸­é—´ä»¶å°±æ˜¯ä¸€ç§ä¸­ä»‹å¼ä»£ç†. </p>
<h2 id="Agentï¼šè‡ªä¸»å¼ä»£ç†"><a href="#Agentï¼šè‡ªä¸»å¼ä»£ç†" class="headerlink" title="Agentï¼šè‡ªä¸»å¼ä»£ç†"></a>Agentï¼šè‡ªä¸»å¼ä»£ç†</h2><p>Agentæ˜¯åˆ†å¸ƒæ™ºèƒ½çš„åŸºç¡€å•å…ƒã€‚å®ƒå…·æœ‰ä¸€å®šç¨‹åº¦çš„ç‹¬ç«‹è¡Œä¸ºèƒ½åŠ›ä¸æ™ºèƒ½,åŒæ—¶åˆéµä»åˆ†å¸ƒç³»ç»Ÿä¸­æŸç§ç»Ÿä¸€çš„æ ‡å‡†ã€‚åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼ŒAgent å¯ä»¥å’Œå®¢æˆ·ç«¯ä¸åœ¨ä¸€å°ä¸»æœºä¸Šã€‚</p>
<p>Agentä»£è¡¨ç€ä¸»ä½“æœåŠ¡ï¼Œä½†ä¸»ä½“æœåŠ¡å¯¹Agentå¹¶ä¸æ˜¯å®Œå…¨æ§åˆ¶ï¼ŒAgentå®ç°äº†ä¸€å®šçš„ç®—æ³•, å…·æœ‰è§£å†³æŸç§é—®é¢˜çš„èƒ½åŠ›, ç”šè‡³åŒ…å«é€šå¸¸æ„ä¹‰ä¸‹çš„â€œäººå·¥æ™ºèƒ½â€, å¦‚æ¨ç†æœºã€æ¨¡ç³Šè¿ç®—ã€ç¥ç»ç½‘ç»œã€çŸ¥è¯†åº“ç­‰èƒ½åŠ›ã€‚Agentåœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…å…·æœ‰å„ç§å¯èƒ½çš„ç‰¹å¾å˜åŒ–ï¼Œä¸€èˆ¬é‡‡ç”¨çŠ¶æ€æœºæ¨¡å‹ï¼Œå…¶é€šä¿¡èƒ½åŠ›æ˜¯ä¸€åˆ‡äº’æ“ä½œæ€§çš„åŸºç¡€ã€‚</p>
<p>åŠ¨æ€ä»£ç†(dynamical-agent) æ¶æ„å°±æ˜¯ä¸€ç§å…¸å‹çš„åº”ç”¨ã€‚å®ƒæ”¯æŒè‡ªèº«è¡Œä¸ºçš„åŠ¨æ€ä¿®æ­£, å¹¶ä¸é™äºå…·æœ‰é¢„å®šçš„å›ºå®šåŠŸèƒ½, è€Œå¯æ ¹æ®åº”ç”¨åŠ¨æ€åœ°åŠ è½½å’Œä¿®æ”¹å…¶åŠ¨ä½œ, ä»¥é€‚åº”ç¯å¢ƒä¸è¦æ±‚å˜åŒ–, è·¨è¶Šä¸åŒåº”ç”¨è€Œæ‰®æ¼”ä¸åŒçš„è§’è‰²ã€‚</p>
<p>åœ¨äº’è”ç½‘åè®®æ ˆçš„åº”ç”¨ä¸­ï¼Œ SNMP Agentå°±æ˜¯ä¸€ç§è‡ªä¸»å¼ä»£ç†ï¼Œå…·ä½“å®ç°åŒ…æ‹¬äº†ä¸‰å¤§éƒ¨åˆ†ï¼šæ§åˆ¶æ¨¡å—ã€é€šè®¯æ¨¡å—å’ŒMIBä¿¡æ¯åº“ã€‚</p>
<h2 id="Proxyï¼šé€ä¼ å¼ä»£ç†"><a href="#Proxyï¼šé€ä¼ å¼ä»£ç†" class="headerlink" title="Proxyï¼šé€ä¼ å¼ä»£ç†"></a>Proxyï¼šé€ä¼ å¼ä»£ç†</h2><p>Proxyæ˜¯ä¸€ç§é€ä¼ å¼ä»£ç†ï¼Œæ˜¯ä¸ºäº†èƒ½æœ‰æ•ˆåœ°è®¿é—®è¿œç¨‹æœåŠ¡æˆ–å…¶ä»–ä»£ç†ã€‚è¿™é‡Œçš„â€œè¿œç¨‹â€å¹¶éä¸€å®šæ˜¯åœ°åŸŸä¸Šçš„è¿œè¿‘, è€Œæ˜¯æ¶‰åŠç½‘ç»œæ‹“æ‰‘æˆ–è®¡ç®—å¤æ‚åº¦ä¸Šçš„æˆæœ¬ã€‚</p>
<p>äº’è”ç½‘ä¸Šçš„ä»£ç†æœåŠ¡å™¨æŠ€æœ¯, ä¾¿æ˜¯è¿™ç±»ä»£ç†çš„åº”ç”¨, å®ƒå¯ä»¥ç©¿è¶Šæˆ–ç»•å¼€ç½‘ç»œå°é”(å¦‚é˜²ç«å¢™) , è¾¾åˆ°ç›®æ ‡ä¸»æœºã€‚</p>
<p>åœ¨Java ä¸­åŠ¨é™æ€ä»£ç†ä¸­çš„proxy å‘½åï¼Œæœ‰æ··æ·†æ¦‚å¿µçš„å«Œç–‘ï¼ŒJavaScriptä¸­çš„Proxyå¯¹è±¡ï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚</p>
<h2 id="Delegateï¼šå§”æ‰˜å¼ä»£ç†"><a href="#Delegateï¼šå§”æ‰˜å¼ä»£ç†" class="headerlink" title="Delegateï¼šå§”æ‰˜å¼ä»£ç†"></a>Delegateï¼šå§”æ‰˜å¼ä»£ç†</h2><p>Delegate æ˜¯å§”æ‰˜æ€§æˆ–è€…æŒ‡æ´¾å¼ä»£ç†ï¼Œä¸€èˆ¬åœ°ï¼Œç®¡ç†è¿›ç¨‹æŒ‡æ´¾ç»™ä»£ç†æ–¹ï¼Œå¹¶åœ¨ä»£ç†æ–¹æ‰§è¡Œç®¡ç†æ“ä½œï¼Œè€Œä¸æ¶‰åŠç®¡ç†æ–¹ã€‚</p>
<p>Delegate ä¸å…·å¤‡è‡ªä¸»ç§»åŠ¨çš„èƒ½åŠ›ï¼Œéœ€è¦å€ŸåŠ©å¤–åŠ›ï¼Œé€šè¿‡æŒ‡æ´¾åè®®ä»ä¸€ä¸ªåœ°å€ç©ºé—´ç§»åŠ¨åˆ°å¦ä¸€ä¸ªåœ°å€ç©ºé—´ã€‚åªè¦éœ€è¦Delegate æ‰§è¡Œä»»åŠ¡ï¼Œå®ƒå°±ä¸€ç›´å¤„äºæ‰§è¡ŒçŠ¶æ€ã€‚å®ƒå¯ä»¥å®Œæˆè®¡ç®—æ€§èƒ½å‚æ•°å’Œç»Ÿè®¡æ•°æ®ã€é…ç½®ç½‘ç»œã€ä¿®æ”¹å‚æ•°ã€æ›´æ–°åº”ç”¨ç­‰ä»»åŠ¡ã€‚</p>
<p>åœ¨JQuery ä¸­å°±æœ‰Delegateï¼ˆï¼‰æ–¹æ³•ï¼Œæ›´å¹¿æ³›ä¸ºäººæ‰€çŸ¥çš„å°±æ˜¯Obj-Cä¸­çš„å§”æ‰˜å¼ä»£ç†äº†ã€‚iOSå¼€å‘ä¸­çš„Delegateç”¨äºé¡µé¢ä¼ å€¼ï¼Œä¹Ÿå¸¸ç”¨Delegateæ¥ä¼ é€’æ¶ˆæ¯å’Œå€¼ï¼Œä»¥åŠUITableViewçš„Delegateç­‰ã€‚</p>
<p>ç„¶è€Œï¼Œç°å®æ˜¯å¤æ‚çš„ï¼Œè¿™å››ç§ä»£ç†æœºåˆ¶ç«Ÿç„¶å¯ä»¥æ··åˆç»„è£…ä½¿ç”¨ï¼Œä¾‹å¦‚proxy-agent ç­‰ç­‰ã€‚</p>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>Using Cluster IP Service Type and Ingress</title>
    <url>/2021/Using-Cluster-IP%20Service-Type-and-Ingress/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/exposing-tcp-udp-services/" rel="external nofollow noopener noreferrer" target="_blank">ingresså››å±‚è½¬å‘é…ç½®å‚è€ƒ</a><br><a href="https://www.ibm.com/docs/en/netcoolomnibus/8?topic=private-exposing-probe-service" rel="external nofollow noopener noreferrer" target="_blank">Exposing the probe service - IBM Documentation</a></p>
</blockquote>
<p>Due to a limitation on the Kubernetes Ingress resource to expose TCP and UDP services, the following steps can be used to create a static configuration on the Kubernetes Ingress controller to make the probe service reachable externally. This limitation does not apply to probes that use HTTP protocols to receive data.</p>
<p>A Cluster Administrator needs to reconfigure the nginx-ingress-controller with a â€œstaticâ€ configuration based on Configmaps and restart the ingress controller for the changes to take effect.</p>
<a id="more"></a>
<blockquote>
<p>CAUTION:<br>Restarting the ingress controller would impact other workloads running. Consider performing the change during a planned downtime in production environments.</p>
</blockquote>
<p>To expose the probe TCP/UDP service to external networks using Ingress, you will need to configure the nginx-ingress-controller to specify the <strong>â€“tcp-services-configmap</strong> and <strong>â€“udp-services-configmap</strong> flags to point to an existing configuration map where the key is the external port to use and the value indicates the service to expose:</p>
<ol>
<li><p>Set <strong>probe.service.type=ClusterIP</strong>.</p>
</li>
<li><p>Determine the service name and ports of deployment using the following commands. In this example, the myprobe Helm release in the default namespace is used to query for the service name and port.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">export NAMESPACE=default</span><br><span class="line">export CHARTREL=myprobe</span><br><span class="line">export SERVICE_NAME=$(kubectl get services --namespace $NAMESPACE -l &quot;app.kubernetes.io/instance=$CHARTREL&quot; -o jsonpath=&quot;&#123;.items[0].metadata.name&#125;&quot;)</span><br><span class="line">export SERVICE_PORT=$(kubectl get services --namespace $NAMESPACE -l &quot;app.kubernetes.io/instance=$CHARTREL&quot; -o jsonpath=&quot;&#123;.items[0].spec.ports[0].port&#125;&quot;)</span><br><span class="line">echo &quot;$NAMESPACE/$SERVICE_NAME:$SERVICE_PORT&quot;</span><br><span class="line">default/myprobe-ibm-netcool-probe-snmp:162</span><br></pre></td></tr></table></figure>
</li>
<li><p>Create a configuration map to store the external port to use and service to expose using the format: &lt;namespace/service name&gt;:<service port>:[PROXY]:[PROXY] where [PROXY]:[PROXY] is optional. For example, create the configmap resource as shown below in the default namepace to expose a host port 1162 to myprobe-ibm-netcool-probe-snmp on port 162 which is deployed on default namespace. If an existing configmap already exists, add a new entry into the section data.</service></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl create configmap tcp-controller-configmap \</span><br><span class="line">    --from-literal=1162=default/myprobe-ibm-netcool-probe-snmp:162</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>This creates the following config map:<br>  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">    name: tcp-controller-configmap</span><br><span class="line">    namespace: default</span><br><span class="line">data:</span><br><span class="line">    1162: &quot;default/myprobe-ibm-netcool-probe-snmp:162&quot;</span><br></pre></td></tr></table></figure></p>
<ol start="4">
<li><p>Optionally, to expose a UDP service, create a new config map as shown in the following example. If an existing configmap exists, add a new entry into the data section.</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">    name: udp-controller-configmap</span><br><span class="line">    namespace: default</span><br><span class="line">data:</span><br><span class="line">    1162: &quot;default/myprobe-ibm-netcool-probe-snmp:162&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Edit the nginx-ingress-controller daemon set to add the following items.</p>
<blockquote>
<p><strong>Note</strong>: In IBM Cloud Private 2.1.0.2, the Nginx Controller name is nginx-ingress-lb-<arch>, where <arch> is the platform architecture such amd64 or ppc64le.</arch></arch></p>
</blockquote>
</li>
</ol>
<p>The TCP/UDP services configmap flags <strong>â€“tcp-services-configmap=tcp-controller-configmap</strong> and <strong>â€“udp-services-configmap=udp-controller-configmap</strong> in the .spec.template.spec.containers[].args[] attribute. An example is shown in the following JSON snippet:</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;spec&quot;: &#123;</span><br><span class="line">    &quot;containers&quot;: [</span><br><span class="line"> &#123;</span><br><span class="line">        &quot;args&quot;: [</span><br><span class="line">         &quot;/nginx-ingress-controller&quot;,</span><br><span class="line">            &quot;--default-backend-service=$(POD_NAMESPACE)/default-backend&quot;,</span><br><span class="line">            &quot;--configmap=$(POD_NAMESPACE)/nginx-ingress-controller&quot;,</span><br><span class="line">            &quot;--report-node-internal-ip-address=true&quot;,</span><br><span class="line">         &quot;--annotations-prefix=ingress.kubernetes.io&quot;,</span><br><span class="line">            &quot;--enable-ssl-passthrough=true&quot;,</span><br><span class="line">         &quot;--publish-status-address=9.42.83.226&quot;,</span><br><span class="line">            &quot;--udp-services-configmap=default/udp-controller-configmap&quot;,</span><br><span class="line">            &quot;--tcp-services-configmap=default/tcp-controller-configmap&quot;</span><br><span class="line">    	],</span><br></pre></td></tr></table></figure>
<p>Add an additional hostport for the Ingress to open in the .spec.template.spec.containers[].ports[] attribute of the nginx-ingress-controller daemon set in the kube-system namespace. The default ports are ports 80 (TCP) and 443 (TCP). To add the additional hostports, use the following steps:</p>
<p>Edit the nginx-ingress-controller and find the .spec.template.spec.containers[].ports[] attribute.</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">kubectl edit ds/nginx-ingress-controller -n kube-system</span><br></pre></td></tr></table></figure>
<p>The example shown in the following JSON snippet adds two new hostports 1162 for both TCP/UDP in the Ingress controller.</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;name&quot;: &quot;nginx-ingress&quot;,</span><br><span class="line">&quot;ports&quot;: [</span><br><span class="line"> &#123;</span><br><span class="line">        &quot;containerPort&quot;: 80,</span><br><span class="line">     &quot;hostPort&quot;: 80,</span><br><span class="line">        &quot;name&quot;: &quot;http&quot;,</span><br><span class="line">     &quot;protocol&quot;: &quot;TCP&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;containerPort&quot;: 443,</span><br><span class="line">     &quot;hostPort&quot;: 443,</span><br><span class="line">        &quot;name&quot;: &quot;https&quot;,</span><br><span class="line">     &quot;protocol&quot;: &quot;TCP&quot;</span><br><span class="line">    &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">        &quot;containerPort&quot;: 1162,</span><br><span class="line">        &quot;hostPort&quot;: 1162,</span><br><span class="line">        &quot;name&quot;: &quot;snmp-tcp&quot;,</span><br><span class="line">     &quot;protocol&quot;: &quot;TCP&quot;</span><br><span class="line">    &#125;,</span><br><span class="line"> &#123;</span><br><span class="line">        &quot;containerPort&quot;: 1162,</span><br><span class="line">     &quot;hostPort&quot;: 1162,</span><br><span class="line">        &quot;name&quot;: &quot;snmp-udp&quot;,</span><br><span class="line">        &quot;protocol&quot;: &quot;UDP&quot;</span><br><span class="line">    &#125;</span><br><span class="line">],</span><br></pre></td></tr></table></figure>
<p>Save/apply the changes to the nginx-ingress-controller daemon set. The nginx-ingress-controller will automatically restart its nginx-ingress-controller pod and load the new configuration.</p>
<ol start="6">
<li><p>After the nginx-ingress-controller pod is running, verify that you are able to reach the probe service via the hostport. For the SNMP Probe for example, test by sending a SNMP trap to <kubernetes-proxy-ip>:1162 as configured above and the SNMP Probe should log (if messageLevel=debug) indicating that trap is received.</kubernetes-proxy-ip></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">snmptrap -C i -v 2c \</span><br><span class="line">    -c public tcp:&lt;kubernetes-proxy-ip&gt;:1162 \</span><br><span class="line">    .1.3.6.1.6.3.1.1.5.3 .1.3.6.1.6.3.1.1.5.3   \</span><br><span class="line">    ifIndex i 2 \</span><br><span class="line">    ifAdminStatus i 1 \</span><br><span class="line">    ifOperStatus i 1</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearchç¬”è®°02</title>
    <url>/2021/elasticsearch-note/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å€’æ’ç´¢å¼•"><a href="#å€’æ’ç´¢å¼•" class="headerlink" title="å€’æ’ç´¢å¼•"></a>å€’æ’ç´¢å¼•</h2><p>å€’æ’ç´¢å¼•æ˜¯å•è¯æ–‡æ¡£çŸ©é˜µçš„ä¸€ç§å­˜å‚¨å½¢å¼<br>åˆ†è¯ç³»ç»Ÿå°†æ–‡æ¡£åˆ‡åˆ†æˆå•è¯åºåˆ—</p>
<blockquote>
<p>å•è¯æ–‡æ¡£çŸ©é˜µ = å•è¯è¯å…¸ + å€’æ’æ–‡ä»¶<br>å•è¯è¯å…¸ï¼šæ‰€æœ‰å•è¯çš„é›†åˆï¼ŒåŒ…æ‹¬å•è¯æœ¬èº«çš„ä¿¡æ¯å’ŒæŒ‡å‘å€’æ’åˆ—è¡¨çš„æŒ‡é’ˆ<br>å€’æ’æ–‡ä»¶ï¼šæ‰€æœ‰å•è¯çš„å€’æ’åˆ—è¡¨é¡ºåºåœ°å­˜å‚¨åœ¨ç£ç›˜é‡Œå½¢æˆçš„æ–‡ä»¶</p>
</blockquote>
<p>å€’æ’åˆ—è¡¨æœ€ç®€å•çš„å½¢å¼ä»…è®°å½•åŒ…å«æŸä¸ªå•è¯çš„æ–‡æ¡£ç¼–å·(DocID)ï¼Œå¤æ‚ä¸€äº›çš„ï¼Œè¿˜è®°å½•äº†å•è¯åœ¨æŸä¸ªæ–‡æ¡£å‡ºç°çš„æ¬¡æ•°ï¼Œå³å•è¯é¢‘ç‡ï¼ˆTFï¼‰ï¼Œè¿˜å¯èƒ½åŒ…å«æŸä¸ªå•è¯çš„æ–‡æ¡£æ•°ï¼Œå³æ–‡æ¡£é¢‘ç‡ï¼ˆDFï¼‰,å’Œå•è¯åœ¨æ–‡æ¡£ä¸­çš„ä½ç½®ï¼ˆPosï¼‰</p>
<a id="more"></a>
<h2 id="ESæ“ä½œè®°å½•"><a href="#ESæ“ä½œè®°å½•" class="headerlink" title="ESæ“ä½œè®°å½•"></a>ESæ“ä½œè®°å½•</h2><p>ç‰ˆæœ¬ï¼š7.5</p>
<h3 id="åˆ›å»ºç´¢å¼•ï¼ˆåŒæ—¶åˆ›å»ºæ˜ å°„ï¼‰"><a href="#åˆ›å»ºç´¢å¼•ï¼ˆåŒæ—¶åˆ›å»ºæ˜ å°„ï¼‰" class="headerlink" title="åˆ›å»ºç´¢å¼•ï¼ˆåŒæ—¶åˆ›å»ºæ˜ å°„ï¼‰"></a>åˆ›å»ºç´¢å¼•ï¼ˆåŒæ—¶åˆ›å»ºæ˜ å°„ï¼‰</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -XPUT http://localhost:9200/book -H &quot;Content-Type: application/json&quot; -d &apos;&#123;</span><br><span class="line">  &quot;settings&quot;: &#123;</span><br><span class="line">    &quot;number_of_shards&quot;: 1,</span><br><span class="line">    &quot;number_of_replicas&quot;: 1</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;mappings&quot;: &#123;</span><br><span class="line">    &quot;properties&quot;: &#123;</span><br><span class="line">      &quot;id&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;long&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;name&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;text&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;book_url&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;keyword&quot;</span><br><span class="line">      &#125;,</span><br><span class="line">      &quot;price&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;double&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;&apos;</span><br></pre></td></tr></table></figure>
<p>7.0ä¹‹åçš„ç‰ˆæœ¬æ²¡æœ‰typeçš„æ¦‚å¿µï¼ˆè§<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/removal-of-types.html" rel="external nofollow noopener noreferrer" target="_blank">Removal of mapping types</a>ï¼‰ã€‚å¦‚æœéœ€è¦è¿ç§»åŒ…å«å¤šä¸ªtypeçš„æ—§ç´¢å¼•åˆ°æ–°ç‰ˆæœ¬ESé‡Œï¼Œå¯ä»¥åˆ›å»ºå¤šä¸ªindexåˆ†åˆ«å¯¹åº”ä¸€ä¸ªtypeï¼Œæˆ–è€…åªåˆ›å»ºä¸€ä¸ªindexå¹¶å¢åŠ typeå­—æ®µï¼Œç„¶åä½¿ç”¨<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.15/docs-reindex.html" rel="external nofollow noopener noreferrer" target="_blank">reindex</a>è¿ç§»æ–‡æ¡£ã€‚</p>
<h3 id="ç”¨PUTè¿˜æ˜¯POSTï¼Ÿ"><a href="#ç”¨PUTè¿˜æ˜¯POSTï¼Ÿ" class="headerlink" title="ç”¨PUTè¿˜æ˜¯POSTï¼Ÿ"></a>ç”¨PUTè¿˜æ˜¯POSTï¼Ÿ</h3><p>æ“ä½œå…·ä½“çš„èµ„æºç”¨PUTï¼Œæ“ä½œé›†åˆèµ„æºç”¨POSTï¼ŒPOSTéå¹‚ç­‰æ€§ã€‚</p>
<blockquote>
<p>_settingséœ€ç”¨PUTä¸èƒ½ç”¨POST<br>_searchä¸èƒ½ç”¨PUT</p>
</blockquote>
<h3 id="æŸ¥çœ‹æ˜ å°„"><a href="#æŸ¥çœ‹æ˜ å°„" class="headerlink" title="æŸ¥çœ‹æ˜ å°„"></a>æŸ¥çœ‹æ˜ å°„</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost es_api_test]# curl -s -XGET http://localhost:9200/book/_mapping |jq</span><br></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ã€æŸ¥çœ‹"><a href="#åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ã€æŸ¥çœ‹" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ã€æŸ¥çœ‹"></a>åˆ›å»ºä¸€ä¸ªæ–‡æ¡£ã€æŸ¥çœ‹</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /user/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;username&quot;: &quot;dream-hammer&quot;,</span><br><span class="line">  &quot;message&quot;: &quot;abc123&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># curlåˆ›å»º</span><br><span class="line">curl -XPUT  -H &apos;Content-Type: application/json&apos; http://localhost:9200/user/_doc/1 -d &apos;&#123;&quot;username&quot;: &quot;dream-hammer&quot;,&quot;message&quot;: &quot;abc123&quot;&#125;&apos;</span><br><span class="line"># curlæŸ¥è¯¢</span><br><span class="line">curl -s -XPOST localhost:9200/user/_search -H &apos;Content-Type: application/json&apos; -d &apos;&#123;&quot;query&quot;: &#123;&quot;match_all&quot;: &#123;&#125;&#125;&#125;&apos; |jq</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;took&quot;: 0,</span><br><span class="line">  &quot;timed_out&quot;: false,</span><br><span class="line">  &quot;_shards&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: 1,</span><br><span class="line">    &quot;successful&quot;: 1,</span><br><span class="line">    &quot;skipped&quot;: 0,</span><br><span class="line">    &quot;failed&quot;: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;hits&quot;: &#123;</span><br><span class="line">    &quot;total&quot;: &#123;</span><br><span class="line">      &quot;value&quot;: 1,</span><br><span class="line">      &quot;relation&quot;: &quot;eq&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;max_score&quot;: 1,</span><br><span class="line">    &quot;hits&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;_index&quot;: &quot;user&quot;,</span><br><span class="line">        &quot;_type&quot;: &quot;_doc&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;1&quot;,</span><br><span class="line">        &quot;_score&quot;: 1,</span><br><span class="line">        &quot;_source&quot;: &#123;</span><br><span class="line">          &quot;username&quot;: &quot;dream-hammer&quot;,</span><br><span class="line">          &quot;message&quot;: &quot;abc123&quot;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ›´æ–°ä¸€ä¸ªæ–‡æ¡£"><a href="#æ›´æ–°ä¸€ä¸ªæ–‡æ¡£" class="headerlink" title="æ›´æ–°ä¸€ä¸ªæ–‡æ¡£"></a>æ›´æ–°ä¸€ä¸ªæ–‡æ¡£</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /user/_doc/1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;def321&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;_index&quot; : &quot;user&quot;,</span><br><span class="line">  &quot;_type&quot; : &quot;_doc&quot;,</span><br><span class="line">  &quot;_id&quot; : &quot;1&quot;,</span><br><span class="line">  &quot;_version&quot; : 7,</span><br><span class="line">  &quot;result&quot; : &quot;updated&quot;,</span><br><span class="line">  &quot;_shards&quot; : &#123;</span><br><span class="line">    &quot;total&quot; : 2,</span><br><span class="line">    &quot;successful&quot; : 1,</span><br><span class="line">    &quot;failed&quot; : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;_seq_no&quot; : 10,</span><br><span class="line">  &quot;_primary_term&quot; : 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ä¹è§‚æ›´æ–°"><a href="#ä¹è§‚æ›´æ–°" class="headerlink" title="ä¹è§‚æ›´æ–°"></a>ä¹è§‚æ›´æ–°</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PUT /user/_doc/1?version=7</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;def3210&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŠ¥é”™å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;action_request_validation_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;type&quot;: &quot;action_request_validation_exception&quot;,</span><br><span class="line">    &quot;reason&quot;: &quot;Validation Failed: 1: internal versioning can not be used for optimistic concurrency control. Please use `if_seq_no` and `if_primary_term` instead;&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;status&quot;: 400</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>versionä¸èƒ½ç”¨äºä¹è§‚å¹¶å‘æ›´æ–°ã€‚æ”¹ç”¨seq_noå’Œprimary_termå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET /user/_doc/1  # æŸ¥çœ‹å½“å‰seq_no, primary_term</span><br><span class="line">PUT /user/_doc/1?if_seq_no=10&amp;if_primary_term=1</span><br><span class="line">&#123;</span><br><span class="line">  &quot;message&quot;: &quot;def3210&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æ‰¹é‡åˆ›å»ºæ–‡æ¡£"><a href="#æ‰¹é‡åˆ›å»ºæ–‡æ¡£" class="headerlink" title="æ‰¹é‡åˆ›å»ºæ–‡æ¡£"></a>æ‰¹é‡åˆ›å»ºæ–‡æ¡£</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost es_api_test]<span class="comment"># cat songs.bulk</span></span><br><span class="line">&#123;<span class="string">"index"</span>: &#123;<span class="string">"_index"</span>: <span class="string">"songs"</span>, <span class="string">"_type"</span>: <span class="string">"_doc"</span>&#125;&#125;</span><br><span class="line">&#123;<span class="string">"id"</span>: 1, <span class="string">"name"</span>: <span class="string">"é£ç­è¯¯"</span>, <span class="string">"time"</span>: <span class="string">"04:31"</span>, <span class="string">"artist"</span>: <span class="string">"åˆ˜ç‚çŸ£"</span>, <span class="string">"album"</span>: <span class="string">"åŠå£¶çº±"</span>, <span class="string">"cover"</span>: <span class="string">"https://s5.music.126.net/style/web2/img/default/default_album.jpg"</span>, <span class="string">"url"</span>: <span class="string">"static/media/é£ç­è¯¯.mp3"</span>&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -s -H &quot;Content-Type: application/x-ndjson&quot; -XPOST localhost:9200/_bulk --data-binary &quot;@songs.bulk&quot;    #æ˜¯--data-binaryï¼Œä¸æ˜¯-dï¼Œå¦åˆ™æç¤ºparse_exception</span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹ç´¢å¼•"><a href="#æŸ¥çœ‹ç´¢å¼•" class="headerlink" title="æŸ¥çœ‹ç´¢å¼•"></a>æŸ¥çœ‹ç´¢å¼•</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost es_api_test]# curl http://localhost:9200/_cat/indices?v</span><br><span class="line">health status index                    uuid                   pri rep docs.count docs.deleted store.size pri.store.size</span><br><span class="line">green  open   .kibana_task_manager_1   zKnjGTdrRgyElkST2F-Bdw   1   0          2            0     31.6kb         31.6kb</span><br><span class="line">yellow open   songs                    2-yMj8ikTYay4k8f_CIQ2g   1   1         25            0     28.4kb         28.4kb</span><br><span class="line">green  open   .apm-agent-configuration nP5HnnIYQhWqjcd17By6lA   1   0          0            0       283b           283b</span><br><span class="line">green  open   .kibana_1                zZuFlefIRhaHHBdJiYovuw   1   0         10            3     43.4kb         43.4kb</span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€"><a href="#æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€" class="headerlink" title="æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€"></a>æŸ¥çœ‹é›†ç¾¤å¥åº·çŠ¶æ€</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost es_api_test]<span class="comment"># curl http://localhost:9200/_cluster/health?pretty</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"docker-cluster"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"yellow"</span>,    <span class="comment">#yellowçŠ¶æ€</span></span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : 1,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : 1,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : 4,</span><br><span class="line">  <span class="string">"active_shards"</span> : 4,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : 0,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : 0,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : 1,    <span class="comment">#unassigned 1</span></span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : 0,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : 0,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : 80.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹åˆ†ç‰‡"><a href="#æŸ¥çœ‹åˆ†ç‰‡" class="headerlink" title="æŸ¥çœ‹åˆ†ç‰‡"></a>æŸ¥çœ‹åˆ†ç‰‡</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost es_api_test]<span class="comment"># curl http://localhost:9200/_cat/shards/songs?v</span></span><br><span class="line">index shard prirep state      docs  store ip         node</span><br><span class="line">songs 0     p      STARTED      25 28.4kb 172.24.0.2 1583abe64b70</span><br><span class="line">songs 0     r      UNASSIGNED</span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹æ–‡æ¡£æ•°"><a href="#æŸ¥çœ‹æ–‡æ¡£æ•°" class="headerlink" title="æŸ¥çœ‹æ–‡æ¡£æ•°"></a>æŸ¥çœ‹æ–‡æ¡£æ•°</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost es_api_test]<span class="comment"># curl http://localhost:9200/songs/_count?pretty</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"count"</span> : 25,</span><br><span class="line">  <span class="string">"_shards"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 1,</span><br><span class="line">    <span class="string">"successful"</span> : 1,</span><br><span class="line">    <span class="string">"skipped"</span> : 0,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="åŸºæ•°èšåˆ"><a href="#åŸºæ•°èšåˆ" class="headerlink" title="åŸºæ•°èšåˆ"></a>åŸºæ•°èšåˆ</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /songs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;aggs&quot;: &#123;</span><br><span class="line">    &quot;distinct_name_count&quot;: &#123;&quot;cardinality&quot;: &#123;&quot;field&quot;: &quot;name&quot;&#125;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;error&quot;: &#123;</span><br><span class="line">    &quot;root_cause&quot;: [</span><br><span class="line">      &#123;</span><br><span class="line">        &quot;type&quot;: &quot;illegal_argument_exception&quot;,</span><br><span class="line">        &quot;reason&quot;: &quot;Fielddata is disabled on text fields by default. Set fielddata=true on [name] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>è§£å†³æ–¹æ³•ï¼š</p>
<ol>
<li>æ”¹nameä¸ºname.keyword</li>
<li>è®¾ç½®fileddata=true</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /songs/_mapping</span><br><span class="line">&#123;</span><br><span class="line">  &quot;properties&quot;: &#123;</span><br><span class="line">     &quot;name&quot;: &#123;</span><br><span class="line">       &quot;type&quot;: &quot;text&quot;, </span><br><span class="line">       &quot;fielddata&quot;: true</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è·å–ç´¢å¼•å‰50ä¸ªæ–‡æ¡£"><a href="#è·å–ç´¢å¼•å‰50ä¸ªæ–‡æ¡£" class="headerlink" title="è·å–ç´¢å¼•å‰50ä¸ªæ–‡æ¡£"></a>è·å–ç´¢å¼•å‰50ä¸ªæ–‡æ¡£</h3><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">GET|POST /songs/_search?size=50</span><br><span class="line"></span><br><span class="line">GET|POST /songs/_search?size=50</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match_all&quot;: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET|POST /songs/_search</span><br><span class="line">&#123;</span><br><span class="line">  &quot;query&quot;: &#123;</span><br><span class="line">    &quot;match&quot;: &#123;</span><br><span class="line">      &quot;name.keyword&quot;: &quot;é£ç­è¯¯&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç”¨GETè¿˜æ˜¯POST"><a href="#ç”¨GETè¿˜æ˜¯POST" class="headerlink" title="ç”¨GETè¿˜æ˜¯POST?"></a>ç”¨GETè¿˜æ˜¯POST?</h3><p>æœ‰ç‚¹å¥‡æ€ªï¼ŒGETä¹Ÿå¯ä»¥å¸¦è¯·æ±‚ä½“ï¼ŒESå®˜ç½‘çš„searchè¯­æ³•<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-span-containing-query.html" rel="external nofollow noopener noreferrer" target="_blank">ç¤ºä¾‹</a>éƒ½æ˜¯GETã€‚</p>
<blockquote>
<p>GETè¯·æ±‚æ˜¯æ˜¯ä¾é URIæ£€ç´¢æ•°æ®çš„ï¼ŒRFCæ²¡æœ‰è§„å®šä¸èƒ½æœ‰å“åº”ä½“ï¼Œåªæ˜¯è¯´GETé€šè¿‡URIæ ‡è¯†å¹¶<strong>è·å–</strong>äº†ä¸€ä¸ªèµ„æºï¼Œä¸”å†æ¬¡è·å–ä¸ä¼šé‡æ–°è¯·æ±‚ï¼Œå¯ä»¥å‡å°‘ç½‘ç»œè´Ÿæ‹…ã€‚</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># curl -s -XPOST localhost:9200/songs/_search?size=50 -H 'Content-Type: application/json' -d '&#123;"query": &#123;"match_all": &#123;&#125;&#125;&#125;' 2&gt;/dev/null  |jq</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"took"</span>: 0,</span><br><span class="line">  <span class="string">"timed_out"</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"_shards"</span>: &#123;</span><br><span class="line">    <span class="string">"total"</span>: 1,</span><br><span class="line">    <span class="string">"successful"</span>: 1,</span><br><span class="line">    <span class="string">"skipped"</span>: 0,</span><br><span class="line">    <span class="string">"failed"</span>: 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"hits"</span>: &#123;</span><br><span class="line">    <span class="string">"total"</span>: &#123;</span><br><span class="line">      <span class="string">"value"</span>: 25,</span><br><span class="line">      <span class="string">"relation"</span>: <span class="string">"eq"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"max_score"</span>: 1,</span><br><span class="line">    <span class="string">"hits"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"_index"</span>: <span class="string">"songs"</span>,</span><br><span class="line">        <span class="string">"_type"</span>: <span class="string">"_doc"</span>,</span><br><span class="line">        <span class="string">"_id"</span>: <span class="string">"vwFbiHsBbxOPhTYXJGC2"</span>,</span><br><span class="line">        <span class="string">"_score"</span>: 1,</span><br><span class="line">        <span class="string">"_source"</span>: &#123;</span><br><span class="line">          <span class="string">"id"</span>: 1,</span><br><span class="line">          <span class="string">"name"</span>: <span class="string">"é£ç­è¯¯"</span>,</span><br><span class="line">          <span class="string">"time"</span>: <span class="string">"04:31"</span>,</span><br><span class="line">          <span class="string">"artist"</span>: <span class="string">"åˆ˜ç‚çŸ£"</span>,</span><br><span class="line">          <span class="string">"album"</span>: <span class="string">"åŠå£¶çº±"</span>,</span><br><span class="line">          <span class="string">"cover"</span>: <span class="string">"https://s4.music.126.net/style/web2/img/default/default_album.jpg"</span>,</span><br><span class="line">          <span class="string">"url"</span>: <span class="string">"static/media/é£ç­è¯¯.mp3"</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      ...</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆjsonp</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># curl -s -XPOST localhost:9200/songs/_doc/_search?size=50 -H 'Content-Type: application/json' -d '&#123;"query": &#123;"match_all": &#123;&#125;&#125;&#125;' 2&gt;/dev/null  |jq |awk 'BEGIN&#123;flag=0&#125;&#123;if($0~/"_source":/)&#123;print "&#123;"; flag=1&#125;else if(flag)&#123;print $0;&#125; if($0~/^\s*&#125;$/)&#123;flag=0&#125;&#125;' |sed 's/\s*&#125;/&#125;,/g;' |sed '1 s/^&#123;/&#123;"data": [&#123;/' |sed '$ s/,$/]&#125;/' |jq |sed '1 i callBack(' |sed '$ s/$/);/'</span></span><br><span class="line">callBack(</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"data"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">"id"</span>: 1,</span><br><span class="line">      <span class="string">"name"</span>: <span class="string">"é£ç­è¯¯"</span>,</span><br><span class="line">      <span class="string">"time"</span>: <span class="string">"04:31"</span>,</span><br><span class="line">      <span class="string">"artist"</span>: <span class="string">"åˆ˜ç‚çŸ£"</span>,</span><br><span class="line">      <span class="string">"album"</span>: <span class="string">"åŠå£¶çº±"</span>,</span><br><span class="line">      <span class="string">"cover"</span>: <span class="string">"https://s4.music.126.net/style/web2/img/default/default_album.jpg"</span>,</span><br><span class="line">      <span class="string">"url"</span>: <span class="string">"static/media/é£ç­è¯¯.mp3"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="å…¶å®ƒAPI"><a href="#å…¶å®ƒAPI" class="headerlink" title="å…¶å®ƒAPI"></a>å…¶å®ƒAPI</h3><ul>
<li><a href="https://lzzeng.github.io/docs/docs/log-analysis/es-api-memo.html">es-api-memo</a></li>
<li><a href="https://lzzeng.github.io/2021/Elasticsearch/">Elasticsearchç¬”è®°01</a></li>
</ul>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Elasticsearch</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘HDFSå’ŒHBase</title>
    <url>/2021/hdfs-hbase/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h2><p>HDFSæ˜¯Hadoopåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€‚<br>ä¸€ä¸ªHDFSé›†ç¾¤ä¸»è¦ç”±ä¸€ä¸ªNameNodeå’Œå¾ˆå¤šä¸ªDatanodeç»„æˆï¼šNamenodeç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®ï¼Œè€ŒDatanodeå­˜å‚¨äº†å®é™…çš„æ•°æ®ã€‚<br><a id="more"></a><br>HDFSé‡‡ç”¨ä¸€ç§ç§°ä¸ºæœºæ¶æ„ŸçŸ¥(rack-aware)çš„ç­–ç•¥æ¥æ”¹è¿›æ•°æ®çš„å¯é æ€§ã€å¯ç”¨æ€§å’Œç½‘ç»œå¸¦å®½çš„åˆ©ç”¨ç‡ã€‚</p>
<p>å‰¯æœ¬ï¼šåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå‰¯æœ¬ç³»æ•°æ˜¯3ï¼ŒHDFSçš„å­˜æ”¾ç­–ç•¥æ˜¯å°†ä¸€ä¸ªå‰¯æœ¬å­˜æ”¾åœ¨æœ¬åœ°æœºæ¶çš„èŠ‚ç‚¹ä¸Šï¼Œä¸€ä¸ªå‰¯æœ¬æ”¾åœ¨åŒä¸€æœºæ¶çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œæœ€åä¸€ä¸ªå‰¯æœ¬æ”¾åœ¨ä¸åŒæœºæ¶çš„èŠ‚ç‚¹ä¸Šã€‚</p>
<h2 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h2><p>HBaseæ˜¯Google Bigtableçš„å¼€æºå®ç°ï¼Œç±»ä¼¼Google Bigtableåˆ©ç”¨GFSä½œä¸ºå…¶æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿï¼ŒHBaseåˆ©ç”¨Hadoop HDFSä½œä¸ºå…¶æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿã€‚</p>
<p>åˆ©ç”¨Hadoop MapReduceæ¥å¤„ç†HBaseä¸­çš„æµ·é‡æ•°æ®ã€‚</p>
<p>ä¸ºä»€ä¹ˆåœ¨HDFSä¸Šä½¿ç”¨HBaseï¼Ÿ</p>
<ul>
<li>HBase åœ¨ HDFS ä¹‹ä¸Šæä¾›äº†ï¼š<ul>
<li>é«˜å¹¶å‘å®æ—¶éšæœºå†™ï¼Œé€šè¿‡ LSMï¼ˆå†…å­˜+é¡ºåºå†™ç£ç›˜ï¼‰çš„æ–¹å¼æä¾›äº† HDFS æ‰€ä¸æ‹¥æœ‰çš„å®æ—¶éšæœºå†™åŠä¿®æ”¹åŠŸèƒ½</li>
<li>é«˜å¹¶å‘å®æ—¶ç‚¹è¯»åŠæ‰«æï¼ˆäº†è§£ä¸€ä¸‹ LSM ç®—æ³•ï¼‰ï¼Œåœ¨æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šæœ‰æ•°æ®åº“ï¼Œåœ¨ä¸šåŠ¡å±‚é¢ï¼ŒHBase å®Œå…¨å¯ä»¥ç‹¬ç«‹äº HDFS</li>
</ul>
</li>
<li>HDFSä¸ºHBaseæä¾›äº†é«˜å¯é æ€§çš„åº•å±‚å­˜å‚¨æ”¯æŒ</li>
<li>Hadoop MapReduceä¸ºHBaseæä¾›äº†é«˜æ€§èƒ½çš„è®¡ç®—èƒ½åŠ›ï¼ŒZookeeperä¸ºHBaseæä¾›äº†ç¨³å®šæœåŠ¡å’Œfailoveræœºåˆ¶ã€‚Pigå’ŒHiveè¿˜ä¸ºHBaseæä¾›äº†é«˜å±‚è¯­è¨€æ”¯æŒï¼Œä½¿å¾—åœ¨HBaseä¸Šè¿›è¡Œæ•°æ®ç»Ÿè®¡å¤„ç†å˜çš„éå¸¸ç®€å•ã€‚ Sqoopåˆ™ä¸ºHBaseæä¾›äº†æ–¹ä¾¿çš„RDBMSï¼ˆå…³ç³»å‹æ•°æ®åº“ï¼‰æ•°æ®å¯¼å…¥åŠŸèƒ½ï¼Œä½¿å¾—ä¼ ç»Ÿæ•°æ®åº“æ•°æ®å‘HBaseä¸­è¿ç§»å˜çš„éå¸¸æ–¹ä¾¿</li>
<li>HBASEå¯ä»¥æ»¡è¶³å¤§è§„æ¨¡æ•°æ®çš„å®æ—¶å¤„ç†éœ€æ±‚<ul>
<li>HDFSé¢å‘æ‰¹é‡è®¿é—®æ¨¡å¼ï¼Œä¸æ˜¯éšæœºè®¿é—®æ¨¡å¼</li>
<li>Hadoopå¯ä»¥å¾ˆå¥½åœ°è§£å†³å¤§è§„æ¨¡æ•°æ®çš„ç¦»çº¿æ‰¹é‡å¤„ç†é—®é¢˜ï¼Œä½†æ˜¯ï¼Œå—é™äºHadoop MapReduceç¼–ç¨‹æ¡†æ¶çš„é«˜å»¶è¿Ÿæ•°æ®å¤„ç†æœºåˆ¶ï¼Œä½¿å¾—Hadoopæ— æ³•æ»¡è¶³å¤§è§„æ¨¡æ•°æ®å®æ—¶å¤„ç†åº”ç”¨çš„éœ€æ±‚</li>
</ul>
</li>
</ul>
<p>Hadoopçš„å››ä¸ªä¸»è¦ç»„æˆéƒ¨åˆ†ï¼šæ ¸å¿ƒåŒ…ï¼ŒHDFSæ–‡ä»¶ç³»ç»Ÿï¼ŒMapReduceæ¨¡å‹ï¼Œyarnèµ„æºè°ƒåº¦æ¡†æ¶ã€‚</p>
]]></content>
      <categories>
        <category>Hadoop</category>
      </categories>
      <tags>
        <tag>Hadoop</tag>
      </tags>
  </entry>
  <entry>
    <title>å¯†ç ç®¡ç†å·¥å…·ä¸€åª</title>
    <url>/2021/mypass/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>å¯†ç ç™¾å…«åä¸ªï¼Œåˆä¸ä¾¿æ˜æ–‡è®°å½•åœ¨æ‰‹æœºæˆ–æœ¬å­ä¸Šï¼Œåªè®°æç¤ºç¬¦æ—¶é—´ä¸€é•¿çœ‹ç€ä¸€å †ç®€ç•¥çš„æç¤ºç¬¦ä¹Ÿå‚»çœ¼ï¼Œå¸‚åœºä¸Šçš„å¯†ç ç®¡ç†appè™½ç„¶ç•Œé¢å¥½çœ‹ä½†ä¹Ÿä¸æ•¢ç”¨ï¼Œå®‰å“å¼€å‘åˆä¸huiï¼Œç´¢æ€§é¼“æ£ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·</p>
</blockquote>
<a id="more"></a>
<p>æ•ˆæœå›¾ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/mypass.jpg" alt="mypass" style="zoom: 33%;"></p>
<p>åŠ å¯†/è§£å¯†ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyPass</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, file_passwd=<span class="string">'./passwd'</span>)</span>:</span></span><br><span class="line">        self.encrypt_head = bytes(<span class="string">'MYPASSWD_HEAD'</span>, encoding=<span class="string">"utf8"</span>)</span><br><span class="line">        self.secret = <span class="string">''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">decrypt</span><span class="params">(self, content, encode=False, decode=True)</span>:</span></span><br><span class="line">        <span class="string">""" bytes -&gt; str</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(self.secret) == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">"Warning: the secret is empty"</span>)</span><br><span class="line">        <span class="keyword">elif</span> decode <span class="keyword">and</span> <span class="keyword">not</span> content.startswith(self.encrypt_head):</span><br><span class="line">            print(<span class="string">"The content has already been decrypt"</span>)</span><br><span class="line">            <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line">        content = content[len(self.encrypt_head):]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> itertools <span class="keyword">import</span> cycle</span><br><span class="line">        result = bytes()</span><br><span class="line">        temp = cycle(self.secret)</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> content:</span><br><span class="line">            result += bytes(chr(ch ^ ord(next(temp))), encoding=<span class="string">"utf8"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result.decode(encoding=<span class="string">"utf8"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">encrypt</span><span class="params">(self, content, encode=True, decode=False)</span>:</span></span><br><span class="line">        <span class="string">""" bytes -&gt; bytes</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">if</span> len(self.secret) == <span class="number">0</span>:</span><br><span class="line">            print(<span class="string">"Warning: the secret is empty"</span>)</span><br><span class="line">        <span class="keyword">elif</span> encode <span class="keyword">and</span> content.startswith(self.encrypt_head):</span><br><span class="line">            print(<span class="string">"The content has already been encrypt"</span>)</span><br><span class="line">            <span class="keyword">return</span> content</span><br><span class="line"></span><br><span class="line">        <span class="keyword">from</span> itertools <span class="keyword">import</span> cycle</span><br><span class="line">        result = self.encrypt_head</span><br><span class="line">        temp = cycle(self.secret)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> bt <span class="keyword">in</span> content:</span><br><span class="line">            result += bytes(chr(bt ^ ord(next(temp))), encoding=<span class="string">"utf8"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br></pre></td></tr></table></figure>
<p><a href="/assets/files/mypass.py">é™„ä»¶ï¼šmypass.py</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘MySQLè°ƒä¼˜</title>
    <url>/2021/mysql-optimization/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="SQLè¯­å¥ä¼˜åŒ–"><a href="#SQLè¯­å¥ä¼˜åŒ–" class="headerlink" title="SQLè¯­å¥ä¼˜åŒ–"></a>SQLè¯­å¥ä¼˜åŒ–</h2><p><strong>ORDER BYï¼ŒGROUP BYå’ŒDISTINCTä¼˜åŒ–</strong></p>
<ul>
<li><p>ORDER BYçš„å®ç°ä¸ä¼˜åŒ–</p>
<ul>
<li>ä¼˜åŒ–Queryè¯­å¥ä¸­çš„ORDER BYçš„æ—¶å€™ï¼Œå°½å¯èƒ½åˆ©ç”¨å·²æœ‰çš„ç´¢å¼•æ¥é¿å…å®é™…çš„æ’åºè®¡ç®—ï¼Œå¯ä»¥å¾ˆå¤§å¹…åº¦çš„æå‡ORDER BYæ“ä½œçš„æ€§èƒ½ã€‚<a id="more"></a>
ä¼˜åŒ–æ’åºï¼š<br>1.åŠ å¤§max_length_for_sort_dataå‚æ•°çš„è®¾ç½®ï¼›<br>2.å»æ‰ä¸å¿…è¦çš„è¿”å›å­—æ®µï¼›<br>3.å¢å¤§sort_buffer_sizeå‚æ•°è®¾ç½®ï¼›</li>
</ul>
</li>
<li><p>GROUP BYçš„å®ç°ä¸ä¼˜åŒ–</p>
<ul>
<li>ç”±äºGROUP BYå®é™…ä¸Šä¹ŸåŒæ ·éœ€è¦è¿›è¡Œæ’åºæ“ä½œï¼Œè€Œä¸”ä¸ORDER BYç›¸æ¯”ï¼ŒGROUP BYä¸»è¦åªæ˜¯å¤šäº†æ’åºä¹‹åçš„åˆ†ç»„æ“ä½œã€‚å½“ç„¶ï¼Œå¦‚æœåœ¨åˆ†ç»„çš„æ—¶å€™è¿˜ä½¿ç”¨äº†å…¶ä»–çš„ä¸€äº›èšåˆå‡½æ•°ï¼Œé‚£ä¹ˆè¿˜éœ€è¦ä¸€äº›èšåˆå‡½æ•°çš„è®¡ç®—ã€‚æ‰€ä»¥ï¼Œåœ¨GROUP BYçš„å®ç°è¿‡ç¨‹ä¸­ï¼Œä¸ORDER BYä¸€æ ·ä¹Ÿå¯ä»¥åˆ©ç”¨åˆ°ç´¢å¼•ã€‚</li>
</ul>
</li>
<li><p>DISTINCTçš„å®ç°ä¸ä¼˜åŒ–</p>
<ul>
<li>DISTINCTå®é™…ä¸Šå’ŒGROUP BYçš„æ“ä½œéå¸¸ç›¸ä¼¼ï¼Œåªä¸è¿‡æ˜¯åœ¨GROUP BYä¹‹åçš„æ¯ç»„ä¸­åªå–å‡ºä¸€æ¡è®°å½•è€Œå·²ã€‚æ‰€ä»¥ï¼ŒDISTINCTçš„å®ç°å’ŒGROUP BYçš„å®ç°ä¹ŸåŸºæœ¬å·®ä¸å¤šï¼Œæ²¡æœ‰å¤ªå¤§çš„åŒºåˆ«ã€‚åŒæ ·å¯ä»¥é€šè¿‡æ¾æ•£ç´¢å¼•æ‰«ææˆ–è€…æ˜¯ç´§å‡‘ç´¢å¼•æ‰«ææ¥å®ç°ï¼Œå½“ç„¶ï¼Œåœ¨æ— æ³•ä»…ä»…ä½¿ç”¨ç´¢å¼•å³èƒ½å®ŒæˆDISTINCTçš„æ—¶å€™ï¼ŒMySQLåªèƒ½é€šè¿‡ä¸´æ—¶è¡¨æ¥å®Œæˆã€‚ä½†æ˜¯ï¼Œå’ŒGROUP BYæœ‰ä¸€ç‚¹å·®åˆ«çš„æ˜¯ï¼ŒDISTINCTå¹¶ä¸éœ€è¦è¿›è¡Œæ’åºã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ä»…ä»…åªæ˜¯DISTINCTæ“ä½œçš„Queryå¦‚æœæ— æ³•ä»…ä»…åˆ©ç”¨ç´¢å¼•å®Œæˆæ“ä½œçš„æ—¶å€™ï¼ŒMySQLä¼šåˆ©ç”¨ä¸´æ—¶è¡¨æ¥åšä¸€æ¬¡æ•°æ®çš„â€œç¼“å­˜â€ï¼Œä½†æ˜¯ä¸ä¼šå¯¹ä¸´æ—¶è¡¨ä¸­çš„æ•°æ®è¿›è¡Œfilesortæ“ä½œã€‚</li>
</ul>
</li>
</ul>
<p><strong>Joinè¯­å¥çš„ä¼˜åŒ–</strong></p>
<p>â€¦</p>
<h2 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h2><p><strong>Mysql8.0å·²å»æ‰æŸ¥è¯¢ç¼“å­˜</strong></p>
<p>æŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆéå¸¸é¢‘ç¹ï¼Œåªè¦æœ‰å¯¹ä¸€ä¸ªè¡¨çš„æ›´æ–°ï¼Œè¿™ä¸ªè¡¨ä¸Šæ‰€æœ‰çš„æŸ¥è¯¢ç¼“å­˜éƒ½ä¼šè¢«æ¸…ç©ºã€‚å› æ­¤å¾ˆå¯èƒ½ä½ è´¹åŠ²åœ°æŠŠç»“æœå­˜èµ·æ¥ï¼Œè¿˜æ²¡ä½¿ç”¨å‘¢ï¼Œå°±è¢«ä¸€ä¸ªæ›´æ–°å…¨æ¸…ç©ºäº†ã€‚å¯¹äºæ›´æ–°å‹åŠ›å¤§çš„æ•°æ®åº“æ¥è¯´ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ä¼šéå¸¸ä½ã€‚<strong>ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹å¯ç”¨æŸ¥è¯¢ç¼“å­˜å¼Šå¤§äºåˆ©</strong>ï¼Œé™¤éä½ çš„ä¸šåŠ¡å°±æ˜¯æœ‰ä¸€å¼ é™æ€è¡¨ï¼Œå¾ˆé•¿æ—¶é—´æ‰ä¼šæ›´æ–°ä¸€æ¬¡ã€‚</p>
<p>Mysqlç¼“å­˜ä¸»è¦åŒ…æ‹¬å…³é”®å­—ç¼“å­˜ï¼ˆkey cacheï¼‰å’ŒæŸ¥è¯¢ç¼“å­˜ï¼ˆquery cacheï¼‰</p>
<p>æŸ¥è¯¢ç¼“å­˜ä¼˜åŒ–</p>
<ul>
<li>å¯¹äºä¸€äº›ä¸å¸¸æ”¹å˜çš„æ•°æ®ä¸”æœ‰å¤§é‡ç›¸åŒsqlæŸ¥è¯¢çš„è¡¨ï¼ŒæŸ¥è¯¢ç¼“å­˜ä¼šèŠ‚çº¦å¾ˆå¤§çš„æ€§èƒ½</li>
<li>å¦‚æœç³»ç»Ÿç¡®å®å­˜åœ¨ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œå¯ä»¥å°è¯•æ‰“å¼€æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨æ•°æ®åº“è®¾è®¡ä¸Šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚ï¼š<br>1.ç”¨å¤šä¸ªå°è¡¨ä»£æ›¿ä¸€ä¸ªå¤§è¡¨ï¼Œæ³¨æ„ä¸è¦è¿‡åº¦è®¾è®¡<br>2.æ‰¹é‡æ’å…¥ä»£æ›¿å¾ªç¯å•æ¡æ’å…¥<br>3.åˆç†æ§åˆ¶ç¼“å­˜ç©ºé—´å¤§å°ï¼Œä¸€èˆ¬æ¥è¯´å…¶å¤§å°è®¾ç½®ä¸ºå‡ åå…†æ¯”è¾ƒåˆé€‚<br>4.å¯ä»¥é€šè¿‡SQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜</li>
<li>show status like â€˜%qcache_hits%â€™;</li>
<li><p>é…ç½®æŸ¥è¯¢ç¼“å­˜</p>
<ul>
<li>query_cache_typeå¯ä»¥æ˜¯0,1,2ï¼Œ0ä»£è¡¨ä¸ä½¿ç”¨ç¼“å­˜ï¼Œ1ä»£è¡¨ä½¿ç”¨ç¼“å­˜ï¼Œ2ä»£è¡¨æ ¹æ®éœ€è¦ä½¿ç”¨<br>query_cache_size<br>query_cache_limit<ul>
<li>query_cache_type=1<br>query_cache_size=67108864<br>query_cache_limit=67108864</li>
</ul>
</li>
</ul>
</li>
<li><p>MySqlä¸­å¯ä»¥åœ¨SQLä¸­æŒ‡å®šSQL_CACHEå’ŒSQL_NO_CACHEæ¥æ§åˆ¶æŸä¸ªæŸ¥è¯¢è¯­å¥æ˜¯å¦éœ€è¦è¿›è¡Œç¼“å­˜</p>
<ul>
<li>select SQL_NO_CACHE * from â€¦   ä¸èµ°ç¼“å­˜ï¼Œä¸æŸ¥è¯¢ç¼“å­˜ï¼Œä¹Ÿä¸å†™å…¥ç¼“å­˜</li>
</ul>
</li>
<li>Query Cache å‘½ä¸­ç‡= Qcache_hits / ( Qcache_hits + Qcache_inserts )ï¼›</li>
</ul>
<h2 id="åˆ†åº“åˆ†è¡¨"><a href="#åˆ†åº“åˆ†è¡¨" class="headerlink" title="åˆ†åº“åˆ†è¡¨"></a>åˆ†åº“åˆ†è¡¨</h2><p>å‚ç›´ï¼Œæ°´å¹³åˆ†åº“åˆ†è¡¨ â€¦</p>
<h2 id="ä½¿ç”¨redisæˆ–memcache"><a href="#ä½¿ç”¨redisæˆ–memcache" class="headerlink" title="ä½¿ç”¨redisæˆ–memcache"></a>ä½¿ç”¨redisæˆ–memcache</h2><p>1.è·å¾—æ•°æ® 2.å¤„ç†æ•°æ® 3.ç¼“å­˜æ•°æ® 4.è¯»å–ç¼“å­˜æ•°æ®</p>
<p>Mysql Query Cacheæ²¡æœ‰æ¥å£æ”¾å®šåˆ¶æ•°æ®ï¼ˆ2ï¼Œ3ï¼‰ï¼Œåªèƒ½æ”¾æœç´¢ç»“æœé›†ï¼Œåªæ˜¯å¯¹1çš„ä¼˜åŒ–ï¼Œåœ¨å…·ä½“ä¸šåŠ¡åœºæ™¯é‡Œæ²¡æœ‰å¯ç”¨æ€§ï¼›Memcacheé‡Œå¯ä»¥æ”¾ä»»æ„ç»“æ„çš„ä¸šåŠ¡æ•°æ®ï¼›å› æ­¤ç¨‹åºå‘˜å¯ä»¥é€šè¿‡åˆç†åœ°è®¾è®¡ï¼Œæå‡cacheçš„ä½¿ç”¨æ•ˆç‡</p>
<h2 id="OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç†-On-Line-Transaction-Processingï¼‰åœºæ™¯"><a href="#OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç†-On-Line-Transaction-Processingï¼‰åœºæ™¯" class="headerlink" title="OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç† On-Line Transaction Processingï¼‰åœºæ™¯"></a>OLTPï¼ˆè”æœºäº‹åŠ¡å¤„ç† On-Line Transaction Processingï¼‰åœºæ™¯</h2><p>å¹¶å‘é‡å¤§ï¼Œæ•´ä½“æ•°æ®é‡æ¯”è¾ƒå¤šï¼Œä½†æ¯æ¬¡è®¿é—®çš„æ•°æ®æ¯”è¾ƒå°‘ï¼Œä¸”è®¿é—®çš„æ•°æ®æ¯”è¾ƒç¦»æ•£ï¼Œæ´»è·ƒæ•°æ®å æ€»ä½“æ•°æ®çš„æ¯”ä¾‹ä¸æ˜¯å¤ªå¤§</p>
<h2 id="OLAPï¼ˆè”æœºåˆ†æå¤„ç†-On-Line-Analytical-Processingï¼‰åœºæ™¯"><a href="#OLAPï¼ˆè”æœºåˆ†æå¤„ç†-On-Line-Analytical-Processingï¼‰åœºæ™¯" class="headerlink" title="OLAPï¼ˆè”æœºåˆ†æå¤„ç† On-Line Analytical Processingï¼‰åœºæ™¯"></a>OLAPï¼ˆè”æœºåˆ†æå¤„ç† On-Line Analytical Processingï¼‰åœºæ™¯</h2><p>æ•°æ®é‡éå¸¸å¤§ï¼Œå¹¶å‘è®¿é—®ä¸å¤šï¼Œä½†æ¯æ¬¡è®¿é—®æ‰€éœ€è¦æ£€ç´¢çš„æ•°æ®é‡éƒ½æ¯”è¾ƒå¤šï¼Œè€Œä¸”æ•°æ®è®¿é—®ç›¸å¯¹è¾ƒä¸ºé›†ä¸­ï¼Œæ²¡æœ‰å¤ªæ˜æ˜¾çš„æ´»è·ƒæ•°æ®æ¦‚å¿µ</p>
<p>å¹¶å‘å¤§ï¼Œcpuè¦å¥½<br>å†…å­˜è¦å¤§ä¸€äº›ï¼Œä»¥ç¼“å­˜æ›´å¤šæ´»è·ƒçš„æ•°æ®<br>ç£ç›˜iopsè¦å¥½ï¼Œååèƒ½åŠ›å…¶æ¬¡<br>ç½‘ç»œäº¤äº’éå¸¸é¢‘ç¹</p>
<p>OLTPè´Ÿè´£åŸºæœ¬ä¸šåŠ¡çš„æ­£å¸¸è¿è½¬ï¼Œè€Œä¸šåŠ¡æ•°æ®ç§¯ç´¯æ—¶æ‰€äº§ç”Ÿçš„ä»·å€¼ä¿¡æ¯åˆ™è¢«OLAPä¸æ–­å‘ˆç°ï¼Œä¼ä¸šé«˜å±‚é€šè¿‡å‚è€ƒè¿™äº›ä¿¡æ¯ä¼šä¸æ–­è°ƒæ•´ç»è¥æ–¹é’ˆï¼Œä¹Ÿä¼šä¿ƒè¿›åŸºç¡€ä¸šåŠ¡çš„ä¸æ–­ä¼˜åŒ–</p>
<h1 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h1><p><strong>éš”ç¦»çº§åˆ«</strong></p>
<ul>
<li>READ_UNCOMMITTED</li>
<li>READ_COMMITED</li>
<li>REPEATABLE_READ</li>
<li>SERLALIZABLE</li>
</ul>
<p><strong>ç‰¹ç‚¹</strong></p>
<ul>
<li>åŸå­æ€§</li>
<li>ä¸€è‡´æ€§</li>
<li>éš”ç¦»æ€§</li>
<li>æŒä¹…æ€§</li>
</ul>
<p><strong>å¹¶å‘é—®é¢˜</strong></p>
<ul>
<li>ç¬¬ä¸€ç±»æ›´æ–°</li>
<li>ç¬¬äºŒç±»æ›´æ–°</li>
<li>è„è¯»</li>
<li>ä¸å¯é‡å¤è¯»</li>
<li>å¹»è¯»</li>
</ul>
<p><strong>1ã€è„è¯»</strong></p>
<p>æ‰€è°“è„è¯»ï¼Œå°±æ˜¯æŒ‡äº‹åŠ¡Aè¯»åˆ°äº†äº‹åŠ¡Bè¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ï¼Œæ¯”å¦‚é“¶è¡Œå–é’±ï¼Œäº‹åŠ¡Aå¼€å¯äº‹åŠ¡ï¼Œæ­¤æ—¶åˆ‡æ¢åˆ°äº‹åŠ¡Bï¼Œäº‹åŠ¡Bå¼€å¯äº‹åŠ¡â€“&gt;å–èµ°100å…ƒï¼Œæ­¤æ—¶åˆ‡æ¢å›äº‹åŠ¡Aï¼Œäº‹åŠ¡Aè¯»å–çš„è‚¯å®šæ˜¯æ•°æ®åº“é‡Œé¢çš„åŸå§‹æ•°æ®ï¼Œå› ä¸ºäº‹åŠ¡Bå–èµ°äº†100å—é’±ï¼Œå¹¶æ²¡æœ‰æäº¤ï¼Œæ•°æ®åº“é‡Œé¢çš„è´¦åŠ¡ä½™é¢è‚¯å®šè¿˜æ˜¯åŸå§‹ä½™é¢ï¼Œè¿™å°±æ˜¯è„è¯»ã€‚</p>
<p><strong>2ã€ä¸å¯é‡å¤è¯»</strong></p>
<p>æ‰€è°“ä¸å¯é‡å¤è¯»ï¼Œå°±æ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œé¢è¯»å–äº†ä¸¤æ¬¡æŸä¸ªæ•°æ®ï¼Œè¯»å‡ºæ¥çš„æ•°æ®ä¸ä¸€è‡´ã€‚è¿˜æ˜¯ä»¥é“¶è¡Œå–é’±ä¸ºä¾‹ï¼Œäº‹åŠ¡Aå¼€å¯äº‹åŠ¡â€“&gt;æŸ¥å‡ºé“¶è¡Œå¡ä½™é¢ä¸º1000å…ƒï¼Œæ­¤æ—¶åˆ‡æ¢åˆ°äº‹åŠ¡Bäº‹åŠ¡Bå¼€å¯äº‹åŠ¡â€“&gt;äº‹åŠ¡Bå–èµ°100å…ƒâ€“&gt;æäº¤ï¼Œæ•°æ®åº“é‡Œé¢ä½™é¢å˜ä¸º900å…ƒï¼Œæ­¤æ—¶åˆ‡æ¢å›äº‹åŠ¡Aï¼Œäº‹åŠ¡Aå†æŸ¥ä¸€æ¬¡æŸ¥å‡ºè´¦æˆ·ä½™é¢ä¸º900å…ƒï¼Œè¿™æ ·å¯¹äº‹åŠ¡Aè€Œè¨€ï¼Œåœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…ä¸¤æ¬¡è¯»å–è´¦æˆ·ä½™é¢æ•°æ®ä¸ä¸€è‡´ï¼Œè¿™å°±æ˜¯ä¸å¯é‡å¤è¯»ã€‚</p>
<p><strong>3ã€å¹»è¯»</strong></p>
<p>æ‰€è°“å¹»è¯»ï¼Œå°±æ˜¯æŒ‡åœ¨ä¸€ä¸ªäº‹åŠ¡é‡Œé¢çš„æ“ä½œä¸­å‘ç°äº†æœªè¢«æ“ä½œçš„æ•°æ®ã€‚æ¯”å¦‚å­¦ç”Ÿä¿¡æ¯ï¼Œäº‹åŠ¡Aå¼€å¯äº‹åŠ¡â€“&gt;ä¿®æ”¹æ‰€æœ‰å­¦ç”Ÿå½“å¤©ç­¾åˆ°çŠ¶å†µä¸ºfalseï¼Œæ­¤æ—¶åˆ‡æ¢åˆ°äº‹åŠ¡Bï¼Œäº‹åŠ¡Bå¼€å¯äº‹åŠ¡â€“&gt;äº‹åŠ¡Bæ’å…¥äº†ä¸€æ¡å­¦ç”Ÿæ•°æ®ï¼Œæ­¤æ—¶åˆ‡æ¢å›äº‹åŠ¡Aï¼Œäº‹åŠ¡Aæäº¤çš„æ—¶å€™å‘ç°äº†ä¸€æ¡è‡ªå·±æ²¡æœ‰ä¿®æ”¹è¿‡çš„æ•°æ®ï¼Œè¿™å°±æ˜¯å¹»è¯»ï¼Œå°±å¥½åƒå‘ç”Ÿäº†å¹»è§‰ä¸€æ ·ã€‚å¹»è¯»å‡ºç°çš„å‰ææ˜¯å¹¶å‘çš„äº‹åŠ¡ä¸­æœ‰äº‹åŠ¡å‘ç”Ÿäº†æ’å…¥ã€åˆ é™¤æ“ä½œã€‚</p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>HJ-03</title>
    <url>/2021/py-coding-2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æ±‚è´¨å› å­"><a href="#æ±‚è´¨å› å­" class="headerlink" title="æ±‚è´¨å› å­"></a>æ±‚è´¨å› å­</h2><blockquote>
<p>é¢˜ç›®ï¼šè¾“å…¥ä¸€ä¸ªæ­£æ•´æ•°ï¼ŒæŒ‰ç…§ä»å°åˆ°å¤§çš„é¡ºåºè¾“å‡ºå®ƒçš„æ‰€æœ‰è´¨å› å­ï¼ˆé‡å¤çš„ä¹Ÿè¦åˆ—ä¸¾ï¼Œå¦‚180çš„è´¨å› å­ä¸º2 2 3 3 5 ï¼‰</p>
</blockquote>
<a id="more"></a>
<p>é€’å½’æ‹†è§£ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">ä»¥180ä¸ºä¾‹ï¼Œå› å­åˆ—è¡¨ä¼šä¾æ¬¡å˜åŒ–å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="string">[180]</span></span><br><span class="line"><span class="string">[2, 90]</span></span><br><span class="line"><span class="string">[2, 2, 45]</span></span><br><span class="line"><span class="string">[2, 2, 3, 15]</span></span><br><span class="line"><span class="string">[2, 2, 3, 3, 5]  # ä¸å¯ç»§ç»­æ‹†è§£äº†ï¼Œæ­¤æ—¶å°±æ˜¯è´¨å› å­åˆ—è¡¨</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> range(x, len(a)):</span><br><span class="line">        v = a[k]</span><br><span class="line">        flag = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">2</span>, int(v ** <span class="number">0.5</span> + <span class="number">1</span>)):</span><br><span class="line">            <span class="keyword">if</span> v % i == <span class="number">0</span>:</span><br><span class="line">                flag = <span class="literal">True</span></span><br><span class="line">                a.pop(k)</span><br><span class="line">                a.append(i)</span><br><span class="line">                v /= i</span><br><span class="line">                <span class="keyword">if</span> v &gt; <span class="number">1</span>:</span><br><span class="line">                    a.append(v)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> flag:</span><br><span class="line">            f(k + <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">m = int(raw_input())</span><br><span class="line">a = [m]</span><br><span class="line">f(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> a:</span><br><span class="line">    <span class="keyword">print</span> i,</span><br></pre></td></tr></table></figure>
<p>ç‰¹åˆ«è§£æ³•ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">èƒ½è¢«2ï¼Œ3ï¼Œ5 ... æ•´é™¤åˆ™printï¼Œæ¥ç€ä»¥ã€å•†ã€‘é€’å½’ã€‚æ³¨æ„breakçš„ä½ç½®ï¼</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prime</span><span class="params">(a)</span>:</span></span><br><span class="line">    mark = <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>, int(a ** <span class="number">0.5</span> + <span class="number">2</span>)):</span><br><span class="line">        <span class="keyword">if</span> a % i == <span class="number">0</span>:</span><br><span class="line">            mark = <span class="number">0</span></span><br><span class="line">            <span class="keyword">print</span> i,</span><br><span class="line">            b = int(a / i)</span><br><span class="line">            prime(b)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> mark == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">print</span> a,</span><br><span class="line"></span><br><span class="line">prime(int(input()))</span><br></pre></td></tr></table></figure>
<p>ç”¨å¾ªç¯æ›¿ä»£é€’å½’ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_result</span><span class="params">(num)</span>:</span></span><br><span class="line">    end = int(math.sqrt(num))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">2</span>, end+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">while</span> num % i == <span class="number">0</span>:</span><br><span class="line">            print(i, end=<span class="string">" "</span>)</span><br><span class="line">            num /= i</span><br><span class="line">            flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> num != <span class="number">1</span>:</span><br><span class="line">        print(num, end=<span class="string">" "</span>)</span><br><span class="line"></span><br><span class="line">a = raw_input()</span><br><span class="line">get_result(int(a))</span><br></pre></td></tr></table></figure>
<h2 id="åŠ¨æ€è§„åˆ’"><a href="#åŠ¨æ€è§„åˆ’" class="headerlink" title="åŠ¨æ€è§„åˆ’"></a>åŠ¨æ€è§„åˆ’</h2><blockquote>
<p>é¢˜ç›®ï¼šè´­ç‰©å•é—®é¢˜</p>
<p>å¦‚æœè¦ä¹°å½’ç±»ä¸ºé™„ä»¶çš„ç‰©å“ï¼Œå¿…é¡»å…ˆä¹°è¯¥é™„ä»¶æ‰€å±çš„ä¸»ä»¶ï¼›<br>æ¯ä¸ªä¸»ä»¶å¯ä»¥æœ‰ 0 ä¸ªã€ 1 ä¸ªæˆ– 2 ä¸ªé™„ä»¶ï¼›<br>é™„ä»¶ä¸å†æœ‰ä»å±äºè‡ªå·±çš„é™„ä»¶ï¼›<br>æ¯ä»¶ç‰©å“è§„å®šäº†ä¸€ä¸ªé‡è¦åº¦ï¼Œåˆ†ä¸º 5 ç­‰ï¼šç”¨æ•´æ•° 1 <strong>~</strong> 5 è¡¨ç¤ºï¼Œç¬¬ 5 ç­‰æœ€é‡è¦ï¼›<br>æ¯ä»¶ç‰©å“çš„ä»·æ ¼éƒ½æ˜¯10å…ƒçš„æ•´æ•°å€ï¼›<br>å¸Œæœ›åœ¨ä¸è¶…è¿‡ N å…ƒï¼ˆå¯ä»¥ç­‰äº N å…ƒï¼‰çš„å‰æä¸‹ï¼Œä½¿æ¯ä»¶ç‰©å“çš„ä»·æ ¼ä¸é‡è¦åº¦çš„ä¹˜ç§¯çš„æ€»å’Œæœ€å¤§ã€‚<br>æ±‚è¿™ä¸ªæœ€å¤§å€¼ã€‚</p>
</blockquote>
<p>å‚è€ƒè§£æ³•ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">ç¤ºä¾‹è¾“å…¥ï¼š</span></span><br><span class="line"><span class="string">1000 5</span></span><br><span class="line"><span class="string">800 2 0</span></span><br><span class="line"><span class="string">400 5 1</span></span><br><span class="line"><span class="string">300 5 1</span></span><br><span class="line"><span class="string">400 3 0</span></span><br><span class="line"><span class="string">500 2 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¾“å‡ºï¼š</span></span><br><span class="line"><span class="string">2200</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯´æ˜ï¼š</span></span><br><span class="line"><span class="string">1000 5 ä¸­1000æ˜¯æ€»é¢„ç®—ï¼Œ5è¡¨ç¤ºä¸‹é¢åˆ—å‡º5ä»¶å€™é€‰å•†å“</span></span><br><span class="line"><span class="string">æ¥ä¸‹çš„ç¬¬ä¸€è¡Œï¼š800 2 0 è¡¨ç¤ºç¬¬ä¸€ä»¶æ˜¯ä¸»ä»¶ï¼ˆ0ï¼‰ï¼Œé‡è¦åº¦2ï¼Œä»·æ ¼800</span></span><br><span class="line"><span class="string">ç¬¬äºŒè¡Œï¼š400 5 1 è¡¨ç¤ºç¬¬äºŒä»¶æ˜¯é™„ä»¶ï¼ˆé0ï¼‰ï¼Œä¸”æ˜¯ç¬¬ä¸€ä»¶ï¼ˆ1ï¼‰çš„é™„ä»¶ï¼Œé‡è¦åº¦5ï¼Œä»·æ ¼400</span></span><br><span class="line"><span class="string">ä»¥ä¸‹ç±»æ¨</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">n, m = map(int, raw_input().split())</span><br><span class="line">pri, anex = &#123;&#125;, &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, m + <span class="number">1</span>):</span><br><span class="line">    v, p, q = map(int, raw_input().split())</span><br><span class="line">    <span class="keyword">if</span> q == <span class="number">0</span>:</span><br><span class="line">        pri[i] = [v, p]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">if</span> q <span class="keyword">in</span> anex:</span><br><span class="line">            anex[q].append([v, p])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            anex[q] = [[v, p]]</span><br><span class="line">            </span><br><span class="line">dp = [<span class="number">0</span>] * (n + <span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> key <span class="keyword">in</span> pri:  <span class="comment"># å¯¹äºæ¯ä¸€ä¸ªä¸»ä»¶</span></span><br><span class="line">    w, v = [], []  <span class="comment"># è®¡ç®— è¯¥ä¸»ä»¶+é™„ä»¶ å„ç§ç»„åˆçš„w,v</span></span><br><span class="line">    w.append(pri[key][<span class="number">0</span>])  <span class="comment"># ä»…ä¸»ä»¶</span></span><br><span class="line">    v.append(pri[key][<span class="number">0</span>] * pri[key][<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> key <span class="keyword">in</span> anex:</span><br><span class="line">        w.append(w[<span class="number">0</span>] + anex[key][<span class="number">0</span>][<span class="number">0</span>])  <span class="comment"># ä¸»ä»¶+é™„ä»¶1 çš„ä»·æ ¼</span></span><br><span class="line">        v.append(v[<span class="number">0</span>] + anex[key][<span class="number">0</span>][<span class="number">0</span>] * anex[key][<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">        <span class="keyword">if</span> len(anex[key]) &gt;= <span class="number">2</span>:</span><br><span class="line">            w.append(w[<span class="number">0</span>] + anex[key][<span class="number">1</span>][<span class="number">0</span>])  <span class="comment"># ä¸»ä»¶+é™„ä»¶2</span></span><br><span class="line">            v.append(v[<span class="number">0</span>] + anex[key][<span class="number">1</span>][<span class="number">0</span>] * anex[key][<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">            w.append(w[<span class="number">0</span>] + anex[key][<span class="number">0</span>][<span class="number">0</span>] + anex[key][<span class="number">1</span>][<span class="number">0</span>])  <span class="comment"># ä¸»ä»¶+é™„ä»¶1+é™„ä»¶2</span></span><br><span class="line">            v.append(v[<span class="number">0</span>] + anex[key][<span class="number">0</span>][<span class="number">0</span>] * anex[key][<span class="number">0</span>][<span class="number">1</span>] + anex[key][<span class="number">1</span>][<span class="number">0</span>] * anex[key][<span class="number">1</span>][<span class="number">1</span>])</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(n, <span class="number">-1</span>, <span class="number">-10</span>):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> range(len(w)):</span><br><span class="line">            <span class="comment"># å¦‚æœå¤Ÿä¹°ç¬¬kç»„åˆï¼Œå½“å‰é‡‘é¢dp å’Œ å‰©ä½™é‡‘é¢dp+æœ¬ç»„åˆv å¤§è€…æ›´æ–°ä¸ºå½“å‰dp</span></span><br><span class="line">            <span class="keyword">if</span> j - w[k] &gt;= <span class="number">0</span>:</span><br><span class="line">                dp[j] = max(dp[j], dp[j - w[k]] + v[k])</span><br><span class="line">                </span><br><span class="line"><span class="keyword">print</span> dp[n]</span><br></pre></td></tr></table></figure>
<h2 id="èµ°æ–¹æ ¼"><a href="#èµ°æ–¹æ ¼" class="headerlink" title="èµ°æ–¹æ ¼"></a>èµ°æ–¹æ ¼</h2><blockquote>
<p>é¢˜ç›®ï¼šè®¡ç®—n*mçš„æ£‹ç›˜æ ¼å­ï¼ˆnä¸ºæ¨ªå‘çš„æ ¼å­æ•°ï¼Œmä¸ºç«–å‘çš„æ ¼å­æ•°ï¼Œm&lt;=8ï¼‰ä»æ£‹ç›˜å·¦ä¸Šè§’å‡ºå‘æ²¿ç€è¾¹ç¼˜çº¿ä»å·¦ä¸Šè§’èµ°åˆ°å³ä¸‹è§’ï¼Œæ€»å…±æœ‰å¤šå°‘ç§èµ°æ³•ï¼Œè¦æ±‚ä¸èƒ½èµ°å›å¤´è·¯ï¼Œå³ï¼šåªèƒ½å¾€å³å’Œå¾€ä¸‹èµ°ï¼Œä¸èƒ½å¾€å·¦å’Œå¾€ä¸Šèµ°ã€‚</p>
<p>æ³¨ï¼šæ²¿æ£‹ç›˜æ ¼ä¹‹é—´çš„è¾¹ç¼˜çº¿è¡Œèµ°</p>
</blockquote>
<p>é€’å½’æ³•ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">p_mn</span><span class="params">(m, n)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> m == <span class="number">1</span> <span class="keyword">or</span> n == <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> m + n</span><br><span class="line">    <span class="keyword">return</span> p_mn(m - <span class="number">1</span>, n) + p_mn(m, n - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">m, n = map(int, raw_input().split())</span><br><span class="line"><span class="keyword">if</span> m &gt; <span class="number">8</span>:</span><br><span class="line">    <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> p_mn(m, n)</span><br></pre></td></tr></table></figure>
<p>å…¬å¼æ³•ï¼ˆé˜¶ä¹˜ï¼‰ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> factorial <span class="keyword">as</span> f</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        n, m = map(int, raw_input().split())</span><br><span class="line">        <span class="keyword">print</span> f(n + m) / (f(m) * f(n))</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸çŸ¥é“ä»mathå¯¼å…¥ï¼Œå¯è‡ªå®šä¹‰é˜¶ä¹˜å‡½æ•°ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">factorial</span><span class="params">(n)</span>:</span></span><br><span class="line">    ans = <span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n:</span><br><span class="line">        ans *= n</span><br><span class="line">        n -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> ans</span><br></pre></td></tr></table></figure>
<p>å¦‚ä½•è¯æ˜å¯ä»¥æŒ‰è¿™ä¸ªå…¬å¼ï¼Ÿçœ‹èµ·æ¥åƒæ˜¯æ’åˆ—ç»„åˆæˆ–æ¦‚ç‡ç»Ÿè®¡çš„é—®é¢˜ã€‚<br>f(n+m)æ˜¯æ—¢ä¸è€ƒè™‘é¡ºåºï¼Œåˆä¸è€ƒè™‘æ–¹å‘çš„æ’åˆ—æ•°ï¼Œf(m)å’Œf(n)åˆ†åˆ«æ˜¯ç«–å‘ã€æ¨ªå‘ä¸è€ƒè™‘é¡ºåºçš„æ’åˆ—æ•°ã€‚</p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘MySQLé—®é¢˜</title>
    <url>/2021/mysql-questions/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="ä¸»ä»å»¶è¿Ÿ"><a href="#ä¸»ä»å»¶è¿Ÿ" class="headerlink" title="ä¸»ä»å»¶è¿Ÿ"></a>ä¸»ä»å»¶è¿Ÿ</h2><p>ä¸»ä»å¤åˆ¶ä¸­æœ‰ä¸¤ä¸ªå¾ˆé‡è¦çš„æ—¥å¿—æ–‡ä»¶ï¼Œbinlogå’Œrelay logï¼Œåˆ†åˆ«ä½äºä¸»åº“ä¸ä»åº“ä¸­ã€‚å…¶ä¸­ binlog æ˜¯ä¸»ä»å¤åˆ¶çš„åŸºç¡€ï¼Œé€šè¿‡å°†æ“ä½œäº‹ä»¶å†™å…¥ binlog é€šè¿‡ I/O çº¿ç¨‹ä¼ é€è‡³ä»åº“è¿›è¡ŒåŒæ­¥ã€‚</p>
<p>ä¸»ä»å»¶è¿Ÿå¯èƒ½çš„åŸå› ï¼š</p>
<ul>
<li>ä»åº“ä¸­ SQL çº¿ç¨‹é‡æ”¾çš„è¿‡ç¨‹æ˜¯éšæœºå†™ç›˜çš„ï¼Œå¹¶ä¸” SQL çº¿ç¨‹æ˜¯å•çº¿ç¨‹çš„ï¼Œå› æ­¤æ•°æ®æ¥ä¸åŠé‡æ”¾çš„è¯å°±ä¼šå¯¼è‡´ä¸»ä»å»¶è¿Ÿã€‚</li>
<li><strong>ä¸»åº“å¹¶å‘é«˜</strong>ä¼šå¯¼è‡´å†™æ“ä½œä¸æ–­å†™å…¥ binlogï¼Œå¯¹äº SQL çº¿ç¨‹è¯´å¯èƒ½ä¼šåº”æ¥ä¸æš‡ï¼Œä¹Ÿä¼šäº§ç”Ÿä¸»ä»å»¶è¿Ÿã€‚</li>
<li>é‡æ”¾è¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°<strong>é”ç­‰å¾…</strong>ä¹Ÿæ˜¯äº§ç”Ÿå»¶è¿Ÿçš„åŸå› ä¹‹ä¸€ã€‚</li>
</ul>
<a id="more"></a>
<p>ä¸€äº›å¤„ç†æ–¹æ³•ï¼š</p>
<p><strong>1. å¹¶è¡Œå¤åˆ¶</strong><br>MySQL 5.6 ç‰ˆæœ¬åï¼Œæä¾›äº†ä¸€ç§å¹¶è¡Œå¤åˆ¶çš„æ–¹å¼ï¼Œé€šè¿‡å°† SQL çº¿ç¨‹è½¬æ¢ä¸ºå¤šä¸ª work çº¿ç¨‹æ¥è¿›è¡Œé‡æ”¾</p>
<p><strong>2. é™ä½ä¸»åº“å†™å¹¶å‘ï¼Œé™ä½ä»åº“è¯»å¹¶å‘</strong><br>é€šè¿‡<strong>é™æµ</strong>æªæ–½é™ä½è¯»å¹¶å‘ã€å†™å¹¶å‘<br>ä½¿ç”¨redisé™ä½è¯»ä»åº“çš„å‹åŠ›</p>
<p><strong>3. è¯»ä¸»åº“</strong><br>é…ç½®ä¸»åº“å¯å†™å¯è¯»</p>
<hr>
<h2 id="ä¸»åº“æŸ¥è¯¢æ›´æ–°å—ä¸»ä»å¤åˆ¶çš„å½±å“"><a href="#ä¸»åº“æŸ¥è¯¢æ›´æ–°å—ä¸»ä»å¤åˆ¶çš„å½±å“" class="headerlink" title="ä¸»åº“æŸ¥è¯¢æ›´æ–°å—ä¸»ä»å¤åˆ¶çš„å½±å“"></a>ä¸»åº“æŸ¥è¯¢æ›´æ–°å—ä¸»ä»å¤åˆ¶çš„å½±å“</h2><p>æ–°å»ºå¤‡åº“çº§è”åˆ°ä¸»åº“ä¼šå°†ä¸»åº“ä¸Šå¤§é‡çš„binlogæ‹‰åˆ°æœ¬åœ°ä¿å­˜ä¸ºrelaylogï¼Œè¿™ä¸ªé˜¶æ®µä¼šå¯¼è‡´ä¸»åº“ç½‘ç»œæµé‡éå¸¸å¤§ï¼Œä»è€Œå¼•å‘ä¸»åº“çš„æŸ¥è¯¢æ›´æ–°ç­‰å—åˆ°å½±å“ã€‚</p>
<p>æ–°å»ºslaveè¿åˆ°masteræ—¶ï¼Œä¼šå°†ä¸»åº“ä¸Šå¤§é‡çš„binlogï¼ˆå‡ ç™¾Gï¼‰æ‹‰å–åˆ°æœ¬åœ°ä¿å­˜ä¸ºrelay logï¼Œä¼šå¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>ä¸»åº“ç½‘ç»œå¸¦å®½è¢«å æ»¡ </li>
<li>ä¸»åº“çš„ç£ç›˜I/Oè´Ÿè½½å¾ˆé«˜</li>
</ul>
<p>è§£å†³æ€è·¯ï¼š<br><strong>1. åœ¨å¤‡åº“æ‹‰ä¸»åº“binlogçš„IOçº¿ç¨‹ä¸Šåšé™æµï¼Œæ¯æ‹‰ä¸€å®šæ•°æ®é‡Mçš„binlogåˆ™sleepæ—¶é—´N</strong><br>è¿™ä¸ªæµ‹è¯•æ•ˆæœæ¯”è¾ƒæ˜æ˜¾ï¼Œä½†å­˜åœ¨å¦‚ä¸‹å‡ ä¸ªé—®é¢˜ï¼š</p>
<ul>
<li>å‚æ•°æ¯”è¾ƒéš¾æ§åˆ¶ éœ€è¦DBAæ ¹æ®å®é™…åœºæ™¯è°ƒæ•´æ¥è·å¾—é¢„æœŸçš„ç½‘ç»œæµé‡ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯èƒ½éœ€è¦å¤šæ¬¡å°è¯•æ‰å¯èƒ½è·å–åˆ°é¢„æœŸè¡Œä¸º</li>
<li>å­˜åœ¨æŠ–åŠ¨ åœ¨sleepæ—¶åˆ»æ˜æ˜¾èƒ½è§‚å¯Ÿåˆ°ä¸å‡åŒ€çš„ç½‘ç»œæµé‡</li>
</ul>
<p><strong>2. åœ¨socketçš„é€‰å‹ä¸Šåšæ”¹è¿›</strong></p>
<p><strong>3.è€ƒè™‘åˆ°ç“¶é¢ˆåœ¨ç½‘ç»œå¸¦å®½å’Œç£ç›˜I/Oä¸Šï¼Œå¯ä»¥æ”¹è¿›æ¶æ„ï¼Œæ”¹ä¸ºslaveçº§è”çš„æ¶æ„ï¼Œä½†æ˜¯ç»´æŠ¤çš„æˆæœ¬ä¼šç›¸åº”å¢åŠ ï¼Œéœ€è¦æƒè¡¡åœºæ™¯ã€‚</strong></p>
<p><strong>4.è€ƒè™‘ä½¿ç”¨SSD</strong></p>
<p><em>åŸæ–‡ï¼š<a href="https://blog.51cto.com/laoxu/1413257" rel="external nofollow noopener noreferrer" target="_blank">https://blog.51cto.com/laoxu/1413257</a></em></p>
<hr>
<h2 id="MySQLè¯»å†™åˆ†ç¦»ï¼šå¦‚ä½•è§£å†³å†™å®Œè¯»ä¸åˆ°é—®é¢˜"><a href="#MySQLè¯»å†™åˆ†ç¦»ï¼šå¦‚ä½•è§£å†³å†™å®Œè¯»ä¸åˆ°é—®é¢˜" class="headerlink" title="MySQLè¯»å†™åˆ†ç¦»ï¼šå¦‚ä½•è§£å†³å†™å®Œè¯»ä¸åˆ°é—®é¢˜"></a>MySQLè¯»å†™åˆ†ç¦»ï¼šå¦‚ä½•è§£å†³å†™å®Œè¯»ä¸åˆ°é—®é¢˜</h2><p>MySQLç»å…¸çš„<strong>ä¸€ä¸»ä¸¤ä»</strong>æ˜¯å¤§å¤šæ•°åˆ›ä¸šå…¬å¸åˆæœŸä½¿ç”¨çš„ä¸»æµæ•°æ®å­˜å‚¨æ–¹æ¡ˆä¹‹ä¸€ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/mysql-questions.assets/image-20211010012130423.png" alt="image-20211010012130423" style="zoom:80%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/mysql-questions.assets/image-20211010012615624.png" alt="image-20211010012615624" style="zoom:80%;"></p>
<p>ä¸Šå›¾æ˜¯é»˜è®¤çš„<strong>å¼‚æ­¥åŒæ­¥æ¨¡å¼</strong>ï¼Œæˆ‘ä»¬å‘ç°ï¼Œä»ä¸»èŠ‚ç‚¹æäº¤æˆåŠŸåˆ°ä»èŠ‚ç‚¹åŒæ­¥å®Œæˆï¼Œä¸­é—´é—´éš”äº†6ã€7ã€8ã€9ã€10å¤šä¸ªæ­¥éª¤ï¼Œæ¶‰åŠåˆ°ä¸€æ¬¡ç½‘ç»œä¼ è¾“ï¼Œå¤šæ¬¡æ–‡ä»¶è¯»å–å’Œå†™å…¥çš„ç£ç›˜ IO æ“ä½œï¼Œä»¥åŠæœ€åçš„ SQL æ‰§è¡Œçš„ CPU æ“ä½œã€‚</p>
<p>æ‰€ä»¥ï¼Œå½“ä¸»ä»èŠ‚ç‚¹é—´ç½‘ç»œä¼ è¾“å‡ºç°é—®é¢˜ï¼Œæˆ–è€…ä»èŠ‚ç‚¹æ€§èƒ½è¾ƒä½æ—¶ï¼Œä¸»ä»èŠ‚ç‚¹é—´çš„åŒæ­¥å°±ä¼šå‡ºç°å»¶è¿Ÿï¼Œå¯¼è‡´å†™åè¯»ä¸åˆ°çš„é—®é¢˜ã€‚åœ¨é«˜å¹¶å‘åœºæ™¯ï¼Œä»èŠ‚ç‚¹ä¸€èˆ¬è¦è¿‡å‡ åæ¯«ç§’ï¼Œç”šè‡³å‡ ç™¾æ¯«ç§’æ‰èƒ½è¯»åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚</p>
<p><strong>å¸¸è§çš„è§£å†³ç­–ç•¥</strong></p>
<p>ä¸€èˆ¬æ¥è®²ï¼Œå¤§è‡´æœ‰å¦‚ä¸‹æ–¹æ¡ˆè§£å†³å†™åè¯»ä¸å‡ºé—®é¢˜ï¼š</p>
<ul>
<li>å¼ºåˆ¶èµ°ä¸»åº“</li>
<li>åˆ¤æ–­ä¸»å¤‡æ— å»¶è¿Ÿ</li>
<li>ç­‰ä¸»åº“ä½ç‚¹æˆ– GTID æ–¹æ¡ˆ</li>
</ul>
<p><strong>1. å¼ºåˆ¶èµ°ä¸»åº“</strong><br>è¿™ç§æ–¹æ¡ˆé—®é¢˜åœ¨äºå°†ä¸€éƒ¨åˆ†è¯»å‹åŠ›ç»™äº†ä¸»èŠ‚ç‚¹ï¼Œéƒ¨åˆ†è¿èƒŒäº†è¯»å†™åˆ†ç¦»çš„åˆè¡·ï¼Œé™ä½äº†æ•´ä¸ªç³»ç»Ÿçš„æ‰©å±•æ€§ã€‚</p>
<p><strong>2. åˆ¤æ–­ä¸»å¤‡æ— å»¶è¿Ÿ</strong><br>ç¬¬äºŒç§æ–¹æ¡ˆæ˜¯ä½¿ç”¨ show slave status è¯­å¥ç»“æœä¸­çš„éƒ¨åˆ†å€¼æ¥åˆ¤æ–­ä¸»ä»åŒæ­¥çš„å»¶è¿Ÿæ—¶é—´ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt; show slave status</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Master_Log_File: mysql-bin.001822</span><br><span class="line">Read_Master_Log_Pos: 290072815</span><br><span class="line">Seconds_Behind_Master: 2923</span><br><span class="line">Relay_Master_Log_File: mysql-bin.001821</span><br><span class="line">Exec_Master_Log_Pos: 256529431</span><br><span class="line">Auto_Position: 0</span><br><span class="line">Retrieved_Gtid_Set: </span><br><span class="line">Executed_Gtid_Set: </span><br><span class="line">.....</span><br></pre></td></tr></table></figure>
<ul>
<li><em>seconds_behind_master</em>ï¼Œè¡¨ç¤ºè½åä¸»èŠ‚ç‚¹ç§’æ•°ï¼Œå¦‚æœæ­¤å€¼ä¸º0ï¼Œåˆ™è¡¨ç¤ºä¸»ä»æ— å»¶è¿Ÿï¼›</li>
<li><em>Master_Log_File å’Œ Read_Master_Log_Pos</em>ï¼Œè¡¨ç¤ºçš„æ˜¯è¯»åˆ°çš„ä¸»åº“çš„æœ€æ–°ä½ç‚¹ï¼ŒRelay_Master_Log_File å’Œ Exec_Master_Log_Posï¼Œè¡¨ç¤ºçš„æ˜¯å¤‡åº“æ‰§è¡Œçš„æœ€æ–°ä½ç‚¹ã€‚å¦‚æœè¿™ä¸¤ç»„å€¼ç›¸ç­‰ï¼Œåˆ™è¡¨ç¤ºä¸»ä»æ— å»¶è¿Ÿï¼›</li>
<li><em>Auto_Position=1</em> ï¼Œè¡¨ç¤ºä½¿ç”¨äº† GTID åè®®ï¼Œå¹¶ä¸”å¤‡åº“æ”¶åˆ°çš„æ‰€æœ‰æ—¥å¿—çš„ GTID é›†åˆ Retrieved_Gtid_Set å’Œ æ‰§è¡Œå®Œæˆçš„ GTID é›†åˆ Executed_Gtid_Set ç›¸ç­‰ï¼Œåˆ™è¡¨ç¤ºä¸»ä»æ— å»¶è¿Ÿã€‚</li>
</ul>
<p>åœ¨è¿›è¡Œè¯»æ“ä½œå‰ï¼Œå…ˆæ ¹æ®ä¸Šè¿°æ–¹å¼æ¥åˆ¤æ–­ä¸»ä»æ˜¯å¦æœ‰å»¶è¿Ÿã€‚å¦‚æœæœ‰å»¶è¿Ÿï¼Œåˆ™ä¸€ç›´ç­‰å¾…åˆ°æ— å»¶è¿Ÿåæ‰§è¡Œã€‚ä½†æ˜¯è¿™ç±»æ–¹æ¡ˆåœ¨åˆ¤æ–­æ˜¯å¦æœ‰å»¶è¿Ÿæ—¶å­˜åœ¨ç€å‡é˜³å’Œå‡é˜´çš„é—®é¢˜ï¼š</p>
<ul>
<li><em>åˆ¤æ–­æ— å»¶è¿Ÿï¼Œå…¶ä»–å»¶è¿Ÿäº†</em>ã€‚å› ä¸ºä¸Šè¿°åˆ¤æ–­æ˜¯åŸºäºä»èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œå½“ä¸»èŠ‚ç‚¹çš„ Dump Thread å°šæœªå°†æœ€æ–°çŠ¶æ€å‘é€ç»™ä»èŠ‚ç‚¹çš„ IO SQL æ—¶ï¼Œä»èŠ‚ç‚¹å¯èƒ½ä¼šé”™è¯¯çš„åˆ¤æ–­è‡ªå·±å’Œä¸»èŠ‚ç‚¹æ— å»¶è¿Ÿã€‚</li>
<li><em>åˆ¤æ–­æœ‰å»¶è¿Ÿï¼Œä½†æ˜¯è¯»æ“ä½œè¯»å–çš„æœ€æ–°çŠ¶æ€å·²ç»åŒæ­¥</em>ã€‚å› ä¸º MySQL ä¸»ä»å¤åˆ¶æ˜¯ä¸€ç›´åœ¨è¿›è¡Œçš„ï¼Œå†™åç›´æ¥è¯»çš„åŒæ—¶å¯èƒ½è¿˜æœ‰å…¶ä»–æ— å…³å†™æ“ä½œï¼Œè™½ç„¶ä¸»ä»æœ‰å»¶è¿Ÿï¼Œä½†æ˜¯å¯¹äºç¬¬ä¸€æ¬¡å†™æ“ä½œçš„åŒæ­¥å·²ç»å®Œæˆï¼Œæ‰€ä»¥è¯»æ“ä½œå·²ç»å¯ä»¥è¯»åˆ°æœ€æ–°çš„çŠ¶æ€ã€‚</li>
</ul>
<p>å¯¹äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦ä½¿ç”¨ä¸»ä»å¤åˆ¶çš„ <strong>semi-sync æ¨¡å¼</strong>ï¼Œå³<strong>åŠåŒæ­¥æ¨¡å¼</strong>ï¼Œä¸Šæ–‡ä¸­è®²è§£ä»‹ç»çš„æ˜¯é»˜è®¤çš„å¼‚æ­¥æ¨¡å¼ï¼Œsemi-sync æ¨¡å¼çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/mysql-questions.assets/image-20211010013950743.png" alt="image-20211010013950743" style="zoom:80%;"></p>
<p>ä¸»èŠ‚ç‚¹åªéœ€è¦æ¥æ”¶åˆ°å…¶ä¸­ä¸€å°ä»èŠ‚ç‚¹çš„ACKï¼Œå°±ä¼šcommitï¼Œæ‰€ä»¥å¯¹äºä¸€ä¸»å¤šä»çš„æ¨¡å¼ï¼Œè¯¥æ–¹æ¡ˆæ— æ•ˆã€‚</p>
<p>è™½ç„¶è¯¥æ–¹æ¡ˆæœ‰ç§ç§é—®é¢˜ï¼Œä½†æ˜¯å¯¹äºä¸€è‡´æ€§è¦æ±‚ä¸é‚£ä¹ˆé«˜çš„åœºæ™¯ä¹Ÿèƒ½é€‚ç”¨ï¼Œæ¯”å¦‚ MyCat å°±æ˜¯ç”¨ seconds_behind_master æ˜¯å¦è½åä¸»èŠ‚ç‚¹è¿‡å¤šï¼Œå¦‚æœè¶…è¿‡ä¸€å®šé˜ˆå€¼ï¼Œå°±å°†å…¶ä»æœ‰æ•ˆä»èŠ‚ç‚¹åˆ—è¡¨ä¸­åˆ é™¤ï¼Œä¸å†å°†è¯»è¯·æ±‚è·¯ç”±åˆ°å®ƒèº«ä¸Šã€‚</p>
<p>åœ¨ MyCAT çš„ç”¨äºç›‘å¬ä»èŠ‚ç‚¹çŠ¶æ€ï¼Œå‘é€å¿ƒè·³çš„ MySQLDetector ç±»ä¸­ï¼Œå®ƒä¼šè¯»å–ä»èŠ‚ç‚¹çš„ seconds_behind_masterï¼Œå¦‚æœå…¶å€¼å¤§äºé…ç½®çš„ slaveThresholdï¼Œåˆ™å°†æ‰“å°æ—¥å¿—ï¼Œå¹¶å°†å»¶è¿Ÿæ—¶é—´è®¾ç½®åˆ°å¿ƒè·³ä¿¡æ¯ä¸­ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/mysql-questions.assets/image-20211010020752584.png" alt="image-20211010020752584" style="zoom:80%;"></p>
<p>åŠåŒæ­¥æ¨¡å¼(mysql semi-sync)<br>è¿™ç§æ¨¡å¼ä¸‹ä¸»èŠ‚ç‚¹åªéœ€è¦æ¥æ”¶åˆ°å…¶ä¸­ä¸€å°ä»èŠ‚ç‚¹çš„è¿”å›ä¿¡æ¯ï¼Œå°±ä¼šcommitï¼›å¦åˆ™éœ€è¦ç­‰å¾…ç›´åˆ°è¶…æ—¶æ—¶é—´ç„¶ååˆ‡æ¢æˆå¼‚æ­¥æ¨¡å¼å†æäº¤ï¼›è¿™æ ·åšçš„ç›®çš„å¯ä»¥ä½¿ä¸»ä»æ•°æ®åº“çš„æ•°æ®å»¶è¿Ÿç¼©å°ï¼Œå¯ä»¥æé«˜æ•°æ®å®‰å…¨æ€§ï¼Œç¡®ä¿äº†äº‹åŠ¡æäº¤åï¼Œbinlogè‡³å°‘ä¼ è¾“åˆ°äº†ä¸€ä¸ªä»èŠ‚ç‚¹ä¸Šï¼Œä¸èƒ½ä¿è¯ä»èŠ‚ç‚¹å°†æ­¤äº‹åŠ¡æ›´æ–°åˆ°dbä¸­ã€‚æ€§èƒ½ä¸Šä¼šæœ‰ä¸€å®šçš„é™ä½ï¼Œå“åº”æ—¶é—´ä¼šå˜é•¿ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/mysql-questions.assets/v2-d9ac9c5493d1d772f5bf57ede089f0d5_hd.jpg" alt="img"></p>
<p>åŠåŒæ­¥æ¨¡å¼ä¸æ˜¯mysqlå†…ç½®çš„ï¼Œä»mysql 5.5å¼€å§‹é›†æˆï¼Œéœ€è¦master å’Œslave å®‰è£…æ’ä»¶å¼€å¯åŠåŒæ­¥æ¨¡å¼ã€‚</p>
<p><strong>3. ç­‰å¾…GTID</strong><br>é¦–å…ˆä»‹ç»ä¸€ä¸‹ GTIDï¼Œä¹Ÿå°±æ˜¯<strong>å…¨å±€äº‹åŠ¡ID</strong>ï¼Œæ˜¯ä¸€ä¸ªäº‹åŠ¡åœ¨æäº¤çš„æ—¶å€™ç”Ÿæˆçš„ï¼Œæ˜¯è¿™ä¸ªäº‹åŠ¡çš„å”¯ä¸€æ ‡è¯†ã€‚å®ƒç”±MySQL å®ä¾‹çš„ uuid å’Œä¸€ä¸ªæ•´æ•°ç»„æˆï¼Œè¯¥æ•´æ•°ç”±è¯¥å®ä¾‹ç»´æŠ¤ï¼Œåˆå§‹å€¼æ˜¯ 1ï¼Œæ¯æ¬¡è¯¥å®ä¾‹æäº¤äº‹åŠ¡åéƒ½ä¼šåŠ ä¸€ã€‚</p>
<p>MySQL æä¾›äº†ä¸€æ¡åŸºäº GTID çš„å‘½ä»¤ï¼Œç”¨äºåœ¨ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œï¼Œç­‰å¾…ä»åº“åŒæ­¥åˆ°äº†å¯¹åº”çš„ GTIDï¼ˆbinlogæ–‡ä»¶ä¸­ä¼šåŒ…å« GTIDï¼‰æˆ–è€…è¶…æ—¶è¿”å›ã€‚</p>
<p>MySQL åœ¨æ‰§è¡Œå®Œäº‹åŠ¡åï¼Œä¼šå°†è¯¥äº‹åŠ¡çš„ GTID ä¼šç»™å®¢æˆ·ç«¯ï¼Œç„¶åå®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¯¥å‘½ä»¤å»è¦æ‰§è¡Œè¯»æ“ä½œçš„ä»åº“ä¸­æ‰§è¡Œï¼Œç­‰å¾…è¯¥GTIDï¼Œç­‰å¾…æˆåŠŸåï¼Œå†æ‰§è¡Œè¯»æ“ä½œã€‚å¦‚æœç­‰å¾…è¶…æ—¶ï¼Œåˆ™å»ä¸»åº“æ‰§è¡Œè¯»æ“ä½œï¼Œæˆ–è€…å†æ¢ä¸€ä¸ªä»åº“æ‰§è¡Œä¸Šè¿°æµç¨‹ã€‚</p>
<p><em>æ¥æºï¼šç¨‹åºå‘˜å†å°å†°</em></p>
<hr>
<h2 id="éšå¼ç±»å‹è½¬æ¢å¯¼è‡´çš„æ…¢SQL"><a href="#éšå¼ç±»å‹è½¬æ¢å¯¼è‡´çš„æ…¢SQL" class="headerlink" title="éšå¼ç±»å‹è½¬æ¢å¯¼è‡´çš„æ…¢SQL"></a>éšå¼ç±»å‹è½¬æ¢å¯¼è‡´çš„æ…¢SQL</h2><p>ä¸šåŠ¡æ–¹åé¦ˆäº†ä¸€ä¸ªé—®é¢˜ï¼Œè¯´æ˜¯æŸä¸€æœåŠ¡æ¯æ¬¡åœ¨æŸ¥è¯¢çš„æ—¶å€™ä¼šæœ‰0.5sçš„å»¶è¿Ÿï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`account`</span> </span><br><span class="line"><span class="keyword">WHERE</span>  </span><br><span class="line"><span class="string">`accountid`</span> = <span class="number">20000000528</span> </span><br><span class="line"><span class="keyword">and</span> </span><br><span class="line"><span class="string">`accounttype`</span> = <span class="number">1</span> </span><br><span class="line"><span class="keyword">and</span> </span><br><span class="line"><span class="string">`appid`</span>=<span class="number">10005</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysql--dba_admin 12:59:09&gt;&gt;show create table account\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: account</span><br><span class="line">Create Table: CREATE TABLE `account` (</span><br><span class="line">  `appid` int(4) unsigned NOT NULL,</span><br><span class="line">  `uid` bigint(8) unsigned NOT NULL,</span><br><span class="line">  `accountid` char(32) NOT NULL DEFAULT <span class="string">''</span>,</span><br><span class="line">  `accounttype` int(4) unsigned NOT NULL,</span><br><span class="line">  `mtime` bigint(8) unsigned NOT NULL DEFAULT <span class="string">'0'</span>,</span><br><span class="line">  `id` bigint(20) NOT NULL,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  KEY `appid` (`appid`,`accountid`,`accounttype`,`uid`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹1ï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> uid <span class="keyword">FROM</span> <span class="string">`account`</span> </span><br><span class="line"><span class="keyword">WHERE</span>  </span><br><span class="line"><span class="string">`accountid`</span> = <span class="number">20000000528</span> </span><br><span class="line"><span class="keyword">and</span> </span><br><span class="line"><span class="string">`accounttype`</span> = <span class="number">1</span> </span><br><span class="line"><span class="keyword">and</span> </span><br><span class="line"><span class="string">`appid`</span>=<span class="number">10005</span>;</span><br></pre></td></tr></table></figure>
<p>ä¸šåŠ¡æ–¹åé¦ˆè¯´æ˜¯å¹¶æ²¡æœ‰æ˜æ˜¾çš„é™ä½æŸ¥è¯¢æ—¶é—´ã€‚æ—¶é—´è¿˜æ˜¯åœ¨0.3så·¦å³ï¼Œè¿˜æ˜¯ä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚å¼€å§‹æ€€ç–‘è¿™ä¸ªè¡¨çš„ç´¢å¼•åˆ›å»ºçš„æ˜¯å¦æœ‰é—®é¢˜ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysql &gt;&gt;select distinct accounttype from account <span class="built_in">limit</span> 10;</span><br><span class="line">+-------------+</span><br><span class="line">| accounttype |</span><br><span class="line">+-------------+</span><br><span class="line">|           1 |</span><br><span class="line">+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql &gt;&gt;select distinct appid  from account <span class="built_in">limit</span> 10;</span><br><span class="line">+-------------+</span><br><span class="line">|   appid     |</span><br><span class="line">+-------------+</span><br><span class="line">|       10005 |</span><br><span class="line">+-------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.02 sec)</span><br></pre></td></tr></table></figure>
<p>å‘ç°appidçš„å€¼ç›®å‰åªåŒ…å«ä¸€ä¸ª10005ï¼Œè€Œaccounttypeçš„å€¼ä¹ŸåªåŒ…å«æ•°å­—1ï¼Œè€Œaccountidå’Œuidçš„å€¼åŒ…å«5wå·¦å³ã€‚</p>
<p>ä¿®æ”¹ç´¢å¼•å­—æ®µ</p>
<p>è”åˆç´¢å¼•ï¼škey appid(appid,accountid,accounttype,uid)  ä¸åˆç†ï¼Œå› ä¸ºappidå’Œaccounttypeçš„å€¼åŸºæ•°å¤ªå°ï¼Œåªæœ‰1ï¼Œæ‰€ä»¥è¿™ä¸ªç´¢å¼•åº”è¯¥ä¿®æ”¹ï¼Œå…·ä½“çš„æ”¹æ³•æœ‰å¾ˆå¤šï¼Œæˆ‘æ˜¯é€šè¿‡ä¿®æ”¹è”åˆç´¢å¼•çš„å…ˆåé¡ºåºï¼Œå°†åŸºæ•°å¤§çš„å­—æ®µæ”¾åœ¨å‰é¢ï¼Œè¿™æ ·æ‰«æçš„æ—¶å€™èƒ½å¤Ÿè¿‡æ»¤çš„æ›´åŠ å‡†ç¡®ä¸€äº›ã€‚å°†ç´¢å¼•æ”¹ä¸ºï¼š</p>
<p>key â€˜idx_accidâ€™ (accountid,uid,appid,accounttype)</p>
<p>æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysql--dba_admin 13:05:51&gt;&gt;explain SELECT uid FROM `account` WHERE  `accountid` = 20000000528;</span><br><span class="line">+----+-------------+---------+-------+---------------+-----------+---------+------+-------+--------------------------+</span><br><span class="line">| id | select_type | table   | <span class="built_in">type</span>  | possible_keys | key       | key_len | ref  | rows  | Extra                    |</span><br><span class="line">+----+-------------+---------+-------+---------------+-----------+---------+------+-------+--------------------------+</span><br><span class="line">|  1 | SIMPLE      | account | index | idx_accid     | idx_accid | 112     | NULL | 57237 | Using <span class="built_in">where</span>; Using index |</span><br><span class="line">+----+-------------+---------+-------+---------------+-----------+---------+------+-------+--------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>å‘ç°æ²¡èµ°ç´¢å¼•ã€‚</p>
<p>æœ€ç»ˆå®šä½åˆ°åŸå› æ˜¯ï¼šaccountidåœ¨è¡¨ä¸­åº”è¯¥æ˜¯ä¸€ä¸ªcharç±»å‹çš„ï¼Œä½†æ˜¯åœ¨SQLè¯­å¥ä¸­å†™æˆäº†æ•´æ•°ç±»å‹ï¼Œå‘ç”Ÿäº†éšå¼ç±»å‹è½¬æ¢ï¼Œå¯¼è‡´ç´¢å¼•ä¸å¯ç”¨ã€‚</p>
<p>åº”ä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> uid <span class="keyword">FROM</span> <span class="string">`account`</span> </span><br><span class="line"><span class="keyword">WHERE</span>  </span><br><span class="line"><span class="string">`accountid`</span> = <span class="string">'20000000528'</span></span><br><span class="line"><span class="keyword">and</span> </span><br><span class="line"><span class="string">`accounttype`</span> = <span class="number">1</span> </span><br><span class="line"><span class="keyword">and</span> </span><br><span class="line"><span class="string">`appid`</span>=<span class="number">10005</span>;</span><br></pre></td></tr></table></figure>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>ç´¢å¼•çš„åˆ›å»ºï¼Œåº”è¯¥é€‰æ‹©åŸºæ•°å¤šçš„åˆ—ä½œä¸ºç´¢å¼•åˆ—ï¼Œè¿™æ ·æ¯”è¾ƒæœ‰åŒºåˆ†åº¦ï¼Œå¯ä»¥å‡å°‘æ‰«æè¡Œæ•°ï¼›</li>
<li>æŸ¥è¯¢SQLï¼Œä¸è¦è¿”å›æ— ç”¨çš„å­—æ®µï¼Œæœ‰å¯èƒ½é”™å¤±æœ€ä½³æŸ¥è¯¢è·¯å¾„ï¼Œä¾‹å¦‚select * ä¸èƒ½ç”¨åˆ°è¦†ç›–ç´¢å¼•ï¼›</li>
<li>æŸ¥è¯¢SQLä¸­çš„æ•°æ®ç±»å‹ä¸€å®šè¦åŒ¹é…ï¼Œå¦åˆ™ä¸€æ—¦äº§ç”Ÿäº†éšå¼è½¬æ¢ï¼Œå°±æœ‰å¯èƒ½ç”¨ä¸åˆ°ç´¢å¼•ã€‚</li>
</ul>
<p><em>æ¥æºï¼šDABéšç¬”ï¼Œä¸€ä¸ªæ…¢SQLï¼Œä¸€æ³¢ä¸‰æŠ˜â€¦</em></p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>åˆ†è‹¹æœ</title>
    <url>/2021/py-coding-3/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>é¢˜ç›®ï¼šmä¸ªäººåˆ†nä¸ªè‹¹æœï¼ŒæŒ‰åˆ†å¾—ä¸ªæ•°æ’åºå‰åç›¸é‚»2ä¸ªäººæœ€å¤šç›¸å·®3ä¸ªï¼Œæ¯ä¸ªäººæœ€å°‘åˆ†å¾—1ä¸ªï¼Œé—®æœ‰å‡ ç§åˆ†æ³•?</p>
</blockquote>
<a id="more"></a>
<p>æ™®é€šç‰ˆçš„åˆ†è‹¹æœé—®é¢˜ï¼š</p>
<blockquote>
<p>Mä¸ªåŒæ ·çš„è‹¹æœåˆ†åœ¨Nä¸ªåŒæ ·çš„ç¯®å­é‡Œï¼Œå…è®¸æœ‰ç¯®å­ç©ºç€ä¸æ”¾ï¼Œæ±‚ä¸€å…±æœ‰å¤šå°‘ç§ä¸åŒçš„åˆ†æ³•ã€‚<br>è¯´æ˜ï¼Œ3ï¼Œ1ï¼Œ1å’Œ1ï¼Œ3ï¼Œ1æ˜¯ä¸€ç§åˆ†æ³•ï¼›ç¯®å­å¯ä»¥æ”¾å…¥çš„è‹¹æœæ•°é‡æ²¡æœ‰æœ€å¤§é™åˆ¶ã€‚</p>
</blockquote>
<p>é€’å½’è§£æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">def share(apple, basket):</span><br><span class="line">    if apple &lt; 0 or basket &lt;= 0:</span><br><span class="line">        return 0</span><br><span class="line">    elif apple == 0 or basket == 1:</span><br><span class="line">        return 1</span><br><span class="line">    elif apple &lt; basket:</span><br><span class="line">        return share(apple, apple)</span><br><span class="line">    else:</span><br><span class="line">        return share(apple, basket - 1) + share(apple - basket, basket)</span><br><span class="line"> </span><br><span class="line">echo = list(map(int, raw_input().split()))</span><br><span class="line">apple = echo[0]</span><br><span class="line">basket = echo[1]</span><br><span class="line">print(share(apple, basket))</span><br></pre></td></tr></table></figure>
<p>å’Œæœ¬é¢˜æœ‰ä¸€å®šçš„ç›¸ä¼¼ï¼Œä½†æ²¡æ‰¾åˆ°é€’å½’æˆ–åŠ¨æ€è§„åˆ’çš„æ€è·¯ã€‚</p>
<p>ä»¥ä¸‹æ˜¯ä¸€ç§ä¸å¤ªå¥½çš„è§£æ³•ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="string">""" åˆ†è‹¹æœ</span></span><br><span class="line"><span class="string">mä¸ªäºº åˆ†nä¸ªè‹¹æœ æŒ‰åˆ†å¾—æ•°æ’åº å‰åç›¸é‚»2ä¸ªäººæœ€å¤šç›¸å·®3ä¸ª æ¯ä¸ªäººæœ€å°‘åˆ†å¾—1ä¸ª æœ‰å‡ ç§åˆ†æ³•?</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">æ³¨æ„ï¼š</span></span><br><span class="line"><span class="string">Aï¼ŒBä¸¤äººåˆ†4ä¸ªè‹¹æœï¼Œåˆ†åˆ« 1ï¼Œ3 å’Œ åˆ†åˆ« 3ï¼Œ1 è§†ä¸ºåŒä¸€ç§åˆ†æ³•ï¼Œä¸è€ƒè™‘äººçš„å¯¹åº”é¡ºåº</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">n &gt;= m</span></span><br><span class="line"><span class="string">m &gt; 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="string">2ä¸ªäººåˆ†4ä¸ªè‹¹æœï¼Œè¾“å…¥ï¼š</span></span><br><span class="line"><span class="string">2 4</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">æœ‰[3,1]ï¼Œ[2,2]å…±2ç§æ–¹æ¡ˆï¼Œè¾“å‡ºï¼š</span></span><br><span class="line"><span class="string">2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        m, n = map(int, raw_input().split())</span><br><span class="line">        <span class="keyword">if</span> n &lt; m <span class="keyword">or</span> m &lt; <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> m == <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"--------------------------&gt;"</span>, [n]</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># æœ€åä¸€ä¸ªäººæœ€å¤škmä¸ªï¼Œæœ€å°‘ä¸€ä¸ª(n&gt;=m)</span></span><br><span class="line">        km = n // m</span><br><span class="line">        Q = <span class="number">4</span>  <span class="comment"># æ¯”åä¸€ä½å¤š 0 1 2 3 å››ç§å–å€¼ï¼Œæ‰€ä»¥æ¨¡ä¸º4</span></span><br><span class="line"></span><br><span class="line">        nS = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> pm <span class="keyword">in</span> range(<span class="number">1</span>, km + <span class="number">1</span>):</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"pm:"</span>, pm  <span class="comment"># è®°æœ€åä¸€ä¸ªäººåˆ†å¾—pmä¸ª</span></span><br><span class="line">            <span class="comment"># å‡åˆ†ç‰¹ä¾‹</span></span><br><span class="line">            <span class="keyword">if</span> m * pm == n:</span><br><span class="line">                nS += <span class="number">1</span></span><br><span class="line">                <span class="keyword">print</span> <span class="string">"-------------*------------&gt;"</span>, [pm] * m</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># éå‡åˆ†çš„æƒ…å†µ</span></span><br><span class="line">            p = [<span class="number">0</span>] * (m - <span class="number">1</span>)  <span class="comment"># p[x] è¡¨ç¤ºç¬¬xä¸ªäºº æ¯”ç¬¬x+1ä¸ªäºº å¤šp[x]ä¸ª</span></span><br><span class="line">            QL = [Q] * (m - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># æ›´æ–°å„ä½çš„æ¨¡ï¼Œä»¥å‡å°‘å¾ªç¯æ¬¡æ•°</span></span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> range(m - <span class="number">1</span>):</span><br><span class="line">                <span class="comment"># p[y]*(y+1) + pm*m &lt;= n</span></span><br><span class="line">                QL[y] = min((n - m * pm) // (y + <span class="number">1</span>) + <span class="number">1</span>, Q)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"QL:"</span>, QL</span><br><span class="line"></span><br><span class="line">            is_break = <span class="literal">False</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                p[m - <span class="number">2</span>] += <span class="number">1</span>  <span class="comment"># å¾ªç¯+1ï¼Œé€ä½æ£€æŸ¥æ˜¯å¦è¿›1é€€0ï¼Œç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸ºm-1çš„åºåˆ—p</span></span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> range(m - <span class="number">2</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">                    <span class="keyword">if</span> p[j] &lt; QL[j]:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">if</span> j &gt; <span class="number">0</span>:</span><br><span class="line">                            p[j - <span class="number">1</span>] += <span class="number">1</span></span><br><span class="line">                            p[j] = <span class="number">0</span></span><br><span class="line">                        <span class="keyword">elif</span> j == <span class="number">0</span>:</span><br><span class="line">                            is_break = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> is_break:</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">                sum_p = pm * m</span><br><span class="line">                <span class="keyword">for</span> x <span class="keyword">in</span> range(m - <span class="number">2</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">                    sum_p += p[x] * (x + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> sum_p != n:</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="comment"># print "--------------------------&gt;", p, pm, sum_p</span></span><br><span class="line">                    nS += <span class="number">1</span></span><br><span class="line">                    t = p[<span class="number">-1</span>] + pm</span><br><span class="line">                    res = [t]</span><br><span class="line">                    <span class="keyword">for</span> k <span class="keyword">in</span> range(len(p) - <span class="number">2</span>, <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">                        t += p[k]</span><br><span class="line">                        res.insert(<span class="number">0</span>, t)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"--------------------------&gt;"</span>, res + [pm]</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Total:"</span>, nS</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹è¾“å‡ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">2 4</span><br><span class="line">pm: 1</span><br><span class="line">QL: [3]</span><br><span class="line">--------------------------&gt; [3, 1]</span><br><span class="line">pm: 2</span><br><span class="line">-------------*------------&gt; [2, 2]</span><br><span class="line">Total: 2</span><br><span class="line"></span><br><span class="line">5 7</span><br><span class="line">pm: 1</span><br><span class="line">QL: [3, 2, 1, 1]</span><br><span class="line">--------------------------&gt; [2, 2, 1, 1, 1]</span><br><span class="line">--------------------------&gt; [3, 1, 1, 1, 1]</span><br><span class="line">Total: 2</span><br><span class="line"></span><br><span class="line">5 12</span><br><span class="line">pm: 1</span><br><span class="line">QL: [4, 4, 3, 2]</span><br><span class="line">--------------------------&gt; [3, 3, 3, 2, 1]</span><br><span class="line">--------------------------&gt; [4, 4, 2, 1, 1]</span><br><span class="line">--------------------------&gt; [4, 3, 3, 1, 1]</span><br><span class="line">--------------------------&gt; [4, 3, 2, 2, 1]</span><br><span class="line">--------------------------&gt; [5, 4, 1, 1, 1]</span><br><span class="line">--------------------------&gt; [5, 3, 2, 1, 1]</span><br><span class="line">--------------------------&gt; [5, 2, 2, 2, 1]</span><br><span class="line">--------------------------&gt; [6, 3, 1, 1, 1]</span><br><span class="line">pm: 2</span><br><span class="line">QL: [3, 2, 1, 1]</span><br><span class="line">--------------------------&gt; [3, 3, 2, 2, 2]</span><br><span class="line">--------------------------&gt; [4, 2, 2, 2, 2]</span><br><span class="line">Total: 10</span><br><span class="line"></span><br><span class="line">13 27</span><br><span class="line">pm: 1</span><br><span class="line">QL: [4, 4, 4, 4, 3, 3, 3, 2, 2, 2, 2, 2]</span><br><span class="line">--------------------------&gt; [3, 3, 3, 3, 3, 3, 3, 1, 1, 1, 1, 1, 1]</span><br><span class="line">...ï¼ˆæ­¤å¤„çœç•¥å‡ åè¡Œï¼‰</span><br><span class="line">--------------------------&gt; [8, 5, 4, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span><br><span class="line">--------------------------&gt; [7, 4, 2, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1]</span><br><span class="line">--------------------------&gt; [8, 5, 3, 2, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span><br><span class="line">--------------------------&gt; [8, 5, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1]</span><br><span class="line">pm: 2</span><br><span class="line">QL: [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1]</span><br><span class="line">--------------------------&gt; [3, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]</span><br><span class="line">Total: 81</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythoné¢˜è®°-04</title>
    <url>/2021/py-coding-4/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>æ•°å­—é“¾è¡¨ï¼Œéšæœºå¯†ç </p>
</blockquote>
<a id="more"></a>
<blockquote>
<p>é¢˜1ï¼šç”¨é“¾è¡¨å­˜0-9çš„æ•°å­—ï¼Œç„¶åä»å¤´åˆ°å°¾è¾“å‡ºå…¶ä»£è¡¨çš„10è¿›åˆ¶æ•°å€¼ï¼ˆå‰é¢çš„0å¿½ç•¥ï¼‰</p>
<p>é¢˜2ï¼šéšæœºç”Ÿæˆ8å­—ç¬¦çš„å¯†ç <br>åŒ…å«1ä¸ªç‰¹æ®Šå­—ç¬¦ï¼š!#$%&amp;()+,-./:;&lt;=&gt;?@[]^_{}~<br>åŒ…å«1åˆ°2ä¸ªæ•°å­—<br>åŒ…å«å¤§å†™å­—æ¯<br>åŒ…å«å°å†™å­—æ¯</p>
<p>ç¤ºä¾‹ï¼š<br>4mOhNkV?<br>$pDz0Q9F<br>fXi?AGC9</p>
</blockquote>
<h2 id="æ•°å­—é“¾è¡¨"><a href="#æ•°å­—é“¾è¡¨" class="headerlink" title="æ•°å­—é“¾è¡¨"></a>æ•°å­—é“¾è¡¨</h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="string">""" æ•°å­—é“¾è¡¨</span></span><br><span class="line"><span class="string">ç”¨é“¾è¡¨å­˜0-9çš„æ•°å­—ï¼Œç„¶åä»å¤´åˆ°å°¾è¾“å‡ºå…¶ä»£è¡¨çš„10è¿›åˆ¶æ•°å€¼ï¼ˆå‰é¢çš„0å¿½ç•¥ï¼‰</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="string">0 0 1 2 3</span></span><br><span class="line"><span class="string">è¾“å‡º</span></span><br><span class="line"><span class="string">123</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">1 0 3 4 5</span></span><br><span class="line"><span class="string">è¾“å‡º</span></span><br><span class="line"><span class="string">10345</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, v=None)</span>:</span></span><br><span class="line">        self.value = v</span><br><span class="line">        self.next = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__repr__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> str(self.value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Nodes</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, node=None)</span>:</span></span><br><span class="line">        self.head = node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_tail</span><span class="params">(self)</span>:</span></span><br><span class="line">        cur_node = self.head</span><br><span class="line">        <span class="keyword">while</span> cur_node.next:</span><br><span class="line">            cur_node = cur_node.next</span><br><span class="line">        <span class="keyword">return</span> cur_node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_node</span><span class="params">(self, node)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.head <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            self.head = node</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            cur_node = self.get_tail()</span><br><span class="line">            cur_node.next = node</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_num</span><span class="params">(self)</span>:</span></span><br><span class="line">        s = <span class="literal">None</span></span><br><span class="line">        cur_node = self.head</span><br><span class="line">        <span class="keyword">while</span> cur_node:</span><br><span class="line">            <span class="keyword">if</span> s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> cur_node.value:</span><br><span class="line">                    s = str(cur_node.value)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                s += str(cur_node.value)</span><br><span class="line">            cur_node = cur_node.next</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">print</span> s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    nums = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>]</span><br><span class="line">    nodes = Nodes()</span><br><span class="line">    <span class="keyword">for</span> n <span class="keyword">in</span> nums:</span><br><span class="line">        nodes.add_node(Node(n))</span><br><span class="line"></span><br><span class="line">    nodes.print_num()</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…Nodesç¨ä½œä¿®æ”¹</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">class Nodes(object):</span><br><span class="line">    def __init__(self, node=None):</span><br><span class="line">        self.head = node</span><br><span class="line">        self.tail = node</span><br><span class="line"></span><br><span class="line">    def add_node(self, node):</span><br><span class="line">        if self.head is None:</span><br><span class="line">            self.head = node</span><br><span class="line">            self.tail = node</span><br><span class="line">        else:</span><br><span class="line">            self.tail.next = node</span><br><span class="line">            self.tail = node            </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="éšæœºå¯†ç "><a href="#éšæœºå¯†ç " class="headerlink" title="éšæœºå¯†ç "></a>éšæœºå¯†ç </h2><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint, choice, shuffle</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> letters, digits, uppercase, lowercase</span><br><span class="line"></span><br><span class="line"><span class="string">""" ç”Ÿæˆ10ä¸ªéšæœº8ä½æ•°å¯†ç </span></span><br><span class="line"><span class="string">åŒ…å«1ä¸ªç‰¹æ®Šå­—ç¬¦ï¼š!#$%&amp;()+,-./:;&lt;=&gt;?@[]^_&#123;&#125;~</span></span><br><span class="line"><span class="string">åŒ…å«1åˆ°2ä¸ªæ•°å­—</span></span><br><span class="line"><span class="string">åŒ…å«å¤§å†™å­—æ¯</span></span><br><span class="line"><span class="string">åŒ…å«å°å†™å­—æ¯</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ç¤ºä¾‹ï¼š</span></span><br><span class="line"><span class="string">4mOhNkV?</span></span><br><span class="line"><span class="string">$pDz0Q9F</span></span><br><span class="line"><span class="string">fXi?AGC9</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_psw</span><span class="params">()</span>:</span></span><br><span class="line">    r_lst = []</span><br><span class="line">    my_punctuation = <span class="string">"""!#$%&amp;()+,-./:;&lt;=&gt;?@[]^_&#123;&#125;~"""</span></span><br><span class="line">    r_lst.append(choice(my_punctuation))</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(randint(<span class="number">1</span>, <span class="number">2</span>)):</span><br><span class="line">        r_lst.append(choice(digits))</span><br><span class="line">    r_lst.append(choice(uppercase))</span><br><span class="line">    r_lst.append(choice(lowercase))</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">8</span> - len(r_lst)):</span><br><span class="line">        r_lst.append(choice(letters))</span><br><span class="line"></span><br><span class="line">    shuffle(r_lst)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>.join(r_lst)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">print</span> create_psw()</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>HJ-01</title>
    <url>/2021/py-coding/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å­—ç¬¦ä¸²"><a href="#å­—ç¬¦ä¸²" class="headerlink" title="å­—ç¬¦ä¸²"></a>å­—ç¬¦ä¸²</h2><h3 id="åˆ†å‰²ã€é€†åº"><a href="#åˆ†å‰²ã€é€†åº" class="headerlink" title="åˆ†å‰²ã€é€†åº"></a>åˆ†å‰²ã€é€†åº</h3><p>å­—ç¬¦é€†åº</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" å­—ç¬¦ä¸²åè½¬ æ•°å­—é¢ å€’ å­—ç¬¦é€†åº """</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> raw_input()[::<span class="number">-1</span>]</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>å•è¯é€†åº</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" å•è¯é€†åº</span></span><br><span class="line"><span class="string">i am a student</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">student a am i</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># S1:</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">line = raw_input()</span><br><span class="line">a = re.findall(<span class="string">"[A-Za-z]+"</span>, line)</span><br><span class="line"><span class="keyword">print</span> <span class="string">' '</span>.join(a[::<span class="number">-1</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># S2:</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">" "</span>.join(reversed(raw_input().split()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># S3:</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">" "</span>.join(raw_input().split()[::<span class="number">-1</span>])</span><br></pre></td></tr></table></figure>
<p>å­—ç¬¦ä¸²æœ€åä¸€ä¸ªå•è¯çš„é•¿åº¦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" å­—ç¬¦ä¸²æœ€åä¸€ä¸ªå•è¯çš„é•¿åº¦</span></span><br><span class="line"><span class="string">hello abc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">s = raw_input()</span><br><span class="line">lst = s.split(<span class="string">' '</span>)</span><br><span class="line">print(len(lst[<span class="number">-1</span>]))</span><br></pre></td></tr></table></figure>
<p>å­—ç¬¦ä¸²åˆ†å‰²</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" å­—ç¬¦ä¸²åˆ†å‰² æ¯8ä¸ªå­—ç¬¦åˆ†å‰² ä¸è¶³åˆ™å³è¡¥é›¶</span></span><br><span class="line"><span class="string">abc</span></span><br><span class="line"><span class="string">123456789</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">abc00000</span></span><br><span class="line"><span class="string">12345678</span></span><br><span class="line"><span class="string">90000000</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        s = raw_input()</span><br><span class="line">        <span class="keyword">while</span> len(s) &gt; <span class="number">8</span>:</span><br><span class="line">            <span class="keyword">print</span> s[:<span class="number">8</span>]</span><br><span class="line">            s = s[<span class="number">8</span>:]</span><br><span class="line">        <span class="keyword">print</span> s.ljust(<span class="number">8</span>, <span class="string">"0"</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<h3 id="å­—ç¬¦æ•°"><a href="#å­—ç¬¦æ•°" class="headerlink" title="å­—ç¬¦æ•°"></a>å­—ç¬¦æ•°</h3><p>ç»Ÿè®¡ä¸é‡å¤çš„å­—ç¬¦æ€»æ•°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" ç»Ÿè®¡ä¸é‡å¤çš„å­—ç¬¦æ€»æ•°</span></span><br><span class="line"><span class="string">abc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">s = raw_input()</span><br><span class="line">sn = set()</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">    sn.add(c)</span><br><span class="line"></span><br><span class="line">print(len(sn))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶å®ä¸€è¡Œå°±å¤Ÿäº†</span></span><br><span class="line">print(len(set(s)))</span><br></pre></td></tr></table></figure>
<p>ç»Ÿè®¡å„å­—ç¬¦çš„æ•°é‡</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" ç»Ÿè®¡å„å­—ç¬¦çš„æ•°é‡</span></span><br><span class="line"><span class="string">hello</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;'h': 1, 'e': 1, 'l': 2, 'o': 1&#125;</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">s = raw_input()</span><br><span class="line">d = dict(zip(s, [<span class="number">0</span>] * len(s)))</span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> s:</span><br><span class="line">    d[c] += <span class="number">1</span></span><br><span class="line"><span class="keyword">print</span> d</span><br></pre></td></tr></table></figure>
<h3 id="å›æ–‡"><a href="#å›æ–‡" class="headerlink" title="å›æ–‡"></a>å›æ–‡</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" æœ€é•¿çš„å¯¹ç§°éƒ¨åˆ† æœ€é•¿å›æ–‡é•¿åº¦é—®é¢˜</span></span><br><span class="line"><span class="string">ADEFFFFFFFFF</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">9</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>
<p><strong>æ­£å‘æŸ¥æ‰¾æ³•ï¼š</strong>å…ˆå‡å®šè¾¹ç•Œ å†æ¯”è¾ƒé•¿åº¦</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = raw_input()</span><br><span class="line">nmax = <span class="number">1</span></span><br><span class="line">j = len(s)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> j &lt;= nmax:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    j -= <span class="number">1</span></span><br><span class="line">    <span class="keyword">for</span> k <span class="keyword">in</span> xrange(<span class="number">0</span>, j):</span><br><span class="line">        ss = s[k:j + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">if</span> ss == ss[::<span class="number">-1</span>]:</span><br><span class="line">            <span class="keyword">if</span> j - k + <span class="number">1</span> &gt; nmax:</span><br><span class="line">                nmax = j - k + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> nmax</span><br></pre></td></tr></table></figure>
<p><strong>é€†å‘æŸ¥æ‰¾æ³•ï¼š</strong>å…ˆå‡å®šæœ€å¤§é•¿åº¦ï¼Œå†æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨è¿™æ ·çš„å­å­—ç¬¦ä¸²</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">f</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> length <span class="keyword">in</span> range(len(s), <span class="number">-1</span>, <span class="number">-1</span>):</span><br><span class="line">        <span class="keyword">for</span> index <span class="keyword">in</span> range(<span class="number">0</span>, len(s) - length + <span class="number">1</span>):</span><br><span class="line">            sub_string = s[index:length + index]</span><br><span class="line">            <span class="keyword">if</span> sub_string == sub_string[::<span class="number">-1</span>]:</span><br><span class="line">                <span class="keyword">return</span> len(sub_string)</span><br><span class="line"></span><br><span class="line">a = input()</span><br><span class="line"><span class="keyword">if</span> a:</span><br><span class="line">    print(f(a))</span><br></pre></td></tr></table></figure>
<p><strong>å•å±‚å¾ªç¯æ³•</strong>ï¼šæœ€å¿«</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s = raw_input()</span><br><span class="line">m = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s)):</span><br><span class="line">    <span class="keyword">if</span> i - m &gt;= <span class="number">1</span> <span class="keyword">and</span> s[i - m - <span class="number">1</span>:i + <span class="number">1</span>] == s[i - m - <span class="number">1</span>:i + <span class="number">1</span>][::<span class="number">-1</span>]:</span><br><span class="line">        m += <span class="number">2</span></span><br><span class="line">    <span class="keyword">elif</span> i - m &gt;= <span class="number">0</span> <span class="keyword">and</span> s[i - m:i + <span class="number">1</span>] == s[i - m:i + <span class="number">1</span>][::<span class="number">-1</span>]:</span><br><span class="line">        m += <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">print</span> m</span><br></pre></td></tr></table></figure>
<h2 id="å­—å…¸ã€åˆ—è¡¨"><a href="#å­—å…¸ã€åˆ—è¡¨" class="headerlink" title="å­—å…¸ã€åˆ—è¡¨"></a>å­—å…¸ã€åˆ—è¡¨</h2><p>åˆå¹¶è¡¨è®°å½•</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" åˆå¹¶è¡¨è®°å½•</span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">0 1</span></span><br><span class="line"><span class="string">0 2</span></span><br><span class="line"><span class="string">1 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0 3</span></span><br><span class="line"><span class="string">1 2</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">d = &#123;&#125;</span><br><span class="line">n = int(raw_input())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n):</span><br><span class="line">    <span class="comment"># k, v = [int(e) for e in raw_input().split()]</span></span><br><span class="line">    k, v = map(int, raw_input().split())</span><br><span class="line">    <span class="keyword">if</span> k <span class="keyword">in</span> d:</span><br><span class="line">        d[k] += v</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        d[k] = v</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k, v <span class="keyword">in</span> d.items():</span><br><span class="line">    <span class="keyword">print</span> k, v</span><br></pre></td></tr></table></figure>
<p>æŸ¥æ‰¾å…„å¼Ÿå•è¯</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" æŸ¥æ‰¾å…„å¼Ÿå•è¯</span></span><br><span class="line"><span class="string">6 cab ad abcd cba abc bca abc 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">bca</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">è¯´æ˜ï¼š</span></span><br><span class="line"><span class="string">abcçš„å…„å¼Ÿå•è¯æœ‰cab cba bcaï¼Œæ‰€ä»¥è¾“å‡º3</span></span><br><span class="line"><span class="string">ç»å­—å…¸åºæ’åˆ—åï¼Œå˜ä¸ºbca cab cbaï¼Œæ‰€ä»¥ç¬¬1ä¸ªå­—å…¸åºå…„å¼Ÿå•è¯ä¸ºbca</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">s = raw_input().strip().split()</span><br><span class="line">n = int(s.pop(<span class="number">0</span>))</span><br><span class="line">a, x, k = s[:n], s[n], int(s[<span class="number">-1</span>])</span><br><span class="line">y = sorted(x)</span><br><span class="line">temp = sorted([i <span class="keyword">for</span> i <span class="keyword">in</span> a <span class="keyword">if</span> i != x <span class="keyword">and</span> sorted(i) == y])</span><br><span class="line"><span class="keyword">print</span> len(temp)</span><br><span class="line"><span class="keyword">if</span> k &lt;= len(temp):</span><br><span class="line">    <span class="keyword">print</span> temp[k - <span class="number">1</span>]</span><br></pre></td></tr></table></figure>
<h2 id="æ•°å­—"><a href="#æ•°å­—" class="headerlink" title="æ•°å­—"></a>æ•°å­—</h2><h3 id="äºŒè¿›åˆ¶"><a href="#äºŒè¿›åˆ¶" class="headerlink" title="äºŒè¿›åˆ¶"></a>äºŒè¿›åˆ¶</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" åè¿›åˆ¶æ•° äºŒè¿›åˆ¶å½¢å¼1çš„ä¸ªæ•°</span></span><br><span class="line"><span class="string">7</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> bin(input()).count(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ³¨æ„ç±»å‹ï¼š</span></span><br><span class="line"><span class="keyword">print</span> type(input())         <span class="comment"># int</span></span><br><span class="line"><span class="keyword">print</span> type(raw_input())     <span class="comment"># str</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">""" äºŒè¿›åˆ¶æ•°é—®é¢˜ æœ€é•¿çš„è¿ç»­1çš„ä¸ªæ•° """</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># S0:</span></span><br><span class="line">s = bin(int(raw_input()))[<span class="number">2</span>:]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(s), <span class="number">0</span>, <span class="number">-1</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="string">'1'</span> * i <span class="keyword">in</span> s:</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="comment"># S2: æ­£åˆ™æ³• ç¨æ…¢ä¸€ç‚¹ç‚¹</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> len(max(re.findall(<span class="string">r'1&#123;1,&#125;'</span>, bin(int(raw_input()))[<span class="number">2</span>:]), key=len))</span><br></pre></td></tr></table></figure>
<h3 id="æœ€å°å…¬å€æ•°"><a href="#æœ€å°å…¬å€æ•°" class="headerlink" title="æœ€å°å…¬å€æ•°"></a>æœ€å°å…¬å€æ•°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">a, b = map(int, raw_input().split())</span><br><span class="line"><span class="keyword">if</span> a == b:</span><br><span class="line">    <span class="keyword">print</span> a</span><br><span class="line">    exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> a &gt; b:</span><br><span class="line">    a, b = b, a</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">1</span>, a + <span class="number">1</span>):</span><br><span class="line">    c = b * i</span><br><span class="line">    <span class="keyword">if</span> c % a == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">print</span> c</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p><strong>å¾ªç¯æ±‚ä½™æ³•ï¼š</strong>å¯åŒæ—¶æ±‚å‡º æœ€å°å…¬å€æ•° å’Œ æœ€å¤§å…¬çº¦æ•°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">m, n = map(int, raw_input().split())</span><br><span class="line">p = m * n</span><br><span class="line">t = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> n != <span class="number">0</span>:</span><br><span class="line">    t = m</span><br><span class="line">    m = n</span><br><span class="line">    n = t % n</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> p / m  <span class="comment"># m å³æœ€å¤§å…¬çº¦æ•°, p/m å³æœ€å°å…¬å€æ•°</span></span><br></pre></td></tr></table></figure>
<h2 id="ç”Ÿæˆå™¨"><a href="#ç”Ÿæˆå™¨" class="headerlink" title="ç”Ÿæˆå™¨"></a>ç”Ÿæˆå™¨</h2><p>æ±‚æ–æ³¢é‚£å¥‘æ•°åˆ—ç¬¬né¡¹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> timeit <span class="keyword">import</span> default_timer <span class="keyword">as</span> timer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">g</span><span class="params">(n)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    æœ‰è¾¹ç•Œï¼Œé™åˆ¶nä¸ªï¼Œå°±éœ€è¦æ ¹æ® n æ¥åˆ¤æ–­æ˜¯å¦ yield</span></span><br><span class="line"><span class="string">    :param n:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">2</span>:</span><br><span class="line">        a, b, i = <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> i != n:</span><br><span class="line">            a, b = b, a + b</span><br><span class="line">            <span class="keyword">yield</span> b</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…ï¼š</span></span><br><span class="line"><span class="comment"># def g(n):</span></span><br><span class="line"><span class="comment">#     a, b, counter = 1, 1, 0</span></span><br><span class="line"><span class="comment">#     while True:</span></span><br><span class="line"><span class="comment">#         if (counter &gt; n):</span></span><br><span class="line"><span class="comment">#             return</span></span><br><span class="line"><span class="comment">#         yield a</span></span><br><span class="line"><span class="comment">#         a, b = b, a + b</span></span><br><span class="line"><span class="comment">#         counter += 1</span></span><br><span class="line">            </span><br><span class="line"><span class="comment"># def g():</span></span><br><span class="line"><span class="comment">#     """</span></span><br><span class="line"><span class="comment">#     æ— è¾¹ç•Œé™åˆ¶</span></span><br><span class="line"><span class="comment">#     :return:</span></span><br><span class="line"><span class="comment">#     """</span></span><br><span class="line"><span class="comment">#     yield 1</span></span><br><span class="line"><span class="comment">#     yield 1</span></span><br><span class="line"><span class="comment">#     a, b = 1, 1</span></span><br><span class="line"><span class="comment">#     while True:</span></span><br><span class="line"><span class="comment">#         a, b = b, a + b</span></span><br><span class="line"><span class="comment">#         yield b</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        n = int(raw_input())</span><br><span class="line">        tic = timer()</span><br><span class="line">        <span class="keyword">for</span> i, e <span class="keyword">in</span> enumerate(g(n), start=<span class="number">1</span>):</span><br><span class="line">            <span class="keyword">if</span> i == n:</span><br><span class="line">                <span class="keyword">print</span> e</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        toc = timer()</span><br><span class="line">        <span class="keyword">print</span> toc - tic</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>ç´¯è®¡æ³•ï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = int(raw_input())</span><br><span class="line">        tic = timer()</span><br><span class="line">        a, b = <span class="number">1</span>, <span class="number">1</span></span><br><span class="line">        n = <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>, i + <span class="number">1</span>):</span><br><span class="line">                n = a + b</span><br><span class="line">                a = b</span><br><span class="line">                b = n</span><br><span class="line">        <span class="keyword">print</span> n</span><br><span class="line">        toc = timer()</span><br><span class="line">        <span class="keyword">print</span> toc - tic</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ã€æ‘˜ã€‘Redisç¬”è®°01</title>
    <url>/2021/redis-questions/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Redisä¸ºä»€ä¹ˆå¿«"><a href="#Redisä¸ºä»€ä¹ˆå¿«" class="headerlink" title="Redisä¸ºä»€ä¹ˆå¿«"></a>Redisä¸ºä»€ä¹ˆå¿«</h2><p>åŸå› ä¸»è¦æ˜¯ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p>
<ul>
<li>çº¯å†…å­˜æ“ä½œ</li>
<li>å•çº¿ç¨‹æ“ä½œï¼Œé¿å…äº†é¢‘ç¹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li>é‡‡ç”¨äº†éé˜»å¡ I/O å¤šè·¯å¤ç”¨æœºåˆ¶</li>
</ul>
<a id="more"></a>
<blockquote>
<p>åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ Redisï¼Œä¸»è¦è€ƒè™‘ä¸¤ä¸ªè§’åº¦ï¼šæ€§èƒ½å’Œå¹¶å‘ã€‚å¦‚æœåªæ˜¯ä¸ºäº†åˆ†å¸ƒå¼é”è¿™äº›å…¶ä»–åŠŸèƒ½ï¼Œè¿˜æœ‰å…¶ä»–ä¸­é—´ä»¶ Zookeeper ç­‰ä»£æ›¿ï¼Œå¹¶éä¸€å®šè¦ä½¿ç”¨ Redisã€‚</p>
</blockquote>
<h2 id="Redisçš„æ•°æ®ç±»å‹"><a href="#Redisçš„æ•°æ®ç±»å‹" class="headerlink" title="Redisçš„æ•°æ®ç±»å‹"></a>Redisçš„æ•°æ®ç±»å‹</h2><p><strong>String</strong></p>
<p><strong>Hash</strong></p>
<p><strong>List</strong></p>
<p>ä½¿ç”¨ List çš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥åšç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½ã€‚å¦å¤–ï¼Œå¯ä»¥åˆ©ç”¨ lrange å‘½ä»¤ï¼ŒåšåŸºäº Redis çš„åˆ†é¡µåŠŸèƒ½ï¼Œæ€§èƒ½æä½³ï¼Œç”¨æˆ·ä½“éªŒå¥½ã€‚</p>
<p><strong>Set</strong></p>
<p><strong>Sorted Set</strong></p>
<p><strong>Bitmap</strong></p>
<h2 id="Rediså¸¸è§é—®é¢˜"><a href="#Rediså¸¸è§é—®é¢˜" class="headerlink" title="Rediså¸¸è§é—®é¢˜"></a>Rediså¸¸è§é—®é¢˜</h2><ul>
<li>ç¼“å­˜å’Œæ•°æ®åº“åŒå†™ä¸€è‡´æ€§é—®é¢˜</li>
<li>ç¼“å­˜é›ªå´©é—®é¢˜</li>
<li>ç¼“å­˜å‡»ç©¿é—®é¢˜</li>
<li>ç¼“å­˜çš„å¹¶å‘ç«äº‰é—®é¢˜</li>
</ul>
<h2 id="Redis-çš„è¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶"><a href="#Redis-çš„è¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶" class="headerlink" title="Redis çš„è¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶"></a>Redis çš„è¿‡æœŸç­–ç•¥å’Œå†…å­˜æ·˜æ±°æœºåˆ¶</h2><p>Redis é‡‡ç”¨çš„æ˜¯å®šæœŸåˆ é™¤+æƒ°æ€§åˆ é™¤çš„è¿‡æœŸç­–ç•¥ã€‚</p>
<p>å®šæœŸåˆ é™¤ï¼ŒRedis é»˜è®¤æ¯100ms æ£€æŸ¥ä¸€æ¬¡ï¼Œæœ‰è¿‡æœŸ Key åˆ™åˆ é™¤ã€‚ä½†ä¸æ˜¯æ¯100ms å°†æ‰€æœ‰çš„ Key æ£€æŸ¥ä¸€æ¬¡ï¼Œè€Œæ˜¯éšæœºæŠ½å–è¿›è¡Œæ£€æŸ¥ã€‚å¦‚æœåªé‡‡ç”¨å®šæœŸåˆ é™¤ç­–ç•¥ï¼Œä¼šå¯¼è‡´å¾ˆå¤š Key åˆ°æ—¶é—´æ²¡æœ‰åˆ é™¤ã€‚äºæ˜¯ï¼Œæƒ°æ€§åˆ é™¤æ´¾ä¸Šç”¨åœºã€‚</p>
<p>å¦‚æœå®šæœŸåˆ é™¤æ²¡åˆ é™¤æ‰ Keyã€‚å¹¶ä¸”ä½ ä¹Ÿæ²¡åŠæ—¶å»è¯·æ±‚ Keyï¼Œä¹Ÿå°±æ˜¯è¯´æƒ°æ€§åˆ é™¤ä¹Ÿæ²¡ç”Ÿæ•ˆã€‚è¿™æ ·ï¼ŒRedis çš„å†…å­˜ä¼šè¶Šæ¥è¶Šé«˜ã€‚é‚£ä¹ˆå°±åº”è¯¥é‡‡ç”¨<strong>å†…å­˜æ·˜æ±°æœºåˆ¶</strong>ã€‚</p>
<ul>
<li>noevictionï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œæ–°å†™å…¥æ“ä½œä¼šæŠ¥é”™ã€‚</li>
<li>allkeys-lruï¼š<strong><em>å½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ Key</em></strong>ã€‚ï¼ˆæ¨èä½¿ç”¨ï¼Œç›®å‰é¡¹ç›®åœ¨ç”¨è¿™ç§ï¼‰(æœ€è¿‘æœ€ä¹…ä½¿ç”¨ç®—æ³•)</li>
<li>allkeys-randomï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ª Keyã€‚ï¼ˆåº”è¯¥ä¹Ÿæ²¡äººç”¨å§ï¼Œä½ ä¸åˆ æœ€å°‘ä½¿ç”¨ Keyï¼Œå»éšæœºåˆ ï¼‰</li>
<li>volatile-lruï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œç§»é™¤æœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ Keyã€‚è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯æŠŠ Redis æ—¢å½“ç¼“å­˜ï¼ŒåˆåšæŒä¹…åŒ–å­˜å‚¨çš„æ—¶å€™æ‰ç”¨ã€‚ï¼ˆä¸æ¨èï¼‰</li>
<li>volatile-randomï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œéšæœºç§»é™¤æŸä¸ª Keyã€‚ï¼ˆä¾ç„¶ä¸æ¨èï¼‰</li>
<li>volatile-ttlï¼šå½“å†…å­˜ä¸è¶³ä»¥å®¹çº³æ–°å†™å…¥æ•°æ®æ—¶ï¼Œåœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®ç©ºé—´ä¸­ï¼Œæœ‰æ›´æ—©è¿‡æœŸæ—¶é—´çš„ Key ä¼˜å…ˆç§»é™¤ã€‚ï¼ˆä¸æ¨èï¼‰</li>
</ul>
<p>é»˜è®¤é…ç½®çš„æ˜¯ï¼š maxmemory-policy  volatile-lru<br>æ¨èï¼š maxmemory-policy  allkeys-lru</p>
<h2 id="Redis-å’Œæ•°æ®åº“åŒå†™ä¸€è‡´æ€§é—®é¢˜"><a href="#Redis-å’Œæ•°æ®åº“åŒå†™ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="Redis å’Œæ•°æ®åº“åŒå†™ä¸€è‡´æ€§é—®é¢˜"></a>Redis å’Œæ•°æ®åº“åŒå†™ä¸€è‡´æ€§é—®é¢˜</h2><p>ä¸€è‡´æ€§é—®é¢˜è¿˜å¯ä»¥å†åˆ†ä¸ºæœ€ç»ˆä¸€è‡´æ€§å’Œå¼ºä¸€è‡´æ€§ã€‚æ•°æ®åº“å’Œç¼“å­˜åŒå†™ï¼Œå°±å¿…ç„¶ä¼šå­˜åœ¨ä¸ä¸€è‡´çš„é—®é¢˜ã€‚å¦‚æœå¯¹æ•°æ®æœ‰å¼ºä¸€è‡´æ€§è¦æ±‚ï¼Œä¸èƒ½æ”¾ç¼“å­˜ã€‚æˆ‘ä»¬æ‰€åšçš„ä¸€åˆ‡ï¼Œåªèƒ½ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ã€‚</p>
<p>é¦–å…ˆï¼Œé‡‡å–æ­£ç¡®æ›´æ–°ç­–ç•¥ï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜ã€‚<br>å…¶æ¬¡ï¼Œå› ä¸ºå¯èƒ½å­˜åœ¨åˆ é™¤ç¼“å­˜å¤±è´¥çš„é—®é¢˜ï¼Œæä¾›ä¸€ä¸ªè¡¥å¿æªæ–½å³å¯ï¼Œä¾‹å¦‚åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p>
<h2 id="ç¼“å­˜ç©¿é€å’Œç¼“å­˜é›ªå´©é—®é¢˜"><a href="#ç¼“å­˜ç©¿é€å’Œç¼“å­˜é›ªå´©é—®é¢˜" class="headerlink" title="ç¼“å­˜ç©¿é€å’Œç¼“å­˜é›ªå´©é—®é¢˜"></a>ç¼“å­˜ç©¿é€å’Œç¼“å­˜é›ªå´©é—®é¢˜</h2><p>ç¼“å­˜ç©¿é€è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>åˆ©ç”¨äº’æ–¥é”ï¼Œç¼“å­˜å¤±æ•ˆçš„æ—¶å€™ï¼Œå…ˆå»è·å¾—é”ï¼Œå¾—åˆ°é”äº†ï¼Œå†å»è¯·æ±‚æ•°æ®åº“ã€‚æ²¡å¾—åˆ°é”ï¼Œåˆ™ä¼‘çœ ä¸€æ®µæ—¶é—´é‡è¯•ã€‚</li>
<li>é‡‡ç”¨å¼‚æ­¥æ›´æ–°ç­–ç•¥ï¼Œæ— è®º Key æ˜¯å¦å–åˆ°å€¼ï¼Œéƒ½ç›´æ¥è¿”å›ã€‚Value å€¼ä¸­ç»´æŠ¤ä¸€ä¸ªç¼“å­˜å¤±æ•ˆæ—¶é—´ï¼Œç¼“å­˜å¦‚æœè¿‡æœŸï¼Œå¼‚æ­¥èµ·ä¸€ä¸ªçº¿ç¨‹å»è¯»æ•°æ®åº“ï¼Œæ›´æ–°ç¼“å­˜ã€‚éœ€è¦åšç¼“å­˜é¢„çƒ­(é¡¹ç›®å¯åŠ¨å‰ï¼Œå…ˆåŠ è½½ç¼“å­˜)æ“ä½œã€‚</li>
<li>æä¾›ä¸€ä¸ªèƒ½è¿…é€Ÿåˆ¤æ–­è¯·æ±‚æ˜¯å¦æœ‰æ•ˆçš„æ‹¦æˆªæœºåˆ¶ï¼Œæ¯”å¦‚ï¼Œåˆ©ç”¨å¸ƒéš†è¿‡æ»¤å™¨ï¼Œå†…éƒ¨ç»´æŠ¤ä¸€ç³»åˆ—åˆæ³•æœ‰æ•ˆçš„ Keyã€‚è¿…é€Ÿåˆ¤æ–­å‡ºï¼Œè¯·æ±‚æ‰€æºå¸¦çš„ Key æ˜¯å¦åˆæ³•æœ‰æ•ˆã€‚å¦‚æœä¸åˆæ³•ï¼Œåˆ™ç›´æ¥è¿”å›ã€‚</li>
</ul>
<p>ç¼“å­˜é›ªå´©ï¼Œå³ç¼“å­˜åŒä¸€æ—¶é—´å¤§é¢ç§¯çš„å¤±æ•ˆï¼Œè¿™ä¸ªæ—¶å€™åˆæ¥äº†ä¸€æ³¢è¯·æ±‚ï¼Œç»“æœè¯·æ±‚éƒ½æ€¼åˆ°æ•°æ®åº“ä¸Šï¼Œä»è€Œå¯¼è‡´æ•°æ®åº“è¿æ¥å¼‚å¸¸ã€‚</p>
<p>ç¼“å­˜é›ªå´©è§£å†³æ–¹æ¡ˆï¼š</p>
<ul>
<li>ç»™ç¼“å­˜çš„å¤±æ•ˆæ—¶é—´ï¼ŒåŠ ä¸Šä¸€ä¸ªéšæœºå€¼ï¼Œé¿å…é›†ä½“å¤±æ•ˆã€‚</li>
<li>ä½¿ç”¨äº’æ–¥é”ï¼Œä½†æ˜¯è¯¥æ–¹æ¡ˆååé‡æ˜æ˜¾ä¸‹é™äº†ã€‚</li>
<li>åŒç¼“å­˜ã€‚æˆ‘ä»¬æœ‰ä¸¤ä¸ªç¼“å­˜ï¼Œç¼“å­˜ A å’Œç¼“å­˜ Bã€‚ç¼“å­˜ A çš„å¤±æ•ˆæ—¶é—´ä¸º 20 åˆ†é’Ÿï¼Œç¼“å­˜ B ä¸è®¾å¤±æ•ˆæ—¶é—´ã€‚è‡ªå·±åšç¼“å­˜é¢„çƒ­æ“ä½œã€‚</li>
<li>ç„¶åç»†åˆ†ä»¥ä¸‹å‡ ä¸ªå°ç‚¹ï¼šä»ç¼“å­˜ A è¯»æ•°æ®åº“ï¼Œæœ‰åˆ™ç›´æ¥è¿”å›ï¼›A æ²¡æœ‰æ•°æ®ï¼Œç›´æ¥ä» B è¯»æ•°æ®ï¼Œç›´æ¥è¿”å›ï¼Œå¹¶ä¸”å¼‚æ­¥å¯åŠ¨ä¸€ä¸ªæ›´æ–°çº¿ç¨‹ï¼Œæ›´æ–°çº¿ç¨‹åŒæ—¶æ›´æ–°ç¼“å­˜ A å’Œç¼“å­˜ Bã€‚</li>
</ul>
<p><em>æ¥æºï¼š<a href="http://www.cnblogs.com/yaodengyan/p/9717080.html" rel="external nofollow noopener noreferrer" target="_blank">www.cnblogs.com/yaodengyan/p/9717080.html</a></em></p>
<hr>
<h2 id="å¹¶å‘ç«äº‰Keyé—®é¢˜"><a href="#å¹¶å‘ç«äº‰Keyé—®é¢˜" class="headerlink" title="å¹¶å‘ç«äº‰Keyé—®é¢˜"></a>å¹¶å‘ç«äº‰Keyé—®é¢˜</h2><p>å¹¶å‘ç«äº‰keyï¼Œå³åŒæ—¶æœ‰å¤šä¸ªå®¢æˆ·ç«¯å»setä¸€ä¸ªkeyã€‚è§£å†³æ–¹æ³•ï¼š</p>
<p><strong>ä¹è§‚é”</strong><br>å¯¹ä¿®æ”¹é¡ºåºæ²¡æœ‰è¦æ±‚çš„åœºæ™¯ï¼Œå¹¶ä¸”redisæ²¡æœ‰ä½¿ç”¨åˆ†ç‰‡æ—¶ï¼Œå¯ä»¥é€šè¿‡<strong>watch</strong>å‘½ä»¤å®ç°ã€‚watchå‘½ä»¤ä¼šç›‘è§†ç»™å®šçš„æ¯ä¸€ä¸ªkeyï¼Œå½“execæ—¶å¦‚æœç›‘è§†çš„ä»»ä¸€ä¸ªkeyè‡ªä»è°ƒç”¨watchåå‘ç”Ÿè¿‡å˜åŒ–ï¼Œåˆ™æ•´ä¸ªäº‹åŠ¡ä¼šå›æ»šï¼Œä¸æ‰§è¡Œä»»ä½•åŠ¨ä½œã€‚</p>
<p><strong>åˆ†å¸ƒå¼é”</strong><br>å¯¹ä¿®æ”¹é¡ºåºæ²¡æœ‰è¦æ±‚çš„åœºæ™¯ï¼Œå‡†å¤‡ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼ŒæŠ¢åˆ°é”æ‰èƒ½setã€‚</p>
<p><strong>æ—¶é—´æˆ³</strong><br>å¯¹äºæœ‰é¡ºåºè¦æ±‚çš„åœºæ™¯ï¼Œåœ¨å†™å…¥æ—¶ä¿å­˜ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œå†™å…¥å‰å…ˆæ¯”è¾ƒè‡ªå·±çš„æ—¶é—´æˆ³æ˜¯ä¸æ˜¯æ—©äºç°æœ‰è®°å½•çš„æ—¶é—´æˆ³ï¼Œå¦‚æœæ—©äºï¼Œå°±ä¸å†™å…¥äº†ã€‚</p>
<p><strong>é˜Ÿåˆ—</strong><br>é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œä¸²è¡ŒåŒ–å¤„ç†ã€‚</p>
<p><em>åŸæ–‡ï¼š<a href="https://blog.csdn.net/suifeng629/article/details/103304247" rel="external nofollow noopener noreferrer" target="_blank">https://blog.csdn.net/suifeng629/article/details/103304247</a></em></p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redisç¬”è®°02</title>
    <url>/2021/redis/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p><a href="https://lzzeng.github.io/2021/redis-questions/">Redisç¬”è®°01</a></p>
</blockquote>
<h2 id="çº¿ç¨‹æ¨¡å‹"><a href="#çº¿ç¨‹æ¨¡å‹" class="headerlink" title="çº¿ç¨‹æ¨¡å‹"></a>çº¿ç¨‹æ¨¡å‹</h2><p>å•çº¿ç¨‹æ¨¡å‹ï¼Œæ–‡ä»¶äº‹ä»¶å¤„ç†å™¨é€šè¿‡IOå¤šè·¯å¤ç”¨ ç›‘å¬å¤šä¸ªsocketï¼ˆsocketæ‰§è¡Œaccept read write closeç­‰æ“ä½œäº§ç”Ÿæ–‡ä»¶äº‹ä»¶ï¼‰ï¼Œç„¶åç”±æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨å¤„ç†æ–‡ä»¶äº‹ä»¶ã€‚</p>
<a id="more"></a>
<h2 id="æŒä¹…åŒ–æ–¹å¼"><a href="#æŒä¹…åŒ–æ–¹å¼" class="headerlink" title="æŒä¹…åŒ–æ–¹å¼"></a>æŒä¹…åŒ–æ–¹å¼</h2><p>rdbï¼šå¿«ç…§</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>
<p>aofï¼š é»˜è®¤é…ç½®çš„æ˜¯ appendonly noï¼Œæ”¹æˆyesæ‰“å¼€AOFæ¨¡å¼</p>
<h2 id="å¦‚ä½•è¿æ¥Redis"><a href="#å¦‚ä½•è¿æ¥Redis" class="headerlink" title="å¦‚ä½•è¿æ¥Redis"></a>å¦‚ä½•è¿æ¥Redis</h2><p>1ï½ä½¿ç”¨å®ç°äº†ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•çš„proxyä¸­é—´ä»¶twemproxy<br>2ï½Javaä½¿ç”¨Jedisã€ShardedJedisã€JedisPoolã€JedisSentinelPoolï¼ˆå“¨å…µæ¨¡å¼ï¼‰æˆ–JedisClusterï¼ˆRedis clusteræ¨¡å¼ï¼‰è¿æ¥redis</p>
<p>Jedis 2.9.1å­˜åœ¨çš„ä¸€ä¸ªbug: <a href="https://blog.csdn.net/u013527895/article/details/103121558" rel="external nofollow noopener noreferrer" target="_blank">https://blog.csdn.net/u013527895/article/details/103121558</a></p>
<p>JedisåŠ è½½redisé›†ç¾¤çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹å¦‚æœå¼‚å¸¸ä¸åœ¨çº¿ï¼Œå¹¶ä¸”redisè®¾ç½®äº†å¯†ç çš„è¯ï¼Œä¼šå› è¿æ¥å¼‚å¸¸é€€å‡ºä¸å†å°è¯•ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚æ‰€è°“ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå°±æ˜¯æ‰€æœ‰redisèŠ‚ç‚¹åŠ è½½åˆ°HashSet<hostandport>é›†åˆåé›†åˆé‡Œç¬¬ä¸€ä¸ªå…ƒç´ ã€‚</hostandport></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//src/main/java/redis/clients/jedis/JedisClusterConnectionHandler.java</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initializeSlotsCache</span><span class="params">(Set&lt;HostAndPort&gt; startNodes, GenericObjectPoolConfig poolConfig, <span class="keyword">int</span> connectionTimeout, <span class="keyword">int</span> soTimeout, String password, String clientName)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (HostAndPort hostAndPort : startNodes) &#123;</span><br><span class="line">      Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        jedis = <span class="keyword">new</span> Jedis(hostAndPort.getHost(), hostAndPort.getPort(), connectionTimeout, soTimeout);</span><br><span class="line">        <span class="keyword">if</span> (password != <span class="keyword">null</span>) &#123;</span><br><span class="line">          jedis.auth(password);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (clientName != <span class="keyword">null</span>) &#123;</span><br><span class="line">          jedis.clientSetname(clientName);</span><br><span class="line">        &#125;</span><br><span class="line">        cache.discoverClusterNodesAndSlots(jedis);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (JedisConnectionException e) &#123;</span><br><span class="line">        <span class="comment">// try next nodes</span></span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jedis != <span class="keyword">null</span>) &#123;</span><br><span class="line">          jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<h2 id="Jedisè¿æ¥Redisä»£ç å‚è€ƒ"><a href="#Jedisè¿æ¥Redisä»£ç å‚è€ƒ" class="headerlink" title="Jedisè¿æ¥Redisä»£ç å‚è€ƒ"></a>Jedisè¿æ¥Redisä»£ç å‚è€ƒ</h2><p>æ·±å…¥å‰–æRediså®¢æˆ·ç«¯Jedisçš„ç‰¹æ€§å’ŒåŸç†: <a href="https://baijiahao.baidu.com/s?id=1715292157796722813&amp;wfr=spider&amp;for=pc" rel="external nofollow noopener noreferrer" target="_blank">https://baijiahao.baidu.com/s?id=1715292157796722813&amp;wfr=spider&amp;for=pc</a></p>
<p>ä¸»ä»æ¨¡å¼è¿æ¥ï¼šJedis</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MasterAndSlaveTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        Jedis jedis_M = <span class="keyword">new</span> Jedis(<span class="string">"192.168.248.129"</span>,<span class="number">6379</span>); <span class="comment">//ä¸»æœº</span></span><br><span class="line">        Jedis jedis_S = <span class="keyword">new</span> Jedis(<span class="string">"192.168.248.129"</span>,<span class="number">6380</span>); <span class="comment">//ä»æœº</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//éµå¾ªâ€œé…ä»ä¸é…ä¸»â€çš„æ¨¡å¼</span></span><br><span class="line">        jedis_S.slaveof(<span class="string">"192.168.248.129"</span>,<span class="number">6379</span>);</span><br><span class="line">        </span><br><span class="line">        jedis_M.set(<span class="string">"class"</span>, <span class="string">"8888"</span>); <span class="comment">//ä¸»æœºå»å†™</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//å†…å­˜ä¸­è¯»å†™å¤ªå¿«ï¼Œé˜²æ­¢è¯»åœ¨å†™ä¹‹å‰å…ˆå®Œæˆè€Œå‡ºç°nullçš„æƒ…å†µï¼Œè¿™é‡Œåšä¸€ä¸‹å»¶è¿Ÿ</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        String result = jedis_S.get(<span class="string">"class"</span>); <span class="comment">//ä»æœºå»è¯»</span></span><br><span class="line">        System.out.println(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤šä¸ªrediså®ä¾‹ï¼ˆéclusterï¼‰ï¼šShardedJedisï¼Œä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisShardInfo;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.ShardedJedis;</span><br><span class="line"></span><br><span class="line">List&lt;JedisShardInfo&gt; shards = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">JedisShardInfo info = <span class="keyword">null</span> ;</span><br><span class="line"><span class="keyword">for</span> (String address : addresss.split(<span class="string">","</span>)) &#123;</span><br><span class="line">    String[] hostAndPort = address.split(<span class="string">":"</span>);</span><br><span class="line">    info = <span class="keyword">new</span> JedisShardInfo(hostAndPort[<span class="number">0</span>], Integer.valueOf(hostAndPort[<span class="number">1</span>]));</span><br><span class="line">    shards.add(info);</span><br><span class="line">&#125;</span><br><span class="line">shardedJedis = <span class="keyword">new</span> ShardedJedis(shards);</span><br><span class="line">shardedJedis.set(<span class="string">"a"</span>, <span class="string">"123"</span>);</span><br><span class="line">shardedJedis.get(<span class="string">"a"</span>);</span><br></pre></td></tr></table></figure>
<p>å“¨å…µæ¨¡å¼è¿æ¥ï¼šJedisSentinelPool</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisSentinelPool</span><br><span class="line"></span><br><span class="line"><span class="comment">//1.è®¾ç½®sentinel å„ä¸ªèŠ‚ç‚¹é›†åˆ</span></span><br><span class="line">Set&lt;String&gt; sentinelSet = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">sentinelSet.add(<span class="string">"192.168.14.101:26379"</span>);</span><br><span class="line">sentinelSet.add(<span class="string">"192.168.14.102:26379"</span>);</span><br><span class="line">sentinelSet.add(<span class="string">"192.168.14.103:26379"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//2.è®¾ç½®jedispool è¿æ¥æ± é…ç½®æ–‡ä»¶</span></span><br><span class="line">JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">config.setMaxTotal(<span class="number">10</span>);</span><br><span class="line">config.setMaxWaitMillis(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.è®¾ç½®mastername,sentinelNodeé›†åˆ,é…ç½®æ–‡ä»¶,Redisç™»å½•å¯†ç </span></span><br><span class="line">JedisSentinelPool jedisSentinelPool = <span class="keyword">new</span> JedisSentinelPool(<span class="string">"mymaster"</span>,sentinelSet,config,<span class="string">"123"</span>);</span><br><span class="line">Jedis jedis = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    jedis = jedisSentinelPool.getResource();</span><br><span class="line">    <span class="comment">//è·å–Redisä¸­key=helloçš„å€¼</span></span><br><span class="line">    String value = jedis.get(<span class="string">"hello"</span>);</span><br><span class="line">    System.out.println(value);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(jedis != <span class="keyword">null</span>)&#123;</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>clusteræ¨¡å¼è¿æ¥ï¼šJedisClusterï¼Œå“ˆå¸Œæ§½ç®—æ³•</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.HostAndPort;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisCluster;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestJedisCluster</span> </span>&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">   <span class="comment">//1ã€åˆ›å»ºjedidsClusterå®¢æˆ·ç«¯</span></span><br><span class="line">   <span class="comment">//åˆ›å»ºä¸€ä¸ªseté›†åˆï¼Œç”¨æ¥å°è£…æ‰€æœ‰redisèŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">   Set&lt;HostAndPort&gt; nodes = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">   </span><br><span class="line">   nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.23.12"</span>, <span class="number">7001</span>));</span><br><span class="line">   nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.23.12"</span>, <span class="number">7002</span>));</span><br><span class="line">   nodes.add(<span class="keyword">new</span> HostAndPort(<span class="string">"192.168.23.12"</span>, <span class="number">7003</span>));</span><br><span class="line">   <span class="comment">//...</span></span><br><span class="line">   </span><br><span class="line">   JedisCluster cluster = <span class="keyword">new</span> JedisCluster(nodes);</span><br><span class="line">   </span><br><span class="line">   String name = cluster.get(<span class="string">"user:id:1:name"</span>);</span><br><span class="line">   cluster.set(<span class="string">"user:id:1:address"</span>, <span class="string">"ä½ å¥½å‘€"</span>);</span><br><span class="line">   String address = cluster.get(<span class="string">"user:id:1:address"</span>);</span><br><span class="line">   </span><br><span class="line">   System.out.println(<span class="string">"name:"</span>+name);</span><br><span class="line">   System.out.println(<span class="string">"address:"</span>+address);     </span><br><span class="line">   <span class="keyword">if</span>(<span class="keyword">null</span>!=cluster)&#123;</span><br><span class="line">       cluster.close();</span><br><span class="line">   &#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="é›†ç¾¤æ“ä½œ"><a href="#é›†ç¾¤æ“ä½œ" class="headerlink" title="é›†ç¾¤æ“ä½œ"></a>é›†ç¾¤æ“ä½œ</h2><p>5.0ç‰ˆæœ¬ä¹‹å‰ä½¿ç”¨redis-trib.rb rubyè„šæœ¬æ“ä½œredisé›†ç¾¤ï¼Œ5.0ä»¥ä¸Šç»Ÿä¸€ä½¿ç”¨redis-cliæ“ä½œã€‚</p>
<p>redis clusteråŠæ•°ä»¥ä¸‹çš„èŠ‚ç‚¹é™†ç»­ä¸‹çº¿åï¼Œé›†ç¾¤ä»å¯æ­£å¸¸æä¾›æœåŠ¡ï¼ŒèŠ‚ç‚¹é‡æ–°ä¸Šçº¿åï¼ŒèŠ‚ç‚¹ä¸ŠåŸmasterå˜æˆslaveï¼Œåé¢ä¸å‘ç”Ÿå¼‚å¸¸çš„è¯ï¼Œä¸ä¼šè‡ªåŠ¨è°ƒè½¬è¿‡æ¥ã€‚</p>
<h2 id="åˆ›å»ºredis-cluster"><a href="#åˆ›å»ºredis-cluster" class="headerlink" title="åˆ›å»ºredis-cluster"></a>åˆ›å»ºredis-cluster</h2><p>å“¨å…µæ¨¡å¼å¯å‚è€ƒï¼š<a href="https://github.com/AliyunContainerService" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/AliyunContainerService</a></p>
<p>å¤šå®¹å™¨åˆ›å»ºredis cluster:</p>
<p>Dockerfile:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">ln</span> <span class="string">-sf</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">'Asia/Shanghai'</span> <span class="string">&gt;/etc/timezone</span></span><br><span class="line"></span><br><span class="line"><span class="string">EXPOSE</span> <span class="string">$REDIS_PORT</span></span><br><span class="line"><span class="comment"># EXPOSE $REDIS_PORT_NODE</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">entrypoint.sh</span> <span class="string">/usr/local/bin/</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">redis.conf</span> <span class="string">/usr/local/etc/</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="number">777</span> <span class="string">/usr/local/etc/redis.conf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/bin/entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENTRYPOINT</span> <span class="string">["/usr/local/bin/entrypoint.sh"]</span></span><br><span class="line"><span class="string">CMD</span> <span class="string">["redis-server",</span> <span class="string">"/usr/local/etc/redis.conf"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>redis.conf:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#ç«¯å£</span><br><span class="line">port REDIS_PORT</span><br><span class="line">#å¼€å¯é›†ç¾¤</span><br><span class="line">cluster-enabled yes</span><br><span class="line">#é…ç½®æ–‡ä»¶</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">#æ›´æ–°æ“ä½œåè¿›è¡Œæ—¥å¿—è®°å½•</span><br><span class="line">appendonly yes</span><br><span class="line">#è®¾ç½®ä¸»æœåŠ¡çš„è¿æ¥å¯†ç </span><br><span class="line"># masterauth</span><br><span class="line">#è®¾ç½®ä»æœåŠ¡çš„è¿æ¥å¯†ç </span><br><span class="line"># requirepass</span><br></pre></td></tr></table></figure>
<p>docker-compose.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">redis1:</span></span><br><span class="line"> <span class="attr">image:</span> <span class="string">redis-cluster</span></span><br><span class="line"> <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"> <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">/data/redis-cluster/6381/data:/data</span></span><br><span class="line"> <span class="attr">environment:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">REDIS_PORT=6381</span></span><br><span class="line"> <span class="attr">ports:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">'6381:6381'</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">'16381:16381'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…¶ä½™5ä¸ªä¾æ¬¡å¯å®š6382</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">redis6:</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼Œå…¶å®å¯ä»¥è®©6ä¸ªå®¹å™¨éƒ½ä¿æŒé»˜è®¤6379ç«¯å£ï¼Œä½†å®¿ä¸»æœºç«¯å£ä¸èƒ½é‡å¤ã€‚</p>
<p>cluster.shï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">para=<span class="string">""</span></span><br><span class="line">port=6380</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 6`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  ipaddr=$(docker inspect redis-cluster_redis<span class="variable">$&#123;i&#125;</span>_1 |jq <span class="string">'.[0].NetworkSettings.Networks.bridge.IPAddress'</span> |sed <span class="string">'s/\"//g'</span>)</span><br><span class="line">  <span class="built_in">let</span> port=port+1</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$ipaddr</span>:<span class="variable">$port</span></span><br><span class="line">  para=<span class="string">"<span class="variable">$para</span> <span class="variable">$ipaddr</span>:<span class="variable">$port</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line">docker run --rm -it inem0o/redis-trib create --replicas 1 <span class="variable">$para</span></span><br></pre></td></tr></table></figure>
<p>entrypoint.shï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"></span><br><span class="line"><span class="comment"># allow the container to be started with `--user`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">'redis-server'</span> -a <span class="string">"<span class="variable">$(id -u)</span>"</span> = <span class="string">'0'</span> ]; <span class="keyword">then</span></span><br><span class="line">    sed -i <span class="string">'s/REDIS_PORT/'</span><span class="variable">$REDIS_PORT</span><span class="string">'/g'</span> /usr/<span class="built_in">local</span>/etc/redis.conf</span><br><span class="line">    chown -R redis .</span><br><span class="line">    <span class="built_in">exec</span> gosu redis <span class="string">"<span class="variable">$0</span>"</span> <span class="string">"<span class="variable">$@</span>"</span>  <span class="comment">#gosuæ˜¯sudoè½»é‡çº§â€æ›¿ä»£å“â€</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>
<p>æ„å»ºã€å¯åŠ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost redis-cluster]# docker build -t redis-cluster .  </span><br><span class="line">[root@localhost redis-cluster]# docker-compose up -d</span><br><span class="line">[root@localhost redis-cluster]# docker-compose ps</span><br><span class="line">         Name                       Command               State                             Ports                           </span><br><span class="line">----------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">redis-cluster_redis1_1   /usr/local/bin/entrypoint. ...   Up      0.0.0.0:16381-&gt;16381/tcp, 6379/tcp, 0.0.0.0:6381-&gt;6381/tcp</span><br><span class="line">redis-cluster_redis2_1   /usr/local/bin/entrypoint. ...   Up      0.0.0.0:16382-&gt;16382/tcp, 6379/tcp, 0.0.0.0:6382-&gt;6382/tcp</span><br><span class="line">redis-cluster_redis3_1   /usr/local/bin/entrypoint. ...   Up      0.0.0.0:16383-&gt;16383/tcp, 6379/tcp, 0.0.0.0:6383-&gt;6383/tcp</span><br><span class="line">redis-cluster_redis4_1   /usr/local/bin/entrypoint. ...   Up      0.0.0.0:16384-&gt;16384/tcp, 6379/tcp, 0.0.0.0:6384-&gt;6384/tcp</span><br><span class="line">redis-cluster_redis5_1   /usr/local/bin/entrypoint. ...   Up      0.0.0.0:16385-&gt;16385/tcp, 6379/tcp, 0.0.0.0:6385-&gt;6385/tcp</span><br><span class="line">redis-cluster_redis6_1   /usr/local/bin/entrypoint. ...   Up      0.0.0.0:16386-&gt;16386/tcp, 6379/tcp, 0.0.0.0:6386-&gt;6386/tcp</span><br><span class="line">[root@localhost redis-cluster]# </span><br><span class="line">[root@localhost redis-cluster]# sh cluster.sh </span><br><span class="line">172.17.0.2:6381</span><br><span class="line">172.17.0.7:6382</span><br><span class="line">172.17.0.4:6383</span><br><span class="line">172.17.0.5:6384</span><br><span class="line">172.17.0.3:6385</span><br><span class="line">172.17.0.6:6386</span><br><span class="line">172.17.0.2:6381 172.17.0.7:6382 172.17.0.4:6383 172.17.0.5:6384 172.17.0.3:6385 172.17.0.6:6386</span><br><span class="line">WARNING: IPv4 forwarding is disabled. Networking will not work.</span><br><span class="line">&gt;&gt;&gt; Creating cluster</span><br><span class="line">&gt;&gt;&gt; Performing hash slots allocation on 6 nodes...</span><br><span class="line">Using 3 masters:</span><br><span class="line">172.17.0.2:6381</span><br><span class="line">172.17.0.7:6382</span><br><span class="line">172.17.0.4:6383</span><br><span class="line">Adding replica 172.17.0.5:6384 to 172.17.0.2:6381</span><br><span class="line">Adding replica 172.17.0.3:6385 to 172.17.0.7:6382</span><br><span class="line">Adding replica 172.17.0.6:6386 to 172.17.0.4:6383</span><br><span class="line">M: 0229502412d452827895d48428924ebfdef281c5 172.17.0.2:6381</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">M: 6e8a42258f6d8cdf77611f959665853a81e3bb87 172.17.0.7:6382</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">M: af21e289c4e1426777626fb5f07c26fcb02cf795 172.17.0.4:6383</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">S: 89335368454ba872d4d3ba814b3bbec116e993c6 172.17.0.5:6384</span><br><span class="line">   replicates 0229502412d452827895d48428924ebfdef281c5</span><br><span class="line">S: d1d295a8ece6ffa037ea1b721d036b91a6eef08c 172.17.0.3:6385</span><br><span class="line">   replicates 6e8a42258f6d8cdf77611f959665853a81e3bb87</span><br><span class="line">S: 6b26027dd63542d9b509ff7b0c9ba163891611a6 172.17.0.6:6386</span><br><span class="line">   replicates af21e289c4e1426777626fb5f07c26fcb02cf795</span><br><span class="line">Can I set the above configuration? (type &apos;yes&apos; to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting for the cluster to join.</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 172.17.0.2:6381)</span><br><span class="line">M: 0229502412d452827895d48428924ebfdef281c5 172.17.0.2:6381</span><br><span class="line">   slots:0-5460 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 6b26027dd63542d9b509ff7b0c9ba163891611a6 172.17.0.6:6386@16386</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates af21e289c4e1426777626fb5f07c26fcb02cf795</span><br><span class="line">S: 89335368454ba872d4d3ba814b3bbec116e993c6 172.17.0.5:6384@16384</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 0229502412d452827895d48428924ebfdef281c5</span><br><span class="line">S: d1d295a8ece6ffa037ea1b721d036b91a6eef08c 172.17.0.3:6385@16385</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 6e8a42258f6d8cdf77611f959665853a81e3bb87</span><br><span class="line">M: af21e289c4e1426777626fb5f07c26fcb02cf795 172.17.0.4:6383@16383</span><br><span class="line">   slots:10923-16383 (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 6e8a42258f6d8cdf77611f959665853a81e3bb87 172.17.0.7:6382@16382</span><br><span class="line">   slots:5461-10922 (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check for open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line">[root@localhost redis-cluster]#</span><br></pre></td></tr></table></figure>
<p>è¿æ¥redis1ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost redis-cluster]# docker run --rm -it redis redis-cli -h 172.17.0.2 -p 6381</span><br><span class="line">172.17.0.2:6381&gt; info replication</span><br><span class="line"># Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=172.17.0.5,port=6384,state=online,offset=322,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:7c24732ceeb781c3b3274395d92081c79f13364f</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:322</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:322</span><br><span class="line">172.17.0.2:6381&gt; </span><br><span class="line">172.17.0.2:6381&gt; </span><br><span class="line">172.17.0.2:6381&gt; cluster nodes</span><br><span class="line">6b26027dd63542d9b509ff7b0c9ba163891611a6 172.17.0.6:6386@16386 slave af21e289c4e1426777626fb5f07c26fcb02cf795 0 1636057597000 3 connected</span><br><span class="line">89335368454ba872d4d3ba814b3bbec116e993c6 172.17.0.5:6384@16384 slave 0229502412d452827895d48428924ebfdef281c5 0 1636057597299 1 connected</span><br><span class="line">0229502412d452827895d48428924ebfdef281c5 172.17.0.2:6381@16381 myself,master - 0 1636057597000 1 connected 0-5460</span><br><span class="line">d1d295a8ece6ffa037ea1b721d036b91a6eef08c 172.17.0.3:6385@16385 slave 6e8a42258f6d8cdf77611f959665853a81e3bb87 0 1636057598319 2 connected</span><br><span class="line">af21e289c4e1426777626fb5f07c26fcb02cf795 172.17.0.4:6383@16383 master - 0 1636057597000 3 connected 10923-16383</span><br><span class="line">6e8a42258f6d8cdf77611f959665853a81e3bb87 172.17.0.7:6382@16382 master - 0 1636057598726 2 connected 5461-10922</span><br><span class="line">172.17.0.2:6381&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/redis/image-20211105043729294.png" alt="image-20211105043729294" style="zoom: 80%;"></p>
<p>stop/restart redis1:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost redis-cluster]# docker-compose stop redis1</span><br><span class="line">Stopping redis-cluster_redis1_1 ... done</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/redis/image-20211105043827581.png" alt="image-20211105043827581" style="zoom:80%;"></p>
<p>master failä¸€ä¸ªï¼Œå¯¹åº”çš„slave 172.17.0.5:6384å˜æˆæ–°çš„masteräº†ã€‚</p>
<p>é‡æ–°ä¸Šçº¿redis1ï¼š172.17.0.5:6384ï¼Œå®ƒæ˜¯æ–°masterçš„slaveäº†ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/redis/image-20211105044630762.png" alt="image-20211105044630762" style="zoom:80%;"></p>
<hr>
<p>ï¼ˆå¾…ç»­ï¼‰</p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>HJ-02</title>
    <url>/2021/sh-coding/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>è®°å½•2ä¸ªHJæœºè¯•é¢˜çš„bashè§£æ³•<br>é”™è¯¯å½’å¹¶ã€å››èˆäº”å…¥</p>
</blockquote>
<a id="more"></a>
<h2 id="é”™è¯¯å½’å¹¶"><a href="#é”™è¯¯å½’å¹¶" class="headerlink" title="é”™è¯¯å½’å¹¶"></a>é”™è¯¯å½’å¹¶</h2><p>é¢˜ç›®ï¼šå¼€å‘ä¸€ä¸ªç®€å•é”™è¯¯è®°å½•åŠŸèƒ½å°æ¨¡å—ï¼Œèƒ½å¤Ÿè®°å½•å‡ºé”™çš„ä»£ç æ‰€åœ¨çš„æ–‡ä»¶åç§°å’Œè¡Œå·ã€‚</p>
<p>å¤„ç†ï¼š</p>
<ol>
<li>è®°å½•æœ€å¤š8æ¡é”™è¯¯è®°å½•ï¼Œå¾ªç¯è®°å½•ï¼Œæœ€ååªç”¨è¾“å‡ºæœ€åå‡ºç°çš„å…«æ¡é”™è¯¯è®°å½•ã€‚å¯¹ç›¸åŒçš„é”™è¯¯è®°å½•åªè®°å½•ä¸€æ¡ï¼Œä½†æ˜¯<strong>é”™è¯¯è®¡æ•°å¢åŠ ã€‚æœ€åä¸€ä¸ªæ–œæ åé¢çš„å¸¦åç¼€åçš„éƒ¨åˆ†ï¼ˆä¿ç•™æœ€å16ä½ï¼‰å’Œè¡Œå·å®Œå…¨åŒ¹é…çš„è®°å½•æ‰åšç®—æ˜¯â€ç›¸åŒâ€œçš„é”™è¯¯è®°å½•ã€‚</strong></li>
<li>è¶…è¿‡16ä¸ªå­—ç¬¦çš„æ–‡ä»¶åç§°ï¼Œåªè®°å½•æ–‡ä»¶çš„æœ€åæœ‰æ•ˆ16ä¸ªå­—ç¬¦ã€‚</li>
<li>è¾“å…¥çš„æ–‡ä»¶å¯èƒ½å¸¦è·¯å¾„ï¼Œè®°å½•æ–‡ä»¶åç§°ä¸èƒ½å¸¦è·¯å¾„ã€‚<strong>ä¹Ÿå°±æ˜¯è¯´ï¼Œå“ªæ€•ä¸åŒè·¯å¾„ä¸‹çš„æ–‡ä»¶ï¼Œå¦‚æœå®ƒä»¬çš„åå­—çš„å16ä¸ªå­—ç¬¦ç›¸åŒï¼Œä¹Ÿè¢«è§†ä¸ºç›¸åŒçš„é”™è¯¯è®°å½•ã€‚</strong></li>
<li>å¾ªç¯è®°å½•æ—¶ï¼Œåªä»¥ç¬¬ä¸€æ¬¡å‡ºç°çš„é¡ºåºä¸ºå‡†ï¼Œåé¢é‡å¤çš„ä¸ä¼šæ›´æ–°å®ƒçš„å‡ºç°æ—¶é—´ï¼Œä»ä»¥ç¬¬ä¸€æ¬¡ä¸ºå‡†ã€‚</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ç¤ºä¾‹è¾“å…¥ï¼š</span><br><span class="line">D:\zwtymj\xccb\ljj\cqzlyaszjvlsjmkwoqijggmybr 645</span><br><span class="line">E:\je\rzuwnjvnuz 633</span><br><span class="line">C:\km\tgjwpb\gy\atl 637</span><br><span class="line">F:\weioj\hadd\connsh\rwyfvzsopsuiqjnr 647</span><br><span class="line">E:\ns\mfwj\wqkoki\eez 648</span><br><span class="line">D:\cfmwafhhgeyawnool 649</span><br><span class="line">E:\czt\opwip\osnll\c 637</span><br><span class="line">G:\nt\f 633</span><br><span class="line">F:\fop\ywzqaop 631</span><br><span class="line">F:\yay\jc\ywzqaop 631</span><br><span class="line"></span><br><span class="line">è¾“å‡ºï¼š</span><br><span class="line">rzuwnjvnuz 633 1</span><br><span class="line">atl 637 1</span><br><span class="line">rwyfvzsopsuiqjnr 647 1</span><br><span class="line">eez 648 1</span><br><span class="line">fmwafhhgeyawnool 649 1</span><br><span class="line">c 637 1</span><br><span class="line">f 633 1</span><br><span class="line">ywzqaop 631 2</span><br></pre></td></tr></table></figure>
<p>shellè§£æ³•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">txt=$(cat)</span><br><span class="line">fname_row_uniq_count=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$txt</span>"</span> |sed <span class="string">'s/^.*\\//'</span> |awk <span class="string">'&#123;print substr($1,length($1)-15)" "$2&#125;'</span> |sort |uniq -c)</span><br><span class="line">fname_row_sorted_latest8=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$txt</span>"</span> |sed <span class="string">'s/^.*\\//'</span> |awk <span class="string">'&#123;t=substr($1,length($1)-15)" "$2; if(a[t]!=1) &#123;a[t]=1; print t;&#125;&#125;'</span> |tail -n8)</span><br><span class="line"></span><br><span class="line">IFS=$<span class="string">'\n'</span></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> <span class="variable">$fname_row_sorted_latest8</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"<span class="variable">$fname_row_uniq_count</span>"</span> |grep -E <span class="string">"^\s*[0-9]+\s<span class="variable">$line</span>$"</span> |awk <span class="string">'&#123;print $2" "$3" "$1&#125;'</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$fname_row_sorted_latest8</span>"</span> |awk -v vline=<span class="string">"`echo "</span><span class="variable">$fname_row_uniq_count</span><span class="string">" |sed 's/^/echo /'`"</span> <span class="string">'BEGIN&#123;while(vline |getline) d[$2" "$3]=$1;&#125; &#123;print $0" "d[$0];&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="å››èˆäº”å…¥"><a href="#å››èˆäº”å…¥" class="headerlink" title="å››èˆäº”å…¥"></a>å››èˆäº”å…¥</h2><p>é¢˜ç›®ï¼šè¾“å…¥ä¸€ä¸ªæ­£çš„å°æ•°ï¼Œè¾“å‡ºå››èˆäº”å…¥ç»“æœ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># S0:</span></span><br><span class="line"><span class="built_in">read</span> a</span><br><span class="line">b=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$a</span>"</span> |cut -d. -f1)</span><br><span class="line">b2=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$a</span>"</span> |cut -d. -f2)</span><br><span class="line">[ <span class="string">"<span class="variable">$&#123;b2:0:1&#125;</span>"</span> -ge 5 ] &amp;&amp; <span class="built_in">echo</span> $((b+1)) || <span class="built_in">echo</span> <span class="variable">$b</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># S1:</span></span><br><span class="line">IFS=. <span class="built_in">read</span> b b2</span><br><span class="line">[ <span class="string">"<span class="variable">$&#123;b2:0:1&#125;</span>"</span> -ge 5 ] &amp;&amp; <span class="built_in">echo</span> $((b+1)) || <span class="built_in">echo</span> <span class="variable">$b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># S2:</span></span><br><span class="line"><span class="built_in">read</span> a</span><br><span class="line">b=<span class="variable">$&#123;a%.*&#125;</span></span><br><span class="line">b2=<span class="variable">$&#123;a#*.&#125;</span></span><br><span class="line">[ <span class="string">"<span class="variable">$&#123;b2:0:1&#125;</span>"</span> -ge 5 ] &amp;&amp; <span class="built_in">echo</span> $((b+1)) || <span class="built_in">echo</span> <span class="variable">$b</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># S4: ç‰¹åˆ«è§£æ³•</span></span><br><span class="line"><span class="built_in">read</span> a</span><br><span class="line"><span class="built_in">printf</span> <span class="string">"%.0f"</span> <span class="string">"<span class="variable">$a</span>"</span>1  <span class="comment"># 4.5æ˜¯ç‰¹ä¾‹ï¼Œç»“æœä¸æ˜¯5ï¼Œè€Œæ˜¯4ï¼›ç”±äºéƒ½æ˜¯å°æ•°ï¼Œä¸€å¾‹æœ«å°¾åŠ ä¸€ä¸ª1 å¯é˜²æ­¢4.5=4</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>è·¯çº¿äº¤ç‚¹</title>
    <url>/2022/java-coding/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>å°è½¦ä»åŸç‚¹ï¼ˆ0ï¼Œ0ï¼‰å‡ºå‘ï¼ŒNã€Eã€Wã€Såˆ†åˆ«è¡¨ç¤ºå‘åŒ—/ä¸œ/å—/è¥¿èµ°ä¸€æ­¥ã€‚<br>ç¤ºä¾‹å›¾ä¸ºæŒ‰<strong>NNEESWWWNES</strong>è¡Œé©¶åçš„è·¯çº¿ï¼Œå…±æœ‰2ä¸ªäº¤ç‚¹ã€‚</p>
<p>è¾“å…¥ï¼šNEWSç»„æˆçš„å­—ç¬¦ä¸²<br>è¾“å‡ºï¼šäº¤ç‚¹çš„ä¸ªæ•°</p>
</blockquote>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2022/image-20220220232653933.png" alt="image-20220220232653933"></p>
<a id="more"></a>
<h2 id="ä¸€"><a href="#ä¸€" class="headerlink" title="ä¸€"></a>ä¸€</h2><p>ä¸è€ƒè™‘æ–¹å‘ï¼ŒåŒå‘å¤šæ¬¡ç»è¿‡åŒä¸€ä¸ªç‚¹å³è®¤ä¸ºæ˜¯äº¤ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Crossing</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] main)</span> </span>&#123;</span><br><span class="line">        Solution solution = <span class="keyword">new</span> Solution();</span><br><span class="line">        <span class="keyword">int</span> n = solution.getCrossingNum(<span class="string">"NWSEN"</span>);</span><br><span class="line">        System.out.println(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCrossingNum</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>, d;</span><br><span class="line">        Map&lt;Point, Integer&gt; points = walk(s);</span><br><span class="line">        <span class="keyword">for</span> (Point p : points.keySet()) &#123;</span><br><span class="line">            d = points.get(p);</span><br><span class="line">            <span class="keyword">if</span> (d &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Point, Integer&gt; <span class="title">walk</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Map&lt;Point, Integer&gt; points = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Point p0 = <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> ch : s.toCharArray()) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'N'</span>:</span><br><span class="line">                    p0.y += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'E'</span>:</span><br><span class="line">                    p0.x += <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">                    p0.y -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> <span class="string">'W'</span>:</span><br><span class="line">                    p0.x -= <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            Point p = <span class="keyword">new</span> Point(p0.x, p0.y);</span><br><span class="line">            <span class="keyword">if</span> (points.containsKey(p)) &#123;</span><br><span class="line">                points.put(p, points.get(p) + <span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                points.put(p, <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> points;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Point</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        Point Point = (Point) o;</span><br><span class="line">        <span class="keyword">return</span> x == Point.x &amp;&amp; y == Point.y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(x, y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"[%d,%d]"</span>, x, y);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="äºŒ"><a href="#äºŒ" class="headerlink" title="äºŒ"></a>äºŒ</h2><p>è€ƒè™‘æ–¹å‘ï¼Œä»2ä¸ªä»¥ä¸Šä¸åŒæ–¹å‘ç»è¿‡åŒä¸€ç‚¹ä¸ºäº¤ç‚¹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> top.zlz.practise.cross4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Crossing</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] main)</span> </span>&#123;</span><br><span class="line">        Solution solution = <span class="keyword">new</span> Solution();</span><br><span class="line">        <span class="keyword">int</span> n = solution.getCrossingNum(<span class="string">"NWSENEEWW"</span>);</span><br><span class="line">        System.out.println(<span class="string">"crossing: "</span> + n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCrossingNum</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        Map&lt;Point, Point&gt; points = walk(s);</span><br><span class="line">        <span class="keyword">for</span> (Point p : points.keySet()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (p.isCrossing()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"cross at: "</span> + p);</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;Point, Point&gt; <span class="title">walk</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Map&lt;Point, Point&gt; points = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        Map&lt;Character, <span class="keyword">int</span>[]&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">'N'</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>&#125;);</span><br><span class="line">        map.put(<span class="string">'S'</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0</span>, -<span class="number">1</span>, <span class="number">4</span>&#125;);</span><br><span class="line">        map.put(<span class="string">'E'</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">1</span>, <span class="number">0</span>, <span class="number">2</span>&#125;);</span><br><span class="line">        map.put(<span class="string">'W'</span>, <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">8</span>&#125;);</span><br><span class="line">        Point p0 = <span class="keyword">new</span> Point(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">char</span> ch : s.toCharArray()) &#123;</span><br><span class="line">            p0.x += map.get(ch)[<span class="number">0</span>];</span><br><span class="line">            p0.y += map.get(ch)[<span class="number">1</span>];</span><br><span class="line">            p0.din = map.get(ch)[<span class="number">2</span>];</span><br><span class="line"><span class="comment">//            switch (ch) &#123;</span></span><br><span class="line"><span class="comment">//                case 'N':</span></span><br><span class="line"><span class="comment">//                    p0.y += 1;</span></span><br><span class="line"><span class="comment">//                    p0.din = 1;</span></span><br><span class="line"><span class="comment">//                    break;</span></span><br><span class="line"><span class="comment">//                case 'E':</span></span><br><span class="line"><span class="comment">//                    p0.x += 1;</span></span><br><span class="line"><span class="comment">//                    p0.din = 2;</span></span><br><span class="line"><span class="comment">//                    break;</span></span><br><span class="line"><span class="comment">//                case 'S':</span></span><br><span class="line"><span class="comment">//                    p0.y -= 1;</span></span><br><span class="line"><span class="comment">//                    p0.din = 4;</span></span><br><span class="line"><span class="comment">//                    break;</span></span><br><span class="line"><span class="comment">//                case 'W':</span></span><br><span class="line"><span class="comment">//                    p0.x -= 1;</span></span><br><span class="line"><span class="comment">//                    p0.din = 8;</span></span><br><span class="line"><span class="comment">//                    break;</span></span><br><span class="line"><span class="comment">//            &#125;</span></span><br><span class="line">            Point p = <span class="keyword">new</span> Point(p0.x, p0.y, p0.din);</span><br><span class="line">            <span class="keyword">if</span> (points.containsKey(p)) &#123;</span><br><span class="line">                points.get(p).din |= p.din;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                points.put(p, p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> points;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> x;</span><br><span class="line">    <span class="keyword">int</span> y;</span><br><span class="line">    <span class="keyword">int</span> din;  <span class="comment">//1 2 4 8 -&gt; N E S W; 3=1+2=NE; 7=NES; 15=NESW</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Point</span><span class="params">(<span class="keyword">int</span> x, <span class="keyword">int</span> y, <span class="keyword">int</span> din)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">        <span class="keyword">this</span>.din = din;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCrossing000</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getD() &gt;= <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCrossing</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] notCrossingDinSumArr = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">10</span>&#125;;  <span class="comment">//5,10 åŒä¸€æ¡ç›´çº¿ç›¸å¯¹è¡Œé©¶è¿‡çš„ç‚¹ï¼Œä¸è®¤ä¸ºæ˜¯äº¤ç‚¹ï¼Œå› ä¸ºä¸æ˜¯å‚ç›´ç›¸äº¤</span></span><br><span class="line"><span class="comment">//        int[] notCrossingDinSumArr = &#123;0, 1, 2, 4, 8&#125;;  //ä¸è€ƒè™‘æ˜¯å¦å‚ç›´ç›¸äº¤</span></span><br><span class="line">        <span class="keyword">return</span> Arrays.binarySearch(notCrossingDinSumArr, din) &lt; <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* æœªä½¿ç”¨ */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getD</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> i = din;</span><br><span class="line"><span class="comment">//        while (i != 0) &#123;</span></span><br><span class="line"><span class="comment">//            i = i &amp; (i - 1);</span></span><br><span class="line"><span class="comment">//            count++;</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line">        <span class="keyword">while</span> (i != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((i &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">            i = i &gt;&gt; <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        Point Point = (Point) o;</span><br><span class="line">        <span class="keyword">return</span> x == Point.x &amp;&amp; y == Point.y;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Objects.hash(x, y);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"[%d,%d,%d]"</span>, x, y, din);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¿®å¤github pages CI</title>
    <url>/cicd/github-actions/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>Travis CI æ”¹ç‰ˆåæ­¤å‰é…ç½®çš„CIå‡ºé—®é¢˜äº†ï¼ŒåŠ ä¸Šæœ‰10000 <em>credits</em> (1000 linux build minutes)çš„é™åˆ¶ï¼Œç°æ”¹ç”¨github actionsæ„å»ºgithub pages</p>
<p>github actionsçš„workflowæ–‡ä»¶å†™æ³•ï¼Œç±»ä¼¼äºgitlabçš„.gitlab-ci.ymlï¼Œè¯¦è§<a href="https://docs.github.com/en/actions/reference/workflow-syntax-for-github-actions" rel="external nofollow noopener noreferrer" target="_blank">å®˜æ–¹æ–‡æ¡£</a></p>
</blockquote>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/github-actions/image-20210906012604864.png" alt="image-20210906012604864"></p>
<a id="more"></a>
<p>åªåˆ’åˆ†äº†ä¸€ä¸ªstage: <code>update gitbook docs</code>ï¼Œæ‰€ä»¥ä¸Šå›¾åªæœ‰ä¸€ä¸ªpiplineæ ‡ç­¾ã€‚å…¶ä¸­ï¼ŒåŒ…å«3ä¸ªstep:</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/github-actions/image-20210906020757779.png" alt="image-20210906020757779"></p>
<p>.github/workflows/ruby.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">Ruby</span></span><br><span class="line"></span><br><span class="line"><span class="attr">on:</span></span><br><span class="line">  <span class="attr">push:</span></span><br><span class="line">    <span class="attr">branches:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">master</span></span><br><span class="line"></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line"></span><br><span class="line"><span class="attr">jobs:</span></span><br><span class="line">  <span class="attr">update-docs:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">update</span> <span class="string">gitbook</span> <span class="string">docs</span></span><br><span class="line">    <span class="attr">runs-on:</span> <span class="string">ubuntu-latest</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">steps:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">1</span><span class="string">.</span> <span class="string">checkout</span></span><br><span class="line">      <span class="attr">uses:</span> <span class="string">actions/checkout@v2</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">2</span><span class="string">.</span> <span class="string">gitbook</span> <span class="string">build</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">rm</span> <span class="string">-rf</span> <span class="string">_book</span> <span class="string">||</span> <span class="string">exit</span> <span class="number">0</span></span><br><span class="line">        <span class="string">docker</span> <span class="string">run</span> <span class="string">--rm</span> <span class="string">-v</span> <span class="string">"$(pwd):/opt/data"</span> <span class="string">lzzeng/node-gitbook-cli:alpine</span> <span class="string">sh</span> <span class="string">-c</span> <span class="string">"gitbook install &amp;&amp; gitbook build"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="number">3</span><span class="string">.</span> <span class="string">push</span> <span class="string">to</span> <span class="string">github</span> <span class="string">pages</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="attr">GIT_DEPLOY_REPO:</span> <span class="string">https://$&#123;&#123;</span> <span class="string">secrets.TOKEN</span> <span class="string">&#125;&#125;@github.com/lzzeng/docs.git</span></span><br><span class="line">        <span class="attr">GIT_DEPLOY_DIR:</span> <span class="string">_book</span></span><br><span class="line">        <span class="attr">GIT_DEPLOY_BRANCH:</span> <span class="string">gh-pages</span></span><br><span class="line">        <span class="attr">GIT_DEPLOY_USERNAME:</span> <span class="string">lzzeng</span></span><br><span class="line">      <span class="attr">run:</span> <span class="string">|</span></span><br><span class="line">        <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">"$<span class="template-variable">&#123;&#123; secrets.EMAIL &#125;&#125;</span>"</span></span><br><span class="line">        <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">"$&#123;GIT_DEPLOY_USERNAME&#125;"</span></span><br><span class="line">        <span class="string">cd</span> <span class="string">_book</span></span><br><span class="line">        <span class="string">sudo</span> <span class="string">git</span> <span class="string">init</span></span><br><span class="line">        <span class="string">sudo</span> <span class="string">git</span> <span class="string">add</span> <span class="string">.</span></span><br><span class="line">        <span class="string">sudo</span> <span class="string">git</span> <span class="string">commit</span> <span class="string">-m</span> <span class="string">"update gh-pages"</span></span><br><span class="line">        <span class="string">sudo</span> <span class="string">git</span> <span class="string">push</span> <span class="string">--force</span> <span class="string">--quiet</span> <span class="string">"$&#123;GIT_DEPLOY_REPO&#125;"</span> <span class="string">master:$&#123;GIT_DEPLOY_BRANCH&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä»“åº“settingsï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/github-actions/image-20210906021036380.png" alt="image-20210906021036380"></p>
<p>å‘å¸ƒåçš„æ•ˆæœï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/github-actions/image-20210906023044703.png" alt="image-20210906023044703"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>CICD</tag>
        <tag>Github</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitlab CI -- gitlab ci é…ç½®æ–‡ä»¶ä¸€ä¾‹</title>
    <url>/cicd/gitlab-cicd/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p><a href="https://docs.gitlab.com/ce/ci/" rel="external nofollow noopener noreferrer" target="_blank"><strong>GitLab CI/CD</strong></a>æ˜¯GitLabå†…ç½®çš„å·¥å…·ï¼Œç”¨äºé¡¹ç›®æŒç»­é›†æˆã€æŒç»­éƒ¨ç½²ã€‚GitLab CI/CD ç”±ä½äºä»£ç ä»“åº“æ ¹ç›®å½•çš„åä¸º<strong>.gitlab-ci.yml</strong>çš„æ–‡ä»¶é…ç½®ã€‚è€Œæ­¤æ–‡ä»¶ä¸­è®¾ç½®çš„è„šæœ¬ç”±GitLab Runneræ‰§è¡Œã€‚</p>
<p>Gitlab CI ï¼ˆæŒç»­é›†æˆï¼‰è‡ªåŠ¨æ„å»ºä»»åŠ¡éœ€ç¼–å†™é…ç½®æ–‡ä»¶ .gitlab-ci.yml</p>
</blockquote>
<a id="more"></a>
<p><a href="http://git.pro.keep.com/devops/docs" rel="external nofollow noopener noreferrer" target="_blank">æœ¬ä¹¦</a> é€šè¿‡GitLab CI/CDè‡ªåŠ¨å‘å¸ƒï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/cicd.assets/1561299107170.png" alt="Gitlab CI"></p>
<p>ä»¥æœ¬ä¹¦çš„.gitlab-ci.ymlä¸ºä¾‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">build</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">deploy</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">docker:stable</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">build</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dind-v19</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">info</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">image_name=lzzeng/docs:latest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">build</span> <span class="string">-t</span> <span class="string">$image_name</span> <span class="string">.</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">login</span> <span class="string">-u</span> <span class="string">$docker_hub_user</span> <span class="string">-p</span> <span class="string">$docker_hub_pass</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">docker</span> <span class="string">push</span> <span class="string">$image_name</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">master</span> <span class="comment"># this job will affect only the 'master' branch</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ansible-docker:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">ansible-alpine:2.8.0</span></span><br><span class="line">  <span class="attr">stage:</span> <span class="string">deploy</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">dind-v19</span></span><br><span class="line">  <span class="attr">script:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">"GITBOOK_HOST is $GITBOOK_HOST_DEV"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">"$SSH_PRIVATE_KEY_DEV"</span> <span class="string">&gt;</span> <span class="string">~/.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">chmod</span> <span class="number">600</span> <span class="string">~/.key</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">echo</span> <span class="string">"$ANSIBLE_CFG_CONTENT"</span> <span class="string">&gt;</span> <span class="string">~/.ansible.cfg</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ansible-playbook</span> <span class="string">-i</span> <span class="string">"$GITBOOK_HOST_DEV,"</span> <span class="string">--private-key</span> <span class="string">~/.key</span> <span class="string">-u</span> <span class="string">root</span> <span class="string">deploy/inDocker.yml</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œ</p>
<ul>
<li><p>stages æ®µè½è¡¨ç¤ºæœ‰ æœ‰ä¸¤ä¸ªæ„å»ºé˜¶æ®µï¼Œæ ‡è¯†åˆ†åˆ«æ˜¯build å’Œ deploy</p>
</li>
<li><p>buildæ®µè½ï¼ŒstageåŸŸï¼ˆæˆ–å±æ€§ï¼‰çš„å€¼ä¸º build, è¡¨ç¤ºè¿™æ®µè„šæœ¬æ˜¯ä¸Šè¿°buildçš„å…·ä½“æ‰§è¡Œè¿‡ç¨‹</p>
</li>
<li><p>tagsåŸŸä¸º dind-v19ï¼Œ è¡¨ç¤ºæœ¬é˜¶æ®µæ„å»ºé€‰æ‹©tagä¸ºdind-v19çš„gitlab runnerï¼Œè¿™æ˜¯äº‹å…ˆå·²æ³¨å†Œçš„ä¸€ä¸ªå…è®¸æ„å»ºdockeré•œåƒçš„æ‰§è¡Œå™¨ï¼Œä¸”è¿™ä¸ªæ‰§è¡Œå™¨è‡ªèº«ä¹Ÿæ˜¯dockerå®¹å™¨ï¼Œå³ docker in docker (dindï¼‰</p>
</li>
<li><p>buildçš„scriptæ®µï¼šdocker build æ„å»ºé•œåƒ -&gt; docker login ç™»å½•Docker Hub-&gt; docker push æ¨é€é•œåƒè‡³Docker Hub</p>
</li>
<li><p>only master è¡¨ç¤ºåªæ¥å—masteråˆ†æ”¯æ›´æ–°åè§¦å‘CI</p>
</li>
<li><p>ansible-dockeré˜¶æ®µçš„ä½œç”¨æ˜¯è¿œç¨‹ç™»å½•ç›®æ ‡æœºå™¨æ‹‰å–é•œåƒã€åˆ›å»ºå¹¶è¿è¡Œå®¹å™¨</p>
</li>
</ul>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
        <tag>CICD</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitlab Runner</title>
    <url>/cicd/gitlab-runner/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>å¯åŠ¨gitlab-runnerï¼ˆæä¾›è‡ªåŠ¨åˆ›å»ºã€é”€æ¯runnerçš„æœåŠ¡ï¼‰</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run -d --name gitlab-runner --restart always \</span><br><span class="line">  -v /srv/gitlab-runner/config:/etc/gitlab-runner \</span><br><span class="line">  -v /var/run/docker.sock:/var/run/docker.sock \</span><br><span class="line">  gitlab/gitlab-runner:latest</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æ³¨å†Œrunner</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">gitlab-runner register -n \</span><br><span class="line">  --url http://gitlab.keep.com/ \</span><br><span class="line">  --registration-token your-token*** \</span><br><span class="line">  --executor docker \</span><br><span class="line">  --description <span class="string">"Docker in Docker Runner"</span> \</span><br><span class="line">  --docker-image alpine:latest \</span><br><span class="line">  --tag-list <span class="string">"dind-v19"</span></span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹æ³¨å†Œåç”Ÿæˆçš„/etc/gitlab-runner/config.tomlï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  name = "Docker in Docker Runner"</span><br><span class="line">  url = "http://gitlab.keep.com/"</span><br><span class="line">  token = "xxxxx"</span><br><span class="line">  executor = "docker"</span><br><span class="line">  <span class="section">[runners.custom_build_dir]</span></span><br><span class="line">  <span class="section">[runners.docker]</span></span><br><span class="line">    tls_verify = false</span><br><span class="line">    image = "alpine:latest"</span><br><span class="line">    privileged = false</span><br><span class="line">    disable_entrypoint_overwrite = false</span><br><span class="line">    oom_kill_disable = false</span><br><span class="line">    disable_cache = false</span><br><span class="line">    volumes = ["/cache"]</span><br><span class="line">    shm_size = 0</span><br><span class="line">  <span class="section">[runners.cache]</span></span><br><span class="line">    <span class="section">[runners.cache.s3]</span></span><br><span class="line">    <span class="section">[runners.cache.gcs]</span></span><br><span class="line">  <span class="section">[runners.custom]</span></span><br><span class="line">    run_exec = ""</span><br></pre></td></tr></table></figure>
<p>gitlab cicdæ—¥å¿—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Running with gitlab-runner 12.1.0 (de7731dd)</span><br><span class="line">  on Docker <span class="keyword">in</span> Docker Runner PdsMyiEk</span><br><span class="line">Using Docker executor with image docker:stable ...</span><br><span class="line">Pulling docker image docker:stable ...</span><br><span class="line">Using docker image sha256:9a38a85b1e4e7bb53b7c7cc45afff6ba7b1cdfe01b9738f36a3b4ad0cdb10b00 <span class="keyword">for</span> docker:stable ...</span><br><span class="line">Running on runner-PdsMyiEk-project-238-concurrent-0 via 521aa7f3c946...</span><br><span class="line">Fetching changes...</span><br><span class="line">Initialized empty Git repository <span class="keyword">in</span> /builds/devops/docs/.git/</span><br><span class="line">Created fresh repository.</span><br><span class="line">From http://lzzeng.keep.com/devops/docs</span><br><span class="line"></span><br><span class="line">- [new branch]      master     -&gt; origin/master</span><br><span class="line">  Checking out 78455dad as master...</span><br><span class="line"></span><br><span class="line">Skipping Git submodules setup</span><br><span class="line">$ docker info</span><br><span class="line">Client:</span><br><span class="line"> Debug Mode: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">ERROR: Cannot connect to the Docker daemon at tcp://docker:2375. Is the docker daemon running?</span><br><span class="line">errors pretty printing info</span><br><span class="line">ERROR: Job failed: <span class="built_in">exit</span> code 1</span><br></pre></td></tr></table></figure>
<p>è¦æ”¯æŒdocker in dockerï¼Œæ”¹ä¸ºï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[[runners]]</span></span><br><span class="line">  name = "Docker in Docker Runner"</span><br><span class="line">  url = "http://lzzeng.keep.com/"</span><br><span class="line">  token = "PdsMyiEkyfbPsVZgboPd"</span><br><span class="line">  executor = "docker"</span><br><span class="line">  <span class="section">[runners.custom_build_dir]</span></span><br><span class="line">  <span class="section">[runners.docker]</span></span><br><span class="line">    tls_verify = false</span><br><span class="line">    image = "alpine:latest"</span><br><span class="line">    privileged = true</span><br><span class="line">    disable_entrypoint_overwrite = false</span><br><span class="line">    oom_kill_disable = false</span><br><span class="line">    disable_cache = false</span><br><span class="line">    volumes = ["/cache", "/var/run/docker.sock:/var/run/docker.sock", "/etc/default/docker:/etc/default/docker", "/etc/docker/daemon.json:/etc/docker/daemon.json"]</span><br><span class="line">    shm_size = 0</span><br><span class="line">  <span class="section">[runners.cache]</span></span><br><span class="line">    <span class="section">[runners.cache.s3]</span></span><br><span class="line">    <span class="section">[runners.cache.gcs]</span></span><br><span class="line">  <span class="section">[runners.custom]</span></span><br><span class="line">    run_exec = ""</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
        <tag>CICD</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins API ä½¿ç”¨ç¤ºä¾‹â€”â€”shellç¯‡(2/2)</title>
    <url>/cicd/how-to-use-jenkins-api-in-shell-part2/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>ç¯å¢ƒï¼šJenkins V2.150.1</p>
<h3 id="è·å–æ‰€æœ‰jobåç§°"><a href="#è·å–æ‰€æœ‰jobåç§°" class="headerlink" title="è·å–æ‰€æœ‰jobåç§°"></a>è·å–æ‰€æœ‰jobåç§°</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è·å–crumb</span></span><br><span class="line">crumb=$(curl -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> <span class="variable">$jenkins_url</span>/crumbIssuer/api/xml?xpath=concat\(//crumbRequestField,%22:%22,//crumb\))</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–jobåˆ—è¡¨</span></span><br><span class="line">curl -sX GET <span class="string">"<span class="variable">$jenkins_url</span>/api/json?pretty=true"</span> -H <span class="string">"<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> |grep <span class="string">'"url"'</span> |grep <span class="string">'/job/'</span> |sed -e <span class="string">'s@^.*job/\(.*\)/.*$@\1@'</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng opt]#curl -sX GET 'http://188.131.xxx.xxx:8088/jenkins/api/json?pretty=true' -H Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx -u "<span class="formula">$jenkins_user:$</span>jenkins_password" |grep '"url"' |grep '/job/' |sed -e 's@^.*job/<span class="tag">\<span class="name">(</span></span>.*<span class="tag">\<span class="name">)</span></span>/.*<span class="formula">$@<span class="tag">\</span>1@'</span></span><br><span class="line"><span class="formula">test_job</span></span><br><span class="line"><span class="formula">test_job_with_parameter</span></span><br></pre></td></tr></table></figure>
<h3 id="æ„å»ºjob"><a href="#æ„å»ºjob" class="headerlink" title="æ„å»ºjob"></a>æ„å»ºjob</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ— å‚æ•°æ„å»º</span></span><br><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/job/<span class="variable">$job_name</span>/build"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"<span class="variable">$crumb</span>"</span></span><br><span class="line"><span class="comment"># å¸¦å‚æ•°æ„å»º</span></span><br><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/job/<span class="variable">$job_name</span>/buildWithParameters"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"<span class="variable">$crumb</span>"</span> -d <span class="variable">$parameter_name</span>=<span class="variable">$parameter_value</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng opt]# curl -sX POST http://188.131.xxx.xxx:8088/jenkins/job/test_job/build -u "<span class="formula">$jenkins_user:$</span>jenkins_password" -H Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx</span><br><span class="line">[root@lzzeng opt]# curl -sX POST http://188.131.xxx.xxx:8088/jenkins/job/test_job_with_parameter/buildWithParameters -u "<span class="formula">$jenkins_user:$</span>jenkins_password" -H Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx -d param1=/var -d param2=/srv</span><br><span class="line">[root@lzzeng opt]#</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹Jenkinsï¼Œå¯ä»¥çœ‹åˆ°å‚æ•°ä¼ é€’æ­£ç¡®ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2018/1546328035535.png" alt="1546328035535"></p>
<h3 id="ç¦ç”¨job"><a href="#ç¦ç”¨job" class="headerlink" title="ç¦ç”¨job"></a>ç¦ç”¨job</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/job/<span class="variable">$job_name</span>/disable"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"<span class="variable">$crumb</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng opt]# curl -sX POST http://188.131.xxx.xxx:8088/jenkins/job/test_job_with_parameter/disable -u "<span class="formula">$jenkins_user:$</span>jenkins_password" -H Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx</span><br><span class="line">[root@lzzeng opt]#</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2018/1546326537132.png" alt="1546326537132"></p>
<h3 id="è·å–æ„å»ºç»“æœ"><a href="#è·å–æ„å»ºç»“æœ" class="headerlink" title="è·å–æ„å»ºç»“æœ"></a>è·å–æ„å»ºç»“æœ</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æœ€è¿‘ä¸€æ¬¡æ„å»ºç»“æœ</span></span><br><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/job/<span class="variable">$job_name</span>/lastBuild/api/json?pretty=true"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"<span class="variable">$crumb</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„æ„å»ºç»“æœ</span></span><br><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/job/<span class="variable">$job_name</span>/lastSuccessfulBuild/api/json?pretty=true"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"<span class="variable">$crumb</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng opt]# curl -sX POST http://188.131.xxx.xxx:8088/jenkins/job/test_job_with_parameter/lastBuild/api/json?pretty=true -u "<span class="formula">$jenkins_user:$</span>jenkins_password" -H Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx</span><br></pre></td></tr></table></figure>
<p>å¦‚æœè¦è·å–æ’ä»¶çš„ç»“æœï¼Œå¯ä»¥å°è¯•æ·»åŠ è¯·æ±‚å‚æ•°<code>depth=2</code>ï¼Œå³å˜æˆ<code>api/json?pretty=true&amp;depth=2</code></p>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>CICD</tag>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins API ä½¿ç”¨ç¤ºä¾‹â€”â€”shellç¯‡(1/2)</title>
    <url>/cicd/how-to-use-jenkins-api-in-shell/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>ç¯å¢ƒï¼šJenkins V2.150.1</p>
<h3 id="æ£€æµ‹Jobæ˜¯å¦å­˜åœ¨"><a href="#æ£€æµ‹Jobæ˜¯å¦å­˜åœ¨" class="headerlink" title="æ£€æµ‹Jobæ˜¯å¦å­˜åœ¨"></a>æ£€æµ‹Jobæ˜¯å¦å­˜åœ¨</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -X POST [-H <span class="string">"Content-Type:application/xml"</span>] <span class="string">"<span class="variable">$jenkins_url</span>/checkJobName?value=<span class="variable">$job_name</span>"</span> --user <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œjenkins_passwordä¸€èˆ¬æ˜¯ä½¿ç”¨jenkins_userçš„Jenkins API tokenï¼Œç›´æ¥ç”¨å¯†ç ä¹Ÿå¯ä»¥ã€‚</p>
<a id="more"></a>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng ~]# curl -X POST -H "Content-Type:application/xml" "http://188.131.xxx.xxx:8088/jenkins/checkJobName?value=test_job" --user "<span class="formula">$jenkins_user:$</span>jenkins_password"</span><br><span class="line">&lt;!doctype html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;title&gt;HTTP Status 403 â€“ Forbidden&lt;/title&gt;...&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 403 â€“ Forbidden&lt;/h1&gt;&lt;hr class="line" /&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt; Status Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Message&lt;/b&gt; No valid crumb was included in the request&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt; The server understood the request but refuses to authorize it.&lt;/p&gt;&lt;hr class="line" /&gt;&lt;h3&gt;Apache Tomcat/9.0.14&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç¤º<code>HTTP Status 403 â€“ Forbidden</code>ï¼ŒåŸå› æ˜¯Jenkinså¼€å¯äº†<code>Prevent Cross Site Request Forgery exploits</code>ï¼Œå³<code>é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ </code>ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2018/1546149521653.png" alt="1546149521653"></p>
<p>å–æ¶ˆå‹¾é€‰ï¼Œé‡è¯•ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng ~]# curl -X POST -H "Content-Type:application/xml" "http://188.131.xxx.xxx:8088/jenkins/checkJobName?value=test_job" --user "<span class="formula">$jenkins_user:$</span>jenkins_password"</span><br><span class="line">&lt;div class=error&gt;&lt;img src='/jenkins/static/141801f8/images/none.gif' height=16 width=1&gt;A job already exists with the name â€˜test_jobâ€™&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼ŒJenkinsä¸Šå·²å­˜åœ¨åç§°ä¸º<code>test_job</code>çš„jobã€‚</p>
<p>å¦‚æœæ£€æµ‹çš„jobä¸å­˜åœ¨ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng ~]# curl -X POST -H "Content-Type:application/xml" "http://188.131.xxx.xxx:8088/jenkins/checkJobName?value=test_job222" --user "<span class="formula">$jenkins_user:$</span>jenkins_password"</span><br><span class="line">&lt;div/&gt;[root@lzzeng ~]#</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºä¸ºï¼š<code>&lt;div/&gt;</code>ã€‚</p>
<h3 id="æ£€æµ‹Viewæ˜¯å¦å­˜åœ¨"><a href="#æ£€æµ‹Viewæ˜¯å¦å­˜åœ¨" class="headerlink" title="æ£€æµ‹Viewæ˜¯å¦å­˜åœ¨"></a>æ£€æµ‹Viewæ˜¯å¦å­˜åœ¨</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -X POST [-H <span class="string">"Content-Type:application/xml"</span>] <span class="string">"<span class="variable">$jenkins_url</span>/checkViewName?value=<span class="variable">$view_name</span>"</span> --user <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng ~]# curl -X POST -H "Content-Type:application/xml" "http://188.131.xxx.xxx:8088/jenkins/checkViewName?value=test_view" --user "<span class="formula">$jenkins_user:$</span>jenkins_password"</span><br><span class="line">&lt;div class=error&gt;&lt;img src='/jenkins/static/141801f8/images/none.gif' height=16 width=1&gt;A view already exists with the name &amp;quot;test_view&amp;quot;&lt;/div&gt;[root@lzzeng ~]#</span><br></pre></td></tr></table></figure>
<p>å½“viewä¸å­˜åœ¨æ—¶ï¼Œå’Œjobä¸å­˜åœ¨ä¸€æ ·ä¹Ÿæ˜¯è¾“å‡ºï¼š<code>&lt;div/&gt;</code>ã€‚</p>
<p>æ®æ­¤ï¼Œç¼–å†™ä¸€æ®µè„šæœ¬ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">checkJobView</span></span>()&#123;</span><br><span class="line">    <span class="comment"># Usage: </span></span><br><span class="line">    <span class="comment"># 1. checkJobView "job/&lt;job_name&gt;"</span></span><br><span class="line">    <span class="comment"># 2. checkJobView "view/&lt;view_name&gt;"</span></span><br><span class="line"></span><br><span class="line">    para=<span class="variable">$1</span></span><br><span class="line">    prefix=<span class="variable">$&#123;para%%/*&#125;</span></span><br><span class="line">    target=<span class="variable">$&#123;para##*/&#125;</span></span><br><span class="line">    method=$([ <span class="string">"<span class="variable">$prefix</span>"</span> = <span class="string">"job"</span> ] &amp;&amp; <span class="built_in">echo</span> checkJobName || <span class="built_in">echo</span> checkViewName)</span><br><span class="line">    crumb=$(curl -s -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> <span class="variable">$jenkins_url</span>/crumbIssuer/api/xml?xpath=concat\(//crumbRequestField,%22:%22,//crumb\))</span><br><span class="line">    resp=$(curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/<span class="variable">$method</span>?value=<span class="variable">$target</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"<span class="variable">$crumb</span>"</span>)</span><br><span class="line">    <span class="built_in">test</span> <span class="string">"<span class="variable">$resp</span>"</span> != <span class="string">"&lt;div/&gt;"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä½œå¦‚ä¸‹è°ƒç”¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">jenkins_url=http://188.131.xxx.xxx:8088/jenkins</span><br><span class="line">jenkins_user=<span class="variable">$jenkins_user</span></span><br><span class="line">jenkins_password=<span class="variable">$jenkins_password</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> checkJobView <span class="variable">$@</span>; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"exists"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"not exist"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>è„šæœ¬æ–‡ä»¶åä¸ºcheckJobView.shï¼Œæµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng opt]# sh checkJobView.sh view/test_view</span><br><span class="line">exists</span><br><span class="line">[root@lzzeng opt]# sh checkJobView.sh view/test_view222</span><br><span class="line">not exist</span><br><span class="line">[root@lzzeng opt]# sh checkJobView.sh job/test_job</span><br><span class="line">exists</span><br><span class="line">[root@lzzeng opt]# sh checkJobView.sh job/test_job222</span><br><span class="line">not exist</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ï¼Œtest_viewæ˜¯å·²å­˜åœ¨çš„è§†å›¾ï¼Œtest_jobæ˜¯å·²å­˜åœ¨çš„ä»»åŠ¡ï¼Œæ‰€ä»¥è¾“å‡ºè¡¨ç¤ºæ­£ç¡®ã€‚</p>
<h3 id="å¤‡ä»½Job"><a href="#å¤‡ä»½Job" class="headerlink" title="å¤‡ä»½Job"></a>å¤‡ä»½Job</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -s -X GET <span class="string">"<span class="variable">$url_of_job_config_xml</span>"</span> -o <span class="string">"<span class="variable">$target_xml</span>"</span> --user <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng opt]# curl -sX GET "http://188.131.xxx.xxx:8088/jenkins/job/test_job/config.xml" -o test_job.xml --user "<span class="formula">$jenkins_user:$</span>jenkins_password"</span><br><span class="line">[root@lzzeng opt]# ls -lrt</span><br><span class="line">...</span><br><span class="line">-rw-r--r--  1 root root  837 Dec 30 14:46 checkJobView.sh</span><br><span class="line">-rw-r--r--  1 root root 1442 Dec 30 15:06 test_job.xml</span><br><span class="line">[root@lzzeng opt]# diff /root/.jenkins/jobs/test_job/config.xml test_job.xml </span><br><span class="line">[root@lzzeng opt]#</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹å‡ºï¼Œå¤‡ä»½ä¸‹æ¥çš„test_job.xmlä¸.jenkinsé…ç½®ç›®å½•ä¸‹ç›¸åº”çš„config.xmlä¸€è‡´ã€‚</p>
<h3 id="è¿˜åŸJob"><a href="#è¿˜åŸJob" class="headerlink" title="è¿˜åŸJob"></a>è¿˜åŸJob</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/createItem?name=<span class="variable">$job_name</span>"</span> --data_binary <span class="string">"@<span class="variable">$target_xml</span>"</span> -H <span class="string">"ContentType:text/xml"</span> --user <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>å‡è®¾Jenkinsç«¯å·²ç»åˆ é™¤ï¼ˆæˆ–ç§»åŠ¨ï¼‰äº†test_jobè¿™ä¸ªä»»åŠ¡ï¼Œè¿˜åŸå¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"http://188.131.xxx.xxx:8088/createItem?name=test_job"</span> --data_binary <span class="string">"@test_job.xml"</span> -H <span class="string">"ContentType:text/xml"</span> --user <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>åœ¨æ›´ä½ä¸€äº›çš„Jenkinsç‰ˆæœ¬ä¸­ï¼Œæ¯”å¦‚V2.72ï¼Œæ­¤å‘½ä»¤æ˜¯ç”Ÿæ•ˆçš„ã€‚ä½†å¯¹äºå½“å‰æ‰€ç”¨çš„Jenkins V2.150.1ç‰ˆæœ¬ï¼Œè™½ç„¶å·²ç»ç¦ç”¨äº†CSRFå®‰å…¨é˜²æŠ¤ï¼Œæ­¤å‘½ä»¤ä»å¤±è´¥ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">Monitor/jenkins.security.csrf.CSRFAdministrativeMonitor/disable"&gt;&lt;input name="Submit" type="submit" value="Dismiss" class="submit-button primary" /&gt;&lt;/form&gt;You have not configured the CSRF issuer. This could be a security issue. For more information, please refer to &lt;a href="https://jenkins.io/redirect/csrf-protection" target="_blank"&gt;this page&lt;/a&gt;.&lt;p&gt;&lt;/p&gt;You can change the current configuration using the Security section &lt;a href="/jenkins/configureSecurity"&gt;CSRF Protection&lt;/a&gt;.&lt;/div&gt;&lt;/div&gt;&lt;p style="text-align: center; margin: 10px 0 0 0;"&gt;&lt;a onclick="document.location.href='/jenkins/manage';" href="/jenkins/manage"&gt;Manage Jenkins&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;script type="text/javascript"&gt;</span><br><span class="line">            document.getElementById("header").appendChild(document.getElementById("visible-am-container"));</span><br><span class="line">        &lt;/script&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/footer&gt;&lt;/body&gt;&lt;/html&gt;[root@lzzeng opt]#</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­æç¤ºï¼š<code>You have not configured the CSRF issuer</code>ã€‚å…¶å®ï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œç¦ç”¨<code>é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ </code>å¹¶ä¸å€¼å¾—æå€¡ï¼Œå…ˆæ¢å¤ã€å›¾-1ã€‘çš„é»˜è®¤å®‰å…¨è®¾ç½®å†è¯•ä¸€æ¬¡ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@lzzeng opt]# curl -sX POST "http://188.131.xxx.xxx:8088/jenkins/createItem?name=test_job" --data-binary "@test_job.xml" -H "ContentType:text/xml" --user "<span class="formula">$jenkins_user:$</span>jenkins_password"</span><br><span class="line">&lt;!doctype html&gt;&lt;html lang="en"&gt;&lt;head&gt;&lt;title&gt;HTTP Status 403 â€“ Forbidden&lt;/title&gt;...&lt;/head&gt;&lt;body&gt;&lt;h1&gt;HTTP Status 403 â€“ Forbidden&lt;/h1&gt;&lt;hr class="line" /&gt;&lt;p&gt;&lt;b&gt;Type&lt;/b&gt; Status Report&lt;/p&gt;&lt;p&gt;&lt;b&gt;Message&lt;/b&gt; No valid crumb was included in the request&lt;/p&gt;&lt;p&gt;&lt;b&gt;Description&lt;/b&gt; The server understood the request but refuses to authorize it.&lt;/p&gt;&lt;hr class="line" /&gt;&lt;h3&gt;Apache Tomcat/9.0.14&lt;/h3&gt;&lt;/body&gt;&lt;/html&gt;[root@lzzeng opt]#</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œé”™è¯¯ä¿¡æ¯å˜äº†ï¼Œæç¤ºï¼š<code>No valid crumb was included in the request</code>ï¼Œè§£å†³å¦‚ä¸‹ï¼š</p>
<p>å…ˆ<strong>è·å–crumb </strong>ï¼š</p>
<p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> <span class="string">"http://188.131.xxx.xxx:8088/jenkins/crumbIssuer/api/json"</span></span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> <span class="string">"http://188.131.xxx.xxx:8088/jenkins/crumbIssuer/api/xml"</span></span><br></pre></td></tr></table></figure>
<p>ä¼šæœ‰ç±»ä¼¼å¦‚ä¸‹çš„è¾“å‡ºï¼š</p>
<ul>
<li>jsonå½¢å¼</li>
</ul>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">&#123;"_class":"hudson.security.csrf.DefaultCrumbIssuer","crumb":"a1b3b82a61bf4672e6d9003de37xxxxx","crumbRequestField":"Jenkins-Crumb"&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>xmlå½¢å¼</li>
</ul>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">&lt;defaultCrumbIssuer _class='hudson.security.csrf.DefaultCrumbIssuer'&gt;&lt;crumb&gt;a1b3b82a61bf4672e6d9003de37xxxxx&lt;/crumb&gt;&lt;crumbRequestField&gt;Jenkins-Crumb&lt;/crumbRequestField&gt;&lt;/defaultCrumbIssuer&gt;</span><br></pre></td></tr></table></figure>
<p>è®°ä¸‹crumbRequestFieldå­—æ®µå’Œcrumbå­—æ®µçš„å€¼ï¼Œæ­£ç¡®çš„è¯·æ±‚éœ€è¦æ·»åŠ ä¸€ä¸ªHeaderï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-H &quot;crumbRequestFieldå­—æ®µå€¼:crumbå­—æ®µå€¼&quot;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆä¿®æ”¹åçš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"http://188.131.xxx.xxx:8088/jenkins/createItem?name=test_job"</span> --data-binary <span class="string">"@test_job.xml"</span> -H <span class="string">"Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx"</span> -H <span class="string">"Content-Type:text/xml"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<h3 id="å¤‡ä»½View"><a href="#å¤‡ä»½View" class="headerlink" title="å¤‡ä»½View"></a>å¤‡ä»½View</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -s -X GET <span class="string">"<span class="variable">$url_of_view_config_xml</span>"</span> -o <span class="string">"<span class="variable">$target_xml</span>"</span> [-H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span>] -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX GET <span class="string">"http://188.131.xxx.xxx:8088/jenkins/view/test_view/config.xml"</span> -o test_view.xml -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<h3 id="è¿˜åŸView"><a href="#è¿˜åŸView" class="headerlink" title="è¿˜åŸView"></a>è¿˜åŸView</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/createView?name=<span class="variable">$view_name</span>"</span> --data-binary <span class="string">"@<span class="variable">$target_xml</span>"</span> -H <span class="string">"ContentType:text/xml"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"http://188.131.xxx.xxx:8088/jenkins/createView?name=test_view2"</span> --data-binary <span class="string">"@test_view.xml"</span> -H <span class="string">"Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx"</span> -H <span class="string">"Content-Type:text/xml"</span> --user <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<h3 id="å°†Jobæ·»åŠ åˆ°View"><a href="#å°†Jobæ·»åŠ åˆ°View" class="headerlink" title="å°†Jobæ·»åŠ åˆ°View"></a>å°†Jobæ·»åŠ åˆ°View</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/view/<span class="variable">$view_name</span>/addJobToView?name=<span class="variable">$jobName</span>"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"http://188.131.xxx.xxx:8088/jenkins/view/test_view2/addJobToView?name=test_job"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx"</span></span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤Job"><a href="#åˆ é™¤Job" class="headerlink" title="åˆ é™¤Job"></a>åˆ é™¤Job</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/job/<span class="variable">$job_name</span>/doDelete"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"http://188.131.xxx.xxx:8088/jenkins/job/test_job/doDelete"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx"</span></span><br></pre></td></tr></table></figure>
<h3 id="åˆ é™¤View"><a href="#åˆ é™¤View" class="headerlink" title="åˆ é™¤View"></a>åˆ é™¤View</h3><p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/view/<span class="variable">$view_name</span>/doDelete"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -sX POST <span class="string">"http://188.131.xxx.xxx:8088/jenkins/view/test_view2/doDelete"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> -H <span class="string">"Jenkins-Crumb:a1b3b82a61bf4672e6d9003de37xxxxx"</span></span><br></pre></td></tr></table></figure>
<p>åˆ é™¤Viewçš„æ—¶å€™ï¼Œä¸ä¼šåˆ é™¤å…¶ä¸­çš„Jobã€‚</p>
<hr>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>ä»¥ä¸Šå‘½ä»¤ï¼Œæ±‡æ€»å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è·å–crumb</span></span><br><span class="line">curl -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> <span class="string">"<span class="variable">$jenkins_url</span>/crumbIssuer/api/&#123;xml|json&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ‰“å°$crumbRequestField:$crumb</span></span><br><span class="line">curl -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span> <span class="variable">$jenkins_url</span>/crumbIssuer/api/xml?xpath=concat\(//crumbRequestField,%22:%22,//crumb\)  <span class="comment"># è¯·æ±‚è·¯å¾„ä¸èƒ½åŠ å¼•å·ï¼Œ%22æ˜¯åŒå¼•å·"çš„urlencode</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹jobæˆ–view</span></span><br><span class="line">curl -X POST <span class="string">"<span class="variable">$jenkins_url</span>/&#123;checkJobName|checkViewName&#125;?value=<span class="variable">$target_name</span>"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤‡ä»½jobæˆ–view</span></span><br><span class="line">curl -s -X GET <span class="string">"<span class="variable">$jenkins_url</span>/&#123;job|view&#125;/<span class="variable">$target_name</span>/config.xml"</span> -o <span class="string">"<span class="variable">$target_xml_path</span>"</span> [-H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span>] -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿˜åŸjobæˆ–view</span></span><br><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/&#123;createItem|createView&#125;?name=<span class="variable">$target_name</span>"</span> --data-binary <span class="string">"@<span class="variable">$target_xml_path</span>"</span> -H <span class="string">"ContentType:text/xml"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ jobåˆ°viewä¸­</span></span><br><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/view/<span class="variable">$view_name</span>/addJobToView?name=<span class="variable">$jobName</span>"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤jobæˆ–view</span></span><br><span class="line">curl -sX POST <span class="string">"<span class="variable">$jenkins_url</span>/&#123;job|view&#125;/<span class="variable">$target_name</span>/doDelete"</span> -H <span class="string">"<span class="variable">$crumbRequestField</span>:<span class="variable">$crumb</span>"</span> -u <span class="string">"<span class="variable">$jenkins_user</span>:<span class="variable">$jenkins_password</span>"</span></span><br></pre></td></tr></table></figure>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>CICD</tag>
        <tag>Jenkins</tag>
      </tags>
  </entry>
  <entry>
    <title>é€šè¿‡Gitlabå‘å¸ƒGitbook</title>
    <url>/cicd/publish-gitbook/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/1578983279168.png" alt="å‘å¸ƒæ•ˆæœå›¾"></p>
<a id="more"></a>
<h2 id="å®‰è£…gitå®¢æˆ·ç«¯"><a href="#å®‰è£…gitå®¢æˆ·ç«¯" class="headerlink" title="å®‰è£…gitå®¢æˆ·ç«¯"></a>å®‰è£…gitå®¢æˆ·ç«¯</h2><p>Windowsç‰ˆGitå®¢æˆ·ç«¯ï¼š<a href="https://gitforwindows.org/" rel="external nofollow noopener noreferrer" target="_blank">https://gitforwindows.org/</a></p>
<h2 id="åˆ›å»ºgitbooké¡¹ç›®docs"><a href="#åˆ›å»ºgitbooké¡¹ç›®docs" class="headerlink" title="åˆ›å»ºgitbooké¡¹ç›®docs"></a>åˆ›å»ºgitbooké¡¹ç›®docs</h2><p>gitbooké¡¹ç›®docsçš„ç›®å½•ç»“æ„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docs                 # ä»“åº“æ ¹ç›®å½•</span><br><span class="line">â”œâ”€â”€ book.json        # gitbooké…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ deploy/          # å­˜æ”¾éƒ¨ç½²è„šæœ¬</span><br><span class="line">â”œâ”€â”€ .gitlab-ci.yml   # gitlab cié…ç½®æ–‡ä»¶</span><br><span class="line">â”œâ”€â”€ Dockerfile       # dockeré•œåƒç¼–è¯‘è„šæœ¬</span><br><span class="line">â”œâ”€â”€ docs/            # æ–‡æ¡£é›†ä¸­å­˜æ”¾ç›®å½•</span><br><span class="line">â”‚   â”œâ”€â”€ assets/              # å›¾ç‰‡ç›®å½•</span><br><span class="line">â”‚   â”œâ”€â”€ cicd/                # æŒç»­é›†æˆ</span><br><span class="line">â”‚   â”œâ”€â”€ deployment/          # åº”ç”¨éƒ¨ç½²</span><br><span class="line">â”‚   â”œâ”€â”€ task-sheduling/      # ä»»åŠ¡è°ƒåº¦</span><br><span class="line">â”‚   â”œâ”€â”€ config-management/   # é…ç½®ç®¡ç†</span><br><span class="line">â”‚   â””â”€â”€ monitoring/          # è¿ç»´ç›‘æ§</span><br><span class="line">â”œâ”€â”€ README.md    # ä¹¦ç±é¦–é¡µ</span><br><span class="line">â”œâ”€â”€ styles/      # cssæ–‡ä»¶</span><br><span class="line">â””â”€â”€ SUMMARY.md   # ä¹¦ç±ç›®å½•æ–‡ä»¶</span><br></pre></td></tr></table></figure>
<h2 id="å…‹éš†gitbooké¡¹ç›®"><a href="#å…‹éš†gitbooké¡¹ç›®" class="headerlink" title="å…‹éš†gitbooké¡¹ç›®"></a>å…‹éš†gitbooké¡¹ç›®</h2><p>å·²å®‰è£…å¥½gitå®¢æˆ·ç«¯ï¼Œç©ºç™½å¤„å³é”®å¦‚å›¾æ‰“å¼€gitå®¢æˆ·ç«¯ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/1578986400937.png" alt="æ‰“å¼€gitå®¢æˆ·ç«¯"></p>
<p>git clone é¡¹ç›®æ–‡ä»¶åˆ°æœ¬åœ°ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/15789738968739.png" alt="git clone"></p>
<h2 id="æ·»åŠ ä¸€ä¸ªæ–‡æ¡£"><a href="#æ·»åŠ ä¸€ä¸ªæ–‡æ¡£" class="headerlink" title="æ·»åŠ ä¸€ä¸ªæ–‡æ¡£"></a>æ·»åŠ ä¸€ä¸ªæ–‡æ¡£</h2><p>ä»¥ä¸‹åœ¨åŸé¡¹ç›®çš„docs/elseç›®å½•ä¸‹æ·»åŠ ä¸€ä¸ªæ–‡æ¡£<code>es-maximum-shards.md</code></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/1578975378145.png" alt="æ·»åŠ æ–‡æ¡£"></p>
<p>å¹¶ä¿®æ”¹ä¹¦ç±ç›®å½•</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/1578987800016.png" alt="ä¿®æ”¹ç›®å½•"></p>
<h2 id="æ·»åŠ ä¿®æ”¹ã€æäº¤ã€æ¨é€"><a href="#æ·»åŠ ä¿®æ”¹ã€æäº¤ã€æ¨é€" class="headerlink" title="æ·»åŠ ä¿®æ”¹ã€æäº¤ã€æ¨é€"></a>æ·»åŠ ä¿®æ”¹ã€æäº¤ã€æ¨é€</h2><ul>
<li>æŸ¥çœ‹ã€æ·»åŠ æ”¹åŠ¨</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/15789754833155.png" alt="æŸ¥çœ‹"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/15789756132226.png" alt="æ·»åŠ æ”¹åŠ¨"></p>
<ul>
<li><p>æäº¤åˆ°æœ¬åœ°ç‰ˆæœ¬åº“ã€æ¨é€åˆ°è¿œç¨‹ç‰ˆæœ¬åº“ï¼ˆmasteråˆ†æ”¯ï¼‰</p>
<p>git commit æäº¤æ—¶ï¼Œâ€-mâ€å‚æ•°å†™ä¸€ç‚¹ç®€æ˜çš„å¤‡æ³¨ä¿¡æ¯ã€‚</p>
</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/15789758161982.png" alt="æäº¤"></p>
<h2 id="è‡ªåŠ¨æ„å»ºã€å‘å¸ƒ"><a href="#è‡ªåŠ¨æ„å»ºã€å‘å¸ƒ" class="headerlink" title="è‡ªåŠ¨æ„å»ºã€å‘å¸ƒ"></a>è‡ªåŠ¨æ„å»ºã€å‘å¸ƒ</h2><p>git pushæˆåŠŸä¹‹åï¼Œåœ¨gitlabä¸Šå¯ä»¥æŸ¥çœ‹æ„å»ºè¿›åº¦ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/publish-gitbook.assets/1578988387980.png" alt="æ„å»ºè¿›åº¦"></p>
]]></content>
      <categories>
        <category>CICD</category>
      </categories>
      <tags>
        <tag>CICD</tag>
        <tag>Gitbook</tag>
      </tags>
  </entry>
  <entry>
    <title>Ansibleä½¿ç”¨å°ç»“</title>
    <url>/config-management/ansible-intro/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1550564146145.png" alt="Ansibleå®˜ç½‘"></p>
<p>â€‹    æ­£å¦‚<a href="https://www.ansible.com/" rel="external nofollow noopener noreferrer" target="_blank">Ansibleå®˜ç½‘</a>çš„æ ‡é¢˜â€œAnsible is Simple IT Automationâ€å«ä¹‰ï¼ŒAnsibleç®€åŒ–äº†ITè‡ªåŠ¨åŒ–çš„å®ç°ï¼Œæ˜¯é«˜æ•ˆè¿ç»´çš„ä¸€ä¸ªé‡è¦å·¥å…·ã€‚</p>
<p>â€‹    Ansibleçš„è®¾è®¡åˆè¡·å°±æ˜¯åœ¨è‹¥å¹²æœåŠ¡å™¨ä¸Šä»é›¶å¼€å§‹æ‰§è¡Œæ‰€æœ‰å¿…éœ€çš„é…ç½®ä¸æ“ä½œã€‚ä¾‹å¦‚ï¼Œåœ¨å¯åŠ¨Web æœåŠ¡å™¨ä¹‹å‰å…ˆå¯åŠ¨æ•°æ®åº“ï¼Œæˆ–è€…ä¸ºäº†å®ç°é›¶åœæœºå‡çº§ï¼Œå°†Web æœåŠ¡å™¨é€ä¸€ä»è´Ÿè½½å‡è¡¡ä¸Šæ‘˜é™¤å¹¶å‡çº§ã€‚Ansibleé€šè¿‡æç®€çš„æ¨¡å‹æ¥æ§åˆ¶å„ç§æ“ä½œæŒ‰ç…§æ‰€éœ€é¡ºåºæ‰§è¡Œã€‚å…¶å®ƒåŒç±»å·¥å…·æœ‰ï¼šChefã€Puppet åŠSaltstackã€‚</p>
<a id="more"></a>
<h4 id="Ansibleçš„ä¸»è¦ç‰¹ç‚¹"><a href="#Ansibleçš„ä¸»è¦ç‰¹ç‚¹" class="headerlink" title="Ansibleçš„ä¸»è¦ç‰¹ç‚¹"></a>Ansibleçš„ä¸»è¦ç‰¹ç‚¹</h4><ul>
<li>åŸºäºPythonè¯­è¨€å®ç°ï¼Œç”±Paramikoï¼ˆPythonçš„ä¸€ä¸ªå¯å¹¶å‘è¿æ¥sshä¸»æœºåŠŸèƒ½åº“ï¼‰ï¼ŒPyYAMLå’ŒJinja2ï¼ˆæ¨¡æ¿åŒ–ï¼‰ä¸‰ä¸ªå…³é”®æ¨¡å—å®ç°</li>
<li>æ¨¡å—åŒ–è®¾è®¡ï¼Œansibleè‡ªèº«æ˜¯ä¸€ä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œè°ƒç”¨ç‰¹å®šçš„æ¨¡å—æ¥å®Œæˆç‰¹å®šä»»åŠ¡</li>
<li>åŸºäºSSHåè®®å·¥ä½œï¼Œå…å®¢æˆ·ç«¯ï¼Œæœ‰ä¸¤ç§è®¤è¯æ–¹å¼ï¼šå¯†ç ã€å…¬é’¥</li>
<li>ä½¿ç”¨yamlè¯­è¨€ç¼–æ’å‰§æœ¬ï¼Œè¿ç»­ä»»åŠ¡æŒ‰å…ˆåè®¾ç½®é¡ºåºå®Œæˆ</li>
<li>æ˜¯ä¸€ä¸ª<strong>å£°æ˜å¼</strong>çš„ç®¡ç†å·¥å…·ï¼Œåœ¨ç¼–å†™è„šæœ¬æ—¶ä½¿ç”¨çš„æ˜¯å£°æ˜å¼è¯­è¨€</li>
</ul>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">å£°æ˜å¼è¯­è¨€è¡¨ç¤ºâ€œæœŸæœ›ç›®æ ‡æ˜¯ä»€ä¹ˆçŠ¶æ€â€ï¼Œå¦‚æœå·²ç»æ˜¯åˆ™è¿”å›"ok"ï¼Œå¦åˆ™æ”¹å˜ç›®æ ‡çŠ¶æ€å¹¶è¿”å›"changed"ã€‚</span><br></pre></td></tr></table></figure>
<ul>
<li>å…·æœ‰<strong>å¹‚ç­‰æ€§</strong>çš„ç‰¹ç‚¹ï¼Œæ‰§è¡Œä¸€æ¬¡æˆ–å¤šæ¬¡ï¼Œå®‰è£…å‡ºæ¥çš„ç¯å¢ƒæ˜¯ä¸€æ ·çš„</li>
</ul>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">HTTP/1.1ä¸­å¯¹â€œå¹‚ç­‰æ€§â€çš„å®šä¹‰æ˜¯ï¼šä¸€æ¬¡å’Œå¤šæ¬¡è¯·æ±‚æŸä¸€ä¸ªèµ„æºå¯¹äºèµ„æºæœ¬èº«åº”è¯¥å…·æœ‰åŒæ ·çš„ç»“æœï¼ˆç½‘ç»œè¶…æ—¶ç­‰é—®é¢˜é™¤å¤–ï¼‰ã€‚</span><br><span class="line">ä¹Ÿå°±æ˜¯è¯´ï¼Œå…¶ä»»æ„å¤šæ¬¡æ‰§è¡Œå¯¹èµ„æºæœ¬èº«æ‰€äº§ç”Ÿçš„å½±å“å‡ä¸ä¸€æ¬¡æ‰§è¡Œçš„å½±å“ç›¸åŒã€‚</span><br></pre></td></tr></table></figure>
<h4 id="Ansibleæ¶æ„å›¾"><a href="#Ansibleæ¶æ„å›¾" class="headerlink" title="Ansibleæ¶æ„å›¾"></a>Ansibleæ¶æ„å›¾</h4><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/201621695411869.png" alt="Ansibleæ¶æ„å›¾"></p>
<table>
<thead>
<tr>
<th style="text-align:left">ç»„ä»¶</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">ansible core</td>
<td>ansibleè‡ªèº«æ ¸å¿ƒæ¨¡å—</td>
</tr>
<tr>
<td style="text-align:left">host inventory</td>
<td>ä¸»æœºæ¸…å•ï¼Œå®šä¹‰å¯ç®¡æ§çš„ä¸»æœºåˆ—è¡¨</td>
</tr>
<tr>
<td style="text-align:left">connection plugins</td>
<td>è¿æ¥æ’ä»¶ï¼Œä¸€èˆ¬é»˜è®¤åŸºäºsshåè®®è¿æ¥</td>
</tr>
<tr>
<td style="text-align:left">modules</td>
<td>core modulesï¼ˆè‡ªå¸¦çš„æ ¸å¿ƒæ¨¡å—ï¼‰ã€custom modulesï¼ˆè‡ªå®šä¹‰æ¨¡å—ï¼‰</td>
</tr>
<tr>
<td style="text-align:left">playbooks</td>
<td>å‰§æœ¬ï¼ŒæŒ‰ç…§æ‰€è®¾å®šç¼–æ’çš„é¡ºåºæ‰§è¡Œå‘½ä»¤</td>
</tr>
</tbody>
</table>
<h4 id="é€‚ç”¨åœºæ™¯"><a href="#é€‚ç”¨åœºæ™¯" class="headerlink" title="é€‚ç”¨åœºæ™¯"></a>é€‚ç”¨åœºæ™¯</h4><p>â€‹    åœ¨è‡ªåŠ¨åŒ–è¿ç»´æ–¹é¢ï¼Œå…³äºAnsibleé€‚ç”¨åœºæ™¯ï¼Œï¼Œå¯ä»¥ä»ä¸åŒç±»å·¥å…·Saltstackå¯¹æ¯”çš„è§’åº¦æ¥ç†è§£ã€‚</p>
<p><strong>å…±åŒç‚¹</strong>ï¼š</p>
<ul>
<li><p>Ansibleå’ŒSaltStackéƒ½æ˜¯çš„ç›®å‰æœ€æµè¡Œçš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·ï¼Œèƒ½æ»¡è¶³ä¼ä¸šITç³»ç»Ÿçš„è‡ªåŠ¨åŒ–è¿ç»´ç®¡ç†ã€‚è¿™ä¸¤ä¸ªå·¥å…·éƒ½æ˜¯ç”¨pythonå¼€å‘çš„ï¼Œå¯ä»¥éƒ¨ç½²åˆ°ä¸åŒçš„ç³»ç»Ÿç¯å¢ƒä¸­å’Œå…·æœ‰è‰¯å¥½çš„äºŒæ¬¡å¼€å‘ç‰¹æ€§ã€‚</p>
</li>
<li><p>åœ¨æ‰§è¡Œçš„å‘½ä»¤çš„æ—¶å€™ï¼ŒAnsibleå’ŒSaltStackéƒ½æ”¯æŒAd-hocæ“ä½œæ¨¡å¼ï¼Œä¹Ÿå¯ä»¥æ”¯æŒå°†å‘½ä»¤å†™å…¥yamlæ ¼å¼æ–‡ä»¶ä¸­å†æ‰¹é‡æ‰§è¡Œã€‚</p>
</li>
<li><p>åœ¨å¤„ç†è¿”å›ç»“æœæ–¹é¢ï¼ŒAnsibleå’ŒSaltStackçš„è¿”å›ç»“æœæ ¼å¼éƒ½æ˜¯JSONæ ¼å¼ï¼Œæ¯”è¾ƒæ˜“æ‡‚å’Œæ–¹ä¾¿è§£æã€‚</p>
</li>
</ul>
<p><strong>å·®å¼‚</strong>ï¼š</p>
<ul>
<li><p>å“åº”é€Ÿåº¦ï¼šSaltStackæ›´å¿«ï¼Œåœ¨æ–‡ä»¶ä¼ è¾“æ–¹é¢å¿«ä¸€ä¸ªé‡çº§ï¼Œä½†åœ¨æ‰¹é‡è„šæœ¬æ‰§è¡Œã€å¤šæœºå™¨éƒ¨ç½²æ–¹é¢ç›¸è¿‘</p>
<p>  SaltStackçš„masterå’Œminionä¸»æœºæ˜¯é€šè¿‡ZeroMQä¼ è¾“æ•°æ®ï¼Œè€ŒAnsibleæ˜¯é€šè¿‡æ ‡å‡†SSHè¿›è¡Œæ•°æ®ä¼ è¾“ï¼ŒSaltStackçš„å“åº”é€Ÿåº¦è¦æ¯”Ansibleå¿«å¾ˆå¤šã€‚æ ‡å‡†SSHè¿æ¥çš„æ—¶å€™æ¯”è¾ƒè€—è´¹æ—¶é—´ï¼ŒZeroMQä¼ è¾“çš„é€Ÿåº¦ä¼šå¿«å¾ˆå¤šï¼Œæ‰€ä»¥å•å•ä»å“åº”é€Ÿåº¦æ–¹é¢è€ƒè™‘SaltStackä¼šæ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚ä½†æ˜¯åœ¨ä¸€èˆ¬çš„è¿ç»´åœºæ™¯ä¸‹Ansibleçš„å“åº”é€Ÿåº¦ä¹Ÿå¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚<br>  æœ‰æµ‹è¯•æ•°æ®è¡¨æ˜ï¼Œåœ¨æ‰§è¡Œå‘½ä»¤ã€åˆ†å‘æ–‡ä»¶ã€è¯»å–æ–‡ä»¶æ–¹é¢ï¼ŒSaltStackçš„å“åº”é€Ÿåº¦æ˜¯Ansibleçš„10å€å·¦å³ã€‚ä½†åœ¨æ‰¹é‡è„šæœ¬æ‰§è¡Œã€å¤šæœºå™¨éƒ¨ç½²æ–¹é¢ï¼ŒäºŒè€…é€Ÿåº¦ç›¸å½“ã€‚</p>
</li>
<li><p>å®‰å…¨æ€§ï¼šAnsibleæ›´å®‰å…¨</p>
<p>  Ansibleä½¿ç”¨æ ‡å‡†SSHè¿æ¥ä¼ è¾“æ•°æ®ï¼Œä¸éœ€è¦åœ¨è¿œç¨‹ä¸»æœºä¸Šå¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå¹¶ä¸”æ ‡å‡†SSHæ•°æ®ä¼ è¾“æœ¬èº«å°±æ˜¯åŠ å¯†ä¼ è¾“ï¼Œè¿™æ ·è¿œç¨‹ä¸»æœºä¸å®¹æ˜“è¢«æ”»å‡»ã€‚</p>
</li>
<li><p>è‡ªèº«è¿ç»´ï¼šAnsibleæ›´å‹å¥½</p>
<p>  Ansibleå’Œè¿œç«¯ä¸»æœºä¹‹é—´çš„é€šè¿‡æ ‡å‡†SSHé€šä¿¡ï¼Œè¿œç¨‹ä¸»æœºä¸Šåªéœ€è¦è¿è¡ŒSSHè¿›ç¨‹å°±å¯ä»¥è¿›è¡Œè¿ç»´æ“ä½œï¼Œè€ŒSSHæ˜¯æœºæˆ¿ä¸»æœºä¸­ä¸€èˆ¬éƒ½å®‰è£…å’Œå¯åŠ¨çš„è¿›ç¨‹ï¼Œæ‰€ä»¥Ansibleå¯¹æœºæˆ¿è¿ç»´ä¸ä¼šå¢åŠ è¿‡å¤šçš„è¿ç»´æˆæœ¬ã€‚</p>
</li>
</ul>
<p>â€‹    ç»¼åˆä»¥ä¸Šï¼Œå¯ä»¥è®¤ä¸º1000å°ä»¥å†…çš„æœåŠ¡å™¨è‡ªåŠ¨åŒ–è¿ç»´ï¼Œä½¿ç”¨Ansibleåšé…ç½®ç®¡ç†ã€åº”ç”¨éƒ¨ç½²ã€æ‰¹é‡è„šæœ¬æ‰§è¡Œç­‰å·¥ä½œæ— éœ€é¡¾è™‘å¤ªå¤šã€‚</p>
<hr>
<h3 id="åŸºæœ¬çŸ¥è¯†"><a href="#åŸºæœ¬çŸ¥è¯†" class="headerlink" title="åŸºæœ¬çŸ¥è¯†"></a>åŸºæœ¬çŸ¥è¯†</h3><h4 id="å¸¸ç”¨æ¨¡å—"><a href="#å¸¸ç”¨æ¨¡å—" class="headerlink" title="å¸¸ç”¨æ¨¡å—"></a>å¸¸ç”¨æ¨¡å—</h4><p>â€‹    Ansibleçš„å¸¸ç”¨æ¨¡å—ä¸»è¦æœ‰ä»¥ä¸‹åæ¥ä¸ªï¼š</p>
<table>
<thead>
<tr>
<th>æ¨¡å—åç§°</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody>
<tr>
<td>ping</td>
<td>å°è¯•è¿æ¥ä¸»æœºï¼Œå¦‚æœæµ‹è¯•æˆåŠŸä¼šè¿”å›â€pongâ€</td>
</tr>
<tr>
<td>command</td>
<td>åœ¨è¿œç¨‹èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤</td>
</tr>
<tr>
<td>yum</td>
<td>ä½¿ç”¨yumè½¯ä»¶åŒ…ç®¡ç†å·¥å…·ç®¡ç†è½¯ä»¶åŒ…</td>
</tr>
<tr>
<td>shell</td>
<td>å’Œcommandæ¨¡å—ç±»ä¼¼ï¼Œæ‰§è¡Œå‘½ä»¤ï¼Œæ”¯æŒå˜é‡ç­‰ç¬¦å·</td>
</tr>
<tr>
<td>cron</td>
<td>ç®¡ç†å®šæ—¶ä»»åŠ¡</td>
</tr>
<tr>
<td>service</td>
<td>ç®¡ç†ç¨‹åºæœåŠ¡</td>
</tr>
<tr>
<td>file</td>
<td>è®¾ç½®æ–‡ä»¶å±æ€§</td>
</tr>
<tr>
<td>copy</td>
<td>å¤åˆ¶æœ¬åœ°æ–‡ä»¶åˆ°è¿œç¨‹ä¸»æœº</td>
</tr>
<tr>
<td>script</td>
<td>ä¼ é€æœ¬åœ°çš„ä¸€ä¸ªè„šæœ¬å¹¶åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œ</td>
</tr>
<tr>
<td>setup</td>
<td>è·å–è¿œç¨‹ä¸»æœºçš„å‚æ•°ä¿¡æ¯</td>
</tr>
<tr>
<td>user</td>
<td>ç®¡ç†ç”¨æˆ·è´¦æˆ·</td>
</tr>
<tr>
<td>group</td>
<td>æ·»åŠ æˆ–è€…åˆ é™¤ç”¨æˆ·ç»„</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
</tr>
</tbody>
</table>
<h4 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h4><p>â€‹    Ansibleé…ç½®æ˜¯ä»¥iniæ ¼å¼å­˜å‚¨æ•°æ®çš„ï¼Œåœ¨Ansibleä¸­ï¼Œå‡ ä¹æ‰€æœ‰é…ç½®éƒ½å¯ä»¥é€šè¿‡Playbookæˆ–ç¯å¢ƒå˜é‡æ¥é‡æ–°èµ‹å€¼ã€‚åŠ è½½é…ç½®æ–‡ä»¶çš„ä¼˜å…ˆé¡ºåºå¦‚ä¸‹ï¼š</p>
<ul>
<li><p>ANSIBLE_CONFIGï¼šä¼˜å…ˆæŸ¥æ‰¾ç¯å¢ƒå˜é‡ANSIBLE_CONFIGæŒ‡å‘çš„é…ç½®æ–‡ä»¶</p>
</li>
<li><p>./ansible.cfgï¼šå½“å‰ç›®å½•ä¸‹çš„ansible.cfgé…ç½®æ–‡ä»¶</p>
</li>
<li><p>~/.ansible.cfgï¼šå½“å‰ç”¨æˆ·homeç›®å½•ä¸‹çš„.ansible.cfgé…ç½®æ–‡ä»¶</p>
</li>
<li><p>/etc/ansible/ansible.cfgï¼šå®‰è£…ansibleç”Ÿæˆçš„é»˜è®¤é…ç½®æ–‡ä»¶</p>
<p>AnsibleæŒ‰é¡ºåºæŸ¥æ‰¾å¹¶åº”ç”¨æœ€å…ˆæ‰¾åˆ°çš„ansibleé…ç½®ã€‚ansible.cfgä¸­çš„é…ç½®å¯è¢«playbookä¸­çš„è‡ªå®šä¹‰é…ç½®è¦†ç›–</p>
</li>
</ul>
<p>å¸¸ç”¨çš„é…ç½®å‚æ•°ï¼š</p>
<table>
<thead>
<tr>
<th>é…ç½®é¡¹</th>
<th>å«ä¹‰</th>
</tr>
</thead>
<tbody>
<tr>
<td>inventory</td>
<td>èµ„æºæ¸…å•æ–‡ä»¶ï¼Œå°±æ˜¯ä¸€äº›Ansibleéœ€è¦è¿æ¥ç®¡ç†çš„ä¸»æœºåˆ—è¡¨</td>
</tr>
<tr>
<td>library</td>
<td>Ansibleæ¨¡å—çš„å®‰è£…ç›®å½•</td>
</tr>
<tr>
<td>forks</td>
<td>é»˜è®¤å¹¶å‘è¿›ç¨‹æ•°5ï¼Œå¯æ ¹æ®æ§åˆ¶ä¸»æœºçš„æ€§èƒ½å’Œè¢«ç®¡ç†èŠ‚ç‚¹çš„æ•°é‡è°ƒæ•´</td>
</tr>
<tr>
<td>sudo_user</td>
<td>æ‰§è¡Œå‘½ä»¤çš„ç”¨æˆ·ï¼Œå¯åœ¨playbookä¸­é‡æ–°è®¾ç½®</td>
</tr>
<tr>
<td>remote_port</td>
<td>SSHè¿æ¥ç«¯å£ä¸€èˆ¬æ˜¯22ï¼Œå¦‚æœ‰ä¸ªåˆ«ç‰¹æ®Šçš„ï¼Œå¯åœ¨inventoryä¸­å•ç‹¬æŒ‡å®š</td>
</tr>
<tr>
<td>host_key_checking</td>
<td>æ˜¯å¦æ£€æŸ¥å…¬é’¥ï¼Œä¸€èˆ¬è®¾ç½®ä¸ºfalse</td>
</tr>
<tr>
<td>timeout</td>
<td>SSHè¿æ¥çš„è¶…æ—¶é—´éš”ï¼Œé»˜è®¤20s</td>
</tr>
<tr>
<td>log_path</td>
<td>ansibleæ—¥å¿—è·¯å¾„</td>
</tr>
<tr>
<td>â€¦</td>
<td>â€¦</td>
</tr>
</tbody>
</table>
<h4 id="æ‰§è¡Œè¿‡ç¨‹"><a href="#æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="æ‰§è¡Œè¿‡ç¨‹"></a>æ‰§è¡Œè¿‡ç¨‹</h4><ul>
<li>åŠ è½½è‡ªå·±çš„é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤<code>/etc/ansible/ansible.cfg</code></li>
<li>æŸ¥æ‰¾å¯¹åº”çš„ä¸»æœºé…ç½®æ–‡ä»¶ï¼Œæ‰¾åˆ°è¦æ‰§è¡Œçš„ä¸»æœºæˆ–è€…ç»„</li>
<li>åŠ è½½è‡ªå·±å¯¹åº”çš„æ¨¡å—æ–‡ä»¶ï¼Œå¦‚ command</li>
<li>é€šè¿‡ansibleå°†æ¨¡å—æˆ–å‘½ä»¤ç”Ÿæˆå¯¹åº”çš„ä¸´æ—¶pyæ–‡ä»¶(pythonè„šæœ¬)ï¼Œ å¹¶å°†è¯¥æ–‡ä»¶ä¼ è¾“è‡³è¿œç¨‹æœåŠ¡å™¨</li>
<li>å¯¹åº”æ‰§è¡Œç”¨æˆ·çš„å®¶ç›®å½•çš„<code>.ansible/tmp/XXX/XXX.PY</code>æ–‡ä»¶</li>
<li>ç»™æ–‡ä»¶ +x æ‰§è¡Œæƒé™</li>
<li>æ‰§è¡Œå¹¶è¿”å›ç»“æœ</li>
<li>åˆ é™¤ä¸´æ—¶pyæ–‡ä»¶ï¼Œ<code>sleep 0</code>é€€å‡º</li>
</ul>
<h4 id="å‰§æœ¬ï¼ˆPlaybookï¼‰"><a href="#å‰§æœ¬ï¼ˆPlaybookï¼‰" class="headerlink" title="å‰§æœ¬ï¼ˆPlaybookï¼‰"></a>å‰§æœ¬ï¼ˆPlaybookï¼‰</h4><p><strong>playbookçš„æ„æˆ</strong>ï¼š</p>
<ul>
<li>Target sectionï¼šå®šä¹‰å°†è¦æ‰§è¡Œ playbook çš„è¿œç¨‹ä¸»æœºç»„</li>
<li>Variable sectionï¼šå®šä¹‰ playbook è¿è¡Œæ—¶éœ€è¦ä½¿ç”¨çš„å˜é‡</li>
<li>Task sectionï¼šå®šä¹‰å°†è¦åœ¨è¿œç¨‹ä¸»æœºä¸Šæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨</li>
<li>Handler sectionï¼šå®šä¹‰ task æ‰§è¡Œå®Œæˆä»¥åéœ€è¦è°ƒç”¨çš„ä»»åŠ¡</li>
</ul>
<p>ä¸€èˆ¬æ‰€éœ€çš„<strong>ç›®å½•å±‚</strong>ï¼š</p>
<ul>
<li>varsï¼šå˜é‡å±‚</li>
<li>tasksï¼šä»»åŠ¡å±‚</li>
<li>handlersï¼šè§¦å‘æ¡ä»¶</li>
<li>filesï¼šæ–‡ä»¶</li>
<li>templateï¼šæ¨¡æ¿</li>
</ul>
<h3 id="å®‰è£…æ–¹æ³•"><a href="#å®‰è£…æ–¹æ³•" class="headerlink" title="å®‰è£…æ–¹æ³•"></a>å®‰è£…æ–¹æ³•</h3><p>â€‹    ä»¥rootç”¨æˆ·å®‰è£…ansibleä¸ºä¾‹ï¼Œæ–¹å¼å¦‚ä¸‹ï¼š</p>
<h4 id="1-ä»Githubè·å–æºç å®‰è£…"><a href="#1-ä»Githubè·å–æºç å®‰è£…" class="headerlink" title="1. ä»Githubè·å–æºç å®‰è£…"></a>1. ä»Githubè·å–æºç å®‰è£…</h4><p>â€‹    éœ€é¢„å…ˆå®‰è£…å¥½Python2.5ä»¥ä¸Šç‰ˆæœ¬ã€‚å¦å¤–ï¼Œå¯¹äºAnsibleï¼ŒWindowsç³»ç»Ÿä¸å¯ä»¥åšæ§åˆ¶ä¸»æœºã€‚å¦‚æœæ§åˆ¶ä¸»æœºæ²¡æœ‰é¢„è£…Pythonï¼Œä»<a href="https://www.python.org/download/releases/" rel="external nofollow noopener noreferrer" target="_blank">Pythonå®˜ç½‘</a>é€‰æ‹©<a href="https://www.python.org/ftp/python/2.7.15/Python-2.7.15.tgz" rel="external nofollow noopener noreferrer" target="_blank">2.7.15ç‰ˆæœ¬çš„æºç åŒ…</a>ï¼Œè§£å‹åˆ°æ§åˆ¶ä¸»æœºæ‰§è¡Œå®‰è£…å³å¯ã€‚</p>
<p>å®‰è£…è¿‡Pythonç¯å¢ƒä¹‹åï¼Œæ›´æ–°ä»¥ä¸‹æ¨¡å—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…pythonçš„åŒ…ç®¡ç†å·¥å…·pip</span></span><br><span class="line">[root@VM_0_6_centos ~]<span class="comment"># easy_install pip</span></span><br><span class="line"><span class="comment"># é€šè¿‡pipå®‰è£…ansibleå¿…éœ€çš„è‹¥å¹²pythonæ¨¡å—</span></span><br><span class="line">[root@VM_0_6_centos ~]<span class="comment"># pip install paramiko PyYAML Jinja2 httplib2 six</span></span><br></pre></td></tr></table></figure>
<p>ä¸‹è½½ã€å®‰è£…ansible</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git://github.com/ansible/ansible.git --recursive</span><br><span class="line"><span class="built_in">cd</span> ./ansible</span><br><span class="line"><span class="comment"># Bashå‘½ä»¤</span></span><br><span class="line"><span class="built_in">source</span> ./hacking/env-setup</span><br></pre></td></tr></table></figure>
<h4 id="2-Yumå®‰è£…"><a href="#2-Yumå®‰è£…" class="headerlink" title="2. Yumå®‰è£…"></a>2. Yumå®‰è£…</h4><p>Fedora ç”¨æˆ·å¯ç›´æ¥å®‰è£…Ansibleï¼Œä½†RHELæˆ–CentOSç”¨æˆ·ï¼Œéœ€è¦ <a href="http://fedoraproject.org/wiki/EPEL" rel="external nofollow noopener noreferrer" target="_blank">é…ç½® EPEL</a>ã€‚</p>
<p>æ›´æ–°EPELæº</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># rpmæ–¹å¼å®‰è£…EPELæº</span></span><br><span class="line">rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line"><span class="comment"># æˆ–è€…ä»é˜¿é‡Œé•œåƒæºè·å–</span></span><br><span class="line">wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span><br></pre></td></tr></table></figure>
<p>ç„¶åæ›´æ–°ä¸€ä¸‹ç¼“å­˜</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_6_centos ~]<span class="comment"># yum clean all</span></span><br><span class="line">[root@VM_0_6_centos ~]<span class="comment"># yum makecache</span></span><br></pre></td></tr></table></figure>
<p>å®‰è£…ansible</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_6_centos ~]<span class="comment"># yum install ansible -y</span></span><br></pre></td></tr></table></figure>
<h4 id="3-å…¶å®ƒç³»ç»Ÿå®‰è£…Ansible"><a href="#3-å…¶å®ƒç³»ç»Ÿå®‰è£…Ansible" class="headerlink" title="3. å…¶å®ƒç³»ç»Ÿå®‰è£…Ansible"></a>3. å…¶å®ƒç³»ç»Ÿå®‰è£…Ansible</h4><p>â€‹    å…¶å®ƒæ“ä½œç³»ç»Ÿï¼Œè¯¦è§<a href="http://www.ansible.com.cn/docs/intro_installation.html" rel="external nofollow noopener noreferrer" target="_blank">Ansibleå®‰è£…æ–¹æ³•</a>ã€‚</p>
<h3 id="æ“ä½œç¤ºä¾‹"><a href="#æ“ä½œç¤ºä¾‹" class="headerlink" title="æ“ä½œç¤ºä¾‹"></a>æ“ä½œç¤ºä¾‹</h3><p>â€‹    æˆ‘ä»¬ä¸»è¦ä½¿ç”¨ansibleå’Œansible-playbookè¿™ä¸¤ä¸ªå‘½ä»¤ã€‚æ‰¹é‡æ‰§è¡Œç®€å•å‘½ä»¤æ—¶ï¼Œä½¿ç”¨ansibleï¼›æ‰§è¡Œæ›´å¤æ‚çš„æ‰¹é‡å®‰è£…éƒ¨ç½²æ—¶ç”¨ansible-playbookã€‚ä»¥ä¸‹æ˜¯æˆ‘åœ¨äº‘ä¸»æœºä¸Šä½¿ç”¨ansibleçš„ä¸‰ä¸ªç¤ºä¾‹ï¼š</p>
<p>ä¸ªäººäº‘ä¸»æœºä¸»æœºç¯å¢ƒå¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ~]<span class="comment"># cat /etc/redhat-release                                </span></span><br><span class="line">CentOS Linux release 7.3.1611 (Core) </span><br><span class="line">[root@VM_0_7_centos ~]<span class="comment"># df -h</span></span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/vda1        50G  6.8G   40G  15% /</span><br><span class="line">devtmpfs        911M     0  911M   0% /dev</span><br><span class="line">tmpfs           920M   24K  920M   1% /dev/shm</span><br><span class="line">tmpfs           920M  436K  920M   1% /run</span><br><span class="line">tmpfs           920M     0  920M   0% /sys/fs/cgroup</span><br><span class="line">tmpfs           184M     0  184M   0% /run/user/0</span><br><span class="line">tmpfs           184M     0  184M   0% /run/user/1000</span><br></pre></td></tr></table></figure>
<h4 id="ä½¿ç”¨ansible"><a href="#ä½¿ç”¨ansible" class="headerlink" title="ä½¿ç”¨ansible"></a>ä½¿ç”¨ansible</h4><h5 id="1-æ‰§è¡Œç®€å•å‘½ä»¤"><a href="#1-æ‰§è¡Œç®€å•å‘½ä»¤" class="headerlink" title="1. æ‰§è¡Œç®€å•å‘½ä»¤"></a>1. æ‰§è¡Œç®€å•å‘½ä»¤</h5><p>â€‹    å®‰è£…å¥½ansibleä¹‹åï¼Œåœ¨å½“å‰ç›®å½•ç¼–å†™ä¸€ä¸ªhostsæ–‡ä»¶ï¼Œå®šä¹‰ä¸€ä¸ªä¸»æœºç¾¤ç»„vmï¼Œé…ç½®å¥½å¾…éƒ¨ç½²æœºå™¨çš„ä¸»æœºåˆ«åã€IPåœ°å€ç­‰ä¿¡æ¯ï¼Œæ ¼å¼å¯ä»¥å¦‚ä¸‹:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cat myhosts</span><br><span class="line">[vm]</span><br><span class="line">vm01 ansible_host=192.168.xxx.xx1 <span class="comment"># ansible2.0ä¹‹å‰çš„ç‰ˆæœ¬åº”è¯¥ä½¿ç”¨ansible_ssh_host</span></span><br><span class="line">vm02 ansible_host=192.168.xxx.xx2</span><br></pre></td></tr></table></figure>
<p>â€‹    ç„¶åï¼Œé€šè¿‡æŒ‡å®š<code>-i</code>å‚æ•°æŒ‡å®šè‡ªå®šä¹‰hostsæ–‡ä»¶æ‰§è¡Œä¸€ä¸ªç®€å•çš„å‘½ä»¤ï¼Œå¦‚æŸ¥è¯¢ç³»ç»Ÿï¼ˆredhatç³»åˆ—ï¼‰ç‰ˆæœ¬ï¼š<code>cat /etc/redhat-release</code></p>
<p><strong>1) ä»…æŸ¥è¯¢vm01</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ~]<span class="comment"># ansible -i myhosts vm01 -m shell -a "cat /etc/redhat-release"</span></span><br><span class="line">vm01 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CentOS Linux release 7.3.1611 (Core)</span><br></pre></td></tr></table></figure>
<p><strong>2) æŸ¥è¯¢ä¸»æœºç¾¤ç»„vmä¸­çš„æ‰€æœ‰ä¸»æœº</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ~]<span class="comment"># ansible -i myhosts vm -m shell -a "cat /etc/redhat-release"</span></span><br><span class="line">vm02 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CentOS Linux release 7.3.1611 (Core) </span><br><span class="line"></span><br><span class="line">vm01 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CentOS Linux release 7.3.1611 (Core)</span><br></pre></td></tr></table></figure>
<p><strong>3) æŸ¥è¯¢hostsæ–‡ä»¶ä¸­çš„æ‰€æœ‰ä¸»æœº</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ~]<span class="comment"># ansible -i myhosts all -m shell -a "cat /etc/redhat-release"</span></span><br><span class="line">vm02 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CentOS Linux release 7.3.1611 (Core) </span><br><span class="line"></span><br><span class="line">vm01 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">CentOS Linux release 7.3.1611 (Core)</span><br></pre></td></tr></table></figure>
<p><strong>ï¼æ³¨æ„ï¼š<code>command</code>æ¨¡å—ä¸æ”¯æŒç®¡é“</strong></p>
<p>ä¾‹å¦‚ï¼Œä¼å›¾é€šè¿‡<code>&quot;df -h |sed -n 2p&quot;</code>è·å–ç¬¬ä¸€ä¸ªåˆ—å‡ºçš„æ–‡ä»¶ç³»ç»Ÿçš„æ•°æ®æ—¶ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ~]<span class="comment"># ansible -i myhosts vm01 -m command -a "df -h |sed -n 2p"</span></span><br><span class="line">vm01 | FAILED | rc=1 &gt;&gt;</span><br><span class="line">df: invalid option -- <span class="string">'n'</span></span><br><span class="line">Try <span class="string">'df --help'</span> <span class="keyword">for</span> more information.non-zero <span class="built_in">return</span> code</span><br></pre></td></tr></table></figure>
<p>æ­¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<strong><code>shell</code>æ¨¡å—</strong>æ›¿ä»£ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ~]<span class="comment"># ansible -i myhosts vm01 -m shell -a "df -h | sed -n 2p"</span></span><br><span class="line">vm01 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">/dev/vda1        50G  3.5G   44G   8% /</span><br></pre></td></tr></table></figure>
<h5 id="2-æ‰§è¡Œæ§åˆ¶ä¸»æœºä¸Šçš„è„šæœ¬"><a href="#2-æ‰§è¡Œæ§åˆ¶ä¸»æœºä¸Šçš„è„šæœ¬" class="headerlink" title="2. æ‰§è¡Œæ§åˆ¶ä¸»æœºä¸Šçš„è„šæœ¬"></a>2. æ‰§è¡Œæ§åˆ¶ä¸»æœºä¸Šçš„è„šæœ¬</h5><p>â€‹    å¦‚æœéœ€è¦æ‰§è¡Œå¤šæ¡shellå‘½ä»¤ï¼Œè€Œåˆä¸æƒ³ç¼–å†™playbookï¼Œå¯ä»¥å°†åŒ…å«è¿™äº›å‘½ä»¤çš„shellè„šæœ¬æ”¾åœ¨æ§åˆ¶ä¸»æœºä¸Šï¼Œé€šè¿‡scriptæ¨¡å—æ‰§è¡Œã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /root/test.sh</span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">yum install httpd -y</span><br><span class="line">systemctl start httpd</span><br><span class="line">systemctl status httpd</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨vm01ä¸Šå®‰è£…httpdå¹¶å¯åŠ¨</span></span><br><span class="line">[root@VM_0_7_centos ~]<span class="comment"># ansible -i myhosts vm01 -m script -a "/root/test.sh"</span></span><br><span class="line">vm01 | CHANGED =&gt; &#123;</span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="string">"rc"</span>: 0, </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="ä½¿ç”¨ansible-playbook"><a href="#ä½¿ç”¨ansible-playbook" class="headerlink" title="ä½¿ç”¨ansible-playbook"></a>ä½¿ç”¨ansible-playbook</h4><h5 id="3-ä½¿ç”¨ansible-playbookéƒ¨ç½²ä¸€ä¸ªtomcaté›†ç¾¤"><a href="#3-ä½¿ç”¨ansible-playbookéƒ¨ç½²ä¸€ä¸ªtomcaté›†ç¾¤" class="headerlink" title="3. ä½¿ç”¨ansible-playbookéƒ¨ç½²ä¸€ä¸ªtomcaté›†ç¾¤"></a>3. ä½¿ç”¨ansible-playbookéƒ¨ç½²ä¸€ä¸ªtomcaté›†ç¾¤</h5><p>â€‹    æ­¤ä¾‹æ¼”ç¤ºå¦‚ä½•å°†ä¸€ä¸ªWebåº”ç”¨éƒ¨ç½²åˆ°ç”± <code>ä¸€ä¸ªNginXèŠ‚ç‚¹ + ä¸¤ä¸ªtomcatèŠ‚ç‚¹</code>é›†ç¾¤ï¼Œç„¶åæ¨¡æ‹Ÿå‡çº§ã€å›é€€è¿‡ç¨‹ï¼š</p>
<p>1+2é›†ç¾¤è®¾å®šï¼š</p>
<table>
<thead>
<tr>
<th>ä¸»æœº</th>
<th>åº”ç”¨</th>
<th>ç›‘å¬ç«¯å£</th>
<th>ç‰ˆæœ¬</th>
</tr>
</thead>
<tbody>
<tr>
<td>vm_nginx</td>
<td>NginX</td>
<td>80</td>
<td>1.12</td>
</tr>
<tr>
<td>vm_tomcat_1</td>
<td>tomcat</td>
<td>8080</td>
<td>8.5.38</td>
</tr>
<tr>
<td>vm_tomcat_2</td>
<td>tomcat</td>
<td>8080</td>
<td>8.5.38</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p>ä¸ºäº†æ¨¡æ‹Ÿå‡çº§ã€å›é€€æ“ä½œï¼Œå‡†å¤‡ä¸¤ä¸ªWebåº”ç”¨ï¼š</p>
<table>
<thead>
<tr>
<th>Webåº”ç”¨</th>
<th>ç‰ˆæœ¬</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>examples.war</td>
<td>1.0</td>
<td>æ—§ç‰ˆæœ¬ï¼Œå›é€€ç”¨</td>
</tr>
<tr>
<td>examples.war</td>
<td>2.0</td>
<td>æ–°ç‰ˆæœ¬ï¼Œå‡çº§ç”¨</td>
</tr>
</tbody>
</table>
<p>æ¥ä¸‹æ¥ï¼Œç¼–å†™playbookã€‚</p>
<p>åœ¨ä¸æ˜¯ç‰¹åˆ«æ¸…æ¥šæ¯ä¸ªæ­¥éª¤è¯¥å¦‚ä½•ç¼–å†™çš„æƒ…å†µä¸‹ï¼Œå…ˆä¸€æ¡ä¸€æ¡ä»¥æ–‡å­—å½¢å¼ç½—åˆ—å‡ºæ¥ï¼š</p>
<ol>
<li>æ›´æ–°æ‰€æœ‰èŠ‚ç‚¹çš„yumæº</li>
<li>åœ¨NginXèŠ‚ç‚¹é€šè¿‡yumå®‰è£…NginX 1.12</li>
<li>åœ¨tomcatèŠ‚ç‚¹é€šè¿‡yumå®‰è£…Java 8</li>
<li>è§£å‹tomcatå®‰è£…åŒ…åˆ°tomcatèŠ‚ç‚¹çš„å®‰è£…ç›®å½•</li>
<li>é…ç½®tomcatï¼ˆæ·»åŠ ç¯å¢ƒå˜é‡ã€å¼€æœºè‡ªå¯ã€å¼€æ”¾8080ç«¯å£ç­‰ï¼‰</li>
<li>å°†examples.war v1.0å‘å¸ƒåˆ°tomcatå¹¶å¯åŠ¨tomcatï¼ˆå› åˆå§‹å·²æœ‰examplesï¼Œæ”¹ä¸ºæ›¿æ¢é¦–é¡µï¼‰</li>
<li>é…ç½®NginXå¹¶å¯åŠ¨</li>
<li>åœæ­¢vm_tomcat_1ä¸Šçš„tomcatï¼Œå°†examples.war v2.0å‘å¸ƒåˆ°tomcatå¹¶å¯åŠ¨</li>
<li>ç­‰å¾…vm_tomcat_1çš„tomcatå¯åŠ¨æ­£å¸¸</li>
<li>åœæ­¢vm_tomcat_2ä¸Šçš„tomcatï¼Œå°†examples.war v2.0å‘å¸ƒåˆ°tomcatå¹¶å¯åŠ¨</li>
<li>ç­‰å¾…vm_tomcat_2çš„tomcatå¯åŠ¨æ­£å¸¸</li>
<li>é‡å¤æ­¥éª¤8~11ï¼Œä½†æ”¹ç”¨examples.war v1.0ï¼Œæ¨¡æ‹Ÿå›é€€è¿‡ç¨‹</li>
</ol>
<hr>
<p>æ®æ­¤ï¼Œå¯ä½œä»¥ä¸‹è§„åˆ’ã€‚</p>
<p>è§’è‰²è®¾å®šï¼š</p>
<table>
<thead>
<tr>
<th>role</th>
<th>è¯´æ˜</th>
<th>åŒ…å«æ­¥éª¤</th>
</tr>
</thead>
<tbody>
<tr>
<td>tomcat</td>
<td>å®‰è£…Java 8ï¼Œtomcat 8ï¼Œå¹¶æ›¿æ¢examplesé¦–é¡µ</td>
<td>1ï¼Œ3 ~ 6</td>
</tr>
<tr>
<td>nginx</td>
<td>å®‰è£…NginX 1.12</td>
<td>1ï¼Œ2ï¼Œ7</td>
</tr>
<tr>
<td>upgrade</td>
<td>å‡çº§åˆ°examples.war v2.0</td>
<td>8 ~ 11</td>
</tr>
<tr>
<td>rollback</td>
<td>å›é€€åˆ°examples.war v1.0</td>
<td>12</td>
</tr>
</tbody>
</table>
<p>ä¸»æœºç»„åˆ’åˆ†ï¼š</p>
<table>
<thead>
<tr>
<th>group</th>
<th>hosts</th>
<th>roles</th>
</tr>
</thead>
<tbody>
<tr>
<td>lb</td>
<td>vm_nginx</td>
<td>nginx</td>
</tr>
<tr>
<td>web</td>
<td>vm_tomcat_1<br>vm_tomcat_2</td>
<td>tomcat<br>upgrade<br>rollback</td>
</tr>
</tbody>
</table>
<p>å…¥å£playbookåˆ’åˆ†ï¼š</p>
<table>
<thead>
<tr>
<th>name</th>
<th>roles</th>
</tr>
</thead>
<tbody>
<tr>
<td>start.yml</td>
<td>tomcat<br>nginx</td>
</tr>
<tr>
<td>upgrade.yml</td>
<td>upgrade</td>
</tr>
<tr>
<td>rollback.yml</td>
<td>rollback</td>
</tr>
</tbody>
</table>
<p><strong>å®Œæ•´çš„playbookç›®å½•ç»“æ„å¦‚ä¸‹:</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos <span class="built_in">test</span>]<span class="comment"># tree ansible_tomcat_cluster/</span></span><br><span class="line">ansible_tomcat_cluster/</span><br><span class="line">|-- ansible.cfg</span><br><span class="line">|-- group_vars</span><br><span class="line">|   `-- web</span><br><span class="line">|       `-- main.yaml <span class="comment"># å¯¹webç»„å¯è§çš„å˜é‡ï¼ˆå‚æ•°ï¼‰</span></span><br><span class="line">|-- hosts</span><br><span class="line">`-- roles</span><br><span class="line">    |-- nginx</span><br><span class="line">    |   |-- files</span><br><span class="line">    |   |   `-- nginx.conf <span class="comment"># ç”¨äºæ›¿æ¢/etc/nginx/nginx.confï¼Œå·²ä½œå¥½è´Ÿè½½å‡è¡¡é…ç½®</span></span><br><span class="line">    |   `-- tasks</span><br><span class="line">    |       `-- main.yml <span class="comment"># æ¯ä¸ªtasksä¸‹çš„main.ymlï¼ˆæˆ–main.yaml)æ˜¯å¯¹åº”roleçš„ä¸»æµç¨‹</span></span><br><span class="line">    |-- rollback</span><br><span class="line">    |   |-- files</span><br><span class="line">    |   |   `-- examples.war <span class="comment"># æ­¤ä¸º1.0ç‰ˆæœ¬ï¼ŒçœŸå®ç¯å¢ƒä¸­ï¼Œä¸€èˆ¬ä¼šä»è¿œç¨‹ç‰ˆæœ¬åº“è·å–ï¼Œæ­¤å¤„æ˜¯é¢„å…ˆå‡†å¤‡å¥½</span></span><br><span class="line">    |   |-- handlers</span><br><span class="line">    |   |   `-- main.yml</span><br><span class="line">    |   `-- tasks</span><br><span class="line">    |       `-- main.yml</span><br><span class="line">    |-- rollback.yml</span><br><span class="line">    |-- start.yml <span class="comment"># æ‰§è¡Œæ­¤playbookï¼Œä¼šå¯¹lbå’Œwebç»„åˆ†åˆ«æ‰§è¡Œnginxå’Œtomcat roleçš„ä¸»æµç¨‹</span></span><br><span class="line">    |-- tomcat</span><br><span class="line">    |   |-- files</span><br><span class="line">    |   |   `-- apache-tomcat-8.5.38.tar.gz <span class="comment"># é¢„ç½®çš„tomcat8è§£å‹å®‰è£…åŒ…</span></span><br><span class="line">    |   |-- tasks</span><br><span class="line">    |   |   `-- main.yaml</span><br><span class="line">    |   |-- templates</span><br><span class="line">    |   |   `-- index.html <span class="comment"># é¦–é¡µæ¨¡æ¿ï¼Œç”¨äºæ›¿æ¢examplesçš„é¦–é¡µã€‚æ­¤å¤„æ¼”ç¤ºæ¨¡æ¿çš„å˜é‡æ³¨å…¥</span></span><br><span class="line">    |   `-- vars</span><br><span class="line">    |       `-- main.yaml <span class="comment"># ä»…å¯¹role tomcatå¯è§çš„å˜é‡ï¼ˆå‚æ•°ï¼‰</span></span><br><span class="line">    |-- upgrade</span><br><span class="line">    |   |-- files</span><br><span class="line">    |   |   `-- examples.war <span class="comment"># æ­¤ä¸º2.0ç‰ˆæœ¬</span></span><br><span class="line">    |   |-- handlers</span><br><span class="line">    |   |   `-- main.yml <span class="comment"># æ­¤å¤„æ¼”ç¤ºå¤„ç†å™¨çš„ç”¨æ³•ï¼Œç”±notifyè§¦å‘ï¼ˆè§upgrade/tasks/main.ymlï¼‰</span></span><br><span class="line">    |   `-- tasks</span><br><span class="line">    |       `-- main.yml</span><br><span class="line">    `-- upgrade.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>inventoryï¼ˆå³hostsæ–‡ä»¶ï¼‰ï¼š</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos <span class="built_in">test</span>]<span class="comment"># cat ansible_tomcat/hosts</span></span><br><span class="line">[web]</span><br><span class="line">vm_tomcat_1 ansible_host=118.24.217.91 mytitle=<span class="string">"this is vm01"</span></span><br><span class="line">vm_tomcat_2 ansible_host=188.131.133.107 mytitle=<span class="string">"this is vm02"</span></span><br><span class="line"></span><br><span class="line">[lb]</span><br><span class="line">vm_nginx ansible_host=188.131.133.107</span><br></pre></td></tr></table></figure>
<ul>
<li>role nginxçš„ä»»åŠ¡ç¼–æ’ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å®‰è£…NginX</span> <span class="string">"<span class="template-variable">&#123;&#123; nginx_version &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">yum-utils</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">"nginx-<span class="template-variable">&#123;&#123; nginx_version &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">é…ç½®NginX</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=nginx.conf</span> <span class="string">dest=/etc/nginx/</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å¯åŠ¨NginX</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å¯ç”¨é˜²ç«å¢™</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=firewalld</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å¼€å¯80ç«¯å£ï¼ˆä¸´æ—¶ï¼‰</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">firewall-cmd</span> <span class="string">--zone=public</span> <span class="string">--add-port=80/tcp</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ç­‰å¾…80ç«¯å£å¯åŠ¨</span></span><br><span class="line">  <span class="attr">wait_for:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br></pre></td></tr></table></figure>
<ul>
<li>role tomcatçš„ä»»åŠ¡ç¼–æ’ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@VM_0_7_centos</span> <span class="string">test]#</span> <span class="string">cat</span> <span class="string">ansible_tomcat/roles/install/tasks/main.yaml</span> </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å®‰è£…Java8</span></span><br><span class="line">  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">yum-utils</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">java-1.8.0</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å°†tomcat8è§£å‹ç¼©åˆ°å®‰è£…ç›®å½•ä¸‹</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">"<span class="template-variable">&#123;&#123; app_name &#125;&#125;</span>.tar.gz"</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">"<span class="template-variable">&#123;&#123; install_path &#125;&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">æ³¨å†Œtomcatç¯å¢ƒå˜é‡</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/profile</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"export CATALINA_HOME=/usr/local/apache-tomcat-8.5.38/"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"export PATH=$CATALINA_HOME/bin:$PATH"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">æ£€æµ‹tomcatå®‰è£…ç›®å½•æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">  <span class="attr">stat:</span> <span class="string">path=&#123;&#123;</span> <span class="string">tomcat_home</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="comment"># æ­¤å¤„æ¼”ç¤ºregisterç”¨æ³•ï¼Œå¯åœ¨åé¢çš„æ­¥éª¤ä¸­æ‰“å°&#123;&#123; check_tomcat_result &#125;&#125;ä»¥è§‚å¯Ÿå…¶å€¼</span></span><br><span class="line">  <span class="attr">register:</span> <span class="string">check_tomcat_result</span></span><br><span class="line">  <span class="attr">failed_when:</span> <span class="string">not</span> <span class="string">check_tomcat_result.stat.exists</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">æ›¿æ¢examplesé¦–é¡µ</span></span><br><span class="line">  <span class="attr">template:</span> <span class="string">src=index.html</span>  <span class="string">dest="&#123;&#123;</span> <span class="string">tomcat_home</span> <span class="string">&#125;&#125;/webapps/examples/index.html"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å¯åŠ¨tomcat</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">nohup</span> <span class="string">"<span class="template-variable">&#123;&#123; tomcat_home &#125;&#125;</span>/bin/startup.sh"</span> <span class="string">&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å¯ç”¨é˜²ç«å¢™</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=firewalld</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å¼€å¯8080ç«¯å£ï¼ˆä¸´æ—¶ï¼‰</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">firewall-cmd</span> <span class="string">--zone=public</span> <span class="string">--add-port=8080/tcp</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ç­‰å¾…8080ç«¯å£å¯åŠ¨</span></span><br><span class="line">  <span class="attr">wait_for:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">started</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">é…ç½®tomcatå¼€æœºè‡ªå¯åŠ¨</span></span><br><span class="line">  <span class="attr">lineinfile:</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">/etc/profile</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">    <span class="attr">line:</span> <span class="string">"<span class="template-variable">&#123;&#123; item &#125;&#125;</span>"</span></span><br><span class="line">  <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"<span class="template-variable">&#123;&#123; tomcat_home &#125;&#125;</span>/bin/startup.sh &amp;"</span></span><br></pre></td></tr></table></figure>
<p><strong>æ‰§è¡Œnginxå’Œtomcatçš„å®‰è£…éƒ¨ç½²ï¼š</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos <span class="built_in">test</span>]<span class="comment"># ansible-playbook roles/start.yml</span></span><br></pre></td></tr></table></figure>
<p>ç»“æœå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551012654701.png" alt="1551012654701"></p>
<p>æ£€éªŒç¯å¢ƒå˜é‡æ˜¯å¦å·²å†™å…¥<code>/etc/profile</code>ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551012868529.png" alt="1551012868529"></p>
<p>æ£€éªŒtomcatå¼€æœºè‡ªå¯åŠ¨æ˜¯å¦å·²å†™å…¥<code>/etc/rc.local</code>ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551014113584.png" alt="1551014113584"></p>
<p>æ£€éªŒindex.htmlæ¨¡æ¿æ˜¯å¦æ³¨å…¥æˆåŠŸï¼š</p>
<p>â€‹    é¢„ç½®çš„index.htmlæ¨¡æ¿ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1550722583627.png" alt="1550722583627"></p>
<p>â€‹    æ³¨å…¥å˜é‡åï¼Œh3æ ‡ç­¾å€¼å˜æˆäº†â€this is vm01â€ï¼ˆå¦ä¸€ä¸ªèŠ‚ç‚¹æ˜¯â€this is vm02â€ï¼‰ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551014256905.png" alt="1551014256905"></p>
<p>æ£€éªŒNginXè´Ÿè½½å‡è¡¡æ˜¯å¦ç”Ÿæ•ˆï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551015508452.png" alt="1551015508452"></p>
<p><strong>æ‰§è¡Œé€ä¸ªèŠ‚ç‚¹å‡çº§ï¼š</strong></p>
<p>upgrade.ymlï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">web</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">1</span> <span class="comment"># serialå€¼ä¸º1ï¼Œè¡¨ç¤ºä¸€ä¸ªä¸€ä¸ªèŠ‚ç‚¹åœ°æ‰§è¡Œ</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">upgrade</span> <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>upgrade/tasks/main.ymlï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">å‡çº§</span> <span class="string">|å…³é—­tomcat</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">sh</span> <span class="string">"<span class="template-variable">&#123;&#123; tomcat_home &#125;&#125;</span>/bin/shutdown.sh"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ç­‰å¾…8080ç«¯å£å…³é—­</span></span><br><span class="line">  <span class="attr">wait_for:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">stopped</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">clean</span> <span class="string">tomcat</span> <span class="string">cache</span> <span class="comment"># é€šçŸ¥handler "clean tomcat cache" å¤„ç†</span></span><br><span class="line"><span class="string">ï¼ˆå‰©ä½™ç•¥ï¼‰</span></span><br></pre></td></tr></table></figure>
<p>handlers/main.ymlï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">clean</span> <span class="string">tomcat</span> <span class="string">cache</span></span><br><span class="line">  <span class="attr">file:</span> <span class="string">path="&#123;&#123;</span> <span class="string">tomcat_home</span> <span class="string">&#125;&#125;/work/Catalina"</span> <span class="string">state=absent</span></span><br><span class="line">  <span class="attr">ignore_errors:</span> <span class="literal">yes</span></span><br></pre></td></tr></table></figure>
<p>æ¨¡æ‹Ÿåº”ç”¨å‡çº§çš„è¿‡ç¨‹è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ansible_tomcat_cluster]<span class="comment"># ansible-playbook roles/upgrade.yml</span></span><br></pre></td></tr></table></figure>
<p>â€‹    å…ˆå¯¹vm_tomat_1ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551016061521.png" alt="1551016061521"></p>
<p>â€‹    å†å¯¹vm_tomcat_2ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551016281860.png" alt="1551016281860"></p>
<p>å‡çº§åï¼Œä»æµè§ˆå™¨è®¿é—®å˜æˆäº†2.0ç‰ˆæœ¬ï¼ˆä¸¤ä¸ªèŠ‚ç‚¹çš„é¡µé¢ä¸€è‡´ï¼Œæœªä½œåŒºåˆ†ï¼‰ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551016392519.png" alt="1551016392519"></p>
<p><strong>æ‰§è¡Œé€ä¸ªèŠ‚ç‚¹å›é€€ï¼š</strong></p>
<p>rollbackå‰§æœ¬å†…å®¹ä¸upgradeç›¸ä¼¼ï¼Œä»ç•¥ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_7_centos ansible_tomcat_cluster]<span class="comment"># ansible-playbook roles/rollback.yml</span></span><br></pre></td></tr></table></figure>
<p>å›é€€è¿‡ç¨‹ç±»ä¼¼å‡çº§è¿‡ç¨‹ï¼Œç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551016579264.png" alt="1551016579264"></p>
<p>å›é€€åï¼Œä»æµè§ˆå™¨è®¿é—®å˜æˆäº†1.0ç‰ˆæœ¬ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/ansible-intro.assets/1551016791550.png" alt="1551016791550"></p>
<p>ä¸€åˆ‡ç¬¦åˆé¢„æœŸã€‚</p>
<p>è‡³æ­¤ï¼ŒNginX <em> 1 + Tomcat </em> 2æ–¹å¼éƒ¨ç½²waråŒ…ï¼Œç„¶åæ¨¡æ‹Ÿå‡çº§ã€å›é€€çš„è¿‡ç¨‹æ¼”ç¤ºå®Œæ¯•ã€‚å®Œæ•´çš„playbookè§<a href="https://github.com/zlzgithub/ansible_zlz/tree/master/tomcat_cluster" rel="external nofollow noopener noreferrer" target="_blank">gitlabä»“åº“</a></p>
<hr>
<p><em>P.s. ä»¥ä¸Šæ“ä½œä¸æ˜¯ä½¿ç”¨å¯†ç ï¼Œéœ€äº‹å…ˆä½œSSHå…å¯†è®¤è¯ã€‚</em></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ§åˆ¶ä¸»æœºç”Ÿæˆsshå¯†é’¥å¯¹ï¼Œç®€å•ç‚¹ï¼Œç›´æ¥ssh-keygenä¸å¸¦ä»»ä½•å‚æ•°</span></span><br><span class="line">ssh-keygen</span><br><span class="line"><span class="comment"># å‘é€ç»™è¢«æ§ä¸»æœº</span></span><br><span class="line">ssh-copy-id root@localhost	<span class="comment"># å¦‚æœè¦åœ¨æ§åˆ¶ä¸»æœºæ‰§è¡Œéƒ¨ç½²ï¼Œéœ€å‘é€å…¬é’¥ç»™è‡ªå·±</span></span><br><span class="line">ssh-copy-id root@&lt;ç›®æ ‡ä¸»æœºIP&gt;</span><br></pre></td></tr></table></figure>
<p><em>å…¶å®ƒæ¨¡å—çš„ç”¨æ³•ï¼ŒåŠé«˜çº§ç‰¹æ€§ï¼Œè¯·ç»“åˆå®é™…éœ€æ±‚ï¼Œé˜…è¯»å®˜æ–¹æ–‡æ¡£ã€ŠAnsible User Guideã€‹ã€‚</em></p>
<h3 id="Ansibleå‚è€ƒ"><a href="#Ansibleå‚è€ƒ" class="headerlink" title="Ansibleå‚è€ƒ"></a>Ansibleå‚è€ƒ</h3><ol>
<li><p><a href="https://docs.ansible.com/ansible/latest/user_guide/" rel="external nofollow noopener noreferrer" target="_blank">Ansible User Guide</a></p>
</li>
<li><p><a href="http://www.ansible.com.cn/" rel="external nofollow noopener noreferrer" target="_blank">Ansibleä¸­æ–‡æƒå¨æŒ‡å—</a></p>
</li>
<li><p><a href="https://blog.csdn.net/a105421548/article/details/53558598" rel="external nofollow noopener noreferrer" target="_blank">Ansibleå’ŒSaltStackçš„æ¯”è¾ƒå’Œé€‰å‹</a></p>
</li>
</ol>
<hr>
<p>ï¼ˆEndï¼‰</p>
]]></content>
      <categories>
        <category>CMDB</category>
      </categories>
      <tags>
        <tag>Ansible</tag>
        <tag>CMDB</tag>
      </tags>
  </entry>
  <entry>
    <title>é…ç½®ç®¡ç†</title>
    <url>/config-management/config-management/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>é…ç½®ç®¡ç†å·¥å…·å¯ä»¥æé«˜åº”ç”¨éƒ¨ç½²å’Œå˜æ›´çš„æ•ˆç‡ï¼Œè¿˜å¯ä»¥è®©è¿™äº›æµç¨‹å˜å¾—å¯é‡ç”¨ã€å¯æ‰©å±•ã€å¯é¢„æµ‹ï¼Œç”šè‡³è®©å®ƒä»¬ç»´æŒåœ¨æœŸæœ›çš„çŠ¶æ€ï¼Œä»è€Œè®©èµ„äº§çš„å¯æ§æ€§æé«˜ã€‚</p>
</blockquote>
<a id="more"></a>
<p>ä½¿ç”¨é…ç½®ç®¡ç†å·¥å…·çš„ä¼˜åŠ¿è¿˜åŒ…æ‹¬ï¼š</p>
<ul>
<li>è®©ä»£ç éµå®ˆç¼–ç è§„èŒƒï¼Œæé«˜ä»£ç å¯è¯»æ€§ï¼›</li>
<li>å…·æœ‰ <em>å¹‚ç­‰æ€§(Idempotency)</em>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡é‡å¤çš„é…ç½®ç®¡ç†æ“ä½œï¼Œå¾—åˆ°çš„ç»“æœéƒ½æ˜¯ä¸€è‡´çš„ï¼›</li>
<li>åˆ†å¸ƒå¼çš„è®¾è®¡å¯ä»¥æ–¹ä¾¿åœ°ç®¡ç†å¤§é‡çš„è¿œç¨‹æœåŠ¡å™¨ã€‚</li>
</ul>
<p>é…ç½®ç®¡ç†å·¥å…·ä¸»è¦åˆ†ä¸º <em>æ‹‰å–(pull)</em>æ¨¡å¼å’Œ <em>æ¨é€(push)</em>æ¨¡å¼ã€‚æ‹‰å–æ¨¡å¼æ˜¯æŒ‡å®‰è£…åœ¨å„å°æœåŠ¡å™¨ä¸Šçš„ <em>ä»£ç†(agent)</em>å®šæœŸä» <em>ä¸­å¤®å­˜å‚¨åº“(central repository)</em>æ‹‰å–æœ€æ–°çš„é…ç½®å¹¶åº”ç”¨åˆ°å¯¹åº”çš„æœåŠ¡å™¨ä¸Šï¼›è€Œæ¨é€æ¨¡å¼åˆ™ç”± <em>ä¸­å¤®æœåŠ¡å™¨(central server)</em>çš„ä¸­å¤®æœåŠ¡å™¨ä¼šè§¦å‘å…¶å®ƒå—ç®¡æœåŠ¡å™¨çš„æ›´æ–°ã€‚</p>
<p>ä¸‹åˆ—æ˜¯å‡ æ¬¾å¼€æºé…ç½®ç®¡ç†å·¥å…·ï¼Œå…¨éƒ½å…·æœ‰å¼€æºè®¸å¯è¯ã€ä½¿ç”¨å¤–éƒ¨é…ç½®æ–‡ä»¶ã€æ”¯æŒæ— äººå€¼å®ˆè¿è¡Œã€å¯ä»¥é€šè¿‡è„šæœ¬è‡ªå®šä¹‰è¿è¡Œã€‚</p>
<h2 id="Ansible"><a href="#Ansible" class="headerlink" title="Ansible"></a>Ansible</h2><p>â€œAnsible æ˜¯ä¸€ä¸ªæå…¶ç®€æ´çš„ IT è‡ªåŠ¨åŒ–å¹³å°ï¼Œå¯ä»¥è®©ä½ çš„åº”ç”¨å’Œç³»ç»Ÿä»¥æ›´ç®€å•çš„æ–¹å¼éƒ¨ç½²ã€‚ä¸éœ€è¦å®‰è£…ä»»ä½•ä»£ç†ï¼Œåªéœ€è¦ä½¿ç”¨ SSH çš„æ–¹å¼å’Œç®€å•çš„è¯­è¨€ï¼Œå°±å¯ä»¥å…å»è„šæœ¬æˆ–ä»£ç éƒ¨ç½²åº”ç”¨çš„è¿‡ç¨‹ã€‚â€â€”â€”<a href="https://github.com/ansible/ansible" rel="external nofollow noopener noreferrer" target="_blank">GitHub Ansible ä»£ç åº“</a></p>
<p>ç”±äº Ansible ä¸éœ€è¦ä»£ç†ï¼Œå› æ­¤å¯¹æœåŠ¡å™¨çš„èµ„æºæ¶ˆè€—ä¼šå¾ˆå°‘ã€‚Ansible é»˜è®¤ä½¿ç”¨çš„æ¨é€æ¨¡å¼éœ€è¦å€ŸåŠ© SSH è¿æ¥ï¼Œä½† Ansible ä¹Ÿæ”¯æŒæ‹‰å–æ¨¡å¼ã€‚<a href="https://opensource.com/article/18/8/ansible-playbooks-you-should-try" rel="external nofollow noopener noreferrer" target="_blank">å‰§æœ¬</a> å¯ä»¥ä½¿ç”¨æœ€å°‘çš„å‘½ä»¤é›†ç¼–å†™ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥æ‰©å±•ä¸ºæ›´åŠ ç²¾ç»†çš„è‡ªåŠ¨åŒ–ä»»åŠ¡ï¼ŒåŒ…æ‹¬å¼•å…¥è§’è‰²ã€å˜é‡å’Œå…¶å®ƒäººå†™çš„æ¨¡å—ã€‚</p>
<blockquote>
<p><em><a href="https://docs.ansible.com/ansible/latest/index.html" rel="external nofollow noopener noreferrer" target="_blank">Ansible</a> is an IT automation tool. It can configure systems, deploy software, and orchestrate more advanced IT tasks such as continuous deployments or zero downtime rolling updates.</em></p>
<p><a href="https://docs.ansible.com/ansible/latest/index.html" rel="external nofollow noopener noreferrer" target="_blank"><strong>Ansible</strong></a> æ˜¯ä¸€ä¸ªITè‡ªåŠ¨åŒ–å·¥å…·ã€‚å®ƒå¯ä»¥é…ç½®ç³»ç»Ÿï¼Œéƒ¨ç½²è½¯ä»¶ä»¥åŠç¼–æ’æ›´é«˜çº§çš„ITä»»åŠ¡ï¼Œä¾‹å¦‚æŒç»­éƒ¨ç½²æˆ–é›¶åœæœºæ»šåŠ¨æ›´æ–°ã€‚</p>
</blockquote>
<p><img src="https://www.ansible.com/hubfs/Images/blog-social/Ansible-Blog-Network-Pool-Gradient-Header.png" alt="img"></p>
<h2 id="Puppet"><a href="#Puppet" class="headerlink" title="Puppet"></a>Puppet</h2><p>â€œPuppet æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ Linuxã€Unix å’Œ Windows ç³»ç»Ÿä¸Šè¿è¡Œçš„è‡ªåŠ¨åŒ–ç®¡ç†å¼•æ“ï¼Œå®ƒå¯ä»¥æ ¹æ®é›†ä¸­çš„è§„èŒƒæ¥æ‰§è¡Œè¯¸å¦‚æ·»åŠ ç”¨æˆ·ã€å®‰è£…è½¯ä»¶åŒ…ã€æ›´æ–°æœåŠ¡å™¨é…ç½®ç­‰ç­‰ç®¡ç†ä»»åŠ¡ã€‚â€â€”â€”<a href="https://github.com/puppetlabs/puppet" rel="external nofollow noopener noreferrer" target="_blank">GitHub Puppet ä»£ç åº“</a></p>
<ul>
<li><a href="https://puppet.com/" rel="external nofollow noopener noreferrer" target="_blank">å®˜ç½‘</a></li>
<li><a href="https://puppet.com/docs" rel="external nofollow noopener noreferrer" target="_blank">æ–‡æ¡£</a></li>
<li><a href="https://puppet.com/community" rel="external nofollow noopener noreferrer" target="_blank">ç¤¾åŒº</a></li>
</ul>
<p>Puppet ä½œä¸ºä¸€æ¬¾é¢å‘è¿ç»´å·¥ç¨‹å¸ˆå’Œç³»ç»Ÿç®¡ç†å‘˜çš„å·¥å…·ï¼Œåœ¨æ›´å¤šæƒ…å†µä¸‹æ˜¯ä½œä¸ºé…ç½®ç®¡ç†å·¥å…·æ¥ä½¿ç”¨ã€‚å®ƒé€šè¿‡å®¢æˆ·ç«¯-æœåŠ¡ç«¯çš„æ¨¡å¼å·¥ä½œï¼Œä½¿ç”¨ä»£ç†ä»ä¸»æœåŠ¡å™¨è·å–é…ç½®æŒ‡ä»¤ã€‚</p>
<p>Puppet ä½¿ç”¨ <em>å£°æ˜å¼è¯­è¨€(declarative language)</em>æˆ– Ruby æ¥æè¿°ç³»ç»Ÿé…ç½®ã€‚å®ƒåŒ…å«äº†ä¸åŒçš„æ¨¡å—ï¼Œå¹¶ä½¿ç”¨ <em>æ¸…å•æ–‡ä»¶(manifest files)</em>è®°å½•æœŸæœ›è¾¾åˆ°çš„ç›®æ ‡çŠ¶æ€ã€‚Puppet é»˜è®¤ä½¿ç”¨æ¨é€æ¨¡å¼ï¼Œä½†ä¹Ÿæ”¯æŒæ‹‰å–æ¨¡å¼ã€‚</p>
<h2 id="Salt"><a href="#Salt" class="headerlink" title="Salt"></a>Salt</h2><p>â€œä¸ºå¤§è§„æ¨¡åŸºç¡€ç»“æ„æˆ–åº”ç”¨ç¨‹åºå®ç°è‡ªåŠ¨åŒ–ç®¡ç†çš„è½¯ä»¶ã€‚â€â€”â€”<a href="https://github.com/saltstack/salt" rel="external nofollow noopener noreferrer" target="_blank">GitHub Salt ä»£ç åº“</a></p>
<ul>
<li><a href="https://www.saltstack.com/" rel="external nofollow noopener noreferrer" target="_blank">å®˜ç½‘</a></li>
<li><a href="https://docs.saltstack.com/en/latest/contents.html" rel="external nofollow noopener noreferrer" target="_blank">æ–‡æ¡£</a></li>
<li><a href="https://www.saltstack.com/resources/community/" rel="external nofollow noopener noreferrer" target="_blank">ç¤¾åŒº</a></li>
</ul>
<p>Salt çš„ä¸“é•¿å°±æ˜¯å¿«é€Ÿæ”¶é›†æ•°æ®ï¼Œå³ä½¿æ˜¯ä¸Šä¸‡å°æœåŠ¡å™¨ä¹Ÿèƒ½å¤Ÿè½»æ¾å®Œæˆä»»åŠ¡ã€‚å®ƒä½¿ç”¨ Python æ¨¡å—æ¥ç®¡ç†é…ç½®ä¿¡æ¯å’Œæ‰§è¡Œç‰¹å®šçš„æ“ä½œï¼Œè¿™äº›æ¨¡å—å¯ä»¥è®© Salt å®ç°æ‰€æœ‰è¿œç¨‹æ“ä½œå’ŒçŠ¶æ€ç®¡ç†ã€‚ä½†é…ç½® Salt æ¨¡å—å¯¹æŠ€æœ¯æ°´å¹³æœ‰ä¸€å®šçš„è¦æ±‚ã€‚</p>
<p>Salt ä½¿ç”¨å®¢æˆ·ç«¯-æœåŠ¡ç«¯çš„ç»“æ„ï¼ˆSalt minions æ˜¯å®¢æˆ·ç«¯ï¼Œè€Œ Salt master æ˜¯æœåŠ¡ç«¯ï¼‰ï¼Œå¹¶ä»¥ Salt çŠ¶æ€æ–‡ä»¶è®°å½•éœ€è¦è¾¾åˆ°çš„ç›®æ ‡çŠ¶æ€ã€‚</p>
]]></content>
      <categories>
        <category>CMDB</category>
      </categories>
      <tags>
        <tag>CMDB</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitå‘½ä»¤å¤‡å¿˜</title>
    <url>/config-management/git-memo/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h3 id="åˆ›å»ºè¿œç¨‹ä»“åº“"><a href="#åˆ›å»ºè¿œç¨‹ä»“åº“" class="headerlink" title="åˆ›å»ºè¿œç¨‹ä»“åº“"></a>åˆ›å»ºè¿œç¨‹ä»“åº“</h3><h4 id="init-remote"><a href="#init-remote" class="headerlink" title="init, remote"></a>init, remote</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä»¥githubä¸ºä¾‹ï¼Œå…ˆåœ¨githubä¸Šæ–°å»ºè¿œç¨‹ä»“åº“git_repo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæœ¬åœ°ä»“åº“</span></span><br><span class="line">mkdir git_repo</span><br><span class="line"><span class="built_in">cd</span> git_repo</span><br><span class="line">git init</span><br><span class="line"></span><br><span class="line"><span class="comment"># githubä¸Šåˆ›å»ºçš„æ–°ä»“åº“æ˜¯é»˜è®¤çš„è¿œç¨‹ç‰ˆæœ¬åº“åç§°æ˜¯originï¼Œé»˜è®¤åˆ†æ”¯master</span></span><br><span class="line"><span class="comment"># æ·»åŠ è¿œç¨‹ç‰ˆæœ¬åº“è®¾ç½®</span></span><br><span class="line"><span class="comment"># git remote add origin https://github.com/&lt;github_user&gt;/git_repo.git</span></span><br><span class="line">git remote add origin git@github.com:&lt;github_user&gt;/git_repo.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¿œç¨‹ç‰ˆæœ¬åº“è®¾ç½®</span></span><br><span class="line">git remote -v</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è¿œç¨‹ç‰ˆæœ¬åº“è®¾ç½®(originç”¨æˆ·)</span></span><br><span class="line">git remote remove origin</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¹Ÿå¯å°è¯•ç›´æ¥ç¼–è¾‘.gité‡Œçš„ç›¸åº”æ–‡ä»¶æ¥ä¿®æ”¹è®¾ç½®</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546331161329.png" alt="1546331161329"></p>
<h4 id="add-commit-push"><a href="#add-commit-push" class="headerlink" title="add, commit, push"></a>add, commit, push</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">git status</span><br><span class="line">git add .</span><br><span class="line">git commit -m <span class="string">"..."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">git add .</span><br><span class="line">git status	<span class="comment"># æŸ¥çœ‹çŠ¶æ€</span></span><br><span class="line">git commit -m <span class="string">"..."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ–‡ä»¶</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">git add -A</span><br><span class="line">git commit -m <span class="string">"..."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­ä¿®æ”¹</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># add &amp; commit</span></span><br><span class="line">git commit -a -m <span class="string">"..."</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># push</span></span><br><span class="line">git push -u origin master</span><br></pre></td></tr></table></figure>
<h3 id="åŸºäºè¿œç¨‹ä»“åº“ä¿®æ”¹"><a href="#åŸºäºè¿œç¨‹ä»“åº“ä¿®æ”¹" class="headerlink" title="åŸºäºè¿œç¨‹ä»“åº“ä¿®æ”¹"></a>åŸºäºè¿œç¨‹ä»“åº“ä¿®æ”¹</h3><h4 id="pullã€clone"><a href="#pullã€clone" class="headerlink" title="pullã€clone"></a>pullã€clone</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä¸è¿œç«¯åŒæ­¥</span></span><br><span class="line"><span class="built_in">cd</span> git_repo</span><br><span class="line">git pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸ä½¿ç”¨æœ¬åœ°git_repo</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/username/git_repo.git</span><br><span class="line"><span class="built_in">cd</span> git_repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹ ...</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">git commit -a -m <span class="string">"..."</span></span><br><span class="line">git push</span><br></pre></td></tr></table></figure>
<h3 id="æ–°å»ºã€åˆ‡æ¢åˆ†æ”¯"><a href="#æ–°å»ºã€åˆ‡æ¢åˆ†æ”¯" class="headerlink" title="æ–°å»ºã€åˆ‡æ¢åˆ†æ”¯"></a>æ–°å»ºã€åˆ‡æ¢åˆ†æ”¯</h3><h4 id="checkout"><a href="#checkout" class="headerlink" title="checkout"></a>checkout</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> git_repo</span><br><span class="line"><span class="comment"># åŸºäºé»˜è®¤åˆ†æ”¯masterï¼Œæ–°å»ºåä¸ºtestçš„åˆ†æ”¯ï¼Œå¹¶åˆ‡æ¢è‡³teståˆ†æ”¯</span></span><br><span class="line">git checkout -b <span class="built_in">test</span></span><br><span class="line">git push -u origin <span class="built_in">test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å·²ç»å­˜åœ¨teståˆ†æ”¯æ—¶ï¼Œä¸åŠ "-b"åˆ‡æ¢</span></span><br><span class="line">git checkout <span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<h3 id="ä¿®æ”¹å†å²æäº¤"><a href="#ä¿®æ”¹å†å²æäº¤" class="headerlink" title="ä¿®æ”¹å†å²æäº¤"></a>ä¿®æ”¹å†å²æäº¤</h3><h4 id="revert"><a href="#revert" class="headerlink" title="revert"></a>revert</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> git_repo</span><br><span class="line">git pull</span><br><span class="line">git <span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’¤é”€ä¸Šæ¬¡æäº¤ï¼Œä¼šäº§ç”Ÿä¸€æ¬¡æ–°çš„æäº¤ï¼Œä¸ä¸Šä¸Šæ¬¡å†…å®¹çš„ç›¸åŒ</span></span><br><span class="line">git revert HEAD</span><br></pre></td></tr></table></figure>
<h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é‡ç½®åˆ°ä¸Šä¸Šæ¬¡æäº¤</span></span><br><span class="line">git reset --hard HEAD^</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡ç½®åˆ°æŒ‡å®šcommit</span></span><br><span class="line">git reset --hard &lt;commit_id&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡ç½®åï¼Œæ»åäºè¿œç¨‹ç‰ˆæœ¬åº“ï¼Œéœ€å¼ºåˆ¶push</span></span><br><span class="line">git push origin master -f</span><br></pre></td></tr></table></figure>
<h4 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ”¹å˜åŸºçº¿</span></span><br><span class="line">git rebase -i &lt;commit_id&gt;</span><br><span class="line"><span class="comment"># ä¿®æ”¹</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">git add .</span><br><span class="line">git commit --amend</span><br><span class="line">git rebase --<span class="built_in">continue</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line">git push origin master -f</span><br></pre></td></tr></table></figure>
<p>rebaseå‰ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546334928965.png" alt="1546334928965"></p>
<p>rebaseåˆ°5c9afï¼š</p>
<p>æ‰§è¡Œgit rebase -i &lt;commit_id&gt;åï¼Œä¼šè‡ªåŠ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œpickè¡¨ç¤ºé€‰å–æŸäº›æäº¤ï¼Œeditè¡¨ç¤ºé€‰å–å¹¶ç¼–è¾‘æŸäº›æäº¤ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546335631435.png" alt="1546335631435"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546335712261.png" alt="1546335712261"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546335005491.png" alt="1546335005491"></p>
<p>å› ä¸Šé¢ä¿®æ”¹äº†2è¡Œä¸ºeditï¼Œeditç¬¬äºŒæ¬¡ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1546335118983.png" alt="1546335118983"></p>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Gitå¤šè´¦å·é…ç½®</title>
    <url>/config-management/multi-git-account-configure/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>å‡è®¾æœ‰2ä¸ªgithubè´¦å·ï¼Œmygithubï¼ˆdefaultï¼‰å’Œmygithub2ï¼Œè¦åœ¨åŒä¸€ä¸ªgitå®¢æˆ·ç«¯ä¸‹ä½¿ç”¨ï¼Œå¯æŒ‰ä»¥ä¸‹é…ç½®ã€‚</p>
<h3 id="ç”ŸæˆSSH-Key"><a href="#ç”ŸæˆSSH-Key" class="headerlink" title="ç”ŸæˆSSH Key"></a>ç”ŸæˆSSH Key</h3><p><code>mygithub</code>çš„ssh keyå·²æŒ‰é»˜è®¤ç”Ÿæˆï¼Œå¯¹åº”id_rsaã€‚å†ç”Ÿæˆ<code>mygithub2</code>è´¦å·çš„ssh keyï¼Œå‡è®¾å–åä¸ºmygithub2ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/.ssh</span><br><span class="line"><span class="comment"># ssh-keygen -t rsa -b 4096 -C &lt;email&gt; -f mygithub2</span></span><br><span class="line">ssh-keygen -f mygithub2</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ç”Ÿæˆsshå¯†é’¥å¯¹ä¹‹åï¼Œç™»å½•githubï¼Œå°†å…¬é’¥è®°å½•åˆ°mygithub2è´¦æˆ·ä¸­ã€‚</p>
<h3 id="æ·»åŠ å¤šè´¦å·é…ç½®æ–‡ä»¶"><a href="#æ·»åŠ å¤šè´¦å·é…ç½®æ–‡ä»¶" class="headerlink" title="æ·»åŠ å¤šè´¦å·é…ç½®æ–‡ä»¶"></a>æ·»åŠ å¤šè´¦å·é…ç½®æ–‡ä»¶</h3><p>åˆ›å»ºæ–‡ä»¶<code>~/.ssh/config</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/.ssh</span><br><span class="line">cat &lt;&lt;EOF &gt; config</span><br><span class="line"><span class="comment"># default</span></span><br><span class="line">Host github.com</span><br><span class="line">HostName github.com</span><br><span class="line">User mygithub</span><br><span class="line">IdentityFile ~/.ssh/id_rsa</span><br><span class="line"></span><br><span class="line"><span class="comment"># mygithub2</span></span><br><span class="line">Host mygithub2</span><br><span class="line">HostName github.com</span><br><span class="line">User mygithub2</span><br><span class="line">IdentityFile ~/.ssh/mygithub2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„Hostã€HostNameçš„å·®å¼‚ã€‚å¦‚æœæœ‰å…¶å®ƒä»£ç æ‰˜ç®¡å¹³å°çš„è´¦å·ï¼Œå¦‚<code>gitlabã€gitee</code>ï¼Œé‡æ–°æŒ‰ä»¥ä¸Šæ­¥éª¤è¿½åŠ ï¼Œå¡«å†™ç›¸åº”çš„HostNameã€Userå’Œssh keyæ–‡ä»¶ï¼Œå¹¶ä»¥ä¸åŒçš„Hostå€¼åŒºåˆ†ã€‚</p>
<h3 id="ä½¿ç”¨å¤šè´¦å·"><a href="#ä½¿ç”¨å¤šè´¦å·" class="headerlink" title="ä½¿ç”¨å¤šè´¦å·"></a>ä½¿ç”¨å¤šè´¦å·</h3><p>ä½¿ç”¨æ—¶ï¼Œå¯¹äºé»˜è®¤è´¦å·<code>mygithub</code>ï¼Œç”¨æ³•ä¸å˜ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># é»˜è®¤è´¦å·mygithubç”¨æ³•ä¸å˜</span></span><br><span class="line">git <span class="built_in">clone</span> git@github.com:mygithub/helloWorld.git</span><br></pre></td></tr></table></figure>
<p>å¯¹äº<code>mygithub2</code>ï¼Œ@github.comå˜æˆ@mygithub2ï¼Œå› <code>mygithub2</code>å¯¹åº”çš„Hostæ˜¯mygithub2ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@mygithub2:mygithub2/helloWorld.git</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸‹å›¾ï¼Œ<code>lzzeng</code>æ˜¯æˆ‘ä½¿ç”¨çš„ç¬¬äºŒgithubè´¦å·ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1550116067833.png" alt="1550116067833"></p>
<p>å¦‚æœäº‹å…ˆå·²cloneä¸‹æ¥ï¼Œå¯ä¿®æ”¹è¿œç¨‹ä»“åº“åœ°å€ä¸º @mygithub2æ ¼å¼ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> helloWorld</span><br><span class="line">git remote rm origin</span><br><span class="line">git remote add origin git@mygithub2:mygithub2/helloWorld.git</span><br></pre></td></tr></table></figure>
<p>æ­¤å¤–ï¼Œå› å…¨å±€é»˜è®¤ç”¨æˆ·æ˜¯<code>mygithub</code>ï¼Œå¦‚æœæƒ³åˆ‡æ¢åˆ°<code>mygithub2</code>ç”¨æˆ·çš„è¯ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> helloWorld</span><br><span class="line">git config --<span class="built_in">local</span> user.name mygithub2</span><br><span class="line">git config --<span class="built_in">local</span> user.email &lt;email&gt;</span><br></pre></td></tr></table></figure>
<h3 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h3><p>æ ¹æ®ä¸Šè¿°å†…å®¹ï¼Œå¯ä»¥å®Œæˆgitå¤šè´¦å·é…ç½®å¹¶ä½¿ç”¨ã€‚å¦å¤–ï¼Œç½‘ä¸Šèµ„æ–™æœ‰æåˆ°<code>ssh-agent</code>å’Œ<code>ssh-add</code>ï¼Œssh-agentæ˜¯ä¸€ä¸ªå¯†é’¥ç®¡ç†å™¨ï¼Œè¿è¡Œssh-agentä»¥åï¼Œä½¿ç”¨ssh-addå°†ç§é’¥äº¤ç»™ssh-agentä¿ç®¡ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ssh-agent bash	<span class="comment"># å¯ç”¨ssh-agent shell</span></span><br><span class="line">ssh-add -l	<span class="comment"># æ˜¾ç¤ºssh-agentä¸­çš„å¯†é’¥</span></span><br><span class="line">ssh-add -D	<span class="comment"># åˆ é™¤æ‰€æœ‰ç¼“å­˜çš„å¯†é’¥</span></span><br><span class="line">ssh-add  ~/.ssh/id_rsa	<span class="comment"># æŠŠç§é’¥æ·»åŠ åˆ°ssh-agentä¸­</span></span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@vm2	<span class="comment"># å°†å…¬é’¥å‘é€ç»™root@vm2ï¼Œä¹‹åå¯å…å¯†ç™»å½•root@vm2</span></span><br></pre></td></tr></table></figure>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>Git</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>éŸ³ä¹æ’­æ”¾å™¨ä¸€æš</title>
    <url>/demo/vue-music/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>ç”¨Vue.jså®ç°çš„ï¼Œæ— éœ€åç«¯ï¼Œæ­Œæ›²ä¿¡æ¯ã€æ­Œè¯å­˜æ”¾åœ¨æœ¬åœ°ï¼ˆä½¿ç”¨jsonpæ–¹å¼è§£æï¼‰ï¼Œæ­Œæ›²æ–‡ä»¶ä¸ºåœ¨çº¿å…è´¹é“¾æ¥ã€‚</p>
<p><a href="https://lzzeng.github.io/music/">demoåœ°å€</a></p>
</blockquote>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/image-20210906005802683.png" alt="image-20210906005802683" style="zoom:50%;"></p>
<a id="more"></a>
<p>æ’­æ”¾åˆ—è¡¨åŠæ­Œæ›²åˆ—è¡¨ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2021/image-20210906010018041.png" alt="image-20210906010018041"></p>
]]></content>
      <categories>
        <category>demo</category>
      </categories>
      <tags>
        <tag>Vue</tag>
      </tags>
  </entry>
  <entry>
    <title>awkå‘½ä»¤</title>
    <url>/linux/awk/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">awk <span class="string">'&#123;c[$1]++;&#125;END&#123;for(k in c)&#123;print k": "c[k];&#125;&#125;'</span> /var/<span class="built_in">log</span>/nginx/myalert_access.log</span><br><span class="line">113.118.106.137: 17</span><br><span class="line">113.116.28.35: 4171</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="ç»Ÿè®¡IPè®¿é—®æ¬¡æ•°"><a href="#ç»Ÿè®¡IPè®¿é—®æ¬¡æ•°" class="headerlink" title="ç»Ÿè®¡IPè®¿é—®æ¬¡æ•°"></a>ç»Ÿè®¡IPè®¿é—®æ¬¡æ•°</h2><h3 id="ç¤ºä¾‹1"><a href="#ç¤ºä¾‹1" class="headerlink" title="ç¤ºä¾‹1"></a>ç¤ºä¾‹1</h3><p>myalert_accessæ—¥å¿—æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">116.7.8.112 - - [14/Jun/2020:18:08:06 +0000] <span class="string">"GET / HTTP/1.1"</span> 302 0 <span class="string">"-"</span> <span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36"</span> <span class="string">"-"</span></span><br></pre></td></tr></table></figure>
<p>ç»Ÿè®¡ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">awk <span class="string">'&#123;c[$1]++;&#125;END&#123;for(k in c)&#123;print k": "c[k];&#125;&#125;'</span> /var/<span class="built_in">log</span>/nginx/myalert_access.log</span><br><span class="line">113.118.106.137: 17</span><br><span class="line">113.116.28.35: 4171</span><br><span class="line">112.97.49.195: 20</span><br><span class="line">116.7.8.112: 440</span><br></pre></td></tr></table></figure>
<h3 id="ç¤ºä¾‹2"><a href="#ç¤ºä¾‹2" class="headerlink" title="ç¤ºä¾‹2"></a>ç¤ºä¾‹2</h3><p>æ—¥å¿—ï¼š<br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Nov 25 13:33:03 VM_0_13_centos sshd[9327]: Invalid user ftp_user from 1.213.195.154 port 37113</span><br></pre></td></tr></table></figure></p>
<p>ç»Ÿè®¡ï¼š<br><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos ~]<span class="comment"># awk '&#123;a[$1]+=1;&#125;END&#123;for(i in a)&#123;print a[i]" "i;&#125;&#125;' /var/log/secure</span></span><br><span class="line">1532 Sep</span><br><span class="line">12542 Nov</span><br><span class="line">3895 Oct</span><br><span class="line">107725 Aug</span><br></pre></td></tr></table></figure></p>
<h2 id="å…³è”æŸ¥è¯¢"><a href="#å…³è”æŸ¥è¯¢" class="headerlink" title="å…³è”æŸ¥è¯¢"></a>å…³è”æŸ¥è¯¢</h2><p>ä» <code>ll</code> å‘½ä»¤çš„ç»“æœç­›é€‰å‡ºDocuments  Downloads Picturesçš„è¡Œï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 ~]<span class="comment"># ll</span></span><br><span class="line">total 4</span><br><span class="line">-rw-------. 1 root root 2744 Feb 15  2020 anaconda-ks.cfg</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Desktop</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Documents</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Downloads</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Music</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Pictures</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Public</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Templates</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Videos</span><br><span class="line"></span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo Documents Downloads Pictures |tr ' ' '\n' |awk -v vline="`ll |sed 's/^/echo /'`" 'BEGIN&#123;while(vline |getline) txt[$NF]=$0;&#125; &#123;print txt[$0];&#125;'</span></span><br><span class="line">drwxr-xr-x. 2 root root 6 Feb 15 2020 Documents</span><br><span class="line">drwxr-xr-x. 2 root root 6 Feb 15 2020 Downloads</span><br><span class="line">drwxr-xr-x. 2 root root 6 Feb 15 2020 Pictures</span><br></pre></td></tr></table></figure>
<p>ä»æ–‡ä»¶ <code>score</code> ä¸­æŸ¥æ‰¾a c eçš„è®°å½•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost code]<span class="comment"># cat score</span></span><br><span class="line">a 90</span><br><span class="line">b 99</span><br><span class="line">c 95</span><br><span class="line">d 88</span><br><span class="line">e 80</span><br><span class="line">f 89</span><br><span class="line">g 94</span><br><span class="line">[root@localhost code]<span class="comment"># echo a c e |tr ' ' '\n' |awk 'BEGIN&#123;while(getline &lt; "./score") txt[$1]=$0 &#125; &#123;print txt[$1];&#125;'</span></span><br><span class="line">a 90</span><br><span class="line">c 95</span><br><span class="line">e 80</span><br></pre></td></tr></table></figure>
<h2 id="åˆ—å‡ºå·²æŒ‚è½½çš„ç£ç›˜"><a href="#åˆ—å‡ºå·²æŒ‚è½½çš„ç£ç›˜" class="headerlink" title="åˆ—å‡ºå·²æŒ‚è½½çš„ç£ç›˜"></a>åˆ—å‡ºå·²æŒ‚è½½çš„ç£ç›˜</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 ~]<span class="comment"># lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0   20G  0 disk </span><br><span class="line">â”œâ”€sda1   8:1    0  300M  0 part /boot</span><br><span class="line">â”œâ”€sda2   8:2    0    2G  0 part [SWAP]</span><br><span class="line">â””â”€sda3   8:3    0 17.7G  0 part /</span><br><span class="line">sr0     11:0    1 1024M  0 rom  </span><br><span class="line">[root@kafka-1 ~]<span class="comment"># </span></span><br><span class="line">[root@kafka-1 ~]<span class="comment"># lsblk |awk '&#123;if($6=="disk") d=$1; if(substr($7,1,1)=="/") print d;&#125;' |sort -u</span></span><br><span class="line">sda</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>bashç¼–ç¨‹ â€”â€” getoptç”¨æ³•</title>
    <url>/linux/getopt/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>getoptçš„ç”¨æ³•</p>
</blockquote>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">filepath=$(<span class="built_in">cd</span> `dirname <span class="variable">$0</span>`; <span class="built_in">pwd</span>)</span><br><span class="line"></span><br><span class="line">show_usage=<span class="string">"args: [-s , -e , -n , -c][--sdate=, --edate=, --numprocs=, --cfile=]"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ -z <span class="variable">$@</span> ]];<span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$show_usage</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">GETOPT_ARGS=`getopt -o s:e:n::c: -al sdate:,edate:,numprocs::,cfile: -- <span class="string">"<span class="variable">$@</span>"</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo "$GETOPT_ARGS"</span></span><br><span class="line"><span class="built_in">eval</span> <span class="built_in">set</span> -- <span class="string">"<span class="variable">$GETOPT_ARGS</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ -n <span class="string">"<span class="variable">$1</span>"</span> ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">    -s|--sdate) sdate=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">    -e|--edate) edate=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">    -n|--numprocs) numprocs=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">    -c|--cfile) cfile=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">    --) <span class="built_in">break</span> ;;</span><br><span class="line">    *) <span class="built_in">echo</span> <span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$show_usage</span>; <span class="built_in">break</span> ;;</span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$sdate</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$edate</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$numprocs</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$cfile</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>grepå‘½ä»¤</title>
    <url>/linux/grep/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æå–åŒ¹é…åˆ°çš„å­—ç¬¦"><a href="#æå–åŒ¹é…åˆ°çš„å­—ç¬¦" class="headerlink" title="æå–åŒ¹é…åˆ°çš„å­—ç¬¦"></a>æå–åŒ¹é…åˆ°çš„å­—ç¬¦</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos demo]<span class="comment"># cat phone.txt</span></span><br><span class="line">987-123-4567</span><br><span class="line">123 456 7890</span><br><span class="line">(123) 456-7890</span><br><span class="line">[root@VM_0_13_centos demo]<span class="comment"># grep -o '\-[0-9]\&#123;3\&#125;' phone.txt</span></span><br><span class="line">-123</span><br><span class="line">-456</span><br><span class="line">-789</span><br><span class="line">[root@VM_0_13_centos demo]<span class="comment"># grep -no '\-[0-9]\&#123;3\&#125;' phone.txt</span></span><br><span class="line">1:-123</span><br><span class="line">1:-456</span><br><span class="line">3:-789</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="help"><a href="#help" class="headerlink" title="help"></a>help</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">/etc/nginx <span class="comment"># grep -h</span></span><br><span class="line">BusyBox v1.30.1 (2019-10-26 11:23:07 UTC) multi-call binary.</span><br><span class="line"></span><br><span class="line">Usage: grep [-HhnlLoqvsriwFE] [-m N] [-A/B/C N] PATTERN/-e PATTERN.../-f FILE [FILE]...</span><br><span class="line"></span><br><span class="line">Search <span class="keyword">for</span> PATTERN <span class="keyword">in</span> FILEs (or stdin)</span><br><span class="line"></span><br><span class="line">	-H	Add <span class="string">'filename:'</span> prefix</span><br><span class="line">	-h	Do not add <span class="string">'filename:'</span> prefix</span><br><span class="line">	-n	Add <span class="string">'line_no:'</span> prefix</span><br><span class="line">	-l	Show only names of files that match</span><br><span class="line">	-L	Show only names of files that don<span class="string">'t match</span></span><br><span class="line"><span class="string">	-c	Show only count of matching lines</span></span><br><span class="line"><span class="string">	-o	Show only the matching part of line</span></span><br><span class="line"><span class="string">	-q	Quiet. Return 0 if PATTERN is found, 1 otherwise</span></span><br><span class="line"><span class="string">	-v	Select non-matching lines</span></span><br><span class="line"><span class="string">	-s	Suppress open and read errors</span></span><br><span class="line"><span class="string">	-r	Recurse</span></span><br><span class="line"><span class="string">	-i	Ignore case</span></span><br><span class="line"><span class="string">	-w	Match whole words only</span></span><br><span class="line"><span class="string">	-x	Match whole lines only</span></span><br><span class="line"><span class="string">	-F	PATTERN is a literal (not regexp)</span></span><br><span class="line"><span class="string">	-E	PATTERN is an extended regexp</span></span><br><span class="line"><span class="string">	-m N	Match up to N times per file</span></span><br><span class="line"><span class="string">	-A N	Print N lines of trailing context</span></span><br><span class="line"><span class="string">	-B N	Print N lines of leading context</span></span><br><span class="line"><span class="string">	-C N	Same as '</span>-A N -B N<span class="string">'</span></span><br><span class="line"><span class="string">	-e PTRN	Pattern to match</span></span><br><span class="line"><span class="string">	-f FILE	Read pattern from file</span></span><br></pre></td></tr></table></figure>
<h2 id="è‹¥å¹²å¸¸ç”¨å‚æ•°"><a href="#è‹¥å¹²å¸¸ç”¨å‚æ•°" class="headerlink" title="è‹¥å¹²å¸¸ç”¨å‚æ•°"></a>è‹¥å¹²å¸¸ç”¨å‚æ•°</h2><p>grep -F <your pattern> file</your></p>
<p>-F å¯ç¦æ­¢patternè½¬ä¹‰ï¼Œä½¿æŒ‰åŸæ ·åŒ¹é…</p>
<p>-i å¯å¿½ç•¥å¤§å°å†™ï¼Œå¯ä»¥ä¸ -F ä¸€èµ·ç”¨</p>
<p>-n é™„å¸¦æ‰“å°è¡Œå·</p>
<p>-c ä»…è®¡æ•°</p>
<p>-x å®Œæ•´åŒ¹é…æ¨¡å¼ï¼ˆæ•´è¡ŒåŒ¹é…ï¼‰</p>
<p>-v åå‘åŒ¹é…ï¼ˆæ’é™¤ï¼‰</p>
<p>-r é€’å½’æŸ¥æ‰¾å½“å‰ç›®å½•åŠå­ç›®å½•ä¸‹çš„æ–‡ä»¶</p>
<p>-o, â€“only-matching. Print only the matched (non-empty) parts of a matching line, with each such part on a separate output line.</p>
<p>-q é™é»˜æ¨¡å¼</p>
<p>  -qæ—¶è™½ç„¶æ²¡æœ‰è¾“å‡ºå†…å®¹ï¼Œä½†æœ‰è¿”å›çŠ¶æ€å€¼ï¼Œå¯ä½œä¸ºæµ‹è¯•æ¡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/etc/nginx # grep -Fq &apos;30/Sep/2020:18:50:03&apos; /var/log/nginx/myalert_access.log          # è¾“å‡ºä¸ºç©º</span><br><span class="line">/etc/nginx # grep -Fq &apos;30/Ssep/2020:18:50:03&apos; /var/log/nginx/myalert_access.log         # è¾“å‡ºä¹Ÿä¸ºç©º</span><br><span class="line">/etc/nginx # grep -Fq &apos;30/Sep/2020:18:50:03&apos; /var/log/nginx/myalert_access.log; echo $?</span><br><span class="line">0</span><br><span class="line">/etc/nginx # grep -Fq &apos;30/Ssep/2020:18:50:03&apos; /var/log/nginx/myalert_access.log; echo $?</span><br><span class="line">1</span><br><span class="line">/etc/nginx # if grep -Fq &apos;30/Sep/2020:18:50:03&apos; /var/log/nginx/myalert_access.log; then echo Y; else echo N; fi</span><br><span class="line">Y</span><br><span class="line">/etc/nginx # if grep -Fq &apos;30/Ssep/2020:18:50:03&apos; /var/log/nginx/myalert_access.log; then echo N; else echo N; fi</span><br><span class="line">N</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux basic 01 â€”â€” è¯»ä¹¦ç¬”è®°</title>
    <url>/linux/linux-basic/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ã€Šé¸Ÿå“¥çš„ç§æˆ¿èœã€‹åœ¨çº¿ä¹¦ç± <a href="http://linux.vbird.org/linux_basic" rel="external nofollow noopener noreferrer" target="_blank">http://linux.vbird.org/linux_basic</a> çš„ç¬”è®°</p>
</blockquote>
<p>ç£ç›˜çš„ç¬¬ä¸€ä¸ªæ‰‡åŒºä¸»è¦è®°å½•äº†ä¸¤ä¸ªé‡è¦ä¿¡æ¯ï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<ul>
<li>ä¸»è¦å¯åŠ¨è®°å½•åŒº(Master Boot Record, MBR)ï¼šå¯ä»¥å®‰è£…å¼€æœºç®¡ç†ç¨‹åºçš„åœ°æ–¹ï¼Œæœ‰446 bytes</li>
<li>åˆ†åŒºè¡¨(partition table)ï¼šè®°å½•æ•´é¢—ç¡¬ç›˜åˆ†åŒºçš„çŠ¶æ€ï¼Œæœ‰64 bytes</li>
</ul>
<a id="more"></a>
<h2 id="ç£ç›˜åˆ†åŒº"><a href="#ç£ç›˜åˆ†åŒº" class="headerlink" title="ç£ç›˜åˆ†åŒº"></a>ç£ç›˜åˆ†åŒº</h2><p>åœ¨åˆ†åŒºè¡¨æ‰€åœ¨çš„64 byteså®¹é‡ä¸­ï¼Œæ€»å…±åˆ†ä¸ºå››ç»„è®°å½•åŒºï¼Œæ¯ç»„è®°å½•åŒºè®°å½•äº†è¯¥åŒºæ®µçš„èµ·å§‹åˆ°ç»“æŸç£æŸ±çš„å·ç ã€‚</p>
<p>P(primary)+E(extended)æœ€å¤šå§èƒ½æœ‰å››ä¸ªï¼Œå…¶ä¸­Eæœ€å¤šå§èƒ½æœ‰ä¸€ä¸ªã€‚</p>
<p>é¢˜ï¼šå‡å¦‚æˆ‘çš„PCæœ‰ä¸¤é¢—SATAç¡¬ç›˜ï¼Œæˆ‘æƒ³åœ¨ç¬¬äº‹é¢—ç¡¬ç›˜åˆ†å‰²å‡º6ä¸ªå¯ç”¨çš„åˆ†å‰²æ§½(å¯ä»¥è¢«æ ¼å¼åŒ–)ï¼Œ é‚£æ¯ä¸ªåˆ†å‰²æ§½åœ¨Linuxç³»ç»Ÿä¸‹çš„è£…ç½®æ–‡ä»¶åä¸ºä½•ï¼Ÿåˆ†å‰²ç±»å‹å„ä¸ºä½•ï¼Ÿè‡³å°‘å†™å‡ºä¸¤ç§ä¸åŒçš„åˆ†å‰²æ–¹æ¡ˆã€‚</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">PPP+Eæ–¹æ¡ˆ:</span><br><span class="line">/dev/sdb1, /dev/sdb2, /dev/sdb3, /dev/sdb5, /dev/sdb6, /dev/sdb7è¿™å…­ä¸ªï¼Œè‡³äº/dev/sdb4è¿™ä¸ªå»¶ä¼¸åˆ†å‰²æœ¬èº«ä»…æ˜¯æä¾›æ¥ç»™é€¡è¾‘åˆ†å‰²æ§½å»ºç«‹ä¹€ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">P+Eæ–¹æ¡ˆ:</span><br><span class="line">/dev/sdb1, /dev/sdb5, /dev/sdb6, /dev/sdb7, /dev/sdb8, /dev/sdb9</span><br></pre></td></tr></table></figure>
<p>ç®€å•åœ°è¯´ï¼Œæ•´ä¸ªå¼€æœºæµç¨‹åˆ°æ“ä½œç³»ç»Ÿä¹‹å‰çš„åŠ¨ä½œåº”è¯¥æ˜¯è¿™æ ·ï¼š</p>
<ul>
<li>BIOSï¼šå¼€æœºè‡ªåŠ¨æ‰§è¡Œçš„éŸ§ä½“ï¼Œä¼šè¯†åˆ«ç¬¬ä¸€ä¸ªå¯å¼€æœºçš„è£…ç½®ï¼›</li>
<li>MBRï¼šç¬¬ä¸€ä¸ªå¯å¼€æœºè£…ç½®çš„ç¬¬ä¸€ä¸ªåˆ†åŒºå†…çš„ä¸»è¦å¯åŠ¨è®°å½•åŒºå—ï¼Œå†…å«å¼€æœºç®¡ç†ç¨‹åºï¼›</li>
<li>å¼€æœºç®¡ç†ç¨‹åº(boot loader)ï¼šä¸€ä¸ªå¯è¯»å–æ ¸å¿ƒæ–‡ä»¶æ¥æ‰§è¡Œçš„è½¯ä»¶ï¼›</li>
<li>æ ¸å¿ƒæ¡£æ¡ˆï¼ˆæ–‡ä»¶ï¼‰ï¼šå¼€å§‹æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½â€¦</li>
</ul>
<p>Linuxå†…çš„æ‰€æœ‰èµ„æ–™éƒ½æ˜¯ä»¥æ¡£æ¡ˆçš„å½¢æ€æ¥å‘ˆç°çš„ï¼Œæ‰€ä»¥å•°ï¼Œæ•´ä¸ªLinuxç³»ç»Ÿæœ€é‡è¦çš„åœ°æ–¹å°±æ˜¯åœ¨äºç›®å½•æ ‘æ¶æ„</p>
<p>æ— è®ºå¦‚ä½•ï¼Œåº•ä¸‹è¿˜æ˜¯è¯´æ˜ä¸€ä¸‹åŸºæœ¬ç¡¬ç¢Ÿåˆ†å‰²çš„æ¨¡å¼å§ï¼</p>
<p>æœ€ç®€å•çš„åˆ†å‰²æ–¹æ³•ï¼š<br>è¿™ä¸ªåœ¨ä¸Šé¢ç¬¬äºŒèŠ‚å·²ç»è°ˆè¿‡äº†ï¼Œå°±æ˜¯ä»…åˆ†å‰²å‡ºæ ¹ç›®å½•ä¸è®°å¿†ä½“ç½®æ¢ç©ºé—´( / &amp; swap )å³å¯ã€‚ç„¶åå†é¢„ç•™ä¸€äº›å‰©ä½™çš„ç£ç¢Ÿä»¥ä¾›åç»­çš„ç»ƒä¹ ä¹‹ç”¨ã€‚ä¸è¿‡ï¼Œè¿™å½“ç„¶æ˜¯ä¸ä¿é™©çš„åˆ†å‰²æ–¹æ³•(æ‰€ä»¥é¸Ÿå“¥å¸¸å¸¸è¯´è¿™æ˜¯ã€æ‡’äººåˆ†å‰²æ³•ã€)ï¼å› ä¸ºå¦‚æœä»»ä½•ä¸€ä¸ªå°ç»†èŠ‚åæ‰(ä¾‹å¦‚åè½¨çš„äº§ç”Ÿ)ï¼Œä½ çš„æ ¹ç›®å½•å°†å¯èƒ½æ•´ä¸ªçš„æŸæ¯ï½æŒ½æ•‘æ–¹é¢è¾ƒå›°éš¾ï¼</p>
<p>ç¨å¾®éº»çƒ¦ä¸€ç‚¹çš„æ–¹å¼ï¼š<br>è¾ƒéº»çƒ¦ä¸€ç‚¹çš„åˆ†å‰²æ–¹å¼å°±æ˜¯å…ˆåˆ†æè¿™éƒ¨ä¸»æœºçš„æœªæ¥ç”¨é€”ï¼Œç„¶åæ ¹æ®ç”¨é€”å»åˆ†æéœ€è¦è¾ƒå¤§å®¹é‡çš„ç›®å½•ï¼Œä»¥åŠè¯»å†™è¾ƒä¸ºé¢‘ç¹çš„ç›®å½•ï¼Œå°†è¿™äº›é‡è¦çš„ç›®å½•åˆ†åˆ«ç‹¬ç«‹å‡ºæ¥è€Œä¸ä¸æ ¹ç›®å½•æ”¾åœ¨ä¸€èµ·ï¼Œé‚£å½“è¿™äº›è¯»å†™è¾ƒé¢‘ç¹çš„ç£ç¢Ÿåˆ†å‰²æ§½æœ‰é—®é¢˜æ—¶ï¼Œè‡³å°‘ä¸ä¼šå½±å“åˆ°æ ¹ç›®å½•çš„ç³»ç»Ÿèµ„æ–™ï¼Œé‚£æŒ½æ•‘æ–¹é¢å°±æ¯”è¾ƒå®¹æ˜“å•Šï¼åœ¨é¢„è®¾çš„CentOSç¯å¢ƒä¸­ï¼Œåº•ä¸‹çš„ç›®å½•æ˜¯æ¯”è¾ƒç¬¦åˆå®¹é‡å¤§ä¸”(æˆ–)è¯»å†™é¢‘ç¹çš„ç›®å½•ï¼š<br>/boot<br>/<br>/home<br>/var<br>Swap</p>
<p>ç”±äºŒBIOSæ‰åˆ°çš„ç£ç›˜å®¹é‡ä¸Œå¯¹ï¼Œä½†æ˜¯è‡³å°‘åœ¨æ•´é¢—ç£ç›˜å‰é¢çš„æ‰‚åŒºä»–è¿˜è¯»å¾—åˆ°å•Šï¼ å› æ­¤ï¼Œä½ å§è¦å°†è¿™ä¸ªç£ç›˜æœ€å‰é¢çš„å®¹é‡åˆ†å‰²å‡ºä¸€ä¸ªå°åˆ†å‰²æ§½ï¼Œå¹µå°†è¿™ä¸ªåˆ†å‰²æ§½ä¸ç³»ç»Ÿå¯åŠ¢æ–‡ä»¶çš„æ”¾ç½®ç›®å½•æ‘†åœ¨ä¸€èµ·ï¼Œ é‚£å°±æ˜¯ /boot è¿™ä¸ªç›®å½•ï¼å°±èƒ½å¤Ÿè§£å†³äº†ï¼å¾ˆç®€å•å§ï¼ å…¶å®ï¼Œé‡ç‚¹æ˜¯ï¼šã€å°†å¯åŠ¢æ‰‚åŒºæ‰€åœ¨åˆ†å‰²æ§½è§„èŒƒåœ¨å°äºŒ1024ä¸ªç£æŸ±ä»¥å†…ï½ã€ å³å¯ï¼é‚£æ€ä¸¾åšåˆ°å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œåœ¨è¿›è¡Œå®‰è£…çš„æ—¶å€™ï¼Œè§„åˆ’å‡ºä¸‰ä¸ªåˆ†åŒºï¼Œåˆ†åˆ«æ˜¯ï¼š<br>/boot<br>/<br>swap</p>
<p>é‚£ä¸ª/bootåªè¦ç»™100MBå·¦å³å³å¯ï¼Œè€Œä¸”/bootè¦æ”¾åœ¨æ•´å—ç¡¬ç›˜çš„æœ€å‰é¢ã€‚åœ¨Linuxé‡Œé¢ï¼Œä»»ä½•ä¸€ä¸ªæ–‡ä»¶éƒ½å…·æœ‰User,Group,Othersä¸‰ç§èº«ä»½çš„ä¸ªåˆ«æƒé™ï¼š</p>
<p>drwxr-xrâ€“ 1 test1 testgroup 5238 Jun 19 10:25 groups/</p>
<p>ç¬¬ä¸€ä¸ªå­—å…ƒä»£è¡¨è¿™ä¸ªæ¡£æ¡ˆæ˜¯ã€ç›®å½•ã€æ¡£æ¡ˆæˆ–è¿ç»“æ¡£ç­‰ç­‰ã€ï¼š</p>
<ul>
<li>å½“ä¸º[ d ]åˆ™æ˜¯ç›®å½•ï¼Œä¾‹å¦‚ä¸Šè¡¨æ¡£åä¸ºã€.configã€çš„é‚£ä¸€è¡Œï¼›</li>
<li>å½“ä¸º[ - ]åˆ™æ˜¯æ¡£æ¡ˆï¼Œä¾‹å¦‚ä¸Šè¡¨æ¡£åä¸ºã€initial-setup-ks.cfgã€é‚£ä¸€è¡Œï¼›</li>
<li>è‹¥æ˜¯[ l ]åˆ™è¡¨ç¤ºä¸ºè¿ç»“æ¡£(link file)ï¼›</li>
<li>è‹¥æ˜¯[ b ]åˆ™è¡¨ç¤ºä¸ºè£…ç½®æ¡£é‡Œé¢çš„å¯ä¾›å‚¨å­˜çš„å‘¨è¾¹è®¾å¤‡(å¯éšæœºå­˜å–è£…ç½®)ï¼›</li>
<li>è‹¥æ˜¯[ c ]åˆ™è¡¨ç¤ºä¸ºè£…ç½®æ¡£é‡Œé¢çš„åºåˆ—åŸ è®¾å¤‡ï¼Œä¾‹å¦‚é”®ç›˜ã€æ»‘é¼ (ä¸€æ¬¡æ€§è¯»å–è£…ç½®)ã€‚</li>
</ul>
<p>æ¥ä¸‹æ¥çš„å­—å…ƒä¸­ï¼Œä»¥ä¸‰ä¸ªä¸ºä¸€ç»„ï¼Œä¸”å‡ä¸ºã€rwxã€çš„ä¸‰ä¸ªå‚æ•°çš„ç»„åˆã€‚<br>u: user å³ owner<br>g: group<br>o: others  !! ä¸æ˜¯owner</p>
<p>ç›®å½•çš„xä»£è¡¨çš„æ˜¯ä½¿ç”¨è€…èƒ½å¦è¿›å…¥è¯¥ç›®å½•æˆä¸ºå·¥ä½œç›®å½•çš„ç”¨é€”ï¼</p>
<p>é™¤äº†åŸºæœ¬r, w, xæƒé™å¤–ï¼Œåœ¨Linuxä¼ ç»Ÿçš„Ext2/Ext3/Ext4æ¡£æ¡ˆç³»ç»Ÿä¸‹ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è®¾å®šå…¶ä»–çš„ç³»ç»Ÿéšè—å±æ€§ï¼Œè¿™éƒ¨ä»½å¯ä½¿ç”¨chattræ¥è®¾å®šï¼Œè€Œä»¥lsattr æ¥æŸ¥çœ‹ï¼Œæœ€é‡è¦çš„å±æ€§å°±æ˜¯å¯ä»¥è®¾å®šå…¶ä¸å¯ä¿®æ”¹çš„ç‰¹æ€§ï¼è®©è¿æ¡£æ¡ˆçš„æ‹¥æœ‰è€…éƒ½ä¸èƒ½è¿›è¡Œä¿®æ”¹ï¼è¿™ä¸ªå±æ€§å¯æ˜¯ç›¸å½“é‡è¦çš„ï¼Œå°¤å…¶æ˜¯åœ¨å®‰å…¨æœºåˆ¶ä¸Šé¢(security)ï¼</p>
<p>CentOS 7.x ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls -ld /bin; ls -ld /sbin; ls -ld /lib; ls -ld /lib64; ls -ld /var/lock; ls -ld /var/run;</span></span><br><span class="line">lrwxrwxrwx. 1 root root 7 Mar  7  2019 /bin -&gt; usr/bin</span><br><span class="line">lrwxrwxrwx. 1 root root 8 Mar  7  2019 /sbin -&gt; usr/sbin</span><br><span class="line">lrwxrwxrwx. 1 root root 7 Mar  7  2019 /lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx. 1 root root 9 Mar  7  2019 /lib64 -&gt; usr/lib64</span><br><span class="line">lrwxrwxrwx. 1 root root 11 Mar  7  2019 /var/lock -&gt; ../run/lock</span><br><span class="line">lrwxrwxrwx. 1 root root 6 Mar  7  2019 /var/run -&gt; ../run</span><br></pre></td></tr></table></figure>
<p>ç›®å½•è§„èŒƒï¼š<a href="http://linux.vbird.org/linux_basic/0210filepermission.php" rel="external nofollow noopener noreferrer" target="_blank">http://linux.vbird.org/linux_basic/0210filepermission.php</a></p>
<p><strong>/proc</strong>ç›®å½•ï¼šè¿™ä¸ªç›®å½•æœ¬èº«æ˜¯ä¸€ä¸ªã€è™šæ‹Ÿæ¡£æ¡ˆç³»ç»Ÿ(virtual filesystem)ã€å–”ï¼ä»–æ”¾ç½®çš„èµ„æ–™éƒ½æ˜¯åœ¨è®°å¿†ä½“å½“ä¸­ï¼Œä¾‹å¦‚ç³»ç»Ÿæ ¸å¿ƒã€è¡Œç¨‹èµ„è®¯(process)ã€å‘¨è¾¹è£…ç½®çš„çŠ¶æ€åŠç½‘è·¯çŠ¶æ€ç­‰ç­‰ã€‚å› ä¸ºè¿™ä¸ªç›®å½•ä¸‹çš„èµ„æ–™éƒ½æ˜¯åœ¨è®°å¿†ä½“å½“ä¸­ï¼Œæ‰€ä»¥æœ¬èº«ä¸å ä»»ä½•ç¡¬ç¢Ÿç©ºé—´å•Šï¼æ¯”è¾ƒé‡è¦çš„æ¡£æ¡ˆä¾‹å¦‚ï¼š/proc/cpuinfo, /proc/dma, /proc/interrupts, /proc/ioports, /proc/net/*ç­‰ç­‰ã€‚</p>
<h2 id="æŸ¥çœ‹ç‰ˆæœ¬"><a href="#æŸ¥çœ‹ç‰ˆæœ¬" class="headerlink" title="æŸ¥çœ‹ç‰ˆæœ¬"></a>æŸ¥çœ‹ç‰ˆæœ¬</h2><h3 id="uname"><a href="#uname" class="headerlink" title="uname"></a>uname</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -a</span></span><br><span class="line">Linux VM_0_13_centos 3.10.0-957.el7.x86_64 <span class="comment">#1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -s</span></span><br><span class="line">Linux</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -n</span></span><br><span class="line">VM_0_13_centos</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -r</span></span><br><span class="line">3.10.0-957.el7.x86_64</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -m</span></span><br><span class="line">x86_64</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -p</span></span><br><span class="line">x86_64</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -i</span></span><br><span class="line">x86_64</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># uname -o</span></span><br><span class="line">GNU/Linux</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># cat /etc/issue</span></span><br><span class="line">\S</span><br><span class="line">Kernel \r on an \m</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># cat /etc/redhat-release </span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># cat /etc/centos-release</span></span><br><span class="line">CentOS Linux release 7.6.1810 (Core)</span><br></pre></td></tr></table></figure>
<h2 id="å‘½ä»¤"><a href="#å‘½ä»¤" class="headerlink" title="å‘½ä»¤"></a>å‘½ä»¤</h2><h3 id="lsblk"><a href="#lsblk" class="headerlink" title="lsblk"></a>lsblk</h3><blockquote>
<p>list block devices</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># lsblk</span></span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sr0     11:0    1  4.4M  0 rom  </span><br><span class="line">vda    253:0    0   50G  0 disk </span><br><span class="line">â””â”€vda1 253:1    0   50G  0 part /</span><br></pre></td></tr></table></figure>
<h3 id="vmstat"><a href="#vmstat" class="headerlink" title="vmstat"></a>vmstat</h3><blockquote>
<p>vmstat reports information about processes, memory, paging, block IO, traps, disks and cpu activity.</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># vmstat</span></span><br><span class="line">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class="line"> r  b   swpd   free   buff  cache   si   so    bi    bo   <span class="keyword">in</span>   cs us sy id wa st</span><br><span class="line"> 1  0      0 159888 137604 869576    0    0    11    18    0    0  5  3 92  0  0</span><br></pre></td></tr></table></figure>
<h3 id="ls"><a href="#ls" class="headerlink" title="ls"></a>ls</h3><p>ls -Al  ä¸ ls -al çš„åŒºåˆ«ï¼Œä¸åŒ…å« . å’Œ ..</p>
<p>ls -n       # ä¸éœ€è¦l</p>
<p>-n ï¼šåˆ—å‡ºUIDä¸GIDè€Œéä½¿ç”¨è€…ä¸ç¾¤ç»„çš„åç§°</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost sh]<span class="comment"># ls -n</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r--. 1 0 0 309 Nov  1 10:33 fixed-ts.sh</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls -lS a    # æŒ‰å¤§å°é™åº</span></span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 root root 4 Oct  4 01:54 b1</span><br><span class="line">-rw-r--r-- 1 root root 3 Oct  4 01:53 b2</span><br><span class="line">-rw-rwxr-x 1 root root 0 Oct  4 01:02 b</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls -lt a    # æŒ‰æ—¶é—´é™åº æ–°-&gt;æ—§</span></span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 root root 4 Oct  4 01:54 b1</span><br><span class="line">-rw-r--r-- 1 root root 3 Oct  4 01:53 b2</span><br><span class="line">-rw-rwxr-x 1 root root 0 Oct  4 01:02 b</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls -l a     # æŒ‰åç§°å‡åº</span></span><br><span class="line">total 8</span><br><span class="line">-rw-rwxr-x 1 root root 0 Oct  4 01:02 b</span><br><span class="line">-rw-r--r-- 1 root root 4 Oct  4 01:54 b1</span><br><span class="line">-rw-r--r-- 1 root root 3 Oct  4 01:53 b2</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls -Rl a    # R å­ç›®å½•ä¹Ÿls</span></span><br><span class="line">a:</span><br><span class="line">total 8</span><br><span class="line">-rw-rwxr-x 1 root root 0 Oct  4 01:02 b</span><br><span class="line">-rw-r--r-- 1 root root 4 Oct  4 01:54 b1</span><br><span class="line">-rw-r--r-- 1 root root 3 Oct  4 01:53 b2</span><br><span class="line"></span><br><span class="line"><span class="comment"># -F ï¼šæ ¹æ®æ¡£æ¡ˆã€ç›®å½•ç­‰èµ„è®¯ï¼Œç»™äºˆé™„åŠ èµ„æ–™ç»“æ„ï¼Œä¾‹å¦‚ï¼š</span></span><br><span class="line"><span class="comment">#       *:ä»£è¡¨å¯æ‰§è¡Œæ¡£ï¼› /:ä»£è¡¨ç›®å½•ï¼› =:ä»£è¡¨socket æ¡£æ¡ˆï¼› |:ä»£è¡¨FIFO æ¡£æ¡ˆï¼›</span></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls -FR .</span></span><br><span class="line">.:</span><br><span class="line">a/  c</span><br><span class="line"></span><br><span class="line">./a:</span><br><span class="line">b*  b1  b2</span><br><span class="line"></span><br><span class="line"><span class="comment"># -f ï¼šç›´æ¥åˆ—å‡ºç»“æœï¼Œè€Œä¸è¿›è¡Œæ’åº(ls é¢„è®¾ä¼šä»¥æ¡£åæ’åºï¼)</span></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls -f a/</span></span><br><span class="line">b1  .  ..  b  b2</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># ls a/</span></span><br><span class="line">b  b1  b2</span><br></pre></td></tr></table></figure>
<h3 id="cat-ä¸-tac"><a href="#cat-ä¸-tac" class="headerlink" title="cat ä¸ tac"></a>cat ä¸ tac</h3><p>tac å¯å®ç°æŒ‰è¡Œé€†åºè¾“å‡º</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># seq 3 |tac</span></span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># seq 3 |cat</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># seq 3</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td></tr></table></figure>
<h3 id="touch"><a href="#touch" class="headerlink" title="touch"></a>touch</h3><p>å³ä½¿æˆ‘ä»¬å¤åˆ¶ä¸€ä¸ªæ¡£æ¡ˆæ—¶ï¼Œå¤åˆ¶æ‰€æœ‰çš„å±æ€§ï¼Œä½†ä¹Ÿæ²¡æœ‰åŠæ³•å¤åˆ¶ctime è¿™ä¸ªå±æ€§çš„ã€‚ctime å¯ä»¥è®°å½•è¿™ä¸ªæ¡£æ¡ˆæœ€è¿‘çš„çŠ¶æ€(status) è¢«æ”¹å˜çš„æ—¶é—´</p>
<h3 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h3><p>å¦‚æœumaskä¸º022ï¼Œåˆ™ï¼š<br>å»ºç«‹æ–‡ä»¶æ—¶ï¼š(-rw-rw-rw-) - (â€”â€“wâ€“w-) ==&gt; -rw-râ€“râ€“                # å³644<br>å»ºç«‹ç›®å½•æ—¶ï¼š(drwxrwxrwx) - (dâ€”-wâ€“w-) ==&gt; drwxr-xr-x        # å³755</p>
<p>åœ¨é¢„è®¾çš„æƒ…å†µä¸­ï¼Œ rootçš„umaskä¼šæ‹¿æ‰æ¯”è¾ƒå¤šçš„å±æ€§ï¼Œrootçš„umaské¢„è®¾æ˜¯022 ï¼Œè¿™æ˜¯åŸºäºå®‰å…¨çš„è€ƒé‡å•¦ï½è‡³äºä¸€èˆ¬èº«ä»½ä½¿ç”¨è€…ï¼Œé€šå¸¸ä»–ä»¬çš„umaskä¸º002 ï¼Œäº¦å³ä¿ç•™åŒç¾¤ç»„çš„å†™å…¥æƒåŠ›ï¼</p>
<h3 id="å…¶å®ƒæ–‡ä»¶ç®¡ç†å‘½ä»¤"><a href="#å…¶å®ƒæ–‡ä»¶ç®¡ç†å‘½ä»¤" class="headerlink" title="å…¶å®ƒæ–‡ä»¶ç®¡ç†å‘½ä»¤"></a>å…¶å®ƒæ–‡ä»¶ç®¡ç†å‘½ä»¤</h3><p>ref: <a href="http://linux.vbird.org/linux_basic/0220filemanager.php#dir_path" rel="external nofollow noopener noreferrer" target="_blank">http://linux.vbird.org/linux_basic/0220filemanager.php#dir_path</a></p>
<h3 id="æ–‡ä»¶ç‰¹æ®Šæƒé™ï¼š-SUID-SGID-SBIT"><a href="#æ–‡ä»¶ç‰¹æ®Šæƒé™ï¼š-SUID-SGID-SBIT" class="headerlink" title="æ–‡ä»¶ç‰¹æ®Šæƒé™ï¼š SUID, SGID, SBIT"></a>æ–‡ä»¶ç‰¹æ®Šæƒé™ï¼š SUID, SGID, SBIT</h3><p>â€¦</p>
<h2 id="ç«¯å£"><a href="#ç«¯å£" class="headerlink" title="ç«¯å£"></a>ç«¯å£</h2><h3 id="åˆ—å‡ºæ‰€æœ‰ç›‘å¬çš„ç«¯å£"><a href="#åˆ—å‡ºæ‰€æœ‰ç›‘å¬çš„ç«¯å£" class="headerlink" title="åˆ—å‡ºæ‰€æœ‰ç›‘å¬çš„ç«¯å£"></a>åˆ—å‡ºæ‰€æœ‰ç›‘å¬çš„ç«¯å£</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">netstat -tnlp |awk <span class="string">'&#123;print $4&#125;'</span> |awk -F: <span class="string">'&#123;if($NF~/^[0-9]*$/) print $NF&#125;'</span> |sort |uniq 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<h2 id="é˜²ç«å¢™"><a href="#é˜²ç«å¢™" class="headerlink" title="é˜²ç«å¢™"></a>é˜²ç«å¢™</h2><p>ref: <a href="https://www.linuxprobe.com/chapter-08.html#83_Firewalld" rel="external nofollow noopener noreferrer" target="_blank">https://www.linuxprobe.com/chapter-08.html#83_Firewalld</a></p>
<p>å¯¹æŒ‡å®šIPå¼€æ”¾æŒ‡å®šç«¯å£</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">firewall-cmd --permanent --add-rich-rule=<span class="string">"rule family="</span>ipv4<span class="string">" source address="</span>192.168.142.166<span class="string">" port protocol="</span>tcp<span class="string">" port="</span>6379<span class="string">" accept"</span></span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p>æ·»åŠ ã€åˆ é™¤2201</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">firewall-cmd --zone=public --add-port=2201/tcp --permanent</span><br><span class="line">firewall-cmd --zone=public --remove-port=2201/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<p><code>--zone=public</code>ï¼šæ‹’ç»æµå…¥çš„æµé‡ï¼Œé™¤éä¸æµå‡ºçš„æµé‡ç›¸å…³ï¼›è€Œå¦‚æœæµé‡ä¸sshã€dhcpv6-clientæœåŠ¡ç›¸å…³ï¼Œåˆ™å…è®¸æµé‡ã€‚</p>
<p>æŒ‡å®šç½‘æ®µ192.168.10.0/24 INPUTï¼Œæ‹’ç»å…¶å®ƒç½‘æ®µINPUT:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">iptables -I INPUT -s 192.168.10.0/24 -p tcp --dport 22 -j ACCEPT</span><br><span class="line">iptables -A INPUT -p tcp --dport 22 -j REJECT</span><br></pre></td></tr></table></figure>
<p>å…è®¸è§„åˆ™è¦æ”¾åœ¨æ‹’ç»è§„åˆ™å‰é¢ï¼Œå¦åˆ™è¢«æ‹’ç»ã€‚</p>
<p>æŠŠINPUTè§„åˆ™é“¾çš„é»˜è®¤ç­–ç•¥è®¾ç½®ä¸ºæ‹’ç»ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">iptables -P INPUT DROP</span><br><span class="line"><span class="comment"># iptables -L</span></span><br></pre></td></tr></table></figure>
<p>è§„åˆ™é“¾çš„é»˜è®¤ç­–ç•¥æ‹’ç»åŠ¨ä½œåªèƒ½æ˜¯DROPï¼Œè€Œä¸èƒ½æ˜¯REJECTã€‚</p>
<p>DROPç›´æ¥å°†æµé‡ä¸¢å¼ƒè€Œä¸”ä¸å“åº”ï¼›REJECTåˆ™ä¼šåœ¨æ‹’ç»æµé‡åå›å¤ä¸€æ¡ä¿¡æ¯ï¼Œä»è€Œè®©æµé‡å‘é€æ–¹æ¸…æ™°åœ°çœ‹åˆ°æ•°æ®è¢«æ‹’ç»çš„å“åº”ä¿¡æ¯ã€‚</p>
<p>å‘INPUTé“¾ä¸­æ·»åŠ å…è®¸ICMPæµé‡è¿›å…¥çš„ç­–ç•¥è§„åˆ™:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">iptables -I INPUT -p icmp -j ACCEPT</span><br></pre></td></tr></table></figure>
<h2 id="ç½‘ç»œå­˜å‚¨"><a href="#ç½‘ç»œå­˜å‚¨" class="headerlink" title="ç½‘ç»œå­˜å‚¨"></a>ç½‘ç»œå­˜å‚¨</h2><h3 id="NFS"><a href="#NFS" class="headerlink" title="NFS"></a>NFS</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install nfs-utils -y</span></span><br><span class="line"></span><br><span class="line">æœåŠ¡ç«¯ï¼š</span><br><span class="line">/nfs 172.17.0.13(rw,no_root_squash,async)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å®¢æˆ·ç«¯ï¼š</span><br><span class="line">mount -t nfs   root@172.17.0.13:/nfs   /mnt</span><br></pre></td></tr></table></figure>
<h2 id="Vim"><a href="#Vim" class="headerlink" title="Vim"></a>Vim</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># vim æ“ä½œï¼š</span></span><br><span class="line">:g/^<span class="comment">#/d     # åˆ é™¤æ‰€æœ‰#å¼€å¤´çš„è¡Œ</span></span><br><span class="line">:g/^$/d     <span class="comment"># åˆ é™¤æ‰€æœ‰ç©ºè¡Œ</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>CentOS</tag>
      </tags>
  </entry>
  <entry>
    <title>bashç¼–ç¨‹ â€”â€” è¯»å†™é…ç½®</title>
    <url>/linux/read-write-ini/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>shellè¯»å†™é…ç½®</p>
</blockquote>
<a id="more"></a>
<h2 id="è¯»å–é…ç½®"><a href="#è¯»å–é…ç½®" class="headerlink" title="è¯»å–é…ç½®"></a>è¯»å–é…ç½®</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="comment"># è¯»å–inié…ç½®æ–‡ä»¶ï¼Œå­—å…¸æ³•</span></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">declare</span> -A d</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">read_ini</span></span>() &#123;</span><br><span class="line">    ini_file=<span class="variable">$1</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">"<span class="variable">$&#123;ini_file&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line"><span class="comment">#        if [ -z $(echo "$line" | sed "s/^[^#]*\[\w+\].*$//") ]; then</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> |grep -xq <span class="string">'^\s*\[[a-zA-Z0-9_\-]\+\].*$'</span>; <span class="keyword">then</span></span><br><span class="line"><span class="comment">#          sec=$(echo "$line" | sed "s/^[^#]*\[\(.\+\)\].*$/\1/")</span></span><br><span class="line">          sec=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | sed <span class="string">"s/^\s*\[\([a-zA-Z0-9_\-]\+\)\].*$/\1/"</span>)</span><br><span class="line">          flag=1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> [ 1 -eq <span class="variable">$flag</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> |grep -xq <span class="string">'^\s*\w\+\s*=\s*.*$'</span>; <span class="keyword">then</span></span><br><span class="line"><span class="comment">#          item=$(echo "$line" |sed "s/^\s*\([a-zA-Z0-9_\-]\+\)\s*=.*$/\1/")</span></span><br><span class="line">          item=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> |sed <span class="string">"s/^\s*\(\S\+\)\s*=.*$/\1/"</span>)</span><br><span class="line">          value=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> |sed <span class="string">"s/^.*=\s*\(.\+\)\s*$/\1/"</span>)</span><br><span class="line">          key=<span class="string">"<span class="variable">$sec</span>/<span class="variable">$item</span>"</span></span><br><span class="line">          d[<span class="variable">$key</span>]=<span class="variable">$value</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">      <span class="keyword">done</span> &lt;<span class="string">"<span class="variable">$&#123;ini_file&#125;</span>"</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">read_ini a.ini</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;d[students/name]&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;d[students/name2]&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"End."</span></span><br></pre></td></tr></table></figure>
<h2 id="å†™å…¥é…ç½®"><a href="#å†™å…¥é…ç½®" class="headerlink" title="å†™å…¥é…ç½®"></a>å†™å…¥é…ç½®</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹inié…ç½®æ–‡ä»¶ï¼Œä¸å­˜åœ¨sectionæˆ–itemæ—¶</span></span><br><span class="line"><span class="comment"># ï¼Œè¿½åŠ item æˆ– å¢åŠ  sectionå’Œitem</span></span><br><span class="line"><span class="comment">######################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">write_ini</span></span>() &#123;</span><br><span class="line">  <span class="comment"># usage: write_ini &lt;ini_file&gt; &lt;section&gt; &lt;item&gt; &lt;value&gt;</span></span><br><span class="line">  ini_file=<span class="variable">$1</span></span><br><span class="line">  section=<span class="variable">$2</span></span><br><span class="line">  item=<span class="variable">$3</span></span><br><span class="line">  value=<span class="variable">$4</span></span><br><span class="line">  flag=0</span><br><span class="line">  is_found=0</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ -f <span class="string">"<span class="variable">$&#123;ini_file&#125;</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">while</span> <span class="built_in">read</span> line; <span class="keyword">do</span></span><br><span class="line">      <span class="comment">#      if [ -z $(echo "$line" | sed "s/^[^#]*\[$&#123;section&#125;\].*$//") ]; then</span></span><br><span class="line">      <span class="keyword">if</span> <span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | grep -xq <span class="string">"^\s*\[<span class="variable">$&#123;section&#125;</span>\].*$"</span>; <span class="keyword">then</span></span><br><span class="line">        flag=1</span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">#      if [ 1 -eq $flag ] &amp;&amp; [ -z $(echo "$line" | sed "s/^[^#]*$&#123;item&#125;.*$//") ]; then</span></span><br><span class="line">      <span class="keyword">if</span> [ 1 -eq <span class="variable">$flag</span> ] &amp;&amp; <span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | grep -xq <span class="string">"^\s*<span class="variable">$&#123;item&#125;</span>\s*=\s*.*$"</span>; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span> | sed <span class="string">"s/=.*$/=<span class="variable">$&#123;value&#125;</span>/"</span></span><br><span class="line">        flag=0</span><br><span class="line">        is_found=1</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$line</span>"</span></span><br><span class="line">      <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">done</span> &lt;<span class="string">"<span class="variable">$&#123;ini_file&#125;</span>"</span>   <span class="comment"># ä»æ–‡ä»¶è¯»å–è¡Œï¼Œå¾ªç¯å†…çš„å˜é‡é€€å‡ºå¾ªç¯åä»æœ‰æ•ˆï¼›ä¼¼ä¹~å¦‚æœä»ç®¡é“è¯»å–åˆ™ä¸ç„¶ã€‚</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$flag</span>,<span class="variable">$is_found</span> <span class="comment"># é™„ä¸Šwhileå¾ªç¯ä¸­çš„å˜é‡å€¼</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">write</span></span>() &#123;</span><br><span class="line">  <span class="comment"># usage: write &lt;ini_file&gt; &lt;section&gt; &lt;item&gt; &lt;value&gt;</span></span><br><span class="line">  ini_file=<span class="variable">$1</span></span><br><span class="line">  section=<span class="variable">$2</span></span><br><span class="line">  item=<span class="variable">$3</span></span><br><span class="line">  value=<span class="variable">$4</span></span><br><span class="line">  out=$(write_ini <span class="variable">$@</span>)               <span class="comment"># è¢«$()æ–¹å¼è°ƒç”¨ï¼Œä¸ç›´æ¥write_iniï¼Œå˜é‡ä½œç”¨åŸŸä¸åŒ; å› åœ¨å­è¿›ç¨‹ä¸­è¿è¡Œï¼Ÿ</span></span><br><span class="line">  ret=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$out</span>"</span> | tail -n 1)</span><br><span class="line">  res=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$out</span>"</span> | head -n -1)</span><br><span class="line"><span class="comment">#  echo $flag,$is_found             # write_iniä¸­flagæ˜¯1ï¼Œæ­¤å¤„æ˜¯0ï¼</span></span><br><span class="line">  flag=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$ret</span>"</span> | cut -d, -f1)</span><br><span class="line">  is_found=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$ret</span>"</span> | cut -d, -f2)</span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$flag</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[<span class="variable">$&#123;section&#125;</span>]"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;item&#125;</span>=<span class="variable">$&#123;value&#125;</span>"</span></span><br><span class="line">  <span class="keyword">elif</span> [ <span class="variable">$is_found</span> -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$res</span>"</span> | sed <span class="string">"/\[<span class="variable">$&#123;section&#125;</span>\]/a\\<span class="variable">$&#123;item&#125;</span>=<span class="variable">$&#123;value&#125;</span>"</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write a.ini students name2 lucy2</span><br><span class="line">write a.ini students3 name3 lucy3</span><br></pre></td></tr></table></figure>
<h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># !/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##################</span></span><br><span class="line"><span class="comment"># è¯»å–ã€ä¿®æ”¹ini, itemä¸å­˜åœ¨æ—¶ä¸ä¼šæ–°å»º</span></span><br><span class="line"><span class="comment">##################</span></span><br><span class="line"></span><br><span class="line">INIFILE=<span class="variable">$1</span></span><br><span class="line">SECTION=<span class="variable">$2</span></span><br><span class="line">ITEM=<span class="variable">$3</span></span><br><span class="line">NEWVAL=<span class="variable">$4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">ReadINIfile</span></span>() &#123;</span><br><span class="line"><span class="comment">#  ReadINI=$(awk -F= '/\['$SECTION'\]/&#123;a=1&#125;a==1&amp;&amp;$1~/'$ITEM'/&#123;print $2;exit&#125;' $INIFILE)</span></span><br><span class="line">  ReadINI=$(awk -F <span class="string">'='</span> -v it=<span class="string">"<span class="variable">$ITEM</span>"</span> <span class="string">'/\['</span><span class="variable">$SECTION</span><span class="string">'\]/&#123;a=1&#125;a==1&amp;&amp;$1==it&#123;print $2;exit&#125;'</span> <span class="variable">$INIFILE</span>)</span><br><span class="line"><span class="comment">#  ReadINI=$(awk -F '=' -v it="$ITEM" '/\['$SECTION'\]/&#123;a=1&#125;&#123;if(a==1&amp;&amp;$1==it)&#123;print $2;exit&#125;&#125;' $INIFILE)</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$ReadINI</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">WriteINIfile</span></span>() &#123;</span><br><span class="line">  sed -i <span class="string">"/^\[<span class="variable">$SECTION</span>\]/,/^\[/ &#123;/^\[<span class="variable">$SECTION</span>\]/b;/^\[/b;s/^<span class="variable">$ITEM</span>*=.*/<span class="variable">$ITEM</span>=<span class="variable">$NEWVAL</span>/g;&#125;"</span> <span class="variable">$INIFILE</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$4</span>"</span> = <span class="string">""</span> ]; <span class="keyword">then</span></span><br><span class="line">  ReadINIfile <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  WriteINIfile <span class="variable">$1</span> <span class="variable">$2</span> <span class="variable">$3</span> <span class="variable">$4</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>sedå‘½ä»¤</title>
    <url>/linux/sed/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="æ›¿æ¢ä¸­æ–‡"><a href="#æ›¿æ¢ä¸­æ–‡" class="headerlink" title="æ›¿æ¢ä¸­æ–‡"></a>æ›¿æ¢ä¸­æ–‡</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sed <span class="string">'s/[^ -z]/*/g'</span></span><br></pre></td></tr></table></figure>
<h2 id="æŒ‰è¡Œé€†åºè¾“å‡º"><a href="#æŒ‰è¡Œé€†åºè¾“å‡º" class="headerlink" title="æŒ‰è¡Œé€†åºè¾“å‡º"></a>æŒ‰è¡Œé€†åºè¾“å‡º</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sed -e <span class="string">'1!G; h; $!d'</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos ~]<span class="comment"># seq 4 |sed -e '1!G; h; $!d'</span></span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´ç®€å•çš„å‘½ä»¤  tac</span></span><br><span class="line">[root@VM_0_13_centos linux-learning]<span class="comment"># seq 3 |tac</span></span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p><code>1!G;h;$!d</code> å¯æ‹†è§£ä¸ºä¸‰ä¸ªå‘½ä»¤:</p>
<ul>
<li>1!G â€”â€” åªæœ‰ç¬¬ä¸€è¡Œä¸æ‰§è¡ŒGå‘½ä»¤ï¼Œå°†hold spaceä¸­çš„å†…å®¹appendå›åˆ°pattern space</li>
<li>h â€”â€” ç¬¬ä¸€è¡Œéƒ½æ‰§è¡Œhå‘½ä»¤ï¼Œå°†pattern spaceä¸­çš„å†…å®¹æ‹·è´åˆ°hold spaceä¸­</li>
<li>$!d â€”â€” é™¤äº†æœ€åä¸€è¡Œä¸æ‰§è¡Œdå‘½ä»¤ï¼Œå…¶å®ƒè¡Œéƒ½æ‰§è¡Œdå‘½ä»¤ï¼Œåˆ é™¤å½“å‰è¡Œ</li>
</ul>
<p><em>æ‘˜è‡ª:  <a href="https://blog.csdn.net/weixin_38149264/article/details/78074300" rel="external nofollow noopener noreferrer" target="_blank">https://blog.csdn.net/weixin_38149264/article/details/78074300</a></em></p>
<h2 id="å¯¹ç¬¦åˆæ¡ä»¶çš„è¡Œæ“ä½œ"><a href="#å¯¹ç¬¦åˆæ¡ä»¶çš„è¡Œæ“ä½œ" class="headerlink" title="å¯¹ç¬¦åˆæ¡ä»¶çš„è¡Œæ“ä½œ"></a>å¯¹ç¬¦åˆæ¡ä»¶çš„è¡Œæ“ä½œ</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos opt]<span class="comment"># find /opt -type f -name "*.tgz"</span></span><br><span class="line">/opt/note/K8s/yaml/elk/elk2020/e/helm/elasticsearch-7.6.0.tgz</span><br><span class="line">[root@VM_0_13_centos opt]<span class="comment"># find /opt -type f -name "*.tgz" | sed -n -e '/^\/opt\/note\//&#123;s?/opt/note/?Note:?; p&#125;;'		# æš‚æœªæ‰¾åˆ°æ›¿ä»£/çš„æ–¹æ³•</span></span><br><span class="line">Note:K8s/yaml/elk/elk2020/e/helm/elasticsearch-7.6.0.tgz</span><br></pre></td></tr></table></figure>
<h2 id="å˜é‡å«sedåˆ†å‰²ç¬¦"><a href="#å˜é‡å«sedåˆ†å‰²ç¬¦" class="headerlink" title="å˜é‡å«sedåˆ†å‰²ç¬¦"></a>å˜é‡å«sedåˆ†å‰²ç¬¦</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"><span class="comment"># sedæ›¿æ¢ç›®æ ‡å­—ç¬¦ä¸ºå˜é‡å†…å®¹æ—¶ï¼Œå¦‚æœ</span></span><br><span class="line"><span class="comment"># å˜é‡å†…å®¹ä¸­å«æœ‰sedåˆ†éš”ç¬¦ï¼Œéœ€è¦å¤„ç†</span></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"></span><br><span class="line">s=<span class="string">"The remote SSH server rejected X11 forwarding request."</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">assert</span></span>()&#123;</span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"<span class="variable">$2</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"ok"</span></span><br><span class="line">    <span class="built_in">return</span> 0</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[<span class="variable">$1</span>] is not equal to [<span class="variable">$2</span>]"</span></span><br><span class="line">    <span class="built_in">return</span> 1</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">w=<span class="string">"accepted"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$s</span>"</span> |sed <span class="string">"s/rejected/<span class="variable">$w</span>/g"</span></span><br><span class="line"></span><br><span class="line">w=<span class="string">"@ccepted"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$s</span>"</span> |sed <span class="string">"s/rejected/<span class="variable">$w</span>/g"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#w="accept/ed"</span></span><br><span class="line"><span class="comment">#echo "$s" |sed "s/rejected/$w/g"    # sed: -e expression #1, char 20: unknown option to `s'</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"--------------1"</span></span><br><span class="line">w0=<span class="string">"a#cc/ept/ed"</span></span><br><span class="line">w=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$w0</span>"</span> |sed <span class="string">'s#/#\\/#g'</span>)     <span class="comment"># æ›¿æ¢ä¸ºå˜é‡çš„å†…å®¹æ—¶ï¼Œéœ€å…ˆå¯¹å˜é‡å¤„ç†ï¼Œå°†å…¶ä¸­åŒ…å«çš„sedåˆ†éš”ç¬¦æ›¿æ¢æˆ\å¼€å¤´çš„</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$w</span>"</span></span><br><span class="line">assert <span class="string">"`echo "</span><span class="variable">$s</span><span class="string">" |sed "</span>s/rejected/<span class="variable">$w</span>/g<span class="string">"`"</span>  <span class="string">"The remote SSH server <span class="variable">$w0</span> X11 forwarding request."</span></span><br><span class="line"><span class="built_in">echo</span> $?</span><br></pre></td></tr></table></figure>
<h2 id="æ‰‹æœºå·åŒ¹é…"><a href="#æ‰‹æœºå·åŒ¹é…" class="headerlink" title="æ‰‹æœºå·åŒ¹é…"></a>æ‰‹æœºå·åŒ¹é…</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"><span class="comment"># sed åŒ¹é…æ‰‹æœºå·ç¤ºä¾‹</span></span><br><span class="line"><span class="comment">###################</span></span><br><span class="line"></span><br><span class="line">phone=<span class="string">"my phone is 86+15612348888. his phone is 13912348889. haha!"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"&gt;&gt;: <span class="variable">$phone</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$phone</span>"</span> |sed <span class="string">'s/1(3[0-9]|5[1689]|8[6789])[0-9]&#123;8&#125;/xxx/'</span>          <span class="comment"># err</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$phone</span>"</span> |sed <span class="string">'s/\(^\|[^0-9]\)\([0-9]\&#123;3,4\&#125;-\)\?1\(3[0-9]\|5[1689]\|8[6789]\)[0-9]\&#123;8\&#125;/\1***/g'</span></span><br><span class="line"><span class="comment"># åˆ†ä¸‰æ®µæå– \2\3\4</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$phone</span>"</span> |sed <span class="string">'s/\(^\|[^0-9]\)\([0-9]\&#123;2,4\&#125;[+-]\?\)\?\(13[0-9]\|15[1689]\|18[6789]\)\([0-9]\&#123;8\&#125;\)/\1[\2\3\4]/g'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$phone</span>"</span> |sed <span class="string">'s/\(^\|[^0-9]\)\([0-9]\&#123;2,4\&#125;[+-]\?\)\?\(13[0-9]\|15[1689]\|18[6789]\)\([0-9]\&#123;8\&#125;\)/\1***/g'</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$phone</span>"</span> |sed <span class="string">'s/\([0-9]\&#123;2,4\&#125;[+-]\?\)\?\(13[0-9]\|15[1689]\|18[6789]\)\([0-9]\&#123;8\&#125;\)/***/g'</span></span><br></pre></td></tr></table></figure>
<h2 id="æå–IP"><a href="#æå–IP" class="headerlink" title="æå–IP"></a>æå–IP</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#######################</span></span><br><span class="line"><span class="comment"># ç”¨é€”ï¼šæå–ipå„æ®µæ•°å­—</span></span><br><span class="line"><span class="comment">#######################</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ³•1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"method 1: "</span></span><br><span class="line">str=<span class="string">"192.168.31.65"</span></span><br><span class="line">OLD_IFS=<span class="string">"<span class="variable">$IFS</span>"</span> <span class="comment">#ä¿å­˜æ—§çš„åˆ†éš”ç¬¦</span></span><br><span class="line">IFS=<span class="string">"."</span></span><br><span class="line">array=(<span class="variable">$str</span>)</span><br><span class="line">IFS=<span class="string">"<span class="variable">$OLD_IFS</span>"</span> <span class="comment"># å°†IFSæ¢å¤æˆåŸæ¥çš„</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">"<span class="variable">$&#123;!array[@]&#125;</span>"</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$i</span>=&gt;<span class="variable">$&#123;array[i]&#125;</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;array[@]&#125;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> -n <span class="string">"<span class="variable">$i</span> "</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ³•2</span></span><br><span class="line">str=<span class="string">"192.168.31.66"</span></span><br><span class="line">s2=$(<span class="built_in">echo</span> <span class="string">"<span class="variable">$str</span>"</span> |sed <span class="string">'s/\./ /g'</span>)</span><br><span class="line">arr2=(<span class="variable">$s2</span>)</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"method 2: "</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;arr2[@]&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–¹æ³•2-2</span></span><br><span class="line">str=<span class="string">"192.168.31.67"</span></span><br><span class="line">arr3=($(<span class="built_in">echo</span> <span class="string">"<span class="variable">$str</span>"</span> |sed <span class="string">'s/\./ /g'</span>))</span><br><span class="line"><span class="built_in">echo</span> -n <span class="string">"method 3: "</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;arr3[@]&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Shell basic 01</title>
    <url>/linux/shell-basic-01/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><table>
<thead>
<tr>
<th>å‚æ•°å¤„ç†</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>$#</td>
<td>ä¼ é€’åˆ°è„šæœ¬çš„å‚æ•°ä¸ªæ•°</td>
</tr>
<tr>
<td>$*</td>
<td>ä»¥ä¸€ä¸ªå•å­—ç¬¦ä¸²æ˜¾ç¤ºæ‰€æœ‰å‘è„šæœ¬ä¼ é€’çš„å‚æ•°ã€‚ å¦‚â€$*â€ç”¨ã€Œâ€ã€æ‹¬èµ·æ¥çš„æƒ…å†µã€ä»¥â€$1 $2 â€¦ $nâ€çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚</td>
</tr>
<tr>
<td>$$</td>
<td>è„šæœ¬è¿è¡Œçš„å½“å‰è¿›ç¨‹IDå·</td>
</tr>
<tr>
<td>$!</td>
<td>åå°è¿è¡Œçš„æœ€åä¸€ä¸ªè¿›ç¨‹çš„IDå·</td>
</tr>
<tr>
<td>$@</td>
<td>ä¸$*ç›¸åŒï¼Œä½†æ˜¯ä½¿ç”¨æ—¶åŠ å¼•å·ï¼Œå¹¶åœ¨å¼•å·ä¸­è¿”å›æ¯ä¸ªå‚æ•°ã€‚ å¦‚â€$@â€ç”¨ã€Œâ€ã€æ‹¬èµ·æ¥çš„æƒ…å†µã€ä»¥â€$1â€ â€œ$2â€ â€¦ â€œ$nâ€ çš„å½¢å¼è¾“å‡ºæ‰€æœ‰å‚æ•°ã€‚</td>
</tr>
<tr>
<td>$-</td>
<td>æ˜¾ç¤ºShellä½¿ç”¨çš„å½“å‰é€‰é¡¹ï¼Œä¸setå‘½ä»¤åŠŸèƒ½ç›¸åŒã€‚</td>
</tr>
<tr>
<td>$?</td>
<td>æ˜¾ç¤ºæœ€åå‘½ä»¤çš„é€€å‡ºçŠ¶æ€ã€‚0è¡¨ç¤ºæ²¡æœ‰é”™è¯¯ï¼Œå…¶ä»–ä»»ä½•å€¼è¡¨æ˜æœ‰é”™è¯¯ã€‚</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h2 id="æ¡ä»¶åˆ¤æ–­"><a href="#æ¡ä»¶åˆ¤æ–­" class="headerlink" title="æ¡ä»¶åˆ¤æ–­"></a>æ¡ä»¶åˆ¤æ–­</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">-a file exists.</span><br><span class="line">-b file exists and is a block special file.</span><br><span class="line">-c file exists and is a character special file.</span><br><span class="line">-d file exists and is a directory.</span><br><span class="line">-e file exists (just the same as -a).</span><br><span class="line">-f file exists and is a regular file.</span><br><span class="line">-g file exists and has its setgid(2) bit <span class="built_in">set</span>.</span><br><span class="line">-G file exists and has the same group ID as this process.</span><br><span class="line">-k file exists and has its sticky bit <span class="built_in">set</span>.</span><br><span class="line">-L file exists and is a symbolic link.</span><br><span class="line">-n string length is not zero.</span><br><span class="line">-o Named option is <span class="built_in">set</span> on.</span><br><span class="line">-O file exists and is owned by the user ID of this process.</span><br><span class="line">-p file exists and is a first <span class="keyword">in</span>, first out (FIFO) special file or named pipe.</span><br><span class="line">-r file exists and is readable by the current process.</span><br><span class="line">-s file exists and has a size greater than zero.</span><br><span class="line">-S file exists and is a socket.</span><br><span class="line">-t file descriptor number fildes is open and associated with a terminal device.</span><br><span class="line">-u file exists and has its setuid(2) bit <span class="built_in">set</span>.</span><br><span class="line">-w file exists and is writable by the current process.</span><br><span class="line">-x file exists and is executable by the current process.</span><br><span class="line">-z string length is zero.</span><br></pre></td></tr></table></figure>
<h2 id="å­—ç¬¦ä¸²æˆªå–"><a href="#å­—ç¬¦ä¸²æˆªå–" class="headerlink" title="å­—ç¬¦ä¸²æˆªå–"></a>å­—ç¬¦ä¸²æˆªå–</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">a=abc123abc123</span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;a:-2:12&#125;</span> abc123abc123</span><br><span class="line"><span class="variable">$&#123;a:-2:6&#125;</span> abc123abc123</span><br><span class="line"><span class="variable">$&#123;a:0-2:12&#125;</span> 23</span><br><span class="line"><span class="variable">$&#123;a:0-2&#125;</span> 23</span><br><span class="line"><span class="variable">$&#123;a:0-2:&#125;</span></span><br><span class="line"><span class="variable">$&#123;a::-2&#125;</span> abc123abc1</span><br><span class="line"><span class="variable">$&#123;a:0:-2&#125;</span> abc123abc1</span><br><span class="line"><span class="variable">$&#123;a::0-2&#125;</span> abc123abc1</span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;a#a&#125;</span> bc123abc123</span><br><span class="line"><span class="variable">$&#123;a##a&#125;</span> bc123abc123</span><br><span class="line"><span class="variable">$&#123;a#*a&#125;</span> bc123abc123</span><br><span class="line"><span class="variable">$&#123;a##*a&#125;</span> bc123</span><br><span class="line"></span><br><span class="line"><span class="variable">$&#123;a%3&#125;</span> abc123abc12</span><br><span class="line"><span class="variable">$&#123;a%%3&#125;</span> abc123abc12</span><br><span class="line"><span class="variable">$&#123;a%3*&#125;</span> abc123abc12</span><br><span class="line"><span class="variable">$&#123;a%%3*&#125;</span> abc12</span><br></pre></td></tr></table></figure>
<h2 id="é€‰é¡¹å‚æ•°"><a href="#é€‰é¡¹å‚æ•°" class="headerlink" title="é€‰é¡¹å‚æ•°"></a>é€‰é¡¹å‚æ•°</h2><p>getopts å’Œ getopt çš„ç”¨æ³•</p>
<p>ref: </p>
<ul>
<li><a href="https://www.cnblogs.com/FrankTan/archive/2010/03/01/1634516.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.cnblogs.com/FrankTan/archive/2010/03/01/1634516.html</a></li>
<li><a href="https://www.cnblogs.com/tommyjiang/p/10629848.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.cnblogs.com/tommyjiang/p/10629848.html</a></li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -al </span></span><br><span class="line">GETOPT_ARGS=`getopt -o s:e:n::c: -al sdate:,edate:,numprocs::,cfile: -- <span class="string">"<span class="variable">$@</span>"</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo "$GETOPT_ARGS"</span></span><br><span class="line"><span class="built_in">eval</span> <span class="built_in">set</span> -- <span class="string">"<span class="variable">$GETOPT_ARGS</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> [ -n <span class="string">"<span class="variable">$1</span>"</span> ]</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span></span><br><span class="line">        -s|--sdate) sdate=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">        -e|--edate) edate=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">        -n|--numprocs) numprocs=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">        -c|--cfile) cfile=<span class="variable">$2</span>; <span class="built_in">shift</span> 2;;</span><br><span class="line">        --) <span class="built_in">break</span> ;;</span><br><span class="line">        *) <span class="built_in">echo</span> <span class="variable">$1</span>,<span class="variable">$2</span>,<span class="variable">$show_usage</span>; <span class="built_in">break</span> ;;</span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<h2 id="shell-æ±‚å·®é›†-å¹¶é›†-äº¤é›†"><a href="#shell-æ±‚å·®é›†-å¹¶é›†-äº¤é›†" class="headerlink" title="shell æ±‚å·®é›† å¹¶é›† äº¤é›†"></a>shell æ±‚å·®é›† å¹¶é›† äº¤é›†</h2><p>ref: <a href="https://blog.csdn.net/nwpulei/article/details/38556595" rel="external nofollow noopener noreferrer" target="_blank">https://blog.csdn.net/nwpulei/article/details/38556595</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># cat a</span></span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">5</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># cat b</span></span><br><span class="line">4</span><br><span class="line">6</span><br><span class="line">5</span><br><span class="line">8</span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># ua=$(cat a |sort |uniq)      # a ä¸é‡å¤é›†</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># echo $ua</span></span><br><span class="line">1 2 3 4 5</span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># ub=$(cat b |sort |uniq)      # b ä¸é‡å¤é›†</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># echo $ub</span></span><br><span class="line">4 5 6 8</span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># uaub=$(echo -e "$ua\n$ub" |sort |uniq -u)      # aå’Œbçš„å·®é›†</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># echo $uaub</span></span><br><span class="line">1 2 3 6 8</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># uab=$(echo -e "$ua\n$ub\n$ub" |sort |uniq -u)  # bç›¸å¯¹açš„è¡¥é›†</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># echo $uab</span></span><br><span class="line">1 2 3</span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># uba=$(echo -e "$ua\n$ua\n$ub" |sort |uniq -u)  # aç›¸å¯¹bçš„è¡¥é›†</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># echo $uba</span></span><br><span class="line">6 8</span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># cat a b |sort |uniq                             # å¹¶é›†</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># a_b=$(echo -e "$ua\n$ub" |sort |uniq)           # å¹¶é›†2</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># echo $a_b</span></span><br><span class="line">1 2 3 4 5 6 8</span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># ab=$(echo -e "$ua\n$ub" |sort |uniq -d)        # äº¤é›†</span></span><br><span class="line">[root@VM_0_13_centos shell-basic]<span class="comment"># echo $ab</span></span><br><span class="line">4 5</span><br></pre></td></tr></table></figure>
<h2 id="å›ºå®šæ—¶é—´é—´éš”"><a href="#å›ºå®šæ—¶é—´é—´éš”" class="headerlink" title="å›ºå®šæ—¶é—´é—´éš”"></a>å›ºå®šæ—¶é—´é—´éš”</h2><p>æ¯5sæ‰§è¡Œä¸€æ¬¡å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  sleep 5</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"`date '+%S'`: doing ..."</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>æ­¤å†™æ³•å¾ˆç®€å•ï¼Œä½†å¯èƒ½ä¼šäº§ç”Ÿç´¯ç§¯è¯¯å·®ã€‚</p>
<p>æ”¹æˆå¦‚ä¸‹å¯è‡ªåŠ¨æ ¡æ­£ï¼Œä½¿æ¯ä¸ªå‘¨æœŸçš„å®é™…æ‰§è¡Œæ—¶åˆ»å’Œé¢„æœŸæ‰§è¡Œæ—¶åˆ»çš„åå·®ä¿æŒåœ¨0.5sä»¥å†…ï¼ˆä½†sleepé—´éš”ä¸å®œè¿‡å°ï¼Œ0.1åˆ°1ä¹‹é—´ï¼Œ0.5å·¦å³å³å¯ï¼Œè¶Šå°CPUè´Ÿè½½è¶Šé«˜ï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">tperiod=5</span><br><span class="line"><span class="built_in">let</span> tnext=`date <span class="string">'+%s'</span>`+tperiod</span><br><span class="line"><span class="built_in">let</span> tend=`date <span class="string">'+%s'</span>`+tperiod*1000  <span class="comment"># å¯è®¾å®šæˆªæ­¢æ—¶åˆ»ï¼Œå¦‚æœæ— é™å¾ªç¯ï¼Œå¯å»æ‰tendç›¸å…³çš„è¡Œ</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  tnow=`date <span class="string">'+%s'</span>`</span><br><span class="line">  sleep 0.5</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$tnow</span> -gt <span class="variable">$tend</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"end."</span></span><br><span class="line">    <span class="built_in">break</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [ <span class="variable">$tnow</span> -le <span class="variable">$tnext</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">continue</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">let</span> tnext+=tperiod</span><br><span class="line"></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"`date '+%S'`: doing ..."</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Shell basic 02</title>
    <url>/linux/shell-basic-02/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="é‡å®šå‘"><a href="#é‡å®šå‘" class="headerlink" title="é‡å®šå‘"></a>é‡å®šå‘</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ls /opt/abc &gt;/dev/null 2&gt;&amp;1  # /dev/nullä½æ¡¶, 2&gt;&amp; é¡»è¿ç€</span><br><span class="line">ls /opt/abc &amp;&gt;/dev/null  # &amp;&gt; é¡»è¿ç€</span><br><span class="line">echo &quot;error: ...&quot; 2&gt;/var/log/err.log</span><br><span class="line">ls /opt/abc &gt;./a.log 2&gt;&amp;1</span><br><span class="line">ls /opt/abc 1&gt;./a.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># *æ‰©å±•</span><br><span class="line">[root@localhost t]# ls</span><br><span class="line">1000-2.txt  1000.txt  xaa  xab  xac  xad</span><br><span class="line"></span><br><span class="line">[root@localhost t]# ls *</span><br><span class="line">1000-2.txt  1000.txt  xaa  xab  xac  xad</span><br><span class="line">[root@localhost t]# echo *</span><br><span class="line">1000-2.txt 1000.txt xaa xab xac xad</span><br><span class="line">[root@localhost t]# echo &quot;*&quot;</span><br><span class="line">*</span><br><span class="line"></span><br><span class="line">[root@localhost t]# echo x*</span><br><span class="line">xaa xab xac xad</span><br><span class="line">[root@localhost t]# echo [[:digit:]]*</span><br><span class="line">1000-2.txt 1000.txt</span><br><span class="line">[root@localhost t]# echo [0-9]*</span><br><span class="line">1000-2.txt 1000.txt</span><br><span class="line">[root@localhost t]# echo [!x]*</span><br><span class="line">1000-2.txt 1000.txt</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># è·¯å¾„æ‰©å±•</span><br><span class="line">[root@localhost zlz]# echo /opt/www/*/*.log</span><br><span class="line">/opt/www/logs/access.log /opt/www/logs/error.log</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># æ³¢æµªçº¿æ‰©å±•ä¸ºå®¶ç›®å½•</span><br><span class="line">[root@localhost zlz]# echo ~</span><br><span class="line">/root</span><br><span class="line">[root@localhost t]# echo ~zeng</span><br><span class="line">/home/zeng</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># ç®—æœ¯æ‰©å±• $</span><br><span class="line">[root@localhost zlz]# echo $((2+2))</span><br><span class="line">4</span><br><span class="line"></span><br><span class="line"># å‚æ•°æ‰©å±•</span><br><span class="line">[root@localhost zlz]# echo $USER</span><br><span class="line">root</span><br><span class="line"></span><br><span class="line"># å‘½ä»¤æ›¿æ¢</span><br><span class="line">[root@localhost zlz]# ls -l $(which cat)</span><br><span class="line">-rwxr-xr-x. 1 root root 54048 Nov 19  2015 /usr/bin/cat</span><br><span class="line"></span><br><span class="line"># åå¼•å·å‘½ä»¤æ›¿æ¢</span><br><span class="line">[root@localhost zlz]# ls -l `which cat`</span><br><span class="line">-rwxr-xr-x. 1 root root 54048 Nov 19  2015 /usr/bin/cat</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸Šç®—æœ¯æ‰©å±•ã€å‚æ•°æ‰©å±•ã€å‘½ä»¤æ›¿æ¢éƒ½è§†ä½œ$è¡¨è¾¾å¼ï¼Œç›¸å½“äºå˜é‡ï¼Œéå•å¼•å·åŒ…å›´å¯è¢«è§£æï¼Œå¦åˆ™ä¸è§£æï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost zlz]# echo &apos;$(which cat)&apos;</span><br><span class="line">$(which cat)</span><br><span class="line">[root@localhost zlz]# echo &apos;`which cat`&apos;</span><br><span class="line">`which cat`</span><br><span class="line">[root@localhost zlz]# echo &apos;$USER&apos;</span><br><span class="line">$USER</span><br><span class="line">[root@localhost zlz]# echo &apos;$((2+2))&apos;</span><br><span class="line">$((2+2))</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># &#123;&#125;æ‰©å±•</span><br><span class="line">[root@kafka-1 ~]# echo &#123;a..c&#125;&#123;0..2&#125; |xargs -n 3</span><br><span class="line">a0 a1 a2</span><br><span class="line">b0 b1 b2</span><br><span class="line">c0 c1 c2</span><br><span class="line"></span><br><span class="line">[root@localhost zlz]# echo a&#123;A&#123;1,2&#125;,B&#123;3,4&#125;&#125;b</span><br><span class="line">aA1b aA2b aB3b aB4b</span><br></pre></td></tr></table></figure>
<h2 id="ç‰¹æ®Šæƒé™"><a href="#ç‰¹æ®Šæƒé™" class="headerlink" title="ç‰¹æ®Šæƒé™"></a>ç‰¹æ®Šæƒé™</h2><p><strong>setuid</strong></p>
<p>åº”ç”¨äºå¯æ‰§è¡Œæ–‡ä»¶ï¼Œä¼šå°†æœ‰æ•ˆç”¨æˆ·IDï¼ˆeffective user IDï¼‰ä»çœŸå®ç”¨æˆ·ï¼ˆå®é™…æ‰§è¡Œç¨‹åºçš„ç”¨æˆ·ï¼‰IDæ›´æ”¹ä¸ºç¨‹åºå±ä¸»çš„æœ‰æ•ˆç”¨æˆ·IDã€‚</p>
<p><strong>setgid</strong></p>
<p>ä¼šå°†æœ‰æ•ˆç»„IDï¼ˆeffective group IDï¼‰ä»çœŸå®ç”¨æˆ·çš„çœŸå®ç»„IDï¼ˆreal group IDï¼‰æ›´æ”¹ä¸ºæ–‡ä»¶å±ä¸»çš„æœ‰æ•ˆç»„IDã€‚</p>
<p><strong>sticky</strong></p>
<p>ç”¨äºå°†å¯æ‰§è¡Œæ–‡ä»¶æ ‡è®°ä¸ºâ€œä¸å¯äº¤æ¢â€ã€‚Linuxä¼šå¿½ç•¥æ–‡ä»¶ä¸Šè®¾ç½®çš„ç²˜æ»ä½ï¼Œå¦‚æœå¯¹ç›®å½•è®¾ç½®äº†ç²˜æ»ä½ï¼Œåˆ™èƒ½å¤Ÿé˜»æ­¢ç”¨æˆ·åˆ é™¤æˆ–è€…é‡å‘½åå…¶ä¸­çš„æ–‡ä»¶ï¼Œé™¤éç”¨æˆ·æ˜¯è¯¥ç›®å½•çš„å±ä¸»ï¼Œæˆ–è€…æ˜¯æ–‡ä»¶çš„å±ä¸»ï¼Œåˆæˆ–è€…æ˜¯è¶…çº§ç”¨æˆ·ã€‚ç²˜æ»ä½å¸¸ç”¨æ¥æ§åˆ¶å¯¹å…±äº«ç›®å½•ï¼ˆå¦‚/tmpï¼‰çš„è®¿é—®ã€‚</p>
<h2 id="cp"><a href="#cp" class="headerlink" title="cp"></a>cp</h2><p>cpä¸åŠ é€‰é¡¹å‚æ•°å¤åˆ¶æ—¶ï¼Œè®¿é—®æ—¶é—´ã€ä¿®æ”¹æ—¶é—´éƒ½ä¼šå˜ï¼ŒåŠ ä¸Š <code>-p</code> æˆ– <code>--preserve</code> å¯ä¿æŒï¼Œä½†changeæ—¶é—´ï¼ˆçŠ¶æ€æ”¹å˜æ—¶é—´ï¼‰æ˜¯æŒ‰æœ€æ–°çš„ã€‚çŠ¶æ€æ”¹å˜æ—¶é—´é€šè¿‡chmodå‘½ä»¤æ›´æ”¹æ–‡ä»¶å±æ€§æ—¶ä¹Ÿä¼šæ›´æ–°ã€‚æ–‡ä»¶é€šè¿‡sedæˆ–viä¿®æ”¹ä¿å­˜ï¼Œ3ä¸ªæ—¶é—´éƒ½æ›´æ–°ä¸ºæœ€æ–°æ—¶é—´ï¼Œé€šè¿‡echoè¿½åŠ å†…å®¹æ—¶modifyæ—¶é—´å’Œchangeæ—¶é—´ä¼šæ›´æ–°ä¸ºæœ€æ–°æ—¶é—´ã€‚</p>
<p>Linuxä¸­æ–‡ä»¶æ²¡æœ‰åˆ›å»ºæ—¶é—´çš„æ¦‚å¿µã€‚</p>
<h2 id="su-amp-sudo"><a href="#su-amp-sudo" class="headerlink" title="su &amp; sudo"></a>su &amp; sudo</h2><p>sudoä¸éœ€è¦å¯åŠ¨æ–°çš„shellï¼Œä¹Ÿä¸éœ€è¦åŠ è½½å…¶ä»–ç”¨æˆ·çš„ç¯å¢ƒã€‚è¿™æ„å‘³ç€sudoä¸éœ€è¦å¼•ç”¨å‘½ä»¤ã€‚</p>
<p>sudoä¸éœ€è¦è¾“å…¥rootå¯†ç ï¼Œå¦‚æœé€šè¿‡visudoæˆ–ç›´æ¥ç¼–è¾‘/etc/sudoersæ–‡ä»¶é…ç½®å…å¯†sudoï¼Œé‚£ä¹ˆå¯ä»¥å…å¯†æ‰§è¡Œï¼Œå¦åˆ™è¾“å…¥sudoææƒå¯†ç ã€‚è€Œ <code>su -</code> æˆ– <code>su</code> æ˜¯çœŸæ­£åˆ‡æ¢åˆ°rootç”¨æˆ·ç¯å¢ƒï¼Œéœ€è¦è¾“å…¥rootå¯†ç ã€‚</p>
<p>sudoå‘½ä»¤çš„-ié€‰é¡¹å¯ç”¨äºå¯åŠ¨ä¸€ä¸ªäº¤äº’å¼çš„è¶…çº§ç”¨æˆ·Shellä¼šè¯ï¼ˆå’Œ <code>su -</code> å·®ä¸å¤šï¼‰ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">su -c <span class="string">'ls -l /root /*'</span></span><br><span class="line">sudo ls -l /root /*</span><br></pre></td></tr></table></figure>
<h2 id="cat"><a href="#cat" class="headerlink" title="cat"></a>cat</h2><p>å¸¸ç”¨äºæ˜¾ç¤ºçŸ­æ–‡æœ¬ï¼Œä¹Ÿå¯ä»¥é…åˆsplitç”¨æ¥è¿æ¥å¤šä¸ªæ–‡ä»¶ã€‚</p>
<p>splitåˆ†å‰²æ–‡ä»¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost t]<span class="comment"># seq 1000 &gt; 1000.txt</span></span><br><span class="line">[root@localhost t]<span class="comment"># ll 1000.txt</span></span><br><span class="line">-rw-r--r--. 1 root root 3893 Oct 31 06:44 1000.txt</span><br><span class="line">[root@localhost t]<span class="comment"># split -b 1KB 1000.txt</span></span><br><span class="line">[root@localhost t]<span class="comment"># ll</span></span><br><span class="line">total 20</span><br><span class="line">-rw-r--r--. 1 root root 3893 Oct 31 06:44 1000.txt</span><br><span class="line">-rw-r--r--. 1 root root 1000 Oct 31 06:45 xaa</span><br><span class="line">-rw-r--r--. 1 root root 1000 Oct 31 06:45 xab</span><br><span class="line">-rw-r--r--. 1 root root 1000 Oct 31 06:45 xac</span><br><span class="line">-rw-r--r--. 1 root root  893 Oct 31 06:45 xad</span><br><span class="line">[root@localhost t]<span class="comment"># </span></span><br><span class="line">[root@localhost t]<span class="comment"># getconf PAGESIZE</span></span><br><span class="line">4096</span><br><span class="line">[root@localhost t]<span class="comment"># ls -sl</span></span><br><span class="line">total 20</span><br><span class="line">4 -rw-r--r--. 1 root root 3893 Oct 31 06:44 1000.txt</span><br><span class="line">4 -rw-r--r--. 1 root root 1000 Oct 31 06:45 xaa</span><br><span class="line">4 -rw-r--r--. 1 root root 1000 Oct 31 06:45 xab</span><br><span class="line">4 -rw-r--r--. 1 root root 1000 Oct 31 06:45 xac</span><br><span class="line">4 -rw-r--r--. 1 root root  893 Oct 31 06:45 xad</span><br></pre></td></tr></table></figure>
<p>é¡ºä¾¿è®°ä¸€ä¸‹ï¼Œls -l ç¬¬ä¸€è¡Œtotalè¡¨ç¤ºæ€»çš„å ç”¨ç©ºé—´ï¼ˆå•ä½ï¼šKBï¼‰ã€‚ä¸€ä¸ªblockå 4KBï¼Œä¸€ä¸ªæ–‡ä»¶è‡³å°‘å ä¸€ä¸ªblockã€‚</p>
<p>catè¿æ¥æ–‡ä»¶ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[root@localhost t]# cat xa* &gt; 1000-2.txt</span><br><span class="line">[root@localhost t]# ll</span><br><span class="line">total 24</span><br><span class="line">-rw-r--r--. 1 root root 3893 Oct 31 06:56 1000-2.txt</span><br><span class="line">-rw-r--r--. 1 root root 3893 Oct 31 06:44 1000.txt</span><br><span class="line">-rw-r--r--. 1 root root 1000 Oct 31 06:45 xaa</span><br><span class="line">-rw-r--r--. 1 root root 1000 Oct 31 06:45 xab</span><br><span class="line">-rw-r--r--. 1 root root 1000 Oct 31 06:45 xac</span><br><span class="line">-rw-r--r--. 1 root root  893 Oct 31 06:45 xad</span><br><span class="line">[root@localhost t]# </span><br><span class="line">[root@localhost t]# diff 1000.txt 1000-2.txt </span><br><span class="line">[root@localhost t]#</span><br></pre></td></tr></table></figure>
<p>åœ¨æ§åˆ¶å°ä¸å¸¦å‚æ•°catï¼Œé€šè¿‡ctrl-Då‘é€EOFç»“æŸè¾“å…¥ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost zlz]<span class="comment"># cat &gt; test_cat.log</span></span><br><span class="line">this is line1        </span><br><span class="line">line2</span><br><span class="line">[root@localhost zlz]<span class="comment"># cat test_cat.log </span></span><br><span class="line">this is line1</span><br><span class="line">line2</span><br></pre></td></tr></table></figure>
<h2 id="tee"><a href="#tee" class="headerlink" title="tee"></a>tee</h2><p>teeï¼Œç®¡é“Tå½¢è½¬æ¥å¤´ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost t]<span class="comment"># ls</span></span><br><span class="line">1000-2.txt  1000.txt  1.txt  xaa  xab  xac  xad</span><br><span class="line">[root@localhost t]<span class="comment"># ls |tee 1.txt |grep xa</span></span><br><span class="line">xaa</span><br><span class="line">xab</span><br><span class="line">xac</span><br><span class="line">xad</span><br><span class="line">[root@localhost t]<span class="comment"># cat 1.txt</span></span><br><span class="line">1000-2.txt</span><br><span class="line">1000.txt</span><br><span class="line">1.txt</span><br><span class="line">xaa</span><br><span class="line">xab</span><br><span class="line">xac</span><br><span class="line">xad</span><br></pre></td></tr></table></figure>
<h2 id="å…±äº«ç›®å½•"><a href="#å…±äº«ç›®å½•" class="headerlink" title="å…±äº«ç›®å½•"></a>å…±äº«ç›®å½•</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[zeng@localhost opt]$ groups</span><br><span class="line">zeng</span><br><span class="line">[zeng@localhost opt]$ umask</span><br><span class="line">0002</span><br><span class="line">[zeng@localhost opt]$ sudo groupadd share</span><br><span class="line">[zeng@localhost opt]$ sudo usermod -a -G share zeng</span><br><span class="line">[zeng@localhost opt]$ groups zeng</span><br><span class="line">zeng : zeng share</span><br><span class="line"></span><br><span class="line"># æ·»åŠ å…¶ä»–ç”¨æˆ·åˆ°shareç»„</span><br><span class="line">$ sudo useradd -m -c &quot;John Doo&quot; -s /bin/bash -G share john</span><br><span class="line"></span><br><span class="line">[zeng@localhost opt]$ sudo mkdir /opt/share</span><br><span class="line">[zeng@localhost opt]$ ls -ld share</span><br><span class="line">drwxr-xr-x. 2 root root 6 Oct 31 09:49 share</span><br><span class="line"></span><br><span class="line">[zeng@localhost opt]$ sudo chown :share share</span><br><span class="line">[zeng@localhost opt]$ ls -ld share</span><br><span class="line">drwxr-xr-x. 2 root share 6 Oct 31 09:49 share</span><br><span class="line"></span><br><span class="line">[zeng@localhost opt]$ sudo chmod g+sw share  # æˆ–è€…chmod 2775</span><br><span class="line">[zeng@localhost opt]$ ls -ld share</span><br><span class="line">drwxrwsr-x. 2 root share 6 Oct 31 09:49 share</span><br><span class="line"></span><br><span class="line">[zeng@localhost opt]$ </span><br><span class="line">[zeng@localhost opt]$ vi share/f01</span><br><span class="line">[zeng@localhost opt]$ mkdir share/d01</span><br><span class="line"></span><br><span class="line"># ï¼ï¼centosä¸‹å®æµ‹æç¤ºæ— æƒé™ï¼Œä½†ä¸Šè¿°æ­¥éª¤åº”è¯¥æ˜¯æ­£ç¡®çš„</span><br></pre></td></tr></table></figure>
<h2 id="bashæç¤ºç¬¦"><a href="#bashæç¤ºç¬¦" class="headerlink" title="bashæç¤ºç¬¦"></a>bashæç¤ºç¬¦</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> PS1=<span class="string">"[\u@\h \W]\\$ "</span></span><br><span class="line">[ <span class="string">"<span class="variable">$PS1</span>"</span> = <span class="string">"\\s-\\v\\\$ "</span> ] &amp;&amp; PS1=<span class="string">"[\u@\h \W]\\$ "</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¯´æ˜ï¼š</span></span><br><span class="line">\uï¼šç”¨æˆ·å</span><br><span class="line">\hï¼šçŸ­ä¸»æœºå</span><br><span class="line">\Wï¼šå½“å‰ç›®å½•</span><br><span class="line">\sï¼šShellåç§°</span><br><span class="line">\vï¼šShellç‰ˆæœ¬å·</span><br></pre></td></tr></table></figure>
<h2 id="vi-amp-vim"><a href="#vi-amp-vim" class="headerlink" title="vi &amp; vim"></a>vi &amp; vim</h2><table>
<thead>
<tr>
<th style="text-align:left">æ“ä½œ</th>
<th>æŒ‰é”®</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">å½“å‰å­—ç¬¦å‰/åç»§ç»­è¾“å…¥</td>
<td>i/a</td>
</tr>
<tr>
<td style="text-align:left">å½“å‰è¡Œé¦–/å°¾è¾“å…¥</td>
<td>I/A</td>
</tr>
<tr>
<td style="text-align:left">åˆ é™¤å½“å‰å­—ç¬¦</td>
<td>x</td>
</tr>
<tr>
<td style="text-align:left">ç²˜è´´åˆ°å½“å‰è¡Œä¸Š/ä¸‹ä¸€è¡Œ</td>
<td>P/p</td>
</tr>
<tr>
<td style="text-align:left">åˆå¹¶è¡Œ</td>
<td>J</td>
</tr>
<tr>
<td style="text-align:left">å/å‰ä¸€ä¸ªå•è¯ã€å/å‰ä¸€ä¸ªå­—ç¬¦ã€ä¸‹/ä¸Šä¸€è¡Œ</td>
<td>w/bã€l/hã€j/k</td>
</tr>
<tr>
<td style="text-align:left">å‰/åä¸€ä¸ªæ–‡ä»¶ï¼ˆçš„ç¼“å†²åŒºï¼‰</td>
<td>:bn/:bp</td>
</tr>
<tr>
<td style="text-align:left">åˆ—å‡ºç¼“å†²åŒºæ–‡ä»¶</td>
<td>:buffers</td>
</tr>
<tr>
<td style="text-align:left">åˆ‡æ¢åˆ°æŒ‡å®šç¼“å†²åŒºn</td>
<td>:buffer n</td>
</tr>
<tr>
<td style="text-align:left">åˆ é™¤ä»¥ä¸‹10è¡Œï¼ˆå«å½“å‰è¡Œï¼‰</td>
<td>:10ddï¼Œ:d9+</td>
</tr>
<tr>
<td style="text-align:left">åˆ é™¤ä»¥ä¸Š10è¡Œï¼ˆå«å½“å‰è¡Œï¼‰</td>
<td>:d9-</td>
</tr>
<tr>
<td style="text-align:left">åˆ é™¤ä»¥ä¸‹æ‰€æœ‰è¡Œ</td>
<td>:dG</td>
</tr>
<tr>
<td style="text-align:left">æ˜¾ç¤º/å…³é—­è¡Œå·</td>
<td>:set nu!</td>
</tr>
<tr>
<td style="text-align:left"></td>
</tr>
</tbody>
</table>
<h2 id="readå‘½ä»¤"><a href="#readå‘½ä»¤" class="headerlink" title="readå‘½ä»¤"></a>readå‘½ä»¤</h2><h3 id="æ¥å‚"><a href="#æ¥å‚" class="headerlink" title="æ¥å‚"></a>æ¥å‚</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 ~]<span class="comment"># ll</span></span><br><span class="line">total 4</span><br><span class="line">-rw-------. 1 root root 2744 Feb 15  2020 anaconda-ks.cfg</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Desktop</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Documents</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Downloads</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Music</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Pictures</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Public</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Templates</span><br><span class="line">drwxr-xr-x. 2 root root    6 Feb 15  2020 Videos</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># </span></span><br><span class="line">[root@kafka-1 ~]<span class="comment"># ll |while read fa ft fu fg fz m d y fn; do echo "$fn: $fz"; done |tail -n +2</span></span><br><span class="line">anaconda-ks.cfg: 2744</span><br><span class="line">Desktop: 6</span><br><span class="line">Documents: 6</span><br><span class="line">Downloads: 6</span><br><span class="line">Music: 6</span><br><span class="line">Pictures: 6</span><br><span class="line">Public: 6</span><br><span class="line">Templates: 6</span><br><span class="line">Videos: 6</span><br></pre></td></tr></table></figure>
<h3 id="è¾“å…¥å¯†ç "><a href="#è¾“å…¥å¯†ç " class="headerlink" title="è¾“å…¥å¯†ç "></a>è¾“å…¥å¯†ç </h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 ~]<span class="comment"># read -sp "password: " a</span></span><br><span class="line">password: [root@kafka-1 ~]<span class="comment"># echo $a</span></span><br><span class="line">abc123</span><br></pre></td></tr></table></figure>
<h3 id="æŒ‡å®šIFS"><a href="#æŒ‡å®šIFS" class="headerlink" title="æŒ‡å®šIFS"></a>æŒ‡å®šIFS</h3><p>æœ¬å‘½ä»¤æ‰§è¡ŒæœŸé—´æ–°IFSæœ‰æ•ˆï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 ~]<span class="comment"># IFS=. read a b c</span></span><br><span class="line">a.b.c</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $a</span></span><br><span class="line">a</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $b</span></span><br><span class="line">b</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $c</span></span><br><span class="line">c</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">[root@kafka-1 ~]<span class="comment"># read a b c</span></span><br><span class="line">a.b.c</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $a</span></span><br><span class="line">a.b.c</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $b</span></span><br><span class="line"></span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $c</span></span><br></pre></td></tr></table></figure>
<p>æœ¬shellå†…æ–°IFSæœ‰æ•ˆï¼ˆæ³¨æ„åˆ†å·ï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 ~]<span class="comment"># IFS=.; read a b c</span></span><br><span class="line">a.b.c</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $c</span></span><br><span class="line">c</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># read a b c</span></span><br><span class="line">x.y.z</span><br><span class="line">[root@kafka-1 ~]<span class="comment"># echo $c</span></span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯ <code>while read</code> æˆ– <code>for in</code> å¾ªç¯ä¸­éœ€åŠ åˆ†å·ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@kafka-1 ~]<span class="comment"># IFS=. while read a b c; do echo "$a,$b,$c"; done</span></span><br><span class="line">-bash: syntax error near unexpected token `<span class="keyword">do</span><span class="string">'</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[root@kafka-1 ~]# IFS=. for i in a.b.c; do echo "$i ..."; done</span></span><br><span class="line"><span class="string">-bash: syntax error near unexpected token `do'</span></span><br><span class="line">[root@kafka-1 ~]<span class="comment"># IFS=.; for i in a.b.c; do echo "$i ..."; done</span></span><br><span class="line">a.b.c ...</span><br><span class="line"></span><br><span class="line">[root@kafka-1 ~]<span class="comment"># IFS=$'\n' for i in `ll`; do echo "$i"; done</span></span><br><span class="line">-bash: syntax error near unexpected token `<span class="keyword">do</span><span class="string">'</span></span><br><span class="line"><span class="string">[root@kafka-1 ~]# IFS=$'</span>\n<span class="string">'; for i in `ll`; do echo "$i"; done</span></span><br><span class="line"><span class="string">total 4</span></span><br><span class="line"><span class="string">-rw-------. 1 root root 2744 Feb 15  2020 anaconda-ks.cfg</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Desktop</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Documents</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Downloads</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Music</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Pictures</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Public</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Templates</span></span><br><span class="line"><span class="string">drwxr-xr-x. 2 root root    6 Feb 15  2020 Videos</span></span><br></pre></td></tr></table></figure>
<h2 id="è½¯ä»¶åŒ…ç®¡ç†"><a href="#è½¯ä»¶åŒ…ç®¡ç†" class="headerlink" title="è½¯ä»¶åŒ…ç®¡ç†"></a>è½¯ä»¶åŒ…ç®¡ç†</h2><p>æ‰“åŒ…å·¥å…·ï¼š</p>
<table>
<thead>
<tr>
<th>Linuxå‘è¡Œç‰ˆ</th>
<th>ä½å±‚å·¥å…·</th>
<th>é«˜å±‚å·¥å…·</th>
</tr>
</thead>
<tbody>
<tr>
<td>redhat</td>
<td>rpm</td>
<td>yum</td>
</tr>
<tr>
<td>debian</td>
<td>dpkg</td>
<td>apt-get</td>
</tr>
</tbody>
</table>
<p>å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºè½¯ä»¶åŒ…</span></span><br><span class="line">rpm -qa</span><br><span class="line">dpkg -l</span><br><span class="line"></span><br><span class="line"><span class="comment"># è½¯ä»¶åŒ…æ˜¯å¦å·²å®‰è£…</span></span><br><span class="line">rpm -q vim  <span class="comment"># redhat</span></span><br><span class="line">dpkg -s vim  <span class="comment"># debian</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åæŸ¥è½¯ä»¶åŒ…</span></span><br><span class="line">rpm -qf /usr/bin/vim</span><br><span class="line">dpkg -S /usr/bin/vim</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Shell</category>
      </categories>
      <tags>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>æ¸…ç†ELKçš„æ—§ç´¢å¼•</title>
    <url>/log-analysis/clean_elk_indices/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>å®‰è£…elasticsearch-curator</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pip install elasticsearch-curator</span><br><span class="line"></span><br><span class="line">å¦‚æœæŠ¥é”™<span class="string">"ERROR: Cannot uninstall 'PyYAML'. It is a distutils installed ..."</span></span><br><span class="line"></span><br><span class="line">pip install pip==8.0.3</span><br><span class="line">pip uninstall pyyaml</span><br><span class="line">pip install elasticsearch-curator</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>é…ç½®ç¤ºä¾‹ï¼š<br><em>~/.curator/curator.yml</em></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">client:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">10.1</span><span class="number">.7</span><span class="number">.211</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9200</span></span><br><span class="line">  <span class="attr">url_prefix:</span></span><br><span class="line">  <span class="attr">use_ssl:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">certificate:</span></span><br><span class="line">  <span class="attr">client_cert:</span></span><br><span class="line">  <span class="attr">client_key:</span></span><br><span class="line">  <span class="attr">aws_key:</span></span><br><span class="line">  <span class="attr">aws_secret_key:</span></span><br><span class="line">  <span class="attr">aws_region:</span></span><br><span class="line">  <span class="attr">ssl_no_validate:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">http_auth:</span></span><br><span class="line">  <span class="attr">timeout:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">master_only:</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">loglevel:</span> <span class="string">INFO</span></span><br><span class="line">  <span class="attr">logfile:</span></span><br><span class="line">  <span class="attr">logformat:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">blacklist:</span> <span class="string">[â€˜elasticsearchâ€™]</span></span><br></pre></td></tr></table></figure>
<p>actionæ–‡ä»¶é…ç½®ï¼š<br><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">actions:</span></span><br><span class="line">  <span class="attr">1:</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">delete_indices</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&gt;-</span></span><br><span class="line">      <span class="string">Delete</span> <span class="string">indices</span> <span class="string">older</span> <span class="string">than</span> <span class="number">10</span> <span class="string">days</span> <span class="string">(based</span> <span class="string">on</span> <span class="string">index</span> <span class="string">name).</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">ignore_empty_list:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">timeout_override:</span></span><br><span class="line">      <span class="attr">continue_if_exception:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">disable_action:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filtertype:</span> <span class="string">pattern</span></span><br><span class="line">      <span class="attr">kind:</span> <span class="string">prefix</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">'[a-z]'</span> <span class="comment">#åŒ¹é…å°å†™å­—æ¯å¼€å¤´çš„index</span></span><br><span class="line">      <span class="attr">exclude:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filtertype:</span> <span class="string">age</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">name</span></span><br><span class="line">      <span class="attr">direction:</span> <span class="string">older</span></span><br><span class="line">      <span class="attr">timestring:</span> <span class="string">'%Y.%m.%d'</span></span><br><span class="line">      <span class="attr">unit:</span> <span class="string">days</span></span><br><span class="line">      <span class="attr">unit_count:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">exclude:</span></span><br></pre></td></tr></table></figure></p>
<p>åªæŒ‰æ—¶é—´åŒ¹é…ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">actions:</span></span><br><span class="line">  <span class="attr">1:</span></span><br><span class="line">    <span class="attr">action:</span> <span class="string">delete_indices</span></span><br><span class="line">    <span class="attr">description:</span> <span class="string">&gt;-</span></span><br><span class="line">      <span class="string">Delete</span> <span class="string">indices</span> <span class="string">older</span> <span class="string">than</span> <span class="number">8</span> <span class="string">days</span> <span class="string">(based</span> <span class="string">on</span> <span class="string">index</span> <span class="string">name).</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="attr">ignore_empty_list:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">timeout_override:</span></span><br><span class="line">      <span class="attr">continue_if_exception:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">disable_action:</span> <span class="literal">False</span></span><br><span class="line">    <span class="attr">filters:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">filtertype:</span> <span class="string">age</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">name</span></span><br><span class="line">      <span class="attr">direction:</span> <span class="string">older</span></span><br><span class="line">      <span class="attr">timestring:</span> <span class="string">'%Y.%m.%d'</span></span><br><span class="line">      <span class="attr">unit:</span> <span class="string">days</span></span><br><span class="line">      <span class="attr">unit_count:</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">exclude:</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œæ¸…ç†ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‘½ä»¤ç”¨æ³•</span></span><br><span class="line">curator &lt;action file&gt; [--config &lt;config file&gt;] [--dry-run]</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@<span class="built_in">test</span>-vm150 opt]<span class="comment"># curator ac.yml</span></span><br><span class="line">2019-08-19 12:02:22,174 INFO      Preparing Action ID: 1, <span class="string">"delete_indices"</span></span><br><span class="line">2019-08-19 12:02:22,191 INFO      GET http://10.1.7.211:9200/ [status:200 request:0.011s]</span><br><span class="line">2019-08-19 12:02:22,191 INFO      Trying Action ID: 1, <span class="string">"delete_indices"</span>: Delete indices older than 30 days (based on index name).</span><br><span class="line">...</span><br><span class="line">2019-08-19 12:02:22,762 INFO      Deleting 7 selected indices: [u<span class="string">'keepcorests-log-2019.08.08'</span>, u<span class="string">'keepcorests-log-2019.08.09'</span>, u<span class="string">'keepweb.mdmadapter-log-2019.08.09'</span>, u<span class="string">'fms-log-2019.08.08'</span>, u<span class="string">'fms-log-2019.08.09'</span>, u<span class="string">'keep_onecardsolution-log-2019.08.08'</span>, u<span class="string">'keep_onecardsolution-log-2019.08.09'</span>]</span><br><span class="line">2019-08-19 12:02:22,762 INFO      ---deleting index keepcorests-log-2019.08.08</span><br><span class="line">2019-08-19 12:02:22,763 INFO      ---deleting index keepcorests-log-2019.08.09</span><br><span class="line">2019-08-19 12:02:22,763 INFO      ---deleting index keepweb.mdmadapter-log-2019.08.09</span><br><span class="line">2019-08-19 12:02:22,763 INFO      ---deleting index fms-log-2019.08.08</span><br><span class="line">2019-08-19 12:02:22,763 INFO      ---deleting index fms-log-2019.08.09</span><br><span class="line">2019-08-19 12:02:22,763 INFO      ---deleting index keep_onecardsolution-log-2019.08.08</span><br><span class="line">2019-08-19 12:02:22,763 INFO      ---deleting index keep_onecardsolution-log-2019.08.09</span><br><span class="line">2019-08-19 12:02:23,049 INFO      DELETE http://10.1.7.211:9200/fms-log-2019.08.08,fms-log-2019.08.09,keep_onecardsolution-log-2019.08.08,keep_onecardsolution-log-2019.08.09,keepcorests-log-2019.08.08,keepcorests-log-2019.08.09,keepweb.mdmadapter-log-2019.08.09?master_timeout=100s [status:200 request:0.286s]</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>ELKè‹¥å¹²é—®é¢˜è®°å½•</title>
    <url>/log-analysis/elk-problems/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>è®°å½•ä½¿ç”¨ELKé‡åˆ°çš„å‡ ä¸ªé—®é¢˜</p>
</blockquote>
<a id="more"></a>
<h2 id="è¾“å‡ºæ—¥å¿—å¤šè€—å°½ç£ç›˜ç©ºé—²ç©ºé—´"><a href="#è¾“å‡ºæ—¥å¿—å¤šè€—å°½ç£ç›˜ç©ºé—²ç©ºé—´" class="headerlink" title="è¾“å‡ºæ—¥å¿—å¤šè€—å°½ç£ç›˜ç©ºé—²ç©ºé—´"></a>è¾“å‡ºæ—¥å¿—å¤šè€—å°½ç£ç›˜ç©ºé—²ç©ºé—´</h2><p>/usr/share/elasticsearch/config/log4j2.properties  ç½®logLevel: off</p>
<h2 id="ESé»˜è®¤åˆ†ç‰‡æ•°1000ä¸å¤Ÿçš„é—®é¢˜"><a href="#ESé»˜è®¤åˆ†ç‰‡æ•°1000ä¸å¤Ÿçš„é—®é¢˜" class="headerlink" title="ESé»˜è®¤åˆ†ç‰‡æ•°1000ä¸å¤Ÿçš„é—®é¢˜"></a>ESé»˜è®¤åˆ†ç‰‡æ•°1000ä¸å¤Ÿçš„é—®é¢˜</h2><p>ç´¢å¼•esæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"error"</span> : &#123;</span><br><span class="line">    <span class="attr">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"validation_exception"</span>,</span><br><span class="line">        <span class="attr">"reason"</span> : <span class="string">"Validation Failed: 1: this action would add [2] total shards, but this cluster currently has [1000]/[1000] maximum shards open;"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"type"</span> : <span class="string">"validation_exception"</span>,</span><br><span class="line">    <span class="attr">"reason"</span> : <span class="string">"Validation Failed: 1: this action would add [2] total shards, but this cluster currently has [1000]/[1000] maximum shards open;"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"status"</span> : <span class="number">400</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è§£å†³ï¼šè®¾ç½®æœ€å¤§åˆ†ç‰‡æ•°3000</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT /_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"transient"</span>: &#123;</span><br><span class="line">    <span class="string">"cluster"</span>: &#123;</span><br><span class="line">      <span class="string">"max_shards_per_node"</span>:3000</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="docker-composeé™åˆ¶ELKçš„CPUã€å†…å­˜"><a href="#docker-composeé™åˆ¶ELKçš„CPUã€å†…å­˜" class="headerlink" title="docker-composeé™åˆ¶ELKçš„CPUã€å†…å­˜"></a>docker-composeé™åˆ¶ELKçš„CPUã€å†…å­˜</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.7'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"><span class="attr">elasticsearch:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">...</span></span><br><span class="line">  <span class="string">...</span></span><br><span class="line">  <span class="attr">deploy:</span></span><br><span class="line">	<span class="attr">resources:</span></span><br><span class="line">	  <span class="attr">limits:</span></span><br><span class="line">		<span class="attr">cpus:</span> <span class="string">'0.50'</span></span><br><span class="line">		<span class="attr">memory:</span> <span class="string">4096M</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨å‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker-compose --compatibility up -d</span><br></pre></td></tr></table></figure>
<h2 id="elasticsearchã€kibana-é€šè¿‡NginXä½œBasic-Authè®¤è¯"><a href="#elasticsearchã€kibana-é€šè¿‡NginXä½œBasic-Authè®¤è¯" class="headerlink" title="elasticsearchã€kibana é€šè¿‡NginXä½œBasic Authè®¤è¯"></a>elasticsearchã€kibana é€šè¿‡NginXä½œBasic Authè®¤è¯</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">upstream kb443 &#123;</span><br><span class="line">    server 127.0.0.1:5601;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">upstream es443 &#123;</span><br><span class="line">    server 127.0.0.1:9200;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/keep.com/fullchain.pem;</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/keep.com/privkey.pem;</span><br><span class="line">    server_name es.keep.com;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">      auth_basic "secret";</span><br><span class="line">      auth_basic_user_file /etc/nginx/nginx_passwd.kibana;</span><br><span class="line">      proxy_pass http://es443;</span><br><span class="line">      proxy_redirect off;</span><br><span class="line">      proxy_buffering off;</span><br><span class="line">      proxy_http_version 1.1;</span><br><span class="line">      proxy_set_header Connection "Keep-Alive";</span><br><span class="line">      proxy_set_header Proxy-Connection "Keep-Alive";</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    ssl_certificate /etc/letsencrypt/live/keep.com/fullchain.pem;</span><br><span class="line">    ssl_certificate_key /etc/letsencrypt/live/keep.com/privkey.pem;</span><br><span class="line">    server_name kibana.keep.com;</span><br><span class="line"></span><br><span class="line">    root html;</span><br><span class="line">    index index.html index.htm;</span><br><span class="line">    access_log /var/log/nginx/kibana-443.access.log main;</span><br><span class="line">    error_log /var/log/nginx/kibana-443.error.log ;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        auth_basic "secret";</span><br><span class="line">        auth_basic_user_file /etc/nginx/nginx_passwd.kibana;</span><br><span class="line">        proxy_pass              http://kb443;</span><br><span class="line">        proxy_redirect          off;</span><br><span class="line">        proxy_set_header    Host        $host;</span><br><span class="line">        proxy_set_header    X-Real-IP   $remote_addr;</span><br><span class="line">        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">        proxy_redirect http://$host http://$host:$server_port;</span><br><span class="line">        add_header Strict-Transport-Security "max-age=31536000";</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    error_page  500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ›´æ–°ç”¨æˆ·å/å¯†ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum install httpd-tools -y</span></span><br><span class="line">htpasswd -c -b /etc/nginx/nginx_passwd.kibana <span class="variable">$username</span> <span class="variable">$password</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>ESåˆ†ç»„æƒé™ç®¡ç†çš„è´¦å·è®¾ç½®</title>
    <url>/log-analysis/es-account-manage/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>åŸºäºX-Packæƒé™æ§åˆ¶ç‰ˆESï¼Œç»™ä¸åŒé¡¹ç›®ç»„ã€ç”¨æˆ·åˆ†é…ä¸åŒçš„æƒé™</p>
</blockquote>
<a id="more"></a>
<h2 id="åˆ›å»ºè§’è‰²"><a href="#åˆ›å»ºè§’è‰²" class="headerlink" title="åˆ›å»ºè§’è‰²"></a>åˆ›å»ºè§’è‰²</h2><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579570458650.png" alt="1579570458650"></p>
<h3 id="è®¾ç½®è§’è‰²çš„ESæƒé™"><a href="#è®¾ç½®è§’è‰²çš„ESæƒé™" class="headerlink" title="è®¾ç½®è§’è‰²çš„ESæƒé™"></a>è®¾ç½®è§’è‰²çš„ESæƒé™</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579570909750.png" alt="1579570909750"></p>
<h3 id="è®¾ç½®è§’è‰²çš„Kibanaæƒé™"><a href="#è®¾ç½®è§’è‰²çš„Kibanaæƒé™" class="headerlink" title="è®¾ç½®è§’è‰²çš„Kibanaæƒé™"></a>è®¾ç½®è§’è‰²çš„Kibanaæƒé™</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579570803128.png" alt="1579570803128"></p>
<h2 id="åˆ›å»ºç”¨æˆ·"><a href="#åˆ›å»ºç”¨æˆ·" class="headerlink" title="åˆ›å»ºç”¨æˆ·"></a>åˆ›å»ºç”¨æˆ·</h2><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579570327982.png" alt="1579570327982"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579571404585.png" alt="1579571404585"></p>
<h3 id="æ–°ç”¨æˆ·ç™»å½•"><a href="#æ–°ç”¨æˆ·ç™»å½•" class="headerlink" title="æ–°ç”¨æˆ·ç™»å½•"></a>æ–°ç”¨æˆ·ç™»å½•</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579571546419.png" alt="1579571546419"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579571702942.png" alt="1579571702942"></p>
<h3 id="æµ‹è¯•ESç´¢å¼•æƒé™"><a href="#æµ‹è¯•ESç´¢å¼•æƒé™" class="headerlink" title="æµ‹è¯•ESç´¢å¼•æƒé™"></a>æµ‹è¯•ESç´¢å¼•æƒé™</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -XPUT -u es:password <span class="string">"http://es.keep.com/es-test/_doc/1?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "name": "John"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"error"</span> : &#123;</span><br><span class="line">    <span class="attr">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">        <span class="attr">"reason"</span> : <span class="string">"action [indices:admin/create] is unauthorized for user [es]"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">    <span class="attr">"reason"</span> : <span class="string">"action [indices:admin/create] is unauthorized for user [es]</span></span><br><span class="line"><span class="string">  &#125;,</span></span><br><span class="line"><span class="string">  "</span>status<span class="string">" : 403</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>æƒé™ä¸å¤Ÿï¼Œä¸èƒ½åˆ›å»ºè¯¥ç´¢å¼•ã€‚</p>
<p>ä½¿ç”¨elasticè´¦å·æŸ¥çœ‹å·²åˆ›å»ºçš„role_eså…·ä½“æœ‰å“ªäº›æƒé™ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -XGET -u elastic:xxxxxx <span class="string">"http://es.keep.com/_xpack/security/role/role_es"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"role_es"</span>: &#123;</span><br><span class="line">    <span class="string">"cluster"</span>: [],</span><br><span class="line">    <span class="string">"indices"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"names"</span>: [</span><br><span class="line">          <span class="string">"es.*"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"privileges"</span>: [</span><br><span class="line">          <span class="string">"all"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"field_security"</span>: &#123;</span><br><span class="line">          <span class="string">"grant"</span>: [</span><br><span class="line">            <span class="string">"*"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">"except"</span>: []</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"allow_restricted_indices"</span>: <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"applications"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"application"</span>: <span class="string">"kibana-.kibana"</span>,</span><br><span class="line">        <span class="string">"privileges"</span>: [</span><br><span class="line">          <span class="string">"feature_discover.all"</span>,</span><br><span class="line">          <span class="string">"feature_visualize.all"</span>,</span><br><span class="line">          <span class="string">"feature_dashboard.all"</span>,</span><br><span class="line">          <span class="string">"feature_dev_tools.all"</span>,</span><br><span class="line">          <span class="string">"feature_indexPatterns.all"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"resources"</span>: [</span><br><span class="line">          <span class="string">"space:default"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"run_as"</span>: [],</span><br><span class="line">    <span class="string">"metadata"</span>: &#123;&#125;,</span><br><span class="line">    <span class="string">"transient_metadata"</span>: &#123;</span><br><span class="line">      <span class="string">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”±äºç»™role_esè§’è‰²åˆ†é…çš„ESç´¢å¼•æƒé™æ˜¯ä»…åç§°ä»¥<code>es.</code>å¼€å¤´ï¼Œæ•…æ— æƒåˆ›å»º<code>es-test</code>ã€‚æ”¹ä¸ºåˆ›å»º<code>es.test</code>å†è¯•åˆ™æˆåŠŸï¼š</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"_index"</span> : <span class="string">"es.test"</span>,</span><br><span class="line">  <span class="attr">"_type"</span> : <span class="string">"_doc"</span>,</span><br><span class="line">  <span class="attr">"_id"</span> : <span class="string">"1"</span>,</span><br><span class="line">  <span class="attr">"_version"</span> : <span class="number">1</span>,</span><br><span class="line">  <span class="attr">"result"</span> : <span class="string">"created"</span>,</span><br><span class="line">  <span class="attr">"_shards"</span> : &#123;</span><br><span class="line">    <span class="attr">"total"</span> : <span class="number">2</span>,</span><br><span class="line">    <span class="attr">"successful"</span> : <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"failed"</span> : <span class="number">0</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"_seq_no"</span> : <span class="number">0</span>,</span><br><span class="line">  <span class="attr">"_primary_term"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/es-account-manage.assets/1579574124809.png" alt="1579574124809"></p>
<h2 id="è´¦å·è§„åˆ’"><a href="#è´¦å·è§„åˆ’" class="headerlink" title="è´¦å·è§„åˆ’"></a>è´¦å·è§„åˆ’</h2><p>æ ¹æ®ä»¥ä¸Šï¼Œåˆæ­¥è®¾ç½®äº†ä»¥ä¸‹è´¦å·ï¼š</p>
<table>
<thead>
<tr>
<th>è§’è‰²</th>
<th>ç°æœ‰è´¦å·</th>
<th>ESç´¢å¼•æƒé™</th>
<th>Kibanaå·¥ä½œåŒºæƒé™</th>
</tr>
</thead>
<tbody>
<tr>
<td>role_es</td>
<td><strong>es</strong></td>
<td>es.*</td>
<td>å‘ç°  feature_discover.all<br>å¯è§†åŒ–  feature_visualize.all<br>ä»ªè¡¨æ¿  feature_dashboard.all<br>å¼€å‘å·¥å…·  feature_dev_tools.all<br>ç´¢å¼•æ¨¡å¼  eature_indexPatterns.all</td>
</tr>
<tr>
<td>role_k8s</td>
<td><strong>k8s</strong></td>
<td>k8s*</td>
<td>åŒä¸Š</td>
</tr>
</tbody>
</table>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>Elasticsearchï¼ˆå¯ç”¨ç”¨æˆ·æƒé™æ§åˆ¶ï¼‰é•œåƒæ„å»ºè¿‡ç¨‹</title>
    <url>/log-analysis/es-xpack/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h2 id="è‡ªåŠ¨æ„å»º-amp-æ¨é€ESé•œåƒ"><a href="#è‡ªåŠ¨æ„å»º-amp-æ¨é€ESé•œåƒ" class="headerlink" title="è‡ªåŠ¨æ„å»º&amp;æ¨é€ESé•œåƒ"></a>è‡ªåŠ¨æ„å»º&amp;æ¨é€ESé•œåƒ</h2><p>ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> Harbor_AddRess=x.x.x.x</span><br><span class="line"><span class="built_in">export</span> Harbor_User=xxx</span><br><span class="line"><span class="built_in">export</span> Harbor_Pwd=xxxxxx</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æ„å»ºæ–°é•œåƒï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 0</span></span><br><span class="line">mypath=$(<span class="built_in">cd</span> `dirname <span class="variable">$0</span>`; <span class="built_in">pwd</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$mypath</span></span><br><span class="line"></span><br><span class="line">version=<span class="variable">$1</span></span><br><span class="line">version=<span class="variable">$&#123;version:=7.5.1&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"version: <span class="variable">$version</span>"</span></span><br><span class="line"></span><br><span class="line">mkdir <span class="variable">$version</span></span><br><span class="line">es_path=<span class="variable">$mypath</span>/<span class="variable">$version</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$es_path</span></span><br><span class="line"></span><br><span class="line">mkdir -p <span class="variable">$es_path</span>/&#123;src,build,install&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$es_path</span>/src</span><br><span class="line">wget https://github.com/elastic/elasticsearch/archive/v<span class="variable">$&#123;version&#125;</span>.tar.gz</span><br><span class="line">tar -xf v<span class="variable">$&#123;version&#125;</span>.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$es_path</span>/install</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-<span class="variable">$&#123;version&#125;</span>-linux-x86_64.tar.gz</span><br><span class="line">tar -xf elasticsearch-<span class="variable">$&#123;version&#125;</span>-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$es_path</span>/build</span><br><span class="line"></span><br><span class="line"><span class="comment"># lib module</span></span><br><span class="line">ln -s <span class="variable">$es_path</span>/install/elasticsearch-<span class="variable">$&#123;version&#125;</span>/lib .</span><br><span class="line">ln -s <span class="variable">$es_path</span>/install/elasticsearch-<span class="variable">$&#123;version&#125;</span>/modules .</span><br><span class="line"></span><br><span class="line"><span class="comment"># License.java</span></span><br><span class="line">find <span class="variable">$es_path</span>/src -name <span class="string">"License.java"</span> | xargs -r -I &#123;&#125; cp &#123;&#125; .</span><br><span class="line">sed -i <span class="string">'s#this.type = type;#this.type = "platinum";#g'</span> License.java</span><br><span class="line">sed -i <span class="string">'s#validate();#// validate();#g'</span> License.java</span><br><span class="line"></span><br><span class="line"><span class="comment"># compile License.java</span></span><br><span class="line">javac -cp <span class="string">"`ls lib/elasticsearch-<span class="variable">$&#123;version&#125;</span>.jar`:`ls lib/elasticsearch-x-content-<span class="variable">$&#123;version&#125;</span>.jar`:`ls lib/lucene-core-*.jar`:`ls modules/x-pack-core/x-pack-core-<span class="variable">$&#123;version&#125;</span>.jar`"</span> License.java</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"=========================== License.java: in `pwd`/"</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># 3</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$es_path</span>/build</span><br><span class="line">mkdir src &amp;&amp; <span class="built_in">cd</span> src</span><br><span class="line"></span><br><span class="line">find <span class="variable">$es_path</span>/install -name <span class="string">"x-pack-core-<span class="variable">$&#123;version&#125;</span>.jar"</span> | xargs -r -I &#123;&#125; cp &#123;&#125; .</span><br><span class="line">jar xvf x-pack-core-<span class="variable">$&#123;version&#125;</span>.jar</span><br><span class="line">rm -f x-pack-core-<span class="variable">$&#123;version&#125;</span>.jar</span><br><span class="line">cp -f ../License*.class org/elasticsearch/license/</span><br><span class="line">jar cvf x-pack-core-<span class="variable">$&#123;version&#125;</span>.jar .</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4</span></span><br><span class="line">cat &lt;&lt;EOF &gt; Dockerfile</span><br><span class="line">FROM  elasticsearch:<span class="variable">$&#123;version&#125;</span></span><br><span class="line"></span><br><span class="line">COPY  ./x-pack-core-<span class="variable">$&#123;version&#125;</span>.jar  /usr/share/elasticsearch/modules/x-pack-core/</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"docker build elasticsearch by running:"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"docker build -t elasticsearch:<span class="variable">$&#123;version&#125;</span> ."</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"under current directory"</span></span><br><span class="line"><span class="built_in">echo</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"End"</span></span><br></pre></td></tr></table></figure>
<p><em>è„šæœ¬æœªè‡ªåŠ¨è¿è¡Œdocker buildåŠdocker push</em></p>
<h2 id="å‡çº§ELK"><a href="#å‡çº§ELK" class="headerlink" title="å‡çº§ELK"></a>å‡çº§ELK</h2><ol>
<li>ESé•œåƒæ”¹ç”¨æ–°æ„å»ºçš„elasticsearch:7.5.1</li>
</ol>
<ol start="2">
<li><p>è®¾ç½®Kibanaä¸­æ–‡:</p>
<p>ä¿®æ”¹Kibanaé…ç½®æ–‡ä»¶kibana.yml</p>
</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">server.name:</span> <span class="string">kibana</span></span><br><span class="line"><span class="attr">server.host:</span> <span class="string">"0"</span></span><br><span class="line"><span class="attr">elasticsearch.hosts:</span> <span class="string">[</span> <span class="string">"http://elasticsearch:9200"</span> <span class="string">]</span></span><br><span class="line"><span class="attr">xpack.monitoring.ui.container.elasticsearch.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">elasticsearch.username:</span> <span class="string">xxx</span></span><br><span class="line"><span class="attr">elasticsearch.password:</span> <span class="string">xxxxxx</span></span><br><span class="line"><span class="attr">elasticsearch.requestTimeout:</span> <span class="number">90000</span></span><br><span class="line"><span class="attr">i18n.locale:</span> <span class="string">"zh-CN"</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>ELKéƒ¨ç½²è‡³K8så¹¶å¯ç”¨ADè®¤è¯</title>
    <url>/log-analysis/k8s-elk-auth-kibana-via-ad/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>å•èŠ‚ç‚¹ã€å¤šèŠ‚ç‚¹ç¤ºä¾‹<br>ä½¿ç”¨åŸºäºNFSçš„åŠ¨æ€PV<br>å¯ç”¨Windows ADåŸŸè´¦å·è®¤è¯</p>
</blockquote>
<a id="more"></a>
<h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>é•œåƒå‡†å¤‡</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker push lzzeng/es-xpack:7.5.1	 <span class="comment"># xpackç»„ä»¶ç ´è§£ç‰ˆ</span></span><br></pre></td></tr></table></figure>
<h3 id="å•èŠ‚ç‚¹"><a href="#å•èŠ‚ç‚¹" class="headerlink" title="å•èŠ‚ç‚¹"></a>å•èŠ‚ç‚¹</h3><p><a href="https://github.com/lzzeng/lzzeng.github.io/tree/src/hexo/extra-files/elk-single-node/" rel="external nofollow noopener noreferrer" target="_blank">K8s ELK single-node</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sh run-es.sh; sh run-kb.sh; sh run-logstash.sh</span></span><br></pre></td></tr></table></figure>
<h3 id="å¤šèŠ‚ç‚¹"><a href="#å¤šèŠ‚ç‚¹" class="headerlink" title="å¤šèŠ‚ç‚¹"></a>å¤šèŠ‚ç‚¹</h3><p><a href="https://github.com/lzzeng/lzzeng.github.io/tree/src/hexo/extra-files/elk-cluster/" rel="external nofollow noopener noreferrer" target="_blank">K8s ELK cluster</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># sh run-es.sh; sh run-kb.sh; sh run-logstash.sh</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="ADåŸŸè´¦å·è®¤è¯"><a href="#ADåŸŸè´¦å·è®¤è¯" class="headerlink" title="ADåŸŸè´¦å·è®¤è¯"></a>ADåŸŸè´¦å·è®¤è¯</h2><p>esé…ç½®å­—å…¸ es-cm2.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># å¦‚æœè¦åˆå§‹ç»‘å®šrole_mapping.yml:</span></span><br><span class="line">  <span class="comment"># role_mapping.yml: |-</span></span><br><span class="line">  <span class="comment">#   kibana_user:</span></span><br><span class="line">  <span class="comment">#     - "CN=elk_user,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">  <span class="comment">#     - "CN=å ¡å’æœº,CN=Users,DC=keep,DC=com"</span></span><br><span class="line">  <span class="comment">#   superuser:</span></span><br><span class="line">  <span class="comment">#     - "CN=elk_admin,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">  <span class="attr">elasticsearch.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">cluster.name:</span> <span class="string">"docker-cluster"</span></span><br><span class="line">    <span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line">    <span class="attr">xpack.security.authc.realms.active_directory:</span></span><br><span class="line">      <span class="attr">my_ad:</span></span><br><span class="line">        <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">domain_name:</span> <span class="string">keep.com</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">ldap://192.168.100.20:389,</span> <span class="string">ldap://192.168.100.29:389</span></span><br><span class="line">        <span class="attr">bind_dn:</span> <span class="string">xxx@keep.com</span></span><br><span class="line">        <span class="attr">bind_password:</span> <span class="string">******</span></span><br><span class="line">        <span class="attr">load_balance:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">"round_robin"</span></span><br><span class="line">        <span class="attr">user_search:</span></span><br><span class="line">          <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">          <span class="attr">filter:</span> <span class="string">"(&amp;(objectClass=user)(sAMAccountName=&#123;0&#125;))"</span></span><br><span class="line">        <span class="attr">group_search:</span></span><br><span class="line">          <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">        <span class="comment"># å¦‚æœè¦åˆå§‹ç»‘å®šrole_mapping.yml:</span></span><br><span class="line">        <span class="comment">#files:</span></span><br><span class="line">        <span class="comment">#  role_mapping: "/usr/share/elasticsearch/config/role_mapping.yml"</span></span><br><span class="line">        <span class="comment">#unmapped_groups_as_roles: true</span></span><br></pre></td></tr></table></figure>
<p>å¦æœ‰å¦‚ä¸‹å‘½ä»¤æ·»åŠ bind_dnçš„å¯†ç ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">bin/elasticsearch-keystore add xpack.security.authc.realms.active_directory.my_ad.secure_bind_password</span><br></pre></td></tr></table></figure>
<p>é›†ç¾¤æ­£å¸¸å¯åŠ¨åï¼Œä»¥ç®¡ç†è´¦å·åœ¨Kibanaçš„å¼€å‘å·¥å…·ç•Œé¢è°ƒç”¨ESçš„APIä½œã€ç”¨æˆ·-è§’è‰²ã€‘åç»‘å®šçš„æ–¹æ³•ç¤ºä¾‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-auth-kibana-via-ad.assets/1582290036274.png" alt="1582290036274"></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># GET /_security/role_mapping/admins</span></span><br><span class="line"><span class="comment"># DELETE /_security/role_mapping/admins</span></span><br><span class="line"><span class="comment"># GET /_security/role_mapping/basic_users</span></span><br><span class="line"><span class="comment"># DELETE /_security/role_mapping/basic_users</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹ç®¡ç†å‘˜çš„ç»‘å®š</span></span><br><span class="line">PUT /_security/role_mapping/admins</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"roles"</span> : [ <span class="string">"kibana_user"</span>, ... ],    <span class="comment"># éœ€è¦åˆ†é…çš„è§’è‰²</span></span><br><span class="line">  <span class="string">"rules"</span> : &#123; <span class="string">"field"</span> : &#123;</span><br><span class="line">    <span class="string">"groups"</span> : <span class="string">"CN=elk_admin,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">  &#125; &#125;,</span><br><span class="line">  <span class="string">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯¹æ™®é€šç”¨æˆ·çš„ç»‘å®š</span></span><br><span class="line">PUT  /_security/role_mapping/basic_users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"enabled"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"roles"</span> : [ <span class="string">"kibana_user"</span> ],</span><br><span class="line">    <span class="string">"rules"</span> : &#123;</span><br><span class="line">      <span class="string">"any"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field"</span> : &#123;</span><br><span class="line">            <span class="string">"groups"</span> : <span class="string">"CN=elk_user,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field"</span> : &#123;</span><br><span class="line">            <span class="string">"dn"</span> : <span class="string">"CN=å ¡å’æœº,CN=Users,DC=keep,DC=com"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-auth-kibana-via-ad.assets/1582290767486.png" alt="1582290767486"></p>
<h2 id="Logstashé…ç½®"><a href="#Logstashé…ç½®" class="headerlink" title="Logstashé…ç½®"></a>Logstashé…ç½®</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">log-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">elk</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">logstash.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">http.host:</span> <span class="string">"0.0.0.0"</span></span><br><span class="line">    <span class="attr">path.config:</span> <span class="string">/usr/share/logstash/pipeline</span></span><br><span class="line">    <span class="attr">xpack.monitoring.enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">log-pipeline</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">elk</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">tcp-input.conf:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">input</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">tcp</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">514</span></span><br><span class="line">        <span class="string">type</span> <span class="string">=&gt;</span> <span class="string">syslog</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">      <span class="string">beats</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">port</span> <span class="string">=&gt;</span> <span class="number">5044</span></span><br><span class="line">        <span class="string">type</span> <span class="string">=&gt;</span> <span class="string">beatlog</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line">  <span class="comment"># kafka-input.conf: |-</span></span><br><span class="line">  <span class="comment">#   input &#123;</span></span><br><span class="line">  <span class="comment">#     kafka &#123;</span></span><br><span class="line">  <span class="comment">#       bootstrap_servers =&gt; "bootstrap.kafka.svc.cluster.local:9092"</span></span><br><span class="line">  <span class="comment">#       topics =&gt; ["fail2ban", "rsyslog", "dummy", "docker", "k8s", "twitter"]</span></span><br><span class="line">  <span class="comment">#       group_id =&gt; "logstash_elastic"</span></span><br><span class="line">  <span class="comment">#       client_id =&gt; "logstash"</span></span><br><span class="line">  <span class="comment">#       consumer_threads =&gt; 1</span></span><br><span class="line">  <span class="comment">#       auto_offset_reset =&gt; "earliest"</span></span><br><span class="line">  <span class="comment">#       codec =&gt; plain &#123; format =&gt; "%&#123;message&#125;" &#125;</span></span><br><span class="line">  <span class="comment">#       decorate_events =&gt; true</span></span><br><span class="line">  <span class="comment">#     &#125;</span></span><br><span class="line">  <span class="comment">#   &#125;</span></span><br><span class="line">  <span class="attr">elasticsearch-output.conf:</span> <span class="string">|-</span></span><br><span class="line">    <span class="string">output</span> <span class="string">&#123;</span></span><br><span class="line">      <span class="string">elasticsearch</span> <span class="string">&#123;</span></span><br><span class="line">        <span class="string">index</span> <span class="string">=&gt;</span> <span class="string">"logstash-<span class="template-variable">%&#123;+YYYY.MM.dd&#125;</span>"</span></span><br><span class="line">        <span class="comment"># hosts =&gt; "elasticsearch:9200"</span></span><br><span class="line">        <span class="string">hosts</span> <span class="string">=&gt;</span> <span class="string">["http://es-cluster-0.elasticsearch-headless.elk:9200",</span> <span class="string">"http://es-cluster-1.elasticsearch-headless.elk:9200"</span><span class="string">,</span> <span class="string">"http://es-cluster-2.elasticsearch-headless.elk:9200"</span><span class="string">]</span></span><br><span class="line">        <span class="string">user</span> <span class="string">=&gt;</span> <span class="string">"elastic"</span></span><br><span class="line">        <span class="string">password</span> <span class="string">=&gt;</span> <span class="string">"******"</span></span><br><span class="line">      <span class="string">&#125;</span></span><br><span class="line">    <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>ä»¥NodePortæ–¹å¼æš´éœ²logstashæœåŠ¡ï¼Œ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">The Service <span class="string">"logstash"</span> is invalid: spec.clusterIP: Invalid value: <span class="string">"None"</span>: may not be <span class="built_in">set</span> to <span class="string">'None'</span> <span class="keyword">for</span> NodePort services</span><br></pre></td></tr></table></figure>
<p>æ­¤æ–¹å¼ clusterIPä¸èƒ½ä¸ºNoneã€‚</p>
<h2 id="å…¶å®ƒ"><a href="#å…¶å®ƒ" class="headerlink" title="å…¶å®ƒ"></a>å…¶å®ƒ</h2><h3 id="Elasticsearch-cluster-hoståœ°å€"><a href="#Elasticsearch-cluster-hoståœ°å€" class="headerlink" title="Elasticsearch cluster hoståœ°å€"></a>Elasticsearch cluster hoståœ°å€</h3><p>ESçš„serviceæè¿°æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9200</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">es-http</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">32200</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elasticsearch-headless</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9200</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br></pre></td></tr></table></figure>
<p>åœ¨é›†ç¾¤å†…éƒ¨ï¼Œä»kibanaè®¿é—®esï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">sh-4.2$ curl http://es-cluster-1.elasticsearch.elk:9200 -u elastic:******</span><br><span class="line">curl: (6) Could not resolve host: es-cluster-1.elasticsearch.elk; Unknown error</span><br><span class="line"></span><br><span class="line"><span class="comment"># è´Ÿè½½èŠ‚ç‚¹æ¯æ¬¡éƒ½å˜åŒ–</span></span><br><span class="line">sh-4.2$ curl http://elasticsearch:9200 -u elastic:******</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"es-cluster-0"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"es-cluster"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"VP2AdLR9RzqPVz3tnmSdEw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.5.1"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"3ae9ac9a93c95bd0cdc054951cf95d88e1e18d96"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2019-12-16T22:57:37.835892Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.3.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è´Ÿè½½èŠ‚ç‚¹æ¯æ¬¡éƒ½å˜åŒ–</span></span><br><span class="line">sh-4.2$ curl http://elasticsearch.elk:9200 -u elastic:******</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"es-cluster-2"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"es-cluster"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"VP2AdLR9RzqPVz3tnmSdEw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.5.1"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"3ae9ac9a93c95bd0cdc054951cf95d88e1e18d96"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2019-12-16T22:57:37.835892Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.3.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># è´Ÿè½½èŠ‚ç‚¹ä¸å¸¸å˜åŒ–</span></span><br><span class="line">sh-4.2$ curl http://elasticsearch-headless.elk:9200 -u elastic:******</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"es-cluster-0"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"es-cluster"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"VP2AdLR9RzqPVz3tnmSdEw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.5.1"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"3ae9ac9a93c95bd0cdc054951cf95d88e1e18d96"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2019-12-16T22:57:37.835892Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.3.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‡å®šèŠ‚ç‚¹</span></span><br><span class="line">sh-4.2$ curl http://es-cluster-0.elasticsearch-headless.elk:9200 -u elastic:******</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span> : <span class="string">"es-cluster-0"</span>,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"es-cluster"</span>,</span><br><span class="line">  <span class="string">"cluster_uuid"</span> : <span class="string">"VP2AdLR9RzqPVz3tnmSdEw"</span>,</span><br><span class="line">  <span class="string">"version"</span> : &#123;</span><br><span class="line">    <span class="string">"number"</span> : <span class="string">"7.5.1"</span>,</span><br><span class="line">    <span class="string">"build_flavor"</span> : <span class="string">"default"</span>,</span><br><span class="line">    <span class="string">"build_type"</span> : <span class="string">"docker"</span>,</span><br><span class="line">    <span class="string">"build_hash"</span> : <span class="string">"3ae9ac9a93c95bd0cdc054951cf95d88e1e18d96"</span>,</span><br><span class="line">    <span class="string">"build_date"</span> : <span class="string">"2019-12-16T22:57:37.835892Z"</span>,</span><br><span class="line">    <span class="string">"build_snapshot"</span> : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">"lucene_version"</span> : <span class="string">"8.3.0"</span>,</span><br><span class="line">    <span class="string">"minimum_wire_compatibility_version"</span> : <span class="string">"6.8.0"</span>,</span><br><span class="line">    <span class="string">"minimum_index_compatibility_version"</span> : <span class="string">"6.0.0-beta1"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"tagline"</span> : <span class="string">"You Know, for Search"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="helm-å®‰è£…ELKå‚è€ƒ"><a href="#helm-å®‰è£…ELKå‚è€ƒ" class="headerlink" title="helm å®‰è£…ELKå‚è€ƒ"></a>helm å®‰è£…ELKå‚è€ƒ</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># helm repo add stable https://kubernetes-charts.storage.googleapis.com</span></span><br><span class="line"><span class="string">helm</span> <span class="string">repo</span> <span class="string">add</span> <span class="string">elastic</span> <span class="string">https://helm.elastic.co</span></span><br><span class="line"><span class="comment"># è·å–helm chart</span></span><br><span class="line"><span class="string">helm</span> <span class="string">fetch</span> <span class="string">stable/elasticsearch</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹ååº”ç”¨</span></span><br><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">elastic/elasticsearch</span> <span class="string">-n</span> <span class="string">elk-es</span> <span class="string">--namespace</span> <span class="string">elk</span> <span class="string">-f</span> <span class="string">elasticsearch/values.yaml</span></span><br></pre></td></tr></table></figure>
<p>å¼ºåˆ¶åˆ é™¤podï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl delete pod -n elk kibana-75cd5fcbc5-jxn44  --force --grace-period=0</span><br></pre></td></tr></table></figure>
<p>ADè®¤è¯ï¼š<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.x/active-directory-realm.html#ad-realm-configuration" rel="external nofollow noopener noreferrer" target="_blank">https://www.elastic.co/guide/en/elasticsearch/reference/7.x/active-directory-realm.html#ad-realm-configuration</a></p>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>ELKæ•´æ”¹éƒ¨ç½²</title>
    <url>/log-analysis/k8s-elk-improvement/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ä¸ºäº†å°†æµ‹è¯•ç¯å¢ƒã€ä»¿çœŸç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„ELKåˆå¹¶ä¸ºä¸€ä¸ªéƒ¨ç½²åˆ°K8sä¸­ç®¡ç†ï¼Œä½œä¸€äº›æµ‹è¯•éªŒè¯ï¼Œå¹¶å°è¯•é›†æˆSTSå•ç‚¹ç™»å½•ã€‚</p>
</blockquote>
<h2 id="æµ‹è¯•NFSå¯ç”¨æ€§"><a href="#æµ‹è¯•NFSå¯ç”¨æ€§" class="headerlink" title="æµ‹è¯•NFSå¯ç”¨æ€§"></a>æµ‹è¯•NFSå¯ç”¨æ€§</h2><blockquote>
<p> æµ‹è¯•åº”ç”¨ä½¿ç”¨çš„MySQLæ•°æ®ç›®å½•æ˜¯é€šè¿‡NFSæŒ‚è½½çš„ï¼Œæ¯GETè¯·æ±‚ä¸€æ¬¡ <code>http://192.168.100.157:9000/visit/add/</code> ä¼šæ–°å¢ä¸€æ¡è®°å½•åˆ°æ•°æ®åº“ã€‚é€šè¿‡è„šæœ¬æ¯0.01ç§’è¯·æ±‚ä¸€æ¬¡ï¼Œå…±è¯·æ±‚10000æ¬¡çš„è¿‡ç¨‹ä¸­ï¼šå½“äººä¸ºåœæ­¢NFSæœåŠ¡æ—¶ï¼ŒMySQLæ•°æ®ç›®å½•æŒ‚è½½å¤±æ•ˆï¼Œå¯¼è‡´è¯·æ±‚æ¥å£æ— æ³•è®¿é—®ï¼›é‡æ–°å¼€å¯NFSæœåŠ¡åï¼Œæ¢å¤æ­£å¸¸ï¼Œå¹¶ä¸”æœ€ç»ˆè®°å½•æ€»æ•°ä¸€è‡´ã€‚</p>
</blockquote>
<a id="more"></a>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582856249817.png" alt="1582856249817"></p>
<h3 id="NFSä¾›åº”èŠ‚ç‚¹"><a href="#NFSä¾›åº”èŠ‚ç‚¹" class="headerlink" title="NFSä¾›åº”èŠ‚ç‚¹"></a>NFSä¾›åº”èŠ‚ç‚¹</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 elk]<span class="comment"># cat /etc/exports</span></span><br><span class="line">/testPV *(rw,sync)</span><br><span class="line">/helloPV *(rw,no_root_squash,async)</span><br></pre></td></tr></table></figure>
<h3 id="æµ‹è¯•èŠ‚ç‚¹"><a href="#æµ‹è¯•èŠ‚ç‚¹" class="headerlink" title="æµ‹è¯•èŠ‚ç‚¹"></a>æµ‹è¯•èŠ‚ç‚¹</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@157-xxl-job testPV]<span class="comment"># df -h</span></span><br><span class="line">Filesystem                Size  Used Avail Use% Mounted on</span><br><span class="line">...</span><br><span class="line">192.168.100.150:/helloPV  292G   42G  250G  15% /helloPV</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">'Asia/Shanghai'</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">qwerasdf</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">testpv</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">['mysqld',</span> <span class="string">'--character-set-server=utf8'</span><span class="string">]</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"/helloPV/db:/var/lib/mysql"</span></span><br></pre></td></tr></table></figure>
<h3 id="æŸ¥çœ‹æ•°æ®åº“"><a href="#æŸ¥çœ‹æ•°æ®åº“" class="headerlink" title="æŸ¥çœ‹æ•°æ®åº“"></a>æŸ¥çœ‹æ•°æ®åº“</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mysql&gt; select count(id) from visit_record;</span><br><span class="line">+-----------+</span><br><span class="line">| count(id) |</span><br><span class="line">+-----------+</span><br><span class="line">|      9999 |</span><br><span class="line">+-----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from visit_record <span class="built_in">limit</span> 1;</span><br><span class="line">+----+----------------------+----------------------------+</span><br><span class="line">| id | ip_addr              | visit_date                 |</span><br><span class="line">+----+----------------------+----------------------------+</span><br><span class="line">|  1 | 192.168.100.157:9000 | 2020-02-28 01:13:38.370327 |</span><br><span class="line">+----+----------------------+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from visit_record order by id desc <span class="built_in">limit</span> 1;</span><br><span class="line">+------+----------------------+----------------------------+</span><br><span class="line">| id   | ip_addr              | visit_date                 |</span><br><span class="line">+------+----------------------+----------------------------+</span><br><span class="line">| 9999 | 192.168.100.157:9000 | 2020-02-28 01:18:10.755606 |</span><br><span class="line">+------+----------------------+----------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure>
<h2 id="PVæ•°æ®æ¢å¤éªŒè¯"><a href="#PVæ•°æ®æ¢å¤éªŒè¯" class="headerlink" title="PVæ•°æ®æ¢å¤éªŒè¯"></a>PVæ•°æ®æ¢å¤éªŒè¯</h2><h3 id="æ–‡æ¡£å†™å…¥ã€æ›´æ–°"><a href="#æ–‡æ¡£å†™å…¥ã€æ›´æ–°" class="headerlink" title="æ–‡æ¡£å†™å…¥ã€æ›´æ–°"></a>æ–‡æ¡£å†™å…¥ã€æ›´æ–°</h3><ul>
<li>åˆå§‹å†™å…¥2ä¸ªæ–‡æ¡£</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/1?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:50:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/2?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:51:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green2"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æ›´æ–°æ–‡æ¡£</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/1?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:54:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green3"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/2?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:54:02",</span></span><br><span class="line"><span class="string">  "name": "Jim Green4"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582772220081.png" alt="1582772220081"></p>
<ul>
<li>å¢åŠ 2ä¸ªæ–‡æ¡£</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/3?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:58:00",</span></span><br><span class="line"><span class="string">  "name": "Jim Green5"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl -X PUT <span class="string">"http://es.staging.keep.com/customer/_doc/4?pretty"</span> -H <span class="string">'Content-Type: application/json'</span> -u elastic:elastic -d <span class="string">'</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="string">  "datetime": "2020-02-27 10:58:02",</span></span><br><span class="line"><span class="string">  "name": "Jim Green6"</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582772345348.png" alt="1582772345348"></p>
<h3 id="ä¿®æ”¹è¯·æ±‚çš„å®¹é‡"><a href="#ä¿®æ”¹è¯·æ±‚çš„å®¹é‡" class="headerlink" title="ä¿®æ”¹è¯·æ±‚çš„å®¹é‡"></a>ä¿®æ”¹è¯·æ±‚çš„å®¹é‡</h3><p>NFS StorageClass Providerè‡ªåŠ¨ä¸ºESåˆ›å»ºçš„PVç›®å½•ä¸ºï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 ~]<span class="comment"># ls /testPV/</span></span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<h4 id="ä¸åˆ PVä»…ä¿®æ”¹ç¼–æ’çš„å®¹é‡éœ€æ±‚"><a href="#ä¸åˆ PVä»…ä¿®æ”¹ç¼–æ’çš„å®¹é‡éœ€æ±‚" class="headerlink" title="ä¸åˆ PVä»…ä¿®æ”¹ç¼–æ’çš„å®¹é‡éœ€æ±‚"></a>ä¸åˆ PVä»…ä¿®æ”¹ç¼–æ’çš„å®¹é‡éœ€æ±‚</h4><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åŸå…ˆ20Gi</span></span><br><span class="line"><span class="attr">volumeClaimTemplates:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">es-data</span></span><br><span class="line">  <span class="attr">spec:</span></span><br><span class="line">    <span class="attr">storageClassName:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">    <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">storage:</span> <span class="string">40Gi</span></span><br></pre></td></tr></table></figure>
<p>é‡æ–°éƒ¨ç½²ES</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl apply -f es-ss.yml </span></span><br><span class="line">The StatefulSet <span class="string">"elasticsearch"</span> is invalid: spec: Forbidden: updates to statefulset spec <span class="keyword">for</span> fields other than <span class="string">'replicas'</span>, <span class="string">'template'</span>, and <span class="string">'updateStrategy'</span> are forbidden</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæ˜¯statefulset.appsï¼Œæç¤ºä¸èƒ½ç›´æ¥applyï¼Œå…ˆdeleteå†apply</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl delete -f es-ss.yml </span></span><br><span class="line">statefulset.apps <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl apply -f es-ss.yml </span></span><br><span class="line">statefulset.apps/elasticsearch created</span><br></pre></td></tr></table></figure>
<p>PVç›®å½•æœªå˜åŒ–ï¼Œå¹¶ä¸”ä»KibanaæŸ¥çœ‹æ•°æ®è¿˜æ˜¯å®¹é‡å˜æ›´å‰çš„æ ·å­</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582773231870.png" alt="1582773231870"></p>
<p>è¯´æ˜ä¸åˆ é™¤å·²åˆ›å»ºçš„PVæƒ…å†µä¸‹ï¼Œä¿®æ”¹è¯·æ±‚PVå®¹é‡å€¼<code>resources.requests.storage</code>ï¼Œä¸å½±å“å·²æœ‰æ•°æ®ã€‚</p>
<h4 id="åˆ PVé‡å»ºES"><a href="#åˆ PVé‡å»ºES" class="headerlink" title="åˆ PVé‡å»ºES"></a>åˆ PVé‡å»ºES</h4><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># sh run-es.sh down</span></span><br><span class="line">ingress.extensions <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">service <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">statefulset.apps <span class="string">"elasticsearch"</span> deleted</span><br><span class="line">configmap <span class="string">"es-config"</span> deleted</span><br><span class="line">secret <span class="string">"rp-client-secret"</span> deleted</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl delete pvc -n yhelk es-data-elasticsearch-0</span></span><br><span class="line">persistentvolumeclaim <span class="string">"es-data-elasticsearch-0"</span> deleted</span><br><span class="line"></span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># sh run-es.sh</span></span><br><span class="line">namespace/yhelk unchanged</span><br><span class="line">secret/rp-client-secret created</span><br><span class="line">configmap/es-config created</span><br><span class="line">statefulset.apps/elasticsearch created</span><br><span class="line">service/elasticsearch created</span><br><span class="line">ingress.extensions/elasticsearch created</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582774172498.png" alt="1582774172498"></p>
<p>åˆ é™¤PVåï¼ŒPVç›®å½•è¢«å½’æ¡£</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<p>é‡å»ºåï¼Œç”Ÿæˆäº†æ–°çš„PVç›®å½•</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<p>æ˜¾ç„¶ï¼Œä¹‹å‰çš„ä¿å­˜çš„æ–‡æ¡£ä¸åœ¨æ–°ç›®å½•ä¸­ï¼ŒæŸ¥çœ‹Kibanaä¹Ÿæ˜¾ç¤ºæ²¡æœ‰ä»»ä½•ç´¢å¼•ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582774922290.png" alt="1582774922290"></p>
<p>å°è¯•æ¢å¤æ—§æ•°æ®å¦‚ä¸‹ï¼š</p>
<p>é€šè¿‡ç§»åŠ¨å½’æ¡£çš„PVç›®å½•æ›¿æ¢ç°åœ¨ä½¿ç”¨çš„PVç›®å½•ï¼Œå¹¶åˆ é™¤esçš„podä»¥ä½¿å…¶è¢«é‡æ–°è°ƒåº¦ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 4cp]<span class="comment"># mv /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1/ /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1.old</span></span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1</span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1.old</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># mv /testPV/archived-yhelk-es-data-elasticsearch-0-pvc-94de2142-590a-11ea-ac5d-005056a941c1/ /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1</span></span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># ls /testPV/</span></span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1</span><br><span class="line">yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1.old</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl get pod -n yhelk</span></span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">elasticsearch-0           1/1     Running   0          7m17s</span><br><span class="line">kibana-6564b7c688-bvmf4   1/1     Running   0          61m</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl delete pod -n yhelk elasticsearch-0 </span></span><br><span class="line">pod <span class="string">"elasticsearch-0"</span> deleted</span><br><span class="line">[root@zabbix02 4cp]<span class="comment"># kubectl get pod -n yhelk</span></span><br><span class="line">NAME                      READY   STATUS    RESTARTS   AGE</span><br><span class="line">elasticsearch-0           1/1     Running   0          16s</span><br><span class="line">kibana-6564b7c688-bvmf4   1/1     Running   0          62m</span><br></pre></td></tr></table></figure>
<p>å¾…kibanaé‡æ–°è¿æ¥esåï¼Œæ˜¾ç¤ºæ—§æ–‡æ¡£å·²æ¢å¤ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582775406309.png" alt="1582775406309"></p>
<hr>
<h3 id="æ•°æ®è¿ç§»åˆ°æ–°çš„é›†ç¾¤"><a href="#æ•°æ®è¿ç§»åˆ°æ–°çš„é›†ç¾¤" class="headerlink" title="æ•°æ®è¿ç§»åˆ°æ–°çš„é›†ç¾¤"></a>æ•°æ®è¿ç§»åˆ°æ–°çš„é›†ç¾¤</h3><h4 id="åˆ›å»ºä¸€ä¸ªæ–°ELKç¯å¢ƒ"><a href="#åˆ›å»ºä¸€ä¸ªæ–°ELKç¯å¢ƒ" class="headerlink" title="åˆ›å»ºä¸€ä¸ªæ–°ELKç¯å¢ƒ"></a>åˆ›å»ºä¸€ä¸ªæ–°ELKç¯å¢ƒ</h4><p>åœ¨å¦ä¸€ä¸ªåç§°ç©ºé—´ yhelk2 å†åˆ›å»ºä¸€ä¸ªELKç¯å¢ƒï¼š</p>
<p>å¯¹åº”çš„PVç›®å½•ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582785238406.png" alt="1582785238406"></p>
<h4 id="å¤åˆ¶è¿ç§»æ•°æ®"><a href="#å¤åˆ¶è¿ç§»æ•°æ®" class="headerlink" title="å¤åˆ¶è¿ç§»æ•°æ®"></a>å¤åˆ¶è¿ç§»æ•°æ®</h4><p>å…ˆåˆ é™¤åˆšåˆ›å»ºå‡ºæ¥çš„ESï¼Œä»…ä¿ç•™PVCå’ŒPVã€‚å¦‚æœåˆ é™¤PVCï¼ˆå’ŒPVï¼‰ï¼ŒåŸæ•°æ®ï¼ˆç›®å½•ï¼‰ä¼šè¢«å½’æ¡£ï¼Œé‡æ–°éƒ¨ç½²åä¼šé‡å»ºPVã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582786894380.png" alt="1582786894380"></p>
<p>å†å°†å¯¹åº”yhelkç©ºé—´çš„åŸæœ‰ELKç¯å¢ƒçš„PVç›®å½•å¤åˆ¶ä¸€ä»½æ›¿æ¢æ–°ELKç¯å¢ƒçš„PVç›®å½•</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">mv /testPV/yhelk2-es-data-elasticsearch-0-pvc-a2488669-5929-11ea-ac5d-005056a941c1&#123;,.old&#125;</span><br><span class="line"></span><br><span class="line">cp -rp /testPV/yhelk-es-data-elasticsearch-0-pvc-cb8ea87c-5912-11ea-ac5d-005056a941c1  /testPV/yhelk2-es-data-elasticsearch-0-pvc-a2488669-5929-11ea-ac5d-005056a941c1</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582786693455.png" alt="1582786693455"></p>
<p>é‡å»ºyhelk2ç©ºé—´çš„ESï¼Œå› å¯¹åº”çš„PVç›®å½•åç§°ä¸å˜ï¼Œå°†ä¼šåŠ è½½è¯¥ç›®å½•ä¸­çš„æ•°æ®ã€‚åœ¨Kibanaä¸­å¯ä»¥çœ‹åˆ°ï¼Œæ–°ã€æ—§ç¯å¢ƒELKä¸­çš„ç´¢å¼•ã€æ–‡æ¡£æ˜¯ç›¸åŒçš„ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582787118597.png" alt="1582787118597"></p>
<blockquote>
<p>è¿™è¯´æ˜ä¸¤ä¸ªä¸åŒåç§°ç©ºé—´çš„ELKé›†ç¾¤çš„æ•°æ®ï¼Œå¯ä»¥é€šè¿‡å¤åˆ¶æ•°æ®ç›®å½•çš„æ–¹å¼ä»ä¸€ä¸ªç¯å¢ƒè¿ç§»åˆ°å¦ä¸€ä¸ªã€‚å¯ä»¥ä½œå‡ºåˆç†æ¨æµ‹ï¼š1. å¦‚æœä¸¤ä¸ªESé›†ç¾¤çš„èŠ‚ç‚¹æ•°ä¸€æ ·ï¼ˆå¯¹åº”çš„PVç›®å½•æ•°ä¸€æ ·ï¼‰ï¼Œæ•°æ®å¯ä»¥é€šè¿‡ç›´æ¥å¤åˆ¶çš„æ–¹å¼è¿ç§»ã€‚2. ESå¯¹ä¾›åº”PVçš„NFSæ–‡ä»¶ç³»ç»Ÿæ˜¯æ— æ„ŸçŸ¥çš„ï¼ŒNFSæ–‡ä»¶ç³»ç»Ÿè‡ªèº«æ‰©å®¹ã€ç¼©å®¹ï¼Œåªè¦æ»¡è¶³podéœ€æ±‚ï¼Œæ•°æ®å°±å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚</p>
</blockquote>
<hr>
<h2 id="ESè´¦å·è®¾ç½®"><a href="#ESè´¦å·è®¾ç½®" class="headerlink" title="ESè´¦å·è®¾ç½®"></a>ESè´¦å·è®¾ç½®</h2><p>å¯ç”¨äº†ADè®¤è¯åï¼Œé™¤äº†å‡ ä¸ªå†…ç½®çš„ç”¨æˆ·å’Œå·²æˆæƒçš„ADè´¦å·å¤–ï¼Œæ–°åˆ›å»ºçš„ç”¨æˆ·ï¼ˆæœªè¢«ADç®¡ç†çš„ï¼‰æ— æ³•ä½¿ç”¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"error"</span> : &#123;</span><br><span class="line">    <span class="string">"root_cause"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">        <span class="string">"reason"</span> : <span class="string">"unable to authenticate user [etms_dev] for REST request [/dev.etms.abc/_doc/1?pretty]"</span>,</span><br><span class="line">        <span class="string">"header"</span> : &#123;</span><br><span class="line">          <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"security\" charset=\"UTF-8\""</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"type"</span> : <span class="string">"security_exception"</span>,</span><br><span class="line">    <span class="string">"reason"</span> : <span class="string">"unable to authenticate user [etms_dev] for REST request [/dev.etms.abc/_doc/1?pretty]"</span>,</span><br><span class="line">    <span class="string">"header"</span> : &#123;</span><br><span class="line">      <span class="string">"WWW-Authenticate"</span> : <span class="string">"Basic realm=\"security\" charset=\"UTF-8\""</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"status"</span> : 401</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç”¨æˆ·ç»„æƒé™è®¾ç½®"><a href="#ç”¨æˆ·ç»„æƒé™è®¾ç½®" class="headerlink" title="ç”¨æˆ·ç»„æƒé™è®¾ç½®"></a>ç”¨æˆ·ç»„æƒé™è®¾ç½®</h3><p>åªèƒ½è®¾ç½®ä¸¤ç±»æƒé™</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT /_security/role_mapping/admins</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"roles"</span> : [ <span class="string">"superuser"</span> ],</span><br><span class="line">  <span class="string">"rules"</span> : &#123;</span><br><span class="line">    <span class="string">"field"</span> : &#123;</span><br><span class="line">      <span class="string">"groups"</span> : <span class="string">"CN=elk_admin,OU=Elasticsearch,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT  /_security/role_mapping/basic_users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"enabled"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"roles"</span> : [</span><br><span class="line">      <span class="string">"kibana_user"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"rules"</span> : &#123;</span><br><span class="line">      <span class="string">"any"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field"</span> : &#123;</span><br><span class="line">            <span class="string">"groups"</span> : <span class="string">"CN=elk_user,OU=Elasticsearch,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è®¾ç½®æŒ‡å®šç”¨æˆ·çš„æƒé™"><a href="#è®¾ç½®æŒ‡å®šç”¨æˆ·çš„æƒé™" class="headerlink" title="è®¾ç½®æŒ‡å®šç”¨æˆ·çš„æƒé™"></a>è®¾ç½®æŒ‡å®šç”¨æˆ·çš„æƒé™</h3><blockquote>
<p>åˆšå¼€å§‹æ‰€æœ‰ç”¨æˆ·è¦ä¹ˆå±äºelk_adminç»„ï¼Œè¦ä¹ˆå±äºelk_userç»„ï¼Œå¹¶å…·æœ‰å¯¹åº”çš„ä¸¤ç±»æƒé™ã€‚å¦‚æœè¦è¿›ä¸€æ­¥å•ç‹¬è®¾ç½®ç»„å†…æŸä¸ªç”¨æˆ·çš„æƒé™ï¼Œå¯æŒ‰ä»¥ä¸‹æ­¥éª¤è¿›è¡Œï¼š</p>
</blockquote>
<ul>
<li>å…ˆæŒ‰ä¼ ç»Ÿæ–¹æ³•æ·»åŠ ä¸€ä¸ªåŒ…å«æ‰€éœ€æƒé™çš„è§’è‰²</li>
<li>åœ¨kibanaæ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªä¸ADè´¦å·åŒåçš„ç”¨æˆ·ï¼Œå¯†ç éšæ„è®¾ç½®ï¼Œå¹¶ä¸åˆšåˆšåˆ›å»ºçš„è§’è‰²ç»‘å®š</li>
<li>ä»¥è¯¥ç”¨æˆ·ååŠç›¸åº”çš„ADå¯†ç ç™»å½•Kibanaå³å¯å‘ç°æƒé™å·²å˜æ›´</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ã€åˆ é™¤adminsçš„role_mapping</span></span><br><span class="line">GET /_security/role_mapping/admins</span><br><span class="line">DELETE /_security/role_mapping/admins</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ã€åˆ é™¤basic_usersçš„role_mapping</span></span><br><span class="line">GET /_security/role_mapping/basic_users</span><br><span class="line">DELETE /_security/role_mapping/basic_users</span><br><span class="line"></span><br><span class="line">PUT /_security/role_mapping/admins</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"roles"</span> : [ <span class="string">"superuser"</span> ],</span><br><span class="line">  <span class="string">"rules"</span> : &#123;</span><br><span class="line">    <span class="string">"field"</span> : &#123;</span><br><span class="line">      <span class="string">"groups"</span> : <span class="string">"CN=elk_admin,OU=Elasticsearch,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"enabled"</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PUT  /_security/role_mapping/basic_users</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"enabled"</span> : <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"roles"</span> : [</span><br><span class="line">      <span class="string">"kibana_user"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"rules"</span> : &#123;</span><br><span class="line">      <span class="string">"any"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"field"</span> : &#123;</span><br><span class="line">            <span class="string">"groups"</span> : <span class="string">"CN=elk_user,OU=Elasticsearch,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç´¢å¼•åç§°è§„èŒƒ"><a href="#ç´¢å¼•åç§°è§„èŒƒ" class="headerlink" title="ç´¢å¼•åç§°è§„èŒƒ"></a>ç´¢å¼•åç§°è§„èŒƒ</h3><p><strong>å»ºè®®æŒ‰</strong></p>
<p><code>&lt;ç¯å¢ƒåç§°&gt;.&lt;ç³»ç»Ÿ&gt;[.&lt;åº”ç”¨&gt;][.&lt;æ—¥å¿—ç±»å‹&gt;]_&lt;YYYY.MM.dd&gt;</code></p>
<p>çš„å½¢å¼å–ç´¢å¼•åç§°ï¼Œä¾‹å¦‚ï¼š</p>
<p><code>dev.etms.webhost.error-log_2020.02.28</code></p>
<p>æ®ä»¥ä¸Šï¼Œå¯ä»¥é’ˆå¯¹ é¡¹ç›®ç»„åŠä¸ªäººè®¾ç½®ELKæƒé™ã€‚æ¯”å¦‚è®¾ç½®ETMSç»„æˆå‘˜devç¯å¢ƒçš„æƒé™ï¼š</p>
<ol>
<li>åˆ›å»ºè§’è‰²<code>role_etms_dev</code></li>
</ol>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">PUT /_security/role/role_etms_dev</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"cluster"</span> : [ ],</span><br><span class="line">    <span class="string">"indices"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"names"</span> : [</span><br><span class="line">          <span class="string">"dev.etms.*"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"privileges"</span> : [</span><br><span class="line">          <span class="string">"all"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"field_security"</span> : &#123;</span><br><span class="line">          <span class="string">"grant"</span> : [</span><br><span class="line">            <span class="string">"*"</span></span><br><span class="line">          ],</span><br><span class="line">          <span class="string">"except"</span> : [ ]</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"allow_restricted_indices"</span> : <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"applications"</span> : [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">"application"</span> : <span class="string">"kibana-.kibana"</span>,</span><br><span class="line">        <span class="string">"privileges"</span> : [</span><br><span class="line">          <span class="string">"feature_discover.all"</span>,</span><br><span class="line">          <span class="string">"feature_visualize.all"</span>,</span><br><span class="line">          <span class="string">"feature_dashboard.all"</span>,</span><br><span class="line">          <span class="string">"feature_dev_tools.all"</span>,</span><br><span class="line">          <span class="string">"feature_indexPatterns.all"</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"resources"</span> : [</span><br><span class="line">          <span class="string">"space:default"</span></span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"run_as"</span> : [ ],</span><br><span class="line">    <span class="string">"metadata"</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">"transient_metadata"</span> : &#123;</span><br><span class="line">      <span class="string">"enabled"</span> : <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>åˆ›å»ºetmsç»„æˆå‘˜ADè´¦å·åŒåçš„ESè´¦å·å¹¶ç»‘å®šè§’è‰²</li>
</ol>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582881482944.png" alt="1582881482944"></p>
<ol start="3">
<li>ç™»å½•æŸ¥çœ‹æ•ˆæœ</li>
</ol>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-elk-improvement.assets/1582881659083.png" alt="1582881659083"></p>
<hr>
<h2 id="ELKé›†æˆSTSç™»å½•è°ƒè¯•è¿‡ç¨‹è®°å½•"><a href="#ELKé›†æˆSTSç™»å½•è°ƒè¯•è¿‡ç¨‹è®°å½•" class="headerlink" title="ELKé›†æˆSTSç™»å½•è°ƒè¯•è¿‡ç¨‹è®°å½•"></a>ELKé›†æˆSTSç™»å½•è°ƒè¯•è¿‡ç¨‹è®°å½•</h2><blockquote>
<p>å› ä¸ºESä¸æ”¯æŒåœ¨é…ç½®æ–‡ä»¶ä¸­ç›´æ¥é…ç½®ï¼šrp.client_secret ï¼Œä»¥åŠå…¶å®ƒä¸€äº›é›†æˆOpenIDçš„å‚æ•°è®¾ç½®ä¸æ¸…æ™°ï¼Œä½œäº†å¦‚ä¸‹å¤§é‡å°è¯•ï¼š</p>
</blockquote>
<h3 id="ä½¿ç”¨é…ç½®å­—å…¸çš„æ–¹å¼"><a href="#ä½¿ç”¨é…ç½®å­—å…¸çš„æ–¹å¼" class="headerlink" title="ä½¿ç”¨é…ç½®å­—å…¸çš„æ–¹å¼"></a>ä½¿ç”¨é…ç½®å­—å…¸çš„æ–¹å¼</h3><p>OIDC realmé…ç½®åˆ°es-cm.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment">#role_mapping.yml: |-</span></span><br><span class="line">  <span class="comment">#  kibana_user:</span></span><br><span class="line">  <span class="comment">#    - "CN=elk_user,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line">  <span class="comment">#    - "CN=å ¡å’æœº,CN=Users,DC=keep,DC=com"</span></span><br><span class="line">  <span class="comment">#  superuser:</span></span><br><span class="line">  <span class="comment">#    - "CN=elk_admin,OU=ç³»ç»Ÿå¸å·,DC=keep,DC=com"</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">elasticsearch.yml:</span> <span class="string">|-</span></span><br><span class="line">    <span class="attr">cluster.name:</span> <span class="string">"docker-cluster"</span></span><br><span class="line">    <span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    <span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line">    <span class="attr">xpack.security.authc.realms.active_directory:</span></span><br><span class="line">      <span class="attr">my_ad:</span></span><br><span class="line">        <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">        <span class="attr">domain_name:</span> <span class="string">keep.com</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">ldap://192.168.100.120:389,</span> <span class="string">ldap://192.168.100.129:389</span></span><br><span class="line">        <span class="attr">bind_dn:</span> <span class="string">xxx@keep.com</span></span><br><span class="line">        <span class="attr">bind_password:</span> <span class="string">******</span></span><br><span class="line">        <span class="attr">load_balance:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">"round_robin"</span></span><br><span class="line">        <span class="attr">user_search:</span></span><br><span class="line">          <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">          <span class="attr">filter:</span> <span class="string">"(&amp;(objectClass=user)(sAMAccountName=&#123;0&#125;))"</span></span><br><span class="line">        <span class="attr">group_search:</span></span><br><span class="line">          <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">        <span class="comment">#files:</span></span><br><span class="line">        <span class="comment">#  role_mapping: "/usr/share/elasticsearch/config/role_mapping.yml"</span></span><br><span class="line">        <span class="comment">#unmapped_groups_as_roles: true</span></span><br><span class="line">    <span class="attr">xpack.security.authc.realms.oidc.oidc1:</span></span><br><span class="line">      <span class="attr">order:</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">rp.client_id:</span> <span class="string">"kibana"</span></span><br><span class="line">      <span class="comment"># rp.client_secret: "secret"  # rp.client_secret ä¸èƒ½è¿™æ ·å†™åœ¨é…ç½®æ–‡ä»¶ï¼Œæœ‰ä¸‹é¢æŠ¥é”™ä¿¡æ¯</span></span><br><span class="line">      <span class="attr">rp.response_type:</span> <span class="string">code</span></span><br><span class="line">      <span class="attr">rp.requested_scopes:</span> <span class="string">[openid,profile]</span></span><br><span class="line">      <span class="attr">rp.redirect_uri:</span> <span class="string">"http://kibana.staging.keep.com/api/security/v1/oidc"</span></span><br><span class="line">      <span class="attr">rp.post_logout_redirect_uri:</span> <span class="string">"http://kibana.staging.keep.com/logged_out"</span></span><br><span class="line">      <span class="attr">op.issuer:</span> <span class="string">"https://sts.keep.cn"</span></span><br><span class="line">      <span class="attr">op.authorization_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/authorize"</span></span><br><span class="line">      <span class="attr">op.token_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/token"</span></span><br><span class="line">      <span class="comment">#op.userinfo_endpoint: "http://sts.staging.keep.com/connect/userinfo"</span></span><br><span class="line">      <span class="comment">#op.end_session_endpoint: "http://sts.staging.keep.com/connect/endsession"</span></span><br><span class="line">      <span class="attr">claims.principal:</span> <span class="string">email_verified</span></span><br><span class="line">      <span class="attr">claim_patterns.principal:</span> <span class="string">"^([^@]+)@keep\\.com$"</span></span><br></pre></td></tr></table></figure>
<p>kb-cm.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">xpack.security.authc.providers:</span> <span class="string">[oidc,</span> <span class="string">basic]</span></span><br><span class="line"><span class="attr">xpack.security.authc.oidc.realm:</span> <span class="string">"oidc1"</span></span><br><span class="line"><span class="attr">server.xsrf.whitelist:</span> <span class="string">[/api/security/v1/oidc,</span> <span class="string">/logged_out]</span></span><br></pre></td></tr></table></figure>
<p>é”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&quot;Caused by: java.lang.IllegalArgumentException: unknown setting [xpack.security.authc.realms.oidc.oidc1.op.end_session_endpoint] please check that any required plugins are installed, or check the breaking changes documentation for removed settings&quot;,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">[xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is a secure setting and must be stored inside the Elasticsearch keystore, but was found inside elasticsearch.yml&quot;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>é‡åˆ°çš„å¼‚å¸¸ä¸»è¦æœ‰ï¼š</p>
<ul>
<li><p>[xpack.security.authc.realms.oidc.oidc1.op.end_session_endpoint] please check that any required plugins are installed, or check the breaking changes documentation for removed settingsâ€</p>
</li>
<li><p>Setting [xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is a secure setting and must be stored inside the Elasticsearch keystore, but was found inside elasticsearch.yml</p>
</li>
<li><p>java.lang.IllegalStateException: security initialization failedâ€</p>
<p>The configuration setting [xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is requiredâ€</p>
</li>
</ul>
<h3 id="ä½¿ç”¨ç¯å¢ƒå˜é‡-ä¿å¯†å­—å…¸çš„æ–¹å¼"><a href="#ä½¿ç”¨ç¯å¢ƒå˜é‡-ä¿å¯†å­—å…¸çš„æ–¹å¼" class="headerlink" title="ä½¿ç”¨ç¯å¢ƒå˜é‡+ä¿å¯†å­—å…¸çš„æ–¹å¼"></a>ä½¿ç”¨ç¯å¢ƒå˜é‡+ä¿å¯†å­—å…¸çš„æ–¹å¼</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rp-client-secret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">xpack.security.authc.realms.oidc.oidc1.rp.client_secret:</span> <span class="string">c2VjcmV0Cg==</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"xpack.security.authc.realms.oidc.oidc1.rp.client_secret"</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">secretKeyRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">rp-client-secret</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret</span></span><br></pre></td></tr></table></figure>
<p>æŠ¥é”™åŒä¸Šï¼Œå¤±è´¥</p>
<h3 id="initContainersæ–¹å¼"><a href="#initContainersæ–¹å¼" class="headerlink" title="initContainersæ–¹å¼"></a>initContainersæ–¹å¼</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">lzzeng/es-xpack:7.5.1</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">inites</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">|</span>                </span><br><span class="line">        <span class="string">echo</span> <span class="string">-e</span> <span class="string">"y\nsecret"</span> <span class="string">|</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">add</span> <span class="string">--stdin</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret</span></span><br><span class="line">        <span class="string">exit</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="attr">subPath:</span> <span class="string">elasticsearch.keystore</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/config/elasticsearch.keystore</span></span><br></pre></td></tr></table></figure>
<p>ä¼å›¾é€šè¿‡initContainerä¸eså…±äº«é…ç½®çš„æ–¹å¼è®¾ç½®rp.client_secretï¼ŒinitContaineræ­£å¸¸åˆå§‹åŒ–åï¼Œes podå¼‚å¸¸é€€å‡ºï¼Œä¸»è¦é”™è¯¯åŸå› å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@zabbix02 4cp-err]<span class="comment"># kubectl logs -f -n yhelk elasticsearch-0 </span></span><br><span class="line">Exception <span class="keyword">in</span> thread <span class="string">"main"</span> java.lang.IllegalStateException: unable to <span class="built_in">read</span> from standard input; is standard input open and a tty attached?</span><br><span class="line">	at org.elasticsearch.cli.Terminal<span class="variable">$SystemTerminal</span>.readText(Terminal.java:207)</span><br><span class="line">	at org.elasticsearch.cli.Terminal.promptYesNo(Terminal.java:140)</span><br><span class="line">	at org.elasticsearch.common.settings.CreateKeyStoreCommand.execute(CreateKeyStoreCommand.java:43)</span><br><span class="line">	at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:125)</span><br><span class="line">	at org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:77)</span><br><span class="line">	at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:125)</span><br><span class="line">	at org.elasticsearch.cli.Command.main(Command.java:90)</span><br><span class="line">	at org.elasticsearch.common.settings.KeyStoreCli.main(KeyStoreCli.java:41)</span><br></pre></td></tr></table></figure>
<p>å¤±è´¥</p>
<h3 id="ç›´æ¥ä¿®æ”¹esé•œåƒçš„æ–¹å¼"><a href="#ç›´æ¥ä¿®æ”¹esé•œåƒçš„æ–¹å¼" class="headerlink" title="ç›´æ¥ä¿®æ”¹esé•œåƒçš„æ–¹å¼"></a>ç›´æ¥ä¿®æ”¹esé•œåƒçš„æ–¹å¼</h3><p>ç›´æ¥ä¿®æ”¹esé•œåƒï¼Œåœ¨é•œåƒä¸­ç”Ÿæˆelasticsearch.keystoreï¼Œå¹¶å®Œæˆå…¶å®ƒé…ç½®ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">lzzeng/es-xpack:7.5.1</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENV</span> <span class="string">RP_CLIENT_SECRET</span> <span class="string">secret</span></span><br><span class="line"></span><br><span class="line"><span class="string">ADD</span> <span class="string">elasticsearch.yml</span> <span class="string">/usr/share/elasticsearch/config/</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">-e</span> <span class="string">"y\n$&#123;RP_CLIENT_SECRET&#125;"</span> <span class="string">|</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">add</span> <span class="string">--stdin</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret;</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">list</span> <span class="string">&gt;</span> <span class="string">/opt/elasticsearch.keystore</span></span><br></pre></td></tr></table></figure>
<p>elasticsearch.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">cluster.name:</span> <span class="string">"docker-cluster"</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"><span class="attr">discovery.zen.minimum_master_nodes:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">discovery.type:</span> <span class="string">single-node</span></span><br><span class="line"><span class="attr">xpack.security.authc.realms.active_directory:</span></span><br><span class="line">  <span class="attr">my_ad:</span></span><br><span class="line">    <span class="attr">order:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">domain_name:</span> <span class="string">keep.com</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">ldap://192.168.100.120:389,</span> <span class="string">ldap://192.168.100.129:389</span></span><br><span class="line">    <span class="attr">bind_dn:</span> <span class="string">xxx@keep.com</span></span><br><span class="line">    <span class="attr">bind_password:</span> <span class="string">xxxxxx</span></span><br><span class="line">    <span class="attr">load_balance:</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">"round_robin"</span></span><br><span class="line">    <span class="attr">user_search:</span></span><br><span class="line">      <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">      <span class="attr">filter:</span> <span class="string">"(&amp;(objectClass=user)(sAMAccountName=&#123;0&#125;))"</span></span><br><span class="line">    <span class="attr">group_search:</span></span><br><span class="line">      <span class="attr">base_dn:</span> <span class="string">"dc=keep,dc=com"</span></span><br><span class="line">    <span class="comment">#files:</span></span><br><span class="line">    <span class="comment">#  role_mapping: "/usr/share/elasticsearch/config/role_mapping.yml"</span></span><br><span class="line">    <span class="comment">#unmapped_groups_as_roles: true</span></span><br><span class="line"><span class="attr">xpack.security.authc.realms.oidc.oidc1:</span></span><br><span class="line">  <span class="attr">order:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">rp.client_id:</span> <span class="string">"kibana"</span></span><br><span class="line">  <span class="attr">rp.response_type:</span> <span class="string">code</span></span><br><span class="line">  <span class="attr">rp.requested_scopes:</span> <span class="string">[openid,</span> <span class="string">profile]</span></span><br><span class="line">  <span class="attr">rp.redirect_uri:</span> <span class="string">"http://kibana.staging.keep.com/api/security/v1/oidc"</span></span><br><span class="line">  <span class="attr">op.issuer:</span> <span class="string">"https://sts.keep.cn"</span></span><br><span class="line">  <span class="attr">op.authorization_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/authorize"</span></span><br><span class="line">  <span class="attr">op.token_endpoint:</span> <span class="string">"http://sts.staging.keep.com/connect/token"</span></span><br><span class="line">  <span class="attr">claims.principal:</span> <span class="string">email_verified</span></span><br><span class="line">  <span class="attr">claim_patterns.principal:</span> <span class="string">"^([^@]+)@keep\\.com$"</span></span><br></pre></td></tr></table></figure>
<p>é‡æ–°éƒ¨ç½²ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="string">"Caused by: org.elasticsearch.common.settings.SettingsException: found settings for the realm [oidc1] (with type [oidc]) in the secure settings (elasticsearch.keystore), but this realm does not have any settings in elasticsearch.yml. Please remove these settings from the keystore, or update their names to match one of the realms that are defined in elasticsearch.yml - [xpack.security.authc.realms.oidc.oidc1.rp.client_secret]"</span>,</span><br></pre></td></tr></table></figure>
<p>å¤±è´¥</p>
<h3 id="postStartæ–¹å¼"><a href="#postStartæ–¹å¼" class="headerlink" title="postStartæ–¹å¼"></a>postStartæ–¹å¼</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span></span><br><span class="line">    <span class="string">...</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">sh</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">|</span></span><br><span class="line">              <span class="string">rm</span> <span class="string">-f</span> <span class="string">/usr/share/elasticsearch/config/elasticsearch.keystore*</span></span><br><span class="line">              <span class="string">echo</span> <span class="string">-e</span> <span class="string">"y\nsecret"</span> <span class="string">|</span> <span class="string">/usr/share/elasticsearch/bin/elasticsearch-keystore</span> <span class="string">add</span> <span class="string">--stdin</span> <span class="string">xpack.security.authc.realms.oidc.oidc1.rp.client_secret</span></span><br><span class="line">              <span class="string">exit</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>å†åå¤æ ¹æ®é”™è¯¯æç¤ºä¿®æ”¹é…ç½®å­—å…¸ï¼ŒæŠ¥é”™ä¿¡æ¯æœ‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="string">"Caused by: org.elasticsearch.common.settings.SettingsException: The configuration setting [xpack.security.authc.realms.oidc.oidc1.op.jwkset_path] is required"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.require(OpenIdConnectRealm.java:329) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.buildOpenIdConnectProviderConfiguration(OpenIdConnectRealm.java:283) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:105) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.InternalRealms.lambda<span class="variable">$getFactories</span><span class="variable">$7</span>(InternalRealms.java:119) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="string">"Caused by: org.elasticsearch.common.settings.SettingsException: The configuration setting [xpack.security.authc.realms.oidc.oidc1.rp.client_secret] is required"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.buildRelyingPartyConfiguration(OpenIdConnectRealm.java:259) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:104) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.InternalRealms.lambda<span class="variable">$getFactories</span><span class="variable">$7</span>(InternalRealms.java:119) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.Realms.initRealms(Realms.java:218) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.Realms.&lt;init&gt;(Realms.java:72) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: OpenID Connect Realm requires that the token service be enabled (xpack.security.authc.token.enabled)"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:114) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.InternalRealms.lambda<span class="variable">$getFactories</span><span class="variable">$7</span>(InternalRealms.java:119) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;<span class="string">"type"</span>: <span class="string">"server"</span>, <span class="string">"timestamp"</span>: <span class="string">"2020-02-27T01:47:32,863Z"</span>, <span class="string">"level"</span>: <span class="string">"WARN"</span>, <span class="string">"component"</span>: <span class="string">"o.e.b.ElasticsearchUncaughtExceptionHandler"</span>, <span class="string">"cluster.name"</span>: <span class="string">"docker-cluster"</span>, <span class="string">"node.name"</span>: <span class="string">"elasticsearch-0"</span>, <span class="string">"message"</span>: <span class="string">"uncaught exception in thread [main]"</span>, </span><br><span class="line"><span class="string">"stacktrace"</span>: [<span class="string">"org.elasticsearch.bootstrap.StartupException: java.lang.IllegalStateException: security initialization failed"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:163) ~[elasticsearch-7.5.1.jar:7.5.1]"</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: Unable to create a IDTokenValidator instance"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectAuthenticator.createIdTokenValidator(OpenIdConnectAuthenticator.java:619) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectAuthenticator.&lt;init&gt;(OpenIdConnectAuthenticator.java:143) ~[?:?]"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectRealm.&lt;init&gt;(OpenIdConnectRealm.java:116) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: security initialization failed"</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">"Caused by: java.lang.IllegalStateException: Unable to create a IDTokenValidator instance"</span>,</span><br><span class="line"><span class="string">"at org.elasticsearch.xpack.security.authc.oidc.OpenIdConnectAuthenticator.createIdTokenValidator(OpenIdConnectAuthenticator.java:619) ~[?:?]"</span>,</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="string">"Caused by: java.nio.file.NoSuchFileException: /usr/share/elasticsearch/config/oidc/jwkset.json"</span>,</span><br><span class="line"><span class="string">"at sun.nio.fs.UnixException.translateToIOException(UnixException.java:92) ~[?:?]"</span>,</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>op.jwkset_path</strong></p>
<p>The path to a file or a URL containing a JSON Web Key Set with the key material that the OpenID Connect Provider uses for signing tokens and claims responses.</p>
</blockquote>
<p><strong>å½“å‰é”™è¯¯åŸå› ï¼šç¼ºå°‘JSON Webå¯†é’¥é›†çš„æ–‡ä»¶æˆ–URLï¼Œéœ€ç”±STSæä¾› op.jwkset_path ä¿¡æ¯ï¼Œä»¥è¿›ä¸€æ­¥å°è¯•ã€‚</strong></p>
]]></content>
      <categories>
        <category>ELK</category>
      </categories>
      <tags>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>Python Basic 01</title>
    <url>/python/python-basic-map-list-dict-set/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>åˆ—è¡¨å’Œå­—å…¸ç±»å‹ â€”â€” è¿™å¯èƒ½æ˜¯åœ¨Pythonç¨‹åºä¸­æ‰€è§åˆ°å¹¶ä½¿ç”¨çš„ä¸¤ç§æœ€å¸¸è§ã€æœ€å…·æœ‰çµæ´»æ€§è€Œä¸”åŠŸèƒ½æœ€ä¸ºå¼ºå¤§çš„é›†åˆä½“ç±»å‹ã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="map-æ˜ å°„"><a href="#map-æ˜ å°„" class="headerlink" title="map æ˜ å°„"></a>map æ˜ å°„</h2><p>map()æ˜¯Pythonå†…ç½®çš„é«˜é˜¶å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªå‡½æ•° f å’Œä¸€ä¸ª listï¼Œå¹¶é€šè¿‡æŠŠå‡½æ•° f ä¾æ¬¡ä½œç”¨åœ¨ list çš„æ¯ä¸ªå…ƒç´ ä¸Šï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„ list å¹¶è¿”å›ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; L = map(str, [1, 2, 4])         <span class="comment"># intè½¬str</span></span><br><span class="line">&gt;&gt;&gt; L2 = list(L)</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">for</span> e <span class="keyword">in</span> L:                     <span class="comment"># L å·²ç»è¿­ä»£è¿‡äº†ï¼Œä¸ä¼šprint</span></span><br><span class="line">...   <span class="built_in">print</span>(e)</span><br><span class="line">... </span><br><span class="line">&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[<span class="string">'1'</span>, <span class="string">'2'</span>, <span class="string">'4'</span>]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L = list(map(ord, <span class="string">'abcd'</span>))              <span class="comment"># ord å­—ç¬¦è½¬ASC-IIç </span></span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[97, 98, 99, 100]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L = list(map(chr, range(97,100)))       <span class="comment"># chr ASC-IIç è½¬å­—ç¬¦</span></span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; list(map(str.upper, [<span class="string">'a'</span>, <span class="string">'B'</span>, <span class="string">'c'</span>]))   <span class="comment"># è½¬å¤§å†™</span></span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'B'</span>, <span class="string">'C'</span>]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: <span class="string">'555'</span>, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [9, 11], <span class="string">'bb'</span>: 44&#125;, (1, 2, 6): <span class="string">'999'</span>&#125;</span><br><span class="line">&gt;&gt;&gt; list(map(str, d2))                      <span class="comment"># æå–keysï¼Œå¹¶è½¬åŒ–ä¸ºsträº†</span></span><br><span class="line">[<span class="string">'b'</span>, <span class="string">'c'</span>, <span class="string">'a'</span>, <span class="string">'(1, 2, 6)'</span>]</span><br></pre></td></tr></table></figure>
<h2 id="list-æœ‰åºé›†"><a href="#list-æœ‰åºé›†" class="headerlink" title="list æœ‰åºé›†"></a>list æœ‰åºé›†</h2><h3 id="removeæ–¹æ³•æŒ‰ç»™å®šå…ƒç´ åˆ é™¤"><a href="#removeæ–¹æ³•æŒ‰ç»™å®šå…ƒç´ åˆ é™¤" class="headerlink" title="removeæ–¹æ³•æŒ‰ç»™å®šå…ƒç´ åˆ é™¤"></a>removeæ–¹æ³•æŒ‰ç»™å®šå…ƒç´ åˆ é™¤</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; a = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, 2, 3, 2]</span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, 2, 3, 2]</span><br><span class="line">&gt;&gt;&gt; a.remove(<span class="string">'a'</span>)</span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">[<span class="string">'b'</span>, <span class="string">'a'</span>, 2, 3, 2]</span><br><span class="line">&gt;&gt;&gt; a.remove(2)</span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">[<span class="string">'b'</span>, <span class="string">'a'</span>, 3, 2]    <span class="comment"># removeåˆ é™¤çš„æ˜¯å·¦è¾¹ç¬¬ä¸€ä¸ªæ‰¾åˆ°çš„å…ƒç´ </span></span><br></pre></td></tr></table></figure>
<h3 id="popæ–¹æ³•æŒ‰indexåˆ é™¤"><a href="#popæ–¹æ³•æŒ‰indexåˆ é™¤" class="headerlink" title="popæ–¹æ³•æŒ‰indexåˆ é™¤"></a>popæ–¹æ³•æŒ‰indexåˆ é™¤</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; a = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, 2, 3, 2]</span><br><span class="line">&gt;&gt;&gt; a.pop(2)</span><br><span class="line"><span class="string">'a'</span></span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, 2, 3, 2]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; a = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, 2, 3, 2]</span><br><span class="line">&gt;&gt;&gt; a.pop()                         <span class="comment"># ä¸ç»™å®šindexæ—¶ï¼Œpopçš„æ˜¯æœ«å°¾å…ƒç´ ï¼Œç­‰åŒäº a.pop(-1)</span></span><br><span class="line">2</span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, 2, 3]</span><br></pre></td></tr></table></figure>
<h3 id="delå‘½ä»¤ä¹Ÿå¯ä»¥åˆ é™¤åˆ—è¡¨å…ƒç´ ï¼ŒæŒ‰indexåˆ é™¤"><a href="#delå‘½ä»¤ä¹Ÿå¯ä»¥åˆ é™¤åˆ—è¡¨å…ƒç´ ï¼ŒæŒ‰indexåˆ é™¤" class="headerlink" title="delå‘½ä»¤ä¹Ÿå¯ä»¥åˆ é™¤åˆ—è¡¨å…ƒç´ ï¼ŒæŒ‰indexåˆ é™¤"></a>delå‘½ä»¤ä¹Ÿå¯ä»¥åˆ é™¤åˆ—è¡¨å…ƒç´ ï¼ŒæŒ‰indexåˆ é™¤</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; a = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'a'</span>, 2, 3, 2]</span><br><span class="line">&gt;&gt;&gt; del a[2]</span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">[<span class="string">'a'</span>, <span class="string">'b'</span>, 2, 3, 2]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; del a         <span class="comment"># delåˆ—è¡¨å ä¼šåˆ é™¤æ­¤åˆ—è¡¨</span></span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'a'</span> is not defined</span><br></pre></td></tr></table></figure>
<h3 id="åˆ—è¡¨åˆ†ç‰‡èµ‹å€¼"><a href="#åˆ—è¡¨åˆ†ç‰‡èµ‹å€¼" class="headerlink" title="åˆ—è¡¨åˆ†ç‰‡èµ‹å€¼"></a>åˆ—è¡¨åˆ†ç‰‡èµ‹å€¼</h3><p>åˆ†ç‰‡èµ‹å€¼æœ€å¥½åˆ†æˆä¸¤æ­¥æ¥ç†è§£ï¼š</p>
<blockquote>
<p>1.åˆ é™¤, åˆ é™¤ç­‰å·å·¦è¾¹æŒ‡å®šçš„åˆ†ç‰‡, å«å¤´ä¸å«å°¾ã€‚</p>
<p>2.æ’å…¥, å°†åŒ…å«åœ¨ç­‰å·å³è¾¹å¯¹è±¡ä¸­çš„ç‰‡æ®µæ’å…¥æ—§åˆ†ç‰‡è¢«åˆ é™¤çš„ä½ç½®ã€‚</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; L = [1, 3, 5, 7, 9]</span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 3, 5, 7, 9]</span><br><span class="line">&gt;&gt;&gt; L[1:3] = [2, 4, 6, 8]</span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 2, 4, 6, 8, 7, 9]</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; L[1:5] = []                 <span class="comment"># åˆ†ç‰‡èµ‹å€¼[] ç›¸å½“äºåˆ é™¤åˆ†ç‰‡å…ƒç´ </span></span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 7, 9]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L[1:3] = [2, 4, 6, 8]</span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 2, 4, 6, 8]</span><br><span class="line">&gt;&gt;&gt; del L[1:3]                  <span class="comment"># delå‘½ä»¤åˆ é™¤åˆ†ç‰‡</span></span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 6, 8]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'C'</span>]</span><br><span class="line">&gt;&gt;&gt; L2[:] = []                  <span class="comment"># [:]åˆ†ç‰‡è¡¨ç¤ºå…¨éƒ¨å…ƒç´ ï¼Œæ­¤å¤„åˆ é™¤å…¨éƒ¨å…ƒç´ </span></span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'C'</span>]</span><br><span class="line">&gt;&gt;&gt; del L2[:]</span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[]</span><br><span class="line">&gt;&gt;&gt; del L2</span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">NameError: name <span class="string">'L2'</span> is not defined</span><br></pre></td></tr></table></figure>
<h3 id="sort"><a href="#sort" class="headerlink" title="sort"></a>sort</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; L = [<span class="string">'a'</span>, <span class="string">'A'</span>, <span class="string">'b'</span>, <span class="string">'C'</span>]</span><br><span class="line">&gt;&gt;&gt; L.sort()</span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'C'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>]</span><br><span class="line">&gt;&gt;&gt; L.sort(reverse=True)</span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[<span class="string">'b'</span>, <span class="string">'a'</span>, <span class="string">'C'</span>, <span class="string">'A'</span>]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'C'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>]</span><br><span class="line">&gt;&gt;&gt; L.sort(key=str.lower)           <span class="comment"># ï¼Ÿç»Ÿä¸€æŒ‰å°å†™æ’åºï¼Œå°å†™åç›¸åŒçš„ä¿ç•™åŸé¡ºåº</span></span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[<span class="string">'A'</span>, <span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'C'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># L.sort(key=str.upper) ä¸ L.sort(key=str.lower) æ•ˆæœç›¸åŒ</span></span><br></pre></td></tr></table></figure>
<h2 id="set-æ— åºé›†"><a href="#set-æ— åºé›†" class="headerlink" title="set æ— åºé›†"></a>set æ— åºé›†</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; a = <span class="built_in">set</span>(1,2,3)                    <span class="comment"># setå’Œlist ä¸èƒ½é€šè¿‡å‚æ•°åˆ—è¡¨çš„æ–¹å¼åˆå§‹åŒ–å…ƒç´ </span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="built_in">set</span> expected at most 1 arguments, got 3</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; a = <span class="built_in">set</span>([1,2,3])                  <span class="comment"># æ–¹å¼ä¸€ï¼šè½¬åŒ–listä¸ºset</span></span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">&#123;1, 2, 3&#125;</span><br><span class="line">&gt;&gt;&gt; a = &#123;1,2,3,4&#125;                     <span class="comment"># æ–¹å¼äºŒï¼šä½¿ç”¨&#123;&#125;</span></span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">&#123;1, 2, 3, 4&#125;</span><br><span class="line">&gt;&gt;&gt; a.pop(3)                          <span class="comment"># å› æ— åºï¼Œæ²¡æœ‰pop(index)æ–¹æ³•ï¼Œdelå‘½ä»¤ä¹Ÿæ˜¯</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: pop() takes no arguments (1 given)</span><br><span class="line">&gt;&gt;&gt; a.remove(3)                       <span class="comment"># æœ‰remove(element)æ–¹æ³•ï¼ŒæŒ‰å…ƒç´ åˆ é™¤ï¼›ä¸è¦æ··æ·†popï¼Œæ²¡æœ‰pop(element)æ–¹æ³•</span></span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">&#123;1, 2, 4&#125;</span><br><span class="line">&gt;&gt;&gt; a = &#123;1,2,2,3&#125;                     <span class="comment"># åˆå§‹å…ƒç´ å«é‡å¤ï¼Œä¼šè‡ªåŠ¨å‰”é™¤é‡å¤å…ƒç´ </span></span><br><span class="line">&gt;&gt;&gt; a</span><br><span class="line">&#123;1, 2, 3&#125;</span><br></pre></td></tr></table></figure>
<h2 id="dict-å­—å…¸"><a href="#dict-å­—å…¸" class="headerlink" title="dict å­—å…¸"></a>dict å­—å…¸</h2><p>Python 3.0ä¸­çš„keysè¿”å›ä¸€ä¸ªè¿­ä»£å™¨ï¼Œåœ¨Python 2.6ä¸­ï¼Œkeysæ„å»ºå¹¶è¿”å›ä¸€ä¸ªçœŸæ­£çš„åˆ—è¡¨</p>
<h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; d = &#123;<span class="string">'a'</span>: 1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3,4,5]&#125;      <span class="comment"># æ–¹å¼ä¸€</span></span><br><span class="line">&gt;&gt;&gt; d = dict(a=1, b=2, c=[3,4,5])           <span class="comment"># æ–¹å¼äºŒ</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; d = &#123;&#125;                                  <span class="comment"># æ–¹å¼ä¸‰ï¼Œé€è¡Œèµ‹å€¼æ³•</span></span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'a'</span>] = 1</span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'b'</span>] = 2</span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'c'</span>] = [3,4,5]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; d4 = dict.fromkeys([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], 0)  <span class="comment"># æ–¹å¼å››ï¼Œæ­¤æ–¹æ³•åªèƒ½æŒ‡å®škeyï¼Œå‚æ•°äºŒæ˜¯å…¬å…±çš„å€¼ï¼Œä¸å†™åˆ™ä¸ºNone</span></span><br><span class="line">&gt;&gt;&gt; d4</span><br><span class="line">&#123;<span class="string">'a'</span>: 0, <span class="string">'b'</span>: 0, <span class="string">'c'</span>: 0&#125;</span><br><span class="line">&gt;&gt;&gt; d4 = dict.fromkeys([<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>])</span><br><span class="line">&gt;&gt;&gt; d4</span><br><span class="line">&#123;<span class="string">'a'</span>: None, <span class="string">'b'</span>: None, <span class="string">'c'</span>: None&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; D3 = dict.fromkeys(<span class="string">'abcd'</span>)                    <span class="comment"># å››-2, æ³¨æ„'dict'å­—ç¬¦ä¸²è¢«åˆ†å‰²ï¼Œå¦‚åŒ for e in 'abcd'</span></span><br><span class="line">&gt;&gt;&gt; D3</span><br><span class="line">&#123;<span class="string">'a'</span>: None, <span class="string">'b'</span>: None, <span class="string">'c'</span>: None, <span class="string">'d'</span>: None&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; D2 = &#123;k:v <span class="keyword">for</span> k,v  <span class="keyword">in</span> zip([<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>], [1,2,3])&#125;     <span class="comment"># è§£ææ³•</span></span><br><span class="line">&gt;&gt;&gt; D2</span><br><span class="line">&#123;<span class="string">'a'</span>: 1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: 3&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="comment"># å…¶å®ƒè½¬åŒ–æ³•</span></span><br></pre></td></tr></table></figure>
<h3 id="2ä¸ªlisté€šè¿‡zipåˆå¹¶æˆdict"><a href="#2ä¸ªlisté€šè¿‡zipåˆå¹¶æˆdict" class="headerlink" title="2ä¸ªlisté€šè¿‡zipåˆå¹¶æˆdict"></a>2ä¸ªlisté€šè¿‡zipåˆå¹¶æˆdict</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; list_a = [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]</span><br><span class="line">&gt;&gt;&gt; list_b = [1, 2, [3,4,5]]</span><br><span class="line">&gt;&gt;&gt; zip(list_a,list_b)</span><br><span class="line">&lt;zip object at 0x7f8d0b714e08&gt;</span><br><span class="line">&gt;&gt;&gt; list(zip(list_a,list_b))</span><br><span class="line">[(<span class="string">'a'</span>, 1), (<span class="string">'b'</span>, 2), (<span class="string">'c'</span>, [3, 4, 5])]</span><br><span class="line">&gt;&gt;&gt; dict(zip(list_a, list_b))</span><br><span class="line">&#123;<span class="string">'a'</span>: 1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5]&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; a = zip(list_a, list_b)                 <span class="comment"># zip è¿­ä»£å™¨ç±»å‹</span></span><br><span class="line">&gt;&gt;&gt; <span class="built_in">type</span>(a)</span><br><span class="line">&lt;class <span class="string">'zip'</span>&gt;</span><br><span class="line">&gt;&gt;&gt; <span class="keyword">for</span> m,n <span class="keyword">in</span> a:</span><br><span class="line">...     <span class="built_in">print</span>(f<span class="string">'&#123;m&#125;,&#123;n&#125;'</span>)</span><br><span class="line">... </span><br><span class="line">a,1</span><br><span class="line">b,2</span><br><span class="line">c,[3, 4, 5]</span><br></pre></td></tr></table></figure>
<h3 id="items"><a href="#items" class="headerlink" title="items"></a>items</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; d = &#123;<span class="string">'a'</span>: 1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3,4,5]&#125;</span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'a'</span>: 1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5]&#125;</span><br><span class="line">&gt;&gt;&gt; d.items</span><br><span class="line">&lt;built-in method items of dict object at 0x7f8d0b7924c8&gt;</span><br><span class="line">&gt;&gt;&gt; d.items()</span><br><span class="line">dict_items([(<span class="string">'a'</span>, 1), (<span class="string">'b'</span>, 2), (<span class="string">'c'</span>, [3, 4, 5])])      <span class="comment"># d.items() æ˜¯dict_itemsç±»å‹</span></span><br><span class="line">&gt;&gt;&gt; items = list(d.items())</span><br><span class="line">&gt;&gt;&gt; items</span><br><span class="line">[(<span class="string">'a'</span>, 1), (<span class="string">'b'</span>, 2), (<span class="string">'c'</span>, [3, 4, 5])]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">for</span> k,v <span class="keyword">in</span> d.items():</span><br><span class="line">...     <span class="built_in">print</span>(f<span class="string">"&#123;k&#125;:&#123;v&#125;"</span>)</span><br><span class="line">... </span><br><span class="line">a:1</span><br><span class="line">b:2</span><br><span class="line">c:[3, 4, 5]</span><br></pre></td></tr></table></figure>
<h3 id="dictæ˜¯å¯å˜ç±»å‹"><a href="#dictæ˜¯å¯å˜ç±»å‹" class="headerlink" title="dictæ˜¯å¯å˜ç±»å‹"></a>dictæ˜¯å¯å˜ç±»å‹</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'a'</span>: 1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5]&#125;</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; d2 = d</span><br><span class="line">&gt;&gt;&gt; d is d2</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'a'</span>] = 1.1</span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'a'</span>: 1.1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5]&#125;</span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'a'</span>: 1.1, <span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5]&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; d.pop(<span class="string">'a'</span>)                          <span class="comment"># dict æœ‰pop(key)æ–¹æ³•ï¼Œç›¸å½“äºget(key)å¹¶del d[key]</span></span><br><span class="line">1.1</span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5]&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; d.remove(<span class="string">'a'</span>)                       <span class="comment"># ! dict æ²¡æœ‰removeæˆ–deleteæ–¹æ³•</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">'dict'</span> object has no attribute <span class="string">'remove'</span></span><br><span class="line">&gt;&gt;&gt; d.delete(<span class="string">'a'</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">AttributeError: <span class="string">'dict'</span> object has no attribute <span class="string">'delete'</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; del d[<span class="string">'a'</span>]                          <span class="comment"># del å‘½ä»¤å¯ä»¥æŒ‰keyåˆ é™¤</span></span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5]&#125;</span><br></pre></td></tr></table></figure>
<h2 id="copyå’Œdeepcopy"><a href="#copyå’Œdeepcopy" class="headerlink" title="copyå’Œdeepcopy"></a>copyå’Œdeepcopy</h2><h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><p>å­—å…¸ã€åˆ—è¡¨æœ¬èº«æœ‰copyæ–¹æ³•</p>
<blockquote>
<p>æ‹·è´éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ— æ¡ä»¶å€¼çš„åˆ†ç‰‡ä»¥åŠå­—å…¸copyæ–¹æ³•åªèƒ½åšé¡¶å±‚å¤åˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸èƒ½å¤Ÿå¤åˆ¶åµŒå¥—çš„æ•°æ®ç»“æ„ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ã€‚å¦‚æœä½ éœ€è¦ä¸€ä¸ªæ·±å±‚åµŒå¥—çš„æ•°æ®ç»“æ„çš„å®Œæ•´çš„ã€å®Œå…¨ç‹¬ç«‹çš„æ‹·è´ï¼Œé‚£ä¹ˆå°±è¦ä½¿ç”¨æ ‡å‡†çš„copyæ¨¡å—â€”â€”åŒ…æ‹¬import copyè¯­å¥ï¼Œå¹¶ç¼–è¾‘X = copy.deepcopyï¼ˆYï¼‰å¯¹ä»»æ„åµŒå¥—å¯¹è±¡Yåšå®Œæ•´çš„å¤åˆ¶ã€‚</p>
</blockquote>
<ul>
<li>æ²¡æœ‰é™åˆ¶æ¡ä»¶çš„åˆ†ç‰‡è¡¨è¾¾å¼(L[:])èƒ½å¤Ÿå¤åˆ¶åºåˆ—ã€‚</li>
<li>å­—å…¸copyæ–¹æ³•(X.copy())èƒ½å¤Ÿå¤åˆ¶å­—å…¸ã€‚</li>
<li>æœ‰äº›å†…ç½®å‡½æ•°, ä¾‹å¦‚list, èƒ½å¤Ÿç”Ÿæˆæ‹·è´(list(L))ã€‚</li>
<li>copyæ ‡å‡†åº“æ¨¡å—èƒ½å¤Ÿç”Ÿæˆå®Œæ•´æ‹·è´ã€‚</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d2 = d</span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d3 = d.copy()</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'a'</span>] = <span class="string">'abc'</span></span><br><span class="line">&gt;&gt;&gt; d3</span><br><span class="line">&#123;<span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: <span class="string">'abc'</span>&#125;</span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'b'</span>] = 222</span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d3</span><br><span class="line">&#123;<span class="string">'b'</span>: 2, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: <span class="string">'abc'</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L = [1,3,5,7]</span><br><span class="line">&gt;&gt;&gt; L2 = L</span><br><span class="line">&gt;&gt;&gt; L3 = L.copy()             <span class="comment"># L3æ˜¯å¯¹Lçš„ç‹¬ç«‹çš„å¤åˆ¶</span></span><br><span class="line">&gt;&gt;&gt; L3</span><br><span class="line">[1, 3, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L3[1] = 2                 <span class="comment"># L3æ”¹å˜ Lå’ŒL2ä¸å˜</span></span><br><span class="line">&gt;&gt;&gt; L3</span><br><span class="line">[1, 2, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 3, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[1, 3, 5, 7]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L[1] = 100                <span class="comment"># Læ”¹å˜ï¼ŒL2è·Ÿç€å˜ï¼ŒL3ä¸å˜</span></span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 100, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[1, 100, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L3</span><br><span class="line">[1, 2, 5, 7]</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; L4 = L[:]                 <span class="comment"># [:]åˆ†ç‰‡ç›¸å½“äºL.copy(), L[0:], L[0:4]ä¹Ÿä¸€æ ·</span></span><br><span class="line">&gt;&gt;&gt; L4</span><br><span class="line">[1, 100, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L4[1] = 99</span><br><span class="line">&gt;&gt;&gt; L4</span><br><span class="line">[1, 99, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L</span><br><span class="line">[1, 100, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L2</span><br><span class="line">[1, 100, 5, 7]</span><br><span class="line">&gt;&gt;&gt; L3</span><br><span class="line">[1, 2, 5, 7]</span><br></pre></td></tr></table></figure>
<h3 id="deepcopy"><a href="#deepcopy" class="headerlink" title="deepcopy"></a>deepcopy</h3><p>copyåªå¤åˆ¶é¡¶å±‚ç»“æ„, deepcopyå¯ä»¥å¤åˆ¶åµŒå¥—çš„æ•°æ®ç»“æ„</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; d2 = d.copy()</span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'a'</span>][<span class="string">'aa'</span>] = [8, 9, 10]                                   <span class="comment"># ä¿®æ”¹ç¬¬äºŒå±‚æ•°æ®ï¼Œä¼šå‘ç°d2 ä»ç„¶éš d å˜åŒ–ï¼Œå› ä¸ºå¯¹key:'a'çš„valueå¤åˆ¶çš„æ˜¯å¼•ç”¨</span></span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d2 </span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'b'</span>] = 333                                                <span class="comment"># ä¿®æ”¹é¡¶å±‚æ•°æ®åˆ™ä¸ä¼š</span></span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 333, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; import copy</span><br><span class="line">&gt;&gt;&gt; d3 = copy.deepcopy(d)                                       <span class="comment"># deepcopyå¯ä»¥å®ç°åµŒå¥—å¼•ç”¨ç»“æ„çš„å¤åˆ¶</span></span><br><span class="line">&gt;&gt;&gt; d3</span><br><span class="line">&#123;<span class="string">'b'</span>: 333, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d[<span class="string">'a'</span>][<span class="string">'aa'</span>] = [9, 11]</span><br><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 333, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [9, 11], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d3</span><br><span class="line">&#123;<span class="string">'b'</span>: 333, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;   <span class="comment"># æ²¡å˜</span></span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [9, 11], <span class="string">'bb'</span>: 22&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>è¿›ä¸€æ­¥æµ‹è¯•</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: <span class="string">'222'</span>, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [9, 11], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d4 = d2.copy()</span><br><span class="line">&gt;&gt;&gt; d4 is d2</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; d4 == d2</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; d2[<span class="string">'b'</span>] is d4[<span class="string">'b'</span>]                <span class="comment"># ä½¿ç”¨copyæ—¶ï¼Œå¯¹äºä¸å¯å˜å¯¹è±¡å’Œï¼ˆåµŒå¥—çš„ï¼‰å¯å˜å¯¹è±¡ï¼Œéƒ½æ˜¯å¤åˆ¶ï¼ˆé¡¶å±‚ï¼‰åœ°å€</span></span><br><span class="line">True                                  <span class="comment"># å› æ­¤ï¼Œå½“é¡¶å±‚ä¸å¯å˜å¯¹è±¡ä¿®æ”¹æ—¶ï¼Œäº’ä¸å½±å“</span></span><br><span class="line">&gt;&gt;&gt; d2[<span class="string">'b'</span>] = <span class="string">'555'</span></span><br><span class="line">&gt;&gt;&gt; d4[<span class="string">'b'</span>]</span><br><span class="line">222</span><br><span class="line">&gt;&gt;&gt; d2[<span class="string">'b'</span>] is d4[<span class="string">'b'</span>]</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; d2[<span class="string">'a'</span>][<span class="string">'bb'</span>] = 44                <span class="comment"># è€ŒåµŒå¥—ç»“æ„ä¿®æ”¹æ—¶ï¼Œå› ä¸ºæ˜¯åŸåœ°ä¿®æ”¹ï¼ˆé¡¶å±‚åœ°å€ä¸å˜ï¼‰ï¼ŒåŸå§‹å¯¹è±¡å’Œå¤åˆ¶å¯¹è±¡ä¸€èµ·æ”¹å˜</span></span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: <span class="string">'555'</span>, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [9, 11], <span class="string">'bb'</span>: 44&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d4</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [9, 11], <span class="string">'bb'</span>: 44&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d2[<span class="string">'a'</span>][<span class="string">'bb'</span>] is d4[<span class="string">'a'</span>][<span class="string">'bb'</span>]    <span class="comment"># è™½ç„¶å­å±‚ d2['a']['bb'] æ˜¯intä¸å¯å˜ç±»å‹ä¿®æ”¹æ—¶ç¬¬äºŒå±‚çš„ç›¸åº”åœ°å€å˜äº†</span></span><br><span class="line">True                                  <span class="comment"># ï¼Œä½†å› ä¸ºæ‰€å…³è”çš„é¡¶å±‚åœ°å€ä¸å˜ï¼Œæ‰€ä»¥å¤åˆ¶å¯¹è±¡ä¸åŸå§‹å¯¹è±¡ä¿æŒä¸€è‡´</span></span><br><span class="line">                                      <span class="comment"># copyå¤åˆ¶çš„å¯¹è±¡ å¯ä»¥çœ‹ä½œæ—¶ æ ˆå†…å­˜ä¸­çš„ä¸€ä¸ªå†…å­˜ä½ç½®æ‰€æŒ‡å‘çš„å †å†…å­˜çš„é¡¶å±‚åœ°å€åˆ—è¡¨</span></span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; d3 = copy.deepcopy(d2)</span><br><span class="line">&gt;&gt;&gt; d3</span><br><span class="line">&#123;<span class="string">'b'</span>: <span class="string">'555'</span>, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [9, 11], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'b'</span>] is d2[<span class="string">'b'</span>]</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'c'</span>] is d2[<span class="string">'c'</span>]</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'c'</span>][0] is d2[<span class="string">'c'</span>][0]</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'a'</span>] is d2[<span class="string">'a'</span>]</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'a'</span>][<span class="string">'bb'</span>] is d2[<span class="string">'a'</span>][<span class="string">'bb'</span>]</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'a'</span>][<span class="string">'aa'</span>] is d2[<span class="string">'a'</span>][<span class="string">'aa'</span>]</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; d3[<span class="string">'a'</span>][<span class="string">'aa'</span>][0] is d2[<span class="string">'a'</span>][<span class="string">'aa'</span>][0]</span><br><span class="line">True</span><br></pre></td></tr></table></figure>
<h2 id="æ¯”è¾ƒå¤§å°"><a href="#æ¯”è¾ƒå¤§å°" class="headerlink" title="æ¯”è¾ƒå¤§å°"></a>æ¯”è¾ƒå¤§å°</h2><p>ä¸€èˆ¬æ¥è¯´ï¼ŒPythonä¸­ä¸åŒçš„ç±»å‹çš„æ¯”è¾ƒæ–¹æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>æ•°å­—é€šè¿‡ç›¸å¯¹å¤§å°è¿›è¡Œæ¯”è¾ƒã€‚</li>
<li>å­—ç¬¦ä¸²æ˜¯æŒ‰ç…§å­—å…¸é¡ºåºï¼Œä¸€ä¸ªå­—ç¬¦æ¥ä¸€ä¸ªå­—ç¬¦åœ°å¯¹æ¯”è¿›è¡Œæ¯”è¾ƒï¼ˆâ€abcâ€ &lt; â€œacâ€ï¼‰ã€‚</li>
<li>åˆ—è¡¨å’Œå…ƒç»„ä»å·¦åˆ°å³å¯¹æ¯éƒ¨åˆ†çš„å†…å®¹è¿›è¡Œæ¯”è¾ƒã€‚</li>
<li>å­—å…¸é€šè¿‡æ’åºä¹‹åçš„ï¼ˆé”®ã€å€¼ï¼‰åˆ—è¡¨è¿›è¡Œæ¯”è¾ƒã€‚å­—å…¸çš„ç›¸å¯¹å¤§å°æ¯”è¾ƒåœ¨Python 3.0ä¸­ä¸æ”¯æŒ</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&gt;&gt;&gt; d</span><br><span class="line">&#123;<span class="string">'b'</span>: 333, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; d2</span><br><span class="line">&#123;<span class="string">'b'</span>: 222, <span class="string">'c'</span>: [3, 4, 5], <span class="string">'a'</span>: &#123;<span class="string">'aa'</span>: [8, 9, 10], <span class="string">'bb'</span>: 22&#125;&#125;</span><br><span class="line">&gt;&gt;&gt; </span><br><span class="line">&gt;&gt;&gt; d3 = d</span><br><span class="line">&gt;&gt;&gt; d3 is d</span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; d4 = d2.copy()</span><br><span class="line">&gt;&gt;&gt; d4 is d2</span><br><span class="line">False</span><br><span class="line">&gt;&gt;&gt; d4 == d2                  <span class="comment"># å¯ä»¥æµ‹è¯•æ˜¯å¦ç›¸ç­‰ ==</span></span><br><span class="line">True</span><br><span class="line">&gt;&gt;&gt; d2 &lt; d                    <span class="comment"># ä½† python3 ä¸­ä¸æ”¯æŒæ¯”å¤§å° &gt; &lt;</span></span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line 1, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">TypeError: <span class="string">'&lt;'</span> not supported between instances of <span class="string">'dict'</span> and <span class="string">'dict'</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythonæ•´é½è¾“å‡ºå¤šåˆ—</title>
    <url>/python/python-pretty-column/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>æ•ˆæœå›¾ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/image-20201008161147875.png" alt="image-20201008161147875"></p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding:utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""pythonæ•´é½è¾“å‡ºå¤šåˆ—ï¼ˆå«ä¸­è‹±æ–‡å­—ç¬¦ï¼‰çš„æ–¹æ³•"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> csv</span><br><span class="line"></span><br><span class="line">is_py2 = <span class="number">2</span> == sys.version_info.major</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pretty_col</span><span class="params">(rows, title=True, print_title=True, fields=None)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    :param rows: List[List] or List[Dict] type</span></span><br><span class="line"><span class="string">    :param title: whether row0 is title or not. always True when &lt;rows&gt; is List[Dict] type</span></span><br><span class="line"><span class="string">    :param print_title: print title or not when &lt;title&gt; is True,</span></span><br><span class="line"><span class="string">    :param fields: specify columns order</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_zh</span><span class="params">(ch)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        éƒ¨åˆ†ç¼–ç èŒƒå›´çš„å­—ç¬¦ä¸€ä¸ªå­—ç¬¦å 2ä¸ªæ™®é€šå­—ç¬¦çš„å®½åº¦ï¼Œä¸é½å…¨</span></span><br><span class="line"><span class="string">        :param ch:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> is_py2:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">u'\u4e00'</span> &lt;= ch &lt;= <span class="string">u'\u9fa5'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">u'\u3000'</span> &lt;= ch &lt;= <span class="string">u'\u303F'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">u'\uff00'</span> &lt;= ch &lt;= <span class="string">u'\uff60'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'\u4e00'</span> &lt;= ch &lt;= <span class="string">'\u9fa5'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">'\u3000'</span> &lt;= ch &lt;= <span class="string">'\u303F'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">'\uff00'</span> &lt;= ch &lt;= <span class="string">'\uff60'</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">str_width</span><span class="params">(string)</span>:</span></span><br><span class="line">        count = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> string.decode(<span class="string">'utf8'</span>) <span class="keyword">if</span> is_py2 <span class="keyword">else</span> string:</span><br><span class="line">            <span class="keyword">if</span> is_zh(ch):</span><br><span class="line">                count += <span class="number">2</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> count</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(rows) == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    row_list = rows</span><br><span class="line">    <span class="comment"># if type(rows[0]) is dict:</span></span><br><span class="line">    <span class="comment"># if isinstance(rows[0], OrderedDict) or isinstance(rows[0], dict):</span></span><br><span class="line">    <span class="keyword">if</span> type(rows[<span class="number">0</span>]).__name__ <span class="keyword">in</span> [<span class="string">"dict"</span>, <span class="string">"OrderedDict"</span>]:</span><br><span class="line">        title = <span class="literal">True</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> fields:</span><br><span class="line">            fields = rows[<span class="number">0</span>].keys()</span><br><span class="line">        row_list = [[d.get(k) <span class="keyword">for</span> k <span class="keyword">in</span> fields] <span class="keyword">for</span> d <span class="keyword">in</span> rows]</span><br><span class="line">        row_list.insert(<span class="number">0</span>, fields)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> type(rows[<span class="number">0</span>]) <span class="keyword">is</span> list:</span><br><span class="line">        <span class="keyword">if</span> fields:</span><br><span class="line">            fields_cols = fields</span><br><span class="line">            <span class="keyword">if</span> isinstance(fields[<span class="number">0</span>], str):</span><br><span class="line">                row0 = rows[<span class="number">0</span>]</span><br><span class="line">                fields_cols = [row0.index(m) <span class="keyword">for</span> m <span class="keyword">in</span> fields]</span><br><span class="line">            row_list = [[r[i] <span class="keyword">for</span> i <span class="keyword">in</span> fields_cols] <span class="keyword">for</span> r <span class="keyword">in</span> row_list]</span><br><span class="line"></span><br><span class="line">    columns_list = list(zip(*row_list))</span><br><span class="line">    c_len = [max(map(str_width, col)) <span class="keyword">for</span> col <span class="keyword">in</span> columns_list]</span><br><span class="line">    c_len = [w + <span class="number">4</span> - w % <span class="number">4</span> <span class="keyword">for</span> w <span class="keyword">in</span> c_len]</span><br><span class="line">    r_len = sum(c_len) - <span class="number">2</span></span><br><span class="line"></span><br><span class="line">    nr = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> row_list:</span><br><span class="line">        nr += <span class="number">1</span></span><br><span class="line">        line = <span class="string">""</span>.join([x + <span class="string">" "</span> * (c_len[i] - str_width(x)) <span class="keyword">for</span> i, x <span class="keyword">in</span> enumerate(row)])</span><br><span class="line">        <span class="keyword">if</span> <span class="number">1</span> == nr <span class="keyword">and</span> title:</span><br><span class="line">            <span class="keyword">if</span> print_title:</span><br><span class="line">                print(line)</span><br><span class="line">                print(<span class="string">"*"</span> * r_len)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        print(line)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_all</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span>(open(<span class="string">"contact.txt"</span>, <span class="string">"r"</span>)) <span class="keyword">as</span> f:</span><br><span class="line">        name_dict_list = list(csv.DictReader(f))</span><br><span class="line"></span><br><span class="line">    pretty_col(name_dict_list, title=<span class="literal">True</span>, fields=[<span class="string">"å§“å"</span>, <span class="string">"phone"</span>, <span class="string">"qq"</span>, <span class="string">"email"</span>, <span class="string">"remark"</span>])</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_dict_list, title=<span class="literal">True</span>, print_title=<span class="literal">False</span>, fields=[<span class="string">"å§“å"</span>, <span class="string">"phone"</span>, <span class="string">"qq"</span>, <span class="string">"email"</span>, <span class="string">"remark"</span>])</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_dict_list, title=<span class="literal">True</span>)</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_dict_list, title=<span class="literal">True</span>, print_title=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_all2</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">with</span>(open(<span class="string">"contact.txt"</span>, <span class="string">"r"</span>)) <span class="keyword">as</span> f:</span><br><span class="line">        name_list = list(csv.reader(f))</span><br><span class="line"></span><br><span class="line">    pretty_col(name_list, title=<span class="literal">True</span>, fields=[<span class="string">"å§“å"</span>, <span class="string">"qq"</span>, <span class="string">"phone"</span>, <span class="string">"email"</span>, <span class="string">"remark"</span>])</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_list, title=<span class="literal">True</span>, print_title=<span class="literal">False</span>, fields=[<span class="number">0</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">2</span>])</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_list, title=<span class="literal">True</span>)</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_list, title=<span class="literal">False</span>, fields=[<span class="string">"å§“å"</span>, <span class="string">"email"</span>, <span class="string">"remark"</span>])</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_list, title=<span class="literal">False</span>, fields=[<span class="number">0</span>, <span class="number">3</span>])</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    pretty_col(name_list, title=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="string">"""contact.txt:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">å§“å,phone,qq,email,remark</span></span><br><span class="line"><span class="string">å¼ ä¸‰33333333333333333333333333,15688886666,666999,zhangsan@qq.com,æ— </span></span><br><span class="line"><span class="string">æå››44444444444444444444444444444444444444444444444444,13188889999,999777,lisi@qq.com,2020</span></span><br><span class="line"><span class="string">ç‹!@#ii@()ï¼ˆï¼‰ã€ã€‘äº”5555555,156787888991,8882222222222222,ww@qq.com,2019</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    show_all()</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    print(<span class="string">""</span>)</span><br><span class="line">    show_all2()</span><br></pre></td></tr></table></figure>
<p><a href="/assets/files/pretty_column.py">é™„ä»¶ï¼špretty_column.py</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythonæ¨¡æ‹Ÿæ ˆå’Œé˜Ÿåˆ—</title>
    <url>/python/python-stack-queue/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">How to reduce <span class="string">'attention residue'</span> <span class="keyword">in</span> your life </span><br><span class="line"> 34 Many of us struggle with the never-ending nature of our to-do lists, says Elizabeth Emens, author of The Art of Life Admin and a New York-based professor     of law at Columbia University.</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>æ¨¡æ‹Ÿæ ˆéšæœºå­˜å–è‹¥å¹²å­—ç¬¦ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos pyQueueStack]<span class="comment"># python stack.py </span></span><br><span class="line"></span><br><span class="line">+6: H o w   t o </span><br><span class="line">-5: o t   w o </span><br><span class="line">+5:   r e d u </span><br><span class="line">-7: u d e r   H (empty) </span><br><span class="line">+5: c e   <span class="string">' a </span></span><br><span class="line"><span class="string">+4: t t e n </span></span><br><span class="line"><span class="string">+6: t i o n   r </span></span><br><span class="line"><span class="string">-6: r   n o i t </span></span><br><span class="line"><span class="string">+7: e s i d u e '</span> </span><br><span class="line">-6: <span class="string">' e u d i s </span></span><br><span class="line"><span class="string">-5: e n e t t </span></span><br><span class="line"><span class="string">+3:   i n </span></span><br><span class="line"><span class="string">+4:   y o u </span></span><br><span class="line"><span class="string">-7: u o y   n i   </span></span><br><span class="line"><span class="string">-3: a '</span>   </span><br><span class="line">-5: e c (empty) </span><br><span class="line">+5: r   l i f </span><br><span class="line">+4: e ? </span><br><span class="line">-4: ? e f i </span><br><span class="line">-3: l   r </span><br><span class="line">End.</span><br></pre></td></tr></table></figure>
<p>æ¨¡æ‹Ÿé˜Ÿåˆ—éšæœºå­˜å–è‹¥å¹²å­—ç¬¦ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos pyQueueStack]<span class="comment"># python queue.py </span></span><br><span class="line"></span><br><span class="line">+7: H o w   t o   </span><br><span class="line">+7: r e d u c e   </span><br><span class="line">+4: <span class="string">' a t t </span></span><br><span class="line"><span class="string">+3: e n t </span></span><br><span class="line"><span class="string">+7: i o n   r e s </span></span><br><span class="line"><span class="string">+7: i d u e '</span>   i </span><br><span class="line">+3: n   y </span><br><span class="line">+3: o u r </span><br><span class="line">+4:   l i f </span><br><span class="line">+5: e ? </span><br><span class="line">-5: H o w   t </span><br><span class="line">-6: o   r e d u </span><br><span class="line">-7: c e   <span class="string">' a t t </span></span><br><span class="line"><span class="string">-3: e n t </span></span><br><span class="line"><span class="string">-5: i o n   r </span></span><br><span class="line"><span class="string">-6: e s i d u e </span></span><br><span class="line"><span class="string">-7: '</span>   i n   y o </span><br><span class="line">-6: u r   l i f </span><br><span class="line">-7: e ? (empty) </span><br><span class="line">End.</span><br></pre></td></tr></table></figure>
<p>æ¨¡æ‹Ÿ 2ä¸ªæ ˆ å®ç° é˜Ÿåˆ—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos pyQueueStack]<span class="comment"># python stack2queue.py </span></span><br><span class="line"></span><br><span class="line">+4: H o w   </span><br><span class="line">+7: t o   r e d u </span><br><span class="line">+3: c e   </span><br><span class="line">+4: <span class="string">' a t t </span></span><br><span class="line"><span class="string">+5: e n t i o </span></span><br><span class="line"><span class="string">+4: n   r e </span></span><br><span class="line"><span class="string">+4: s i d u </span></span><br><span class="line"><span class="string">+5: e '</span>   i n </span><br><span class="line">+5:   y o u r </span><br><span class="line">+6:   l i f e ? </span><br><span class="line">-3: H o w </span><br><span class="line">-4:   t o   </span><br><span class="line">-6: r e d u c e </span><br><span class="line">-4:   <span class="string">' a t </span></span><br><span class="line"><span class="string">-6: t e n t i o </span></span><br><span class="line"><span class="string">-7: n   r e s i d </span></span><br><span class="line"><span class="string">-7: u e '</span>   i n   </span><br><span class="line">-7: y o u r   l i </span><br><span class="line">-4: f e ? (empty) </span><br><span class="line">End.</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># coding=utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SequenceStack</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__members = list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_empty</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">not</span> len(self.__members)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        self.__members.append(data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">pop</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.is_empty():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">return</span> self.__members.pop()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">length</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> len(self.__members)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.is_empty():</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">return</span> self.__members[<span class="number">-1</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Queue</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.__stackA = SequenceStack()</span><br><span class="line">        self.__stackB = SequenceStack()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">is_empty</span><span class="params">(self)</span>:</span></span><br><span class="line">         <span class="keyword">return</span> self.__stackA.is_empty() <span class="keyword">and</span> self.__stackB.is_empty()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">offer</span><span class="params">(self, e)</span>:</span></span><br><span class="line">        self.__stackA.push(e)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">poll</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> self.__stackB.is_empty():</span><br><span class="line">            <span class="keyword">while</span> <span class="keyword">not</span> self.__stackA.is_empty():</span><br><span class="line">                self.__stackB.push(self.__stackA.pop())</span><br><span class="line">        <span class="keyword">return</span> self.__stackB.pop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    q = Queue()</span><br><span class="line">    s = <span class="string">"""How to reduce 'attention residue' in your life?"""</span></span><br><span class="line">    n_pos = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># is_offer = int(random.random()*2) == 1 and n_pos &lt; len(s)</span></span><br><span class="line">        is_offer = n_pos &lt; len(s)</span><br><span class="line">        in_num = int(random.random()*<span class="number">5</span>) + <span class="number">3</span></span><br><span class="line">        out_num = int(random.random()*<span class="number">5</span>) + <span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> is_offer:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"\n+%1d:"</span> % in_num,</span><br><span class="line">            <span class="keyword">for</span> e <span class="keyword">in</span> s[n_pos:n_pos+in_num]:</span><br><span class="line">                <span class="keyword">print</span> e,</span><br><span class="line">                q.offer(e)</span><br><span class="line">            n_pos += in_num</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"\n-%1d:"</span> % out_num,</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> range(out_num):</span><br><span class="line">                <span class="keyword">if</span> q.is_empty():</span><br><span class="line">                    <span class="keyword">print</span> <span class="string">"(empty)"</span>,</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">print</span> q.poll(),</span><br><span class="line">            <span class="keyword">if</span> q.is_empty() <span class="keyword">and</span> n_pos &gt;= len(s):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\nEnd."</span></span><br></pre></td></tr></table></figure>
<p>é˜Ÿåˆ— å½“ æ ˆ ä½¿ç”¨ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos pyQueueStack]<span class="comment"># python queue2stack.py </span></span><br><span class="line"></span><br><span class="line">+3: H o w </span><br><span class="line">+5:   t o   r </span><br><span class="line">+7: e d u c e   <span class="string">' </span></span><br><span class="line"><span class="string">+5: a t t e n </span></span><br><span class="line"><span class="string">+4: t i o n </span></span><br><span class="line"><span class="string">+6:   r e s i d </span></span><br><span class="line"><span class="string">+4: u e '</span>   </span><br><span class="line">-7:   <span class="string">' e u d i s </span></span><br><span class="line"><span class="string">+3: i n   </span></span><br><span class="line"><span class="string">+7: y o u r   l i </span></span><br><span class="line"><span class="string">+7: f e ? </span></span><br><span class="line"><span class="string">-5: ? e f i l </span></span><br><span class="line"><span class="string">-5:   r u o y </span></span><br><span class="line"><span class="string">-6:   n i e r   </span></span><br><span class="line"><span class="string">-5: n o i t n </span></span><br><span class="line"><span class="string">-3: e t t </span></span><br><span class="line"><span class="string">-3: a '</span>   </span><br><span class="line">-7: e c u d e r   </span><br><span class="line">-6: o t   w o H </span><br><span class="line">End.</span><br></pre></td></tr></table></figure>
<p><a href="/assets/files/stack-queue/stack.py">é™„ä»¶ï¼šstack.py</a></p>
<p><a href="/assets/files/stack-queue/queue.py">é™„ä»¶ï¼šqueue.py</a></p>
<p><a href="/assets/files/stack-queue/stack2queue.py">é™„ä»¶ï¼šstack2queue.py</a></p>
<p><a href="/assets/files/stack-queue/queue2stack.py">é™„ä»¶ï¼šqueue2stack.py</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythonæ–‡æœ¬å¯¹é½</title>
    <url>/python/python-text-align/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p>æ•ˆæœå›¾ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/image-20201008165358024.png" alt="image-20201008161147875" style="zoom: 67%;"></p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># coding=utf8</span></span><br><span class="line"></span><br><span class="line"><span class="string">"""æŒ‡å®šè¡Œå®½ï¼Œæ–‡æœ¬æ®µè½åˆ†æ•£å¯¹é½ï¼ˆæ¯è¡Œå°½é‡å¤šè¾“å‡ºå•è¯ï¼Œç±»ä¼¼ä¸¤ç«¯å¯¹é½ï¼Œæœ«è¡Œå·¦å¯¹é½ï¼‰"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> typing <span class="keyword">import</span> List</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Solution</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def full_justify2(self, words: List[str], max_width: int) -&gt; List[str]:</span></span><br><span class="line">    <span class="comment"># def full_justify2(words, max_width):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full_justify2</span><span class="params">(words: List[str], max_width: int)</span> -&gt; List[str]:</span></span><br><span class="line">        cur = <span class="number">0</span></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        res = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(len(words)):</span><br><span class="line">            cur += len(words[i]) + <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> cur &gt; max_width + <span class="number">1</span>:  <span class="comment"># +1æ˜¯è€ƒè™‘ç©ºæ ¼æƒ…å†µï¼Œbtwï¼Œæ­¤æ—¶å¯ä»¥æ•´ç†æ”¾å…¥resçš„è¡Œä¸åŒ…æ‹¬words[i]</span></span><br><span class="line">                space_count = i - start - <span class="number">1</span>  <span class="comment"># [start,i)å¯ä»¥ç»„æˆä¸€è¡Œæ”¾å…¥res</span></span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> space_count:  <span class="comment"># ä¸€è¡Œåªæœ‰ä¸€ä¸ªå•è¯çš„æƒ…å†µ</span></span><br><span class="line">                    res.append(words[i - <span class="number">1</span>].ljust(max_width, <span class="string">" "</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    total_space = max_width - (cur - len(words[i]) - <span class="number">2</span>) + i - <span class="number">1</span> - start  <span class="comment"># æ³¨æ„è¡¥ä¸Šä¸€å¼€å§‹æ¯ä¸ªspaceé¢„ç•™çš„ä¸€ä¸ªç©ºæ ¼</span></span><br><span class="line">                    small_space = total_space // space_count</span><br><span class="line">                    small_space_str = small_space * <span class="string">" "</span></span><br><span class="line">                    big_space_str = (small_space + <span class="number">1</span>) * <span class="string">" "</span></span><br><span class="line">                    big_space_count = total_space - small_space * space_count</span><br><span class="line">                    res.append(big_space_str.join(words[start:start + big_space_count + <span class="number">1</span>]) + small_space_str.join(</span><br><span class="line">                        [<span class="string">""</span>] + words[start + big_space_count + <span class="number">1</span>:i]))  <span class="comment"># å¤§å°ç©ºæ ¼è¿æ¥çš„å­—ç¬¦ä¸²ä¸­é—´æ³¨æ„è¿˜è¦æœ‰ç©ºæ ¼ï¼Œç”¨ç©ºå­—ç¬¦ä¸²åå ä½ç¬¦æ¥è¡¥</span></span><br><span class="line"></span><br><span class="line">                cur = len(words[i]) + <span class="number">1</span></span><br><span class="line">                start = i</span><br><span class="line">        res.append(<span class="string">" "</span>.join(words[start:]).ljust(max_width, <span class="string">" "</span>))</span><br><span class="line">        <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def fullJustify(self, words, maxWidth):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full_justify</span><span class="params">(words, max_width)</span>:</span>  <span class="comment"># ? ä¸ç”¨selfï¼Œè¯­æ³•è§„èŒƒå¦ï¼Ÿ</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        :type words: List[str]</span></span><br><span class="line"><span class="string">        :type max_width: int</span></span><br><span class="line"><span class="string">        :rtype: List[str]</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        res = []</span><br><span class="line">        tmp = []</span><br><span class="line">        lg = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> words:</span><br><span class="line">            <span class="keyword">if</span> len(i) + lg &lt;= max_width:</span><br><span class="line">                tmp.append(i)</span><br><span class="line">                lg += len(i) + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                res.append(tmp)</span><br><span class="line">                tmp = [i]</span><br><span class="line">                lg = len(i) + <span class="number">1</span></span><br><span class="line">        res.append(tmp)</span><br><span class="line">        <span class="keyword">for</span> word <span class="keyword">in</span> res[:<span class="number">-1</span>]:</span><br><span class="line">            lg = sum(len(ws) <span class="keyword">for</span> ws <span class="keyword">in</span> word)</span><br><span class="line">            <span class="keyword">if</span> len(word) == <span class="number">1</span>:</span><br><span class="line">                word[<span class="number">0</span>] = word[<span class="number">0</span>] + <span class="string">' '</span> * (max_width - lg)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">while</span> lg != max_width:</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> range(len(word) - <span class="number">1</span>):</span><br><span class="line">                        word[i] = word[i] + <span class="string">' '</span></span><br><span class="line">                        lg += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">if</span> lg == max_width:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">        ans = <span class="string">' '</span>.join(res[<span class="number">-1</span>])</span><br><span class="line">        <span class="keyword">if</span> len(ans) &lt; max_width:</span><br><span class="line">            ans = ans + <span class="string">" "</span> * (max_width - len(ans))</span><br><span class="line">        <span class="comment"># print(ans)</span></span><br><span class="line">        <span class="keyword">return</span> [<span class="string">''</span>.join(word) <span class="keyword">for</span> word <span class="keyword">in</span> res[:<span class="number">-1</span>]] + [ans]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    txt_list = [</span><br><span class="line">        <span class="string">"This is a sample textyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy for testing justification."</span>,</span><br><span class="line">        <span class="string">"This2 is a sa justification2."</span>,</span><br><span class="line">        <span class="string">"This3 is a sample texjustification2."</span>,</span><br><span class="line">        <span class="string">"This4 is a sample text forstification2."</span>,</span><br><span class="line">        <span class="string">"This5 is a saustification2."</span>,</span><br><span class="line">    ]</span><br><span class="line">    txt_list = <span class="string">" "</span>.join(txt_list).split(<span class="string">" "</span>)</span><br><span class="line">    max_len = <span class="number">80</span></span><br><span class="line">    <span class="comment"># ins = Solution()</span></span><br><span class="line">    <span class="comment"># for line in ins.fullJustify(txt_list, max_len):</span></span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> Solution.full_justify(txt_list, max_len):</span><br><span class="line">        print(<span class="string">"["</span>, line, <span class="string">"]"</span>)</span><br><span class="line">        </span><br><span class="line">    print(<span class="string">" ---"</span> * <span class="number">20</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> Solution.full_justify2(txt_list, max_len):</span><br><span class="line">        print(<span class="string">"["</span>, line, <span class="string">"]"</span>)</span><br></pre></td></tr></table></figure>
<p><a href="/assets/files/python-text-align.py">é™„ä»¶ï¼špython-text-align.py</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>è‚¡ä»·æŸ¥è¯¢å°å·¥å…·ä¸€æš[2]</title>
    <url>/python/stock-price-plus/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><p><a href="../tools-stock-price/">æ—§ç‰ˆ</a></p>
<p>é’ˆå¯¹æœ‰æ—¶è¾“å‡ºå¯¹ä¸é½ä½œäº†æ”¹è¿›ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/stock-price-plus-01_20201008163516.png" alt="image-20200928004218980" style="zoom: 67%;"></p>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨ï¼š</span></span><br><span class="line">[root@VM_0_13_centos ~]<span class="comment"># cp sp3.py /usr/local/bin/stock-price</span></span><br><span class="line">[root@VM_0_13_centos ~]<span class="comment"># chmod +x /usr/local/bin/stock-price</span></span><br><span class="line">[root@VM_0_13_centos ~]<span class="comment"># cd /usr/local/bin</span></span><br><span class="line">[root@VM_0_13_centos ~]<span class="comment"># ln -s stock-price sp</span></span><br><span class="line"></span><br><span class="line">[root@VM_0_13_centos demo]<span class="comment"># sp -h</span></span><br><span class="line">usage: sp [-h] [-C] [-Z] stock_code [day]</span><br><span class="line"></span><br><span class="line">positional arguments:</span><br><span class="line">  stock_code      the stock code or the stock name, e.g. sz000002 or ä¸‡ç§‘A</span><br><span class="line">  day             <span class="built_in">which</span> day(s), use the number of days before today, e.g.</span><br><span class="line">                  <span class="string">"3,1"</span> or <span class="string">"1,3"</span> or <span class="string">"3,"</span> or <span class="string">",1"</span> or <span class="string">"3"</span>, by default <span class="string">","</span> is the</span><br><span class="line">                  same as <span class="string">"10,1"</span>, and the quotes are not necessary. Maximum</span><br><span class="line">                  days: 137</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  -h, --<span class="built_in">help</span>      show this <span class="built_in">help</span> message and <span class="built_in">exit</span></span><br><span class="line">  -C, --no-color  <span class="keyword">if</span> calculate delta, <span class="keyword">then</span> color, <span class="keyword">else</span> no color.</span><br><span class="line">  -Z, --en        cancel zh-CN</span><br></pre></td></tr></table></figure>
<p><a href="/assets/files/sp3.py">é™„ä»¶ï¼šsp3.py</a></p>
]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>ç¼–è¯‘xxl-job-2.1.2</title>
    <url>/task-sheduling/upgrade-xxl-job/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>xxl-job-2.0.2 åªæœ‰ä¸€ä¸ªadminç”¨æˆ·ï¼Œä¸èƒ½è®¾ç½®åˆ›å»ºå¤šä¸ªè´¦å·ï¼Œv2.1.2ç‰ˆå¯ä»¥åˆ›å»ºå¤šä¸ªã€‚</p>
</blockquote>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/upgrade-xxl-job.assets/1579404329759.png" alt="xxl-jobé¦–é¡µ"></p>
<a id="more"></a>
<h2 id="è¿è¡Œä¸€ä¸ªmavenå®¹å™¨"><a href="#è¿è¡Œä¸€ä¸ªmavenå®¹å™¨" class="headerlink" title="è¿è¡Œä¸€ä¸ªmavenå®¹å™¨"></a>è¿è¡Œä¸€ä¸ªmavenå®¹å™¨</h2><p>docker-compose.ymlå¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">mvn:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">maven:3.5-jdk-8-alpine</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./data:/data</span>		<span class="comment"># æºç åŒ…xxl-job-2.1.2.tar.gzåœ¨./dataä¸‹</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">["tail",</span> <span class="string">"-f"</span><span class="string">,</span> <span class="string">"/dev/null"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run -d --name mvn3 maven:3.5-jdk-8-alpine tail -f /dev/null</span><br><span class="line"><span class="comment"># å¤åˆ¶æºç åŒ…åˆ°å®¹å™¨/dataç›®å½•ä¸­</span></span><br><span class="line">docker cp data/xxl-job-2.1.2.tar.gz mvn3:/data/</span><br></pre></td></tr></table></figure>
<h2 id="è¿›å…¥å®¹å™¨ç¼–è¯‘"><a href="#è¿›å…¥å®¹å™¨ç¼–è¯‘" class="headerlink" title="è¿›å…¥å®¹å™¨ç¼–è¯‘"></a>è¿›å…¥å®¹å™¨ç¼–è¯‘</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mvn3 bash</span><br><span class="line"><span class="comment"># ç¼–åŒ…</span></span><br><span class="line"><span class="built_in">cd</span> /data/xxl-job-&#123;ç‰ˆæœ¬å·&#125;</span><br><span class="line">mvn clean package</span><br><span class="line"><span class="comment"># æ‹·åŒ…</span></span><br><span class="line">mkdir target</span><br><span class="line">mv xxl-job-admin/target/*.jar target/</span><br><span class="line">mv xxl-job-executor-samples/xxl-job-executor-sample-springboot/target/*.jar target/</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/upgrade-xxl-job.assets/1579251741156.png" alt="ç¼–è¯‘æˆåŠŸ-æ•ˆæœå›¾"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/upgrade-xxl-job.assets/1579252048628.png" alt="æ‹·åŒ…åˆ°ä¸€ä¸ªç›®å½•ä¸­"></p>
<p>å°†å…¶ä»å®¹å™¨ä¸­æ‹·è´åˆ°å®¿ä¸»æœºç›®å½•ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/upgrade-xxl-job.assets/1579252125212.png" alt="æ‹·åŒ…åˆ°å®¿ä¸»æœº"></p>
<p>åœæ­¢xxl-jobï¼Œæ›¿æ¢åŸç›¸åº”çš„æ‰€æœ‰jaråŒ…å¹¶é‡æ–°å¯åŠ¨ã€‚</p>
<p><strong>å‡çº§å¤±è´¥</strong></p>
<p>æ›¿æ¢jaråŒ…å¹¶é‡æ–°å¯åŠ¨ï¼Œå‘ç°å¯åŠ¨å¤±è´¥ã€‚ç»åˆ†ææ˜¯ç‰ˆæœ¬ä¹‹é—´ æ•°æ®åº“ çš„è®¾è®¡å‘ç”Ÿè¾ƒå¤§å˜åŒ–ã€‚å› æœªæä¾›æ•°æ®è¿ç§»åŠŸèƒ½ï¼Œé€šè¿‡æ‰‹åŠ¨å¤åˆ¶æ—§ç‰ˆæœ¬çš„æ‰€æœ‰ä»»åŠ¡åˆ°æ–°ç‰ˆæœ¬é‡å»ºä»»åŠ¡ï¼Œå®Œæˆæœ¬æ¬¡å‡çº§è¿‡ç¨‹ã€‚</p>
<h2 id="supervisordé…ç½®"><a href="#supervisordé…ç½®" class="headerlink" title="supervisordé…ç½®"></a>supervisordé…ç½®</h2><p>æ‰§è¡Œå™¨ï¼ˆä½œä¸ºå®¢æˆ·ç«¯ï¼‰ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[program:xxl-job-executor]</span></span><br><span class="line"><span class="attr">command</span>=java -jar /srv/xxl-job-executor-sample-springboot-<span class="number">2.1</span>.<span class="number">2</span>.jar --server.port=<span class="number">10080</span> --xxl.job.executor.ip=<span class="number">10.1</span>.<span class="number">7.211</span>  --xxl.job.executor.port=<span class="number">9999</span> --xxl.job.admin.addresses=https://job.keep.com/xxl-job-admin --xxl.job.executor.appname=xxl-job-executor-<span class="number">7</span>-<span class="number">211</span></span><br><span class="line"><span class="attr">directory</span>=/srv</span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">50</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/xxl-job-executor.log</span><br></pre></td></tr></table></figure>
<p>è°ƒåº¦æœåŠ¡ï¼ˆä½œä¸ºæœåŠ¡ç«¯ï¼‰ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[program:xxl-job-admin_212]</span></span><br><span class="line"><span class="attr">command</span>=java -jar /srv/xxl-target-<span class="number">2.1</span>.<span class="number">2</span>/xxl-job-admin-<span class="number">2.1</span>.<span class="number">2</span>.jar --spring.datasource.url=jdbc:mysql://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">3306</span>/xxl_job?Unicode=<span class="literal">true</span>&amp;characterEncoding=UTF-<span class="number">8</span> --spring.datasource.username=root --spring.datasource.password=mysql@dmin --server.port=<span class="number">8080</span></span><br><span class="line"><span class="attr">directory</span>=/srv</span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">50</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/xxl-job-admin.log</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ä»»åŠ¡è°ƒåº¦</category>
      </categories>
      <tags>
        <tag>Job</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»»åŠ¡è°ƒåº¦</title>
    <url>/task-sheduling/xxl-job/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>åˆ†å¸ƒå¼è°ƒåº¦åœ¨äº’è”ç½‘ä¼ä¸šä¸­å æ®ç€ååˆ†é‡è¦çš„ä½œç”¨ï¼Œå°¤å…¶æ˜¯ç”µå­å•†åŠ¡é¢†åŸŸï¼Œç”±äºå­˜åœ¨æ•°æ®é‡å¤§ã€é«˜å¹¶å‘çš„ç‰¹ç‚¹ï¼Œå¯¹æ•°æ®å¤„ç†çš„è¦æ±‚è¾ƒé«˜ï¼Œæ—¢è¦ä¿è¯é«˜æ•ˆæ€§ï¼Œä¹Ÿè¦ä¿è¯å‡†ç¡®æ€§å’Œå®‰å…¨æ€§ï¼Œç›¸å¯¹æ¯”è¾ƒè€—æ—¶çš„ä¸šåŠ¡é€»è¾‘å¾€å¾€ä¼šä»ä¸­å‰¥ç¦»å¼€æ¥è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚</p>
</blockquote>
<a id="more"></a>
<hr>
<p>ä¸‹åˆ—æ˜¯å‡ æ¬¾ä¼˜ç§€å’Œæå…·æ½œåŠ›çš„å›½äº§å¼€æºåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼š</p>
<p><strong>opencron</strong></p>
<p><a href="https://www.oschina.net/p/opencron" rel="external nofollow noopener noreferrer" target="_blank">opencron</a> æ˜¯ä¸€ä¸ªåŠŸèƒ½å®Œå–„ä¸”é€šç”¨çš„å¼€æºå®šæ—¶ä»»åŠ¡è°ƒåº¦ç³»ç»Ÿï¼Œæ‹¥æœ‰å…ˆè¿›å¯é çš„è‡ªåŠ¨åŒ–ä»»åŠ¡ç®¡ç†è°ƒåº¦åŠŸèƒ½ï¼Œæä¾›å¯æ“ä½œçš„ web å›¾å½¢åŒ–ç®¡ç†æ»¡è¶³å¤šç§åœºæ™¯ä¸‹å„ç§å¤æ‚çš„å®šæ—¶ä»»åŠ¡è°ƒåº¦ï¼ŒåŒæ—¶é›†æˆäº† linux å®æ—¶ç›‘æ§ã€webssh ç­‰åŠŸèƒ½ç‰¹æ€§ã€‚</p>
<p><strong>LTS</strong></p>
<p><a href="https://www.oschina.net/p/lts" rel="external nofollow noopener noreferrer" target="_blank">LTS</a>ï¼Œlight-task-schedulerï¼Œæ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶, æ”¯æŒå®æ—¶ä»»åŠ¡ã€å®šæ—¶ä»»åŠ¡å’Œ Cron ä»»åŠ¡ã€‚æœ‰è¾ƒå¥½çš„ä¼¸ç¼©æ€§å’Œæ‰©å±•æ€§ï¼Œæä¾›å¯¹ Spring çš„æ”¯æŒï¼ˆåŒ…æ‹¬ Xml å’Œæ³¨è§£ï¼‰ï¼Œæä¾›ä¸šåŠ¡æ—¥å¿—è®°å½•å™¨ã€‚æ”¯æŒèŠ‚ç‚¹ç›‘æ§ã€ä»»åŠ¡æ‰§è¡Œç›‘ã€JVM ç›‘æ§ï¼Œæ”¯æŒåŠ¨æ€æäº¤ã€æ›´æ”¹ã€åœæ­¢ä»»åŠ¡ã€‚</p>
<p><strong>xxl-job</strong></p>
<p><a href="https://www.oschina.net/p/xxl-job" rel="external nofollow noopener noreferrer" target="_blank">XXL-JOB</a> æ˜¯ä¸€ä¸ªè½»é‡çº§åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦æ¡†æ¶ï¼Œæ”¯æŒé€šè¿‡ Web é¡µé¢å¯¹ä»»åŠ¡è¿›è¡Œ CRUD æ“ä½œï¼Œæ”¯æŒåŠ¨æ€ä¿®æ”¹ä»»åŠ¡çŠ¶æ€ã€æš‚åœ/æ¢å¤ä»»åŠ¡ï¼Œä»¥åŠç»ˆæ­¢è¿è¡Œä¸­ä»»åŠ¡ï¼Œæ”¯æŒåœ¨çº¿é…ç½®è°ƒåº¦ä»»åŠ¡å…¥å‚å’Œåœ¨çº¿æŸ¥çœ‹è°ƒåº¦ç»“æœã€‚</p>
<hr>
<h2 id="XXL-JOB"><a href="#XXL-JOB" class="headerlink" title="XXL-JOB"></a>XXL-JOB</h2><h3 id="æ–°å¢æ‰§è¡Œå™¨"><a href="#æ–°å¢æ‰§è¡Œå™¨" class="headerlink" title="æ–°å¢æ‰§è¡Œå™¨"></a>æ–°å¢æ‰§è¡Œå™¨</h3><ul>
<li><p>ç¼–è¯‘æ‰§è¡Œå™¨é¡¹ç›®</p>
<p>æºç ï¼š<a href="https://github.com/xuxueli/xxl-job/" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/xuxueli/xxl-job/</a></p>
</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/xxl-job.assets/1558508900842.png" alt="1558508900842"></p>
<p>xxl-job-executor-sampleæ˜¯é€šè¿‡æºç é…ç½®ã€ç¼–è¯‘åçš„ç»„ä»¶xxl-job-executor-sample-springbootè¿è¡Œæ—¶æä¾›çš„ä¸€ä¸ªserverï¼Œæºç ä¸­ä¿®æ”¹çš„ä½ç½®å¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/xxl-job.assets/1558509187649.png" alt="1558509187649"></p>
<p>æ‰§è¡Œ<code>mvn clean package</code>ç¼–è¯‘æ‰“åŒ…å¯ç”Ÿæˆjaræ–‡ä»¶</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/xxl-job.assets/1558509314582.png" alt="1558509314582"></p>
<p>ç„¶åï¼Œé€šè¿‡supervisorä½¿å…¶åœ¨åå°æŒç»­è¿è¡Œã€‚</p>
<ul>
<li>æ·»åŠ æ‰§è¡Œå™¨åˆ°xxl-job-admin</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/xxl-job.assets/1558512727527.png" alt="1558512727527"></p>
<p>æ³¨æ„ï¼šAppNameä¸ç¼–è¯‘æºç æ—¶é…ç½®çš„appnameä¸€è‡´ï¼Œæ‰å¯ä»¥è‡ªåŠ¨è·å–æœºå™¨åœ°å€ï¼ˆç«¯å£ï¼‰ã€‚å¦åˆ™ï¼Œæ‰‹åŠ¨å½•å…¥ã€‚</p>
<hr>
<h3 id="æ·»åŠ ç¤ºä¾‹ä»»åŠ¡"><a href="#æ·»åŠ ç¤ºä¾‹ä»»åŠ¡" class="headerlink" title="æ·»åŠ ç¤ºä¾‹ä»»åŠ¡"></a>æ·»åŠ ç¤ºä¾‹ä»»åŠ¡</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/xxl-job.assets/1558511698496.png" alt="1558511698496"></p>
<p>ä»»åŠ¡è®¾ç½®</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/xxl-job.assets/1558511749220.png" alt="1558511749220"></p>
<p><code>0 * * * * ? *</code>è¡¨ç¤ºæ¯åˆ†é’Ÿï¼ˆ0ç§’æ—¶ï¼‰è°ƒåº¦ä¸€æ¬¡ï¼Œå› é—´éš”çŸ­ï¼Œä¸è®¾ç½®ä»»åŠ¡è¶…æ—¶åŠå¤±è´¥é‡è¯•ã€‚ä»»åŠ¡å‚æ•°å†…å¡«å¤šè¡Œä¹Ÿæ˜¯ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼ˆ$1ï¼‰ä¼ é€’ç»™è„šæœ¬çš„ã€‚è·¯ç”±ç­–ç•¥â€œç¬¬ä¸€ä¸ªâ€è¡¨ç¤ºæ€»æ˜¯åœ¨ç¬¬ä¸€ä¸ªOnLineæœºå™¨ä¸Šæ‰§è¡Œã€‚</p>
<p>è¯¥ä»»åŠ¡çš„ç¤ºä¾‹è„šæœ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"xxl-job: hello shell"</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"è„šæœ¬ä½ç½®ï¼š<span class="variable">$0</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"ä»»åŠ¡å‚æ•°ï¼š<span class="variable">$1</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"åˆ†ç‰‡åºå· = <span class="variable">$2</span>"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"åˆ†ç‰‡æ€»æ•° = <span class="variable">$3</span>"</span></span><br><span class="line"></span><br><span class="line">failed=0</span><br><span class="line">succeed=0</span><br><span class="line">failed_urls=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> url <span class="keyword">in</span> <span class="variable">$1</span> <span class="comment"># å¯¹æ¯ä¸€è¡Œçš„url</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"current url: [<span class="variable">$url</span>]"</span></span><br><span class="line">  status_code=$(curl -s -o /dev/null -w <span class="string">"%&#123;http_code&#125;"</span> <span class="variable">$url</span>) <span class="comment"># æ£€æµ‹httpå“åº”çŠ¶æ€ç </span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"status_code: <span class="variable">$status_code</span>"</span></span><br><span class="line">  <span class="keyword">if</span> [ <span class="string">"<span class="variable">$status_code</span>"</span> -ne 200 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"Failed: Access <span class="variable">$url</span> failed."</span></span><br><span class="line">    failed_urls=<span class="string">"<span class="variable">$failed_urls</span>,<span class="variable">$url</span>"</span></span><br><span class="line">    <span class="built_in">let</span> failed=failed+1 <span class="comment"># å¤±è´¥+1</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">let</span> succeed=succeed+1 <span class="comment"># æˆåŠŸ+1</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Good bye!"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Total: <span class="variable">$failed</span> failed <span class="variable">$succeed</span> succeed"</span> <span class="comment"># æ—¥å¿—ä¸­æ‰“å°ç»Ÿè®¡ç»“æœ</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$failed</span> -lt 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Failed Urls: <span class="variable">$failed_urls</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> <span class="variable">$failed</span> <span class="comment"># é€€å‡ºçŠ¶æ€å€¼ï¼Œé0è¡¨ç¤ºå¤±è´¥</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœæ‰§è¡ŒçŠ¶æ€å¤±è´¥ï¼Œå°†å‘å‡ºæŠ¥è­¦é‚®ä»¶ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/xxl-job.assets/1558512929701.png" alt="1558512929701"></p>
]]></content>
      <categories>
        <category>ä»»åŠ¡è°ƒåº¦</category>
      </categories>
      <tags>
        <tag>Job</tag>
      </tags>
  </entry>
  <entry>
    <title>K8sç¬”è®°</title>
    <url>/2020/K8s-learning/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p><em><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank">Kubernetes (K8s)</a> is an open-source system for automating deployment, scaling, and management of containerized applications.</em></p>
<p><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank"><strong>Kubernetes (K8s)</strong></a> æ˜¯ä¸€ä¸ªå¼€æºå®¹å™¨ç¼–æ’å¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œæ‰©å±•å’Œç®¡ç†ã€‚</p>
</blockquote>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/container_evolution.svg" alt="Deployment evolution"></p>
<a id="more"></a>
<p>åº”ç”¨éƒ¨ç½²æ–¹å¼çš„æ¼”å˜å†å²ï¼šç‰©ç†æœºéƒ¨ç½²  =&gt; è™šæ‹Ÿæœºéƒ¨ç½²  =&gt; å®¹å™¨åŒ–éƒ¨ç½²*</p>
<p>æ—©æœŸçš„åº”ç”¨æ˜¯ç›´æ¥éƒ¨ç½²åœ¨ç‰©ç†æœºçš„ï¼Œèµ„æºä½¿ç”¨ç‡ä¸é«˜ã€‚</p>
<p>ä¸¾ä¾‹æ¥è¯´ï¼Œæ¯”å¦‚200qpsï¼ŒåŒ…å«100ä¸ªè¯·æ±‚é™æ€èµ„æºçš„è¯·æ±‚å’Œ100ä¸ªåŠ¨æ€èµ„æºçš„è¯·æ±‚ï¼Œå‡è®¾é™æ€è¯·æ±‚å ç”¨2Må†…å­˜ï¼ŒåŠ¨æ€è¯·æ±‚å ç”¨10Må†…å­˜ï¼Œé‚£ä¹ˆ200qpså ç”¨å†…å­˜çº¦1200MBã€‚å¦‚æœæœåŠ¡å™¨å†…å­˜æ˜¯4GBï¼Œé‚£æœ€é«˜å¯ä»¥600qpså·¦å³ï¼Œå¦‚æœè€ƒè™‘CPUã€å¸¦å®½åŠå…¶ä»–èµ„æºçš„å ç”¨ï¼Œå¯èƒ½å®é™…æœ€å¤šæ”¯æŒ300qpsï¼ŒæŒ‰300qpsçš„è¯ï¼Œå®é™…å†…å­˜åˆ©ç”¨ç‡å°±ä¸é«˜äº†ã€‚</p>
<p>è™šæ‹ŸæœºæŠ€æœ¯çš„å‡ºç°ï¼Œå¯ä»¥å°†é«˜è§„æ ¼çš„ç‰©ç†æœåŠ¡å™¨éš”ç¦»æˆå¤šä¸ªå°è§„æ ¼çš„è™šæ‹Ÿæœºï¼Œèƒ½æ›´å¥½åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€‚è€Œä¸”ï¼Œè™šæ‹Ÿæœºä¹‹é—´æœ‰ä¸¥æ ¼çš„éš”ç¦»ï¼Œä¸ºä¸åŒçš„åº”ç”¨æä¾›äº†ç›¸å¯¹ç‹¬ç«‹çš„è¿è¡Œç¯å¢ƒï¼Œä»…é€šè¿‡ç½‘ç»œç›¸äº’è®¿é—®ï¼Œå®‰å…¨æ€§ä¹Ÿæ›´é«˜äº†ã€‚</p>
<p>å®¹å™¨æŠ€æœ¯ï¼Œæ˜¯ä¸€ç§æ›´åŠ è½»é‡çº§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚å°½ç®¡åœ¨èµ„æºéš”ç¦»ä¸Šä¸å¦‚è™šæ‹Ÿæœºä¸¥æ ¼ï¼Œä½†å…¶å®ƒæ–¹é¢çš„ä¼˜åŠ¿ä¹Ÿå¾ˆæ˜æ˜¾ã€‚</p>
<p>å®¹å™¨å¯ä»¥è¿è¡Œåœ¨è™šæ‹Ÿæœºé‡Œé¢ã€‚</p>
<p>ä¼¼ä¹å¯ä»¥è¿™ä¹ˆç†è§£ï¼Œä»¥OpenStackä¸ºä»£è¡¨çš„äº‘è®¡ç®—æŠ€æœ¯äº§ç”Ÿäº†å…¬æœ‰äº‘ï¼Œè€Œä»¥K8sä¸ºä»£è¡¨çš„å®¹å™¨äº‘æŠ€æœ¯åˆ™åœ¨å…¬æœ‰äº‘æä¾›çš„åŸºç¡€è®¾æ–½ä¹‹ä¸Šæ„å»ºå‡ºäº†å®¹å™¨äº‘ã€‚</p>
<p>æ¶æ„ç®€å›¾ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/k8s-arch.jpg" alt="img"></p>
<p>masterèŠ‚ç‚¹åŒ…å«çš„ç»„ä»¶ï¼š</p>
<p><strong>API Server</strong>ï¼šæ˜¯k8sæœ€æ ¸å¿ƒçš„ç»„ä»¶ï¼Œç»Ÿä¸€çš„èµ„æºæ“ä½œå…¥å£ï¼ŒåŒ…æ‹¬æä¾›è®¤è¯ã€æˆæƒã€è®¿é—®æ§åˆ¶ã€APIæ³¨å†Œå’Œ å‘ç°ç­‰æœºåˆ¶ï¼Œå…¶ä»–çš„ç»„ä»¶è¿è¡Œä¾èµ–äºapi serverï¼Œé€šè¿‡apiæ¥å£å¯ä»¥å¯¹k8sèµ„æºå¯¹è±¡è¿›è¡Œcurdä»¥åŠç›‘æ§ï¼Œä¹Ÿèƒ½è¿›è¡Œå¥åº·ï¼Œæ—¥å¿—ç­‰ç›‘æ§ã€‚</p>
<p><strong>Scheduler</strong>ï¼šå±äºè°ƒåº¦å™¨çš„è§’è‰²ï¼Œè´Ÿè´£å†³ç­–podæŒ‰ç…§å“ªç§ç®—æ³•è°ƒåº¦åˆ°å“ªä¸ªnodeä¸Šï¼Œå®ƒä¼šæŠŠå†³ç­–çš„ä¿¡æ¯é€šè¿‡ap iserverå‘é€ç»™kubeletï¼Œè®©kubeletæ‰§è¡Œã€‚</p>
<p><strong>Controller-Manger</strong>ï¼šä¸ºäº†ç®¡ç†é›†ç¾¤ä¸­ä¸åŒçš„èµ„æºï¼Œk8sä¸ºä¸åŒçš„èµ„æºå»ºç«‹äº†å¯¹åº”çš„controllerã€‚k8sä¸­åˆ†äº†8ä¸ªcontroller,ä¸åŒçš„ Controller è´Ÿè´£å¯¹ä¸åŒèµ„æºçš„ç›‘æ§å’Œç®¡ç†ã€‚</p>
<p><strong>ETCD</strong> ä¸€èˆ¬ä¹Ÿéƒ¨ç½²åœ¨masterèŠ‚ç‚¹ä¸Šï¼Œæ˜¯k8sçš„key-valueæ•°æ®åº“ï¼Œé›†ç¾¤çš„çŠ¶æ€ä¿¡æ¯éƒ½æŒä¹…åŒ–å­˜å‚¨åœ¨ETCDä¸­ã€‚</p>
<p>workerèŠ‚ç‚¹åŒ…å«çš„ç»„ä»¶ï¼š</p>
<p><strong>kubelet</strong>ï¼šçœŸæ­£çš„å®¹å™¨ç®¡ç†å’Œç»´æŠ¤è€…ï¼Œå®ƒæ ¹æ®masterèŠ‚ç‚¹ä¸Šshceduleçš„è°ƒåº¦å†³ç­–å»çœŸæ­£æ§åˆ¶èŠ‚ç‚¹ä¸Šçš„å®¹å™¨ï¼Œç»´æŠ¤ Container çš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒæ—¶ä¹Ÿè´Ÿè´£å­˜å‚¨ï¼ˆCSIï¼‰å’Œç½‘ç»œï¼ˆCNIï¼‰çš„ç®¡ç†ã€‚</p>
<p><strong>kube-proxy</strong>ï¼šé›†ç¾¤å†…éƒ¨é€šè¿‡kube-proxyè®¿é—®å…¶ä»–pod,å…¶ä¸»è¦åŠŸèƒ½æ˜¯æä¾›é›†ç¾¤å†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p>
<h1 id="å®‰è£…K8s"><a href="#å®‰è£…K8s" class="headerlink" title="å®‰è£…K8s"></a>å®‰è£…K8s</h1><p>å°è¯•è¿‡ä»¥ä¸‹å››ç§å®‰è£…æ–¹å¼ï¼škubeadmï¼Œrancherï¼Œrke åŠ kubesprayã€‚</p>
<h2 id="kubeadm"><a href="#kubeadm" class="headerlink" title="kubeadm"></a>kubeadm</h2><p>å®˜ç½‘æä¾›çš„æ–¹æ³•ã€‚å¤§è‡´è¿‡ç¨‹æ˜¯ï¼š</p>
<ul>
<li><p>åˆå§‹åŒ–ç¯å¢ƒï¼Œå®‰è£…docker</p>
</li>
<li><p>å…ˆåœ¨å„ä¸ªèŠ‚ç‚¹yumå®‰è£…kubeletã€kubeadmã€kubectl</p>
</li>
<li><p>åœ¨ä¸€ä¸ªmasterèŠ‚ç‚¹kubeadm init è·å¾—kubeadm joiné›†ç¾¤çš„å‘½ä»¤</p>
</li>
<li>åœ¨å…¶å®ƒèŠ‚ç‚¹ä¸Šæ‰§è¡Œkubeadm joinå‘½ä»¤åŠ å…¥é›†ç¾¤</li>
</ul>
<h2 id="rancher"><a href="#rancher" class="headerlink" title="rancher"></a>rancher</h2><p>å…ˆé€šè¿‡dockerå¯åŠ¨ä¸€ä¸ªrancherç®¡ç†ç•Œé¢ï¼Œç„¶åä»ç®¡ç†ç•Œé¢å¤åˆ¶æ·»åŠ èŠ‚ç‚¹çš„å‘½ä»¤ï¼Œåœ¨å¾…åŠ å…¥é›†ç¾¤çš„èŠ‚ç‚¹ä¸Šæ‰§è¡Œå‘½ä»¤ï¼Œé€ä¸ªæ·»åŠ èŠ‚ç‚¹åˆ›å»ºK8sé›†ç¾¤ã€‚ç•Œé¢å¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551840932234.png" alt="1551840932234"></p>
<h2 id="rke"><a href="#rke" class="headerlink" title="rke"></a>rke</h2><p>rancherå®˜æ–¹æä¾›çš„ä¸€ä¸ªå®‰è£…å·¥å…·ï¼Œé€šè¿‡ä¸€ä¸ªèŠ‚ç‚¹é…ç½®æ–‡ä»¶æè¿°é›†ç¾¤å„ä¸ªèŠ‚ç‚¹ä¿¡æ¯ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.79</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,worker,etcd]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.80</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,worker,etcd]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.81</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,etcd]</span></span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rke up --config  &lt;èŠ‚ç‚¹é…ç½®æ–‡ä»¶&gt;</span><br></pre></td></tr></table></figure>
<p>å³å¯å®Œæˆé›†ç¾¤çš„åˆæ­¥å®‰è£…ï¼Œç›¸æ¯”å…¶å®ƒæ–¹å¼æ›´å¿«æ·ï¼Œä½†èƒ½å®‰è£…çš„ç‰ˆæœ¬æ»åäºå®˜ç½‘ï¼Œæœ€æ–°çš„K8sç‰ˆæœ¬å¯èƒ½å°šæœªè¢«rancheræ”¯æŒã€‚</p>
<p>rancheré›†ç¾¤ç®¡ç†ç•Œé¢ç±»ä¼¼ä¸‹å›¾ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551841031094.png" alt="1551841031094"></p>
<p>3ä¸ªmasterã€etcd + 3ä¸ªnode:</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551844009517.png" alt="1551844009517"></p>
<h2 id="kubespray"><a href="#kubespray" class="headerlink" title="kubespray"></a>kubespray</h2><blockquote>
<p>å®˜æ–¹github:  <a href="https://github.com/kubernetes-sigs/kubespray/tree/release-2.14" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kubernetes-sigs/kubespray/tree/release-2.14</a></p>
</blockquote>
<p>è¿™æ˜¯ä¸€ç§é€šè¿‡ansible-playbookè‡ªåŠ¨å®‰è£…K8sçš„æ–¹å¼ã€‚é»˜è®¤å’Œkubeadmä¸€æ ·éœ€è¦èƒ½è®¿é—®å›½å¤–ç½‘ç«™ï¼Œå¦åˆ™æœ‰ç‚¹é•œåƒæˆ–äºŒè¿›åˆ¶æ–‡ä»¶è·å–ä¸åˆ°ã€‚ä¹Ÿå¯è‡ªè¡Œä¿®æ”¹ç›¸å…³åœ°å€ï¼Œä¸»è¦æ¶‰åŠä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š</p>
<ul>
<li>roles/download/defaults/main.yml</li>
<li><p>inventory/sample/group_vars/k8s-cluster/k8s-cluster.yml</p>
</li>
<li><p>roles/kubespray-defaults/defaults/main.yaml</p>
</li>
</ul>
<p>ä¿®æ”¹å…¶ä¸­çš„åœ°å€ï¼Œæ›¿æ¢æˆå›½å†…èƒ½è®¿é—®åˆ°çš„é•œåƒæºï¼Œå®‰è£…åº”è¯¥å°±èƒ½é¡ºåˆ©è¿›è¡Œäº†ã€‚é»˜è®¤ä¼šä¸€å¹¶å®‰è£…dashboardã€‚</p>
<p>å…¶ä¸»æœºæ¸…å•ï¼ˆinventoryï¼‰æ–‡ä»¶æ ¼å¼å¦‚ä¸‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">[all]</span></span><br><span class="line"><span class="string">m01</span>    <span class="string">ansible_host=192.168.19.135</span> <span class="string">ip=192.168.19.135</span></span><br><span class="line"><span class="string">m02</span>    <span class="string">ansible_host=192.168.19.136</span> <span class="string">ip=192.168.19.136</span></span><br><span class="line"><span class="string">m03</span>    <span class="string">ansible_host=192.168.19.137</span> <span class="string">ip=192.168.19.137</span></span><br><span class="line"><span class="string">n01</span>    <span class="string">ansible_host=192.168.19.138</span> <span class="string">ip=192.168.19.138</span></span><br><span class="line"><span class="string">n02</span>    <span class="string">ansible_host=192.168.19.139</span> <span class="string">ip=192.168.19.139</span></span><br><span class="line"><span class="string">n03</span>    <span class="string">ansible_host=192.168.19.140</span> <span class="string">ip=192.168.19.140</span></span><br><span class="line"></span><br><span class="line"><span class="string">[kube-master]</span></span><br><span class="line"><span class="string">m01</span></span><br><span class="line"><span class="string">m02</span></span><br><span class="line"><span class="string">m03</span></span><br><span class="line"></span><br><span class="line"><span class="string">[etcd]</span></span><br><span class="line"><span class="string">m01</span></span><br><span class="line"><span class="string">m02</span></span><br><span class="line"><span class="string">m03</span></span><br><span class="line"></span><br><span class="line"><span class="string">[kube-node]</span></span><br><span class="line"><span class="string">n01</span></span><br><span class="line"><span class="string">n02</span></span><br><span class="line"><span class="string">n03</span></span><br><span class="line"></span><br><span class="line"><span class="string">[calico-rr]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[k8s-cluster:children]</span></span><br><span class="line"><span class="string">kube-master</span></span><br><span class="line"><span class="string">kube-node</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115174122445.png" alt="image-20201115174122445" style="zoom:50%;"></p>
<p>å®‰è£…å‘½ä»¤</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># cd kubespray</span></span><br><span class="line">[root@localhost kubespray]<span class="comment"># cp -r inventory/sample inventory/mycluster</span></span><br><span class="line">(ä¿®æ”¹æŸäº›æ— æ³•è·å–åˆ°çš„é•œåƒåœ°å€)</span><br><span class="line">[root@localhost kubespray]<span class="comment"># pip install -U pip</span></span><br><span class="line">[root@localhost kubespray]<span class="comment"># pip install -r requirements.txt</span></span><br><span class="line">[root@localhost kubespray]<span class="comment"># ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root cluster.yml</span></span><br></pre></td></tr></table></figure>
<h1 id="å®‰è£…-kubernetes-dashboard"><a href="#å®‰è£…-kubernetes-dashboard" class="headerlink" title="å®‰è£… kubernetes dashboard"></a>å®‰è£… kubernetes dashboard</h1><blockquote>
<p>å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼š<a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>
</blockquote>
<p>åœ¨é›†ç¾¤å·²ç»å®‰è£…æˆåŠŸçš„å‰æä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>
<p>è·å–ç™»å½•ä»¤ç‰Œ</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep kubernetes-dashboard-token|awk <span class="string">'&#123;print $1&#125;'</span>)|grep token:|awk <span class="string">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure>
<p>è®¿é—®</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">https://&lt;masterèŠ‚ç‚¹ip&gt;:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108222956832.png" alt="image-20201108222956832"></p>
<p>æˆ–è€…ç»‘å®šåŸŸåè®¿é—®ï¼ˆæ¶‰åŠingressï¼‰</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108223045757.png" alt="image-20201108223045757"></p>
<p>é¦–é¡µ</p>
<hr>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114225536299.png" alt="image-20201114225536299"></p>
<p>mywebåç§°ç©ºé—´</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114225653905.png" alt="image-20201114225653905"></p>
<h1 id="K8såŸºç¡€"><a href="#K8såŸºç¡€" class="headerlink" title="K8såŸºç¡€"></a>K8såŸºç¡€</h1><p>æœ¬æ–‡æ¶‰åŠK8sæ“ä½œçš„éƒ¨åˆ†æ˜¯åœ¨å¦‚ä¸‹K8sç¯å¢ƒä¸­è¿›è¡Œçš„ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">[root@m01 ~]<span class="comment"># kubectl get nodes -o wide</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114215421923.png" alt="image-20201114215421923"></p>
<h2 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h2><p>Kubernetesé‡Œçš„æ‰€æœ‰èµ„æºå¯¹è±¡éƒ½å¯ä»¥é‡‡ç”¨YAMLæˆ–è€…JSONæ ¼å¼çš„æ–‡ä»¶æ¥å®šä¹‰æˆ–æè¿°ã€‚</p>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114220715630.png" alt="image-20201114220715630" style="zoom: 50%;"></p>
<p>Podæ˜¯Kubernetesæœ€é‡è¦çš„åŸºæœ¬æ¦‚å¿µã€‚</p>
<p>æ¯ä¸ªPodéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸ºâ€œæ ¹å®¹å™¨â€çš„Pauseå®¹å™¨ã€‚Pauseå®¹å™¨å¯¹åº”çš„é•œåƒå±äºKuberneteså¹³å°çš„ä¸€éƒ¨åˆ†ï¼Œé™¤äº†Pauseå®¹å™¨ï¼Œæ¯ä¸ªPodè¿˜åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªç´§å¯†ç›¸å…³çš„ç”¨æˆ·ä¸šåŠ¡å®¹å™¨ã€‚</p>
<p>åœ¨åˆå§‹åŒ–æ¯ä¸€ä¸ªpodå®¹å™¨çš„æ—¶å€™ï¼Œéƒ½ä¼šç”Ÿæˆä¸€ä¸ªpauseå®¹å™¨ã€‚è¿™ä¸ªå®¹å™¨ä½¿å¾—podé‡Œé¢çš„å­å®¹å™¨èƒ½å¤Ÿå…±äº«ç½‘ç»œå’Œå­˜å‚¨ï¼Œæ–¹ä¾¿å†…éƒ¨å®¹å™¨ä¹‹é—´çš„è°ƒç”¨ã€‚</p>
<font color="red">ä¸ºä»€ä¹ˆKubernetesæŠŠPodè®¾è®¡æˆè¿™æ ·çš„ç‰¹æ®Šç»“æ„ï¼Ÿ</font>

<ul>
<li><p>åœ¨ä¸€ç»„å®¹å™¨ä½œä¸ºä¸€ä¸ªå•å…ƒçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éš¾ä»¥ç®€å•åœ°å¯¹â€œæ•´ä½“â€è¿›è¡Œåˆ¤æ–­åŠæœ‰æ•ˆåœ°è¡ŒåŠ¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªå®¹å™¨æ­»äº¡äº†ï¼Œæ­¤æ—¶ç®—æ˜¯æ•´ä½“æ­»äº¡ä¹ˆï¼Ÿæ˜¯N/Mçš„æ­»äº¡ç‡ä¹ˆï¼Ÿå¼•å…¥ä¸šåŠ¡æ— å…³å¹¶ä¸”ä¸æ˜“æ­»äº¡çš„Pauseå®¹å™¨ä½œä¸ºPodçš„æ ¹å®¹å™¨ï¼Œä»¥å®ƒçš„çŠ¶æ€ä»£è¡¨æ•´ä¸ªå®¹å™¨ç»„çš„çŠ¶æ€ï¼Œå°±ç®€å•ã€å·§å¦™åœ°è§£å†³äº†è¿™ä¸ªéš¾é¢˜ã€‚</p>
</li>
<li><p>Podé‡Œçš„å¤šä¸ªä¸šåŠ¡å®¹å™¨å…±äº«Pauseå®¹å™¨çš„IPï¼Œå…±äº«Pauseå®¹å™¨æŒ‚æ¥çš„Volumeï¼Œè¿™æ ·æ—¢ç®€åŒ–äº†å¯†åˆ‡å…³è”çš„ä¸šåŠ¡å®¹å™¨ä¹‹é—´çš„é€šä¿¡é—®é¢˜ï¼Œä¹Ÿå¾ˆå¥½åœ°è§£å†³äº†å®ƒä»¬ä¹‹é—´çš„æ–‡ä»¶å…±äº«é—®é¢˜ã€‚</p>
</li>
</ul>
<p>åœ¨Kubernetesç³»ç»Ÿä¸­å¯¹é•¿æ—¶é—´è¿è¡Œå®¹å™¨çš„è¦æ±‚æ˜¯ï¼šå…¶ä¸»ç¨‹åºéœ€è¦ä¸€ç›´åœ¨å‰å°æ‰§è¡Œã€‚å¯¹äºæ— æ³•æ”¹é€ ä¸ºå‰å°æ‰§è¡Œçš„åº”ç”¨ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨å¼€æºå·¥å…·Supervisorè¾…åŠ©è¿›è¡Œå‰å°è¿è¡Œçš„åŠŸèƒ½ã€‚Supervisoræä¾›äº†ä¸€ç§å¯ä»¥åŒæ—¶å¯åŠ¨å¤šä¸ªåå°åº”ç”¨ï¼Œå¹¶ä¿æŒSupervisorè‡ªèº«åœ¨å‰å°æ‰§è¡Œçš„æœºåˆ¶ï¼Œå¯ä»¥æ»¡è¶³Kuberneteså¯¹å®¹å™¨çš„å¯åŠ¨è¦æ±‚ã€‚</p>
<p>Pod IP</p>
<p>Kubernetesä¸ºæ¯ä¸ªPodéƒ½åˆ†é…äº†å”¯ä¸€çš„IPåœ°å€ï¼Œç§°ä¹‹ä¸ºPod IPï¼Œä¸€ä¸ªPodé‡Œçš„å¤šä¸ªå®¹å™¨å…±äº«Pod IPåœ°å€ã€‚Kubernetesè¦æ±‚åº•å±‚ç½‘ç»œæ”¯æŒé›†ç¾¤å†…ä»»æ„ä¸¤ä¸ªPodä¹‹é—´çš„TCP/IPç›´æ¥é€šä¿¡ï¼Œè¿™é€šå¸¸é‡‡ç”¨è™šæ‹ŸäºŒå±‚ç½‘ç»œæŠ€æœ¯æ¥å®ç°ï¼Œä¾‹å¦‚Flannelã€Open vSwitchç­‰ï¼Œå› æ­¤åœ¨Kubernetesé‡Œä¸€ä¸ªPodé‡Œçš„å®¹å™¨ä¸å¦å¤–ä¸»æœºä¸Šçš„Podå®¹å™¨èƒ½å¤Ÿç›´æ¥é€šä¿¡ã€‚</p>
<p>Podäº‹ä»¶</p>
<p>Eventæ˜¯ä¸€ä¸ªäº‹ä»¶çš„è®°å½•ï¼Œè®°å½•äº†äº‹ä»¶çš„æœ€æ—©äº§ç”Ÿæ—¶é—´ã€æœ€åé‡ç°æ—¶é—´ã€é‡å¤æ¬¡æ•°ã€å‘èµ·è€…ã€ç±»å‹ï¼Œä»¥åŠå¯¼è‡´æ­¤äº‹ä»¶çš„åŸå› ç­‰ä¼—å¤šä¿¡æ¯ã€‚</p>
<p>Podèµ„æºé…é¢</p>
<p>Kubernetesé‡Œé€šå¸¸ä»¥åƒåˆ†ä¹‹ä¸€çš„CPUé…é¢ä¸ºæœ€å°å•ä½ï¼Œç”¨mæ¥è¡¨ç¤ºã€‚é€šå¸¸ä¸€ä¸ªå®¹å™¨çš„CPUé…é¢è¢«å®šä¹‰ä¸º100ï½300mï¼Œå³å ç”¨0.1ï½0.3ä¸ªCPUã€‚</p>
<p>åœ¨Kubernetesé‡Œï¼Œä¸€ä¸ªè®¡ç®—èµ„æºè¿›è¡Œé…é¢é™å®šæ—¶éœ€è¦è®¾å®šä»¥ä¸‹ä¸¤ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>Requestsï¼šè¯¥èµ„æºçš„æœ€å°ç”³è¯·é‡ï¼Œç³»ç»Ÿå¿…é¡»æ»¡è¶³è¦æ±‚ã€‚</li>
<li>Limitsï¼šè¯¥èµ„æºæœ€å¤§å…è®¸ä½¿ç”¨çš„é‡ï¼Œä¸èƒ½è¢«çªç ´ï¼Œå½“å®¹å™¨è¯•å›¾ä½¿ç”¨è¶…è¿‡è¿™ä¸ªé‡çš„èµ„æºæ—¶ï¼Œå¯èƒ½ä¼šè¢«Kubernetesâ€œæ€æ‰â€å¹¶é‡å¯ã€‚</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114221430793.png" alt="image-20201114221430793" style="zoom: 67%;"></p>
<p>æ™®é€šPod</p>
<p>Podå…¶å®æœ‰ä¸¤ç§ç±»å‹ï¼šæ™®é€šçš„PodåŠé™æ€Podï¼ˆStatic Podï¼‰ã€‚åè€…æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå¹¶æ²¡è¢«å­˜æ”¾åœ¨Kubernetesçš„etcdå­˜å‚¨é‡Œï¼Œè€Œæ˜¯è¢«å­˜æ”¾åœ¨æŸä¸ªå…·ä½“çš„Nodeä¸Šçš„ä¸€ä¸ªå…·ä½“æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”åªåœ¨æ­¤Nodeä¸Šå¯åŠ¨ã€è¿è¡Œã€‚è€Œæ™®é€šçš„Podä¸€æ—¦è¢«åˆ›å»ºï¼Œå°±ä¼šè¢«æ”¾å…¥etcdä¸­å­˜å‚¨ï¼Œéšåä¼šè¢«Kubernetes Masterè°ƒåº¦åˆ°æŸä¸ªå…·ä½“çš„Nodeä¸Šå¹¶è¿›è¡Œç»‘å®šï¼ˆBindingï¼‰ï¼Œéšåè¯¥Podè¢«å¯¹åº”çš„Nodeä¸Šçš„kubeletè¿›ç¨‹å®ä¾‹åŒ–æˆä¸€ç»„ç›¸å…³çš„Dockerå®¹å™¨å¹¶å¯åŠ¨ã€‚åœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œå½“Podé‡Œçš„æŸä¸ªå®¹å™¨åœæ­¢æ—¶ï¼ŒKubernetesä¼šè‡ªåŠ¨æ£€æµ‹åˆ°è¿™ä¸ªé—®é¢˜å¹¶ä¸”é‡æ–°å¯åŠ¨è¿™ä¸ªPodï¼ˆé‡å¯Podé‡Œçš„æ‰€æœ‰å®¹å™¨ï¼‰ï¼Œå¦‚æœPodæ‰€åœ¨çš„Nodeå®•æœºï¼Œå°±ä¼šå°†è¿™ä¸ªNodeä¸Šçš„æ‰€æœ‰Podé‡æ–°è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114221127406.png" alt="image-20201114221127406" style="zoom: 67%;"></p>
<p>é™æ€Pod</p>
<blockquote>
<p>é™æ€Podæ˜¯ç”±kubeletè¿›è¡Œç®¡ç†çš„ä»…å­˜åœ¨äºç‰¹å®šNodeä¸Šçš„Podã€‚å®ƒä»¬ä¸èƒ½é€šè¿‡API Serverè¿›è¡Œç®¡ç†ï¼Œæ— æ³•ä¸ReplicationControllerã€Deploymentæˆ–è€…DaemonSetè¿›è¡Œå…³è”ï¼Œå¹¶ä¸”kubeletæ— æ³•å¯¹å®ƒä»¬è¿›è¡Œå¥åº·æ£€æŸ¥ã€‚é™æ€Podæ€»æ˜¯ç”±kubeletåˆ›å»ºçš„ï¼Œå¹¶ä¸”æ€»åœ¨kubeletæ‰€åœ¨çš„Nodeä¸Šè¿è¡Œã€‚</p>
<p>åˆ›å»ºé™æ€Podæœ‰ä¸¤ç§æ–¹å¼ï¼šé…ç½®æ–‡ä»¶æ–¹å¼å’ŒHTTPæ–¹å¼ã€‚</p>
</blockquote>
<p>Podå†…çš„å­˜å‚¨ä¸é€šä¿¡</p>
<p>å±äºåŒä¸€ä¸ªPodçš„å¤šä¸ªå®¹å™¨åº”ç”¨ä¹‹é—´ç›¸äº’è®¿é—®æ—¶ä»…éœ€è¦é€šè¿‡localhostå°±å¯ä»¥é€šä¿¡ã€‚</p>
<p>åŒä¸€ä¸ªPodä¸­çš„å¤šä¸ªå®¹å™¨èƒ½å¤Ÿå…±äº«Podçº§åˆ«çš„å­˜å‚¨å·Volumeã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115203204927.png" alt="image-20201115203204927" style="zoom:50%;"></p>
<p>Podçš„å‡ ç§çŠ¶æ€</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115205626768.png" alt="image-20201115205626768"></p>
<p>Podçš„é‡å¯ç­–ç•¥åŒ…æ‹¬Alwaysã€OnFailure å’Œ Neverï¼Œé»˜è®¤å€¼ä¸ºAlwaysã€‚</p>
<ul>
<li>Alwaysï¼šå½“å®¹å™¨å¤±æ•ˆæ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ã€‚</li>
<li>OnFailureï¼šå½“å®¹å™¨ç»ˆæ­¢è¿è¡Œä¸”é€€å‡ºç ä¸ä¸º0æ—¶ï¼Œç”±kubeletè‡ªåŠ¨é‡å¯è¯¥å®¹å™¨ã€‚</li>
<li>Neverï¼šä¸è®ºå®¹å™¨è¿è¡ŒçŠ¶æ€å¦‚ä½•ï¼Œkubeletéƒ½ä¸ä¼šé‡å¯è¯¥å®¹å™¨ã€‚</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115210018640.png" alt="image-20201115210018640"></p>
<p>æ¯ç§æ§åˆ¶å™¨å¯¹Podçš„é‡å¯ç­–ç•¥è¦æ±‚å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>RCå’ŒDaemonSetï¼šå¿…é¡»è®¾ç½®ä¸ºAlwaysï¼Œéœ€è¦ä¿è¯è¯¥å®¹å™¨æŒç»­è¿è¡Œã€‚</p>
</li>
<li><p>Jobï¼šOnFailureæˆ–Neverï¼Œç¡®ä¿å®¹å™¨æ‰§è¡Œå®Œæˆåä¸å†é‡å¯ã€‚</p>
</li>
<li>kubeletï¼ˆç®¡ç†é™æ€podæ—¶ï¼‰ï¼šåœ¨Podå¤±æ•ˆæ—¶è‡ªåŠ¨é‡å¯å®ƒï¼Œä¸è®ºå°†RestartPolicyè®¾ç½®ä¸ºä»€ä¹ˆå€¼ï¼Œä¹Ÿä¸ä¼šå¯¹Podè¿›è¡Œå¥åº·æ£€æŸ¥ã€‚</li>
</ul>
<p>Podçš„å¥åº·çŠ¶æ€å¯ä»¥é€šè¿‡ä¸¤ç±»æ¢é’ˆæ¥æ£€æŸ¥ï¼š LivenessProbeå’ŒReadinessProbeï¼Œkubeletå®šæœŸæ‰§è¡Œè¿™ä¸¤ç±»æ¢é’ˆæ¥è¯Šæ–­å®¹å™¨çš„å¥åº·çŠ¶å†µã€‚</p>
<p>ï¼ˆ1ï¼‰LivenessProbeæ¢é’ˆï¼šç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯å¦å­˜æ´»ï¼ˆRunningçŠ¶æ€ï¼‰ï¼Œå¦‚æœLivenessProbeæ¢é’ˆæ¢æµ‹åˆ°å®¹å™¨ä¸å¥åº·ï¼Œåˆ™kubeletå°†æ€æ‰è¯¥å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥åšç›¸åº”çš„å¤„ç†ã€‚å¦‚æœä¸€ä¸ªå®¹å™¨ä¸åŒ…å«LivenessProbeæ¢é’ˆï¼Œé‚£ä¹ˆkubeletè®¤ä¸ºè¯¥å®¹å™¨çš„LivenessProbeæ¢é’ˆè¿”å›çš„å€¼æ°¸è¿œæ˜¯Successã€‚</p>
<p>ï¼ˆ2ï¼‰ReadinessProbeæ¢é’ˆï¼šç”¨äºåˆ¤æ–­å®¹å™¨æœåŠ¡æ˜¯å¦å¯ç”¨ï¼ˆReadyçŠ¶æ€ï¼‰ï¼Œè¾¾åˆ°ReadyçŠ¶æ€çš„Podæ‰å¯ä»¥æ¥æ”¶è¯·æ±‚ã€‚</p>
<p>å¯¹äºè¢«Serviceç®¡ç†çš„Podï¼ŒServiceä¸Pod Endpointçš„å…³è”å…³ç³»ä¹Ÿå°†åŸºäºPodæ˜¯å¦Readyè¿›è¡Œè®¾ç½®ã€‚å¦‚æœåœ¨è¿è¡Œè¿‡ç¨‹ä¸­ReadyçŠ¶æ€å˜ä¸ºFalseï¼Œåˆ™ç³»ç»Ÿè‡ªåŠ¨å°†å…¶ä»Serviceçš„åç«¯Endpointåˆ—è¡¨ä¸­éš”ç¦»å‡ºå»ï¼Œåç»­å†æŠŠæ¢å¤åˆ°ReadyçŠ¶æ€çš„PodåŠ å›åç«¯Endpointåˆ—è¡¨ã€‚è¿™æ ·å°±èƒ½ä¿è¯å®¢æˆ·ç«¯åœ¨è®¿é—®Serviceæ—¶ä¸ä¼šè¢«è½¬å‘åˆ°æœåŠ¡ä¸å¯ç”¨çš„Podå®ä¾‹ä¸Šã€‚</p>
<p>LivenessProbeå’ŒReadinessProbeå‡å¯é…ç½®ä»¥ä¸‹ä¸‰ç§å®ç°æ–¹å¼ã€‚</p>
<p>ï¼ˆ1ï¼‰ExecActionï¼šåœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œå¦‚æœè¯¥å‘½ä»¤çš„è¿”å›ç ä¸º0ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">exec:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/tmp/health</span></span><br><span class="line">    <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>ï¼ˆ2ï¼‰TCPSocketActionï¼šé€šè¿‡å®¹å™¨çš„IPåœ°å€å’Œç«¯å£å·æ‰§è¡ŒTCPæ£€æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹TCPè¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">tcpSocket:</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>ï¼ˆ3ï¼‰HTTPGetActionï¼šé€šè¿‡å®¹å™¨çš„IPåœ°å€ã€ç«¯å£å·åŠè·¯å¾„è°ƒç”¨HTTP Getæ–¹æ³•ï¼Œå¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº200ä¸”å°äº400ï¼Œåˆ™è®¤ä¸ºå®¹å™¨å¥åº·ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/_status/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>å¯¹äºæ¯ç§æ¢æµ‹æ–¹å¼ï¼Œéƒ½éœ€è¦è®¾ç½®initialDelaySecondså’ŒtimeoutSecondsä¸¤ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>initialDelaySecondsï¼šå¯åŠ¨å®¹å™¨åè¿›è¡Œé¦–æ¬¡å¥åº·æ£€æŸ¥çš„ç­‰å¾…æ—¶é—´ï¼Œå•ä½ä¸ºsã€‚</li>
<li>timeoutSecondsï¼šå¥åº·æ£€æŸ¥å‘é€è¯·æ±‚åç­‰å¾…å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºsã€‚å½“è¶…æ—¶å‘ç”Ÿæ—¶ï¼Œkubeletä¼šè®¤ä¸ºå®¹å™¨å·²ç»æ— æ³•æä¾›æœåŠ¡ï¼Œå°†ä¼šé‡å¯è¯¥å®¹å™¨ã€‚</li>
</ul>
<p>Kubernetesçš„ReadinessProbeæœºåˆ¶å¯èƒ½æ— æ³•æ»¡è¶³æŸäº›å¤æ‚åº”ç”¨å¯¹å®¹å™¨å†…æœåŠ¡å¯ç”¨çŠ¶æ€çš„åˆ¤æ–­ã€‚</p>
<p>é€šè¿‡Pod Readiness Gatesæœºåˆ¶ï¼Œç”¨æˆ·å¯ä»¥å°†è‡ªå®šä¹‰çš„ReadinessProbeæ¢æµ‹æ–¹å¼è®¾ç½®åœ¨Podä¸Šï¼Œè¾…åŠ©Kubernetesè®¾ç½®Podä½•æ—¶è¾¾åˆ°æœåŠ¡å¯ç”¨çŠ¶æ€ï¼ˆReadyï¼‰ã€‚ä¸ºäº†ä½¿è‡ªå®šä¹‰çš„ReadinessProbeç”Ÿæ•ˆï¼Œç”¨æˆ·éœ€è¦æä¾›ä¸€ä¸ªå¤–éƒ¨çš„æ§åˆ¶å™¨ï¼ˆControllerï¼‰æ¥è®¾ç½®ç›¸åº”çš„ConditionçŠ¶æ€ã€‚</p>
<h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><p>Namespaceï¼ˆå‘½åç©ºé—´ï¼‰æ˜¯Kubernetesç³»ç»Ÿä¸­çš„å¦ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼ŒNamespaceåœ¨å¾ˆå¤šæƒ…å†µä¸‹ç”¨äºå®ç°å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»ã€‚å¦‚æœä¸ç‰¹åˆ«æŒ‡æ˜Namespaceï¼Œåˆ™ç”¨æˆ·åˆ›å»ºçš„Podã€RCã€Serviceéƒ½å°†è¢«ç³»ç»Ÿåˆ›å»ºåˆ°è¿™ä¸ªé»˜è®¤çš„åä¸ºdefaultçš„Namespaceä¸­ã€‚</p>
<h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><p>Labelï¼ˆæ ‡ç­¾ï¼‰ä¹Ÿæ˜¯Kubernetesç³»ç»Ÿä¸­ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µã€‚</p>
<p>ä¸€ä¸ªLabelæ˜¯ä¸€ä¸ªkey=valueçš„é”®å€¼å¯¹ï¼Œå…¶ä¸­keyä¸valueç”±ç”¨æˆ·è‡ªå·±æŒ‡å®šã€‚Labelå¯ä»¥è¢«é™„åŠ åˆ°å„ç§èµ„æºå¯¹è±¡ä¸Šï¼Œä¾‹å¦‚Nodeã€Podã€Serviceã€RCç­‰ï¼Œä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰ä»»æ„æ•°é‡çš„Labelï¼ŒåŒä¸€ä¸ªLabelä¹Ÿå¯ä»¥è¢«æ·»åŠ åˆ°ä»»æ„æ•°é‡çš„èµ„æºå¯¹è±¡ä¸Šã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure>
<p>ç»™æŸä¸ªèµ„æºå¯¹è±¡å®šä¹‰ä¸€ä¸ªLabelï¼Œå°±ç›¸å½“äºç»™å®ƒæ‰“äº†ä¸€ä¸ªæ ‡ç­¾ï¼Œéšåå¯ä»¥é€šè¿‡Label Selectorï¼ˆæ ‡ç­¾é€‰æ‹©å™¨ï¼‰æŸ¥è¯¢å’Œç­›é€‰æ‹¥æœ‰æŸäº›Labelçš„èµ„æºå¯¹è±¡ã€‚ä¸€äº›å…·ä½“çš„ä¾‹å­ï¼š</p>
<ul>
<li>name = redis-slaveï¼šåŒ¹é…æ‰€æœ‰å…·æœ‰æ ‡ç­¾name=redis-slaveçš„èµ„æºå¯¹è±¡ã€‚</li>
<li>env != productionï¼šåŒ¹é…æ‰€æœ‰ä¸å…·æœ‰æ ‡ç­¾env=productionçš„èµ„æºå¯¹è±¡ï¼Œæ¯”å¦‚env=testå°±æ˜¯æ»¡è¶³æ­¤æ¡ä»¶çš„æ ‡ç­¾ä¹‹ä¸€ã€‚</li>
<li>name inï¼ˆredis-master, redis-slaveï¼‰ï¼šåŒ¹é…æ‰€æœ‰å…·æœ‰æ ‡ç­¾name=redis-masteræˆ–è€…name= redis-slaveçš„èµ„æºå¯¹è±¡ã€‚</li>
<li>name not inï¼ˆphp-frontendï¼‰ï¼šåŒ¹é…æ‰€æœ‰ä¸å…·æœ‰æ ‡ç­¾name=php-frontendçš„èµ„æºå¯¹è±¡ã€‚</li>
</ul>
<p>ç®¡ç†å¯¹è±¡RCå’ŒServiceåˆ™é€šè¿‡Selectorå­—æ®µè®¾ç½®éœ€è¦å…³è”Podçš„Labelï¼Œå…¶ä»–ç®¡ç†å¯¹è±¡å¦‚Deploymentã€ReplicaSetã€DaemonSetå’ŒJobåˆ™å¯ä»¥åœ¨Selectorä¸­ä½¿ç”¨åŸºäºé›†åˆçš„ç­›é€‰æ¡ä»¶å®šä¹‰ã€‚</p>
<p>åŸºäºé›†åˆçš„ç­›é€‰ç¤ºä¾‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;key:</span> <span class="string">tier,</span> <span class="attr">operator:</span> <span class="string">In,</span> <span class="attr">values:</span> <span class="string">[frontend]&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;key:</span> <span class="string">environment,</span> <span class="attr">operator:</span> <span class="string">NotIn,</span> <span class="attr">values:</span> <span class="string">[dev]&#125;</span></span><br></pre></td></tr></table></figure>
<p>å¦‚æœåŒæ—¶è®¾ç½®äº†matchLabelså’ŒmatchExpressionsï¼Œåˆ™ä¸¤ç»„æ¡ä»¶ä¸ºANDå…³ç³»ã€‚</p>
<p>Label Selectoråœ¨Kubernetesä¸­çš„é‡è¦ä½¿ç”¨åœºæ™¯å¦‚ä¸‹ã€‚</p>
<ul>
<li>kube-controllerè¿›ç¨‹é€šè¿‡åœ¨èµ„æºå¯¹è±¡RCä¸Šå®šä¹‰çš„Label Selectoræ¥ç­›é€‰è¦ç›‘æ§çš„Podå‰¯æœ¬æ•°é‡ï¼Œä½¿Podå‰¯æœ¬æ•°é‡å§‹ç»ˆç¬¦åˆé¢„æœŸè®¾å®šçš„å…¨è‡ªåŠ¨æ§åˆ¶æµç¨‹ã€‚</li>
<li>kube-proxyè¿›ç¨‹é€šè¿‡Serviceçš„Label Selectoræ¥é€‰æ‹©å¯¹åº”çš„Podï¼Œè‡ªåŠ¨å»ºç«‹æ¯ä¸ªServiceåˆ°å¯¹åº”Podçš„è¯·æ±‚è½¬å‘è·¯ç”±è¡¨ï¼Œä»è€Œå®ç°Serviceçš„æ™ºèƒ½è´Ÿè½½å‡è¡¡æœºåˆ¶ã€‚</li>
<li>é€šè¿‡å¯¹æŸäº›Nodeå®šä¹‰ç‰¹å®šçš„Labelï¼Œå¹¶ä¸”åœ¨Podå®šä¹‰æ–‡ä»¶ä¸­ä½¿ç”¨NodeSelectorè¿™ç§æ ‡ç­¾è°ƒåº¦ç­–ç•¥ï¼Œkube-schedulerè¿›ç¨‹å¯ä»¥å®ç°Podå®šå‘è°ƒåº¦çš„ç‰¹æ€§ã€‚</li>
</ul>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Kubernetesé‡Œçš„æ¯ä¸ªServiceå…¶å®å°±æ˜¯æˆ‘ä»¬ç»å¸¸æèµ·çš„å¾®æœåŠ¡æ¶æ„ä¸­çš„ä¸€ä¸ªå¾®æœåŠ¡ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115174901221.png" alt="image-20201115174901221" style="zoom: 80%;"></p>
<p>Kubernetesçš„Serviceå®šä¹‰äº†ä¸€ä¸ªæœåŠ¡çš„è®¿é—®å…¥å£åœ°å€ï¼Œå‰ç«¯çš„åº”ç”¨ï¼ˆPodï¼‰é€šè¿‡è¿™ä¸ªå…¥å£åœ°å€è®¿é—®å…¶èƒŒåçš„ä¸€ç»„ç”±Podå‰¯æœ¬ç»„æˆçš„é›†ç¾¤å®ä¾‹ï¼ŒServiceä¸å…¶åç«¯Podå‰¯æœ¬é›†ç¾¤ä¹‹é—´åˆ™æ˜¯é€šè¿‡Label Selectoræ¥å®ç°æ— ç¼å¯¹æ¥çš„ã€‚</p>
<p>RCçš„ä½œç”¨å®é™…ä¸Šæ˜¯ä¿è¯Serviceçš„æœåŠ¡èƒ½åŠ›å’ŒæœåŠ¡è´¨é‡å§‹ç»ˆç¬¦åˆé¢„æœŸæ ‡å‡†ã€‚</p>
<p>è¿è¡Œåœ¨æ¯ä¸ªNodeä¸Šçš„kube-proxyè¿›ç¨‹å…¶å®å°±æ˜¯ä¸€ä¸ªæ™ºèƒ½çš„è½¯ä»¶è´Ÿè½½å‡è¡¡å™¨ï¼Œè´Ÿè´£æŠŠå¯¹Serviceçš„è¯·æ±‚è½¬å‘åˆ°åç«¯çš„æŸä¸ªPodå®ä¾‹ä¸Šï¼Œå¹¶åœ¨å†…éƒ¨å®ç°æœåŠ¡çš„è´Ÿè½½å‡è¡¡ä¸ä¼šè¯ä¿æŒæœºåˆ¶ã€‚ä½†Kuberneteså‘æ˜äº†ä¸€ç§å¾ˆå·§å¦™åˆå½±å“æ·±è¿œçš„è®¾è®¡ï¼šServiceæ²¡æœ‰å…±ç”¨ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨çš„IPåœ°å€ï¼Œæ¯ä¸ªServiceéƒ½è¢«åˆ†é…äº†ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„è™šæ‹ŸIPåœ°å€ï¼Œè¿™ä¸ªè™šæ‹ŸIPè¢«ç§°ä¸ºCluster IPã€‚è¿™æ ·ä¸€æ¥ï¼Œæ¯ä¸ªæœåŠ¡å°±å˜æˆäº†å…·å¤‡å”¯ä¸€IPåœ°å€çš„é€šä¿¡èŠ‚ç‚¹ï¼ŒæœåŠ¡è°ƒç”¨å°±å˜æˆäº†æœ€åŸºç¡€çš„TCPç½‘ç»œé€šä¿¡é—®é¢˜ã€‚</p>
<p>Serviceä¸€æ—¦è¢«åˆ›å»ºï¼ŒKuberneteså°±ä¼šè‡ªåŠ¨ä¸ºå®ƒåˆ†é…ä¸€ä¸ªå¯ç”¨çš„Cluster IPï¼Œè€Œä¸”åœ¨Serviceçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…ï¼Œå®ƒçš„Cluster IPä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">tier:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115175558607.png" alt="image-20201115175558607" style="zoom: 67%;"></p>
<p>åœ¨spec.portsçš„å®šä¹‰ä¸­ï¼ŒtargetPortå±æ€§ç”¨æ¥ç¡®å®šæä¾›è¯¥æœåŠ¡çš„å®¹å™¨æ‰€æš´éœ²ï¼ˆEXPOSEï¼‰çš„ç«¯å£å·ï¼Œå³å…·ä½“ä¸šåŠ¡è¿›ç¨‹åœ¨å®¹å™¨å†…çš„targetPortä¸Šæä¾›TCP/IPæ¥å…¥ï¼›portå±æ€§åˆ™å®šä¹‰äº†Serviceçš„è™šç«¯å£ã€‚å‰é¢å®šä¹‰TomcatæœåŠ¡æ—¶æ²¡æœ‰æŒ‡å®štargetPortï¼Œåˆ™é»˜è®¤targetPortä¸portç›¸åŒã€‚</p>
<p>Kubernetes Serviceæ”¯æŒå¤šä¸ªEndpointï¼Œåœ¨å­˜åœ¨å¤šä¸ªEndpointçš„æƒ…å†µä¸‹ï¼Œè¦æ±‚æ¯ä¸ªEndpointéƒ½å®šä¹‰ä¸€ä¸ªåç§°æ¥åŒºåˆ†ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-port</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8005</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">shutdown-port</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">tier:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure>
<font color="red">å¤šç«¯å£ä¸ºä»€ä¹ˆéœ€è¦ç»™æ¯ä¸ªç«¯å£éƒ½å‘½åå‘¢ï¼Ÿ</font>

<p>è¿™å°±æ¶‰åŠKubernetesçš„æœåŠ¡å‘ç°æœºåˆ¶ï¼ŒKubernetesé€šè¿‡Add-Onå¢å€¼åŒ…å¼•å…¥äº†DNSç³»ç»Ÿï¼ŒæŠŠæœåŠ¡åä½œä¸ºDNSåŸŸåï¼Œè¿™æ ·ç¨‹åºå°±å¯ä»¥ç›´æ¥ä½¿ç”¨æœåŠ¡åæ¥å»ºç«‹é€šä¿¡è¿æ¥äº†ã€‚</p>
<p><strong>å¤–éƒ¨ç³»ç»Ÿè®¿é—®Serviceçš„é—®é¢˜</strong></p>
<p>ä¸ºäº†æ›´æ·±å…¥åœ°ç†è§£å’ŒæŒæ¡Kubernetesï¼Œæˆ‘ä»¬éœ€è¦å¼„æ˜ç™½Kubernetesé‡Œçš„3ç§IPï¼Œè¿™3ç§IPåˆ†åˆ«å¦‚ä¸‹ã€‚</p>
<ul>
<li>Node IPï¼šNodeçš„IPåœ°å€</li>
<li>Pod IPï¼šPodçš„IPåœ°å€</li>
<li>Cluster IPï¼šServiceçš„IPåœ°å€</li>
</ul>
<p>Node IPæ˜¯Kubernetesé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„ç‰©ç†ç½‘å¡çš„IPåœ°å€ã€‚</p>
<p>Pod IPæ˜¯æ¯ä¸ªPodçš„IPåœ°å€ï¼Œå®ƒæ˜¯Docker Engineæ ¹æ®docker0ç½‘æ¡¥çš„IPåœ°å€æ®µè¿›è¡Œåˆ†é…çš„ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„äºŒå±‚ç½‘ç»œã€‚æ‰€ä»¥Kubernetesé‡Œä¸€ä¸ªPodé‡Œçš„å®¹å™¨è®¿é—®å¦å¤–ä¸€ä¸ªPodé‡Œçš„å®¹å™¨æ—¶ï¼Œå°±æ˜¯é€šè¿‡Pod IPæ‰€åœ¨çš„<strong>è™šæ‹ŸäºŒå±‚ç½‘ç»œ</strong>è¿›è¡Œé€šä¿¡çš„ï¼Œè€ŒçœŸå®çš„TCP/IPæµé‡æ˜¯é€šè¿‡Node IPæ‰€åœ¨çš„ç‰©ç†ç½‘å¡æµå‡ºçš„ã€‚</p>
<p>Cluster IPï¼Œå®ƒä¹Ÿæ˜¯ä¸€ç§è™šæ‹Ÿçš„IPï¼Œä½†æ›´åƒä¸€ä¸ªâ€œä¼ªé€ â€çš„IPç½‘ç»œã€‚</p>
<ul>
<li>Cluster IPä»…ä»…ä½œç”¨äºKubernetes Serviceè¿™ä¸ªå¯¹è±¡ï¼Œå¹¶ç”±Kubernetesç®¡ç†å’Œåˆ†é…IPåœ°å€ã€‚</li>
<li>Cluster IPæ— æ³•è¢«Pingï¼Œå› ä¸ºæ²¡æœ‰ä¸€ä¸ªâ€œå®ä½“ç½‘ç»œå¯¹è±¡â€æ¥å“åº”ã€‚</li>
<li>Cluster IPåªèƒ½ç»“åˆService Portç»„æˆä¸€ä¸ªå…·ä½“çš„é€šä¿¡ç«¯å£ï¼Œå•ç‹¬çš„Cluster IPä¸å…·å¤‡TCP/IPé€šä¿¡çš„åŸºç¡€ï¼Œå¹¶ä¸”å®ƒä»¬å±äºKubernetesé›†ç¾¤è¿™æ ·ä¸€ä¸ªå°é—­çš„ç©ºé—´ã€‚</li>
</ul>
<p>Serviceçš„Cluster IPå±äºKubernetesé›†ç¾¤å†…éƒ¨çš„åœ°å€ï¼Œæ— æ³•åœ¨é›†ç¾¤å¤–éƒ¨ç›´æ¥ä½¿ç”¨è¿™ä¸ªåœ°å€ã€‚</p>
<font color="red">å¤–éƒ¨çš„åº”ç”¨æˆ–è€…ç”¨æˆ·æ€ä¹ˆè®¿é—®serviceï¼Ÿ</font>

<p>é‡‡ç”¨NodePortæ˜¯è§£å†³ä¸Šè¿°é—®é¢˜çš„æœ€ç›´æ¥ã€æœ‰æ•ˆçš„å¸¸è§åšæ³•ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nodePort:</span> <span class="number">30888</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">ui</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>
<p>NodePortçš„å®ç°æ–¹å¼æ˜¯åœ¨Kubernetesé›†ç¾¤é‡Œçš„æ¯ä¸ªNodeä¸Šéƒ½ä¸ºéœ€è¦å¤–éƒ¨è®¿é—®çš„Serviceå¼€å¯ä¸€ä¸ªå¯¹åº”çš„TCPç›‘å¬ç«¯å£ï¼Œå¤–éƒ¨ç³»ç»Ÿåªè¦ç”¨ä»»æ„ä¸€ä¸ªNodeçš„IPåœ°å€+å…·ä½“çš„NodePortç«¯å£å·å³å¯è®¿é—®æ­¤æœåŠ¡ã€‚</p>
<p>NodePortè¿˜æ²¡æœ‰å®Œå…¨è§£å†³å¤–éƒ¨è®¿é—®Serviceçš„æ‰€æœ‰é—®é¢˜ï¼Œæ¯”å¦‚è´Ÿè½½å‡è¡¡é—®é¢˜ã€‚</p>
<p>å¦‚æœæˆ‘ä»¬çš„é›†ç¾¤è¿è¡Œåœ¨å…¬æœ‰äº‘ä¸Šï¼Œé‚£ä¹ˆåªè¦æŠŠServiceçš„type=NodePortæ”¹ä¸ºtype=LoadBalancerï¼ŒKuberneteså°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„Load balancerå®ä¾‹å¹¶è¿”å›å®ƒçš„IPåœ°å€ä¾›å¤–éƒ¨å®¢æˆ·ç«¯ä½¿ç”¨ã€‚</p>
<h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><p>Replication Controllerï¼ˆç®€ç§°RCï¼‰æ˜¯Kubernetesç³»ç»Ÿä¸­çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ï¼Œç®€å•æ¥è¯´ï¼Œå®ƒå…¶å®å®šä¹‰äº†ä¸€ä¸ªæœŸæœ›çš„åœºæ™¯ï¼Œå³å£°æ˜æŸç§Podçš„å‰¯æœ¬æ•°é‡åœ¨ä»»æ„æ—¶åˆ»éƒ½ç¬¦åˆæŸä¸ªé¢„æœŸå€¼ï¼Œæ‰€ä»¥RCçš„å®šä¹‰åŒ…æ‹¬å¦‚ä¸‹å‡ ä¸ªéƒ¨åˆ†ï¼š</p>
<ul>
<li>PodæœŸå¾…çš„å‰¯æœ¬æ•°é‡</li>
<li>ç”¨äºç­›é€‰ç›®æ ‡Podçš„Label Selector</li>
<li>å½“Podçš„å‰¯æœ¬æ•°é‡å°äºé¢„æœŸæ•°é‡æ—¶ï¼Œç”¨äºåˆ›å»ºæ–°Podçš„Podæ¨¡æ¿ï¼ˆtemplateï¼‰</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">	<span class="attr">metadata:</span></span><br><span class="line">	  <span class="attr">labels:</span></span><br><span class="line">	  <span class="attr">app:</span> <span class="string">app-demo</span></span><br><span class="line">	  <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">	  <span class="attr">containers:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-demo</span></span><br><span class="line">	  <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">	  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">	  <span class="attr">env:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">		<span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">	  <span class="attr">ports:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>åœ¨å®šä¹‰ä¸€ä¸ªRCå¹¶å°†å…¶æäº¤åˆ°Kubernetesé›†ç¾¤ä¸­åï¼ŒMasterä¸Šçš„Controller Managerç»„ä»¶å°±å¾—åˆ°é€šçŸ¥ï¼Œå®šæœŸå·¡æ£€ç³»ç»Ÿä¸­å½“å‰å­˜æ´»çš„ç›®æ ‡Podï¼Œå¹¶ç¡®ä¿ç›®æ ‡Podå®ä¾‹çš„æ•°é‡åˆšå¥½ç­‰äºæ­¤RCçš„æœŸæœ›å€¼ï¼Œå¦‚æœæœ‰è¿‡å¤šçš„Podå‰¯æœ¬åœ¨è¿è¡Œï¼Œç³»ç»Ÿå°±ä¼šåœæ‰ä¸€äº›Podï¼Œå¦åˆ™ç³»ç»Ÿä¼šå†è‡ªåŠ¨åˆ›å»ºä¸€äº›Podã€‚</p>
<p>å¯ä»¥é€šè¿‡æ‰§è¡Œ kubectl scale å‘½ä»¤æ¥å®ç°Podçš„åŠ¨æ€ç¼©æ”¾ï¼ˆScalingï¼‰ã€‚åˆ é™¤RCå¹¶ä¸ä¼šå½±å“é€šè¿‡è¯¥RCå·²åˆ›å»ºå¥½çš„Podã€‚ä¸ºäº†åˆ é™¤æ‰€æœ‰Podï¼Œå¯ä»¥è®¾ç½®replicasçš„å€¼ä¸º0ï¼Œç„¶åæ›´æ–°è¯¥RCã€‚é€šè¿‡RCæœºåˆ¶ï¼ŒKuberneteså¾ˆå®¹æ˜“å°±å®ç°äº†è¿™ç§é«˜çº§å®ç”¨çš„ç‰¹æ€§ï¼Œè¢«ç§°ä¸ºâ€œæ»šåŠ¨å‡çº§â€ ã€‚</p>
<p>RCç›®å‰å·²å‡çº§ä¸ºå¦å¤–ä¸€ä¸ªæ–°æ¦‚å¿µâ€”â€”Replica Setï¼Œå®˜æ–¹è§£é‡Šå…¶ä¸ºâ€œä¸‹ä¸€ä»£çš„RCâ€ã€‚Replica Setä¸RCå½“å‰çš„å”¯ä¸€åŒºåˆ«æ˜¯ï¼ŒReplica Setsæ”¯æŒåŸºäºé›†åˆçš„Label selectorï¼ˆSet-based selectorï¼‰ï¼Œè€ŒRCåªæ”¯æŒåŸºäºç­‰å¼çš„Label Selectorï¼ˆequality-based selectorï¼‰ï¼Œè¿™ä½¿å¾—Replica Setçš„åŠŸèƒ½æ›´å¼ºã€‚</p>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deploymentæ˜¯Kubernetesåœ¨1.2ç‰ˆæœ¬ä¸­å¼•å…¥çš„æ–°æ¦‚å¿µï¼Œç”¨äºæ›´å¥½åœ°è§£å†³Podçš„ç¼–æ’é—®é¢˜ã€‚ä¸ºæ­¤ï¼ŒDeploymentåœ¨å†…éƒ¨ä½¿ç”¨äº†Replica Setæ¥å®ç°ç›®çš„ï¼Œæ— è®ºä»Deploymentçš„ä½œç”¨ä¸ç›®çš„ã€YAMLå®šä¹‰ï¼Œè¿˜æ˜¯ä»å®ƒçš„å…·ä½“å‘½ä»¤è¡Œæ“ä½œæ¥çœ‹ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æŠŠå®ƒçœ‹ä½œRCçš„ä¸€æ¬¡å‡çº§ï¼Œä¸¤è€…çš„ç›¸ä¼¼åº¦è¶…è¿‡90%ã€‚</p>
<p>Deploymentç›¸å¯¹äºRCçš„ä¸€ä¸ªæœ€å¤§å‡çº§æ˜¯æˆ‘ä»¬å¯ä»¥éšæ—¶çŸ¥é“å½“å‰Podâ€œéƒ¨ç½²â€çš„è¿›åº¦ã€‚å®é™…ä¸Šç”±äºä¸€ä¸ªPodçš„åˆ›å»ºã€è°ƒåº¦ã€ç»‘å®šèŠ‚ç‚¹åŠåœ¨ç›®æ ‡Nodeä¸Šå¯åŠ¨å¯¹åº”çš„å®¹å™¨è¿™ä¸€å®Œæ•´è¿‡ç¨‹éœ€è¦ä¸€å®šçš„æ—¶é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬æœŸå¾…ç³»ç»Ÿå¯åŠ¨Nä¸ªPodå‰¯æœ¬çš„ç›®æ ‡çŠ¶æ€ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªè¿ç»­å˜åŒ–çš„â€œéƒ¨ç½²è¿‡ç¨‹â€å¯¼è‡´çš„æœ€ç»ˆçŠ¶æ€ã€‚</p>
<p>Deploymentçš„å…¸å‹ä½¿ç”¨åœºæ™¯æœ‰ä»¥ä¸‹å‡ ä¸ªï¼š</p>
<ul>
<li>åˆ›å»ºä¸€ä¸ªDeploymentå¯¹è±¡æ¥ç”Ÿæˆå¯¹åº”çš„Replica Setå¹¶å®ŒæˆPodå‰¯æœ¬çš„åˆ›å»º</li>
<li>æ£€æŸ¥Deploymentçš„çŠ¶æ€æ¥çœ‹éƒ¨ç½²åŠ¨ä½œæ˜¯å¦å®Œæˆï¼ˆPodå‰¯æœ¬æ•°é‡æ˜¯å¦è¾¾åˆ°é¢„æœŸçš„å€¼ï¼‰</li>
<li>æ›´æ–°Deploymentä»¥åˆ›å»ºæ–°çš„Podï¼ˆæ¯”å¦‚é•œåƒå‡çº§ï¼‰</li>
<li>å¦‚æœå½“å‰Deploymentä¸ç¨³å®šï¼Œåˆ™å›æ»šåˆ°ä¸€ä¸ªæ—©å…ˆçš„Deploymentç‰ˆæœ¬</li>
<li>æš‚åœDeploymentä»¥ä¾¿äºä¸€æ¬¡æ€§ä¿®æ”¹å¤šä¸ªPodTemplateSpecçš„é…ç½®é¡¹ï¼Œä¹‹åå†æ¢å¤Deploymentï¼Œè¿›è¡Œæ–°çš„å‘å¸ƒ</li>
<li>æ‰©å±•Deploymentä»¥åº”å¯¹é«˜è´Ÿè½½</li>
<li><p>æŸ¥çœ‹Deploymentçš„çŠ¶æ€ï¼Œä»¥æ­¤ä½œä¸ºå‘å¸ƒæ˜¯å¦æˆåŠŸçš„æŒ‡æ ‡</p>
</li>
<li><p>æ¸…ç†ä¸å†éœ€è¦çš„æ—§ç‰ˆæœ¬ReplicaSets</p>
</li>
</ul>
<p>é™¤äº†APIå£°æ˜ä¸Kindç±»å‹ç­‰æœ‰æ‰€åŒºåˆ«ï¼ŒDeploymentçš„å®šä¹‰ä¸Replica Setçš„å®šä¹‰å¾ˆç±»ä¼¼ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">matchLabels:</span></span><br><span class="line">	  <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">	<span class="attr">matchExpressions:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="string">&#123;key:</span> <span class="string">tier,</span> <span class="attr">operator:</span> <span class="string">In,</span> <span class="attr">values:</span> <span class="string">[frontend]&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">	<span class="attr">metadata:</span></span><br><span class="line">	  <span class="attr">labels:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">app-demo</span></span><br><span class="line">		<span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">	  <span class="attr">containers:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-demo</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">		<span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">		<span class="attr">ports:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231530048.png" alt="image-20201114231530048" style="zoom: 80%;"></p>
<p>å¯¹ä¸Šè¿°è¾“å‡ºä¸­æ¶‰åŠçš„æ•°é‡è§£é‡Šå¦‚ä¸‹ï¼š</p>
<ul>
<li>DESIREDï¼šPodå‰¯æœ¬æ•°é‡çš„æœŸæœ›å€¼ï¼Œå³åœ¨Deploymenté‡Œå®šä¹‰çš„Replica</li>
<li>CURRENTï¼šå½“å‰Replicaçš„å€¼ï¼Œå®é™…ä¸Šæ˜¯Deploymentåˆ›å»ºçš„Replica Seté‡Œçš„Replicaå€¼ï¼Œè¿™ä¸ªå€¼ä¸æ–­å¢åŠ ï¼Œç›´åˆ°è¾¾åˆ°DESIREDä¸ºæ­¢ï¼Œè¡¨æ˜æ•´ä¸ªéƒ¨ç½²è¿‡ç¨‹å®Œæˆ</li>
<li>UP-TO-DATEï¼šæœ€æ–°ç‰ˆæœ¬çš„Podçš„å‰¯æœ¬æ•°é‡ï¼Œç”¨äºæŒ‡ç¤ºåœ¨æ»šåŠ¨å‡çº§çš„è¿‡ç¨‹ä¸­ï¼Œæœ‰å¤šå°‘ä¸ªPodå‰¯æœ¬å·²ç»æˆåŠŸå‡çº§</li>
<li>AVAILABLEï¼šå½“å‰é›†ç¾¤ä¸­å¯ç”¨çš„Podå‰¯æœ¬æ•°é‡ï¼Œå³é›†ç¾¤ä¸­å½“å‰å­˜æ´»çš„Podæ•°é‡</li>
</ul>
<h4 id="æ¼”ç¤º-â€”â€”-Deployment-æ‰©å®¹"><a href="#æ¼”ç¤º-â€”â€”-Deployment-æ‰©å®¹" class="headerlink" title="æ¼”ç¤º â€”â€” Deployment æ‰©å®¹"></a>æ¼”ç¤º â€”â€” Deployment æ‰©å®¹</h4><p>æ‰©å®¹ myweb ä¸º2ä¸ªå‰¯æœ¬ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231740085.png" alt="image-20201114231740085"></p>
<p>æ‰©å®¹ä¸­ â€¦</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231813394.png" alt="image-20201114231813394"></p>
<p>æ‰©å®¹å®Œæˆ</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231851088.png" alt="image-20201114231851088"></p>
<p>ä¸ºäº†åŒºåˆ†è®¿é—®çš„æ˜¯å“ªä¸ªpodï¼Œå¯ä»¥è¿›å…¥å®¹å™¨ä¿®æ”¹ <code>myweb</code> çš„htmlæºç ï¼Œæ¯”å¦‚å¯ä»¥å°†å…¶ä¸­ä¹‹ä¸€çš„ <code>h1</code> æ ‡é¢˜å¢åŠ  <code>(2)</code> å­—æ ·ï¼Œä¿å­˜åå³å¯ç”Ÿæ•ˆï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114232414808.png" alt="image-20201114232414808"></p>
<p>å¼€2ä¸ªçª—å£ï¼Œå¤šæ¬¡åˆ·æ–°ï¼Œä¼šå‘ç°æœ‰æ—¶è®¿é—®åˆ°çš„æ˜¯<strong>ä¿®æ”¹ç‰ˆ</strong>ï¼ˆå³ï¼‰ï¼Œæœ‰æ—¶è®¿é—®åˆ°çš„æ˜¯<strong>æœªä¿®æ”¹ç‰ˆ</strong>ï¼ˆå·¦ï¼‰ï¼Œè¯´æ˜æ‰©å®¹åçš„2ä¸ªpodéƒ½èƒ½æä¾›æœåŠ¡ï¼›å¹¶ä¸”è¢«è®¿é—®çš„å‡ ç‡å·®ä¸å¤šï¼Œè¿™æ˜¯serviceçš„è´Ÿè½½å‡è¡¡ç‰¹æ€§ã€‚è¿™äº›ç¬¦åˆé¢„æœŸã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114232526869.png" alt="image-20201114232526869"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114233931967.png" alt="image-20201114233931967" style="zoom: 67%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114234101500.png" alt="image-20201114234101500" style="zoom: 67%;"></p>
<h3 id="Horizontal-Pod-Autoscaler"><a href="#Horizontal-Pod-Autoscaler" class="headerlink" title="Horizontal Pod Autoscaler"></a>Horizontal Pod Autoscaler</h3><p>é€šè¿‡æ‰‹å·¥æ‰§è¡Œ kubectl scale å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°Podæ‰©å®¹æˆ–ç¼©å®¹ã€‚å¦‚æœä»…ä»…åˆ°æ­¤ä¸ºæ­¢ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆè°·æ­Œå¯¹Kubernetesçš„å®šä½ç›®æ ‡â€”â€”è‡ªåŠ¨åŒ–ã€æ™ºèƒ½åŒ–ã€‚</p>
<p>Kubernetesä»1.6ç‰ˆæœ¬å¼€å§‹ï¼Œå¢å¼ºäº†æ ¹æ®åº”ç”¨è‡ªå®šä¹‰çš„æŒ‡æ ‡è¿›è¡Œè‡ªåŠ¨æ‰©å®¹å’Œç¼©å®¹çš„åŠŸèƒ½ï¼ŒAPIç‰ˆæœ¬ä¸ºautoscaling/v2alpha1ï¼Œå¹¶ä¸æ–­æ¼”è¿›ã€‚</p>
<p>HPAä¸ä¹‹å‰çš„RCã€Deploymentä¸€æ ·ï¼Œä¹Ÿå±äºä¸€ç§Kubernetesèµ„æºå¯¹è±¡ã€‚</p>
<p>é€šè¿‡è¿½è¸ªåˆ†ææŒ‡å®šRCæ§åˆ¶çš„æ‰€æœ‰ç›®æ ‡Podçš„è´Ÿè½½å˜åŒ–æƒ…å†µï¼Œæ¥ç¡®å®šæ˜¯å¦éœ€è¦æœ‰é’ˆå¯¹æ€§åœ°è°ƒæ•´ç›®æ ‡Podçš„å‰¯æœ¬æ•°é‡ï¼Œè¿™æ˜¯HPAçš„å®ç°åŸç†ã€‚å½“å‰ï¼ŒHPAæœ‰ä»¥ä¸‹ä¸¤ç§æ–¹å¼ä½œä¸ºPodè´Ÿè½½çš„åº¦é‡æŒ‡æ ‡ã€‚</p>
<ul>
<li>CPUUtilizationPercentage</li>
<li>åº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„åº¦é‡æŒ‡æ ‡ï¼Œæ¯”å¦‚æœåŠ¡åœ¨æ¯ç§’å†…çš„ç›¸åº”è¯·æ±‚æ•°ï¼ˆTPSæˆ–QPSï¼‰</li>
</ul>
<p>CPUUtilizationPercentage æ˜¯ä¸€ä¸ªç®—æœ¯å¹³å‡å€¼ï¼Œå³ç›®æ ‡Podæ‰€æœ‰å‰¯æœ¬è‡ªèº«çš„CPUåˆ©ç”¨ç‡çš„å¹³å‡å€¼ã€‚</p>
<p>ä¸€ä¸ªPodè‡ªèº«çš„CPUåˆ©ç”¨ç‡æ˜¯è¯¥Podå½“å‰CPUçš„ä½¿ç”¨é‡é™¤ä»¥å®ƒçš„Pod Requestçš„å€¼ã€‚</p>
<p>åœ¨CPUUtilizationPercentageè®¡ç®—è¿‡ç¨‹ä¸­ä½¿ç”¨åˆ°çš„Podçš„CPUä½¿ç”¨é‡é€šå¸¸æ˜¯1minå†…çš„å¹³å‡å€¼ã€‚</p>
<p>å¦‚æœç›®æ ‡Podæ²¡æœ‰å®šä¹‰Pod Requestçš„å€¼ï¼Œåˆ™æ— æ³•ä½¿ç”¨CPUUtilizationPercentageå®ç°Podæ¨ªå‘è‡ªåŠ¨æ‰©å®¹ã€‚</p>
<p>Kubernetesä»1.2ç‰ˆæœ¬å¼€å§‹ä¹Ÿåœ¨å°è¯•æ”¯æŒåº”ç”¨ç¨‹åºè‡ªå®šä¹‰çš„åº¦é‡æŒ‡æ ‡ã€‚</p>
<p>HPAç¤ºä¾‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">90</span></span><br></pre></td></tr></table></figure>
<p>ç­‰ä»·äº</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl autoscale deployment php-apache --cpu-percent=90--min=1--max=10</span><br></pre></td></tr></table></figure>
<h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>åœ¨Kubernetesç³»ç»Ÿä¸­ï¼ŒPodçš„ç®¡ç†å¯¹è±¡RCã€Deploymentã€DaemonSetå’ŒJobéƒ½é¢å‘æ— çŠ¶æ€çš„æœåŠ¡ã€‚ä½†ç°å®ä¸­æœ‰å¾ˆå¤šæœåŠ¡æ˜¯æœ‰çŠ¶æ€çš„ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›å¤æ‚çš„ä¸­é—´ä»¶é›†ç¾¤ï¼Œä¾‹å¦‚MySQLé›†ç¾¤ã€MongoDBé›†ç¾¤ã€Akkaé›†ç¾¤ã€ZooKeeperé›†ç¾¤ç­‰ï¼Œè¿™äº›åº”ç”¨é›†ç¾¤æœ‰4ä¸ªå…±åŒç‚¹ï¼š</p>
<ul>
<li>æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å›ºå®šçš„èº«ä»½IDï¼Œé€šè¿‡è¿™ä¸ªIDï¼Œé›†ç¾¤ä¸­çš„æˆå‘˜å¯ä»¥ç›¸äº’å‘ç°å¹¶é€šä¿¡ã€‚</li>
<li>é›†ç¾¤çš„è§„æ¨¡æ˜¯æ¯”è¾ƒå›ºå®šçš„ï¼Œé›†ç¾¤è§„æ¨¡ä¸èƒ½éšæ„å˜åŠ¨ã€‚</li>
<li>é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œé€šå¸¸ä¼šæŒä¹…åŒ–æ•°æ®åˆ°æ°¸ä¹…å­˜å‚¨ä¸­ã€‚</li>
<li>å¦‚æœç£ç›˜æŸåï¼Œåˆ™é›†ç¾¤é‡Œçš„æŸä¸ªèŠ‚ç‚¹æ— æ³•æ­£å¸¸è¿è¡Œï¼Œé›†ç¾¤åŠŸèƒ½å—æŸã€‚</li>
</ul>
<p>å¦‚æœé€šè¿‡RCæˆ–Deploymentæ§åˆ¶Podå‰¯æœ¬æ•°é‡æ¥å®ç°ä¸Šè¿°æœ‰çŠ¶æ€çš„é›†ç¾¤ï¼Œå°±ä¼šå‘ç°ç¬¬1ç‚¹æ˜¯æ— æ³•æ»¡è¶³çš„ï¼Œå› ä¸ºPodçš„åç§°æ˜¯éšæœºäº§ç”Ÿçš„ï¼ŒPodçš„IPåœ°å€ä¹Ÿæ˜¯åœ¨è¿è¡ŒæœŸæ‰ç¡®å®šä¸”å¯èƒ½æœ‰å˜åŠ¨çš„ï¼Œæˆ‘ä»¬äº‹å…ˆæ— æ³•ä¸ºæ¯ä¸ªPodéƒ½ç¡®å®šå”¯ä¸€ä¸å˜çš„IDã€‚</p>
<p>StatefulSetä»æœ¬è´¨ä¸Šæ¥è¯´ï¼Œå¯ä»¥çœ‹ä½œDeployment/RCçš„ä¸€ä¸ªç‰¹æ®Šå˜ç§ï¼Œå®ƒæœ‰å¦‚ä¸‹ç‰¹æ€§ï¼š</p>
<ul>
<li><p>StatefulSeté‡Œçš„æ¯ä¸ªPodéƒ½æœ‰ç¨³å®šã€å”¯ä¸€çš„ç½‘ç»œæ ‡è¯†ï¼Œå¯ä»¥ç”¨æ¥å‘ç°é›†ç¾¤å†…çš„å…¶ä»–æˆå‘˜ã€‚å‡è®¾StatefulSetçš„åç§°ä¸ºkafkaï¼Œé‚£ä¹ˆç¬¬1ä¸ªPodå«kafka-0ï¼Œç¬¬2ä¸ªå«kafka-1ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p>
</li>
<li><p>StatefulSetæ§åˆ¶çš„Podå‰¯æœ¬çš„å¯åœé¡ºåºæ˜¯å—æ§çš„ï¼Œæ“ä½œç¬¬nä¸ªPodæ—¶ï¼Œå‰n-1ä¸ªPodå·²ç»æ˜¯è¿è¡Œä¸”å‡†å¤‡å¥½çš„çŠ¶æ€ã€‚</p>
</li>
<li>StatefulSeté‡Œçš„Podé‡‡ç”¨ç¨³å®šçš„æŒä¹…åŒ–å­˜å‚¨å·ï¼Œé€šè¿‡PVæˆ–PVCæ¥å®ç°ï¼Œåˆ é™¤Podæ—¶é»˜è®¤ä¸ä¼šåˆ é™¤ä¸StatefulSetç›¸å…³çš„å­˜å‚¨å·ï¼ˆä¸ºäº†ä¿è¯æ•°æ®çš„å®‰å…¨ï¼‰ã€‚</li>
</ul>
<h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>åœ¨æ¯ä¸ªNodeä¸Šéƒ½è°ƒåº¦ä¸€ä¸ªPodã€‚<br>DaemonSet ç”¨äºç®¡ç†åœ¨é›†ç¾¤ä¸­æ¯ä¸ªNodeä¸Šä»…è¿è¡Œä¸€ä»½Podçš„å‰¯æœ¬å®ä¾‹ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115215750674.png" alt="image-20201115215750674" style="zoom:50%;"></p>
<p>ä½¿ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¿è¡Œä¸€ä¸ªGlusterFSå­˜å‚¨æˆ–è€…Cephå­˜å‚¨çš„Daemonè¿›ç¨‹ã€‚</li>
<li>åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¿è¡Œä¸€ä¸ªæ—¥å¿—é‡‡é›†ç¨‹åºï¼Œä¾‹å¦‚Fluentdæˆ–è€…Logstachã€‚</li>
<li>åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¿è¡Œä¸€ä¸ªæ€§èƒ½ç›‘æ§ç¨‹åºï¼Œé‡‡é›†è¯¥Nodeçš„è¿è¡Œæ€§èƒ½æ•°æ®ï¼Œä¾‹å¦‚Prometheus Node Exporterã€collectdã€New Relic agentæˆ–è€…Ganglia gmondç­‰ã€‚</li>
</ul>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>æ‰¹å¤„ç†ä»»åŠ¡é€šå¸¸å¹¶è¡Œï¼ˆæˆ–è€…ä¸²è¡Œï¼‰å¯åŠ¨å¤šä¸ªè®¡ç®—è¿›ç¨‹å»å¤„ç†ä¸€æ‰¹å·¥ä½œé¡¹ï¼ˆwork itemï¼‰ï¼Œåœ¨å¤„ç†å®Œæˆåï¼Œæ•´ä¸ªæ‰¹å¤„ç†ä»»åŠ¡ç»“æŸã€‚</p>
<p>ä¸RCã€Deploymentã€ReplicaSetã€DaemonSetç±»ä¼¼ï¼ŒJobä¹Ÿæ§åˆ¶ä¸€ç»„Podå®¹å™¨ã€‚ä»è¿™ä¸ªè§’åº¦æ¥çœ‹ï¼ŒJobä¹Ÿæ˜¯ä¸€ç§ç‰¹æ®Šçš„Podå‰¯æœ¬è‡ªåŠ¨æ§åˆ¶å™¨ã€‚</p>
<p>ï¼ˆ1ï¼‰Jobæ‰€æ§åˆ¶çš„Podå‰¯æœ¬æ˜¯çŸ­æš‚è¿è¡Œçš„ï¼Œå¯ä»¥å°†å…¶è§†ä¸ºä¸€ç»„Dockerå®¹å™¨ï¼Œå…¶ä¸­çš„æ¯ä¸ªDockerå®¹å™¨éƒ½ä»…ä»…è¿è¡Œä¸€æ¬¡</p>
<p>ï¼ˆ2ï¼‰Jobæ‰€æ§åˆ¶çš„Podå‰¯æœ¬çš„å·¥ä½œæ¨¡å¼èƒ½å¤Ÿå¤šå®ä¾‹å¹¶è¡Œè®¡ç®—</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115220103135.png" alt="image-20201115220103135"></p>
<h3 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h3><p>Volumeï¼ˆå­˜å‚¨å·ï¼‰æ˜¯Podä¸­èƒ½å¤Ÿè¢«å¤šä¸ªå®¹å™¨è®¿é—®çš„å…±äº«ç›®å½•ã€‚</p>
<p>Kubernetesä¸­çš„Volumeä¸Podçš„ç”Ÿå‘½å‘¨æœŸç›¸åŒï¼Œä½†ä¸å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸä¸ç›¸å…³ï¼Œå½“å®¹å™¨ç»ˆæ­¢æˆ–è€…é‡å¯æ—¶ï¼ŒVolumeä¸­çš„æ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚</p>
<p>Volumeçš„ä½¿ç”¨ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å…ˆåœ¨Podä¸Šå£°æ˜ä¸€ä¸ªVolumeï¼Œç„¶ååœ¨å®¹å™¨é‡Œå¼•ç”¨è¯¥Volumeå¹¶æŒ‚è½½ï¼ˆMountï¼‰åˆ°å®¹å™¨é‡Œçš„æŸä¸ªç›®å½•ä¸Šã€‚</p>
<p>Kubernetesæä¾›äº†éå¸¸ä¸°å¯Œçš„Volumeç±»å‹ï¼Œä¸‹é¢é€ä¸€è¿›è¡Œè¯´æ˜ï¼š</p>
<p>1ï¼emptyDir</p>
<p>ä¸€ä¸ªemptyDir Volumeæ˜¯åœ¨Podåˆ†é…åˆ°Nodeæ—¶åˆ›å»ºçš„ã€‚ä»å®ƒçš„åç§°å°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒçš„åˆå§‹å†…å®¹ä¸ºç©ºï¼Œå¹¶ä¸”æ— é¡»æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•æ–‡ä»¶ï¼Œå› ä¸ºè¿™æ˜¯Kubernetesè‡ªåŠ¨åˆ†é…çš„ä¸€ä¸ªç›®å½•ï¼Œå½“Podä»Nodeä¸Šç§»é™¤æ—¶ï¼ŒemptyDirä¸­çš„æ•°æ®ä¹Ÿä¼šè¢«æ°¸ä¹…åˆ é™¤ã€‚</p>
<p>emptyDirçš„ä¸€äº›ç”¨é€”å¦‚ä¸‹ï¼š</p>
<ul>
<li>ä¸´æ—¶ç©ºé—´ï¼Œä¾‹å¦‚ç”¨äºæŸäº›åº”ç”¨ç¨‹åºè¿è¡Œæ—¶æ‰€éœ€çš„ä¸´æ—¶ç›®å½•ï¼Œä¸”æ— é¡»æ°¸ä¹…ä¿ç•™ã€‚</li>
<li>é•¿æ—¶é—´ä»»åŠ¡çš„ä¸­é—´è¿‡ç¨‹CheckPointçš„ä¸´æ—¶ä¿å­˜ç›®å½•ã€‚</li>
<li>ä¸€ä¸ªå®¹å™¨éœ€è¦ä»å¦ä¸€ä¸ªå®¹å™¨ä¸­è·å–æ•°æ®çš„ç›®å½•ï¼ˆå¤šå®¹å™¨å…±äº«ç›®å½•ï¼‰ã€‚</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">datavol</span></span><br><span class="line">	<span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>2ï¼hostPath</p>
<p>hostPathä¸ºåœ¨Podä¸ŠæŒ‚è½½å®¿ä¸»æœºä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•ï¼Œå®ƒé€šå¸¸å¯ä»¥ç”¨äºä»¥ä¸‹å‡ æ–¹é¢ï¼š</p>
<ul>
<li>å®¹å™¨åº”ç”¨ç¨‹åºç”Ÿæˆçš„æ—¥å¿—æ–‡ä»¶éœ€è¦æ°¸ä¹…ä¿å­˜æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å®¿ä¸»æœºçš„é«˜é€Ÿæ–‡ä»¶ç³»ç»Ÿè¿›è¡Œå­˜å‚¨ã€‚</li>
<li>éœ€è¦è®¿é—®å®¿ä¸»æœºä¸ŠDockerå¼•æ“å†…éƒ¨æ•°æ®ç»“æ„çš„å®¹å™¨åº”ç”¨æ—¶ï¼Œå¯ä»¥é€šè¿‡å®šä¹‰hostPathä¸ºå®¿ä¸»æœº/var/lib/dockerç›®å½•ï¼Œä½¿å®¹å™¨å†…éƒ¨åº”ç”¨å¯ä»¥ç›´æ¥è®¿é—®Dockerçš„æ–‡ä»¶ç³»ç»Ÿã€‚</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"persistent-storage"</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">"/data"</span></span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p>
<ul>
<li>åœ¨ä¸åŒçš„Nodeä¸Šå…·æœ‰ç›¸åŒé…ç½®çš„Podï¼Œå¯èƒ½ä¼šå› ä¸ºå®¿ä¸»æœºä¸Šçš„ç›®å½•å’Œæ–‡ä»¶ä¸åŒè€Œå¯¼è‡´å¯¹Volumeä¸Šç›®å½•å’Œæ–‡ä»¶çš„è®¿é—®ç»“æœä¸ä¸€è‡´ã€‚</li>
<li>å¦‚æœä½¿ç”¨äº†èµ„æºé…é¢ç®¡ç†ï¼Œåˆ™Kubernetesæ— æ³•å°†hostPathåœ¨å®¿ä¸»æœºä¸Šä½¿ç”¨çš„èµ„æºçº³å…¥ç®¡ç†ã€‚</li>
</ul>
<p>3ï¼NFS</p>
<p>ä½¿ç”¨NFSç½‘ç»œæ–‡ä»¶ç³»ç»Ÿæä¾›çš„å…±äº«ç›®å½•å­˜å‚¨æ•°æ®æ—¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç³»ç»Ÿä¸­éƒ¨ç½²ä¸€ä¸ªNFS Serverã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">	<span class="attr">server:</span> <span class="string">nfsæœåŠ¡å™¨ip</span></span><br><span class="line">	<span class="attr">path:</span> <span class="string">"/"</span></span><br></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œconfigmap å’Œ secret ä¹Ÿå¯ä»¥volumeæ¥ä½¿ç”¨ã€‚</p>
<h3 id="Persistent-Volume"><a href="#Persistent-Volume" class="headerlink" title="Persistent Volume"></a>Persistent Volume</h3><p>ä¹‹å‰æåˆ°çš„Volumeæ˜¯è¢«å®šä¹‰åœ¨Podä¸Šçš„ï¼Œå±äºè®¡ç®—èµ„æºçš„ä¸€éƒ¨åˆ†ï¼Œè€Œå®é™…ä¸Šï¼Œç½‘ç»œå­˜å‚¨æ˜¯ç›¸å¯¹ç‹¬ç«‹äºè®¡ç®—èµ„æºè€Œå­˜åœ¨çš„ä¸€ç§å®ä½“èµ„æºã€‚</p>
<p>PVå¯ä»¥è¢«ç†è§£æˆKubernetesé›†ç¾¤ä¸­çš„æŸä¸ªç½‘ç»œå­˜å‚¨å¯¹åº”çš„ä¸€å—å­˜å‚¨ï¼Œå®ƒä¸Volumeç±»ä¼¼ï¼Œä½†æœ‰ä»¥ä¸‹åŒºåˆ«ã€‚</p>
<ul>
<li><p>PVåªèƒ½æ˜¯ç½‘ç»œå­˜å‚¨ï¼Œä¸å±äºä»»ä½•Nodeï¼Œä½†å¯ä»¥åœ¨æ¯ä¸ªNodeä¸Šè®¿é—®ã€‚</p>
</li>
<li><p>PVå¹¶ä¸æ˜¯è¢«å®šä¹‰åœ¨Podä¸Šçš„ï¼Œè€Œæ˜¯ç‹¬ç«‹äºPodä¹‹å¤–å®šä¹‰çš„ã€‚</p>
</li>
<li>PVç›®å‰æ”¯æŒçš„ç±»å‹åŒ…æ‹¬ï¼šgcePersistentDiskã€AWSElasticBlockStoreã€AzureFileã€AzureDiskã€FCï¼ˆFibre Channelï¼‰ã€Flockerã€NFSã€iSCSIã€RBDï¼ˆRados Block Deviceï¼‰ã€CephFSã€Cinderã€GlusterFSã€VsphereVolumeã€Quobyte Volumesã€VMware Photonã€Portworx Volumesã€ScaleIO Volumeså’ŒHostPathï¼ˆä»…ä¾›å•æœºæµ‹è¯•ï¼‰ã€‚</li>
</ul>
<p>NFS PVç¤ºä¾‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">	<span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">	<span class="attr">path:</span> <span class="string">/somepath</span></span><br><span class="line">	<span class="attr">server:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<p>PVçš„accessModeså±æ€§ï¼Œç›®å‰æœ‰ä»¥ä¸‹ç±»å‹ï¼š</p>
<ul>
<li>ReadWriteOnceï¼šè¯»å†™æƒé™ï¼Œå¹¶ä¸”åªèƒ½è¢«å•ä¸ªNodeæŒ‚è½½ã€‚</li>
<li>ReadOnlyManyï¼šåªè¯»æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ã€‚</li>
<li>ReadWriteManyï¼šè¯»å†™æƒé™ï¼Œå…è®¸è¢«å¤šä¸ªNodeæŒ‚è½½ã€‚</li>
</ul>
<h3 id="Persistent-Volume-Claim"><a href="#Persistent-Volume-Claim" class="headerlink" title="Persistent Volume Claim"></a>Persistent Volume Claim</h3><p>å¦‚æœæŸä¸ªPodæƒ³ç”³è¯·æŸç§ç±»å‹çš„PVï¼Œåˆ™é¦–å…ˆéœ€è¦å®šä¹‰ä¸€ä¸ªPersistentVolumeClaimå¯¹è±¡ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myclaim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">	<span class="attr">requests:</span></span><br><span class="line">	  <span class="attr">storage:</span> <span class="string">8Gi</span></span><br></pre></td></tr></table></figure>
<p>ç„¶åï¼Œåœ¨Podçš„Volumeå®šä¹‰ä¸­å¼•ç”¨ä¸Šè¿°PVC</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypd</span></span><br><span class="line">  <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">    <span class="attr">claimName:</span> <span class="string">myclaim</span></span><br></pre></td></tr></table></figure>
<p>PVæ˜¯æœ‰çŠ¶æ€çš„å¯¹è±¡ï¼Œå®ƒçš„çŠ¶æ€æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>
<ul>
<li>Availableï¼šç©ºé—²çŠ¶æ€</li>
<li>Boundï¼šå·²ç»ç»‘å®šåˆ°æŸä¸ªPVCä¸Š</li>
<li>Releasedï¼šå¯¹åº”çš„PVCå·²ç»è¢«åˆ é™¤ï¼Œä½†èµ„æºè¿˜æ²¡æœ‰è¢«é›†ç¾¤æ”¶å›</li>
<li>Failedï¼šPVè‡ªåŠ¨å›æ”¶å¤±è´¥ã€‚</li>
</ul>
<h3 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h3><p>Annotationï¼ˆæ³¨è§£ï¼‰ä¸Labelç±»ä¼¼ï¼Œä¹Ÿä½¿ç”¨key/valueé”®å€¼å¯¹çš„å½¢å¼è¿›è¡Œå®šä¹‰ã€‚</p>
<p>ä¸åŒçš„æ˜¯Labelå…·æœ‰ä¸¥æ ¼çš„å‘½åè§„åˆ™ï¼Œå®ƒå®šä¹‰çš„æ˜¯Kuberneteså¯¹è±¡çš„å…ƒæ•°æ®ï¼ˆMetadataï¼‰ï¼Œå¹¶ä¸”ç”¨äºLabel Selectorã€‚Annotationåˆ™æ˜¯ç”¨æˆ·ä»»æ„å®šä¹‰çš„é™„åŠ ä¿¡æ¯ï¼Œä»¥ä¾¿äºå¤–éƒ¨å·¥å…·æŸ¥æ‰¾ã€‚åœ¨å¾ˆå¤šæ—¶å€™ï¼ŒKubernetesçš„æ¨¡å—è‡ªèº«ä¼šé€šè¿‡Annotationæ ‡è®°èµ„æºå¯¹è±¡çš„ä¸€äº›ç‰¹æ®Šä¿¡æ¯ã€‚</p>
<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><p>æˆ‘ä»¬çŸ¥é“ï¼ŒDockeré€šè¿‡å°†ç¨‹åºã€ä¾èµ–åº“ã€æ•°æ®åŠé…ç½®æ–‡ä»¶â€œæ‰“åŒ…å›ºåŒ–â€åˆ°ä¸€ä¸ªä¸å˜çš„é•œåƒæ–‡ä»¶ä¸­çš„åšæ³•ï¼Œè§£å†³äº†åº”ç”¨çš„éƒ¨ç½²çš„éš¾é¢˜ï¼Œä½†è¿™åŒæ—¶å¸¦æ¥äº†æ£˜æ‰‹çš„é—®é¢˜ï¼Œå³é…ç½®æ–‡ä»¶ä¸­çš„å‚æ•°åœ¨è¿è¡ŒæœŸå¦‚ä½•ä¿®æ”¹çš„é—®é¢˜ã€‚</p>
<p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒDockeræä¾›äº†ä¸¤ç§æ–¹å¼ï¼š</p>
<ul>
<li>åœ¨è¿è¡Œæ—¶é€šè¿‡å®¹å™¨çš„ç¯å¢ƒå˜é‡æ¥ä¼ é€’å‚æ•°</li>
<li>é€šè¿‡Docker Volumeå°†å®¹å™¨å¤–çš„é…ç½®æ–‡ä»¶æ˜ å°„åˆ°å®¹å™¨å†…</li>
</ul>
<p>æˆ‘ä»¬éƒ½å¸Œæœ›èƒ½é›†ä¸­ç®¡ç†ç³»ç»Ÿçš„é…ç½®å‚æ•°ï¼Œè€Œä¸æ˜¯ç®¡ç†ä¸€å †é…ç½®æ–‡ä»¶ã€‚</p>
<p>K8sæŠŠæ‰€æœ‰çš„é…ç½®é¡¹éƒ½å½“ä½œkey-valueå­—ç¬¦ä¸²ï¼Œè¿™äº›é…ç½®é¡¹å¯ä»¥ä½œä¸ºMapè¡¨ä¸­çš„ä¸€ä¸ªé¡¹ï¼Œæ•´ä¸ªMapçš„æ•°æ®å¯ä»¥è¢«æŒä¹…åŒ–å­˜å‚¨åœ¨Kubernetesçš„etcdæ•°æ®åº“ä¸­ï¼Œç„¶åæä¾›APIä»¥æ–¹ä¾¿Kubernetesç›¸å…³ç»„ä»¶æˆ–å®¢æˆ·åº”ç”¨CRUDæ“ä½œè¿™äº›æ•°æ®ï¼Œä¸Šè¿°ä¸“é—¨ç”¨æ¥ä¿å­˜é…ç½®å‚æ•°çš„Mapå°±æ˜¯Kubernetes ConfigMapèµ„æºå¯¹è±¡ã€‚</p>
<p>Kubernetesæä¾›äº†ä¸€ç§å†…å»ºæœºåˆ¶ï¼Œå°†å­˜å‚¨åœ¨etcdä¸­çš„ConfigMapé€šè¿‡Volumeæ˜ å°„çš„æ–¹å¼å˜æˆç›®æ ‡Podå†…çš„é…ç½®æ–‡ä»¶ã€‚</p>
<p>ä¸ç®¡ç›®æ ‡Podè¢«è°ƒåº¦åˆ°å“ªå°æœåŠ¡å™¨ä¸Šï¼Œéƒ½ä¼šå®Œæˆè‡ªåŠ¨æ˜ å°„ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115201737742.png" alt="image-20201115201737742" style="zoom: 67%;"></p>
<p>ConfigMapä¾›å®¹å™¨ä½¿ç”¨çš„å…¸å‹ç”¨é€”å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç”Ÿæˆä¸ºå®¹å™¨å†…çš„ç¯å¢ƒå˜é‡</li>
<li>è®¾ç½®å®¹å™¨å¯åŠ¨å‘½ä»¤çš„å¯åŠ¨å‚æ•°ï¼ˆéœ€è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼‰</li>
<li>ä»¥Volumeçš„å½¢å¼æŒ‚è½½ä¸ºå®¹å™¨å†…éƒ¨çš„æ–‡ä»¶æˆ–ç›®å½•</li>
</ul>
<p>å®¹å™¨åº”ç”¨å¯¹ConfigMapçš„ä½¿ç”¨æœ‰ä»¥ä¸‹ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li>é€šè¿‡ç¯å¢ƒå˜é‡è·å–ConfigMapä¸­çš„å†…å®¹</li>
<li>é€šè¿‡VolumeæŒ‚è½½çš„æ–¹å¼å°†ConfigMapä¸­çš„å†…å®¹æŒ‚è½½ä¸ºå®¹å™¨å†…éƒ¨çš„æ–‡ä»¶æˆ–ç›®å½•</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cm-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env | grep APP"</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APPLOGLEVEL</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cm-appvars</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">apploglevel</span></span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ConfigMapçš„é™åˆ¶æ¡ä»¶å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>ConfigMapå¿…é¡»åœ¨Podä¹‹å‰åˆ›å»ºã€‚</p>
</li>
<li><p>ConfigMapå—Namespaceé™åˆ¶ï¼Œåªæœ‰å¤„äºç›¸åŒNamespaceä¸­çš„Podæ‰å¯ä»¥å¼•ç”¨å®ƒã€‚</p>
</li>
<li>ConfigMapä¸­çš„é…é¢ç®¡ç†è¿˜æœªèƒ½å®ç°ã€‚</li>
<li>kubeletåªæ”¯æŒå¯ä»¥è¢«API Serverç®¡ç†çš„Podä½¿ç”¨ConfigMapã€‚kubeletåœ¨æœ¬Nodeä¸Šé€šè¿‡â€“manifest-urlæˆ–â€“configè‡ªåŠ¨åˆ›å»ºçš„é™æ€Podå°†æ— æ³•å¼•ç”¨ConfigMapã€‚</li>
<li>åœ¨Podå¯¹ConfigMapè¿›è¡ŒæŒ‚è½½ï¼ˆvolumeMountï¼‰æ“ä½œæ—¶ï¼Œåœ¨å®¹å™¨å†…éƒ¨åªèƒ½æŒ‚è½½ä¸ºâ€œç›®å½•â€ï¼Œæ— æ³•æŒ‚è½½ä¸ºâ€œæ–‡ä»¶â€ã€‚</li>
</ul>
<h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><p>Role-Based Access Controlï¼ŒåŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ã€‚</p>
<p>RBACå¼•å…¥äº†4ä¸ªæ–°çš„é¡¶çº§èµ„æºå¯¹è±¡ï¼š Role ã€ ClusterRole ã€ RoleBindingå’ŒClusterRoleBindingã€‚</p>
<p>1ï¼‰è§’è‰²ï¼ˆRoleï¼‰<br>ä¸€ä¸ªè§’è‰²å°±æ˜¯ä¸€ç»„æƒé™çš„é›†åˆï¼Œè¿™é‡Œçš„æƒé™éƒ½æ˜¯è®¸å¯å½¢å¼çš„ï¼Œä¸å­˜åœ¨æ‹’ç»çš„è§„åˆ™ã€‚åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸­ï¼Œå¯ä»¥ç”¨è§’è‰²æ¥å®šä¹‰ä¸€ä¸ªè§’è‰²ï¼Œå¦‚æœæ˜¯é›†ç¾¤çº§åˆ«çš„ï¼Œå°±éœ€è¦ä½¿ç”¨ClusterRoleäº†ã€‚</p>
<p>2ï¼‰é›†ç¾¤è§’è‰²ï¼ˆClusterRoleï¼‰<br>é›†ç¾¤è§’è‰²é™¤äº†å…·æœ‰å’Œè§’è‰²ä¸€è‡´çš„å‘½åç©ºé—´å†…èµ„æºçš„ç®¡ç†èƒ½åŠ›ï¼Œå› å…¶é›†ç¾¤çº§åˆ«çš„èŒƒå›´ï¼Œè¿˜å¯ä»¥ç”¨äºä»¥ä¸‹ç‰¹æ®Šå…ƒç´ çš„æˆæƒï¼š</p>
<ul>
<li>é›†ç¾¤èŒƒå›´çš„èµ„æºï¼Œä¾‹å¦‚Node</li>
<li>éèµ„æºå‹çš„è·¯å¾„ï¼Œä¾‹å¦‚â€œ/healthzâ€</li>
<li>åŒ…å«å…¨éƒ¨å‘½åç©ºé—´çš„èµ„æºï¼Œä¾‹å¦‚podsï¼ˆç”¨äºkubectl get pods â€“all-namespacesè¿™æ ·çš„æ“ä½œæˆæƒï¼‰</li>
</ul>
<p>3ï¼‰è§’è‰²ç»‘å®šï¼ˆRoleBindingï¼‰å’Œé›†ç¾¤è§’è‰²ç»‘å®šï¼ˆClusterRoleBindingï¼‰<br>è§’è‰²ç»‘å®šæˆ–é›†ç¾¤è§’è‰²ç»‘å®šç”¨æ¥æŠŠä¸€ä¸ªè§’è‰²ç»‘å®šåˆ°ä¸€ä¸ªç›®æ ‡ä¸Šï¼Œç»‘å®šç›®æ ‡å¯ä»¥æ˜¯Userï¼ˆç”¨æˆ·ï¼‰ã€Groupï¼ˆç»„ï¼‰æˆ–è€…Service Accountã€‚ä½¿ç”¨RoleBindingä¸ºæŸä¸ªå‘½åç©ºé—´æˆæƒï¼Œä½¿ç”¨ClusterRoleBindingä¸ºé›†ç¾¤èŒƒå›´å†…æˆæƒã€‚</p>
<p>RoleBindingå¯ä»¥å¼•ç”¨Roleè¿›è¡Œæˆæƒã€‚</p>
<p>RoleBindingä¹Ÿå¯ä»¥å¼•ç”¨ClusterRoleï¼Œå¯¹å±äºåŒä¸€å‘½åç©ºé—´å†…ClusterRoleå®šä¹‰çš„èµ„æºä¸»ä½“è¿›è¡Œæˆæƒã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115213549982.png" alt="image-20201115213549982" style="zoom:50%;"></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<p>ç»‘å®šcluster-adminæ„å‘³ç€å…·æœ‰è¶…çº§ç”¨æˆ·æƒé™ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115214009131.png" alt="image-20201115214009131"></p>
<h3 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h3><p>ç”¨äºå°†ä¸åŒURLçš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°åç«¯ä¸åŒçš„Serviceï¼Œä»¥å®ç°<strong>HTTPå±‚</strong>çš„ä¸šåŠ¡è·¯ç”±æœºåˆ¶</p>
<p>Kubernetesä½¿ç”¨äº†ä¸€ä¸ªIngressç­–ç•¥å®šä¹‰å’Œä¸€ä¸ªå…·ä½“çš„Ingress Controllerï¼Œä¸¤è€…ç»“åˆå¹¶å®ç°äº†ä¸€ä¸ªå®Œæ•´çš„Ingressè´Ÿè½½å‡è¡¡å™¨ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115220412264.png" alt="image-20201115220412264" style="zoom:50%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/v2-784c512e37755bcfd6c4ebb63dcbb866_720w.jpg" alt="img"></p>
<p>ä¸ºä½¿ç”¨Ingressï¼Œéœ€è¦åˆ›å»ºIngress Controllerï¼ˆå¸¦ä¸€ä¸ªé»˜è®¤backendæœåŠ¡ï¼‰å’ŒIngressç­–ç•¥è®¾ç½®æ¥å…±åŒå®Œæˆã€‚</p>
<p>Ingress Controlleræœ‰å¤šç§ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/v2-e11d1a3fef7f0bab2ce64a8f721360bd_r.jpg" alt="preview"></p>
<p>helm å®‰è£… ingress-nginx</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm install my-release ingress-nginx/ingress-nginx</span><br></pre></td></tr></table></figure>
<p>traefik ingress ç•Œé¢æ•ˆæœå›¾</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108220655920.png" alt="image-20201108220655920"></p>
<h3 id="secret"><a href="#secret" class="headerlink" title="secret"></a>secret</h3><p>ä¸€ä¸ªSecret Volumeç”¨äºä¸ºPodæä¾›åŠ å¯†çš„ä¿¡æ¯ï¼Œä½ å¯ä»¥å°†å®šä¹‰åœ¨Kubernetesä¸­çš„Secretç›´æ¥æŒ‚è½½ä¸ºæ–‡ä»¶è®©Podè®¿é—®ã€‚Secret Volumeæ˜¯é€šè¿‡TMFSï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰å®ç°çš„ï¼Œè¿™ç§ç±»å‹çš„Volumeä¸ä¼šè¢«æŒä¹…åŒ–ã€‚</p>
<h2 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h2><p>åœ¨Masterä¸Šè¿è¡Œç€ä»¥ä¸‹å…³é”®è¿›ç¨‹ï¼š</p>
<ul>
<li>Kubernetes API Serverï¼ˆkube-apiserverï¼‰ï¼šæä¾›äº†HTTP Restæ¥å£çš„å…³é”®æœåŠ¡è¿›ç¨‹ï¼Œæ˜¯Kubernetesé‡Œæ‰€æœ‰èµ„æºçš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ç­‰æ“ä½œçš„å”¯ä¸€å…¥å£ï¼Œä¹Ÿæ˜¯é›†ç¾¤æ§åˆ¶çš„å…¥å£è¿›ç¨‹ã€‚</li>
<li>Kubernetes Controller Managerï¼ˆkube-controller-managerï¼‰ï¼šKubernetesé‡Œæ‰€æœ‰èµ„æºå¯¹è±¡çš„è‡ªåŠ¨åŒ–æ§åˆ¶ä¸­å¿ƒï¼Œå¯ä»¥å°†å…¶ç†è§£ä¸ºèµ„æºå¯¹è±¡çš„â€œå¤§æ€»ç®¡â€ã€‚</li>
<li>Kubernetes Schedulerï¼ˆkube-schedulerï¼‰ï¼šè´Ÿè´£èµ„æºè°ƒåº¦ï¼ˆPodè°ƒåº¦ï¼‰çš„è¿›ç¨‹ï¼Œç›¸å½“äºå…¬äº¤å…¬å¸çš„â€œè°ƒåº¦å®¤â€ã€‚</li>
<li>ETCDï¼šetcdæœåŠ¡é€šå¸¸éƒ¨ç½²åœ¨masterèŠ‚ç‚¹ä¸Šï¼ŒKubernetesé‡Œçš„æ‰€æœ‰èµ„æºå¯¹è±¡çš„æ•°æ®éƒ½è¢«ä¿å­˜åœ¨etcdã€‚</li>
</ul>
<p>åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¿è¡Œç€ä»¥ä¸‹å…³é”®è¿›ç¨‹ï¼š</p>
<ul>
<li>kubeletï¼šè´Ÿè´£Podå¯¹åº”çš„å®¹å™¨çš„åˆ›å»ºã€å¯åœç­‰ä»»åŠ¡ï¼ŒåŒæ—¶ä¸Masterå¯†åˆ‡åä½œï¼Œå®ç°é›†ç¾¤ç®¡ç†çš„åŸºæœ¬åŠŸèƒ½ã€‚-</li>
<li>kube-proxyï¼šå®ç°Kubernetes Serviceçš„é€šä¿¡ä¸è´Ÿè½½å‡è¡¡æœºåˆ¶çš„é‡è¦ç»„ä»¶ã€‚</li>
<li>Docker Engineï¼ˆdockerï¼‰ï¼šDockerå¼•æ“ï¼Œè´Ÿè´£æœ¬æœºçš„å®¹å™¨åˆ›å»ºå’Œç®¡ç†å·¥ä½œã€‚</li>
</ul>
<h3 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h3><p>Kubernetes API Serverçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æä¾›Kuberneteså„ç±»èµ„æºå¯¹è±¡ï¼ˆå¦‚Podã€RCã€Serviceç­‰ï¼‰çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥åŠWatchç­‰HTTP Restæ¥å£ï¼Œæˆä¸ºé›†ç¾¤å†…å„ä¸ªåŠŸèƒ½æ¨¡å—ä¹‹é—´æ•°æ®äº¤äº’å’Œé€šä¿¡çš„ä¸­å¿ƒæ¢çº½ï¼Œæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ•°æ®æ€»çº¿å’Œæ•°æ®ä¸­å¿ƒã€‚</p>
<p>é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒè¿˜æœ‰ä»¥ä¸‹ä¸€äº›åŠŸèƒ½ç‰¹æ€§ï¼š<br>ï¼ˆ1ï¼‰æ˜¯é›†ç¾¤ç®¡ç†çš„APIå…¥å£ã€‚<br>ï¼ˆ2ï¼‰æ˜¯èµ„æºé…é¢æ§åˆ¶çš„å…¥å£ã€‚<br>ï¼ˆ3ï¼‰æä¾›äº†å®Œå¤‡çš„é›†ç¾¤å®‰å…¨æœºåˆ¶ã€‚</p>
<p>é€šè¿‡å‘½ä»¤è¡Œå·¥å…·kubectlæ¥ä¸Kubernetes API Serveräº¤äº’ï¼Œå®ƒä»¬ä¹‹é—´çš„æ¥å£æ˜¯RESTful APIã€‚</p>
<p><strong>API Serveræ¶æ„è§£æ</strong></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115221020820.png" alt="image-20201115221020820"></p>
<p>ï¼ˆ1ï¼‰APIå±‚ï¼šä¸»è¦ä»¥RESTæ–¹å¼æä¾›å„ç§APIæ¥å£ï¼Œé™¤äº†æœ‰Kubernetesèµ„æºå¯¹è±¡çš„CRUDå’ŒWatchç­‰ä¸»è¦APIï¼Œè¿˜æœ‰å¥åº·æ£€æŸ¥ã€UIã€æ—¥å¿—ã€æ€§èƒ½æŒ‡æ ‡ç­‰è¿ç»´ç›‘æ§ç›¸å…³çš„APIã€‚Kubernetesä»1.11ç‰ˆæœ¬å¼€å§‹åºŸå¼ƒHeapsterç›‘æ§ç»„ä»¶ï¼Œè½¬è€Œä½¿ç”¨Metrics Serveræä¾›Metrics APIæ¥å£ï¼Œè¿›ä¸€æ­¥å®Œå–„äº†è‡ªèº«çš„ç›‘æ§èƒ½åŠ›ã€‚<br>ï¼ˆ2ï¼‰è®¿é—®æ§åˆ¶å±‚ï¼šå½“å®¢æˆ·ç«¯è®¿é—®APIæ¥å£æ—¶ï¼Œè®¿é—®æ§åˆ¶å±‚è´Ÿè´£å¯¹ç”¨æˆ·èº«ä»½é‰´æƒï¼ŒéªŒæ˜ç”¨æˆ·èº«ä»½ï¼Œæ ¸å‡†ç”¨æˆ·å¯¹Kubernetesèµ„æºå¯¹è±¡çš„è®¿é—®æƒé™ï¼Œç„¶åæ ¹æ®é…ç½®çš„å„ç§èµ„æºè®¿é—®è®¸å¯é€»è¾‘ï¼ˆAdmission Controlï¼‰ï¼Œåˆ¤æ–­æ˜¯å¦å…è®¸è®¿é—®ã€‚<br>ï¼ˆ3ï¼‰æ³¨å†Œè¡¨å±‚ï¼šKubernetesæŠŠæ‰€æœ‰èµ„æºå¯¹è±¡éƒ½ä¿å­˜åœ¨æ³¨å†Œè¡¨ï¼ˆRegistryï¼‰ä¸­ï¼Œé’ˆå¯¹æ³¨å†Œè¡¨ä¸­çš„å„ç§èµ„æºå¯¹è±¡éƒ½å®šä¹‰äº†ï¼šèµ„æºå¯¹è±¡çš„ç±»å‹ã€å¦‚ä½•åˆ›å»ºèµ„æºå¯¹è±¡ã€å¦‚ä½•è½¬æ¢èµ„æºçš„ä¸åŒç‰ˆæœ¬ï¼Œä»¥åŠå¦‚ä½•å°†èµ„æºç¼–ç å’Œè§£ç ä¸ºJSONæˆ–ProtoBufæ ¼å¼è¿›è¡Œå­˜å‚¨ã€‚<br>ï¼ˆ4ï¼‰etcdæ•°æ®åº“ï¼šç”¨äºæŒä¹…åŒ–å­˜å‚¨Kubernetesèµ„æºå¯¹è±¡çš„KVæ•°æ®åº“ã€‚etcdçš„watch APIæ¥å£å¯¹äºAPI Serveræ¥è¯´è‡³å…³é‡è¦ï¼Œå› ä¸ºé€šè¿‡è¿™ä¸ªæ¥å£ï¼ŒAPI Serveråˆ›æ–°æ€§åœ°è®¾è®¡äº†List-Watchè¿™ç§é«˜æ€§èƒ½çš„èµ„æºå¯¹è±¡å®æ—¶åŒæ­¥æœºåˆ¶ï¼Œä½¿Kuberneteså¯ä»¥ç®¡ç†è¶…å¤§è§„æ¨¡çš„é›†ç¾¤ï¼ŒåŠæ—¶å“åº”å’Œå¿«é€Ÿå¤„ç†é›†ç¾¤ä¸­çš„å„ç§äº‹ä»¶ã€‚</p>
<h3 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œæ™ºèƒ½ç³»ç»Ÿå’Œè‡ªåŠ¨ç³»ç»Ÿé€šå¸¸ä¼šé€šè¿‡ä¸€ä¸ªâ€œæ“ä½œç³»ç»Ÿâ€æ¥ä¸æ–­ä¿®æ­£ç³»ç»Ÿçš„å·¥ä½œçŠ¶æ€ã€‚åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œæ¯ä¸ªControlleréƒ½æ˜¯è¿™æ ·çš„ä¸€ä¸ªâ€œæ“ä½œç³»ç»Ÿâ€ï¼Œå®ƒä»¬é€šè¿‡API Serveræä¾›çš„ï¼ˆList-Watchï¼‰æ¥å£å®æ—¶ç›‘æ§é›†ç¾¤ä¸­ç‰¹å®šèµ„æºçš„çŠ¶æ€å˜åŒ–ï¼Œå½“å‘ç”Ÿå„ç§æ•…éšœå¯¼è‡´æŸèµ„æºå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒControllerä¼šå°è¯•å°†å…¶çŠ¶æ€è°ƒæ•´ä¸ºæœŸæœ›çš„çŠ¶æ€ã€‚æ¯”å¦‚å½“æŸä¸ªNodeæ„å¤–å®•æœºæ—¶ï¼ŒNode Controllerä¼šåŠæ—¶å‘ç°æ­¤æ•…éšœå¹¶æ‰§è¡Œè‡ªåŠ¨åŒ–ä¿®å¤æµç¨‹ï¼Œç¡®ä¿é›†ç¾¤å§‹ç»ˆå¤„äºé¢„æœŸçš„å·¥ä½œçŠ¶æ€ã€‚Controller Manageræ˜¯Kubernetesä¸­å„ç§æ“ä½œç³»ç»Ÿçš„ç®¡ç†è€…ï¼Œæ˜¯é›†ç¾¤å†…éƒ¨çš„ç®¡ç†æ§åˆ¶ä¸­å¿ƒï¼Œä¹Ÿæ˜¯Kubernetesè‡ªåŠ¨åŒ–åŠŸèƒ½çš„æ ¸å¿ƒã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230301979.png" alt="image-20201115230301979"></p>
<h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p>å‰é¢æ·±å…¥åˆ†æäº†Controller ManageråŠå®ƒæ‰€åŒ…å«çš„å„ä¸ªç»„ä»¶çš„è¿è¡Œæœºåˆ¶ï¼Œæœ¬èŠ‚å°†ç»§ç»­å¯¹Kubernetesä¸­è´Ÿè´£Podè°ƒåº¦çš„é‡è¦åŠŸèƒ½æ¨¡å—â€”â€”Kubernetes Schedulerçš„å·¥ä½œåŸç†å’Œè¿è¡Œæœºåˆ¶åšæ·±å…¥åˆ†æã€‚</p>
<p>Kubernetes Scheduleråœ¨æ•´ä¸ªç³»ç»Ÿä¸­æ‰¿æ‹…äº†â€œæ‰¿ä¸Šå¯ä¸‹â€çš„é‡è¦åŠŸèƒ½ï¼Œâ€œæ‰¿ä¸Šâ€æ˜¯æŒ‡å®ƒè´Ÿè´£æ¥æ”¶Controller Manageråˆ›å»ºçš„æ–°Podï¼Œä¸ºå…¶å®‰æ’ä¸€ä¸ªè½è„šçš„â€œå®¶â€â€”â€”ç›®æ ‡Nodeï¼›â€œå¯ä¸‹â€æ˜¯æŒ‡å®‰ç½®å·¥ä½œå®Œæˆåï¼Œç›®æ ‡Nodeä¸Šçš„kubeletæœåŠ¡è¿›ç¨‹æ¥ç®¡åç»§å·¥ä½œï¼Œè´Ÿè´£Podç”Ÿå‘½å‘¨æœŸä¸­çš„â€œä¸‹åŠç”Ÿâ€ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼ŒKubernetes Schedulerçš„ä½œç”¨æ˜¯å°†å¾…è°ƒåº¦çš„Podï¼ˆAPIæ–°åˆ›å»ºçš„Podã€Controller Managerä¸ºè¡¥è¶³å‰¯æœ¬è€Œåˆ›å»ºçš„Podç­‰ï¼‰æŒ‰ç…§ç‰¹å®šçš„è°ƒåº¦ç®—æ³•å’Œè°ƒåº¦ç­–ç•¥ç»‘å®šï¼ˆBindingï¼‰åˆ°é›†ç¾¤ä¸­æŸä¸ªåˆé€‚çš„Nodeä¸Šï¼Œå¹¶å°†ç»‘å®šä¿¡æ¯å†™å…¥etcdä¸­ã€‚åœ¨æ•´ä¸ªè°ƒåº¦è¿‡ç¨‹ä¸­æ¶‰åŠä¸‰ä¸ªå¯¹è±¡ï¼Œåˆ†åˆ«æ˜¯å¾…è°ƒåº¦Podåˆ—è¡¨ã€å¯ç”¨Nodeåˆ—è¡¨ï¼Œä»¥åŠè°ƒåº¦ç®—æ³•å’Œç­–ç•¥ã€‚ç®€å•åœ°è¯´ï¼Œå°±æ˜¯é€šè¿‡è°ƒåº¦ç®—æ³•è°ƒåº¦ä¸ºå¾…è°ƒåº¦Podåˆ—è¡¨ä¸­çš„æ¯ä¸ªPodä»Nodeåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªæœ€é€‚åˆçš„Nodeã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230446082.png" alt="image-20201115230446082" style="zoom:67%;"></p>
<p>éšåï¼Œç›®æ ‡èŠ‚ç‚¹ä¸Šçš„kubeleté€šè¿‡API Serverç›‘å¬åˆ°Kubernetes Scheduleräº§ç”Ÿçš„Podç»‘å®šäº‹ä»¶ï¼Œç„¶åè·å–å¯¹åº”çš„Podæ¸…å•ï¼Œä¸‹è½½Imageé•œåƒå¹¶å¯åŠ¨å®¹å™¨ã€‚</p>
<p>Kubernetes Schedulerå½“å‰æä¾›çš„é»˜è®¤è°ƒåº¦æµç¨‹åˆ†ä¸ºä»¥ä¸‹ä¸¤æ­¥ï¼š<br>ï¼ˆ1ï¼‰é¢„é€‰è°ƒåº¦è¿‡ç¨‹ï¼Œå³éå†æ‰€æœ‰ç›®æ ‡Nodeï¼Œç­›é€‰å‡ºç¬¦åˆè¦æ±‚çš„å€™é€‰èŠ‚ç‚¹ã€‚ä¸ºæ­¤ï¼ŒKuberneteså†…ç½®äº†å¤šç§é¢„é€‰ç­–ç•¥ï¼ˆxxx Predicatesï¼‰ä¾›ç”¨æˆ·é€‰æ‹©ã€‚<br>ï¼ˆ2ï¼‰ç¡®å®šæœ€ä¼˜èŠ‚ç‚¹ï¼Œåœ¨ç¬¬1æ­¥çš„åŸºç¡€ä¸Šï¼Œé‡‡ç”¨ä¼˜é€‰ç­–ç•¥ï¼ˆxxx Priorityï¼‰è®¡ç®—å‡ºæ¯ä¸ªå€™é€‰èŠ‚ç‚¹çš„ç§¯åˆ†ï¼Œç§¯åˆ†æœ€é«˜è€…èƒœå‡ºã€‚</p>
<h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼Œåœ¨æ¯ä¸ªNodeï¼ˆåˆç§°Minionï¼‰ä¸Šéƒ½ä¼šå¯åŠ¨ä¸€ä¸ªkubeletæœåŠ¡è¿›ç¨‹ã€‚è¯¥è¿›ç¨‹ç”¨äºå¤„ç†Masterä¸‹å‘åˆ°æœ¬èŠ‚ç‚¹çš„ä»»åŠ¡ï¼Œç®¡ç†PodåŠPodä¸­çš„å®¹å™¨ã€‚æ¯ä¸ªkubeletè¿›ç¨‹éƒ½ä¼šåœ¨API Serverä¸Šæ³¨å†ŒèŠ‚ç‚¹è‡ªèº«çš„ä¿¡æ¯ï¼Œå®šæœŸå‘Masteræ±‡æŠ¥èŠ‚ç‚¹èµ„æºçš„ä½¿ç”¨æƒ…å†µï¼Œå¹¶é€šè¿‡cAdvisorç›‘æ§å®¹å™¨å’ŒèŠ‚ç‚¹èµ„æºã€‚</p>
<h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><p>æˆ‘ä»¬åœ¨å‰é¢å·²ç»äº†è§£åˆ°ï¼Œä¸ºäº†æ”¯æŒé›†ç¾¤çš„æ°´å¹³æ‰©å±•ã€é«˜å¯ç”¨æ€§ï¼ŒKubernetesæŠ½è±¡å‡ºäº†Serviceçš„æ¦‚å¿µã€‚Serviceæ˜¯å¯¹ä¸€ç»„Podçš„æŠ½è±¡ï¼Œå®ƒä¼šæ ¹æ®è®¿é—®ç­–ç•¥ï¼ˆå¦‚è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼‰æ¥è®¿é—®è¿™ç»„Podã€‚</p>
<p>Kubernetesåœ¨åˆ›å»ºæœåŠ¡æ—¶ä¼šä¸ºæœåŠ¡åˆ†é…ä¸€ä¸ªè™šæ‹Ÿçš„IPåœ°å€ï¼Œå®¢æˆ·ç«¯é€šè¿‡è®¿é—®è¿™ä¸ªè™šæ‹Ÿçš„IPåœ°å€æ¥è®¿é—®æœåŠ¡ï¼ŒæœåŠ¡åˆ™è´Ÿè´£å°†è¯·æ±‚è½¬å‘åˆ°åç«¯çš„Podä¸Šã€‚è¿™ä¸å°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†å—ï¼Ÿæ²¡é”™ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªåå‘ä»£ç†ã€‚ä½†æ˜¯ï¼Œå®ƒå’Œæ™®é€šçš„åå‘ä»£ç†æœ‰ä¸€äº›ä¸åŒï¼šé¦–å…ˆï¼Œå®ƒçš„IPåœ°å€æ˜¯è™šæ‹Ÿçš„ï¼Œæƒ³ä»å¤–é¢è®¿é—®è¿˜éœ€è¦ä¸€äº›æŠ€å·§ï¼›å…¶æ¬¡ï¼Œå®ƒçš„éƒ¨ç½²å’Œå¯åœæ˜¯ç”±Kubernetesç»Ÿä¸€è‡ªåŠ¨ç®¡ç†çš„ã€‚</p>
<p>åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼ŒServiceåªæ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œè€ŒçœŸæ­£å°†Serviceçš„ä½œç”¨è½å®çš„æ˜¯å®ƒèƒŒåçš„kube-proxyæœåŠ¡è¿›ç¨‹ã€‚åªæœ‰ç†è§£äº†kube-proxyçš„åŸç†å’Œæœºåˆ¶ï¼Œæˆ‘ä»¬æ‰èƒ½çœŸæ­£ç†è§£ServiceèƒŒåçš„å®ç°é€»è¾‘ã€‚</p>
<p>åœ¨Kubernetesé›†ç¾¤çš„æ¯ä¸ªNodeä¸Šéƒ½ä¼šè¿è¡Œä¸€ä¸ªkube-proxyæœåŠ¡è¿›ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠè¿™ä¸ªè¿›ç¨‹çœ‹ä½œServiceçš„é€æ˜ä»£ç†å…¼è´Ÿè½½å‡è¡¡å™¨ï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½æ˜¯å°†åˆ°æŸä¸ªServiceçš„è®¿é—®è¯·æ±‚è½¬å‘åˆ°åç«¯çš„å¤šä¸ªPodå®ä¾‹ä¸Šã€‚æ­¤å¤–ï¼ŒServiceçš„Cluster IPä¸NodePortç­‰æ¦‚å¿µæ˜¯kube-proxyæœåŠ¡é€šè¿‡iptablesçš„NATè½¬æ¢å®ç°çš„ï¼Œkube-proxyåœ¨è¿è¡Œè¿‡ç¨‹ä¸­åŠ¨æ€åˆ›å»ºä¸Serviceç›¸å…³çš„iptablesè§„åˆ™ï¼Œè¿™äº›è§„åˆ™å®ç°äº†å°†è®¿é—®æœåŠ¡ï¼ˆCluster IPæˆ–NodePortï¼‰çš„è¯·æ±‚è´Ÿè½½åˆ†å‘åˆ°åç«¯Podçš„åŠŸèƒ½ã€‚ç”±äºiptablesæœºåˆ¶é’ˆå¯¹çš„æ˜¯æœ¬åœ°çš„kube-proxyç«¯å£ï¼Œæ‰€ä»¥åœ¨æ¯ä¸ªNodeä¸Šéƒ½è¦è¿è¡Œkube-proxyç»„ä»¶ï¼Œè¿™æ ·ä¸€æ¥ï¼Œåœ¨Kubernetesé›†ç¾¤å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä»»æ„Nodeä¸Šå‘èµ·å¯¹Serviceçš„è®¿é—®è¯·æ±‚ã€‚ç»¼ä¸Šæ‰€è¿°ï¼Œç”±äºkube-proxyçš„ä½œç”¨ï¼Œåœ¨Serviceçš„è°ƒç”¨è¿‡ç¨‹ä¸­å®¢æˆ·ç«¯æ— é¡»å…³å¿ƒåç«¯æœ‰å‡ ä¸ªPodï¼Œä¸­é—´è¿‡ç¨‹çš„é€šä¿¡ã€è´Ÿè½½å‡è¡¡åŠæ•…éšœæ¢å¤éƒ½æ˜¯é€æ˜çš„ã€‚</p>
<p>èµ·åˆï¼Œkube-proxyè¿›ç¨‹æ˜¯ä¸€ä¸ªçœŸå®çš„TCP/UDPä»£ç†ï¼Œç±»ä¼¼HA Proxyï¼Œè´Ÿè´£ä»Serviceåˆ°Podçš„è®¿é—®æµé‡çš„è½¬å‘ï¼Œè¿™ç§æ¨¡å¼è¢«ç§°ä¸ºuserspaceï¼ˆç”¨æˆ·ç©ºé—´ä»£ç†ï¼‰æ¨¡å¼ã€‚å¦‚å›¾5.13æ‰€ç¤ºï¼Œå½“æŸä¸ªPodä»¥Cluster IPæ–¹å¼è®¿é—®æŸä¸ªServiceçš„æ—¶å€™ï¼Œè¿™ä¸ªæµé‡ä¼šè¢«Podæ‰€åœ¨æœ¬æœºçš„iptablesè½¬å‘åˆ°æœ¬æœºçš„kube-proxyè¿›ç¨‹ï¼Œç„¶åç”±kube-proxyå»ºç«‹èµ·åˆ°åç«¯Podçš„TCP/UDPè¿æ¥ï¼Œéšåå°†è¯·æ±‚è½¬å‘åˆ°æŸä¸ªåç«¯Podä¸Šï¼Œå¹¶åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å®ç°è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p>
<p>å›¾ï¼šServiceçš„è´Ÿè½½å‡è¡¡è½¬å‘è§„åˆ™</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230811684.png" alt="image-20201115230811684"></p>
<h1 id="æ¡ˆä¾‹-â€”â€”-éƒ¨ç½²mywebè‡³K8s"><a href="#æ¡ˆä¾‹-â€”â€”-éƒ¨ç½²mywebè‡³K8s" class="headerlink" title="æ¡ˆä¾‹ â€”â€” éƒ¨ç½²mywebè‡³K8s"></a>æ¡ˆä¾‹ â€”â€” éƒ¨ç½²mywebè‡³K8s</h1><h2 id="é‡åˆ¶é•œåƒ"><a href="#é‡åˆ¶é•œåƒ" class="headerlink" title="é‡åˆ¶é•œåƒ"></a>é‡åˆ¶é•œåƒ</h2><p>ä¹‹å‰æˆ‘ä»¬æ˜¯ä½¿ç”¨dockerè¿è¡Œmywebè¿™ä¸ªdemoçš„ï¼Œå¹¶ä¸”ä¸ºäº†ç®€å•ï¼Œå°†mysqlçš„ç”¨æˆ·åã€å¯†ç å†™æ­»åœ¨settings.pyé‡Œäº†ã€‚</p>
<p>ç°åœ¨æ”¹æˆå¦‚ä¸‹ï¼Œè®©name, user, password, host, portåˆ†åˆ«ä»ç¯å¢ƒå˜é‡DB_NAME, DB_USER, DB_PASSWORD, DB_HOST, DB_PORT è·å–ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">DATABASES = &#123; </span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: os.environ.get(<span class="string">'DB_NAME'</span>),</span><br><span class="line">        <span class="string">'USER'</span>: os.environ.get(<span class="string">'DB_USER'</span>)</span><br><span class="line">        <span class="string">'PASSWORD'</span>: os.environ.get(<span class="string">'DB_PASSWORD'</span>),</span><br><span class="line">        <span class="string">'HOST'</span>: os.environ.get(<span class="string">'DB_HOST'</span>),</span><br><span class="line">        <span class="string">'PORT'</span>: os.environ.get(<span class="string">'DB_PORT'</span>),</span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡æ–°åˆ¶ä½œé•œåƒ myweb:0.2ï¼Œå¹¶ä¸Šä¼ è‡³ harborã€‚</p>
<p>æ¶‰åŠåˆ°ç¯å¢ƒå˜é‡çš„ä¼ é€’ï¼Œå¯ä»¥é€šè¿‡docker-composeéªŒè¯ä¸€ä¸‹æ–°é•œåƒæ˜¯å¦æ­£å¸¸ã€‚</p>
<p>docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@localhost</span> <span class="string">demo]#</span> <span class="string">cat</span> <span class="string">docker-compose.yml</span> </span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myweb:0.2</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">DB_NAME:</span> <span class="string">"testpv"</span></span><br><span class="line">      <span class="attr">DB_USER:</span> <span class="string">"root"</span></span><br><span class="line">      <span class="attr">DB_PASSWORD:</span> <span class="string">"mysql"</span></span><br><span class="line">      <span class="attr">DB_HOST:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.13</span></span><br><span class="line">      <span class="attr">DB_PORT:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="comment">#command: ['']</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/log:/var/log</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8009</span><span class="string">:8000</span></span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•æ²¡é—®é¢˜ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost demo]<span class="comment"># docker-compose up -d</span></span><br><span class="line">Creating demo_db_1 ... <span class="keyword">done</span></span><br><span class="line">[root@localhost demo]<span class="comment"># docker-compose ps</span></span><br><span class="line">  Name                 Command               State           Ports         </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">demo_db_1   supervisord -n -c /etc/sup ...   Up      0.0.0.0:8009-&gt;8000/tcp</span><br><span class="line">[root@localhost demo]<span class="comment"># curl http://localhost:8009/visit/add/</span></span><br><span class="line"></span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> <span class="built_in">type</span>=<span class="string">"text/css"</span> href=<span class="string">"/static/visit/style.css"</span>/&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;table class=<span class="string">"gridtable"</span>&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;ID&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;date&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;ip_addr&lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;47&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;2020-11-08 11:55:56&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;172.17.0.1&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>å¦å¤–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡docker runå¯åŠ¨ï¼Œâ€“env-fileåŠ è½½ç¯å¢ƒå˜é‡ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost demo]<span class="comment"># cat env</span></span><br><span class="line">DB_NAME=testpv</span><br><span class="line">DB_USER=root</span><br><span class="line">DB_PASSWORD=mysql</span><br><span class="line">DB_HOST=172.17.0.13</span><br><span class="line">DB_PORT=3306</span><br><span class="line">[root@localhost demo]<span class="comment"># docker run -d --name myweb -p 8009:8000 --env-file=env myweb:0.2</span></span><br></pre></td></tr></table></figure>
<h2 id="æ¨é€é•œåƒè‡³harbor"><a href="#æ¨é€é•œåƒè‡³harbor" class="headerlink" title="æ¨é€é•œåƒè‡³harbor"></a>æ¨é€é•œåƒè‡³harbor</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost demo]<span class="comment"># docker tag myweb:0.2 harbor.lzzeng.cn/devops/myweb:0.2</span></span><br><span class="line">[root@localhost demo]<span class="comment"># docker image ls myweb</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">myweb               0.2                 0245c29d6060        25 minutes ago      325MB</span><br><span class="line">[root@localhost demo]<span class="comment"># docker image ls |grep myweb</span></span><br><span class="line">myweb                            0.2                              0245c29d6060        25 minutes ago      325MB</span><br><span class="line">harbor.lzzeng.cn/devops/myweb    0.2                              0245c29d6060        25 minutes ago      325MB</span><br><span class="line">[root@localhost demo]<span class="comment"># </span></span><br><span class="line">[root@localhost demo]<span class="comment"># docker push harbor.lzzeng.cn/devops/myweb:0.2</span></span><br><span class="line">The push refers to repository [harbor.lzzeng.cn/devops/myweb]</span><br><span class="line">7615e9027750: Pushed </span><br><span class="line">8daa36f6b1b1: Pushed </span><br><span class="line">c4b9879e46c2: Pushed </span><br><span class="line">879c0d8666e3: Mounted from devops/alerts </span><br><span class="line">20a7b70bdf2f: Mounted from devops/alerts </span><br><span class="line">3fc750b41be7: Mounted from devops/alerts </span><br><span class="line">beee9f30bc1f: Mounted from devops/alerts </span><br><span class="line">0.2: digest: sha256:4a74959ea51a5834436ecda47f9e9d461d4ec43a68ff1976c555dc6ba2878842 size: 1788</span><br></pre></td></tr></table></figure>
<p>åœ¨Harborä¸Šå¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108202423148.png" alt="image-20201108202423148"></p>
<h2 id="åˆ›å»ºK8sèµ„æºå¯¹è±¡"><a href="#åˆ›å»ºK8sèµ„æºå¯¹è±¡" class="headerlink" title="åˆ›å»ºK8sèµ„æºå¯¹è±¡"></a>åˆ›å»ºK8sèµ„æºå¯¹è±¡</h2><p>å‡è®¾æˆ‘ä»¬ä»ä½¿ç”¨å·²ç»ç‹¬ç«‹éƒ¨ç½²å¥½çš„mysqlï¼Œç°åœ¨åªéœ€è¦å†™mywebçš„k8séƒ¨ç½²æ–‡ä»¶ã€‚</p>
<h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p>å…ˆæ¥åˆ›å»ºä¸€ä¸ªnamespace</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@m01 myweb]<span class="comment"># kubectl create ns myweb</span></span><br><span class="line">namespace/myweb created</span><br></pre></td></tr></table></figure>
<h3 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h3><p>ç”±äºç”¨åˆ°äº†supervisorï¼Œå°†å…¶é…ç½®æ–‡ä»¶åˆ›å»ºä¸ºä¸€ä¸ªconfigmap</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@m01 myweb]<span class="comment"># ls</span></span><br><span class="line">myweb_supervisord.conf</span><br><span class="line">[root@m01 myweb]<span class="comment"># </span></span><br><span class="line">[root@m01 myweb]<span class="comment"># #åˆ›å»ºconfigmap</span></span><br><span class="line">[root@m01 myweb]<span class="comment"># </span></span><br><span class="line">[root@m01 myweb]<span class="comment"># kubectl create -n myweb configmap myweb-supervisord-conf --from-file=myweb_supervisord.conf</span></span><br><span class="line">configmap/myweb-supervisord-conf created</span><br><span class="line">[root@m01 myweb]<span class="comment"># </span></span><br><span class="line">[root@m01 myweb]<span class="comment"># kubectl get cm -n myweb</span></span><br><span class="line">NAME                     DATA   AGE</span><br><span class="line">myweb-supervisord-conf   1      7s</span><br><span class="line">[root@m01 myweb]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>é€šè¿‡â€“from-fileå‚æ•°åˆ›å»ºçš„myweb-supervisord-confå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  myweb_supervisord.conf: |</span><br><span class="line">    [program:myweb]</span><br><span class="line">    <span class="built_in">command</span>=/usr/<span class="built_in">local</span>/bin/python manage.py runserver 0.0.0.0:8000</span><br><span class="line">    directory=/opt/apps/myweb</span><br><span class="line">    user=root</span><br><span class="line">    startsecs=3</span><br><span class="line">    redirect_stderr=<span class="literal">true</span></span><br><span class="line">    stdout_logfile_maxbytes=20MB</span><br><span class="line">    stdout_logfile_backups=3</span><br><span class="line">    stdout_logfile=/var/<span class="built_in">log</span>/myweb_supervisor.log</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2020-11-08T10:11:46Z"</span></span><br><span class="line">  name: myweb-supervisord-conf</span><br><span class="line">  namespace: myweb</span><br><span class="line">  resourceVersion: <span class="string">"1135081"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/myweb/configmaps/myweb-supervisord-conf</span><br><span class="line">  uid: 42cd4d5c-48c4-4845-b1a9-102eb78f591a</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ç›´æ¥å†™ä¸€ä¸ªyamlæ–‡ä»¶ï¼š</p>
<p>myweb-supervisord-conf.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myweb_supervisord.conf:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">[program:myweb]</span></span><br><span class="line">    <span class="string">command=/usr/local/bin/python</span> <span class="string">manage.py</span> <span class="string">runserver</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8000</span></span><br><span class="line">    <span class="string">directory=/opt/apps/myweb</span></span><br><span class="line">    <span class="string">user=root</span></span><br><span class="line">    <span class="string">startsecs=3</span></span><br><span class="line">    <span class="string">redirect_stderr=true</span></span><br><span class="line">    <span class="string">stdout_logfile_maxbytes=20MB</span></span><br><span class="line">    <span class="string">stdout_logfile_backups=3</span></span><br><span class="line">    <span class="string">stdout_logfile=/var/log/myweb_supervisor.log</span></span><br></pre></td></tr></table></figure>
<p>ç„¶å</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl create -n myweb configmap myweb-supervisord-conf -f myweb-supervisord-conf.yml</span><br></pre></td></tr></table></figure>
<h3 id="secret-1"><a href="#secret-1" class="headerlink" title="secret"></a>secret</h3><p>å‡è®¾mysqlè¿æ¥å‚æ•°å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">user=root</span><br><span class="line">password=mysql</span><br><span class="line">host=192.168.100.200</span><br><span class="line">port=3306</span><br><span class="line">name=testpv</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå¸¦å‚æ•°çš„æ–¹å¼åˆ›å»ºä¸€ä¸ªsecret</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@m01 myweb]<span class="comment"># kubectl create -n myweb secret generic db-secret --from-literal=name=testpv --from-literal=user=root --from-literal=host=192.168.100.200 --from-literal=port=3306 --from-literal=password=mysql</span></span><br><span class="line">secret/db-secret created</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥å…ˆç¼–å†™ä¸€ä¸ªsecretæ–‡ä»¶ï¼ˆdataå­—æ®µé‡‡ç”¨base64ç¼–ç ï¼‰ï¼Œå†åˆ›å»ºsecret</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">MTkyLjE2OC4xMDAuMjAwCg==</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dGVzdHB2</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">bXlzcWwK</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">MzMwNg==</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">cm9vdA==</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br></pre></td></tr></table></figure>
<p>ä»dashboardå¯ä»¥çœ‹åˆ°åˆ›å»ºçš„ä¿å¯†å­—å…¸db-secretå†…å®¹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201109005053678.png" alt="image-20201109005053678"></p>
<h3 id="deploymentã€serviceå’Œingress"><a href="#deploymentã€serviceå’Œingress" class="headerlink" title="deploymentã€serviceå’Œingress"></a>deploymentã€serviceå’Œingress</h3><p>myweb-dep.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">harbor.lzzeng.cn/devops/myweb:0.2</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1000Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">0.5</span> </span><br><span class="line">            <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USER</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">user</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">host</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PORT</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">port</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ui</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<p>myweb-svc.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">ui</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30888</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure>
<p>myweb-ing.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">myweb.lzzeng.cn</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>
<h3 id="kubectl-create"><a href="#kubectl-create" class="headerlink" title="kubectl create"></a>kubectl create</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl create -n myweb -f myweb-def.yml</span><br><span class="line">kubectl create -n myweb -f myweb-svc.yml</span><br><span class="line">kubectl create -n myweb -f myweb-ing.yml</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108203029458.png" alt="image-20201108203029458"></p>
<p>æ˜¯deploymentæ–‡ä»¶ä¸­secretåç§°å†™é”™äº†ï¼Œä¿®æ”¹myweb-dep.ymlï¼Œæ›´æ–°åæ­£å¸¸ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl apply -n myweb -f myweb-def.yml</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108213925801.png" alt="image-20201108213925801"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108234036126.png" alt="image-20201108234036126"></p>
<h1 id="ä½¿ç”¨-helm-ä¸-harbor"><a href="#ä½¿ç”¨-helm-ä¸-harbor" class="headerlink" title="ä½¿ç”¨ helm ä¸ harbor"></a>ä½¿ç”¨ helm ä¸ harbor</h1><p>helmæ˜¯K8sçš„chartç®¡ç†å·¥å…·, harboræ˜¯dockeré•œåƒã€helm chartsæ‰˜ç®¡å¹³å°ã€‚</p>
<h2 id="ä½¿ç”¨helm"><a href="#ä½¿ç”¨helm" class="headerlink" title="ä½¿ç”¨helm"></a>ä½¿ç”¨helm</h2><p>helmå®‰è£…prometheus</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115001019175.png" alt="image-20201115001019175"></p>
<p>grafanaæ•ˆæœå›¾</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115022804654.png" alt="image-20201115022804654"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115173012548.png" alt="image-20201115173012548"></p>
<p>ç¼–å†™helm chartï¼Œæ¨é€è‡³harborå‘½ä»¤ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">helm create mychart</span><br><span class="line"><span class="comment"># ç¼–å†™...</span></span><br><span class="line">helm push -u xxx -p xxxxxx  ./  &lt;ä¸Šä¼ è‡³charté¡¹ç›®åœ°å€&gt;</span><br></pre></td></tr></table></figure>
<p>helméƒ¨ç½²ELK</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">helm install elastic/elasticsearch -n elk-es --namespace elk</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108222828848.png" alt="image-20201108222828848"></p>
<h2 id="ä½¿ç”¨harbor"><a href="#ä½¿ç”¨harbor" class="headerlink" title="ä½¿ç”¨harbor"></a>ä½¿ç”¨harbor</h2><blockquote>
<p>å®˜æ–¹githubï¼š<a href="https://github.com/goharbor/harbor" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/goharbor/harbor</a></p>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://goharbor.io/docs/2.0.0/install-config/" rel="external nofollow noopener noreferrer" target="_blank">https://goharbor.io/docs/2.0.0/install-config/</a></p>
</blockquote>
<p>åˆ›å»ºè‡ªç­¾åè¯ä¹¦ï¼ˆä¸€å¹´æœŸï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ./tls.key -out ./tls.crt -subj <span class="string">"/CN=ä½ çš„è‡ªå®šä¹‰harboråŸŸå"</span></span><br></pre></td></tr></table></figure>
<p>harbor.ymlé…ç½®ç¤ºä¾‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108223522500.png" alt="image-20201108223522500"></p>
<p>Harborè¦å¯ç”¨helm chartsç®¡ç†åŠŸèƒ½ï¼Œåœ¨å®‰è£…æ—¶è¦æ·»åŠ <code>--with-chartmuseum</code>å‚æ•°ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">./install.sh --with-chartmuseum</span><br></pre></td></tr></table></figure>
<p>Harborçš„chartsç®¡ç†ç•Œé¢ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108164730437.png" alt="image-20201108164730437"></p>
<p>å¯ä»¥é€šè¿‡webç•Œé¢ä¸Šä¼ æ‰“åŒ…å¥½çš„chartï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨helm pushå‘½ä»¤æ¨é€ã€‚</p>
<p>åœ¨ä½¿ç”¨æ—¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. æ·»åŠ repo</span></span><br><span class="line">helm repo add --ca-file &lt;ca file&gt; --cert-file &lt;cert file&gt; --key-file &lt;key file&gt;     --username &lt;username&gt; --password &lt;password&gt; &lt;repo name&gt; https://&lt;harboråœ°å€&gt;/chartrepo/&lt;é¡¹ç›®åç§°&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. è·å–chartåŒ…</span></span><br><span class="line"><span class="comment"># helm fetch &lt;é¡¹ç›®åç§°&gt;/&lt;chartåç§°&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ç›´æ¥ä½¿ç”¨chartå®‰è£…éƒ¨ç½²è‡³K8s</span></span><br><span class="line">helm install --name &lt;è‡ªå®šä¹‰éƒ¨ç½²å&gt; --namespace &lt;æŒ‡å®šéƒ¨ç½²åˆ°å“ªä¸ªåç§°ç©ºé—´&gt; [å…¶å®ƒé€‰é¡¹] &lt;é¡¹ç›®åç§°&gt;/&lt;chartåç§°&gt;</span><br></pre></td></tr></table></figure>
<p>Harborçš„é•œåƒä»“åº“ç®¡ç†ç•Œé¢ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108165325479.png" alt="image-20201108165325479"></p>
<h1 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h1><ol>
<li><p><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>
</li>
<li><p><a href="https://github.com/goharbor/harbor" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/goharbor/harbor</a></p>
</li>
<li><p><a href="https://doc.traefik.io/traefik/" rel="external nofollow noopener noreferrer" target="_blank">https://doc.traefik.io/traefik/</a></p>
</li>
<li><p><a href="https://rancher.com/docs/rancher/v2.x/en/" rel="external nofollow noopener noreferrer" target="_blank">https://rancher.com/docs/rancher/v2.x/en/</a></p>
</li>
<li><p><a href="https://github.com/kubernetes-sigs" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kubernetes-sigs</a></p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/109458069" rel="external nofollow noopener noreferrer" target="_blank">https://zhuanlan.zhihu.com/p/109458069</a></p>
</li>
<li><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.github.io/ingress-nginx/deploy/</a></p>
</li>
</ol>
<hr>
<p>End</p>
]]></content>
      <categories>
        <category>DevOps</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>Dockerä»‹ç»</title>
    <url>/deployment/docker/docker/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p><a href="https://docs.docker.com/engine/docker-overview/" rel="external nofollow noopener noreferrer" target="_blank"><strong>Docker</strong></a> ä½¿ç”¨å®¢æˆ·ç«¯ - æœåŠ¡å™¨æ¶æ„ã€‚Dockerå®¢æˆ·ç«¯ä¸Dockerå®ˆæŠ¤è¿›ç¨‹é€šä¿¡ï¼Œåè€…è´Ÿè´£æ„å»ºï¼Œè¿è¡Œå’Œåˆ†å‘Dockerå®¹å™¨ã€‚Dockerå®¢æˆ·ç«¯å’Œå®ˆæŠ¤ç¨‹åºå¯ä»¥åœ¨åŒä¸€ç³»ç»Ÿä¸Šè¿è¡Œï¼Œä¹Ÿå¯ä»¥å°†Dockerå®¢æˆ·ç«¯è¿æ¥åˆ°è¿œç¨‹Dockerå®ˆæŠ¤ç¨‹åºã€‚Dockerå®¢æˆ·ç«¯å’Œå®ˆæŠ¤ç¨‹åºä½¿ç”¨REST APIï¼Œé€šè¿‡UNIXå¥—æ¥å­—æˆ–ç½‘ç»œæ¥å£è¿›è¡Œé€šä¿¡ã€‚</p>
</blockquote>
<a id="more"></a>
<p><img src="https://docs.docker.com/engine/images/architecture.svg" alt="Docker Architecture Diagram"></p>
<p><strong>Docker vs VM</strong></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/docker.assets/1561264718294.png" alt="1561264718294"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/docker.assets/1561264737939.png" alt="1561264737939"></p>
<p><a href="https://docs.docker.com/install/linux/docker-ce/centos/" rel="external nofollow noopener noreferrer" target="_blank">docker-ce for centos</a></p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx + Consul-template</title>
    <url>/deployment/docker/nginx-consul/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>é€šè¿‡registratorè‡ªåŠ¨å‘ç°å®¹å™¨å†…çš„æœåŠ¡ï¼Œæ³¨å†Œåˆ°consulï¼Œé€šè¿‡consul -templateåŠ¨æ€ä¿®æ”¹nginxé…ç½®æ–‡ä»¶å®ç°åŠ¨æ€è´Ÿè½½ã€‚</p>
</blockquote>
<a id="more"></a>
<p><code>docker-compose.yml</code>:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SERVICE_8500_NAME:</span> <span class="string">"consul-ui"</span></span><br><span class="line">      <span class="attr">SERVICE_8500_TAGS:</span> <span class="string">"consul,http,ui"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8500</span><span class="string">:8500</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/consul/data:/consul/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf.d:/consul/config</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">"agent -server -bootstrap-expect 1 -ui -disable-host-node-id -client 0.0.0.0 -bind 172.17.0.13"</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">registrator:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gliderlabs/registrator</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/tmp/docker.sock</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">CONSUL_HTTP_TOKEN:</span> <span class="string">$&#123;CONSUL_HTTP_TOKEN&#125;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-internal</span> <span class="string">consul://127.0.0.1:8500</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx-consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx-consul:alpine</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">registrator</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./files/nginx.conf.ctmpl:/etc/nginx/nginx.conf.ctmpl</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">HOST_TYPE:</span> <span class="string">$&#123;HOST_TYPE&#125;</span></span><br><span class="line">      <span class="attr">CONSUL_HTTP_TOKEN:</span> <span class="string">$&#123;CONSUL_HTTP_TOKEN&#125;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-consul-addr=127.0.0.1:8500</span> <span class="string">-wait=5s</span> <span class="string">-template</span> <span class="string">/etc/nginx/nginx.conf.ctmpl:/etc/nginx/conf.d/app.conf:/etc/nginx/nginx.sh</span></span><br></pre></td></tr></table></figure>
<p><code>Dockerfile</code>:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">nginx:alpine</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">apk</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">apk</span> <span class="string">add</span> <span class="string">--no-cache</span> <span class="string">unzip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENV CONSUL_TEMPLATE_VERSION 0.20.0</span></span><br><span class="line"><span class="string">ENV</span> <span class="string">PACKAGE</span> <span class="string">consul-template_0.20.0_linux_amd64.zip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ADD https://releases.hashicorp.com/consul-template/$&#123;CONSUL_TEMPLATE_VERSION&#125;/consul-template_$&#123;CONSUL_TEMPLATE_VERSION&#125;_linux_amd64.zip /tmp/consul-template.zip</span></span><br><span class="line"><span class="string">ADD</span> <span class="string">files/nginx.conf</span> <span class="string">files/nginx.conf.ctmpl</span> <span class="string">files/nginx.sh</span> <span class="string">files/$&#123;PACKAGE&#125;</span> <span class="string">/etc/nginx/</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">unzip</span> <span class="string">/etc/nginx/$&#123;PACKAGE&#125;</span> <span class="string">-d</span> <span class="string">/usr/bin</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/bin/consul-template</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">rm</span> <span class="string">-f</span> <span class="string">/etc/nginx/$&#123;PACKAGE&#125;</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">chmod</span> <span class="string">+x</span> <span class="string">/etc/nginx/nginx.sh</span> <span class="string">&amp;&amp;</span> <span class="string">\</span></span><br><span class="line">    <span class="string">apk</span> <span class="string">del</span> <span class="string">unzip</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">/etc/nginx</span></span><br><span class="line"><span class="string">ENTRYPOINT</span> <span class="string">["/usr/bin/consul-template"]</span></span><br></pre></td></tr></table></figure>
<p><code>conf.d/acl.json</code>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_13_centos nginx-consul]<span class="comment"># cat conf.d/acl.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"acl_datacenter"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">    <span class="string">"acl_master_token"</span>: <span class="string">"xxxxxxxxxxxxxxxxxxxxxxxxxxxx"</span>,</span><br><span class="line">    <span class="string">"acl_agent_token"</span>: <span class="string">"xxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxxxx"</span>,</span><br><span class="line">    <span class="string">"acl_default_policy"</span>: <span class="string">"deny"</span>,</span><br><span class="line">    <span class="string">"acl_down_policy"</span>: <span class="string">"extend-cache"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Consul</tag>
      </tags>
  </entry>
  <entry>
    <title>PMMæ•°æ®åº“æ€§èƒ½ç›‘æ§</title>
    <url>/deployment/docker/pmm/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>Percona Monitoring and Management (PMM)æ˜¯ä¸€æ¬¾å¼€æºçš„MySQLã€MongoDBæ€§èƒ½ç›‘æ§å·¥å…·ï¼ŒPMMå®¢æˆ·ç«¯è´Ÿè´£æ”¶é›†DBç›‘æ§æ•°æ®ï¼ŒPMMæœåŠ¡ç«¯ä»å·²è¿æ¥çš„å®¢æˆ·ç«¯æ‹‰å–æ•°æ®ï¼Œå¹¶é€šè¿‡ç¬¬ä¸‰æ–¹è½¯ä»¶Grafanaå±•ç¤ºå›¾è¡¨ã€‚</p>
</blockquote>
<a id="more"></a>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">pmm-data:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">percona/pmm-server:1.1.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">pmm-data</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/prometheus/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/consul-data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/lib/mysql</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/lib/grafana</span></span><br><span class="line">    <span class="attr">entrypoint:</span> <span class="string">/bin/true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">pmm-server:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">percona/pmm-server:1.1.1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">pmm-server</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8088</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVICE_80_NAME=pmm</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVICE_80_TAGS=pmm,http</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_USER=admin</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">SERVER_PASSWORD=$&#123;PMM_SERVER_PASSWORD&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">METRICS_RETENTION=720h</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">METRICS_MEMORY=4194304</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">METRICS_RESOLUTION=5s</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">QUERIES_RETENTION=30</span></span><br><span class="line">    <span class="attr">volumes_from:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">pmm-data</span></span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">tag0=<span class="variable">$1</span></span><br><span class="line">tag=<span class="variable">$&#123;tag0:=1.1.1&#125;</span></span><br><span class="line"></span><br><span class="line">docker stop pmm-server</span><br><span class="line">docker rm pmm-server pmm-data</span><br><span class="line"></span><br><span class="line">docker create \</span><br><span class="line">   -v /opt/prometheus/data \</span><br><span class="line">   -v /opt/consul-data \</span><br><span class="line">   -v /var/lib/mysql \</span><br><span class="line">   -v /var/lib/grafana \</span><br><span class="line">   --name pmm-data \</span><br><span class="line">   percona/pmm-server:<span class="variable">$tag</span> /bin/<span class="literal">true</span></span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">docker run -d \</span><br><span class="line">   -p 8088:80 \</span><br><span class="line">   --volumes-from pmm-data \</span><br><span class="line">   --name pmm-server \</span><br><span class="line">   -e SERVER_USER=admin \</span><br><span class="line">   -e SERVICE_80_NAME=pmm \</span><br><span class="line">   -e SERVICE_80_TAGS=pmm,http,ui \</span><br><span class="line">   -e SERVER_PASSWORD=<span class="variable">$&#123;PMM_SERVER_PASSWORD&#125;</span> \</span><br><span class="line">   --restart always \</span><br><span class="line">   percona/pmm-server:<span class="variable">$tag</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis in Docker</title>
    <url>/deployment/docker/redis-in-docker/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h3 id="è¿æ¥redis"><a href="#è¿æ¥redis" class="headerlink" title="è¿æ¥redis"></a>è¿æ¥redis</h3><ul>
<li>docker redis-cliè¿æ¥redis</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost redis]<span class="comment"># docker inspect redis_redis_1 |grep net</span></span><br><span class="line">            <span class="string">"NetworkMode"</span>: <span class="string">"redis_localnet"</span>,</span><br><span class="line">            <span class="string">"SandboxKey"</span>: <span class="string">"/var/run/docker/netns/a498b7651db0"</span>,</span><br><span class="line">                <span class="string">"redis_localnet"</span>: &#123;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost redis]<span class="comment"># docker run -it --network redis_localnet --rm redis redis-cli -h redis</span></span><br><span class="line">redis:6379&gt; get k</span><br><span class="line">(nil)</span><br><span class="line">redis:6379&gt; <span class="built_in">exit</span></span><br><span class="line">[root@localhost redis]<span class="comment"># docker run -it --rm redis redis-cli -h 192.168.80.2</span></span><br><span class="line">192.168.80.2:6379&gt; <span class="built_in">set</span> k abc</span><br><span class="line">OK</span><br><span class="line">192.168.80.2:6379&gt; get k</span><br><span class="line"><span class="string">"abc"</span></span><br><span class="line">192.168.80.2:6379&gt; <span class="built_in">exit</span></span><br><span class="line">[root@localhost redis]<span class="comment"># docker run -it --network redis_localnet --rm redis redis-cli -h redis</span></span><br><span class="line">redis:6379&gt; get k</span><br><span class="line"><span class="string">"abc"</span></span><br><span class="line">redis:6379&gt; del k</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">redis:6379&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>ä»å…¶å®ƒredisèŠ‚ç‚¹è®¿é—®</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># docker run -it --rm redis redis-cli -h 10.1.7.211</span></span><br><span class="line">Unable to find image <span class="string">'redis:latest'</span> locally</span><br><span class="line">latest: Pulling from library/redis</span><br><span class="line">27833a3ba0a5: Already exists </span><br><span class="line">cde8019a4b43: Pull complete </span><br><span class="line">97a473b37fb2: Pull complete </span><br><span class="line">c6fe0dfbb7e3: Pull complete </span><br><span class="line">39c8f5ba1240: Pull complete </span><br><span class="line">cfbdd870cf75: Pull complete </span><br><span class="line">Digest: sha256:000339fb57e0ddf2d48d72f3341e47a8ca3b1beae9bdcb25a96323095b72a79b</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> redis:latest</span><br><span class="line">10.1.7.211:6379&gt; get k</span><br><span class="line">(nil)</span><br><span class="line">10.1.7.211:6379&gt; <span class="built_in">set</span> k abcdefg</span><br><span class="line">OK</span><br><span class="line">10.1.7.211:6379&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure>
<h3 id="Redisé›†ç¾¤"><a href="#Redisé›†ç¾¤" class="headerlink" title="Redisé›†ç¾¤"></a>Redisé›†ç¾¤</h3><ul>
<li>åˆ›å»º</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">para=<span class="string">""</span></span><br><span class="line">port=8000 <span class="comment"># 6ä¸ªèŠ‚ç‚¹8001â€”â€”8006</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> `seq 1 6`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="comment"># host? 192.168.*</span></span><br><span class="line"><span class="comment">#  ipaddr=$(docker inspect new_redis_redis$&#123;i&#125;_1 |jq '.[0].NetworkSettings.Networks.new_redis_default.IPAddress' |sed 's/\"//g')</span></span><br><span class="line"><span class="comment"># bridge? 172.*</span></span><br><span class="line">  ipaddr=$(docker inspect new_redis_redis<span class="variable">$&#123;i&#125;</span>_1 |jq <span class="string">'.[0].NetworkSettings.Networks.bridge.IPAddress'</span> |sed <span class="string">'s/\"//g'</span>)</span><br><span class="line">  <span class="built_in">let</span> port=port+1</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$ipaddr</span>:<span class="variable">$port</span></span><br><span class="line">  para=<span class="string">"<span class="variable">$para</span> <span class="variable">$ipaddr</span>:<span class="variable">$port</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$para</span> <span class="comment"># 172.17.0.12:8001 172.17.0.8:8002 172.17.0.13:8003 172.17.0.9:8004 172.17.0.10:8005 172.17.0.11:8006</span></span><br><span class="line">docker run --rm -it inem0o/redis-trib create --replicas 1 <span class="variable">$para</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æŸ¥çœ‹</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost new_redis]<span class="comment"># docker run --rm -it inem0o/redis-trib info 172.17.0.11:8006</span></span><br><span class="line">172.17.0.8:8002@18002 (f015467b...) -&gt; 178239 keys | 5462 slots | 1 slaves.</span><br><span class="line">172.17.0.12:8001@18001 (17687354...) -&gt; 178166 keys | 5461 slots | 1 slaves.</span><br><span class="line">172.17.0.13:8003@18003 (2097e0e6...) -&gt; 178106 keys | 5461 slots | 1 slaves.</span><br><span class="line">[OK] 534511 keys <span class="keyword">in</span> 3 masters.</span><br><span class="line">32.62 keys per slot on average.</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost new_redis]<span class="comment"># docker run --rm -it redis redis-cli -h 172.17.0.12 -p 8001</span></span><br><span class="line">172.17.0.12:8001&gt; cluster nodes</span><br><span class="line">6104ad4f30a511d642aebb1bce8dd77bb5d10621 172.17.0.11:8006@18006 slave 2097e0e6a66c6adb6ddbe3bc783663d390a9360d 0 1557199119530 6 connected</span><br><span class="line">f9a309feda3b442dbf555712c7ff47026dc4700b 172.17.0.9:8004@18004 slave 1768735459c96a46722b1f0f038c125fa88aef83 0 1557199119000 4 connected</span><br><span class="line">f015467b0439b9694a6d633cc62a2502079e74f7 172.17.0.8:8002@18002 master - 0 1557199120532 2 connected 5461-10922</span><br><span class="line">1768735459c96a46722b1f0f038c125fa88aef83 172.17.0.12:8001@18001 myself,master - 0 1557199118000 1 connected 0-5460</span><br><span class="line">2097e0e6a66c6adb6ddbe3bc783663d390a9360d 172.17.0.13:8003@18003 master - 0 1557199120030 3 connected 10923-16383</span><br><span class="line">8126fa4d990c4e08cdb7d3e2ebf59771445b3a1a 172.17.0.10:8005@18005 slave f015467b0439b9694a6d633cc62a2502079e74f7 0 1557199119530 5 connected</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Rediså•èŠ‚ç‚¹å•å®ä¾‹"><a href="#Rediså•èŠ‚ç‚¹å•å®ä¾‹" class="headerlink" title="Rediså•èŠ‚ç‚¹å•å®ä¾‹"></a>Rediså•èŠ‚ç‚¹å•å®ä¾‹</h3><p>docker-compose.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">    <span class="attr">redis:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">"6379:6379"</span></span><br><span class="line">        <span class="attr">volumes:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./data:/data</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">./conf/redis.conf:/etc/redis.conf</span></span><br><span class="line">        <span class="attr">networks:</span></span><br><span class="line">            <span class="attr">localnet:</span></span><br><span class="line">                <span class="attr">aliases:</span></span><br><span class="line">                    <span class="bullet">-</span> <span class="string">my-redis-server</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">["redis-server",</span> <span class="string">"/etc/redis.conf"</span><span class="string">]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">    <span class="attr">localnet:</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="å•èŠ‚ç‚¹redisé›†ç¾¤"><a href="#å•èŠ‚ç‚¹redisé›†ç¾¤" class="headerlink" title="å•èŠ‚ç‚¹redisé›†ç¾¤"></a>å•èŠ‚ç‚¹redisé›†ç¾¤</h3><p>docker-compose.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> <span class="attr">redis1:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/data/redis/6381/data:/data</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">REDIS_PORT=6381</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'6381:6381'</span>       <span class="comment">#æœåŠ¡ç«¯å£</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'16381:16381'</span>   <span class="comment">#é›†ç¾¤ç«¯å£</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">redis2:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/data/redis/6382/data:/data</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">REDIS_PORT=6382</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'6382:6382'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'16382:16382'</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">redis3:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/data/redis/6383/data:/data</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">REDIS_PORT=6383</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'6383:6383'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'16383:16383'</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">redis4:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/data/redis/6384/data:/data</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">REDIS_PORT=6384</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'6384:6384'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'16384:16384'</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">redis5:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/data/redis/6385/data:/data</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">REDIS_PORT=6385</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'6385:6385'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'16385:16385'</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">redis6:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">redis-cluster</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">/data/redis/6386/data:/data</span></span><br><span class="line">  <span class="attr">environment:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">REDIS_PORT=6386</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'6386:6386'</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'16386:16386'</span></span><br></pre></td></tr></table></figure>
<p>redis.conf:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment">#ç«¯å£</span></span><br><span class="line">port REDIS_PORT</span><br><span class="line"><span class="comment">#å¼€å¯é›†ç¾¤</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line"><span class="comment">#é…ç½®æ–‡ä»¶</span></span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line"><span class="comment">#æ›´æ–°æ“ä½œåè¿›è¡Œæ—¥å¿—è®°å½•</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="comment">#è®¾ç½®ä¸»æœåŠ¡çš„è¿æ¥å¯†ç </span></span><br><span class="line"><span class="comment"># masterauth</span></span><br><span class="line"><span class="comment">#è®¾ç½®ä»æœåŠ¡çš„è¿æ¥å¯†ç </span></span><br><span class="line"><span class="comment"># requirepass</span></span><br></pre></td></tr></table></figure>
<p>entrypoint.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment">#åªä½œç”¨äºå½“å‰è¿›ç¨‹,ä¸ä½œç”¨äºå…¶åˆ›å»ºçš„å­è¿›ç¨‹</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"><span class="comment">#$0--Shellæœ¬èº«çš„æ–‡ä»¶å $1--ç¬¬ä¸€ä¸ªå‚æ•° $@--æ‰€æœ‰å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment"># allow the container to be started with `--user`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">'redis-server'</span> -a <span class="string">"<span class="variable">$(id -u)</span>"</span> = <span class="string">'0'</span> ]; <span class="keyword">then</span></span><br><span class="line">    sed -i <span class="string">'s/REDIS_PORT/'</span><span class="variable">$REDIS_PORT</span><span class="string">'/g'</span> /usr/<span class="built_in">local</span>/etc/redis.conf</span><br><span class="line">    chown -R redis .  <span class="comment">#æ”¹å˜å½“å‰æ–‡ä»¶æ‰€æœ‰è€…</span></span><br><span class="line">    <span class="built_in">exec</span> gosu redis <span class="string">"<span class="variable">$0</span>"</span> <span class="string">"<span class="variable">$@</span>"</span>  <span class="comment">#gosuæ˜¯sudoè½»é‡çº§â€æ›¿ä»£å“â€</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>
<p>Dockerfile:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">redis</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">ln</span> <span class="string">-sf</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span> <span class="string">/etc/localtime</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">echo</span> <span class="string">'Asia/Shanghai'</span> <span class="string">&gt;/etc/timezone</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ENV REDIS_PORT 8000</span></span><br><span class="line"><span class="comment"># ENV REDIS_PORT_NODE 18000</span></span><br><span class="line"><span class="string">EXPOSE</span> <span class="string">$REDIS_PORT</span></span><br><span class="line"><span class="comment"># EXPOSE $REDIS_PORT_NODE</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">entrypoint.sh</span> <span class="string">/usr/local/bin/</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">redis.conf</span> <span class="string">/usr/local/etc/</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="number">777</span> <span class="string">/usr/local/etc/redis.conf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/bin/entrypoint.sh</span></span><br><span class="line"></span><br><span class="line"><span class="string">ENTRYPOINT</span> <span class="string">["/usr/local/bin/entrypoint.sh"]</span></span><br><span class="line"><span class="string">CMD</span> <span class="string">["redis-server",</span> <span class="string">"/usr/local/etc/redis.conf"</span><span class="string">]</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>GitLabç‰ˆæœ¬å‡çº§</title>
    <url>/deployment/else/gitlab-update/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>GitLabç‰ˆæœ¬å‡çº§åˆ°11.9.1</p>
</blockquote>
<ul>
<li>å…ˆå¤‡ä»½gitlab</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:create</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆçš„å¤‡ä»½æ–‡ä»¶åœ¨ï¼š/var/opt/gitlab/backups/ä¸‹ï¼Œæ ¼å¼å¦‚ï¼š1537856454_gitlab_backup.tar</p>
<a id="more"></a>
<ul>
<li>å¦‚æœè¦æ¢å¤æ—¶é—´æˆ³ä¸º1537856454çš„å¤‡ä»½</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">gitlab-rake gitlab:backup:restore BACKUP=1537856454</span><br></pre></td></tr></table></figure>
<ul>
<li>å‡çº§åˆ°11.9.1ï¼ˆå½“å‰11.0.4ï¼‰</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/gitlab-ce-11.9.1-ce.0.el7.x86_64.rpm</span><br><span class="line">rpm -Uvh gitlab-ce-11.9.1-ce.0.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>Gitlab</tag>
      </tags>
  </entry>
  <entry>
    <title>yumå®‰è£…MySQL-5.7</title>
    <url>/deployment/else/ins_mysql/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ç³»ç»Ÿï¼šCentOS 7.6</p>
</blockquote>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å…ˆä»å®˜ç½‘ä¸‹è½½rpmåŒ…</span></span><br><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…yumä¾èµ–æº</span></span><br><span class="line"><span class="comment"># rpm -Uvh https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span></span><br><span class="line">wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">rpm -Uvh mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹yumæº</span></span><br><span class="line">sed -i <span class="string">'s/enabled=1/enabled=0/g'</span> /etc/yum.repos.d/mysql-community.repo</span><br><span class="line">sed -i <span class="string">'/\[mysql57-community\]/,+3s/enabled=.*/enabled=1/'</span> /etc/yum.repos.d/mysql-community.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># å½“å‰rpmåŒ…æ‰€åœ¨è·¯å¾„ï¼Œå®‰è£…</span></span><br><span class="line">yum install mysql-community-server-5.7.26-1.el7.x86_64.rpm -y</span><br></pre></td></tr></table></figure>
<p>å®Œæ•´æ—¥å¿—ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">+ wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br><span class="line">--2019-08-13 16:48:01--  https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br><span class="line">Resolving dev.mysql.com (dev.mysql.com)... 137.254.60.11</span><br><span class="line">Connecting to dev.mysql.com (dev.mysql.com)|137.254.60.11|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-community-server-5.7.26-1.el7.x86_64.rpm [following]</span><br><span class="line">--2019-08-13 16:48:06--  https://cdn.mysql.com//Downloads/MySQL-5.7/mysql-community-server-5.7.26-1.el7.x86_64.rpm</span><br><span class="line">Resolving cdn.mysql.com (cdn.mysql.com)... 23.44.160.128</span><br><span class="line">Connecting to cdn.mysql.com (cdn.mysql.com)|23.44.160.128|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 173541272 (166M) [application/x-redhat-package-manager]</span><br><span class="line">Saving to: â€˜mysql-community-server-5.7.26-1.el7.x86_64.rpmâ€™</span><br><span class="line"></span><br><span class="line">100%[===========================================================================================&gt;] 173,541,272 1.71MB/s   <span class="keyword">in</span> 1m 44s </span><br><span class="line"></span><br><span class="line">2019-08-13 16:49:51 (1.59 MB/s) - â€˜mysql-community-server-5.7.26-1.el7.x86_64.rpmâ€™ saved [173541272/173541272]</span><br><span class="line"></span><br><span class="line">+ wget https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">--2019-08-13 16:49:51--  https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">Resolving dev.mysql.com (dev.mysql.com)... 137.254.60.11</span><br><span class="line">Connecting to dev.mysql.com (dev.mysql.com)|137.254.60.11|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 302 Found</span><br><span class="line">Location: https://repo.mysql.com//mysql80-community-release-el7-3.noarch.rpm [following]</span><br><span class="line">--2019-08-13 16:49:53--  https://repo.mysql.com//mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">Resolving repo.mysql.com (repo.mysql.com)... 104.89.31.15</span><br><span class="line">Connecting to repo.mysql.com (repo.mysql.com)|104.89.31.15|:443... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 26024 (25K) [application/x-redhat-package-manager]</span><br><span class="line">Saving to: â€˜mysql80-community-release-el7-3.noarch.rpmâ€™</span><br><span class="line"></span><br><span class="line">100%[===========================================================================================&gt;] 26,024      49.0KB/s   <span class="keyword">in</span> 0.5s   </span><br><span class="line"></span><br><span class="line">2019-08-13 16:49:55 (49.0 KB/s) - â€˜mysql80-community-release-el7-3.noarch.rpmâ€™ saved [26024/26024]</span><br><span class="line"></span><br><span class="line">+ rpm -Uvh mysql80-community-release-el7-3.noarch.rpm</span><br><span class="line">warning: mysql80-community-release-el7-3.noarch.rpm: Header V3 DSA/SHA1 Signature, key ID 5072e1f5: NOKEY</span><br><span class="line">Preparing...                          <span class="comment">################################# [100%]</span></span><br><span class="line">Updating / installing...</span><br><span class="line">   1:mysql80-community-release-el7-3  <span class="comment">################################# [100%]</span></span><br><span class="line">+ sed -i s/enabled=1/enabled=0/g /etc/yum.repos.d/mysql-community.repo</span><br><span class="line">+ sed -i <span class="string">'/\[mysql57-community\]/,+3s/enabled=.*/enabled=1/'</span> /etc/yum.repos.d/mysql-community.repo</span><br><span class="line">+ yum install mysql-community-server-5.7.26-1.el7.x86_64.rpm -y</span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Examining mysql-community-server-5.7.26-1.el7.x86_64.rpm: mysql-community-server-5.7.26-1.el7.x86_64</span><br><span class="line">Marking mysql-community-server-5.7.26-1.el7.x86_64.rpm to be installed</span><br><span class="line">Resolving Dependencies</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package mysql-community-server.x86_64 0:5.7.26-1.el7 will be installed</span><br><span class="line">--&gt; Processing Dependency: mysql-community-common(x86-64) = 5.7.26-1.el7 <span class="keyword">for</span> package: mysql-community-server-5.7.26-1.el7.x86_64</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">mysql57-community                                                                                             | 2.5 kB  00:00:00     </span><br><span class="line">mysql57-community/x86_64/primary_db                                                                           | 184 kB  00:00:02     </span><br><span class="line">--&gt; Processing Dependency: mysql-community-client(x86-64) &gt;= 5.7.9 <span class="keyword">for</span> package: mysql-community-server-5.7.26-1.el7.x86_64</span><br><span class="line">--&gt; Processing Dependency: libnuma.so.1(libnuma_1.1)(64bit) <span class="keyword">for</span> package: mysql-community-server-5.7.26-1.el7.x86_64</span><br><span class="line">--&gt; Processing Dependency: libnuma.so.1(libnuma_1.2)(64bit) <span class="keyword">for</span> package: mysql-community-server-5.7.26-1.el7.x86_64</span><br><span class="line">--&gt; Processing Dependency: libnuma.so.1()(64bit) <span class="keyword">for</span> package: mysql-community-server-5.7.26-1.el7.x86_64</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package mysql-community-client.x86_64 0:5.7.27-1.el7 will be installed</span><br><span class="line">--&gt; Processing Dependency: mysql-community-libs(x86-64) &gt;= 5.7.9 <span class="keyword">for</span> package: mysql-community-client-5.7.27-1.el7.x86_64</span><br><span class="line">---&gt; Package mysql-community-common.x86_64 0:5.7.26-1.el7 will be installed</span><br><span class="line">---&gt; Package numactl-libs.x86_64 0:2.0.9-7.el7 will be installed</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package mariadb-libs.x86_64 1:5.5.60-1.el7_5 will be obsoleted</span><br><span class="line">--&gt; Processing Dependency: libmysqlclient.so.18()(64bit) <span class="keyword">for</span> package: 2:postfix-2.10.1-7.el7.x86_64</span><br><span class="line">--&gt; Processing Dependency: libmysqlclient.so.18(libmysqlclient_18)(64bit) <span class="keyword">for</span> package: 2:postfix-2.10.1-7.el7.x86_64</span><br><span class="line">---&gt; Package mysql-community-libs.x86_64 0:5.7.27-1.el7 will be obsoleting</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package mysql-community-libs-compat.x86_64 0:5.7.27-1.el7 will be obsoleting</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">=====================================================================================================================================</span><br><span class="line"> Package                             Arch           Version                Repository                                           Size</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"> mysql-community-libs                x86_64         5.7.27-1.el7           mysql57-community                                   2.2 M</span><br><span class="line">     replacing  mariadb-libs.x86_64 1:5.5.60-1.el7_5</span><br><span class="line"> mysql-community-libs-compat         x86_64         5.7.27-1.el7           mysql57-community                                   2.0 M</span><br><span class="line">     replacing  mariadb-libs.x86_64 1:5.5.60-1.el7_5</span><br><span class="line"> mysql-community-server              x86_64         5.7.26-1.el7           /mysql-community-server-5.7.26-1.el7.x86_64         746 M</span><br><span class="line">Installing <span class="keyword">for</span> dependencies:</span><br><span class="line"> mysql-community-client              x86_64         5.7.27-1.el7           mysql57-community                                    24 M</span><br><span class="line"> mysql-community-common              x86_64         5.7.26-1.el7           mysql57-community                                   274 k</span><br><span class="line"> numactl-libs                        x86_64         2.0.9-7.el7            os                                                   29 k</span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">=====================================================================================================================================</span><br><span class="line">Install  3 Packages (+3 Dependent packages)</span><br><span class="line"></span><br><span class="line">Total size: 774 M</span><br><span class="line">Total download size: 29 M</span><br><span class="line">Downloading packages:</span><br><span class="line">warning: /var/cache/yum/x86_64/7/mysql57-community/packages/mysql-community-common-5.7.26-1.el7.x86_64.rpm: Header V3 DSA/SHA1 Signature, key ID 5072e1f5: NOKEY</span><br><span class="line">Public key <span class="keyword">for</span> mysql-community-common-5.7.26-1.el7.x86_64.rpm is not installed</span><br><span class="line">(1/5): mysql-community-common-5.7.26-1.el7.x86_64.rpm                                                         | 274 kB  00:00:03     </span><br><span class="line">(2/5): mysql-community-client-5.7.27-1.el7.x86_64.rpm                                                         |  24 MB  00:00:04     </span><br><span class="line">(3/5): numactl-libs-2.0.9-7.el7.x86_64.rpm                                                                    |  29 kB  00:00:00     </span><br><span class="line">(4/5): mysql-community-libs-compat-5.7.27-1.el7.x86_64.rpm                                                    | 2.0 MB  00:00:00     </span><br><span class="line">(5/5): mysql-community-libs-5.7.27-1.el7.x86_64.rpm                                                           | 2.2 MB  00:00:04     </span><br><span class="line">-------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">Total                                                                                                3.6 MB/s |  29 MB  00:00:08     </span><br><span class="line">Retrieving key from file:///etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</span><br><span class="line">Importing GPG key 0x5072E1F5:</span><br><span class="line"> Userid     : <span class="string">"MySQL Release Engineering &lt;mysql-build@oss.oracle.com&gt;"</span></span><br><span class="line"> Fingerprint: a4a9 4068 76fc bd3c 4567 70c8 8c71 8d3b 5072 e1f5</span><br><span class="line"> Package    : mysql80-community-release-el7-3.noarch (installed)</span><br><span class="line"> From       : /etc/pki/rpm-gpg/RPM-GPG-KEY-mysql</span><br><span class="line">Running transaction check</span><br><span class="line">Running transaction <span class="built_in">test</span></span><br><span class="line">Transaction <span class="built_in">test</span> succeeded</span><br><span class="line">Running transaction</span><br><span class="line">Warning: RPMDB altered outside of yum.</span><br><span class="line">  Installing : mysql-community-common-5.7.26-1.el7.x86_64                                                                        1/7 </span><br><span class="line">  Installing : mysql-community-libs-5.7.27-1.el7.x86_64                                                                          2/7 </span><br><span class="line">  Installing : mysql-community-client-5.7.27-1.el7.x86_64                                                                        3/7 </span><br><span class="line">  Installing : numactl-libs-2.0.9-7.el7.x86_64                                                                                   4/7 </span><br><span class="line">  Installing : mysql-community-server-5.7.26-1.el7.x86_64                                                                        5/7 </span><br><span class="line">  Installing : mysql-community-libs-compat-5.7.27-1.el7.x86_64                                                                   6/7 </span><br><span class="line">  Erasing    : 1:mariadb-libs-5.5.60-1.el7_5.x86_64                                                                              7/7 </span><br><span class="line">  Verifying  : mysql-community-server-5.7.26-1.el7.x86_64                                                                        1/7 </span><br><span class="line">  Verifying  : numactl-libs-2.0.9-7.el7.x86_64                                                                                   2/7 </span><br><span class="line">  Verifying  : mysql-community-libs-compat-5.7.27-1.el7.x86_64                                                                   3/7 </span><br><span class="line">  Verifying  : mysql-community-client-5.7.27-1.el7.x86_64                                                                        4/7 </span><br><span class="line">  Verifying  : mysql-community-common-5.7.26-1.el7.x86_64                                                                        5/7 </span><br><span class="line">  Verifying  : mysql-community-libs-5.7.27-1.el7.x86_64                                                                          6/7 </span><br><span class="line">  Verifying  : 1:mariadb-libs-5.5.60-1.el7_5.x86_64</span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line">  mysql-community-libs.x86_64 0:5.7.27-1.el7                     mysql-community-libs-compat.x86_64 0:5.7.27-1.el7                  </span><br><span class="line">  mysql-community-server.x86_64 0:5.7.26-1.el7                  </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  mysql-community-client.x86_64 0:5.7.27-1.el7   mysql-community-common.x86_64 0:5.7.26-1.el7   numactl-libs.x86_64 0:2.0.9-7.el7  </span><br><span class="line"></span><br><span class="line">Replaced:</span><br><span class="line">  mariadb-libs.x86_64 1:5.5.60-1.el7_5                                                                                               </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>yumå®‰è£…rabbitmq</title>
    <url>/deployment/else/ins_rabbitmq/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ç³»ç»Ÿï¼šCentOS 7.6</p>
</blockquote>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://github.com/rabbitmq/erlang-rpm/releases/download/v22.0.1/erlang-22.0.1-1.el7.x86_64.rpm</span><br><span class="line"></span><br><span class="line">wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.15/rabbitmq-server-3.7.15-1.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum install erlang-22.0.1-1.el7.x86_64.rpm rabbitmq-server-3.7.15-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>yumå®‰è£…redis</title>
    <url>/deployment/else/ins_redis5/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p> ç³»ç»Ÿï¼šCentOS 7.6</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rpm -Uvh http://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</span><br><span class="line">rpm -Uvh https://centos7.iuscommunity.org/ius-release.rpm</span><br><span class="line">yum install redis5-5.0.5 -y</span><br></pre></td></tr></table></figure>
<a id="more"></a>]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>yumå®‰è£…ruby-2.6å’Œredis-dump</title>
    <url>/deployment/else/ins_ruby_redis_dump/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>ç³»ç»Ÿï¼šCentOS 7.6</p>
</blockquote>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. å®‰è£…ruby-install</span></span><br><span class="line">wget https://github.com/postmodern/ruby-install/archive/v0.7.0.tar.gz</span><br><span class="line">tar -xf v0.7.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> ruby-install-0.7.0/</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…ruby</span></span><br><span class="line">ruby-install ruby</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…redis-dump</span></span><br><span class="line">gem install redis-dump</span><br><span class="line"></span><br><span class="line"><span class="comment"># ln -s /opt/rubies/ruby-2.6.3/bin/* /usr/bin/</span></span><br><span class="line"><span class="built_in">export</span> PATH=/opt/rubies/ruby-2.6.3/bin:<span class="variable">$PATH</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Y-APIçš„å®‰è£…æ­¥éª¤</title>
    <url>/deployment/else/ins_yapi/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h2 id="å®‰è£…-NodeJS"><a href="#å®‰è£…-NodeJS" class="headerlink" title="å®‰è£… NodeJS"></a>å®‰è£… NodeJS</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… nodeJs</span></span><br><span class="line">wget https://nodejs.org/dist/v12.14.1/node-v12.14.1-linux-x64.tar.xz</span><br><span class="line">tar -xf node-v12.14.1-linux-x64.tar.xz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">chown -R root:root /usr/<span class="built_in">local</span>/node-v12.14.1-linux-x64</span><br><span class="line"></span><br><span class="line"><span class="comment"># è®¾ç½®ç¯å¢ƒå˜é‡ /etc/profile</span></span><br><span class="line"><span class="built_in">export</span> PATH=/usr/<span class="built_in">local</span>/node-v12.14.1-linux-x64/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æŸ¥nodeç‰ˆæœ¬</span></span><br><span class="line">node --version</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="å®‰è£…-MongoDB"><a href="#å®‰è£…-MongoDB" class="headerlink" title="å®‰è£… MongoDB"></a>å®‰è£… MongoDB</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… mongodb</span></span><br><span class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/mongo.repo</span><br><span class="line">[mongodb-org-4.0]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/<span class="variable">$releasever</span>/mongodb-org/4.0/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span><br><span class="line">EOF</span><br><span class="line">yum install -y mongodb-org</span><br></pre></td></tr></table></figure>
<p>é…ç½® <code>/etc/mongod.conf</code>ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">systemLog:</span></span><br><span class="line">  <span class="attr">destination:</span> <span class="string">file</span></span><br><span class="line">  <span class="attr">logAppend:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">path:</span> <span class="string">/var/log/mongodb/mongod.log</span></span><br><span class="line"><span class="attr">storage:</span></span><br><span class="line">  <span class="attr">dbPath:</span> <span class="string">/var/lib/mongo</span></span><br><span class="line">  <span class="attr">journal:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">processManagement:</span></span><br><span class="line">  <span class="attr">fork:</span> <span class="literal">true</span>  <span class="comment"># fork and run in background</span></span><br><span class="line">  <span class="attr">pidFilePath:</span> <span class="string">/var/run/mongodb/mongod.pid</span>  <span class="comment"># location of pidfile</span></span><br><span class="line">  <span class="attr">timeZoneInfo:</span> <span class="string">/usr/share/zoneinfo</span></span><br><span class="line"><span class="attr">net:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">  <span class="attr">bindIp:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  <span class="comment"># Enter 0.0.0.0,:: to bind to all IPv4 and IPv6 addresses or, alternatively, use the net.bindIpAll setting.</span></span><br></pre></td></tr></table></figure>
<p>å¯åŠ¨ mongod</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> mongod		<span class="comment"># å¼€æœºè‡ªå¯åŠ¨</span></span><br><span class="line">systemctl start mongod</span><br></pre></td></tr></table></figure>
<h2 id="å®‰è£…-yapi-cli"><a href="#å®‰è£…-yapi-cli" class="headerlink" title="å®‰è£… yapi-cli"></a>å®‰è£… yapi-cli</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… yapi-cli</span></span><br><span class="line">npm --registry https://registry.npm.taobao.org install express</span><br><span class="line"></span><br><span class="line"><span class="comment"># å‰å°æµ‹è¯•å¯åŠ¨yapi</span></span><br><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/node-v12.14.1-linux-x64/my-yapi/</span><br><span class="line">node vendors/server/app.js</span><br></pre></td></tr></table></figure>
<h2 id="é…ç½®-supervisor"><a href="#é…ç½®-supervisor" class="headerlink" title="é…ç½® supervisor"></a>é…ç½® supervisor</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å¦‚æœæ— easy_installå‘½ä»¤</span></span><br><span class="line"><span class="comment">#wget https://files.pythonhosted.org/packages/1d/64/a18a487b4391a05b9c7f938b94a16d80305bf0369c6b0b9509e86165e1d3/setuptools-41.0.1.zip</span></span><br><span class="line"><span class="comment">#unzip setuptools-41.0.1.zip</span></span><br><span class="line"><span class="comment">#cd setuptools-41.0.1/</span></span><br><span class="line"><span class="comment">#python setup.py install</span></span><br><span class="line"><span class="comment">#cd ..</span></span><br><span class="line"><span class="comment">#rm -rf setuptools-41.0.1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœæ— pipå‘½ä»¤</span></span><br><span class="line"><span class="comment">#easy_install pip</span></span><br><span class="line"><span class="comment">#pip install -U pip</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># pipå®‰è£…</span></span><br><span class="line">pip install supervisor</span><br><span class="line">echo_supervisord_conf &gt; /etc/supervisord.conf</span><br></pre></td></tr></table></figure>
<p>é…ç½® <code>/etc/supervisord.d/yapi.ini</code>ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[program:yapi]</span></span><br><span class="line"><span class="attr">command</span>=/usr/local/node-v10.<span class="number">15.3</span>-linux-x64/bin/node vendors/server/app.js</span><br><span class="line"><span class="attr">directory</span>=/usr/local/node-v10.<span class="number">15.3</span>-linux-x64/my-yapi</span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">50</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/yapi.log</span><br></pre></td></tr></table></figure>
<p>supervisorå¯åŠ¨yapi</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span> supervisord.service		<span class="comment"># supervisord å¼€æœºè‡ªå¯</span></span><br><span class="line">supervisord -c /etc/supervisord.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯yapi</span></span><br><span class="line">supervisorctl restart yapi</span><br></pre></td></tr></table></figure>
<h2 id="é…ç½®-NginX"><a href="#é…ç½®-NginX" class="headerlink" title="é…ç½® NginX"></a>é…ç½® NginX</h2><figure class="highlight"><table><tr><td class="code"><pre><span class="line">upstream yapi443 &#123;</span><br><span class="line">        <span class="comment">#ip_hash;</span></span><br><span class="line">        server 127.0.0.1:3000;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">        listen 443 ssl;</span><br><span class="line">        server_name yapi.keep.com;</span><br><span class="line">        root html;</span><br><span class="line">        index index.html index.htm;</span><br><span class="line">        ssl_certificate /etc/letsencrypt/live/keep.com/fullchain.pem;</span><br><span class="line">        ssl_certificate_key /etc/letsencrypt/live/keep.com/privkey.pem;</span><br><span class="line">        access_log /var/log/nginx/yapi.keep.com.443.access.log main;</span><br><span class="line">        error_log /var/log/nginx/yapi.keep.com.443.error.log ;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">                proxy_pass          http://yapi443;</span><br><span class="line">                proxy_redirect      off;</span><br><span class="line">                proxy_set_header    Host            $host;</span><br><span class="line">                proxy_set_header    X-Real-IP       $remote_addr;</span><br><span class="line">                proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">                proxy_redirect      http://$host http://$host:$server_port;</span><br><span class="line">                add_header          Strict-Transport-Security "max-age=31536000";</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page  500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">                root /usr/share/nginx/html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>else</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQLä¸»ä»é…ç½®</title>
    <url>/deployment/else/mysql-replication/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="mysqlé…ç½®"><a href="#mysqlé…ç½®" class="headerlink" title="mysqlé…ç½®"></a>mysqlé…ç½®</h2><p>masterç«¯my.cnfé…ç½®ç¤ºä¾‹ï¼š</p>
<a id="more"></a>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">'SET collation_connection = utf8_unicode_ci'</span></span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">'SET NAMES utf8'</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8</span><br><span class="line"><span class="attr">collation-server</span>=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line"><span class="comment">## è®¾ç½®server_idï¼Œä¸€èˆ¬è®¾ç½®ä¸ºIPï¼ŒåŒä¸€å±€åŸŸç½‘å†…æ³¨æ„è¦å”¯ä¸€</span></span><br><span class="line"><span class="attr">server_id</span>=<span class="number">100</span>  </span><br><span class="line"><span class="comment">## å¤åˆ¶è¿‡æ»¤ï¼šä¹Ÿå°±æ˜¯æŒ‡å®šå“ªä¸ªæ•°æ®åº“ä¸ç”¨åŒæ­¥ï¼ˆmysqlåº“ä¸€èˆ¬ä¸åŒæ­¥ï¼‰</span></span><br><span class="line"><span class="attr">binlog-ignore-db</span>=mysql  </span><br><span class="line"><span class="comment">## å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½ï¼Œå¯ä»¥éšä¾¿å–ï¼Œæœ€å¥½æœ‰å«ä¹‰ï¼ˆå…³é”®å°±æ˜¯è¿™é‡Œäº†ï¼‰</span></span><br><span class="line"><span class="attr">log-bin</span>=edu-mysql-bin  </span><br><span class="line"><span class="comment">## ä¸ºæ¯ä¸ªsession åˆ†é…çš„å†…å­˜ï¼Œåœ¨äº‹åŠ¡è¿‡ç¨‹ä¸­ç”¨æ¥å­˜å‚¨äºŒè¿›åˆ¶æ—¥å¿—çš„ç¼“å­˜</span></span><br><span class="line"><span class="attr">binlog_cache_size</span>=<span class="number">1</span>M  </span><br><span class="line"><span class="comment">## ä¸»ä»å¤åˆ¶çš„æ ¼å¼ï¼ˆmixed,statement,rowï¼Œé»˜è®¤æ ¼å¼æ˜¯statementï¼‰</span></span><br><span class="line"><span class="attr">binlog_format</span>=mixed  </span><br><span class="line"><span class="comment">## äºŒè¿›åˆ¶æ—¥å¿—è‡ªåŠ¨åˆ é™¤/è¿‡æœŸçš„å¤©æ•°ã€‚é»˜è®¤å€¼ä¸º0ï¼Œè¡¨ç¤ºä¸è‡ªåŠ¨åˆ é™¤ã€‚</span></span><br><span class="line"><span class="attr">expire_logs_days</span>=<span class="number">7</span>  </span><br><span class="line"><span class="comment">## è·³è¿‡ä¸»ä»å¤åˆ¶ä¸­é‡åˆ°çš„æ‰€æœ‰é”™è¯¯æˆ–æŒ‡å®šç±»å‹çš„é”™è¯¯ï¼Œé¿å…slaveç«¯å¤åˆ¶ä¸­æ–­ã€‚</span></span><br><span class="line"><span class="comment">## å¦‚ï¼š1062é”™è¯¯æ˜¯æŒ‡ä¸€äº›ä¸»é”®é‡å¤ï¼Œ1032é”™è¯¯æ˜¯å› ä¸ºä¸»ä»æ•°æ®åº“æ•°æ®ä¸ä¸€è‡´</span></span><br><span class="line"><span class="attr">slave_skip_errors</span>=<span class="number">1062</span></span><br></pre></td></tr></table></figure>
<p>slaveç«¯my.cnfé…ç½®ç¤ºä¾‹ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[client]</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysql]</span></span><br><span class="line"><span class="attr">default-character-set</span>=utf8</span><br><span class="line"></span><br><span class="line"><span class="section">[mysqld]</span></span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">'SET collation_connection = utf8_unicode_ci'</span></span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">'SET NAMES utf8'</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8</span><br><span class="line"><span class="attr">collation-server</span>=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br><span class="line"></span><br><span class="line"><span class="comment">## è®¾ç½®server_idï¼Œä¸€èˆ¬è®¾ç½®ä¸ºIP,æ³¨æ„è¦å”¯ä¸€</span></span><br><span class="line"><span class="attr">server_id</span>=<span class="number">101</span></span><br><span class="line"><span class="comment">## å¤åˆ¶è¿‡æ»¤ï¼šä¹Ÿå°±æ˜¯æŒ‡å®šå“ªä¸ªæ•°æ®åº“ä¸ç”¨åŒæ­¥ï¼ˆmysqlåº“ä¸€èˆ¬ä¸åŒæ­¥ï¼‰</span></span><br><span class="line"><span class="attr">binlog-ignore-db</span>=mysql</span><br><span class="line"><span class="comment">## å¼€å¯äºŒè¿›åˆ¶æ—¥å¿—åŠŸèƒ½ï¼Œä»¥å¤‡Slaveä½œä¸ºå…¶å®ƒSlaveçš„Masteræ—¶ä½¿ç”¨</span></span><br><span class="line"><span class="attr">log-bin</span>=edu-mysql-slave1-bin</span><br><span class="line"><span class="comment">## ä¸ºæ¯ä¸ªsession åˆ†é…çš„å†…å­˜ï¼Œåœ¨äº‹åŠ¡è¿‡ç¨‹ä¸­ç”¨æ¥å­˜å‚¨äºŒè¿›åˆ¶æ—¥å¿—çš„ç¼“å­˜</span></span><br><span class="line"><span class="attr">binlog_cache_size</span>=<span class="number">1</span>M</span><br><span class="line"><span class="comment">## ä¸»ä»å¤åˆ¶çš„æ ¼å¼ï¼ˆmixed,statement,rowï¼Œé»˜è®¤æ ¼å¼æ˜¯statementï¼‰</span></span><br><span class="line"><span class="attr">binlog_format</span>=mixed</span><br><span class="line"><span class="comment">## äºŒè¿›åˆ¶æ—¥å¿—è‡ªåŠ¨åˆ é™¤/è¿‡æœŸçš„å¤©æ•°ã€‚é»˜è®¤å€¼ä¸º0ï¼Œè¡¨ç¤ºä¸è‡ªåŠ¨åˆ é™¤ã€‚</span></span><br><span class="line"><span class="attr">expire_logs_days</span>=<span class="number">7</span></span><br><span class="line"><span class="comment">## è·³è¿‡ä¸»ä»å¤åˆ¶ä¸­é‡åˆ°çš„æ‰€æœ‰é”™è¯¯æˆ–æŒ‡å®šç±»å‹çš„é”™è¯¯ï¼Œé¿å…slaveç«¯å¤åˆ¶ä¸­æ–­ã€‚</span></span><br><span class="line"><span class="comment">## å¦‚ï¼š1062é”™è¯¯æ˜¯æŒ‡ä¸€äº›ä¸»é”®é‡å¤ï¼Œ1032é”™è¯¯æ˜¯å› ä¸ºä¸»ä»æ•°æ®åº“æ•°æ®ä¸ä¸€è‡´</span></span><br><span class="line"><span class="attr">slave_skip_errors</span>=<span class="number">1062</span></span><br><span class="line"><span class="comment">## relay_logé…ç½®ä¸­ç»§æ—¥å¿—</span></span><br><span class="line"><span class="attr">relay_log</span>=edu-mysql-relay-bin</span><br><span class="line"><span class="comment">## log_slave_updatesè¡¨ç¤ºslaveå°†å¤åˆ¶äº‹ä»¶å†™è¿›è‡ªå·±çš„äºŒè¿›åˆ¶æ—¥å¿—</span></span><br><span class="line"><span class="attr">log_slave_updates</span>=<span class="number">1</span></span><br><span class="line"><span class="comment">## é˜²æ­¢æ”¹å˜æ•°æ®(é™¤äº†ç‰¹æ®Šçš„çº¿ç¨‹)</span></span><br><span class="line"><span class="attr">read_only</span>=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<h2 id="masterç«¯æ·»åŠ slaveç«¯å¤åˆ¶è´¦å·"><a href="#masterç«¯æ·»åŠ slaveç«¯å¤åˆ¶è´¦å·" class="headerlink" title="masterç«¯æ·»åŠ slaveç«¯å¤åˆ¶è´¦å·"></a>masterç«¯æ·»åŠ slaveç«¯å¤åˆ¶è´¦å·</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">CREATE USER &apos;slave&apos;@&apos;%&apos; IDENTIFIED BY &apos;xxxxxx&apos;; #slaveå¯†ç xxxxxxï¼Œä¸‹é¢change masteræ—¶ç”¨åˆ°</span><br><span class="line">GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &apos;slave&apos;@&apos;%&apos;;</span><br><span class="line"># mysql 5.7ä¹Ÿå¯ä»¥ä¸€è¡Œå‘½ä»¤</span><br><span class="line"># GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &apos;slave&apos;@&apos;%&apos; IDENTIFIED BY &apos;xxxxxx&apos;;</span><br><span class="line"></span><br><span class="line"># &apos;slave&apos;@&apos;%&apos; æˆ– &apos;slave&apos;@&apos;172.17.0.3&apos; #172.17.0.3æ˜¯slaveå®¹å™¨çš„ip</span><br><span class="line"># ä½†ä¸èƒ½å†™è™šæ‹Ÿæœºçš„ipï¼ˆæœ¬å®éªŒæ˜¯é€šè¿‡docker-composeéhostç½‘ç»œæ¨¡å¼åˆ›å»º2ä¸ªmysqlå®ä¾‹ï¼ŒæœªéªŒè¯hostæ¨¡å¼æ˜¯å¦å¯ä»¥ï¼‰</span><br></pre></td></tr></table></figure>
<h2 id="è·å–masterä¿¡æ¯"><a href="#è·å–masterä¿¡æ¯" class="headerlink" title="è·å–masterä¿¡æ¯"></a>è·å–masterä¿¡æ¯</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># mysql -uroot -p</span><br><span class="line">...</span><br><span class="line">flush tables with read lock; # é”è¡¨ï¼Œstart slaveåè§£é” UNLOCK TABLES</span><br><span class="line">show master status;</span><br><span class="line">+----------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| File                 | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</span><br><span class="line">+----------------------+----------+--------------+------------------+-------------------+</span><br><span class="line">| edu-mysql-bin.000001 |      769 |              | mysql</span><br></pre></td></tr></table></figure>
<h2 id="slaveç«¯è®¾å®šmaster"><a href="#slaveç«¯è®¾å®šmaster" class="headerlink" title="slaveç«¯è®¾å®šmaster"></a>slaveç«¯è®¾å®šmaster</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">change master to master_host=&apos;172.17.0.2&apos;, master_user=&apos;slave&apos;, master_password=&apos;xxxxxx&apos;, master_port=3306, master_log_file=&apos;edu-mysql-bin.000001&apos;, master_log_pos=769, master_connect_retry=30; # 172.17.0.3æ˜¯masterçš„IPï¼Œdockerä¸­é€šè¿‡docker inspectæŸ¥çœ‹</span><br><span class="line"></span><br><span class="line"># change master to master_host=&apos;172.17.0.2&apos;æ—¶172.17.0.2æ˜¯masterå®¹å™¨çš„IPï¼Œä¸èƒ½ä½¿ç”¨è™šæ‹Ÿæœºçš„IP</span><br><span class="line"></span><br><span class="line">###</span><br><span class="line">change master to master_host=&apos;172.17.0.2&apos;, master_user=&apos;slave&apos;, master_password=&apos;slave&apos;, master_port=3306, master_log_file=&apos;edu-mysql-bin.000033&apos;, master_log_pos=72831102, master_connect_retry=30;</span><br></pre></td></tr></table></figure>
<h2 id="slaveå¯åŠ¨ã€æŸ¥çœ‹"><a href="#slaveå¯åŠ¨ã€æŸ¥çœ‹" class="headerlink" title="slaveå¯åŠ¨ã€æŸ¥çœ‹"></a>slaveå¯åŠ¨ã€æŸ¥çœ‹</h2><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mysql&gt; start slave;</span><br><span class="line">mysql&gt; show slave status \G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.17.0.3</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 30</span><br><span class="line">              Master_Log_File: edu-mysql-bin.000001</span><br><span class="line">          Read_Master_Log_Pos: 29661</span><br><span class="line">               Relay_Log_File: edu-mysql-relay-bin.000018</span><br><span class="line">                Relay_Log_Pos: 6051</span><br><span class="line">        Relay_Master_Log_File: edu-mysql-bin.000001</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Percona toolkit</title>
    <url>/deployment/else/percona-toolkit/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a><strong>å®‰è£…</strong></h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://www.percona.com/downloads/percona-toolkit/2.2.7/RPM/percona-toolkit-2.2.7-1.noarch.rpm</span><br><span class="line">yum install percona-toolkit-2.2.7-1.noarch.rpm -y</span><br><span class="line">yum install perl-Digest-MD5 -y</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Installed:</span><br><span class="line">  percona-toolkit.noarch 0:2.2.7-1                                                                                                   </span><br><span class="line"></span><br><span class="line">Dependency Installed:</span><br><span class="line">  perl.x86_64 4:5.16.3-294.el7_6                perl-Carp.noarch 0:1.26-244.el7         perl-Compress-Raw-Bzip2.x86_64 0:2.061-3.el7 </span><br><span class="line">  perl-Compress-Raw-Zlib.x86_64 1:2.061-4.el7   perl-DBD-MySQL.x86_64 0:4.023-6.el7     perl-DBI.x86_64 0:1.627-4.el7                </span><br><span class="line">  perl-Data-Dumper.x86_64 0:2.145-3.el7         perl-Encode.x86_64 0:2.51-7.el7         perl-Exporter.noarch 0:5.68-3.el7            </span><br><span class="line">  perl-File-Path.noarch 0:2.09-2.el7            perl-File-Temp.noarch 0:0.23.01-3.el7   perl-Filter.x86_64 0:1.49-3.el7              </span><br><span class="line">  perl-Getopt-Long.noarch 0:2.40-3.el7          perl-HTTP-Tiny.noarch 0:0.033-3.el7     perl-IO-Compress.noarch 0:2.061-2.el7        </span><br><span class="line">  perl-IO-Socket-IP.noarch 0:0.21-5.el7         perl-IO-Socket-SSL.noarch 0:1.94-7.el7  perl-Mozilla-CA.noarch 0:20130114-5.el7      </span><br><span class="line">  perl-Net-Daemon.noarch 0:0.48-5.el7           perl-Net-LibIDN.x86_64 0:0.12-15.el7    perl-Net-SSLeay.x86_64 0:1.55-6.el7          </span><br><span class="line">  perl-PathTools.x86_64 0:3.40-5.el7            perl-PlRPC.noarch 0:0.2020-14.el7       perl-Pod-Escapes.noarch 1:1.04-294.el7_6     </span><br><span class="line">  perl-Pod-Perldoc.noarch 0:3.20-4.el7          perl-Pod-Simple.noarch 1:3.28-4.el7     perl-Pod-Usage.noarch 0:1.63-3.el7           </span><br><span class="line">  perl-Scalar-List-Utils.x86_64 0:1.27-248.el7  perl-Socket.x86_64 0:2.010-4.el7        perl-Storable.x86_64 0:2.45-3.el7            </span><br><span class="line">  perl-Text-ParseWords.noarch 0:3.29-4.el7      perl-Time-HiRes.x86_64 4:1.9725-3.el7   perl-Time-Local.noarch 0:1.2300-2.el7        </span><br><span class="line">  perl-constant.noarch 0:1.27-2.el7             perl-libs.x86_64 4:5.16.3-294.el7_6     perl-macros.x86_64 4:5.16.3-294.el7_6        </span><br><span class="line">  perl-parent.noarch 1:0.225-244.el7            perl-podlators.noarch 0:2.5.1-3.el7     perl-threads.x86_64 0:1.87-4.el7             </span><br><span class="line">  perl-threads-shared.x86_64 0:1.43-6.el7      </span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure>
<h2 id="æƒé™"><a href="#æƒé™" class="headerlink" title="æƒé™"></a><strong>æƒé™</strong></h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">GRANT ALL PRIVILEGES ON `zabbix`.* TO <span class="string">'pt'</span>@<span class="string">'%'</span></span><br><span class="line"></span><br><span class="line">show grants <span class="keyword">for</span> <span class="string">'root'</span>@<span class="string">'192.168.1.101'</span>;</span><br><span class="line"></span><br><span class="line">revoke SELECT, INSERT, UPDATE, DELETE, CREATE, PROCESS, SUPER, REPLICATION SLAVE ON *.* FROM <span class="string">'root'</span>@<span class="string">'192.168.1.101'</span>;</span><br></pre></td></tr></table></figure>
<h2 id="æ‰§è¡Œ"><a href="#æ‰§è¡Œ" class="headerlink" title="æ‰§è¡Œ"></a><strong>æ‰§è¡Œ</strong></h2><p>pt-table-checksum</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#pt-table-checksum --nocheck-replication-filters --no-check-binlog-format --replicate=test_sync.checksums --create-replicate-table --databases=test_sync --tables=contact h=10.1.7.211,u=root,p=mysqlxxx,P=3306</span></span><br><span class="line"></span><br><span class="line">pt-table-checksum --nocheck-replication-filters --no-check-binlog-format --replicate=test_sync.checksums --create-replicate-table --databases=test_sync h=10.1.7.211,u=root,p=mysqlxxx,P=3306</span><br></pre></td></tr></table></figure>
<p>pt-table-sync</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#pt-table-sync --replicate=test_sync.checksums h=10.1.7.211,u=root,p=mysqlxxx,P=3306 h=10.1.7.211,u=root,p=mysqlxxx,P=3307 --print</span></span><br><span class="line"></span><br><span class="line">pt-table-sync --replicate=test_sync.checksums h=10.1.7.211,u=root,p=mysqlxxx,P=3306 h=10.1.7.211,u=root,p=mysqlxxx,P=3307 --execute</span><br></pre></td></tr></table></figure>
<p>err:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Can<span class="string">'t make changes on the master because no unique index exists at /usr/bin/pt-table-sync line 10649.  while doing zabbix.history on 172.17.0.3</span></span><br></pre></td></tr></table></figure>
<p>pt-heartbeat</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">#pt-heartbeat --user=root --ask-pass --host=10.1.7.211 --port 3306 --create-table -D test_sync --interval=1 --update --replace --daemonize</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pt-heartbeat -D test_sync --table=heartbeat --monitor --host=10.1.7.211 --port=3306 --user=root --password=mysqlxxx --master-server-id=100 --print-master-server-id</span></span><br><span class="line"></span><br><span class="line">pt-heartbeat -D test_sync --table=heartbeat --check --host=10.1.7.211 --port=3306 --user=root --password=mysqlxxx --master-server-id=100 --<span class="built_in">print</span>-master-server-id</span><br><span class="line"></span><br><span class="line"><span class="comment">#pt-heartbeat --stop</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Redisé«˜å¯ç”¨æ–¹æ¡ˆKeepAlivedé…ç½®ç¤ºä¾‹</title>
    <url>/deployment/else/redis_ha_keepalived/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h3 id="ä¸€ä¸»ä¸¤ä»-ä¸‰å“¨å…µ-KeepAlived"><a href="#ä¸€ä¸»ä¸¤ä»-ä¸‰å“¨å…µ-KeepAlived" class="headerlink" title="ä¸€ä¸»ä¸¤ä»+ä¸‰å“¨å…µ+KeepAlived"></a>ä¸€ä¸»ä¸¤ä»+ä¸‰å“¨å…µ+KeepAlived</h3><blockquote>
<p> Redis (M/1 S/2)+ Sentinel/3 + KA/3 (VIP/1)</p>
</blockquote>
<a id="more"></a>
<p>KAé…ç½®ç¤ºä¾‹ï¼ˆå…¶ä¸€èŠ‚ç‚¹ï¼‰:</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id redis_swms</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_http_port &#123;     </span><br><span class="line">    script "/usr/local/redis/bin/redis-cli -p 8379 info | grep role:master &gt;/dev/null 2&gt;&amp;1"     </span><br><span class="line">    interval 1 </span><br><span class="line">    timeout 2</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 64</span><br><span class="line">    priority 120</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    unicast_src_ip 10.1.100.25</span><br><span class="line"></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        10.1.100.23</span><br><span class="line">        10.1.100.24</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 12345</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        10.1.100.22</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_http_port</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="ä¸€ä¸»ä¸€ä»-KeepAlived"><a href="#ä¸€ä¸»ä¸€ä»-KeepAlived" class="headerlink" title="ä¸€ä¸»ä¸€ä»+KeepAlived"></a>ä¸€ä¸»ä¸€ä»+KeepAlived</h3><blockquote>
<p> Redis (M/1 S/1) + KA/2 (VIP/1)</p>
</blockquote>
<p>KAé…ç½®ç¤ºä¾‹ï¼ˆå…¶ä¸€èŠ‚ç‚¹ï¼‰:</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id redis_swms</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_redis &#123;</span><br><span class="line">    script "/opt/scripts/keepalived/redis_check.sh 127.0.0.1 6379"</span><br><span class="line">    interval 1</span><br><span class="line">    timeout 2</span><br><span class="line">    fall 3</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens192</span><br><span class="line">    virtual_router_id 64</span><br><span class="line">    priority 120</span><br><span class="line">    advert_int 1</span><br><span class="line"></span><br><span class="line">    unicast_src_ip 192.168.101.65</span><br><span class="line"></span><br><span class="line">    unicast_peer &#123;</span><br><span class="line">        192.168.101.66</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 12345</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.101.64</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_redis</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    notify_master "/opt/scripts/keepalived/redis_master.sh 127.0.0.1 192.168.101.66 6379"</span><br><span class="line">    notify_backup "/opt/scripts/keepalived/redis_backup.sh 127.0.0.1 192.168.101.66 6379"</span><br><span class="line">    # notify_fault /opt/scripts/keepalived/redis_fault.sh</span><br><span class="line">    # notify_stop /opt/scripts/keepalived/redis_stop.sh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>redis_master.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">REDISCLI=<span class="string">"redis-cli -h <span class="variable">$1</span> -p <span class="variable">$3</span>"</span></span><br><span class="line">LOGFILE=<span class="string">"/var/log/redis/keepalived-redis-state.log"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[master]"</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line">date &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Being master...."</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Run MASTER cmd ..."</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line"><span class="variable">$REDISCLI</span> SLAVEOF <span class="variable">$2</span> <span class="variable">$3</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line">sleep 10 <span class="comment">#delay 10 s wait data async cancel sync</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Run SLAVEOF NO ONE cmd ..."</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line"><span class="variable">$REDISCLI</span> SLAVEOF NO ONE &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>redis_backup.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">REDISCLI=<span class="string">"redis-cli -h <span class="variable">$1</span> -p <span class="variable">$3</span>"</span></span><br><span class="line">LOGFILE=<span class="string">"/var/log/redis/keepalived-redis-state.log"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[backup]"</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line">date &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Run SLAVEOF cmd ..."</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line"><span class="variable">$REDISCLI</span> SLAVEOF <span class="variable">$2</span> <span class="variable">$3</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Being slave...."</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line">sleep 15 <span class="comment">#delay 15 s wait data sync exchange role</span></span><br></pre></td></tr></table></figure>
<p>redis_check.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ALIVE=`redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> PING`</span><br><span class="line">LOGFILE=<span class="string">"/var/log/redis/keepalived-redis-check.log"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"[CHECK]"</span> &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line">date &gt;&gt; <span class="variable">$LOGFILE</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$ALIVE</span> = <span class="string">"PONG"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Success: redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> PING <span class="variable">$ALIVE</span>"</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Failed:redis-cli -h <span class="variable">$1</span> -p <span class="variable">$2</span> PING <span class="variable">$ALIVE</span> "</span> &gt;&gt; <span class="variable">$LOGFILE</span> 2&gt;&amp;1</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>å…¶å®ƒ</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>ELK in K8s</title>
    <url>/deployment/k8s/k8s-elk/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h2 id="ç¤ºä¾‹é…ç½®"><a href="#ç¤ºä¾‹é…ç½®" class="headerlink" title="ç¤ºä¾‹é…ç½®"></a>ç¤ºä¾‹é…ç½®</h2><a id="more"></a>
<ul>
<li>elk-rc.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elk-rc</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">elk</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:6.6.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9200</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">es-storage</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">elasticsearch/data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">docker.elastic.co/logstash/logstash:6.6.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">logstash</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9600</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5000</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">docker.elastic.co/kibana/kibana:6.6.0</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">kibana</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ELASTICSEARCH_URL</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">http://127.0.0.1:9200</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5601</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">es-storage</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">pvc001</span></span><br></pre></td></tr></table></figure>
<ul>
<li>elk-svc-kibana.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kibana</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5601</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">kibana</span></span><br></pre></td></tr></table></figure>
<ul>
<li>elk-svc-logstash.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">logstash</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elk</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">elk</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8600</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">logstash</span></span><br></pre></td></tr></table></figure>
<ul>
<li>pv.yaml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv001</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">"/path/to/nfs"</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">x.xx.xxx.xxx</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pvc001</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">20Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">nfs</span></span><br></pre></td></tr></table></figure>
<p>åˆ›å»ºNFSæŒä¹…å·ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl create -f pv.yaml</span><br></pre></td></tr></table></figure>
<p>éƒ¨ç½²ELKï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">kubectl create -f elk-rc.yaml</span><br><span class="line">kubectl create -f elk-svc-logstash.yaml</span><br><span class="line">kubectl create -f elk-svc-kibana.yaml</span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
        <tag>ELK</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºNFSæ–‡ä»¶ç³»ç»Ÿçš„K8såŠ¨æ€PV</title>
    <url>/deployment/k8s/k8s-nfs-storageclass/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><blockquote>
<p>åŠ¨æ€å·ä¾›åº”çš„å®ç°åŸºäº <code>storage.k8s.io</code> API ç»„ä¸­çš„ <code>StorageClass</code> API å¯¹è±¡ã€‚ é›†ç¾¤ç®¡ç†å‘˜å¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰å¤šä¸ª <code>StorageClass</code> å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡æŒ‡å®šä¸€ä¸ª<em>å·æ’ä»¶</em>ï¼ˆåˆå <em>provisioner</em>ï¼‰ï¼Œ å·æ’ä»¶å‘å·ä¾›åº”å•†æä¾›åœ¨åˆ›å»ºå·æ—¶éœ€è¦çš„æ•°æ®å·ä¿¡æ¯åŠç›¸å…³å‚æ•°ã€‚</p>
</blockquote>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581474416957.png" alt="1581474416957"></p>
<a id="more"></a>
<h2 id="æ­¥éª¤"><a href="#æ­¥éª¤" class="headerlink" title="æ­¥éª¤"></a>æ­¥éª¤</h2><p>1ï¼‰ä½¿ç”¨NFS StorageClassåŠ¨æ€åˆ›å»ºPVçš„åŸºæœ¬é…ç½®</p>
<p>StorageClass</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">managed-nfs-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">archiveOnDelete:</span> <span class="string">"true"</span></span><br></pre></td></tr></table></figure>
<p>rbacï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["persistentvolumes"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"delete"</span><span class="string">]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["persistentvolumeclaims"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">["storage.k8s.io"]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["storageclasses"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["events"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["create",</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">    <span class="attr">resources:</span> <span class="string">["endpoints"]</span></span><br><span class="line">    <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">,</span> <span class="string">"create"</span><span class="string">,</span> <span class="string">"update"</span><span class="string">,</span> <span class="string">"patch"</span><span class="string">]</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="comment"># replace with namespace where provisioner is deployed</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-client-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>
<p>nfs-client provisionerï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">fuseim.pri/ifs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.150</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/testPV</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.150</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/testPV</span></span><br></pre></td></tr></table></figure>
<p>2ï¼‰NFSæ–‡ä»¶ç³»ç»Ÿæ­å»º</p>
<p>ä¸Šè¿°é…ç½®ä¸­ä½¿ç”¨äº†åœ¨192.168.100.150ä¸Šåˆ›å»ºçš„æµ‹è¯•ç”¨NFSæ–‡ä»¶ç³»ç»Ÿï¼Œå…¶æ­å»ºè¿‡ç¨‹æœ¬æ–‡ç•¥è¿‡ã€‚</p>
<h2 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h2><ul>
<li>æµ‹è¯•podç¤ºä¾‹</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">      <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">        <span class="attr">claimName:</span> <span class="string">my-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">5Gi</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æµ‹è¯•deploymentç¤ºä¾‹</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test-nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">www</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">my-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">8Gi</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581476470380.png" alt="1581476470380"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581476543730.png" alt="1581476543730"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581476639703.png" alt="1581476639703"></p>
<p>æŸ¥çœ‹nfsç›®å½•</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581476856992.png" alt="1581476856992"></p>
<ul>
<li>æµ‹è¯•statefulsetç¤ºä¾‹ï¼š</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">"nginx"</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-client-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/data/nginx"</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">ng</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">ng</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">volume.beta.kubernetes.io/storage-class:</span> <span class="string">"managed-nfs-storage"</span></span><br><span class="line">      <span class="attr">spec:</span></span><br><span class="line">        <span class="attr">accessModes:</span> <span class="string">[</span> <span class="string">"ReadWriteOnce"</span> <span class="string">]</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">storage:</span> <span class="string">10Gi</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581479581045.png" alt="1581479581045"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581479695002.png" alt="1581479695002"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/k8s-nfs-storageclass.assets/1581479769120.png" alt="1581479769120"></p>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>K8séƒ¨ç½²prometheus</title>
    <url>/deployment/k8s/k8s-prometheus/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h2 id="ç¤ºä¾‹é…ç½®"><a href="#ç¤ºä¾‹é…ç½®" class="headerlink" title="ç¤ºä¾‹é…ç½®"></a>ç¤ºä¾‹é…ç½®</h2><a id="more"></a>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span>     <span class="string">15s</span></span><br><span class="line">      <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-apiservers'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace,</span> <span class="string">__meta_kubernetes_service_name,</span> <span class="string">__meta_kubernetes_endpoint_port_name]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-nodes'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_node_name]</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-cadvisor'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">      <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">      <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_node_name]</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-service-endpoints'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__,</span> <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_name]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-services'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">      <span class="attr">params:</span></span><br><span class="line">        <span class="attr">module:</span> <span class="string">[http_2xx]</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_annotation_prometheus_io_probe]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_service_name]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-ingresses'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">ingress</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_ingress_annotation_prometheus_io_probe]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_ingress_scheme,__address__,__meta_kubernetes_ingress_path]</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+);(.+);(.+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$&#123;1&#125;://$&#123;2&#125;$&#123;3&#125;</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter.example.com:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__param_target]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_ingress_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_ingress_name]</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'kubernetes-pods'</span></span><br><span class="line">      <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">      <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_scrape]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_annotation_prometheus_io_path]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__address__,</span> <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_namespace]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_kubernetes_pod_name]</span></span><br><span class="line">        <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus-deployment</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">prom/prometheus:v2.0.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"/bin/prometheus"</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--config.file=/etc/prometheus/prometheus.yml"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--storage.tsdb.path=/prometheus"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"--storage.tsdb.retention=24h"</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/prometheus"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/etc/prometheus"</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">2500Mi</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">prometheus</span>    </span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config-volume</span></span><br><span class="line">        <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30003</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> <span class="string">[""]</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/proxy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">services</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">endpoints</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">extensions</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ingresses</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get",</span> <span class="string">"list"</span><span class="string">,</span> <span class="string">"watch"</span><span class="string">]</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">nonResourceURLs:</span> <span class="string">["/metrics"]</span></span><br><span class="line">  <span class="attr">verbs:</span> <span class="string">["get"]</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<h2 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">grafana/grafana:4.2.0</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">grafana-core</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="comment"># env:</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="comment"># keep request = limit to keep this container in guaranteed class</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="comment"># The following env variables set up basic auth twith the default admin user and admin password.</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_BASIC_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">"true"</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GF_AUTH_ANONYMOUS_ENABLED</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">"false"</span></span><br><span class="line">          <span class="comment"># - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span></span><br><span class="line">          <span class="comment">#   value: Admin</span></span><br><span class="line">          <span class="comment"># does not really work, because of template variables in exported dashboards:</span></span><br><span class="line">          <span class="comment"># - name: GF_DASHBOARDS_JSON_ENABLED</span></span><br><span class="line">          <span class="comment">#   value: "true"</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">          <span class="comment"># initialDelaySeconds: 30</span></span><br><span class="line">          <span class="comment"># timeoutSeconds: 1</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">grafana-persistent-storage</span></span><br><span class="line">        <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">   <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">   <span class="attr">rules:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">k8s.grafana</span></span><br><span class="line">     <span class="attr">http:</span></span><br><span class="line">       <span class="attr">paths:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">         <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">grafana</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">3000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">3000</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">grafana</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">core</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Kubernetes Dashboard</title>
    <url>/deployment/k8s/kubernetes-dashboard/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h4 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h4><ul>
<li>è·å–token</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | awk <span class="string">'/^deployment-controller-token-/&#123;print $1&#125;'</span>) | awk <span class="string">'$1=="token:"&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep kubernetes-dashboard-token |awk <span class="string">'&#123;print $1&#125;'</span>) | grep token: | awk <span class="string">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl -n kube-system describe $(kubectl -n kube-system get secret -n kube-system -o name | grep namespace) | grep token:</span><br></pre></td></tr></table></figure>
<ul>
<li>åˆ›å»ºClusterRoleBinding</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<ul>
<li>URL</li>
</ul>
<p><a href="https://{master_ip}:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" target="_blank" rel="noopener">https://{master_ip}:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a></p>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>kubesprayå®‰è£…K8s</title>
    <url>/deployment/k8s/kubespray-k8s/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>kubesprayé¡¹ç›®åœ°å€: <a href="https://github.com/kubernetes-sigs/kubespray" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kubernetes-sigs/kubespray</a></p>
<p>å®˜æ–¹å‚è€ƒï¼š<a href="http://192.168.100.150/k8s/kubespray-k8s/0812/kubespray/#/docs/getting-started" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150/k8s/kubespray-k8s/0812/kubespray/#/docs/getting-started</a></p>
<p>é¡¹ç›®åˆ†æ”¯ï¼šrelease-2.11</p>
<p>K8sç‰ˆæœ¬ï¼š1.15.1</p>
</blockquote>
<a id="more"></a>
<p><em><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank">Kubernetes (K8s)</a> is an open-source system for automating deployment, scaling, and management of containerized applications.</em></p>
<p><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank"><strong>Kubernetes (K8s)</strong></a> æ˜¯ä¸€ä¸ªå¼€æºå®¹å™¨ç¼–æ’å¼•æ“ï¼Œç”¨äºè‡ªåŠ¨åŒ–å®¹å™¨åŒ–åº”ç”¨ç¨‹åºçš„éƒ¨ç½²ï¼Œæ‰©å±•å’Œç®¡ç†ã€‚</p>
<p><img src="https://d33wubrfki0l68.cloudfront.net/26a177ede4d7b032362289c6fccd448fc4a91174/eb693/images/docs/container_evolution.svg" alt="Deployment evolution"></p>
<p><em>åº”ç”¨éƒ¨ç½²æ–¹å¼çš„æ¼”å˜å†å²ï¼šç‰©ç†æœºéƒ¨ç½²  =&gt; è™šæ‹Ÿæœºéƒ¨ç½²  =&gt; å®¹å™¨åŒ–éƒ¨ç½²</em></p>
<h2 id="å‡†å¤‡"><a href="#å‡†å¤‡" class="headerlink" title="å‡†å¤‡"></a>å‡†å¤‡</h2><p>å› å›½å¤–ç½‘ç»œé—®é¢˜ï¼Œå®‰è£…å‰éœ€ä½œå¿…è¦çš„ä¿®æ”¹ï¼Œå†™æˆé¢„å¤„ç†è„šæœ¬å¦‚ä¸‹ï¼š</p>
<p>pre-install.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### å®‰è£…gitå¹¶cloneå®˜æ–¹å®‰è£…è„šæœ¬</span></span><br><span class="line">yum install git -y</span><br><span class="line">kube_version=v1.15.1</span><br><span class="line"><span class="keyword">if</span> [ ! -d kubespray ]; <span class="keyword">then</span></span><br><span class="line">  git <span class="built_in">clone</span> https://github.com/kubernetes-sigs/kubespray</span><br><span class="line">  <span class="built_in">cd</span> kubespray</span><br><span class="line">  git checkout release-2.11</span><br><span class="line">  <span class="built_in">cd</span> -</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cd</span> kubespray</span><br><span class="line"><span class="keyword">if</span> [ ! -d inventory/mycluster ]; <span class="keyword">then</span></span><br><span class="line">  cp -r inventory/sample inventory/mycluster</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### æ›´æ–°pipåŠå®‰è£…ä¾èµ–</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">"-U"</span> ]; <span class="keyword">then</span></span><br><span class="line">  easy_install pip</span><br><span class="line">  pip install pip==8.0.3</span><br><span class="line">  pip uninstall requests</span><br><span class="line">  pip install -U pip</span><br><span class="line">  pip install -U setuptools</span><br><span class="line">  pip install -r requirements.txt</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################### æ‰€æœ‰ä¿®æ”¹ä»…æ¶‰åŠä»¥ä¸‹4ä¸ªæ–‡ä»¶ï¼Œå¯äº‹å…ˆæ”¹å¥½å¦å­˜è¦†ç›–</span></span><br><span class="line"><span class="comment">#inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml</span></span><br><span class="line"><span class="comment">#roles/download/defaults/main.yml</span></span><br><span class="line"><span class="comment">#roles/kubespray-defaults/defaults/main.yaml</span></span><br><span class="line"><span class="comment">#inventory/mycluster/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">################### è‹¥ä¸äº‹å…ˆå‡†å¤‡æ”¹å¥½çš„æ–‡ä»¶ï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¿®æ”¹ï¼š</span></span><br><span class="line"><span class="comment">### æ”¹ç‰ˆæœ¬å·</span></span><br><span class="line">sed -i <span class="string">"s/^kube_version:.*$/kube_version: <span class="variable">$kube_version</span>/"</span> roles/kubespray-defaults/defaults/main.yaml</span><br><span class="line">sed -i <span class="string">"s/^kube_version:.*$/kube_version: <span class="variable">$kube_version</span>/"</span> roles/download/defaults/main.yml</span><br><span class="line">sed -i <span class="string">"s/^kube_version:.*$/kube_version: <span class="variable">$kube_version</span>/"</span> inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">### æ”¹é•œåƒæº</span></span><br><span class="line">kube_image_repo=mirrorgooglecontainers</span><br><span class="line">sed -i <span class="string">"s/^kube_image_repo:.*$/kube_image_repo: <span class="variable">$kube_image_repo</span>/"</span> inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml</span><br><span class="line"></span><br><span class="line">sed -i <span class="string">"s/^kube_image_repo:.*$/kube_image_repo: <span class="variable">$kube_image_repo</span>/"</span> roles/download/defaults/main.yml</span><br><span class="line">sed -i <span class="string">"s/k8s.gcr.io/<span class="variable">$kube_image_repo</span>/g"</span> roles/download/defaults/main.yml</span><br><span class="line">sed -i <span class="string">"s#gcr.io/google_containers#<span class="variable">$kube_image_repo</span>#g"</span> roles/download/defaults/main.yml</span><br><span class="line">sed -i <span class="string">"s/gcr.io/<span class="variable">$kube_image_repo</span>/g"</span> roles/download/defaults/main.yml</span><br><span class="line">sed -i <span class="string">"s#(k8s.)?gcr.io(/google_containers)?#<span class="variable">$kube_image_repo</span>#g"</span> roles/download/defaults/main.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#nodelocaldns_version: 1.15.1</span></span><br><span class="line">nodelocaldns_image_repo=lzzeng/k8s-dns-node-cache</span><br><span class="line">sed -i <span class="string">'s#^nodelocaldns_image_repo:.*$'</span><span class="string">"#nodelocaldns_image_repo: <span class="variable">$nodelocaldns_image_repo</span>#"</span> roles/download/defaults/main.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">### æ”¹äºŒè¿›åˆ¶æ–‡ä»¶ä¸‹è½½åœ°å€</span></span><br><span class="line">download_url=http://192.168.100.150/k8s/<span class="variable">$kube_version</span></span><br><span class="line">sed -i <span class="string">'s#^kubeadm_download_url:.*$#kubeadm_download_url: '</span>\"<span class="string">"<span class="variable">$download_url</span>"</span><span class="string">'/kubeadm\"#'</span> roles/download/defaults/main.yml</span><br><span class="line">sed -i <span class="string">'s#^hyperkube_download_url:.*$#hyperkube_download_url: '</span>\"<span class="string">"<span class="variable">$download_url</span>"</span><span class="string">'/hyperkube\"#'</span> roles/download/defaults/main.yml</span><br><span class="line">sed -i <span class="string">'s#^calicoctl_download_url:.*$#calicoctl_download_url: '</span>\"<span class="string">"<span class="variable">$download_url</span>"</span><span class="string">'/calicoctl-linux-amd64\"#'</span> roles/download/defaults/main.yml <span class="comment">#1.15.1 ä½¿ç”¨ 3.7.3</span></span><br><span class="line">sed -i <span class="string">'s#^etcd_download_url:.*$#etcd_download_url: '</span>\"<span class="string">"<span class="variable">$download_url</span>"</span><span class="string">'/etcd-v3.3.10-linux-amd64.tar.gz\"#'</span> roles/download/defaults/main.yml <span class="comment">#1.15.1 ä½¿ç”¨ v3.3.10</span></span><br><span class="line">sed -i <span class="string">'s#^cni_download_url:.*$#cni_download_url: '</span>\"<span class="string">"<span class="variable">$download_url</span>"</span><span class="string">'/cni-plugins-linux-amd64-v0.8.1.tgz\"#'</span> roles/download/defaults/main.yml <span class="comment">#1.15.1 ä½¿ç”¨ v0.8.1</span></span><br><span class="line">sed -i <span class="string">'s#^crictl_download_url:.*$#crictl_download_url: '</span>\"<span class="string">"<span class="variable">$download_url</span>"</span><span class="string">'/critest-v1.15.0-linux-amd64.tar.gz\"#'</span> roles/download/defaults/main.yml <span class="comment">#1.15.1 ä½¿ç”¨ v1.15.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### å¯ä»¥ä¿®æ”¹å†…å­˜é™åˆ¶ï¼Œä½¿å¾—1Gå†…å­˜ä¹Ÿå¯ä»¥æ‰§è¡Œå®‰è£…</span></span><br><span class="line"><span class="comment">#sed -i 's/^minimal_node_memory_mb:.*$/minimal_node_memory_mb: 500/' roles/kubernetes/preinstall/defaults/main.yml</span></span><br><span class="line"><span class="comment">#sed -i 's/^minimal_master_memory_mb:.*$/minimal_master_memory_mb: 500/' roles/kubernetes/preinstall/defaults/main.yml</span></span><br><span class="line"><span class="comment">#sed -i 's/ansible_memtotal_mb\s*&gt;=\s*[0-9]\+/ansible_memtotal_mb &gt;= 500/' roles/kubernetes/preinstall/tasks/0020-verify-settings.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### dockeråŠ é€Ÿ</span></span><br><span class="line">cat &lt;&lt;EOF &gt;&gt; inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml</span><br><span class="line"><span class="comment"># Debian docker-ce repo</span></span><br><span class="line">docker_debian_repo_base_url: <span class="string">"https://mirrors.aliyun.com/docker-ce/linux/debian"</span></span><br><span class="line">docker_debian_repo_gpgkey: <span class="string">"https://mirrors.aliyun.com/docker-ce/linux/debian/gpg"</span></span><br><span class="line">dockerproject_apt_repo_base_url: <span class="string">"https://mirrors.aliyun.com/docker-engine/apt/repo"</span></span><br><span class="line">dockerproject_apt_repo_gpgkey: <span class="string">"https://mirrors.aliyun.com/docker-engine/apt/gpg"</span></span><br><span class="line">docker_options: <span class="string">"--insecure-registry= --registry-mirror=https://registry.docker-cn.com --graph= "</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">### æ‰“å°ansibleå‘½ä»¤</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"å†kubesprayæ ¹ç›®å½•æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…æˆ–é‡ç½®ï¼š"</span></span><br><span class="line"><span class="built_in">echo</span> ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root cluster.yml</span><br><span class="line"><span class="built_in">echo</span> ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root reset.yml</span><br></pre></td></tr></table></figure>
<p>inventory/mycluster/hosts.iniç¤ºä¾‹ï¼š</p>
<p>node1ã€node2æ˜¯masterè°ƒåº¦èŠ‚ç‚¹ï¼Œnode1~node3æ˜¯etcdèŠ‚ç‚¹ï¼Œnode3~node6æ˜¯å·¥ä½œèŠ‚ç‚¹ã€‚</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[all]</span></span><br><span class="line">node1    ansible_host=192.168.100.79 ip=192.168.100.79</span><br><span class="line">node2    ansible_host=192.168.100.80 ip=192.168.100.80</span><br><span class="line">node3    ansible_host=192.168.100.81 ip=192.168.100.81</span><br><span class="line">node4    ansible_host=192.168.100.216 ip=192.168.100.216</span><br><span class="line">node5    ansible_host=192.168.100.217 ip=192.168.100.217</span><br><span class="line">node6    ansible_host=192.168.100.218 ip=192.168.100.218</span><br><span class="line"></span><br><span class="line"><span class="section">[kube-master]</span></span><br><span class="line">node1</span><br><span class="line">node2</span><br><span class="line"></span><br><span class="line"><span class="section">[etcd]</span></span><br><span class="line">node1</span><br><span class="line">node2</span><br><span class="line">node3</span><br><span class="line"></span><br><span class="line"><span class="section">[kube-node]</span></span><br><span class="line">node3</span><br><span class="line">node4</span><br><span class="line">node5</span><br><span class="line">node6</span><br><span class="line"></span><br><span class="line"><span class="section">[k8s-cluster:children]</span></span><br><span class="line">kube-master</span><br><span class="line">kube-node</span><br></pre></td></tr></table></figure>
<h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><p>å¦æ‰¾ä¸€ä¸ªæ‰§è¡Œansibleçš„æœºå™¨ï¼Œå¹¶æˆæƒä½¿å…¶å¯ä»¥å…å¯†ç™»å½•node1~node6ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ssh-keygen		          <span class="comment"># è¿™å‡ æ¡å‘½ä»¤éƒ½ä¼šæç¤ºæ‰‹åŠ¨ç¡®è®¤</span></span><br><span class="line">ssh-copy-id root@node1</span><br><span class="line">ssh-copy-id root@node2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œå®‰è£…ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ‰§è¡Œä¸Šè¿°å‡†å¤‡å¥½çš„é¢„å¤„ç†è„šæœ¬ï¼ˆå¯¹åº”v1.15.1ç‰ˆæœ¬ï¼‰</span></span><br><span class="line">sh pre-install.sh</span><br><span class="line"><span class="comment"># æŒ‰ä¸Šè¿°ä¿®æ”¹å¥½hosts.iniåï¼Œæ‰§è¡Œansibleç¼–æ’ä»»åŠ¡ï¼Œç­‰å¾…ç»“æŸå³å¯</span></span><br><span class="line">ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root cluster.yml</span><br></pre></td></tr></table></figure>
<h2 id="ç™»å½•"><a href="#ç™»å½•" class="headerlink" title="ç™»å½•"></a>ç™»å½•</h2><p>è·å–ç™»å½•kubernetes-dashboardçš„token:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl get svc --all-namespaces | grep kubernetes-dashboard</span><br><span class="line">kubectl -n kube-system describe $(kubectl -n kube-system get secret -n kube-system -o name | grep namespace) | grep token</span><br></pre></td></tr></table></figure>
<p>æœªä½¿ç”¨keepalivedæ—¶ï¼Œå¯é€šè¿‡å…¶ä¸€masterç™»å½•ï¼š<a href="https://192.168.100.79:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" rel="external nofollow noopener noreferrer" target="_blank">https://192.168.100.79:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a></p>
<h2 id="keepalivedé…ç½®ç¤ºä¾‹"><a href="#keepalivedé…ç½®ç¤ºä¾‹" class="headerlink" title="keepalivedé…ç½®ç¤ºä¾‹"></a>keepalivedé…ç½®ç¤ºä¾‹</h2><p>node1 (master-1) çš„/etc/keepalived/keepalived.confï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script "killall -0 haproxy"</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 78</span><br><span class="line">    priority 120</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass xxxxxxxxxxxxxxxx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.100.78</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>node2 (master-2) çš„/etc/keepalived/keepalived.confï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">    script "killall -0 haproxy"</span><br><span class="line">    interval 3</span><br><span class="line">    weight -2</span><br><span class="line">    fall 10</span><br><span class="line">    rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 78</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass xxxxxxxxxxxxxxxx</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.100.78</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»…<code>state BACKUP</code>å’Œ<code>priority 100</code>ä¸¤å¤„ä¸åŒã€‚</p>
<hr>
<p><strong>è¡¥å……ï¼ˆ1.14.1ï¼‰</strong></p>
<ul>
<li><p>ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ä¸­çš„é•œåƒåœ°å€</p>
<ul>
<li>inventory/mycluster/group_vars/k8s-cluster/k8s-cluster.yml</li>
<li>roles/download/defaults/main.yml</li>
</ul>
<p>å¤§éƒ¨åˆ†é•œåƒå¯ä»¥æ”¹ä»registry.cn-hangzhou.aliyuncs.com/google_containersè·å–ã€‚</p>
</li>
</ul>
<ul>
<li><p>ä¸èƒ½ç›´æ¥ä¸‹è½½çš„è½¯ä»¶</p>
<p>é€šè¿‡æµè§ˆå™¨ï¼ˆå·²è®¾ç½®googleä»£ç†ï¼‰ä¸‹è½½kubeadmå’Œhyperkubeï¼Œæ”¾ç½®åœ¨å†…ç½‘æ–‡ä»¶æœåŠ¡å™¨ä¸­ã€‚hyperkubeå’ŒkubeadmåŒ…ä¼šè¢«ä¸‹è½½åˆ°æ‰€æœ‰k8sèŠ‚ç‚¹çš„/tmp/releasesç›®å½•ä¸‹ã€‚</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># kubeadm_download_url: https://storage.googleapis.com/kubernetes-release/release/v1.14.1/bin/linux/amd64/kubeadm</span></span><br><span class="line"><span class="comment"># hyperkube_download_url: https://storage.googleapis.com/kubernetes-release/release/v1.14.1/bin/linux/amd64/hyperkube</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>ä¸èƒ½ä»Alié•œåƒåº“è·å–çš„é•œåƒ</p>
<ul>
<li>k8s.gcr.io/cluster-proportional-autoscaler-amd64:1.4.0</li>
<li>k8s.gcr.io/k8s-dns-node-cache:1.15.1</li>
</ul>
</li>
</ul>
<ul>
<li>æ‰§è¡Œ</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pip install -r requirements.txt</span><br><span class="line"></span><br><span class="line">ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root cluster.yml</span><br></pre></td></tr></table></figure>
<ul>
<li>å¦‚ä½•æ¸…ç†</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ansible -i inventory/mycluster/hosts.ini all -m script -a <span class="string">'/opt/clean.sh'</span></span><br><span class="line"><span class="comment"># æˆ–è€…</span></span><br><span class="line">ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root reset.yml</span><br></pre></td></tr></table></figure>
<p>clean.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">rm -rf /etc/kubernetes/</span><br><span class="line">rm -rf /var/lib/kubelet</span><br><span class="line">rm -rf /var/lib/etcd</span><br><span class="line">rm -rf /usr/<span class="built_in">local</span>/bin/kubectl</span><br><span class="line">rm -rf /etc/systemd/system/calico-node.service</span><br><span class="line">rm -rf /etc/systemd/system/kubelet.service</span><br><span class="line">systemctl stop etcd.service</span><br><span class="line">systemctl <span class="built_in">disable</span> etcd.service</span><br><span class="line">systemctl stop calico-node.service</span><br><span class="line">systemctl <span class="built_in">disable</span> calico-node.service</span><br><span class="line">docker stop $(docker ps -q)</span><br><span class="line">docker rm $(docker ps -a -q)</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>
<ul>
<li>å®‰è£…å®Œæˆåä¿®æ”¹èŠ‚ç‚¹æ ‡ç­¾</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl label node node3 node-role.kubernetes.io/worker=<span class="string">""</span>  <span class="comment">#æ ‡è®°worker</span></span><br><span class="line"></span><br><span class="line">kubectl label node node3 node-role.kubernetes.io/node=<span class="string">""</span> <span class="comment">#æ ‡è®°node</span></span><br><span class="line"></span><br><span class="line">kubectl label node node3  <span class="string">"node-role.kubernetes.io/worker"</span>- <span class="comment"># åˆ é™¤workeræ ‡è®°</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="Kubernetes-Dashboard"><a href="#Kubernetes-Dashboard" class="headerlink" title="Kubernetes Dashboard"></a>Kubernetes Dashboard</h3><ul>
<li><p>ä»¥NodePortæ–¹å¼æš´éœ²æœåŠ¡</p>
<p>ä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨NodePortæ–¹å¼è®¿é—®Dashboardã€‚</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ./roles/kubernetes-apps/ansible/templates/dashboard.yml.j2</span></span><br><span class="line"><span class="comment"># ------------------- Dashboard Service ------------------- #</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>    <span class="string">//æ·»åŠ è¿™ä¸€è¡Œ</span>   </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line"><span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>
<ul>
<li>è·å–token</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl get svc --all-namespaces | grep kubernetes-dashboard</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system describe $(kubectl -n kube-system get secret -n kube-system -o name | grep namespace) | grep token</span><br></pre></td></tr></table></figure>
<ul>
<li><p>éNodePortæ–¹å¼è®¿é—®</p>
<p><a href="https://192.168.100.78:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/" rel="external nofollow noopener noreferrer" target="_blank">https://192.168.100.78:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</a>ï¼ˆ192.168.100.78æ˜¯VIPæˆ–è€…æŸä¸ªmasterèŠ‚ç‚¹IPï¼‰</p>
</li>
</ul>
<hr>
<p><strong>åç»­æ“ä½œ</strong></p>
<p>ä»¥ä¸Šå®Œæˆçš„æ˜¯å¸¦æœ‰kubernetes dashboardçš„åˆå§‹ç¯å¢ƒçš„æ­å»ºï¼Œä¹‹åè¿˜è¦è¿›è¡Œ æ›¿æ¢Ingressã€è®¾ç½®ADè®¤è¯ã€å®‰è£…ç®¡ç†å·¥å…·ç­‰ï¼Œæ­¤ä¸æ¶‰åŠã€‚</p>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>é€šè¿‡Rancheråˆæ­¥åˆ›å»ºK8sé›†ç¾¤è¿‡ç¨‹è®°å½•</title>
    <url>/deployment/k8s/rancher-k8s/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>é›†ç¾¤æ¶æ„å‚è€ƒå›¾ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551952435046.png" alt="1551952435046"></p>
<a id="more"></a>
<p>é›†ç¾¤èµ„æºåˆ—è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>IP</th>
<th>role</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td>192.168.101.71</td>
<td>rancher server<br>k8s-master (etcd, control)</td>
<td>masterèŠ‚ç‚¹<br><strong><em>rancher server</em></strong></td>
</tr>
<tr>
<td>192.168.101.72</td>
<td>k8s-master (etcd, control)</td>
<td>masterèŠ‚ç‚¹</td>
</tr>
<tr>
<td>192.168.101.73</td>
<td>k8s-master (etcd, control)</td>
<td>masterèŠ‚ç‚¹</td>
</tr>
<tr>
<td>192.168.101.74</td>
<td>k8s-node (worker)</td>
<td>workerèŠ‚ç‚¹ï¼ˆå¯è¢«è°ƒåº¦ï¼‰</td>
</tr>
<tr>
<td>192.168.101.75</td>
<td>k8s-node (worker)</td>
<td>workerèŠ‚ç‚¹</td>
</tr>
<tr>
<td>192.168.101.76</td>
<td>k8s-node (worker)</td>
<td>workerèŠ‚ç‚¹</td>
</tr>
<tr>
<td>192.168.<strong><em>101.70</em></strong></td>
<td>VIP</td>
<td>è™šæ‹Ÿ IP</td>
</tr>
</tbody>
</table>
<p>å®‰è£…æ­¥éª¤ï¼š</p>
<ul>
<li>åˆå§‹å‡†å¤‡</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># /etc/hosts</span></span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">192.168.101.71  b71-k8s-m01</span><br><span class="line">192.168.101.72  b72-k8s-m02</span><br><span class="line">192.168.101.73  b73-k8s-m03</span><br><span class="line">192.168.101.74  b74-k8s-c01</span><br><span class="line">192.168.101.75  b75-k8s-c02</span><br><span class="line">192.168.101.76  b76-k8s-c03</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­firewalld</span></span><br><span class="line">systemctl stop firewalld.service</span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ— swapåˆ†åŒºï¼Œä¸æ¶‰åŠswapoffæ“ä½œ</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­selinux</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i <span class="string">'/^SELINUX=/s/=.*$/=disabled/'</span> /etc/selinux/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…docker-ce 18.06</span></span><br><span class="line">wget -P /etc/yum.repos.d https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">yum install docker-ce-18.06.1.ce -y</span><br><span class="line">systemctl start docker.service</span><br><span class="line">systemctl <span class="built_in">enable</span> docker.service</span><br></pre></td></tr></table></figure>
<p>haproxy + keepalived é…ç½®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment">### å¯¹3ä¸ªmasterèŠ‚ç‚¹ï¼šæ·»åŠ åˆ°æ–‡ä»¶/etc/sysctl.conf</span></span><br><span class="line">cat &lt;&lt;EOF &gt;&gt;/etc/sysctl.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.ipv4.ip_nonlocal_bind = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">### ä¿®æ”¹keepalived.conf</span></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_haproxy &#123;</span><br><span class="line">	script <span class="string">"killall -0 haproxy"</span></span><br><span class="line">	interval 3</span><br><span class="line">	weight -2</span><br><span class="line">	fall 10</span><br><span class="line">	rise 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">	state MASTER <span class="comment"># å¦2ä¸ªåˆ†åˆ«æ˜¯BACKUPã€BACKUP</span></span><br><span class="line">	interface ens192</span><br><span class="line">	virtual_router_id 51</span><br><span class="line">	priority 120 <span class="comment"># ä¼˜å…ˆçº§ï¼Œå¦2ä¸ªå¯ä»¥è®¾ç½®ä¸º100</span></span><br><span class="line">	advert_int 1</span><br><span class="line">	authentication &#123;</span><br><span class="line">		auth_type PASS</span><br><span class="line">		auth_pass 59144e4504f2b953e7b9</span><br><span class="line">	&#125;</span><br><span class="line">	virtual_ipaddress &#123;</span><br><span class="line">		192.168.101.70</span><br><span class="line">	&#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">		check_haproxy</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…killall</span></span><br><span class="line">yum install psmisc -y</span><br><span class="line"></span><br><span class="line">systemctl <span class="built_in">enable</span> keepalived.service</span><br><span class="line">systemctl start keepalived.service</span><br><span class="line">[root@B72-k8s-m02 haproxy]<span class="comment"># ip address show ens192</span></span><br><span class="line">2: ens192: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000</span><br><span class="line">    link/ether 00:50:56:85:8a:00 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 192.168.101.72/24 brd 192.168.101.255 scope global noprefixroute ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 192.168.101.70/32 scope global ens192</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::250:56ff:fe85:8a00/64 scope link</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"><span class="comment">### ä¿®æ”¹haproxy.cfg</span></span><br><span class="line">...</span><br><span class="line"><span class="comment"># main frontend which proxys to the backends</span></span><br><span class="line"><span class="comment">#---------------------------------------------------------------------</span></span><br><span class="line">frontend kubernetes-apiserver</span><br><span class="line">    mode                 tcp</span><br><span class="line">    <span class="built_in">bind</span>                 *:16443</span><br><span class="line">    option               tcplog</span><br><span class="line">    default_backend      kubernetes-apiserver</span><br><span class="line"></span><br><span class="line">backend kubernetes-apiserver</span><br><span class="line">    mode        tcp</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  b71-k8s-m01 192.168.101.71:6443 check weight 1</span><br><span class="line">    server  b72-k8s-m02 192.168.101.72:6443 check weight 2</span><br><span class="line">    server  b73-k8s-m03 192.168.101.73:6443 check weight 2</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line">    <span class="built_in">bind</span>                 *:1080</span><br><span class="line">    stats auth           admin:password</span><br><span class="line">    stats refresh        5s</span><br><span class="line">    stats realm          HAProxy\ Statistics</span><br><span class="line">    stats uri            /admin?stats</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨haproxy</span></span><br><span class="line">systemctl <span class="built_in">enable</span> haproxy.service</span><br><span class="line">systemctl start haproxy.service</span><br></pre></td></tr></table></figure>
<p>éœ€å¼€æ”¾çš„ç«¯å£è§ <a href="https://rancher.com/docs/rancher/v2.x/en/installation/references/" rel="external nofollow noopener noreferrer" target="_blank">https://rancher.com/docs/rancher/v2.x/en/installation/references/</a>ã€‚</p>
<p>ä¸ºäº†ç®€ä¾¿ï¼Œå…³é—­äº†é˜²ç«å¢™ã€‚é€šè¿‡Rancherå®‰è£…åï¼ŒæŸ¥çœ‹ä¸€ä¸‹iptablesè§„åˆ™ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@B71-k8s-m01 ~]<span class="comment"># iptables -L -n</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-EXTERNAL-SERVICES  all  --  0.0.0.0/0            0.0.0.0/0            ctstate NEW </span><br><span class="line">KUBE-FIREWALL  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy DROP)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">KUBE-FORWARD  all  --  0.0.0.0/0            0.0.0.0/0            </span><br><span class="line">DOCKER-USER  all  --  0.0.0.0/0            0.0.0.0/0           </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li><p>å®‰è£…rancher server</p>
<p>åœ¨èŠ‚ç‚¹101.71ä¸Šæ‰§è¡Œï¼š</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run -d --restart=unless-stopped -p 80:80 -p 443:443 rancher/rancher:stable</span><br></pre></td></tr></table></figure>
<ul>
<li><p>ç™»å½•Rancher Webåˆ›å»ºé›†ç¾¤</p>
<p>URL: <a href="https://192.168.101.71/" rel="external nofollow noopener noreferrer" target="_blank">https://192.168.101.71/</a></p>
</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551953142393.png" alt="1551953142393"></p>
<p>â€‹    æ·»åŠ masterèŠ‚ç‚¹æ—¶ï¼Œæ˜¯æŒ‰å¦‚ä¸‹è®¾ç½®çš„ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551840677589.png" alt="1551840677589"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551840771418.png" alt="1551840771418"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551840932234.png" alt="1551840932234"></p>
<p>â€‹    å¤åˆ¶å‘½ä»¤åœ¨å¾…æ·»åŠ çš„èŠ‚ç‚¹æœºå™¨ä¸Šæ‰§è¡Œï¼Œä¾æ¬¡æ·»åŠ å®Œ3ä¸ªmasterèŠ‚ç‚¹åå¦‚ä¸‹ï¼Œå…¶ä¸­101.71æ˜¯ç¬¬äºŒä¸ªæ·»åŠ çš„ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551841031094.png" alt="1551841031094"></p>
<p>â€‹    åœ¨æœºå™¨æ•°é‡è¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œå¯å°†rancher serverå•ç‹¬éƒ¨ç½²ï¼Œæ­¤å¤„æ˜¯ä¸K8s_masterå…±ç”¨ã€‚ç»åå¤è¯•éªŒï¼Œæ·»åŠ masterèŠ‚ç‚¹æ—¶ï¼Œå…ˆæ·»åŠ 101.72æˆ–101.73ï¼Œ<strong>ä¸è¦é¦–å…ˆæ·»åŠ rancher serveræ‰€åœ¨èŠ‚ç‚¹101.71</strong>ã€‚å¦åˆ™ï¼Œåç»­æ·»åŠ masteræ—¶ä¼šå‡º<strong>é—®é¢˜</strong>ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551839742271.png" alt="1551839742271"></p>
<p>ä¸Šå›¾æ˜¾ç¤º101.72ä¸€ç›´å¤„äºRegisteringçŠ¶æ€ï¼Œä¸èƒ½æ·»åŠ è¿›é›†ç¾¤ã€‚</p>
<p>åœ¨æ·»åŠ èŠ‚ç‚¹å¼‚å¸¸æ—¶ï¼Œå…ˆé€šè¿‡Webç®¡ç†ç•Œé¢åˆ é™¤é—®é¢˜èŠ‚ç‚¹ï¼Œç„¶ååœ¨é‡æ–°æ‰§è¡Œæ·»åŠ å‰ï¼Œé€šè¿‡ä»¥ä¸‹è„šæœ¬æ¸…ç†ä¸€ä¸‹å¾…æ·»åŠ èŠ‚ç‚¹çš„ç¯å¢ƒï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸…ç†å®‰è£…æ–‡ä»¶ç›®å½•</span></span><br><span class="line">DLIST=<span class="string">"/var/lib/etcd /etc/kubernetes /etc/cni /opt/cni /var/lib/cni /var/run/calico /opt/rke"</span></span><br><span class="line"><span class="keyword">for</span> dir <span class="keyword">in</span> <span class="variable">$DLIST</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"Removing <span class="variable">$dir</span>"</span></span><br><span class="line">  rm -rf <span class="variable">$dir</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ¸…ç†docker</span></span><br><span class="line">CLIST=$(docker ps -qa)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x"</span><span class="variable">$CLIST</span> == <span class="string">"x"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"No containers exist - skipping container cleanup"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  docker stop -f <span class="variable">$CLIST</span> &amp;&amp; docker rm -f <span class="variable">$CLIST</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">ILIST=$(docker images -a -q)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x"</span><span class="variable">$ILIST</span> == <span class="string">"x"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"No images exist - skipping image cleanup"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  docker rmi <span class="variable">$ILIST</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">VLIST=$(docker volume ls -q)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"x"</span><span class="variable">$VLIST</span> == <span class="string">"x"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"No volumes exist - skipping volume cleanup"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  docker volume rm -f <span class="variable">$VLIST</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">systemctl restart docker.service</span><br></pre></td></tr></table></figure>
<p>ä¸‹å›¾æ˜¯æ·»åŠ å®Œ3ä¸ªmasterå’Œ3ä¸ªnodeåçš„ä¸»æœºç•Œé¢ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551844009517.png" alt="1551844009517"></p>
<ul>
<li>éƒ¨ç½²æœåŠ¡</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551844649598.png" alt="1551844649598"></p>
<p>æµ‹è¯•éƒ¨ç½²5ä¸ªjenkinså®ä¾‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551856322207.png" alt="1551856322207"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551844947277.png" alt="1551844947277"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551845031997.png" alt="1551845031997"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551845141705.png" alt="1551845141705"></p>
<p>è®¿é—® Jenkinsï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551845268617.png" alt="1551845268617"></p>
<hr>
<ul>
<li>æ‰§è¡Œkubectlå‘½ä»¤è¡Œ</li>
</ul>
<p>é€šè¿‡Rancher Webç•Œé¢æ¥æ‰§è¡Œkubectlå‘½ä»¤è¡Œï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551845918415.png" alt="1551845918415"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551845411567.png" alt="1551845411567"></p>
<p>å¦‚æœç›´æ¥ç™»å½•ä¸»æœºï¼Œæ‰¾ä¸åˆ°kubectlå‘½ä»¤ï¼Œéœ€è¿›å…¥ç›¸å…³çš„å®¹å™¨</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551845747894.png" alt="1551845747894"></p>
<ul>
<li>æ·»åŠ Dashboard</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551846399730.png" alt="1551846399730"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551846438286.png" alt="1551846438286"></p>
<p>æ‰¾åˆ°kubernetes-dashboardï¼Œå¹¶éƒ¨ç½²ï¼ˆå¯åŠ¨ï¼‰</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551846551235.png" alt="1551846551235"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551846635456.png" alt="1551846635456"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rancher-k8s.assets/1551953637260.png" alt="1551953637260"></p>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>RKEå®‰è£…K8s HAé›†ç¾¤è¿‡ç¨‹è®°å½•</title>
    <url>/deployment/k8s/rke-k8s-ha/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>ansibleä¸»æœºæ¸…å•ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="section">[rke]</span></span><br><span class="line">rke ansible_host=192.168.100.228</span><br><span class="line"></span><br><span class="line"><span class="section">[k8s]</span></span><br><span class="line">master01 ansible_host=192.168.101.72</span><br><span class="line">master02 ansible_host=192.168.101.75</span><br><span class="line">master03 ansible_host=192.168.100.229</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>å®‰è£…dockerï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ansible-playbook roles/docker.yml</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨ansibleä¹‹å‰ï¼Œéœ€è¦åˆ†å‘å¯†é’¥è‡³å„èŠ‚ç‚¹rootç”¨æˆ·ã€‚</p>
<p>åˆ›å»ºrancherç”¨æˆ·ï¼Œå¹¶åˆ†å‘å¯†é’¥ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ansible-playbook roles/key.yml</span><br></pre></td></tr></table></figure>
<p>å®‰è£…rkeã€kubectlã€helmå·¥å…·ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://www.cnrancher.com/download/rke/rke_linux-amd64</span></span><br><span class="line">wget https://www.cnrancher.com/download/rke/rke_linux-amd64</span><br><span class="line">chmod +x rke_linux-amd64</span><br><span class="line">mv rke_linux-amd64 /usr/bin/rke</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.cnrancher.com/download/kubectl/kubectl_amd64-linux</span></span><br><span class="line">wget https://www.cnrancher.com/download/kubectl/kubectl_amd64-linux</span><br><span class="line">chmod +x kubectl_amd64-linux</span><br><span class="line">mv kubectl_amd64-linux /usr/bin/kubectl</span><br><span class="line"></span><br><span class="line"><span class="comment"># https://www.cnrancher.com/download/helm/helm-linux.tar.gz</span></span><br><span class="line">wget https://storage.googleapis.com/kubernetes-helm/helm-v2.12.0-linux-amd64.tar.gz</span><br><span class="line">tar -xf helm-v2.12.0-linux-amd64.tar.gz</span><br><span class="line">mv linux-amd64/helm /usr/bin/helm</span><br><span class="line">mv linux-amd64/tiller /usr/bin/tiller</span><br><span class="line">rm -rf linux-amd64</span><br></pre></td></tr></table></figure>
<h3 id="åˆ›å»ºé›†ç¾¤"><a href="#åˆ›å»ºé›†ç¾¤" class="headerlink" title="åˆ›å»ºé›†ç¾¤"></a>åˆ›å»ºé›†ç¾¤</h3><p>rancher-cluster.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.72</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,worker,etcd]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.101</span><span class="number">.75</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,worker,etcd]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.229</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,etcd]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">etcd:</span></span><br><span class="line">    <span class="attr">snapshot:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">creation:</span> <span class="string">6h</span></span><br><span class="line">    <span class="attr">retention:</span> <span class="string">24h</span></span><br></pre></td></tr></table></figure>
<p>rke up:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">rke up --config rancher-cluster.yml</span><br></pre></td></tr></table></figure>
<p>rke upåä¼šç”Ÿæˆkube_config_rancher-cluster.yml</p>
<p>è®¾ç½®kube_configç¯å¢ƒå˜é‡ï¼ˆæˆ–è€…å¤åˆ¶åˆ°~/.kube/config ï¼‰ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">"export KUBECONFIG=/home/rancher/kube_config_rancher-cluster.yml"</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…tiller"><a href="#å®‰è£…tiller" class="headerlink" title="å®‰è£…tiller"></a>å®‰è£…tiller</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Helmåœ¨é›†ç¾¤ä¸Šå®‰è£…tilleræœåŠ¡ä»¥ç®¡ç†charts. ç”±äºRKEé»˜è®¤å¯ç”¨RBAC, å› æ­¤æˆ‘ä»¬éœ€è¦ä½¿ç”¨kubectlæ¥åˆ›å»ºä¸€ä¸ªserviceaccountï¼Œclusterrolebindingæ‰èƒ½è®©tillerå…·æœ‰éƒ¨ç½²åˆ°é›†ç¾¤çš„æƒé™</span></span><br><span class="line"></span><br><span class="line">kubectl -n kube-system create serviceaccount tiller</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºClusterRoleBindingä»¥æˆäºˆtillerå¸æˆ·å¯¹é›†ç¾¤çš„è®¿é—®æƒé™</span></span><br><span class="line">kubectl create clusterrolebinding tiller --clusterrole cluster-admin --serviceaccount=kube-system:tiller</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£…Helm Server(Tiller)</span></span><br><span class="line">helm init --service-account tiller --tiller-image registry.cn-hangzhou.aliyuncs.com/google_containers/tiller:v2.12.0 --stable-repo-url https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…cert-manager"><a href="#å®‰è£…cert-manager" class="headerlink" title="å®‰è£…cert-manager"></a>å®‰è£…cert-manager</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">helm install stable/cert-manager \</span><br><span class="line">  --name cert-manager \</span><br><span class="line">  --namespace kube-system</span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…rancher-web"><a href="#å®‰è£…rancher-web" class="headerlink" title="å®‰è£…rancher web"></a>å®‰è£…rancher web</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ä½¿ç”¨helm repo addå‘½ä»¤æ·»åŠ Rancher chartä»“åº“åœ°å€</span></span><br><span class="line">helm repo add rancher-stable https://releases.rancher.com/server-charts/stable</span><br><span class="line"></span><br><span class="line">helm install rancher-stable/rancher \</span><br><span class="line">  --name rancher \</span><br><span class="line">  --namespace cattle-system \</span><br><span class="line">  --<span class="built_in">set</span> hostname=xxx.com</span><br><span class="line"></span><br><span class="line">helm install rancher-stable/rancher --name rancher --namespace cattle-system --<span class="built_in">set</span> hostname=xxx.com</span><br></pre></td></tr></table></figure>
<p>å¦‚æœä¸æ˜¯é€šè¿‡DNSè§£æåŸŸåï¼Œè€Œæ˜¯é€šè¿‡æœ¬åœ°hostsè§£æï¼Œå¯ä»¥é€šè¿‡ç»™cattle-cluster-agent Podå’Œcattle-node-agentæ·»åŠ ä¸»æœºåˆ«åï¼Œè®©å…¶å¯ä»¥æ­£å¸¸é€šä¿¡ï¼Œå‰ææ˜¯IPåœ°å€å¯ä»¥äº’é€šã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">kubectl -n cattle-system patch deployments cattle-cluster-agent --patch <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "spec": &#123;</span></span><br><span class="line"><span class="string">        "template": &#123;</span></span><br><span class="line"><span class="string">            "spec": &#123;</span></span><br><span class="line"><span class="string">                "hostAliases": [</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                        "hostnames":</span></span><br><span class="line"><span class="string">                        [</span></span><br><span class="line"><span class="string">                            "xxx.com"</span></span><br><span class="line"><span class="string">                        ],</span></span><br><span class="line"><span class="string">                            "ip": "192.168.100.228"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                ]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸Šé¢è¿™æ¡å‘½ä»¤å¯èƒ½æŠ¥é”™ï¼šError from server (NotFound): deployments.extensions "cattle-cluster-agent" not foundï¼Œå› ä¸ºcattle-cluster-agentè¿˜æ²¡æœ‰åˆ›å»ºæˆåŠŸ</span></span><br><span class="line"></span><br><span class="line">kubectl -n cattle-system patch daemonsets cattle-node-agent --patch <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "spec": &#123;</span></span><br><span class="line"><span class="string">        "template": &#123;</span></span><br><span class="line"><span class="string">            "spec": &#123;</span></span><br><span class="line"><span class="string">                "hostAliases": [</span></span><br><span class="line"><span class="string">                    &#123;</span></span><br><span class="line"><span class="string">                        "hostnames":</span></span><br><span class="line"><span class="string">                        [</span></span><br><span class="line"><span class="string">                            "xxx.com"</span></span><br><span class="line"><span class="string">                        ],</span></span><br><span class="line"><span class="string">                            "ip": "192.168.100.228"</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                ]</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h3 id="å®‰è£…rancher-cli"><a href="#å®‰è£…rancher-cli" class="headerlink" title="å®‰è£…rancher cli"></a>å®‰è£…rancher cli</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://www.cnrancher.com/download/cli/rancher-linux-amd64.tar.gz</span><br><span class="line">mkdir rancher-linux-amd64.tmp.d <span class="comment"># ä¸´æ—¶ç›®å½•</span></span><br><span class="line">tar -xf rancher-linux-amd64.tar.gz -C rancher-linux-amd64.tmp.d</span><br><span class="line">find rancher-linux-amd64.tmp.d -name <span class="string">'rancher'</span> -<span class="built_in">type</span> f | xargs -I &#123;&#125; mv &#123;&#125; /usr/bin/;</span><br><span class="line">rm -rf rancher-linux-amd64.tmp.d</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>K8s</category>
      </categories>
      <tags>
        <tag>K8s</tag>
      </tags>
  </entry>
  <entry>
    <title>Consul ACL</title>
    <url>/monitoring/consul/consul-acl/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h2 id="systemd-service"><a href="#systemd-service" class="headerlink" title="systemd service"></a>systemd service</h2><figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=consul agent</span><br><span class="line"><span class="attr">Requires</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">EnvironmentFile</span>=-/etc/sysconfig/consul</span><br><span class="line"><span class="attr">Environment</span>=GOMAXPROCS=<span class="number">2</span></span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/consul agent -config-dir=/opt/consul/conf -rejoin</span><br><span class="line"><span class="attr">ExecReload</span>=/bin/kill -HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attr">KillSignal</span>=SIGTERM</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<hr>
<h2 id="acl-json"><a href="#acl-json" class="headerlink" title="acl.json"></a>acl.json</h2><p>å¯ç”¨ACLï¼Œéœ€åœ¨é…ç½®åŠ è½½ç›®å½•ä¸‹æ·»åŠ aclé…ç½®æ–‡ä»¶</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"acl_datacenter"</span>: <span class="string">"dc1"</span>,</span><br><span class="line">  <span class="attr">"acl_master_token"</span>: <span class="string">"xxxxxxxxx"</span>,</span><br><span class="line">  <span class="attr">"acl_default_policy"</span>: <span class="string">"deny"</span>,</span><br><span class="line">  <span class="attr">"acl_down_policy"</span>: <span class="string">"extend-cache"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/consul-acl.assets/1562555213001.png" alt="1562555213001"></p>
<h2 id="deregitster"><a href="#deregitster" class="headerlink" title="deregitster"></a>deregitster</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl  -X PUT http://192.168.100.140:8500/v1/agent/service/deregister/&lt;id&gt; -H <span class="string">"X-Consul-Token:xxx"</span></span><br></pre></td></tr></table></figure>
<h2 id="register"><a href="#register" class="headerlink" title="register"></a>register</h2><ul>
<li>ä»…node check</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://10.1.100.57:8500/v1/agent/service/register -X PUT -i -H <span class="string">"Content-Type:application/json"</span> -H <span class="string">"X-Consul-Token:xxx"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">        "ID": "test.swms.api3",</span></span><br><span class="line"><span class="string">        "Name": "test-swms-api3",</span></span><br><span class="line"><span class="string">        "Tags": ["test", "swms"],</span></span><br><span class="line"><span class="string">        "Address": "192.168.101.35",</span></span><br><span class="line"><span class="string">        "Port": 9003,</span></span><br><span class="line"><span class="string">        "Meta": &#123;</span></span><br><span class="line"><span class="string">            "version": "1.0"</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">        "EnableTagOverride": false</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>node check + service check</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://10.1.100.57:8500/v1/agent/service/register -X PUT -i -H <span class="string">"Content-Type:application/json"</span> -H <span class="string">"X-Consul-Token:xxxxxxxxxxx"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"ID": "test.swms.api2",</span></span><br><span class="line"><span class="string">	"Name": "test-swms-api2",</span></span><br><span class="line"><span class="string">	"Tags": ["test", "swms"],</span></span><br><span class="line"><span class="string">	"Address": "192.168.101.35",</span></span><br><span class="line"><span class="string">	"Port": 9003,</span></span><br><span class="line"><span class="string">	"Check": &#123;</span></span><br><span class="line"><span class="string">		"DeregisterCriticalServiceAfter": "90m",</span></span><br><span class="line"><span class="string">		"Args": [],</span></span><br><span class="line"><span class="string">		"HTTP": "http://192.168.101.35:9003/hc",</span></span><br><span class="line"><span class="string">		"Interval": "15s"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"Meta": &#123;</span></span><br><span class="line"><span class="string">		"version": "1.0"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"EnableTagOverride": false</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p><em>Nameä¸èƒ½åŒ…å«å°æ•°ç‚¹</em></p>
<hr>
<h2 id="åˆ›å»ºä¸€ä¸ªagent-token"><a href="#åˆ›å»ºä¸€ä¸ªagent-token" class="headerlink" title="åˆ›å»ºä¸€ä¸ªagent token"></a>åˆ›å»ºä¸€ä¸ªagent token</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl \</span><br><span class="line">    --request PUT \</span><br><span class="line">    --header <span class="string">"X-Consul-Token: xxxxxxxxxxxxxxxx"</span> \</span><br><span class="line">    --data \</span><br><span class="line"><span class="string">'&#123;</span></span><br><span class="line"><span class="string">  "Name": "Agent Token",</span></span><br><span class="line"><span class="string">  "Type": "client",</span></span><br><span class="line"><span class="string">  "Rules": "node \"\" &#123; policy = \"write\" &#125; service \"\" &#123; policy = \"read\" &#125;"</span></span><br><span class="line"><span class="string">&#125;'</span> http://127.0.0.1:8500/v1/acl/create</span><br></pre></td></tr></table></figure>
<p>Type: client</p>
<p>WebUI tokençš„policyå¯ä»¥è®¾ç½®ä¸ºåªè¯»:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">service_prefix <span class="string">""</span> &#123;</span><br><span class="line">  policy = <span class="string">"read"</span></span><br><span class="line">  &#125;</span><br><span class="line">key_prefix <span class="string">""</span> &#123;</span><br><span class="line">  policy = <span class="string">"read"</span></span><br><span class="line">  &#125;</span><br><span class="line">node_prefix <span class="string">""</span> &#123;</span><br><span class="line">  policy = <span class="string">"read"</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<hr>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_4_centos ins_exporter]<span class="comment"># cat deReg.sh </span></span><br><span class="line">curl -i --request PUT \</span><br><span class="line">     --header <span class="string">"X-Consul-Token: xxxxxxxxxxxxxxxxxx"</span> \</span><br><span class="line">     http://10.1.100.57:8500/v1/agent/service/deregister/<span class="variable">$1</span></span><br><span class="line">     </span><br><span class="line">[root@VM_0_4_centos ins_exporter]<span class="comment"># sh deReg.sh id-xxl-vm04</span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Date: Sun, 07 Jul 2019 08:45:42 GMT</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line">[root@VM_0_4_centos ins_exporter]<span class="comment"># cat regXXL.sh </span></span><br><span class="line">curl http://10.1.100.57:8500/v1/agent/service/register -X PUT -i -H <span class="string">"Content-Type:application/json"</span> \</span><br><span class="line"> --header <span class="string">"X-Consul-Token: xxxxxxxxxxxxxxxxxx"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "ID": "id-xxl-vm04",</span></span><br><span class="line"><span class="string">    "Name": "xxl",</span></span><br><span class="line"><span class="string">    "Tags": ["xxl-job", "http"],</span></span><br><span class="line"><span class="string">    "Address": "192.168.100.150",</span></span><br><span class="line"><span class="string">    "Port": 9977,</span></span><br><span class="line"><span class="string">    "Check": &#123;</span></span><br><span class="line"><span class="string">        "DeregisterCriticalServiceAfter": "90m",</span></span><br><span class="line"><span class="string">        "HTTP": "http://baidu.com",</span></span><br><span class="line"><span class="string">        "Interval": "15s"</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "Meta": &#123;</span></span><br><span class="line"><span class="string">        "version": "1.0",</span></span><br><span class="line"><span class="string">        "type": "app",</span></span><br><span class="line"><span class="string">        "hostname": "vm03"</span></span><br><span class="line"><span class="string">    &#125;,</span></span><br><span class="line"><span class="string">    "EnableTagOverride": false</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">[root@VM_0_4_centos ins_exporter]<span class="comment"># sh regXXL.sh </span></span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Date: Sun, 07 Jul 2019 08:47:47 GMT</span><br><span class="line">Content-Length: 0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸å¸¦tokenè¢«ç¦æ­¢</span></span><br><span class="line">[root@VM_0_4_centos ins_exporter]<span class="comment"># curl -i -X PUT http://10.1.100.57:8500/v1/agent/service/deregister/id-xxl-vm04</span></span><br><span class="line">HTTP/1.1 403 Forbidden</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">Date: Sun, 07 Jul 2019 08:48:54 GMT</span><br><span class="line">Content-Length: 17</span><br><span class="line">Content-Type: text/plain; charset=utf-8</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Consul</category>
      </categories>
      <tags>
        <tag>Consul</tag>
      </tags>
  </entry>
  <entry>
    <title>Consul-template</title>
    <url>/monitoring/consul/consul-template/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<h2 id="å®‰è£…consul"><a href="#å®‰è£…consul" class="headerlink" title="å®‰è£…consul"></a>å®‰è£…consul</h2><p>è§ <a href="/monitoring/consul/my-nginx-consul">consul</a></p>
<h2 id="å®‰è£…consul-template"><a href="#å®‰è£…consul-template" class="headerlink" title="å®‰è£…consul-template"></a>å®‰è£…consul-template</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://releases.hashicorp.com/consul-template/0.20.0/consul-template_0.20.0_linux_amd64.tgz</span><br><span class="line">tar -xf consul-template_0.20.0_linux_amd64.tgz</span><br><span class="line">mv consul-template /usr/bin</span><br><span class="line">chmod a+x /usr/bin/consul-template</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="æ³¨å†ŒæœåŠ¡"><a href="#æ³¨å†ŒæœåŠ¡" class="headerlink" title="æ³¨å†ŒæœåŠ¡"></a>æ³¨å†ŒæœåŠ¡</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://192.168.100.140:8500/v1/agent/service/register -X PUT -i -H <span class="string">"Content-Type:application/json"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"ID": "test.zlz.01",</span></span><br><span class="line"><span class="string">	"Name": "test_zlz",</span></span><br><span class="line"><span class="string">	"Tags": ["zlz"],</span></span><br><span class="line"><span class="string">	"Address": "192.168.101.35",</span></span><br><span class="line"><span class="string">	"Port": 9003,</span></span><br><span class="line"><span class="string">	"Check": &#123;</span></span><br><span class="line"><span class="string">		"DeregisterCriticalServiceAfter": "90m",</span></span><br><span class="line"><span class="string">		"Args": [],</span></span><br><span class="line"><span class="string">		"HTTP": "http://192.168.101.35:9003/hc",</span></span><br><span class="line"><span class="string">		"Interval": "15s"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"Meta": &#123;</span></span><br><span class="line"><span class="string">		"version": "1.0"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"EnableTagOverride": false</span></span><br><span class="line"><span class="string">&#125;'</span></span><br><span class="line"></span><br><span class="line">curl http://192.168.100.140:8500/v1/agent/service/register -X PUT -i -H <span class="string">"Content-Type:application/json"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"ID": "test.zlz.02",</span></span><br><span class="line"><span class="string">	"Name": "test_zlz",</span></span><br><span class="line"><span class="string">	"Tags": ["zlz"],</span></span><br><span class="line"><span class="string">	"Address": "192.168.101.36",</span></span><br><span class="line"><span class="string">	"Port": 9003,</span></span><br><span class="line"><span class="string">	"Check": &#123;</span></span><br><span class="line"><span class="string">		"DeregisterCriticalServiceAfter": "90m",</span></span><br><span class="line"><span class="string">		"Args": [],</span></span><br><span class="line"><span class="string">		"HTTP": "http://192.168.101.36:9003/hc",</span></span><br><span class="line"><span class="string">		"Interval": "15s"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"Meta": &#123;</span></span><br><span class="line"><span class="string">		"version": "1.0"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"EnableTagOverride": false</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<h2 id="ç¼–å†™NginXé…ç½®æ¨¡æ¿"><a href="#ç¼–å†™NginXé…ç½®æ¨¡æ¿" class="headerlink" title="ç¼–å†™NginXé…ç½®æ¨¡æ¿"></a>ç¼–å†™NginXé…ç½®æ¨¡æ¿</h2><p>nginx.conf.ctmplï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">&#123;&#123;range services -&#125;&#125;</span><br><span class="line">&#123;&#123;$name := .Name&#125;&#125;</span><br><span class="line">&#123;&#123;$service := service .Name&#125;&#125;</span><br><span class="line">&#123;&#123;if in .Tags "zlz"&#125;&#125;</span><br><span class="line">upstream &#123;&#123;$name&#125;&#125; &#123;</span><br><span class="line">    &#123;&#123;range $service&#125;&#125;server &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125;;</span><br><span class="line">    &#123;&#123;end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;- range services -&#125;&#125;</span><br><span class="line">&#123;&#123;$name := .Name&#125;&#125;</span><br><span class="line">&#123;&#123;if in .Tags "zlz"&#125;&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name	xxx.xxx;</span><br><span class="line">    root	html;</span><br><span class="line">    index	index.html index.htm;</span><br><span class="line">    </span><br><span class="line">    access_log	/var/log/nginx/&#123;&#123;$name&#125;&#125;_access.log	main;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">    proxy_pass http://&#123;&#123;$name&#125;&#125;;</span><br><span class="line">    proxy_redirect		off;</span><br><span class="line">    proxy_set_header    Host        	$host;</span><br><span class="line">    proxy_set_header    X-Real-IP   	$remote_addr;</span><br><span class="line">    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    error_page  500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">    root	/usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ç¼–å†™consul-templateé…ç½®æ–‡ä»¶"><a href="#ç¼–å†™consul-templateé…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–å†™consul-templateé…ç½®æ–‡ä»¶"></a>ç¼–å†™consul-templateé…ç½®æ–‡ä»¶</h2><p>nginx.hclï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">consul &#123;</span><br><span class="line">    address = "192.168.100.150:8500"</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">template &#123;</span><br><span class="line">    source = "nginx.conf.ctmpl"</span><br><span class="line">    destination = "/etc/nginx/conf.d/default.conf"</span><br><span class="line">    command = "service nginx reload"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•consul-template"><a href="#æµ‹è¯•consul-template" class="headerlink" title="æµ‹è¯•consul-template"></a>æµ‹è¯•consul-template</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">consul-template -config nginx.hcl <span class="comment"># ä¼šç”Ÿæˆ/etc/nginx/conf.d/default.conf</span></span><br><span class="line"><span class="comment"># [control] + c</span></span><br></pre></td></tr></table></figure>
<h2 id="æµ‹è¯•è‡ªåŠ¨æ›´æ–°NginXé…ç½®"><a href="#æµ‹è¯•è‡ªåŠ¨æ›´æ–°NginXé…ç½®" class="headerlink" title="æµ‹è¯•è‡ªåŠ¨æ›´æ–°NginXé…ç½®"></a>æµ‹è¯•è‡ªåŠ¨æ›´æ–°NginXé…ç½®</h2><ol>
<li>è¿è¡Œconsul-templateæœåŠ¡</li>
</ol>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nohup consul-template -config nginx.hcl &gt;/var/<span class="built_in">log</span>/consul-template.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>æ¨¡æ‹Ÿå¥åº·çŠ¶æ€å¼‚å¸¸æ—¶è‡ªåŠ¨æ›´æ–°NginXé…ç½®</p>
<p>æ¯”å¦‚ï¼Œä¿®æ”¹<code>&quot;HTTP&quot;: &quot;http://192.168.101.35:9003/hc&quot;</code>ä¸º<code>&quot;HTTP&quot;: &quot;http://192.168.101.35:9003/hcc&quot;</code>ï¼Œé‡æ–°æ³¨å†Œè¯¥æœåŠ¡åtest.zlz.01çš„æœåŠ¡å¥åº·çŠ¶æ€å˜ä¸ºä¸æ­£å¸¸ã€‚consul-templateèƒ½è‡ªåŠ¨æ£€æµ‹åˆ°å¼‚å¸¸ï¼Œå¹¶é‡æ–°ç”Ÿæˆ/etc/nginx/conf.d/default.confã€‚</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Consul</category>
      </categories>
      <tags>
        <tag>Consul</tag>
      </tags>
  </entry>
  <entry>
    <title>Consulä»‹ç»</title>
    <url>/monitoring/consul/consul/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p><a href="https://www.consul.io/docs/internals/architecture.html" rel="external nofollow noopener noreferrer" target="_blank"><strong>Consul</strong></a> æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœåŠ¡å‘ç°ä¸é…ç½®çš„å·¥å…·ã€‚ä¸å…¶ä»–åˆ†å¸ƒå¼æœåŠ¡æ³¨å†Œä¸å‘ç°çš„æ–¹æ¡ˆï¼ŒConsulçš„æ–¹æ¡ˆæ›´â€œä¸€ç«™å¼â€ï¼Œå†…ç½®äº†æœåŠ¡æ³¨å†Œä¸å‘ç°æ¡†æ¶ã€åˆ†å¸ƒä¸€è‡´æ€§åè®®å®ç°ï¼ˆä¸éœ€è¦ZooKeeperï¼‰ã€å¥åº·æ£€æŸ¥ã€K/Vå­˜å‚¨ã€å¤šæ•°æ®ä¸­å¿ƒæ–¹æ¡ˆã€‚</p>
</blockquote>
<a id="more"></a>
<p><img src="https://www.consul.io/assets/images/consul-arch-420ce04a.png" alt="Consul Architecture"></p>
<ul>
<li>æ³¨å†ŒæœåŠ¡ï¼ˆRegister Serviceï¼‰</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://&lt;your-consul-url&gt;/v1/agent/service/register -X PUT -i -H <span class="string">"Content-Type:application/json"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">    "Name": "test-name", </span></span><br><span class="line"><span class="string">    "Tags": [</span></span><br><span class="line"><span class="string">        "test-tag"</span></span><br><span class="line"><span class="string">    ], </span></span><br><span class="line"><span class="string">    "EnableTagOverride": false, </span></span><br><span class="line"><span class="string">    "ID": "test-id", </span></span><br><span class="line"><span class="string">    "Meta": &#123;"version": "1.0"&#125;, </span></span><br><span class="line"><span class="string">    "Address": "192.168.100.150", </span></span><br><span class="line"><span class="string">    "Port": 8080, </span></span><br><span class="line"><span class="string">    "Check": &#123;</span></span><br><span class="line"><span class="string">        "DeregisterCriticalServiceAfter": "90m", </span></span><br><span class="line"><span class="string">        "Args": [], </span></span><br><span class="line"><span class="string">        "HTTP": "http://192.168.100.150:8080/", </span></span><br><span class="line"><span class="string">        "Interval": "15s"</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>æ³¨é”€æœåŠ¡ï¼ˆDeregister Serviceï¼‰</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl -X PUT http://&lt;your-consul-url&gt;/v1/agent/service/deregister/<span class="built_in">test</span>-id</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Consul</category>
      </categories>
      <tags>
        <tag>Consul</tag>
      </tags>
  </entry>
  <entry>
    <title>æ„å»ºnginx-consul-template</title>
    <url>/monitoring/consul/my-nginx-consul/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">|-- docker-compose.yml</span><br><span class="line">|-- Dockerfile</span><br><span class="line">|-- files</span><br><span class="line">|   |-- consul-template_0.20.0_linux_amd64.zip</span><br><span class="line">|   |-- nginx.conf</span><br><span class="line">|   |-- nginx.conf.ctmpl</span><br><span class="line">|   `-- nginx.sh</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<p>Dockerfile:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FROM nginx:alpine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># RUN apk update &amp;&amp; \</span></span><br><span class="line">RUN apk add --no-cache unzip</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ENV CONSUL_TEMPLATE_VERSION 0.20.0</span><br><span class="line">ENV PACKAGE consul-template_0.20.0_linux_amd64.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># ADD https://releases.hashicorp.com/consul-template/$&#123;CONSUL_TEMPLATE_VERSION&#125;/consul-template_$&#123;CONSUL_TEMPLATE_VERSION&#125;_linux_amd64.zip /tmp/consul-template.zip</span></span><br><span class="line"></span><br><span class="line">ADD files/nginx.conf files/nginx.conf.ctmpl files/nginx.sh files/<span class="variable">$&#123;PACKAGE&#125;</span> /etc/nginx/</span><br><span class="line"></span><br><span class="line">RUN unzip /etc/nginx/<span class="variable">$&#123;PACKAGE&#125;</span> -d /usr/bin &amp;&amp; \</span><br><span class="line">    chmod +x /usr/bin/consul-template &amp;&amp; \</span><br><span class="line">    rm -f /etc/nginx/<span class="variable">$&#123;PACKAGE&#125;</span> &amp;&amp; \</span><br><span class="line">    chmod +x /etc/nginx/nginx.sh &amp;&amp; \</span><br><span class="line">    apk del unzip</span><br><span class="line"></span><br><span class="line">WORKDIR /etc/nginx</span><br><span class="line"></span><br><span class="line">ENTRYPOINT [<span class="string">"/usr/bin/consul-template"</span>]</span><br></pre></td></tr></table></figure>
<p>nginx.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> nginx -t &gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [ -s /var/run/nginx.pid ]; <span class="keyword">then</span></span><br><span class="line">        nginx -s reload</span><br><span class="line">        <span class="keyword">if</span> [ $? != 0 ]; <span class="keyword">then</span></span><br><span class="line">            rm -f /var/run/nginx.pid</span><br><span class="line">            nginx -c /etc/nginx/nginx.conf</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        nginx -c /etc/nginx/nginx.conf</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹nginx.conf:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">http &#123;</span><br><span class="line">	server_names_hash_bucket_size 128;</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<p>nginx.conf.ctmpl:</p>
<p>å«httpæ ‡ç­¾çš„ä¼šè¢«é€‰æ‹©</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;range services&#125;&#125;</span><br><span class="line">&#123;&#123;$name := .Name&#125;&#125;</span><br><span class="line">&#123;&#123;$service := service .Name&#125;&#125;</span><br><span class="line">&#123;&#123;if in .Tags &quot;http&quot;&#125;&#125;</span><br><span class="line">upstream &#123;&#123;$name&#125;&#125; &#123;</span><br><span class="line">    &#123;&#123;range $service&#125;&#125;server &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125;;</span><br><span class="line">    &#123;&#123;end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;range services&#125;&#125;</span><br><span class="line">&#123;&#123;$name := .Name&#125;&#125;</span><br><span class="line">&#123;&#123;if in .Tags &quot;http&quot;&#125;&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name &#123;&#123;$name&#125;&#125;.&#123;&#123;env &quot;HOST_TYPE&quot;&#125;&#125;.keep.com;</span><br><span class="line">    server_name &#123;&#123;$name&#125;&#125;.keep.com;</span><br><span class="line">    root    html;</span><br><span class="line">    index    index.html index.htm;</span><br><span class="line">    </span><br><span class="line">    access_log    /var/log/nginx/&#123;&#123;$name&#125;&#125;_access.log    main;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://&#123;&#123;$name&#125;&#125;;</span><br><span class="line">        proxy_redirect      off;</span><br><span class="line">        proxy_set_header    Host            $host;</span><br><span class="line">        proxy_set_header    X-Real-IP       $remote_addr;</span><br><span class="line">        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    error_page  500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">        root    /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>docker-compose.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SERVICE_8500_NAME:</span> <span class="string">consul</span></span><br><span class="line">      <span class="attr">SERVICE_8500_TAGS:</span> <span class="string">"consul,http"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8400</span><span class="string">:8400</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8500</span><span class="string">:8500</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8600</span><span class="string">:53/udp</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-client=0.0.0.0</span> <span class="string">-dev</span> <span class="string">-node=node0</span> <span class="string">-bootstrap-expect=1</span> <span class="string">-data-dir=/tmp/consul</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">registrator:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gliderlabs/registrator</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/tmp/docker.sock</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-internal</span> <span class="string">consul://consul:8500</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx-consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">my-nginx-consul:alpine</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">registrator</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./files/nginx.conf.ctmpl:/etc/nginx/nginx.conf.ctmpl</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">HOST_TYPE:</span> <span class="string">$&#123;HOST_TYPE&#125;</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-consul-addr=consul:8500</span> <span class="string">-wait=3s</span> <span class="string">-template</span> <span class="string">/etc/nginx/nginx.conf.ctmpl:/etc/nginx/conf.d/app.conf:/etc/nginx/nginx.sh</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Consul</category>
      </categories>
      <tags>
        <tag>Consul</tag>
      </tags>
  </entry>
  <entry>
    <title>åŸºäºNginX + Consul + Registrator + Consul-Templateè‡ªåŠ¨æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</title>
    <url>/monitoring/consul/nginx-consul-registrator/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>é€šè¿‡Dockerï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å°†Consulã€Consul Templateã€Registratorå’ŒNginxç»„è£…æˆä¸€ä¸ªå¯æ‰©å±•çš„ã€é«˜è´¨é‡ã€é«˜å¯ç”¨çš„æœåŠ¡æ¶æ„ä½“ç³»ï¼Œåœ¨æ·»åŠ å’Œç§»é™¤æœåŠ¡æ—¶ä¸éœ€è¦é‡å†™ä»»ä½•é…ç½®ï¼Œä¹Ÿä¸éœ€è¦é‡å¯ä»»ä½•æœåŠ¡ï¼Œä»è€Œé™ä½è¿ç»´æˆæœ¬ã€‚</p>
</blockquote>
<a id="more"></a>
<h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>01.</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1556875370359.png" alt="1556875370359"></p>
<p>02.</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/1556875405475.png" alt="1556875405475"></p>
<hr>
<h3 id="Configure-files"><a href="#Configure-files" class="headerlink" title="Configure files"></a>Configure files</h3><p>docker-compose.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'2'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8400</span><span class="string">:8400</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8500</span><span class="string">:8500</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8600</span><span class="string">:53/udp</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">agent</span> <span class="string">-server</span> <span class="string">-client=0.0.0.0</span> <span class="string">-dev</span> <span class="string">-node=node0</span> <span class="string">-bootstrap-expect=1</span> <span class="string">-data-dir=/tmp/consul</span></span><br><span class="line">    <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">SERVICE_IGNORE:</span> <span class="string">'true'</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">registrator:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">gliderlabs/registrator</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/tmp/docker.sock</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line"><span class="comment">#    command: -internal consul://consul:8500 # err</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-internal</span> <span class="string">consul://127.0.0.1:8500</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">nginx-consul:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx-consul:v0.3.2</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">consul</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">registrator</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">-consul-addr=127.0.0.1:8500</span> <span class="string">-wait=5s</span> <span class="string">-template</span> <span class="string">/etc/nginx/nginx.conf.ctmpl:/etc/nginx/conf.d/app.conf:/etc/nginx/nginx.sh</span></span><br></pre></td></tr></table></figure>
<p>nginx-consul-template Dockerfile:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">FROM nginx</span><br><span class="line"> </span><br><span class="line">RUN apt-get update &amp;&amp; \</span><br><span class="line">    apt-get install --no-install-recommends --no-install-suggests -y unzip &amp;&amp; \</span><br><span class="line">    rm -r /var/lib/apt/lists/*</span><br><span class="line"></span><br><span class="line">ENV CONSUL_TEMPLATE_VERSION 0.20.0</span><br><span class="line"></span><br><span class="line">ADD https://releases.hashicorp.com/consul-template/<span class="variable">$&#123;CONSUL_TEMPLATE_VERSION&#125;</span>/consul-template_<span class="variable">$&#123;CONSUL_TEMPLATE_VERSION&#125;</span>_linux_amd64.zip /tmp/consul-template.zip</span><br><span class="line"></span><br><span class="line">ADD nginx.conf.ctmpl nginx.sh /etc/nginx/</span><br><span class="line"></span><br><span class="line">RUN unzip /tmp/consul-template.zip -d /usr/bin &amp;&amp; \</span><br><span class="line">    chmod +x /usr/bin/consul-template &amp;&amp; \</span><br><span class="line">    rm -f /tmp/consul-template.zip &amp;&amp; \</span><br><span class="line">    chmod +x /etc/nginx/nginx.sh</span><br><span class="line"></span><br><span class="line">WORKDIR /etc/nginx</span><br><span class="line"><span class="comment"># CMD ["nginx", "-g", "daemon off;", "&amp;"]</span></span><br><span class="line">ENTRYPOINT [<span class="string">"/usr/bin/consul-template"</span>]</span><br></pre></td></tr></table></figure>
<p>nginx configure template:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;&#123;range services&#125;&#125;</span><br><span class="line">&#123;&#123;$name := .Name&#125;&#125;</span><br><span class="line">&#123;&#123;$service := service .Name&#125;&#125;</span><br><span class="line">&#123;&#123;if in .Tags &quot;http&quot;&#125;&#125;</span><br><span class="line">upstream &#123;&#123;$name&#125;&#125; &#123;</span><br><span class="line">    &#123;&#123;range $service&#125;&#125;server &#123;&#123;.Address&#125;&#125;:&#123;&#123;.Port&#125;&#125;;</span><br><span class="line">    &#123;&#123;end&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;range services&#125;&#125;</span><br><span class="line">&#123;&#123;$name := .Name&#125;&#125;</span><br><span class="line">&#123;&#123;if in .Tags &quot;http&quot;&#125;&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name	&#123;&#123;$name&#125;&#125;.xxx.com;</span><br><span class="line">    root	html;</span><br><span class="line">    index	index.html index.htm;</span><br><span class="line">    </span><br><span class="line">    access_log	/var/log/nginx/&#123;&#123;$name&#125;&#125;_access.log	main;</span><br><span class="line">    </span><br><span class="line">    location / &#123;</span><br><span class="line">    proxy_pass http://&#123;&#123;$name&#125;&#125;;</span><br><span class="line">    proxy_redirect		off;</span><br><span class="line">    proxy_set_header    Host        	$host;</span><br><span class="line">    proxy_set_header    X-Real-IP   	$remote_addr;</span><br><span class="line">    proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    error_page  500 502 503 504 /50x.html;</span><br><span class="line">    location = /50x.html &#123;</span><br><span class="line">    root	/usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>nginx.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> nginx -t&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">if</span> [[ -s /var/run/nginx.pid ]]; <span class="keyword">then</span></span><br><span class="line">        nginx -s reload</span><br><span class="line">        <span class="keyword">if</span> [[ $? != 0 ]]; <span class="keyword">then</span></span><br><span class="line">            rm -f /var/run/nginx.pid</span><br><span class="line">            nginx -c /etc/nginx/nginx.conf</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        nginx -c /etc/nginx/nginx.conf</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p>pma docker-compose.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">pma:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">phpmyadmin/phpmyadmin:4.7.3-1</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SERVICE_NAME:</span> <span class="string">pma01</span></span><br><span class="line">      <span class="attr">SERVICE_TAGS:</span> <span class="string">"http,phpmyadmin"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<hr>
<h3 id="How-to-test"><a href="#How-to-test" class="headerlink" title="How to test"></a>How to test</h3><ul>
<li>run pma</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br><span class="line">docker-compose scale pma=3</span><br><span class="line">docker-compose scale pma=1</span><br></pre></td></tr></table></figure>
<ul>
<li>start nginx-consul</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Consul</category>
      </categories>
      <tags>
        <tag>Docker</tag>
        <tag>Consul</tag>
      </tags>
  </entry>
  <entry>
    <title>Alertmanagerä»‹ç»</title>
    <url>/monitoring/prometheus/alertmanager/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/alertmanager.assets/prometheus-alert-artich.png" alt="img"></p>
<a id="more"></a>
<blockquote>
<p> Alertmanagerä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œè´Ÿè´£æ¥æ”¶å¹¶å¤„ç†æ¥è‡ªPrometheus Server(ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒçš„å®¢æˆ·ç«¯ç¨‹åº)çš„å‘Šè­¦ä¿¡æ¯ã€‚Alertmanagerå¯ä»¥å¯¹è¿™äº›å‘Šè­¦ä¿¡æ¯è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œæ¯”å¦‚å½“æ¥æ”¶åˆ°å¤§é‡é‡å¤å‘Šè­¦æ—¶èƒ½å¤Ÿæ¶ˆé™¤é‡å¤çš„å‘Šè­¦ä¿¡æ¯ï¼ŒåŒæ—¶å¯¹å‘Šè­¦ä¿¡æ¯è¿›è¡Œåˆ†ç»„å¹¶ä¸”è·¯ç”±åˆ°æ­£ç¡®çš„é€šçŸ¥æ–¹ï¼ŒPrometheuså†…ç½®äº†å¯¹é‚®ä»¶ï¼ŒSlackç­‰å¤šç§é€šçŸ¥æ–¹å¼çš„æ”¯æŒï¼ŒåŒæ—¶è¿˜æ”¯æŒä¸Webhookçš„é›†æˆï¼Œä»¥æ”¯æŒæ›´å¤šå®šåˆ¶åŒ–çš„åœºæ™¯ã€‚</p>
</blockquote>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Grafanaä½¿ç”¨è®°å½•</title>
    <url>/monitoring/prometheus/grafana-intro/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>ç³»ç»Ÿï¼šCentOS 7.5</p>
<p>è½¯ä»¶ç‰ˆæœ¬ï¼šé€šè¿‡dockerå®‰è£…æœ€æ–°ç‰ˆæœ¬</p>
</blockquote>
<a id="more"></a>
<h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>å®˜ç½‘ï¼š<a href="https://grafana.com/grafana" rel="external nofollow noopener noreferrer" target="_blank">https://grafana.com/grafana</a></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552441557000.png" alt="1552441557000"></p>
<blockquote>
<p>Grafanaæ˜¯ä¸€ä¸ªè·¨å¹³å°ã€å¼€æºçš„æŒ‡æ ‡åº¦é‡åˆ†æå’Œå¯è§†åŒ–å·¥å…·ï¼Œæä¾›äº†å¼ºå¤§å’Œä¼˜é›…çš„æ–¹å¼å»åˆ›å»ºã€å…±äº«ã€æµè§ˆæ•°æ®ã€‚Grafanaéå¸¸é€‚äºå’Œæ—¶é—´åºåˆ—æ•°æ®åº“ç»“åˆå±•ç¤ºæ•°æ®ï¼Œå¦‚<a href="http://docs.grafana.org/features/datasources/graphite/" rel="external nofollow noopener noreferrer" target="_blank">Graphite</a>, <a href="http://docs.grafana.org/features/datasources/influxdb/" rel="external nofollow noopener noreferrer" target="_blank">InfluxDB</a>, <a href="http://docs.grafana.org/features/datasources/opentsdb/" rel="external nofollow noopener noreferrer" target="_blank">OpenTSDB</a>, <a href="http://docs.grafana.org/features/datasources/prometheus/" rel="external nofollow noopener noreferrer" target="_blank">Prometheus</a>ã€‚</p>
</blockquote>
<hr>
<h3 id="å¿«é€Ÿå®‰è£…"><a href="#å¿«é€Ÿå®‰è£…" class="headerlink" title="å¿«é€Ÿå®‰è£…"></a>å¿«é€Ÿå®‰è£…</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–é•œåƒ</span></span><br><span class="line">docker pull grafana/grafana</span><br><span class="line"><span class="comment"># è¿è¡Œgrafanaï¼ˆadminç™»å½•å¯†ç ä¸ºadminï¼‰</span></span><br><span class="line">docker run -d -i -p 3000:3000 \</span><br><span class="line">-e <span class="string">"GF_SERVER_ROOT_URL=http://grafana.server.name"</span> \</span><br><span class="line">-e <span class="string">"GF_SECURITY_ADMIN_PASSWORD=admin"</span> \</span><br><span class="line">--net=host \</span><br><span class="line">grafana/grafana</span><br></pre></td></tr></table></figure>
<p>åœ¨192.168.100.150ä¸Šæ‰§è¡Œï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®ï¼š<a href="http://192.168.100.150:3000" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:3000</a>ï¼Œä»¥admin/adminç™»å½•</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552443573409.png" alt="1552443573409"></p>
<p>é¦–é¡µ</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552443615287.png" alt="1552443615287"></p>
<p>å¯ä»¥çœ‹åˆ°åªæœ‰Install Grafanaæ˜¯å·²å®ŒæˆçŠ¶æ€ï¼Œå¾…æ·»åŠ æ•°æ®æºã€åˆ›å»ºä»ªè¡¨ç›˜ã€æ·»åŠ ç”¨æˆ·ã€å®‰è£…æ’ä»¶ç­‰ã€‚</p>
<p><em>å®˜ç½‘å®‰è£…æŒ‡å¯¼ï¼š&lt;<a href="http://docs.grafana.org/installation/docker/" rel="external nofollow noopener noreferrer" target="_blank">http://docs.grafana.org/installation/docker/</a></em>&gt;</p>
<hr>
<h3 id="åˆ›å»ºä¸€ä¸ªDashboard"><a href="#åˆ›å»ºä¸€ä¸ªDashboard" class="headerlink" title="åˆ›å»ºä¸€ä¸ªDashboard"></a>åˆ›å»ºä¸€ä¸ªDashboard</h3><p>å…ˆä¸ç®¡Add data sourceè¿™ä¸€æ­¥ï¼Œç›´æ¥æ¥å°è¯•åˆ›å»ºä¸€ä¸ªDashboardã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552444239771.png" alt="1552444239771"></p>
<ul>
<li><p>ä¿®æ”¹æ•°æ®æº</p>
<p>defaultæ˜¯grafanaæä¾›çš„é»˜è®¤æ•°æ®æºï¼Œä½œæ¼”ç¤ºç”¨æ²¡æœ‰å®é™…æ„ä¹‰ã€‚Aç³»åˆ—æ˜¯éšæœºäº§ç”Ÿçš„æ•°æ®ã€‚</p>
</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552444301113.png" alt="1552444301113"></p>
<ul>
<li><p>ä¿®æ”¹å›¾è¡¨æ ·å¼</p>
<p>å¯ä»¥åœ¨æ­¤é¡µç­¾å†…è®¾ç½®å›¾è¡¨ç±»å‹ã€çº¿å‹ã€é˜´å½±ã€æ˜¾ç¤ºçš„ç³»åˆ—ç­‰ã€‚</p>
</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552444564588.png" alt="1552444564588"></p>
<ul>
<li><p>ä¿®æ”¹é€šç”¨è®¾ç½®</p>
<p>å›¾è¡¨æ ‡é¢˜ã€æè¿°ä¿¡æ¯ç­‰ã€‚</p>
</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552444799208.png" alt="1552444799208"></p>
<ul>
<li><p>ä¿å­˜bashboard</p>
<p>è°ƒæ•´å›¾è¡¨å®½é«˜ï¼Œä¿å­˜è‡ªå®šä¹‰çš„dashboardã€‚</p>
</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552445155699.png" alt="1552445155699"></p>
<hr>
<h3 id="å¯¹æ¥Zabbix"><a href="#å¯¹æ¥Zabbix" class="headerlink" title="å¯¹æ¥Zabbix"></a>å¯¹æ¥Zabbix</h3><p>Grafanaæ²¡æœ‰é¢„è£…zabbixæ•°æ®æºæ’ä»¶ã€‚å®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<p>ç‚¹å‡»Install app &amp; plugins ä¼šè·³è½¬åˆ°<a href="https://grafana.com/plugins" rel="external nofollow noopener noreferrer" target="_blank">https://grafana.com/plugins</a>ï¼Œé€‰æ‹©zabbixã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552445518931.png" alt="1552445518931"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552445618451.png" alt="1552445618451"></p>
<p>ç”±äºæ˜¯é€šè¿‡å®¹å™¨è¿è¡Œgrafanaçš„ï¼Œéœ€è¿›å…¥å®¹å™¨æ‰§è¡Œæ’ä»¶å®‰è£…ã€‚</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºå®¹å™¨</span></span><br><span class="line">docker ps -a</span><br><span class="line"><span class="comment"># è¿›å…¥grafanaçš„å®¹å™¨</span></span><br><span class="line">docker <span class="built_in">exec</span> -it &lt;id&gt; bash</span><br><span class="line"></span><br><span class="line"><span class="comment">## grafanaå®¹å™¨å†…</span></span><br><span class="line"><span class="comment"># å®‰è£…grafanaçš„zabbixæ’ä»¶</span></span><br><span class="line">grafana-cli plugins install alexanderzobnin-zabbix-app</span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯å®¹å™¨ï¼Œç„¶ååˆ·æ–°æµè§ˆå™¨é¡µé¢</span></span><br><span class="line">docker restart &lt;id&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552446272259.png" alt="1552446272259"></p>
<p>é‡å¯å®¹å™¨ååˆ·æ–°æµè§ˆå™¨ï¼Œå¯ä»¥çœ‹åˆ°zabbixæ’ä»¶å·²å®‰è£…ï¼Œå¹¶å¯ç”¨ä¹‹ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552446449534.png" alt="1552446449534"></p>
<p>æ·»åŠ zabbixæ•°æ®æº</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552447021271.png" alt="1552447021271"></p>
<p>è¦ä»zabbixå¹³å°<a href="http://192.168.100.69/zabbix" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.69/zabbix</a>è·å–æ•°æ®ï¼ŒURLå¡«<a href="http://192.168.100.69/zabbix/api_jsonrpc.php" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.69/zabbix/api_jsonrpc.php</a>ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552447231301.png" alt="1552447231301"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552447361551.png" alt="1552447361551"></p>
<p>ä¿å­˜åï¼Œåˆ‡æ¢åˆ°Dashboardsé¡µç­¾ï¼Œå¯¼å…¥ç›¸å…³çš„zabbixæ’ä»¶æä¾›çš„dashboardã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552447689701.png" alt="1552447689701"></p>
<p>å›åˆ°Homeï¼ŒæŸ¥çœ‹å·²æœ‰çš„dashboardã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552447734573.png" alt="1552447734573"></p>
<p>æŸ¥çœ‹zabbixç›‘æ§æ•°æ®åœ¨grafanaä¸Šçš„å±•ç¤ºæ•ˆæœã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552447856369.png" alt="1552447856369"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/grafana-intro.assets/1552447922398.png" alt="1552447922398"></p>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
        <tag>Grafana</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDBç›‘æ§æ¥å…¥</title>
    <url>/monitoring/prometheus/monitoring-mongodb/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>Percona Monitoring and Management (PMM)æ˜¯ä¸€æ¬¾å¼€æºçš„MySQLã€MongoDBæ€§èƒ½ç›‘æ§å·¥å…·ï¼ŒPMMå®¢æˆ·ç«¯è´Ÿè´£æ”¶é›†DBç›‘æ§æ•°æ®ï¼ŒPMMæœåŠ¡ç«¯ä»å·²è¿æ¥çš„å®¢æˆ·ç«¯æ‹‰å–æ•°æ®ï¼Œå¹¶é€šè¿‡ç¬¬ä¸‰æ–¹è½¯ä»¶Grafanaå±•ç¤ºå›¾è¡¨ã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="å®‰è£…pmm-client"><a href="#å®‰è£…pmm-client" class="headerlink" title="å®‰è£…pmm-client"></a>å®‰è£…pmm-client</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…pmm-client</span></span><br><span class="line">yum install https://www.percona.com/downloads/pmm/1.1.1/binary/redhat/7/x86_64/pmm-client-1.1.1-1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h2 id="é…ç½®æœåŠ¡ç«¯"><a href="#é…ç½®æœåŠ¡ç«¯" class="headerlink" title="é…ç½®æœåŠ¡ç«¯"></a>é…ç½®æœåŠ¡ç«¯</h2><p>ç›®å‰ç»Ÿä¸€ç”±PMMæœåŠ¡ç«¯<strong>10.1.100.200</strong>ç®¡ç†æ•°æ®åº“ç›‘æ§ä»»åŠ¡ã€‚</p>
<p>åœ¨mysqlç«¯æ‰§è¡Œï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pmm-admin config --server 10.1.100.200 --<span class="built_in">bind</span>-address=&lt;å½“å‰mysqlå®ä¾‹IPåœ°å€&gt; --client-address=&lt;å½“å‰mysqlå®ä¾‹IPåœ°å€&gt; --client-name=&lt;è‡ªå®šä¹‰å®¢æˆ·ç«¯åç§°&gt;</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pmm-admin config --server 10.1.100.200 --<span class="built_in">bind</span>-address=10.1.7.211 --client-address=10.1.7.211 --client-name=Dev</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œåä¼šä¿å­˜åˆ°æ–‡ä»¶<code>/usr/local/percona/pmm-client/pmm.yml</code>ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@b68-docker-prd pmm]<span class="comment"># cat /usr/local/percona/pmm-client/pmm.yml</span></span><br><span class="line">server_address: 10.1.100.200</span><br><span class="line">client_address: 10.1.7.211</span><br><span class="line">bind_address: 10.1.7.211</span><br><span class="line">client_name: Dev</span><br></pre></td></tr></table></figure>
<h2 id="æ·»åŠ mongodb"><a href="#æ·»åŠ mongodb" class="headerlink" title="æ·»åŠ mongodb"></a>æ·»åŠ mongodb</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@docker-dev pmm]<span class="comment"># pmm-admin add mongodb --help</span></span><br><span class="line">Usage:</span><br><span class="line">  pmm-admin add mongodb [name] [flags]</span><br><span class="line"></span><br><span class="line">Examples:</span><br><span class="line">  pmm-admin add mongodb</span><br><span class="line">  pmm-admin add mongodb --cluster bare-metal</span><br><span class="line">Flags:</span><br><span class="line">      --cluster string   cluster name</span><br><span class="line">      --uri string       MongoDB URI, format: [mongodb://][user:pass@]host[:port][/database][?options] (default <span class="string">"localhost:27017"</span>)</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pmm-admin add mongodb --cluster rs1 --uri mongodb://10.1.7.211:27017 mongodb-dev</span><br></pre></td></tr></table></figure>
<h2 id="æŸ¥çœ‹é…ç½®"><a href="#æŸ¥çœ‹é…ç½®" class="headerlink" title="æŸ¥çœ‹é…ç½®"></a>æŸ¥çœ‹é…ç½®</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@docker-dev pmm]<span class="comment"># pmm-admin list</span></span><br><span class="line">pmm-admin 1.1.1</span><br><span class="line"></span><br><span class="line">PMM Server      | 10.1.100.200 </span><br><span class="line">Client Name     | Dev</span><br><span class="line">Client Address  | 10.1.7.211 </span><br><span class="line">Service Manager | linux-systemd</span><br><span class="line"></span><br><span class="line">---------------- ---------------- ----------- -------- ------------------------------ ------------------------</span><br><span class="line">SERVICE TYPE     NAME             LOCAL PORT  RUNNING  DATA SOURCE                    OPTIONS                 </span><br><span class="line">---------------- ---------------- ----------- -------- ------------------------------ ------------------------</span><br><span class="line">...                         </span><br><span class="line">mongodb:metrics  mongodb-dev      42003       YES      10.1.7.211:27017               cluster=rs1</span><br></pre></td></tr></table></figure>
<h2 id="å›¾è¡¨"><a href="#å›¾è¡¨" class="headerlink" title="å›¾è¡¨"></a>å›¾è¡¨</h2><ul>
<li>æ•°æ®æ¥å…¥æˆåŠŸå</li>
</ul>
<p>ç›‘æ§å›¾è¡¨é¡µé¢ï¼š<a href="http://10.1.100.200/graph" rel="external nofollow noopener noreferrer" target="_blank">http://10.1.100.200/graph</a></p>
<p><img src="mongodb-monitor-steps.assets/1560855181358.png" alt="1560855181358"></p>
<hr>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.percona.com/doc/percona-monitoring-and-management/conf-mongodb.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.percona.com/doc/percona-monitoring-and-management/conf-mongodb.html</a></p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheusç›‘æ§MySQLä¸»ä»åŒæ­¥</title>
    <url>/monitoring/prometheus/monitoring-mysql-replication/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>åˆ©ç”¨node_exporterä»*.promæ–‡ä»¶è¯»å–æŒ‡æ ‡æ•°æ®</p>
</blockquote>
<a id="more"></a>
<h2 id="è·å–æ•°æ®çš„è„šæœ¬"><a href="#è·å–æ•°æ®çš„è„šæœ¬" class="headerlink" title="è·å–æ•°æ®çš„è„šæœ¬"></a>è·å–æ•°æ®çš„è„šæœ¬</h2><p>getKeys.sh:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mypath=$(<span class="built_in">cd</span> `dirname <span class="variable">$0</span>`; <span class="built_in">pwd</span>)</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$mypath</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"executing all shell scripts ..."</span></span><br><span class="line"><span class="keyword">for</span> sh <span class="keyword">in</span> `ls *.sh |grep -v <span class="variable">$0</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"will execute: ./<span class="variable">$sh</span> &gt; <span class="variable">$&#123;sh&#125;</span>.prom"</span></span><br><span class="line">  <span class="built_in">eval</span> <span class="string">"./<span class="variable">$sh</span> &gt; <span class="variable">$&#123;sh&#125;</span>.prom"</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
<p>è·å–ä¸»ä»åŒæ­¥å»¶è¿Ÿæ•°æ®çš„è„šæœ¬pt-heart.shï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">out=`pt-heartbeat -D your_dbname --table=heartbeat --check --host=x.x.x.x --port=xx --user=xx --password=xxxxxx --master-server-id=xxx --<span class="built_in">print</span>-master-server-id`</span><br><span class="line">v=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$out</span>"</span> |awk <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">m=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$out</span>"</span> |awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"pt_heart&#123;server_id=\"<span class="variable">$m</span>\"&#125; <span class="variable">$v</span>"</span></span><br></pre></td></tr></table></figure>
<p>å…·ä½“ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">out=`pt-heartbeat -D test_sync --table=heartbeat --check --host=10.1.7.211 --port=3306 --user=root --password=xxxxxx --master-server-id=100 --<span class="built_in">print</span>-master-server-id`</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>è„šæœ¬ä½ç½®ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@docker-dev node_exporter_keys]<span class="comment"># pwd</span></span><br><span class="line">/srv/node_exporter_keys</span><br><span class="line">[root@docker-dev node_exporter_keys]<span class="comment"># tree .</span></span><br><span class="line">.</span><br><span class="line">â”œâ”€â”€ getkeys.sh</span><br><span class="line">â”œâ”€â”€ procs.sh</span><br><span class="line">â”œâ”€â”€ procs.sh.prom</span><br><span class="line">â”œâ”€â”€ pt-heart.sh</span><br><span class="line">â””â”€â”€ pt-heart.sh.prom</span><br></pre></td></tr></table></figure>
<h3 id="è®¾ç½®å®šæ—¶ä»»åŠ¡"><a href="#è®¾ç½®å®šæ—¶ä»»åŠ¡" class="headerlink" title="è®¾ç½®å®šæ—¶ä»»åŠ¡"></a>è®¾ç½®å®šæ—¶ä»»åŠ¡</h3><p>è®¾ç½®crontabå®šæ—¶ä»»åŠ¡ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">* * * * * /srv/node_exporter_keys/getkeys.sh</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºçš„æ–‡ä»¶pt-heart.sh.promï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">pt_heart&#123;server_id=&quot;100&quot;&#125; 0.00</span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹node_exporterå¯åŠ¨å‚æ•°ï¼š</p>
<p>åˆ†ä¸¤ç§æƒ…å½¢ï¼š</p>
<ul>
<li>é€šè¿‡dockerè¿è¡Œnode_exporter</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.0'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">node-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/proc:/host/proc:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/sys:/host/sys:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/rootfs:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/srv/node_exporter_keys:/var/extra_keys:ro</span> <span class="comment"># æ˜ å°„åˆ°/var/extra_keys</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9100</span><span class="string">:9100</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--collector.textfile.directory=/var/extra_keys'</span> <span class="comment"># æŒ‡å®šä»/var/extra_keysè¯»å–*.prom</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.procfs=/host/proc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.sysfs=/host/sys'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--collector.filesystem.ignored-mount-points="^(/rootfs|/host|)/(sys|proc|dev|host|etc)($$|/)"'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--collector.filesystem.ignored-fs-types="^(sys|proc|auto|cgroup|devpts|ns|au|fuse\.lxc|mqueue)(fs|)$$"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>é€šè¿‡supervisorè¿è¡Œnode_exporter</li>
</ul>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[program:node_exporter]</span></span><br><span class="line"><span class="attr">command</span>=/path/to/node_exporter --collector.textfile.directory=/srv/node_exporter_keys</span><br><span class="line"><span class="attr">directory</span>=/path/to</span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">50</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/node_exporter.log</span><br></pre></td></tr></table></figure>
<p>æœ€åï¼Œè®¿é—®ç›¸åº”çš„<a href="http://your-host:9100/metricsï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æ–°å¢çš„æŒ‡æ ‡åç§°pt_heartã€‚" rel="external nofollow noopener noreferrer" target="_blank">http://your-host:9100/metricsï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æ–°å¢çš„æŒ‡æ ‡åç§°pt_heartã€‚</a></p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQLç›‘æ§æ¥å…¥</title>
    <url>/monitoring/prometheus/monitoring-mysql/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>Percona Monitoring and Management (PMM)æ˜¯ä¸€æ¬¾å¼€æºçš„MySQLã€MongoDBæ€§èƒ½ç›‘æ§å·¥å…·ï¼ŒPMMå®¢æˆ·ç«¯è´Ÿè´£æ”¶é›†DBç›‘æ§æ•°æ®ï¼ŒPMMæœåŠ¡ç«¯ä»å·²è¿æ¥çš„å®¢æˆ·ç«¯æ‹‰å–æ•°æ®ï¼Œå¹¶é€šè¿‡ç¬¬ä¸‰æ–¹è½¯ä»¶Grafanaå±•ç¤ºå›¾è¡¨ã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="å®‰è£…pmm-client"><a href="#å®‰è£…pmm-client" class="headerlink" title="å®‰è£…pmm-client"></a>å®‰è£…pmm-client</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…pmm-client</span></span><br><span class="line">yum install https://www.percona.com/downloads/pmm/1.1.1/binary/redhat/7/x86_64/pmm-client-1.1.1-1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<h2 id="é…ç½®æœåŠ¡ç«¯"><a href="#é…ç½®æœåŠ¡ç«¯" class="headerlink" title="é…ç½®æœåŠ¡ç«¯"></a>é…ç½®æœåŠ¡ç«¯</h2><p>ç›®å‰ç»Ÿä¸€ç”±PMMæœåŠ¡ç«¯<strong>10.1.100.200</strong>ç®¡ç†æ•°æ®åº“ç›‘æ§ä»»åŠ¡ã€‚</p>
<p>åœ¨mysqlç«¯æ‰§è¡Œï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pmm-admin config --server 10.1.100.200 --<span class="built_in">bind</span>-address=&lt;å½“å‰mysqlå®ä¾‹IPåœ°å€&gt; --client-address=&lt;å½“å‰mysqlå®ä¾‹IPåœ°å€&gt; --client-name=&lt;è‡ªå®šä¹‰å®¢æˆ·ç«¯åç§°&gt;</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pmm-admin config --server 10.1.100.200 --<span class="built_in">bind</span>-address=192.168.101.68 --client-address=192.168.101.68 --client-name=Production</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œåä¼šä¿å­˜åˆ°æ–‡ä»¶<code>/usr/local/percona/pmm-client/pmm.yml</code>ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@b68-docker-prd pmm]<span class="comment"># cat /usr/local/percona/pmm-client/pmm.yml</span></span><br><span class="line">server_address: 10.1.100.200</span><br><span class="line">client_address: 192.168.101.68</span><br><span class="line">bind_address: 192.168.101.68</span><br><span class="line">client_name: Production</span><br></pre></td></tr></table></figure>
<h2 id="æ·»åŠ mysql"><a href="#æ·»åŠ mysql" class="headerlink" title="æ·»åŠ mysql"></a>æ·»åŠ mysql</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pmm-admin add mysql --user &lt;mysqlç”¨æˆ·å&gt; --password &lt;mysqlå¯†ç &gt; --host &lt;mysqlå®ä¾‹IPåœ°å€&gt; --port &lt;mysqlç«¯å£&gt; &lt;è‡ªå®šä¹‰æœ¬å®ä¾‹çš„åç§°&gt;</span><br></pre></td></tr></table></figure>
<p>ç¤ºä¾‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">pmm-admin add mysql --user root --password xxxxxx --host 192.168.101.68 --port 3306 client-production-3306</span><br></pre></td></tr></table></figure>
<h2 id="æŸ¥çœ‹é…ç½®"><a href="#æŸ¥çœ‹é…ç½®" class="headerlink" title="æŸ¥çœ‹é…ç½®"></a>æŸ¥çœ‹é…ç½®</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@b68-docker-prd pmm]<span class="comment"># pmm-admin list</span></span><br><span class="line">pmm-admin 1.1.1</span><br><span class="line"></span><br><span class="line">PMM Server      | 10.1.100.200</span><br><span class="line">Client Name     | Production</span><br><span class="line">Client Address  | 192.168.101.68</span><br><span class="line">Service Manager | linux-systemd</span><br><span class="line"></span><br><span class="line">-------------- ----------------------- ----------- -------- ---------------------------------- ------------------------</span><br><span class="line">SERVICE TYPE   NAME                    LOCAL PORT  RUNNING  DATA SOURCE                        OPTIONS</span><br><span class="line">-------------- ----------------------- ----------- -------- ---------------------------------- ------------------------</span><br><span class="line">mysql:queries  client-production-3306  -           YES      root:***@tcp(192.168.101.68:3306)  query_source=perfschema</span><br><span class="line">linux:metrics  client-production-3306  42000       YES      -                   </span><br><span class="line">mysql:metrics  client-production-3306  42002       YES      root:***@tcp(192.168.101.68:3306)</span><br></pre></td></tr></table></figure>
<h2 id="å›¾è¡¨"><a href="#å›¾è¡¨" class="headerlink" title="å›¾è¡¨"></a>å›¾è¡¨</h2><p>æ•°æ®æ¥å…¥æˆåŠŸå</p>
<ul>
<li>æŸ¥è¯¢åˆ†æé¡µé¢ï¼š<a href="http://10.1.100.200/qan/" rel="external nofollow noopener noreferrer" target="_blank">http://10.1.100.200/qan/</a></li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/mysql-monitor-steps.assets/1560845119682.png" alt="1560845119682"></p>
<ul>
<li>ç›‘æ§å›¾è¡¨é¡µé¢ï¼š<a href="http://10.1.100.200/graph" rel="external nofollow noopener noreferrer" target="_blank">http://10.1.100.200/graph</a></li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/mysql-monitor-steps.assets/1560845433306.png" alt="1560845433306"></p>
<hr>
<p>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://www.percona.com/doc/percona-monitoring-and-management/conf-mysql.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.percona.com/doc/percona-monitoring-and-management/conf-mysql.html</a></p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>NginXç›‘æ§</title>
    <url>/monitoring/prometheus/monitoring-nginx/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>nginxéœ€å®‰è£…nginx-module-vtsæ¨¡å—ï¼Œç„¶åé€šè¿‡nginx-vts-exporterè¾“å‡ºç›‘æ§æŒ‡æ ‡ã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="nginx-module-vtsæ¨¡å—"><a href="#nginx-module-vtsæ¨¡å—" class="headerlink" title="nginx-module-vtsæ¨¡å—"></a>nginx-module-vtsæ¨¡å—</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># è·å–nginx-module-vtsæ¨¡å—æºç </span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/vozlt/nginx-module-vts</span><br><span class="line"></span><br><span class="line"><span class="comment"># nginxæºç åŒ…</span></span><br><span class="line">wget https://nginx.org/download/nginx-1.17.0.tar.gz</span><br><span class="line">tar -xf nginx-1.17.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.17.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘nginxï¼ŒåŠ å…¥nginx-module-vtsæ¨¡å—</span></span><br><span class="line">./configure --add-module=/opt/nginx-module-vts --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/<span class="built_in">log</span>/nginx/error.log --http-log-path=/var/<span class="built_in">log</span>/nginx/access.log --pid-path=/var/run/nginx.pid --lock-path=/var/run/nginx.lock --http-client-body-temp-path=/var/cache/nginx/client_temp --http-proxy-temp-path=/var/cache/nginx/proxy_temp --http-fastcgi-temp-path=/var/cache/nginx/fastcgi_temp --http-uwsgi-temp-path=/var/cache/nginx/uwsgi_temp --http-scgi-temp-path=/var/cache/nginx/scgi_temp --user=nginx --group=nginx --with-http_ssl_module --with-http_realip_module --with-http_addition_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_mp4_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_stub_status_module --with-http_auth_request_module --with-mail --with-mail_ssl_module --with-file-aio --with-ipv6 --with-cc-opt=<span class="string">'-O2 -g -pipe -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector --param=ssp-buffer-size=4 -m64 -mtune=generic'</span></span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<h2 id="é…ç½®nginx"><a href="#é…ç½®nginx" class="headerlink" title="é…ç½®nginx"></a>é…ç½®nginx</h2><ul>
<li>ä¿®æ”¹nginx.conf</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    ...</span><br><span class="line">    vhost_traffic_status_zone;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 8088;</span><br><span class="line">        location /status &#123;</span><br><span class="line">            vhost_traffic_status_display;</span><br><span class="line">            vhost_traffic_status_display_format html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>serveré…ç½®ç¤ºä¾‹</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">upstream jenkins &#123;</span><br><span class="line">    server 127.0.0.1:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name jenkins.keep.com;</span><br><span class="line"></span><br><span class="line">	<span class="comment">#uriè®¿é—®ç»Ÿè®¡</span></span><br><span class="line">    vhost_traffic_status_filter_by_set_key $uri uri::$server_name;</span><br><span class="line"></span><br><span class="line">	<span class="comment"># #å›½å®¶/åœ°åŒºè®¿é—®ç»Ÿè®¡ï¼Œæ— æ­¤æ¨¡å—å·²æ³¨é‡Š</span></span><br><span class="line">    <span class="comment"># vhost_traffic_status_filter_by_set_key $geoip_country_code country::$server_name;</span></span><br><span class="line">	<span class="comment"># #UserAgent ç»Ÿè®¡</span></span><br><span class="line">    <span class="comment"># vhost_traffic_status_filter_by_set_key $filter_user_agent agent::$server_name;    </span></span><br><span class="line">    vhost_traffic_status_filter_by_set_key $status $server_name; #http codeç»Ÿè®¡</span><br><span class="line">    vhost_traffic_status_filter_by_set_key $upstream_addr upstream::backend; #åç«¯è½¬å‘ç»Ÿè®¡</span><br><span class="line">    vhost_traffic_status_filter_by_set_key $remote_port client::ports::$server_name; #è¯·æ±‚ç«¯å£ç»Ÿè®¡</span><br><span class="line">    vhost_traffic_status_filter_by_set_key $remote_addr client::addr::$server_name;  #è¯·æ±‚IPç»Ÿè®¡</span><br><span class="line">    </span><br><span class="line">    <span class="comment">#è¯·æ±‚è·¯å¾„ç»Ÿè®¡</span></span><br><span class="line">    location ~ ^/storage/(.+)/.*$ &#123;</span><br><span class="line">        set $volume $1;</span><br><span class="line">        vhost_traffic_status_filter_by_set_key $volume storage::$server_name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://jenkins;</span><br><span class="line">        proxy_redirect default;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ·»åŠ åˆ°ç³»ç»ŸæœåŠ¡</li>
</ul>
<p>/etc/systemd/system/nginx.service:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=The nginx HTTP and reverse proxy server</span><br><span class="line"><span class="attr">After</span>=network.target remote-fs.target nss-lookup.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">PIDFile</span>=/run/nginx.pid</span><br><span class="line"><span class="comment"># Nginx will fail to start if /run/nginx.pid already exists but has the wrong</span></span><br><span class="line"><span class="comment"># SELinux context. This might happen when running `nginx -t` from the cmdline.</span></span><br><span class="line"><span class="comment"># https://bugzilla.redhat.com/show_bug.cgi?id=1268621</span></span><br><span class="line"><span class="attr">ExecStartPre</span>=/usr/bin/rm -f /run/nginx.pid</span><br><span class="line"><span class="attr">ExecStartPre</span>=/usr/sbin/nginx -t</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/sbin/nginx</span><br><span class="line"><span class="attr">ExecReload</span>=/bin/kill -s HUP <span class="variable">$MAINPID</span></span><br><span class="line"><span class="attr">KillSignal</span>=SIGQUIT</span><br><span class="line"><span class="attr">TimeoutStopSec</span>=<span class="number">5</span></span><br><span class="line"><span class="attr">KillMode</span>=process</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ln -s /etc/systemd/system/nginx.service /etc/systemd/system/multi-user.target.wants/</span><br></pre></td></tr></table></figure>
<ul>
<li>å¯åŠ¨ã€æ£€æŸ¥ã€é‡æ–°åŠ è½½</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl start nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹è¿‡nginxé…ç½®å</span></span><br><span class="line">nginx -t</span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<ul>
<li>æŸ¥çœ‹status</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/nginx-monitor-steps.assets/1561097913819.png" alt="1561097913819"></p>
<h2 id="æ•°æ®è½¬æ¢"><a href="#æ•°æ®è½¬æ¢" class="headerlink" title="æ•°æ®è½¬æ¢"></a>æ•°æ®è½¬æ¢</h2><p>é€šè¿‡<a href="https://github.com/hnlq715/nginx-vts-exporter" rel="external nofollow noopener noreferrer" target="_blank">nginx-vts-exporter</a>å°†ç”±nginx-module-vtsæ¨¡å—æä¾›çš„nginxç›‘æ§æ•°æ®è½¬æ¢æˆprometheusèƒ½ç›´æ¥ä½¿ç”¨çš„æ ¼å¼ã€‚</p>
<p>è½¬æ¢å‰ï¼š<a href="http://192.168.100.150:8088/status/format/json" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:8088/status/format/json</a></p>
<p>è½¬æ¢åï¼š<a href="http://192.168.100.150:9913/metrics" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:9913/metrics</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://github.com/hnlq715/nginx-vts-exporter/releases/download/v0.10.3/nginx-vts-exporter-0.10.3.linux-amd64.tar.gz</span><br><span class="line">tar -xf nginx-vts-exporter-0.10.3.linux-amd64.tar.gz</span><br><span class="line">chown -R nginx:nginx nginx-vts-exporter-0.10.3.linux-amd64</span><br><span class="line">ln -s /srv/nginx-vts-exporter-0.10.3.linux-amd64/nginx-vts-exporter /usr/bin/</span><br><span class="line"><span class="comment"># æµ‹è¯•è¿è¡Œexporter</span></span><br><span class="line">nohup nginx-vts-exporter -nginx.scrape_uri=http://localhost:8088/status/format/json</span><br></pre></td></tr></table></figure>
<p>å¯é€šè¿‡supervisorä¿æŒexporteråœ¨åå°è¿è¡Œï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[program:nginx_vts_exporter]</span></span><br><span class="line"><span class="attr">command</span>=/usr/bin/nginx-vts-exporter -nginx.scrape_uri=http://localhost:<span class="number">8088</span>/status/format/json</span><br><span class="line"><span class="attr">user</span>=nginx</span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">50</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/nginx_vts_exporter.log</span><br></pre></td></tr></table></figure>
<h2 id="æ³¨å†Œåˆ°consul"><a href="#æ³¨å†Œåˆ°consul" class="headerlink" title="æ³¨å†Œåˆ°consul"></a>æ³¨å†Œåˆ°consul</h2><p>å°†nginxç›‘æ§æ•°æ®æ¥å£æ³¨å†Œåˆ°consulï¼Œä½¿prometheusèƒ½è·å–è¯¥targetã€‚</p>
<p>curlå‘½ä»¤å‚è€ƒï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">curl http://192.168.100.140:8500/v1/agent/service/register -X PUT -i -H <span class="string">"Content-Type:application/json"</span> -d <span class="string">'&#123;</span></span><br><span class="line"><span class="string">	"ID": "nginx_192.168.100.150",</span></span><br><span class="line"><span class="string">	"Name": "nginx_192_168_100_150",</span></span><br><span class="line"><span class="string">	"Tags": ["nginx", "development", "prometheus-target"],</span></span><br><span class="line"><span class="string">	"Address": "192.168.100.150",</span></span><br><span class="line"><span class="string">	"Port": 9913,</span></span><br><span class="line"><span class="string">	"Check": &#123;</span></span><br><span class="line"><span class="string">		"DeregisterCriticalServiceAfter": "90m",</span></span><br><span class="line"><span class="string">		"HTTP": "http://192.168.100.150:9913/metrics",</span></span><br><span class="line"><span class="string">		"Interval": "15s"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"IsDeleted": false,</span></span><br><span class="line"><span class="string">	"Meta": &#123;</span></span><br><span class="line"><span class="string">		"version": "1.0"</span></span><br><span class="line"><span class="string">	&#125;,</span></span><br><span class="line"><span class="string">	"EnableTagOverride": false</span></span><br><span class="line"><span class="string">&#125;'</span></span><br></pre></td></tr></table></figure>
<p><strong>ä¸ºäº†ç»Ÿä¸€ç®¡æ§ï¼Œåº”æŒ‰ã€åº”ç”¨æ¥å…¥è¯´æ˜ã€‘è®°å½•åˆ°é…ç½®ä»“åº“ä¸­ã€‚</strong></p>
<p>æ³¨å†ŒæˆåŠŸåå¤šäº†ä¸€æ¡serviceè®°å½•ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/nginx-monitor-steps.assets/1561088176905.png" alt="1561088176905"></p>
<h2 id="å›¾è¡¨"><a href="#å›¾è¡¨" class="headerlink" title="å›¾è¡¨"></a>å›¾è¡¨</h2><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/nginx-monitor-steps.assets/1561088071803.png" alt="1561088071803"></p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQç›‘æ§æ¥å…¥</title>
    <url>/monitoring/prometheus/monitoring-rabbitmq/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>åœ¨Dockerä¸­è¿è¡Œçš„rabbitmqï¼Œç”¨dockeré•œåƒç‰ˆçš„rabbitmq-exporteræ›´æ–¹ä¾¿ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶ç‰ˆçš„rabbitmq-exporterã€‚</p>
</blockquote>
<a id="more"></a>
<h2 id="Dockerä¸­çš„RabbitMQ"><a href="#Dockerä¸­çš„RabbitMQ" class="headerlink" title="Dockerä¸­çš„RabbitMQ"></a>Dockerä¸­çš„RabbitMQ</h2><p>å¯é€šè¿‡dockeré•œåƒè¿è¡Œrabbitmq exporterï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">rabbitmq_exporter:</span></span><br><span class="line"><span class="attr">image:</span> <span class="string">kbudde/rabbitmq-exporter</span></span><br><span class="line"><span class="attr">ports:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="number">9429</span><span class="string">:9429</span></span><br><span class="line"><span class="attr">environment:</span></span><br><span class="line">	<span class="attr">SERVICE_TAGS:</span> <span class="string">"prometheus-target,rabbitmq-expo"</span></span><br><span class="line">	<span class="attr">RABBIT_URL:</span> <span class="string">"http://127.0.0.1:15672"</span></span><br><span class="line">	<span class="attr">RABBIT_USER:</span> <span class="string">"guest"</span></span><br><span class="line">	<span class="attr">RABBIT_PASSWORD:</span> <span class="string">"guest"</span></span><br><span class="line">	<span class="attr">PUBLISH_PORT:</span> <span class="string">"9429"</span></span><br><span class="line">	<span class="attr">OUTPUT_FORMAT:</span> <span class="string">"JSON"</span></span><br><span class="line"><span class="comment">#   LOG_LEVEL: "debug"</span></span><br><span class="line"><span class="attr">network_mode:</span> <span class="string">host</span></span><br></pre></td></tr></table></figure>
<h2 id="VMå®‰è£…çš„RabbitMQ"><a href="#VMå®‰è£…çš„RabbitMQ" class="headerlink" title="VMå®‰è£…çš„RabbitMQ"></a>VMå®‰è£…çš„RabbitMQ</h2><p>è·å–rabbitmq_exporterï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># goç¼–è¯‘rabbitmq_exporter</span></span><br><span class="line">go get https://github.com/kbudde/rabbitmq_exporter</span><br><span class="line"></span><br><span class="line"><span class="comment"># æˆ–è€…wgetä¸‹è½½releaseçš„äºŒè¿›åˆ¶æ–‡ä»¶åŒ…</span></span><br><span class="line">https://github.com/kbudde/rabbitmq_exporter/releases/download/v0.29.0/rabbitmq_exporter-0.29.0.linux-amd64.tar.gz</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œrabbitmq_exporter:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">RABBIT_URL=<span class="string">"http://127.0.0.1:15672"</span> RABBIT_USER=guest  RABBIT_PASSWORD=guest ./rabbitmq_exporter</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡supervisorä¿æŒrabbitmq_exporterè¿è¡Œæ—¶ï¼Œå¯ä½œå¦‚ä¸‹é…ç½®:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[program:rabbitmq-expo]</span></span><br><span class="line"><span class="attr">command</span>=/srv/rabbitmq_exporter</span><br><span class="line"><span class="attr">directory</span>=/srv</span><br><span class="line"><span class="attr">user</span>=rabbitmq</span><br><span class="line"><span class="attr">environment</span>=RABBIT_USER=admin,RABBIT_PASSWORD=<span class="string">"xxxxxx"</span>,OUTPUT_FORMAT=JSON,PUBLISH_PORT=<span class="number">9429</span>,RABBIT_URL=http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">15672</span></span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">50</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/rabbitmq-expo.log</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œåï¼Œæ£€æŸ¥æ˜¯å¦èƒ½å¯¼å‡ºç›‘æ§æ•°æ®ã€‚ä»¥10.1.7.211ä¸Šçš„rabbitmqä¸ºä¾‹ï¼Œæ‰“å¼€<a href="http://10.1.7.211:9429/metrics" rel="external nofollow noopener noreferrer" target="_blank">http://10.1.7.211:9429/metrics</a>ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rabbitmq-monitor-steps.assets/1560918051276.png" alt="1560918051276"></p>
<p>æœ€åï¼Œéœ€è¦å°†æ­¤æ¥å£æ³¨å†Œåˆ°Consulä»¥ä¾¿Prometheusèƒ½è‡ªåŠ¨æ·»åŠ æ­¤targetã€‚æ–¹æ³•è§<a href="docs/monitoring/prometheus/self/prometheus-consul-guide.md">åº”ç”¨æ¥å…¥è¯´æ˜</a>ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rabbitmq-monitor-steps.assets/1560918662228.png" alt="1560918662228"></p>
<h2 id="å›¾è¡¨"><a href="#å›¾è¡¨" class="headerlink" title="å›¾è¡¨"></a>å›¾è¡¨</h2><p>å•èŠ‚ç‚¹rabbitmqï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rabbitmq-monitor-steps.assets/1560917193636.png" alt="1560917193636"></p>
<p>rabbitmqé›†ç¾¤ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/rabbitmq-monitor-steps.assets/1560917249540.png" alt="1560917249540"></p>
<hr>
<p>rabbitmq_exporterä½¿ç”¨è¯´æ˜ï¼š<a href="https://github.com/kbudde/rabbitmq_exporter" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kbudde/rabbitmq_exporter</a></p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Redisç›‘æ§æ¥å…¥</title>
    <url>/monitoring/prometheus/monitoring-redis/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>åœ¨Dockerä¸­è¿è¡Œçš„redisï¼Œç”¨dockeré•œåƒç‰ˆçš„redis_exporteræ›´æ–¹ä¾¿ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨äºŒè¿›åˆ¶ç‰ˆçš„redis_exporter</p>
</blockquote>
<a id="more"></a>
<h2 id="Dockerä¸­çš„Redis"><a href="#Dockerä¸­çš„Redis" class="headerlink" title="Dockerä¸­çš„Redis"></a>Dockerä¸­çš„Redis</h2><p>å¯é€šè¿‡dockeré•œåƒè¿è¡Œredis exporterï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">redis-expo:</span></span><br><span class="line">	<span class="attr">image:</span> <span class="string">oliver006/redis_exporter</span></span><br><span class="line">	<span class="attr">ports:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="number">9121</span><span class="string">:9121</span></span><br><span class="line">	<span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">	<span class="attr">environment:</span></span><br><span class="line">	    <span class="attr">REDIS_PASSWORD:</span> <span class="string">"xxxxxxxxxxxxxx"</span></span><br><span class="line">		<span class="attr">SERVICE_TAGS:</span> <span class="string">"prometheus-target,redis-expo"</span></span><br><span class="line">	<span class="attr">command:</span> <span class="string">"--redis.addr redis://127.0.0.1:6379"</span></span><br></pre></td></tr></table></figure>
<h2 id="VMå®‰è£…çš„Redis"><a href="#VMå®‰è£…çš„Redis" class="headerlink" title="VMå®‰è£…çš„Redis"></a>VMå®‰è£…çš„Redis</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…redis_exporter</span></span><br><span class="line">wget https://github.com/oliver006/redis_exporter/releases/download/v1.0.0/redis_exporter-v1.0.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf redis_exporter-v1.0.0.linux-amd64.tar.gz -C /srv/</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œredis_exporter:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">nohup ./redis_exporter --redis.addr <span class="string">"redis://127.0.0.1:6379"</span> --redis.password <span class="string">"xxxxxxxxxx"</span> --web.listen-address <span class="string">"0.0.0.0:9121"</span> &amp; 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
<p>é€šè¿‡supervisorä¿æŒredis_exporterè¿è¡Œæ—¶ï¼Œå¯ä½œå¦‚ä¸‹é…ç½®:</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[program:redis_exporter]</span></span><br><span class="line"><span class="attr">command</span>=redis_exporter</span><br><span class="line"><span class="attr">directory</span>=/srv/redis_exporter-v1.<span class="number">0.0</span>.linux-amd64</span><br><span class="line"><span class="attr">user</span>=root</span><br><span class="line"><span class="attr">environment</span>=REDIS_PASSWORD=<span class="string">"xxxxxx"</span>,REDIS_ADDR=<span class="string">"redis://127.0.0.1:6379"</span>,REDIS_EXPORTER_WEB_LISTEN_ADDRESS=<span class="string">"0.0.0.0:9121"</span></span><br><span class="line"><span class="attr">startsecs</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">redirect_stderr</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">stdout_logfile_maxbytes</span>=<span class="number">50</span>MB</span><br><span class="line"><span class="attr">stdout_logfile_backups</span>=<span class="number">3</span></span><br><span class="line"><span class="attr">stdout_logfile</span>=/var/log/redis_exporter.log</span><br></pre></td></tr></table></figure>
<p>è¿è¡Œåï¼ŒéªŒè¯æ˜¯å¦èƒ½è¾“å‡ºredisç›‘æ§æ•°æ®ã€‚ä»¥10.1.7.211ä¸Šçš„redisä¸ºä¾‹ï¼Œæ‰“å¼€<a href="http://10.1.7.211:9121/metrics" rel="external nofollow noopener noreferrer" target="_blank">http://10.1.7.211:9121/metrics</a>ï¼Œå¹¶æœç´¢<code>redis_connected_clients</code>ï¼Œé0æ­£å¸¸ï¼Œè¡¨æ˜redis_exporterå·²è¿æ¥ä¸Šredisã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/redis-monitor-steps.assets/1560914994853.png" alt="1560914994853"></p>
<p>æœ€åï¼Œéœ€è¦å°†æ­¤æ¥å£æ³¨å†Œåˆ°Consulä»¥ä¾¿Prometheusèƒ½è‡ªåŠ¨æ·»åŠ æ­¤targetã€‚æ–¹æ³•è§<a href="docs/monitoring/prometheus/self/prometheus-consul-guide.md">åº”ç”¨æ¥å…¥è¯´æ˜</a>ã€‚</p>
<h2 id="å›¾è¡¨"><a href="#å›¾è¡¨" class="headerlink" title="å›¾è¡¨"></a>å›¾è¡¨</h2><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/redis-monitor-steps.assets/1560918348143.png" alt="1560918348143"></p>
<hr>
<p>redis_exporterä½¿ç”¨è¯´æ˜ï¼š<a href="https://github.com/oliver006/redis_exporter" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/oliver006/redis_exporter</a></p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Redis</tag>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheusè‡ªåŠ¨å‘ç°é…ç½®</title>
    <url>/monitoring/prometheus/prometheus-discovery/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>Prometheusæ”¯æŒåŸºäºConsulè‡ªåŠ¨å‘ç°</p>
</blockquote>
<a id="more"></a>
<p>prometheus.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span>     <span class="string">1s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span>      <span class="string">1s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">5s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['10.1.7.211:9093']</span></span><br><span class="line"></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'rules/*.yml'</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/metrics</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">instance:</span> <span class="string">prometheus</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">consul_sd</span></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">'192.168.100.140:8500'</span></span><br><span class="line">      <span class="attr">datacenter:</span> <span class="string">dc01</span></span><br><span class="line">      <span class="attr">services:</span> <span class="string">[]</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_consul_tags]</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">'.*,prometheus-target,.*'</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_consul_service]</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">sn</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">consul_sd_dev</span></span><br><span class="line">    <span class="attr">consul_sd_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">server:</span> <span class="string">'10.1.7.211:8500'</span></span><br><span class="line">      <span class="attr">datacenter:</span> <span class="string">dc1</span></span><br><span class="line">      <span class="attr">services:</span> <span class="string">[]</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">[__meta_consul_tags]</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">'.*prometheus-target.*'</span></span><br><span class="line">      <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">source_labels:</span> <span class="string">['__address__']</span></span><br><span class="line"><span class="comment">#      regex: '.*:(.*)'</span></span><br><span class="line">      <span class="attr">regex:</span> <span class="string">'127.0.0.1:(.*)'</span></span><br><span class="line">      <span class="attr">target_label:</span> <span class="string">'__address__'</span></span><br><span class="line">      <span class="attr">replacement:</span> <span class="string">'10.1.7.211:$1'</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus + Grafana + Alertmanagerç›‘æ§</title>
    <url>/monitoring/prometheus/prometheus-intro/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p> ç¯å¢ƒï¼šCentOS Linux release 7.5.1804 (Core)ã€5.5.60-MariaDB</p>
<p>è¿è¡Œæ–¹å¼ï¼šPrometheusï¼ŒGrafanaå’ŒAlertmanageré€šè¿‡dockerå®‰è£…è¿è¡Œï¼ŒMySQLå’Œexporterç›´æ¥è¿è¡Œåœ¨VMä¸Š</p>
</blockquote>
<a id="more"></a>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552636875890.png" alt="1552636875890"></p>
<h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker pull prom/prometheus</span><br><span class="line">docker pull grafana/grafana</span><br><span class="line">docker pull prom/alertmanager</span><br><span class="line">[root@VM_0_2_centos config]<span class="comment"># docker images</span></span><br><span class="line">REPOSITORY             TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">prom/prometheus        latest              f57ed0abd85c        2 days ago          109MB</span><br><span class="line">grafana/grafana        latest              ffd9c905f698        8 days ago          241MB</span><br><span class="line">prom/alertmanager      latest              02e0d8e930da        6 weeks ago         42.5MB</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œprometheuså‰ï¼Œå…ˆé…ç½®å¥½ä»¥ä¸‹æ–‡ä»¶ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@zabbix02</span> <span class="string">~]#</span> <span class="string">tree</span> <span class="string">config/</span></span><br><span class="line"><span class="string">config/</span></span><br><span class="line"><span class="string">â”œâ”€â”€</span> <span class="string">alertmanager</span></span><br><span class="line"><span class="string">â”‚</span>Â Â  <span class="string">â”œâ”€â”€</span> <span class="string">alertmanager.yml</span></span><br><span class="line"><span class="string">â”‚</span>Â Â  <span class="string">â””â”€â”€</span> <span class="string">template</span></span><br><span class="line"><span class="string">â”‚</span>Â Â      <span class="string">â””â”€â”€</span> <span class="string">test.tmpl</span></span><br><span class="line"><span class="string">â””â”€â”€</span> <span class="string">prometheus</span></span><br><span class="line">Â Â   <span class="string">â”œâ”€â”€</span> <span class="string">prometheus.yml</span></span><br><span class="line">Â Â   <span class="string">â””â”€â”€</span> <span class="string">rules.yml</span></span><br></pre></td></tr></table></figure>
<ul>
<li>prometheus.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">external_labels:</span></span><br><span class="line">    <span class="attr">monitor:</span> <span class="string">'codelab_monitor'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ¥è­¦æœåŠ¡ï¼Œalertmanageré»˜è®¤è¿è¡Œåœ¨9093ç«¯å£</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">["localhost:9093"]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŠ¥è­¦è§„åˆ™</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">"rules.yml"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä»¥ä¸‹å®šä¹‰äº†å¯é‡‡é›†çš„æŒ‡æ ‡æ•°æ®æº</span></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="comment"># å®‰è£…node-exporterå¹¶è¿è¡Œåï¼Œé»˜è®¤åœ¨ç«¯å£9100å¯¹å¤–æš´éœ²ç›¸å…³metrics</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'node'</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9100']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># prometheusè¿è¡Œæ—¶è‡ªèº«ä¹Ÿä¼šæä¾›ä¸€äº›metrics</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9090']</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># mysqlæŒ‡æ ‡ç”±mysqld-exporterå¯¼å‡ºï¼Œé»˜è®¤9104ç«¯å£</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'mysqld'</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:9104']</span></span><br></pre></td></tr></table></figure>
<ul>
<li>rules.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="comment"># æµ‹è¯•è§„åˆ™ï¼Œå½“CPUä½¿ç”¨ç‡ï¼ˆ5åˆ†é’Ÿï¼‰è¶…è¿‡20%æ—¶ï¼Œè¾¾åˆ°æŠ¥è­¦æ¡ä»¶</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-rules</span></span><br><span class="line">    <span class="attr">rules:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">hostCpuUsageAlert</span></span><br><span class="line">        <span class="attr">expr:</span> <span class="string">sum(avg</span> <span class="string">without</span> <span class="string">(cpu)(irate(node_cpu_seconds_total&#123;mode!='idle'&#125;[5m])))</span> <span class="string">by</span> <span class="string">(instance)</span> <span class="string">*</span> <span class="number">100</span> <span class="string">&gt;</span> <span class="number">20</span></span><br><span class="line">        <span class="attr">for:</span> <span class="string">1s</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">severity:</span> <span class="string">page</span></span><br><span class="line">        <span class="attr">annotations:</span></span><br><span class="line">          <span class="attr">summary:</span> <span class="string">"Instance <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU usgae high"</span></span><br><span class="line">          <span class="attr">description:</span> <span class="string">"<span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> CPU usage above 20% (current value: <span class="template-variable">&#123;&#123; $value &#125;&#125;</span>)"</span></span><br></pre></td></tr></table></figure>
<ul>
<li>alertmanager.yml</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">resolve_timeout:</span> <span class="string">5m</span> <span class="comment">#å¤„ç†è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º5min</span></span><br><span class="line">  <span class="attr">smtp_smarthost:</span> <span class="string">'smtp.163.com:465'</span> <span class="comment"># é‚®ç®±smtpæœåŠ¡å™¨ä»£ç†</span></span><br><span class="line">  <span class="attr">smtp_from:</span> <span class="string">'xxx@163.com'</span> <span class="comment"># å‘é€é‚®ç®±åç§°</span></span><br><span class="line">  <span class="attr">smtp_auth_username:</span> <span class="string">'xxx@163.com'</span> <span class="comment"># é‚®ç®±åç§°</span></span><br><span class="line">  <span class="attr">smtp_auth_password:</span> <span class="string">'xxxxxxxx'</span> <span class="comment"># é‚®ç®±å¯†ç æˆ–æˆæƒç </span></span><br><span class="line">  <span class="attr">wechat_api_url:</span> <span class="string">'https://qyapi.weixin.qq.com/cgi-bin/'</span> <span class="comment"># ä¼ä¸šå¾®ä¿¡åœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¨¡æ¿</span></span><br><span class="line"><span class="attr">templates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">'template/*.tmpl'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è·¯ç”±</span></span><br><span class="line"><span class="attr">route:</span></span><br><span class="line">  <span class="attr">group_by:</span> <span class="string">['alertname']</span> <span class="comment"># æŠ¥è­¦åˆ†ç»„ä¾æ®</span></span><br><span class="line">  <span class="attr">group_wait:</span> <span class="string">10s</span> <span class="comment"># ç¬¬ä¸€æ¬¡ç­‰å¾…å¤šä¹…æ—¶é—´å‘é€ä¸€ç»„è­¦æŠ¥çš„é€šçŸ¥</span></span><br><span class="line">  <span class="attr">group_interval:</span> <span class="string">10s</span> <span class="comment"># åœ¨å‘é€æ–°è­¦æŠ¥å‰çš„ç­‰å¾…æ—¶é—´</span></span><br><span class="line">  <span class="attr">repeat_interval:</span> <span class="string">1m</span> <span class="comment"># å‘é€é‡å¤è­¦æŠ¥çš„å‘¨æœŸ å¯¹äºemailæ­¤é¡¹ä¸å¯ä»¥è®¾ç½®è¿‡ä½</span></span><br><span class="line">  <span class="attr">receiver:</span> <span class="string">'web.hook'</span> <span class="comment"># ä½¿ç”¨receiversä¸­nameä¸ºweb.hookçš„æŠ¥è­¦æ–¹å¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¸¸ç”¨çš„æŠ¥è­¦é€šçŸ¥æ–¹å¼æœ‰3ç§ï¼Œwebhookã€emailå’Œä¼ä¸šå¾®ä¿¡</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="comment"># webhookæ–¹å¼</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'web.hook'</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">    <span class="comment"># æœ¬åœ°webhookæ‰“å°æŠ¥è­¦ä¿¡æ¯ã€‚webhookæ–¹å¼å¯ç”¨äºæµ‹è¯•ï¼Œæˆ–æ‰§è¡ŒæŸäº›åŠ¨ä½œã€‚</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">'http://127.0.0.1:5001/'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># é‚®ä»¶æ–¹å¼</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'email'</span></span><br><span class="line">    <span class="attr">email_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">to:</span> <span class="string">'xxx@yyy.com'</span> <span class="comment"># æ”¶ä»¶äºº</span></span><br><span class="line">      <span class="attr">html:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "test.html" . &#125;&#125;</span>'</span> <span class="comment"># é‚®ç®±å†…å®¹htmlæ¨¡æ¿</span></span><br><span class="line">      <span class="attr">headers:</span> <span class="string">&#123;</span> <span class="attr">Subject:</span> <span class="string">"[WARN] æŠ¥è­¦é‚®ä»¶"</span><span class="string">&#125;</span> <span class="comment"># é‚®ä»¶ä¸»é¢˜</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¼ä¸šå¾®ä¿¡æ–¹å¼</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'qywx'</span></span><br><span class="line">    <span class="attr">webhook_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">to_party:</span> <span class="string">'1'</span> <span class="comment"># æ¥æ”¶ç»„çš„id</span></span><br><span class="line">      <span class="attr">agent_id:</span> <span class="string">'xxxxxx'</span> <span class="comment"># ä¼ä¸šå¾®ä¿¡--&gt;è‡ªå®šåº”ç”¨--&gt;AgentId</span></span><br><span class="line">      <span class="attr">corp_id:</span> <span class="string">'xxxxxx'</span> <span class="comment"># æˆ‘çš„ä¼ä¸š--&gt;CorpId[åœ¨åº•éƒ¨]</span></span><br><span class="line">      <span class="attr">api_secret:</span> <span class="string">'xxxxxx'</span> <span class="comment"># ä¼ä¸šå¾®ä¿¡--&gt;è‡ªå®šåº”ç”¨--&gt;Secret</span></span><br><span class="line">      <span class="attr">message:</span> <span class="string">'<span class="template-variable">&#123;&#123; template "test.html" . &#125;&#125;</span>'</span> <span class="comment"># æ¨¡æ¿è®¾å®š</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œä¸ä½¿ç”¨dockeræ–¹å¼è¿è¡Œexporterï¼Œé€šè¿‡ä¸‹è½½å®‰è£…åŒ…å®‰è£…node_exporterå’Œmysqld_exporterã€‚</p>
<ul>
<li>å®‰è£…ã€å¯åŠ¨node_exporter</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v0.17.0/node_exporter-0.17.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf node_exporter-0.17.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> node_exporter-0.17.0.linux-amd64/</span><br><span class="line"><span class="comment"># è¿è¡Œnode_exporter</span></span><br><span class="line">nohup ./node_exporter &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹node_exporterç›‘å¬çš„ç«¯å£</span></span><br><span class="line">[root@zabbix02 node_exporter-0.17.0.linux-amd64]<span class="comment"># netstat -alntp |grep node_expo</span></span><br><span class="line">tcp6       0      0 :::9100                 :::*                    LISTEN      21164/./node_export </span><br><span class="line">tcp6       0      0 ::1:9100                ::1:57580               ESTABLISHED 21164/./node_export</span><br></pre></td></tr></table></figure>
<ul>
<li>å®‰è£…ã€å¯åŠ¨mysqld_exporter</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.11.0/mysqld_exporter-0.11.0.linux-amd64.tar.gz</span><br><span class="line">tar -xf mysqld_exporter-0.11.0.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> exporter/mysqld_exporter-0.11.0.linux-amd64/</span><br><span class="line"><span class="comment"># æœ¬æ–‡ä¸­ï¼Œè¢«ç›‘æ§çš„mysqlä¸prometheus serveråœ¨åŒä¸€ä¸ªæœºå™¨ä¸Š</span></span><br><span class="line"><span class="comment"># å°†ä½¿ç”¨mysqlä¸­åˆ›å»ºçš„åä¸ºexporterçš„ç”¨æˆ·æŸ¥è¯¢mysqlæŒ‡æ ‡</span></span><br><span class="line">cat &lt;&lt;EOF &gt;.my.cnf</span><br><span class="line">[client]</span><br><span class="line">user=exporter</span><br><span class="line">password=exporter</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># éœ€åˆ›å»ºmysql exporterç”¨æˆ·</span></span><br><span class="line">CREATE USER <span class="string">'exporter'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'exporter'</span>;</span><br><span class="line">GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO <span class="string">'exporter'</span>@<span class="string">'localhost'</span>;</span><br><span class="line"><span class="comment"># flush privileges;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œmysqld_exporter</span></span><br><span class="line">nohup ./mysqld_exporter --config.my-cnf=<span class="string">"./.my.cnf"</span> &amp;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿è¡Œprometheus</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run -d -p 9090:9090 --name prometheus --net=host \</span><br><span class="line">-v /root/config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml \</span><br><span class="line">-v /root/config/prometheus/rules.yml:/etc/prometheus/rules.yml prom/prometheus</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿è¡Œalertmanager</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">docker run -d -p 9093:9093 --net=host \</span><br><span class="line">-v /root/config/alertmanager/alertmanager.yml:/etc/alertmanager/config.yml \</span><br><span class="line">--name alertmanager prom/alertmanager</span><br></pre></td></tr></table></figure>
<ul>
<li>å®‰è£…åŠé…ç½®grafana</li>
</ul>
<p>è¦é€šè¿‡grafanaå±•ç¤ºç›‘æ§æ•°æ®ï¼Œè§<a href="https://github.com/zlzgithub/docs/blob/master/grafana/grafana-intro.md" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/zlzgithub/docs/blob/master/grafana/grafana-intro.md</a></p>
<hr>
<p>ä»¥ä¸Šæ­¥éª¤å°±ç»ªåï¼Œé€šè¿‡æµè§ˆå™¨è®¿é—®çœ‹çœ‹</p>
<ul>
<li>Prometheusé¦–é¡µ</li>
</ul>
<p><a href="http://192.168.100.150:9090/graph" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:9090/graph</a></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552624310656.png" alt="1552624310656"></p>
<ul>
<li>Alertsé¡µé¢</li>
</ul>
<p><a href="http://192.168.100.150:9090/alerts" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:9090/alerts</a>ï¼Œæ˜¾ç¤ºäº†ä¸€æ¡æŠ¥è­¦è§„åˆ™ï¼Œè¯´æ˜æ­¤å‰çš„prometheus rulesé…ç½®æ­£å¸¸ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552624418930.png" alt="1552624418930"></p>
<ul>
<li>Targetsé¡µé¢</li>
</ul>
<p><a href="http://192.168.100.150:9090/targets" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:9090/targets</a>ï¼Œæ˜¾ç¤ºäº†å·²åœ¨çº¿çš„metricsã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552624868689.png" alt="1552624868689"></p>
<ul>
<li>Alertmanager</li>
</ul>
<p><a href="http://192.168.100.150:9093/#/alerts" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:9093/#/alerts</a></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552624949727.png" alt="1552624949727"></p>
<ul>
<li>metrics</li>
</ul>
<ol>
<li>prometheusçš„metrics</li>
</ol>
<p><a href="http://192.168.100.150:9090/metrics" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:9090/metrics</a></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552625214005.png" alt="1552625214005"></p>
<ol start="2">
<li>mysqlçš„metrics</li>
</ol>
<p><a href="http://192.168.100.150:9104/metrics" rel="external nofollow noopener noreferrer" target="_blank">http://192.168.100.150:9104/metrics</a></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552625272026.png" alt="1552625272026"></p>
<h3 id="åŠŸèƒ½æµ‹è¯•"><a href="#åŠŸèƒ½æµ‹è¯•" class="headerlink" title="åŠŸèƒ½æµ‹è¯•"></a>åŠŸèƒ½æµ‹è¯•</h3><hr>
<p>åœ¨Grafanaä¸­ï¼Œå¯¼å…¥Prometheus 2.0 Statusä»ªè¡¨æ¿ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552640104574.png" alt="1552640104574"></p>
<p>å¯¼å…¥Mysql-Overviewæ¨¡æ¿çš„æ˜¾ç¤ºæ•ˆæœï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552642425792.png" alt="1552642425792"></p>
<p>æŠ¥è­¦æµ‹è¯•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å…ˆè¿è¡Œä¸€ä¸ªwebhookï¼Œå‰æå·²å®‰è£…golang</span></span><br><span class="line">go get github.com/prometheus/alertmanager/examples/webhook</span><br><span class="line">webhook</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦å¼€ä¸€ä¸ªçª—å£ï¼Œäººä¸ºæ‹‰é«˜CPUä½¿ç”¨ç‡ï¼Œè§‚å¯Ÿwebhookæ‰“å°çš„æ—¥å¿—</span></span><br><span class="line">cat /dev/zero &gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•å®Œä¹‹åï¼Œ[ctrl]+[c]ç»ˆæ­¢</span></span><br></pre></td></tr></table></figure>
<p>alertmanager webhookåœ¨æ§åˆ¶å°è¾“å‡ºçš„æ—¥å¿—ï¼š</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">[root@VM_0_2_centos alertmanager]# webhook</span><br><span class="line">2019/03/15 10:49:32 &#123;</span><br><span class="line"> &gt;  "receiver": "web<span class="tag">\<span class="name">\</span></span>.hook",</span><br><span class="line"> &gt;  "status": "firing",</span><br><span class="line"> &gt;  "alerts": [</span><br><span class="line"> &gt;    &#123;</span><br><span class="line"> &gt;      "status": "firing",</span><br><span class="line"> &gt;      "labels": &#123;</span><br><span class="line"> &gt;        "alertname": "hostCpuUsageAlert",</span><br><span class="line"> &gt;        "instance": "cvm001",</span><br><span class="line"> &gt;        "monitor": "codelab_monitor",</span><br><span class="line"> &gt;        "severity": "page"</span><br><span class="line"> &gt;      &#125;,</span><br><span class="line"> &gt;      "annotations": &#123;</span><br><span class="line"> &gt;        "description": "cvm001 CPU usage above 20<span class="comment">% (current value: 99.80000000001382)",</span></span><br><span class="line"> &gt;        "summary": "Instance cvm001 CPU usgae high"</span><br><span class="line"> &gt;      &#125;,</span><br><span class="line"> &gt;      "startsAt": "2019-03-15T02:49:22.839636267Z",</span><br><span class="line"> &gt;      "endsAt": "0001-01-01T00:00:00Z",</span><br><span class="line"> &gt;      "generatorURL": "http://VM_0_2_centos:9090/graph?g0.expr=sum+by<span class="comment">%28instance%29+%28avg+without%28cpu%29+%28irate%28node_cpu_seconds_total%7Bmode%21%3D%22idle%22%7D%5B5m%5D%29%29%29+%2A+100+%3E+20\u0026g0.tab=1"</span></span><br><span class="line"> &gt;    &#125;</span><br><span class="line"> &gt;  ],</span><br><span class="line"> &gt;  "groupLabels": &#123;</span><br><span class="line"> &gt;    "alertname": "hostCpuUsageAlert"</span><br><span class="line"> &gt;  &#125;,</span><br><span class="line"> &gt;  "commonLabels": &#123;</span><br><span class="line"> &gt;    "alertname": "hostCpuUsageAlert",</span><br><span class="line"> &gt;    "instance": "cvm001",</span><br><span class="line"> &gt;    "monitor": "codelab_monitor",</span><br><span class="line"> &gt;    "severity": "page"</span><br><span class="line"> &gt;  &#125;,</span><br><span class="line"> &gt;  "commonAnnotations": &#123;</span><br><span class="line"> &gt;    "description": "cvm001 CPU usage above 20<span class="comment">% (current value: 99.80000000001382)",</span></span><br><span class="line"> &gt;    "summary": "Instance cvm001 CPU usgae high"</span><br><span class="line"> &gt;  &#125;,</span><br><span class="line"> &gt;  "externalURL": "http://VM_0_2_centos:9093",</span><br><span class="line"> &gt;  "version": "4",</span><br><span class="line"> &gt;  "groupKey": "&#123;&#125;:&#123;alertname=<span class="tag">\<span class="name">"</span></span>hostCpuUsageAlert<span class="tag">\<span class="name">"</span></span>&#125;"</span><br><span class="line"> &gt;&#125;</span><br><span class="line"></span><br><span class="line">2019/03/15 10:52:52 &#123;</span><br><span class="line"> &gt;  "receiver": "web<span class="tag">\<span class="name">\</span></span>.hook",</span><br><span class="line"> &gt;  "status": "resolved",</span><br><span class="line"> &gt;  "alerts": [</span><br><span class="line"> &gt;    &#123;</span><br><span class="line"> &gt;      "status": "resolved",</span><br><span class="line"> &gt;      "labels": &#123;</span><br><span class="line"> &gt;        "alertname": "hostCpuUsageAlert",</span><br><span class="line"> &gt;        "instance": "cvm001",</span><br><span class="line"> &gt;        "monitor": "codelab_monitor",</span><br><span class="line"> &gt;        "severity": "page"</span><br><span class="line"> &gt;      &#125;,</span><br><span class="line"> &gt;      "annotations": &#123;</span><br><span class="line"> &gt;        "description": "cvm001 CPU usage above 20<span class="comment">% (current value: 99.79999999999563)",</span></span><br><span class="line"> &gt;        "summary": "Instance cvm001 CPU usgae high"</span><br><span class="line"> &gt;      &#125;,</span><br><span class="line"> &gt;      "startsAt": "2019-03-15T02:49:22.839636267Z",</span><br><span class="line"> &gt;      "endsAt": "2019-03-15T02:52:52.839636267Z",</span><br><span class="line"> &gt;      "generatorURL": "http://VM_0_2_centos:9090/graph?g0.expr=sum+by<span class="comment">%28instance%29+%28avg+without%28cpu%29+%28irate%28node_cpu_seconds_total%7Bmode%21%3D%22idle%22%7D%5B5m%5D%29%29%29+%2A+100+%3E+20\u0026g0.tab=1"</span></span><br><span class="line"> &gt;    &#125;</span><br><span class="line"> &gt;  ],</span><br><span class="line"> &gt;  "groupLabels": &#123;</span><br><span class="line"> &gt;    "alertname": "hostCpuUsageAlert"</span><br><span class="line"> &gt;  &#125;,</span><br><span class="line"> &gt;  "commonLabels": &#123;</span><br><span class="line"> &gt;    "alertname": "hostCpuUsageAlert",</span><br><span class="line"> &gt;    "instance": "cvm001",</span><br><span class="line"> &gt;    "monitor": "codelab_monitor",</span><br><span class="line"> &gt;    "severity": "page"</span><br><span class="line"> &gt;  &#125;,</span><br><span class="line"> &gt;  "commonAnnotations": &#123;</span><br><span class="line"> &gt;    "description": "cvm001 CPU usage above 20<span class="comment">% (current value: 99.79999999999563)",</span></span><br><span class="line"> &gt;    "summary": "Instance cvm001 CPU usgae high"</span><br><span class="line"> &gt;  &#125;,</span><br><span class="line"> &gt;  "externalURL": "http://VM_0_2_centos:9093",</span><br><span class="line"> &gt;  "version": "4",</span><br><span class="line"> &gt;  "groupKey": "&#123;&#125;:&#123;alertname=<span class="tag">\<span class="name">"</span></span>hostCpuUsageAlert<span class="tag">\<span class="name">"</span></span>&#125;"</span><br><span class="line"> &gt;&#125;</span><br></pre></td></tr></table></figure>
<p>å½“CPUä½¿ç”¨ç‡é«˜äº20%æ—¶ï¼ŒPrometheus Alertsé¡µé¢çš„æŠ¥è­¦çŠ¶æ€å…ˆåå˜åŒ–é¡ºåºï¼šin active -&gt; pending -&gt; firingï¼›æ¢å¤åï¼Œæ—¥å¿—æ˜¾ç¤ºresolvedã€‚</p>
<p>åœ¨æŠ¥è­¦é¡¹resolvedä¹‹å‰ï¼ŒAlertmanageré¡µé¢ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/prometheus-intro.assets/1552620299332.png" alt="1552620299332"></p>
<p>é€šè¿‡æµ‹è¯•å¯ä»¥çœ‹å‡ºï¼Œwebhookæ–¹å¼å‘å‡ºé€šçŸ¥æ˜¯æ­£å¸¸çš„ã€‚æœªæµ‹è¯•emailå’Œä¼ä¸šå¾®ä¿¡ã€‚</p>
<hr>
<p>(End)</p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheus</title>
    <url>/monitoring/prometheus/prometheus/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>åœ¨Dockerä¸­è¿è¡ŒPrometheusç›‘æ§ç»„ä»¶ï¼ŒåŒ…æ‹¬prometheus, alertmanager, grafana, åŠç›¸å…³exporterï¼Œå®ç°åŸºæœ¬çš„ä¸šåŠ¡ç›‘æ§ã€‚</p>
</blockquote>
<a id="more"></a>
<p>ä¸‹å›¾æ˜¯å®˜æ–¹ç½‘ç«™ä¸Šçš„Prometheuså®Œæ•´æ¶æ„å›¾ï¼š</p>
<p><img src="https://prometheus.io/assets/architecture.png" alt="Prometheuså®Œæ•´æ¶æ„å›¾"></p>
<hr>
<h2 id="Prometheusé…ç½®"><a href="#Prometheusé…ç½®" class="headerlink" title="Prometheusé…ç½®"></a>Prometheusé…ç½®</h2><p>é…ç½®æ–‡ä»¶ç›®å½•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@docker-dev docker-svc]<span class="comment"># tree -C -L 4 prometheus/</span></span><br><span class="line">prometheus/</span><br><span class="line">â”œâ”€â”€ config</span><br><span class="line">â”‚Â Â  â”œâ”€â”€ alertmanager</span><br><span class="line">â”‚Â Â  â”‚Â Â  â”œâ”€â”€ alertmanager.yml</span><br><span class="line">â”‚Â Â  â”‚Â Â  â””â”€â”€ template</span><br><span class="line">â”‚Â Â  â”‚Â Â      â””â”€â”€ test.tmpl</span><br><span class="line">â”‚Â Â  â””â”€â”€ prometheus</span><br><span class="line">â”‚Â Â      â”œâ”€â”€ prometheus.yml</span><br><span class="line">â”‚Â Â      â””â”€â”€ rules</span><br><span class="line">â”‚Â Â          â””â”€â”€ default.yml</span><br><span class="line">â””â”€â”€ docker-compose.yml</span><br></pre></td></tr></table></figure>
<p>docker-compose.yml:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.0'</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">alertmanager:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/alertmanager:/etc/alertmanager</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"9093:9093"</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SERVICE_NAME:</span> <span class="string">alertmanager</span></span><br><span class="line">      <span class="attr">SERVICE_TAGS:</span> <span class="string">"alertmanager,http"</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./config/prometheus/rules:/etc/prometheus/rules</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/etc/localtime:/etc/localtime</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SERVICE_NAME:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">SERVICE_TAGS:</span> <span class="string">"prometheus-target,prometheus,http"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9090</span><span class="string">:9090</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">grafana:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">grafana/grafana</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line"><span class="comment">#      - grafana-storage:/var/lib/grafana</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/grafana:/var/lib/grafana</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"GF_SERVER_ROOT_URL=http://grafana.server.name"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"GF_SECURITY_ADMIN_PASSWORD=xxxxxx"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"SERVICE_NAME=grafana"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"SERVICE_TAGS=prometheus-target,grafana,http"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">3000</span><span class="string">:3000</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">node-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/node-exporter</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/proc:/host/proc:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/sys:/host/sys:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/:/rootfs:ro</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">9100</span><span class="string">:9100</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">SERVICE_TAGS:</span> <span class="string">"prometheus-target"</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.procfs=/host/proc'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--path.sysfs=/host/sys'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--collector.filesystem.ignored-mount-points="^(/rootfs|/host|)/(sys|proc|dev|host|etc)($$|/)"'</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'--collector.filesystem.ignored-fs-types="^(sys|proc|auto|cgroup|devpts|ns|au|fuse\.lxc|mqueue)(fs|)$$"'</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>Prometheusè”é‚¦</title>
    <url>/monitoring/prometheus/prometheus_federate/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>Prometheusè”é‚¦</p>
</blockquote>
<a id="more"></a>
<p>prometheus.ymlç¤ºä¾‹ï¼š</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">global:</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">15s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">10s</span></span><br><span class="line">  <span class="attr">evaluation_interval:</span> <span class="string">1m</span></span><br><span class="line"><span class="attr">alerting:</span></span><br><span class="line">  <span class="attr">alertmanagers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">x.xx.xxx.xxx:9093</span></span><br><span class="line">    <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">10s</span></span><br><span class="line"><span class="attr">rule_files:</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">/etc/prometheus/rules/*.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">federate</span></span><br><span class="line">  <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="string">match[]:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'&#123;job=~"\\w.*"&#125;'</span></span><br><span class="line">    <span class="comment">#- '&#123;job=~"[a-zA-Z_].*"&#125;'</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/federate</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">x.xx.xxx.xxx:9090</span></span><br><span class="line">	</span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">federate2</span></span><br><span class="line">  <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="string">match[]:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">'&#123;job=~"\\w.*"&#125;'</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/federate</span></span><br><span class="line">  <span class="attr">scheme:</span> <span class="string">http</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">x.xx.xxx.xxx:xxxx</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">federate_pmm_server</span></span><br><span class="line">  <span class="attr">scrape_interval:</span> <span class="string">30s</span></span><br><span class="line">  <span class="attr">scrape_timeout:</span>  <span class="string">30s</span></span><br><span class="line">  <span class="attr">honor_labels:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">metrics_path:</span> <span class="string">/prometheus/federate</span></span><br><span class="line">  <span class="attr">basic_auth:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">"xxx"</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">"xxx"</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="string">match[]:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">'&#123;job=~"\\w.*"&#125;'</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">x.xx.xxx.xxx:xxxx</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Prometheus</tag>
      </tags>
  </entry>
  <entry>
    <title>é€šè¿‡Zabbixçš„è‡ªåŠ¨å‘ç°ï¼ˆè§„åˆ™ï¼‰è‡ªåŠ¨åˆ›å»ºç›‘æ§é¡¹</title>
    <url>/monitoring/zabbix/zabbix-discovery-rule/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<p>ä¸‹å›¾æ˜¯ä¸€ä¸ªå·²é…ç½®å¹¶å¯ç”¨çš„è‡ªåŠ¨å‘ç°è§„åˆ™:</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552289524930.png" alt="1552289524930"></p>
<a id="more"></a>
<p>åº”ç”¨åˆ°165.194è¿™ä¸ªä¸»æœºåï¼Œè‡ªåŠ¨å‘ç°çš„ç›‘æ§é¡¹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552292766307.png" alt="1552292766307"></p>
<h3 id="æœåŠ¡ç«¯é…ç½®"><a href="#æœåŠ¡ç«¯é…ç½®" class="headerlink" title="æœåŠ¡ç«¯é…ç½®"></a>æœåŠ¡ç«¯é…ç½®</h3><hr>
<ul>
<li>åˆ›å»ºTemplate</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552289699169.png" alt="1552289699169"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291377011.png" alt="1552291377011"></p>
<ul>
<li>åˆ›å»ºDiscovery rule</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552290037822.png" alt="1552290037822"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552290165972.png" alt="1552290165972"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552290648939.png" alt="1552290648939"></p>
<p>é”®å€¼<code>readPorts</code>è·Ÿè¢«ç›‘æ§ç«¯é…ç½®çš„å‚æ•°æœ‰å…³ï¼Œä¸‹é¢å†æã€‚</p>
<ul>
<li>åˆ›å»ºç›‘æ§é¡¹åŸå‹</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552290398568.png" alt="1552290398568"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552290435754.png" alt="1552290435754"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552290764479.png" alt="1552290764479"></p>
<p>å®å¼•ç”¨ç¬¦å·{ #SERVICE }å’Œ{ #TCP_PORT }è·Ÿè¢«ç›‘æ§ç«¯è¿”å›çš„jsonæ•°æ®æœ‰å…³ã€‚<code>net.tcp.listen[&lt;port&gt;]</code>è¡¨ç¤ºç›‘å¬ç›®æ ‡æœºå™¨çš„<code>&lt;port&gt;</code>ç«¯å£çŠ¶æ€ï¼Œè¿”å›å€¼ä¸º0æˆ–1ï¼Œ0è¡¨ç¤ºDownï¼Œ1è¡¨ç¤ºUpã€‚å¦å¤–ï¼Œ<code>$1</code>è¡¨ç¤ºé”®å€¼é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå³<code>&lt;port&gt;</code>ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291332721.png" alt="1552291332721"></p>
<ul>
<li>åˆ›å»ºè§¦å‘å™¨åŸå‹</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291459399.png" alt="1552291459399"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291553384.png" alt="1552291553384"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291665378.png" alt="1552291665378"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291704285.png" alt="1552291704285"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291742293.png" alt="1552291742293"></p>
<p>æ·»åŠ å®Œç›‘æ§é¡¹å’Œè§¦å‘å™¨åŸå‹çš„æ ·å­ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552291961703.png" alt="1552291961703"></p>
<ul>
<li><p>æ·»åŠ ä¸»æœºå¹¶å…³è”æ­¤æ¨¡æ¿</p>
<p>æ­¤ç•¥ã€‚</p>
</li>
</ul>
<hr>
<h3 id="è¢«ç›‘æ§ç«¯é…ç½®"><a href="#è¢«ç›‘æ§ç«¯é…ç½®" class="headerlink" title="è¢«ç›‘æ§ç«¯é…ç½®"></a>è¢«ç›‘æ§ç«¯é…ç½®</h3><p>é¦–å…ˆï¼Œçœ‹ä¸€ä¸‹/etc/zabbixç›®å½•ä¸‹çš„æ–‡ä»¶ã€‚scriptsç›®å½•æ˜¯æ–°åŠ çš„ï¼Œzabbix_agentd.confä¹Ÿä½œäº†ä¿®æ”¹ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552292968159.png" alt="1552292968159"></p>
<p>ä½¿ç”¨è‡ªåŠ¨å‘ç°åŠŸèƒ½ï¼Œéœ€è¦è¿”å›ç¬¦å·zabbixè¦æ±‚çš„jsonæ•°æ®ï¼š</p>
<p>ä¾‹å¦‚ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"data"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"&#123;#SERVICE&#125;"</span>: <span class="string">"phjd_mysql"</span>,</span><br><span class="line">            <span class="string">"&#123;#TCP_PORT&#125;"</span>: <span class="string">"28001"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"&#123;#SERVICE&#125;"</span>: <span class="string">"philips_taxfree_tuangou_payment_management"</span>,</span><br><span class="line">            <span class="string">"&#123;#TCP_PORT&#125;"</span>: <span class="string">"16200"</span></span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å½¢å¼å¤§è‡´å¦‚ä¸‹ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"data"</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"&#123;#KEY01&#125;"</span>: <span class="string">"value01_01"</span>,</span><br><span class="line">            <span class="string">"&#123;#KEY02&#125;"</span>: <span class="string">"value01_02"</span>,</span><br><span class="line">            <span class="string">"&#123;#KEY03&#125;"</span>: <span class="string">"value01_03"</span>,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"&#123;#KEY01&#125;"</span>: <span class="string">"value02_01"</span>,</span><br><span class="line">            <span class="string">"&#123;#KEY02&#125;"</span>: <span class="string">"value02_02"</span>,</span><br><span class="line">            <span class="string">"&#123;#KEY02&#125;"</span>: <span class="string">"value02_03"</span>,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>readPorts.shè„šæœ¬çš„å†…å®¹å¾ˆç®€å•ï¼Œå°±æ˜¯è¯»å–å·²å‡†å¤‡å¥½çš„jsonæ•°æ®æ–‡ä»¶ports.jsonï¼Œä½œä¸ºè¿”å›ç»™zabbix serverçš„å€¼ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@172 scripts]<span class="comment"># cat readPorts.sh </span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mypath=$(<span class="built_in">cd</span> `dirname <span class="variable">$0</span>`; <span class="built_in">pwd</span>)</span><br><span class="line">cat <span class="variable">$mypath</span>/ports.json</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†è¿”å›ç»™serverç«¯ï¼Œéœ€è¦å†zabbix_agentd.confä¸­é…ç½®ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552293926733.png" alt="1552293926733"></p>
<p>è¿™æ ·ï¼Œserverç«¯å°±å¯ä»¥ä½¿ç”¨<code>readPorts</code>è¿™ä¸ªé”®å€¼ï¼Œä»¥è·å–å†™åœ¨ports.jsonä¸­çš„æ•°æ®ã€‚<code>readPorts</code>ä¸‹é¢å®šä¹‰çš„<code>getPortsã€getAllPorts</code>æ˜¯å¦å¤–ä¸¤ä¸ªå¯ç”¨çš„è‡ªå®šä¹‰é”®å€¼ã€‚</p>
<p>è‡ªåŠ¨å‘ç°éœ€ç›‘æ§çš„æœåŠ¡/ç«¯å£ï¼Œéš¾ç‚¹ä¸åœ¨äºè¯»å–ï¼Œè€Œåœ¨äºè‡ªåŠ¨ç”Ÿæˆjsonæ•°æ®æ–‡ä»¶ã€‚æ­¤å¤„çš„ports.jsonæ˜¯æ ¹æ®ports.iniè½¬æ¢è€Œæ¥çš„ã€‚</p>
<p>ports.iniæ–‡ä»¶éœ€äººå·¥å¡«å†™ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552295007248.png" alt="1552295007248"></p>
<p>getPorts.pyè„šæœ¬å¦‚ä¸‹ï¼Œç”¨äºè½¬æ¢ports.iniä¸ºports.jsonï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="keyword">import</span> os, json, re</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mypath = os.path.dirname(os.path.realpath(__file__))</span><br><span class="line">port_list = []</span><br><span class="line">port_dict = &#123;<span class="string">"data"</span>:<span class="literal">None</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'%s/ports.ini'</span> % mypath, <span class="string">'r'</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> f.readlines():</span><br><span class="line">        line = line.strip()</span><br><span class="line">        <span class="keyword">if</span> line:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                port_srv = line.split(<span class="string">':'</span>)</span><br><span class="line">                port_list.append(&#123;<span class="string">"&#123;#TCP_PORT&#125;"</span>: port_srv[<span class="number">1</span>].strip(),</span><br><span class="line">                                  <span class="string">"&#123;#SERVICE&#125;"</span>: port_srv[<span class="number">0</span>].strip()&#125;)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">port_dict[<span class="string">"data"</span>] = port_list</span><br><span class="line">json_str = json.dumps(port_dict, sort_keys=<span class="literal">True</span>, indent=<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># json_strå·²æ˜¯jsonå­—ç¬¦ä¸²ï¼Œä½†æ¯è¡Œå°¾éƒ¨æœ‰ä¸€ä¸ªå¤šä½™çš„ç©ºæ ¼ï¼Œzabbixä¸æ¥å—ï¼Œé¡»åˆ é™¤è¡Œå°¾ç©ºæ ¼</span></span><br><span class="line">p = re.compile(<span class="string">"\s+$"</span>)</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> json_str.split(<span class="string">'\n'</span>):</span><br><span class="line">    ss = re.sub(p, <span class="string">""</span>, line)</span><br><span class="line">    <span class="keyword">print</span> ss</span><br></pre></td></tr></table></figure>
<p>è½¬æ¢ports.iniä¸ºjsonå½¢å¼ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552294366863.png" alt="1552294366863"></p>
<p>è‡³äºgetAllPorts.pyï¼Œå®ƒçš„åŠŸèƒ½æ˜¯ç›´æ¥è¿”å›ä¸»æœºä¸Šå®é™…å¼€æ”¾çš„ç«¯å£æ•°æ®ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-discovery-rule.assets/1552294862652.png" alt="1552294862652"></p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Zabbix</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbixçš„å®‰è£…ä¸ä½¿ç”¨</title>
    <url>/monitoring/zabbix/zabbix-intro/</url>
    <content><![CDATA[<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><hr>
<blockquote>
<p>Linuxç¯å¢ƒï¼šCentOS Linux release 7.5.1804 (Core)</p>
</blockquote>
<h3 id="1-å®‰è£…MySQL"><a href="#1-å®‰è£…MySQL" class="headerlink" title="1. å®‰è£…MySQL"></a>1. å®‰è£…MySQL</h3><ul>
<li>å®‰è£…mariadb</li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">yum -y install mariadb mariadb-server mariadb-devel</span><br><span class="line">systemctl start mariadb</span><br><span class="line">systemctl <span class="built_in">enable</span> mariadb</span><br><span class="line">mysql_secure_installation <span class="comment"># é€šè¿‡mysqlé…ç½®å‘å¯¼å®ŒæˆæŸäº›è®¾ç½®ï¼Œä¹Ÿå¯é€šè¿‡ä¿®æ”¹è¡¨çš„æ–¹å¼å®Œæˆè®¾ç½®</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<ul>
<li>é…ç½®å­—ç¬¦é›†</li>
</ul>
<p>åœ¨/etc/my.cnfçš„[mysqld]ä¸‹æ·»åŠ ï¼š</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="attr">init_connect</span>=<span class="string">'SET collation_connection = utf8_unicode_ci'</span></span><br><span class="line"><span class="attr">init_connect</span>=<span class="string">'SET NAMES utf8'</span></span><br><span class="line"><span class="attr">character-set-server</span>=utf8</span><br><span class="line"><span class="attr">collation-server</span>=utf8_unicode_ci</span><br><span class="line">skip-character-set-client-handshake</span><br></pre></td></tr></table></figure>
<p>åœ¨/etc/my.cnf.d/client.cnfçš„[client]ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">default-character-set</span>=utf8</span><br></pre></td></tr></table></figure>
<p>åœ¨/etc/my.cnf.d/<a href="https://www.centos.bz/tag/mysql-2/" rel="external nofollow noopener noreferrer" target="_blank">mysql</a>-clients.cnfçš„[mysql]ä¸­æ·»åŠ ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">default-character-set</span>=utf8</span><br></pre></td></tr></table></figure>
<p>é‡å¯ä½¿ç”Ÿæ•ˆï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">systemctl restart mariadb</span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹å­—ç¬¦é›†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">MariaDB [(none)]&gt; show variables like &quot;%character%&quot;;</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| Variable_name            | Value                      |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">| character_set_client     | utf8                       |</span><br><span class="line">| character_set_connection | utf8                       |</span><br><span class="line">| character_set_database   | utf8                       |</span><br><span class="line">| character_set_filesystem | binary                     |</span><br><span class="line">| character_set_results    | utf8                       |</span><br><span class="line">| character_set_server     | utf8                       |</span><br><span class="line">| character_set_system     | utf8                       |</span><br><span class="line">| character_sets_dir       | /usr/share/mysql/charsets/ |</span><br><span class="line">+--------------------------+----------------------------+</span><br><span class="line">8 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show variables like &quot;%collation%&quot;;</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">| Variable_name        | Value           |</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">| collation_connection | utf8_general_ci |</span><br><span class="line">| collation_database   | utf8_general_ci |</span><br><span class="line">| collation_server     | utf8_general_ci |</span><br><span class="line">+----------------------+-----------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>MySQLçš„å®‰è£…åŠé…ç½®å®Œæˆã€‚</p>
<hr>
<h3 id="2-å®‰è£…Zabbix"><a href="#2-å®‰è£…Zabbix" class="headerlink" title="2. å®‰è£…Zabbix"></a>2. å®‰è£…Zabbix</h3><p>Zabbixå®‰è£…æ­¥éª¤è§ï¼š<a href="https://www.zabbix.com/download?zabbix=3.0&amp;os_distribution=centos&amp;os_version=7&amp;db=mysql" rel="external nofollow noopener noreferrer" target="_blank">CentOS 7å®‰è£…zabbix 3.0</a>ï¼ŒåŸºäºRPMæ–¹å¼å®‰è£…Zabbix 3.0.25ã€‚</p>
<p><em>å¦‚æœæƒ³é€šè¿‡ç¼–è¯‘æºç å®‰è£…ï¼Œå¯å‚è€ƒ<a href="https://github.com/zlzgithub/docs/blob/master/zabbix/make-install-zabbix.md" rel="external nofollow noopener noreferrer" target="_blank">Zabbixæºç å®‰è£…è¿‡ç¨‹è®°å½•</a>ã€‚</em></p>
<p>å¦å¤–ï¼Œå®‰è£…zabbix_getä»¥ä¾¿æµ‹è¯•ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@VM_0_6_centos ~]<span class="comment"># yum install zabbix-get</span></span><br><span class="line"><span class="comment"># æ·»åŠ ç›‘æ§é¡¹æ—¶ï¼Œå¯åœ¨zabbix_serverä¸Šé€šè¿‡zabbix_getæµ‹è¯•å‘½ä»¤æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">[root@VM_0_6_centos ~]<span class="comment"># zabbix_get -s 188.131.133.107 -k vfs.fs.size[/,pused]</span></span><br><span class="line">17.268719</span><br></pre></td></tr></table></figure>
<p>åœ¨å®‰è£…å®Œzabbixä¹‹åï¼Œéœ€åœ¨MySQLä¸­åˆ›å»ºzabbixæ•°æ®åº“å¹¶å¯¼å…¥åˆå§‹æ•°æ®è¡¨ã€‚</p>
<p>å®‰è£…é…ç½®å®Œæˆå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡åï¼Œä»¥<code>http://&lt;zabbix_server_ip&gt;/zabbix</code>è®¿é—®zabbixæ§åˆ¶é¢æ¿ï¼Œåˆå§‹ç”¨æˆ·å/å¯†ç ä¸ºï¼šAdmin/zabbixã€‚</p>
<hr>
<h3 id="3-Zabbixç›‘æ§"><a href="#3-Zabbixç›‘æ§" class="headerlink" title="3. Zabbixç›‘æ§"></a>3. Zabbixç›‘æ§</h3><p>ä»¥ä¸‹æ·»åŠ ä¸€ä¸ª<strong>è¢«ç›‘æ§ä¸»æœº</strong>cvm001ï¼Œç›‘æ§å…¶cpuã€ç£ç›˜ã€80ç«¯å£ç­‰ã€‚</p>
<table>
<thead>
<tr>
<th>ä¸»æœº</th>
<th>ç›‘æ§é¡¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>cvm001</td>
<td>cpu å¹³å‡è´Ÿè½½ã€cpu ä¸Šä¸‹æ–‡åˆ‡æ¢é¢‘ç‡</td>
</tr>
<tr>
<td>cvm001</td>
<td>æ ¹åˆ†åŒºå‰©ä½™ç©ºé—´ç™¾åˆ†æ¯”</td>
</tr>
<tr>
<td>cvm001</td>
<td>80ç«¯å£çŠ¶æ€ï¼ˆhttpdæœåŠ¡ï¼‰</td>
</tr>
<tr>
<td>cvm001</td>
<td>mysqlè¿›ç¨‹æ•°</td>
</tr>
</tbody>
</table>
<h4 id="3-1-æ·»åŠ ä¸»æœº"><a href="#3-1-æ·»åŠ ä¸»æœº" class="headerlink" title="3.1 æ·»åŠ ä¸»æœº"></a>3.1 æ·»åŠ ä¸»æœº</h4><p>ã€é…ç½®ã€‘&gt;ã€ä¸»æœºã€‘&gt;ã€åˆ›å»ºä¸»æœºã€‘ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551234474023.png" alt="1551234474023"></p>
<h4 id="3-2-æ·»åŠ ç›‘æ§é¡¹"><a href="#3-2-æ·»åŠ ç›‘æ§é¡¹" class="headerlink" title="3.2 æ·»åŠ ç›‘æ§é¡¹"></a>3.2 æ·»åŠ ç›‘æ§é¡¹</h4><p>ã€é…ç½®ã€‘&gt;ã€ä¸»æœºã€‘ï¼Œåœ¨åˆšåˆšæ–°åŠ çš„ä¸»æœºæ‰€åœ¨è¡Œï¼Œã€ç›‘æ§é¡¹ã€‘&gt;ã€åˆ›å»ºç›‘æ§é¡¹ã€‘ï¼š</p>
<p>1ï¼‰CPUè´Ÿè½½</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551235105076.png" alt="1551235105076"></p>
<p>è®¾ç½®å†å²æ•°æ®ä¿ç•™7å¤©ï¼Œå¹¶ä¸ºcpuç›¸å…³çš„ç›‘æ§å®šä¹‰äº†ä¸€ä¸ªåä¸ºcpuçš„åº”ç”¨é›†ã€‚</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551235235750.png" alt="1551235235750"></p>
<p>2ï¼‰CPUä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551235576710.png" alt="1551235576710"></p>
<p>å‚¨å­˜å€¼é€‰æ‹©â€œå·®é‡ï¼ˆæ¯ç§’é€Ÿç‡ï¼‰â€ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551260458874.png" alt="1551260458874"></p>
<p>3ï¼‰æ ¹åˆ†åŒºä½¿ç”¨ç‡</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551235817902.png" alt="1551235817902"></p>
<p>â€œpusedâ€è¡¨ç¤ºå·²ä½¿ç”¨ç©ºé—´æ‰€å ç™¾åˆ†æ¯”ã€‚</p>
<p>4ï¼‰mysqlçš„è¿›ç¨‹</p>
<p>é€šè¿‡<code>proc.num[mysqld,mysql]</code>è·å–ç”¨æˆ·mysqlçš„è¿›ç¨‹mysqldçš„æ•°ç›®ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551236027506.png" alt="1551236027506"></p>
<p>5ï¼‰80ç«¯å£çŠ¶æ€</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551236331993.png" alt="1551236331993"></p>
<p>æŸ¥çœ‹å€¼é€‰æ‹©çš„æ˜¯Service stateï¼Œæ­£å¸¸çŠ¶æ€å€¼æ˜¯â€Upâ€ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551236436165.png" alt="1551236436165"></p>
<p>å¦‚ä¸‹å›¾ï¼Œå·²æ·»åŠ å®Œä¸Šé¢çš„5ä¸ªç›‘æ§é¡¹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551236245002.png" alt="1551236245002"></p>
<p>æŸ¥çœ‹æœ€æ–°ç›‘æ§æ•°æ®å¦‚ä¸‹ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551236816850.png" alt="1551236816850"></p>
<p>æŸ¥çœ‹cpuä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°çš„ã€å›¾å½¢ã€‘ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551237146452.png" alt="1551237146452"></p>
<p><em>å›¾è¡¨æ ‡é¢˜ä¸­æ–‡å­—ç¬¦æ˜¾ç¤ºä¸å‡ºæ¥ï¼Œæ˜¯å­—ä½“çš„åŸå› ï¼Œå¯è‡ªè¡Œæ›¿æ¢ï¼Œæ­¤å¤„ä»ç•¥ã€‚</em></p>
<h4 id="3-3-åˆ›å»ºè§¦å‘å™¨"><a href="#3-3-åˆ›å»ºè§¦å‘å™¨" class="headerlink" title="3.3 åˆ›å»ºè§¦å‘å™¨"></a>3.3 åˆ›å»ºè§¦å‘å™¨</h4><p>ã€é…ç½®ã€‘&gt;ã€ä¸»æœºã€‘ï¼Œä¸»æœºæ‰€åœ¨è¡Œçš„ã€è§¦å‘å™¨ã€‘&gt;ã€åˆ›å»ºè§¦å‘å™¨ã€‘ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551260715724.png" alt="1551260715724"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551249076606.png" alt="1551249076606"></p>
<h4 id="3-4-è‡ªå®šä¹‰æŠ¥è­¦åª’ä»‹"><a href="#3-4-è‡ªå®šä¹‰æŠ¥è­¦åª’ä»‹" class="headerlink" title="3.4 è‡ªå®šä¹‰æŠ¥è­¦åª’ä»‹"></a>3.4 è‡ªå®šä¹‰æŠ¥è­¦åª’ä»‹</h4><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551248906136.png" alt="1551248906136"></p>
<p>å†™ä¸€ä¸ªæ¨¡æ‹ŸæŠ¥è­¦è„šæœ¬å¦‚ä¸‹ï¼Œæ”¾ç½®åœ¨<code>/usr/lib/zabbix/alertscripts/myAlert.sh</code>:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line">alert_path=/var/www/html/myalert</span><br><span class="line">mkdir -p <span class="variable">$alert_path</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="title">gen_html</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span><span class="string">"&lt;html&gt;</span></span><br><span class="line"><span class="string">    &lt;head&gt;&lt;/head&gt;</span></span><br><span class="line"><span class="string">    &lt;body&gt;</span></span><br><span class="line"><span class="string">    &lt;h1&gt;Alert&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;pre&gt;</span></span><br><span class="line"><span class="string">    "</span><span class="string">""</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"SENDTO:<span class="variable">$1</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"SUBJECT:<span class="variable">$2</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"MESSAGE:<span class="variable">$3</span>"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">""</span><span class="string">"</span></span><br><span class="line"><span class="string">    &lt;/pre&gt;</span></span><br><span class="line"><span class="string">    &lt;/body&gt;</span></span><br><span class="line"><span class="string">    &lt;/html&gt;"</span><span class="string">""</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">gen_html <span class="variable">$@</span> &gt; <span class="variable">$alert_path</span>/1.html</span><br><span class="line">chmod -R 755 <span class="variable">$alert_path</span></span><br></pre></td></tr></table></figure>
<p>å¹¶ä¿®æ”¹/etc/zabbix/zabbix_server.confé…ç½®ï¼š</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="attr">AllowRoot</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">User</span>=root</span><br></pre></td></tr></table></figure>
<h4 id="3-5-ç”¨æˆ·-å‘Šè­¦ç»‘å®š"><a href="#3-5-ç”¨æˆ·-å‘Šè­¦ç»‘å®š" class="headerlink" title="3.5 ç”¨æˆ·-å‘Šè­¦ç»‘å®š"></a>3.5 ç”¨æˆ·-å‘Šè­¦ç»‘å®š</h4><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551249389835.png" alt="1551249389835"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551255673570.png" alt="1551255673570"></p>
<h4 id="3-6-åˆ›å»ºåŠ¨ä½œ"><a href="#3-6-åˆ›å»ºåŠ¨ä½œ" class="headerlink" title="3.6 åˆ›å»ºåŠ¨ä½œ"></a>3.6 åˆ›å»ºåŠ¨ä½œ</h4><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551249482028.png" alt="1551249482028"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551249617900.png" alt="1551249617900"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551249780128.png" alt="1551249780128"></p>
<h4 id="3-7-æ¨¡æ‹ŸæŠ¥è­¦"><a href="#3-7-æ¨¡æ‹ŸæŠ¥è­¦" class="headerlink" title="3.7 æ¨¡æ‹ŸæŠ¥è­¦"></a>3.7 æ¨¡æ‹ŸæŠ¥è­¦</h4><p>æ¨¡æ‹ŸæŠ¥è­¦æ¡ä»¶ï¼š</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å‡è®¾å½“å‰å ç”¨ç‡19%ï¼Œå†™ä¸€ä¸ªå¤§å°çº¦1GBçš„æ–‡ä»¶ï¼Œä½¿æ ¹åˆ†åŒºå ç”¨ç‡ &gt; 20% è¾¾åˆ°è§¦å‘æŠ¥è­¦</span></span><br><span class="line">[root@VM_0_7_centos ~]<span class="comment"># dd if=/dev/zero bs=1024 count=1000000 of=/root/1Gb.file</span></span><br></pre></td></tr></table></figure>
<p>æŸ¥çœ‹ç›‘æ§å›¾å½¢ï¼ˆè®¾å®šçš„é˜ˆå€¼æ˜¯16%ï¼‰ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551241908732.png" alt="1551241908732"></p>
<p>æŸ¥çœ‹è§¦å‘å™¨çŠ¶æ€ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551241947776.png" alt="1551241947776"></p>
<p>æŸ¥çœ‹äº‹ä»¶è®°å½•ï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551250126172.png" alt="1551250126172"></p>
<p>æŸ¥çœ‹æŠ¥è­¦é€šçŸ¥ç»“æœï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551252223032.png" alt="1551252223032"></p>
<p>å½“æŠ¥è­¦è§£é™¤åï¼š</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2019/zabbix-intro.assets/1551253201767.png" alt="1551253201767"></p>
<p>ç»æµ‹è¯•ï¼ŒæŠ¥è­¦æœºåˆ¶æ­£å¸¸ã€‚æ­£å¼ç¯å¢ƒä¸­ï¼Œé…ç½®å†…ç½®çš„Emailæˆ–SMSæŠ¥è­¦åª’ä»‹ï¼Œæˆ–ä½¿ç”¨è‡ªå®šä¹‰çš„é‚®ä»¶ã€å¾®ä¿¡ã€çŸ­ä¿¡å‘Šè­¦è„šæœ¬ç­‰æ›¿ä»£ã€‚</p>
<hr>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://www.zabbix.com/documentation/3.0/manual/quickstart" rel="external nofollow noopener noreferrer" target="_blank">zabbix 3.0 quickstart</a></p>
<hr>
<p>ï¼ˆEnd)</p>
]]></content>
      <categories>
        <category>ç›‘æ§</category>
      </categories>
      <tags>
        <tag>Zabbix</tag>
      </tags>
  </entry>
</search>
