<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">
<meta name="viewport" content="width=device-width">
<meta name="google-site-verification" content="V4j2XKWJOKRE9YZT6Bh0vioT5VWrnimuwjmS6cyIuJ8">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="K8s,">










<meta name="description" content="Kubernetes (K8s) is an open-source system for automating deployment, scaling, and management of containerized applications. Kubernetes (K8s) 是一个开源容器编排引擎，用于自动化容器化应用程序的部署，扩展和管理。">
<meta name="keywords" content="K8s">
<meta property="og:type" content="article">
<meta property="og:title" content="K8s笔记">
<meta property="og:url" content="https://lzzeng.github.io/2020/K8s-learning/index.html">
<meta property="og:site_name" content="Zeng&#39;s Page">
<meta property="og:description" content="Kubernetes (K8s) is an open-source system for automating deployment, scaling, and management of containerized applications. Kubernetes (K8s) 是一个开源容器编排引擎，用于自动化容器化应用程序的部署，扩展和管理。">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/container_evolution.svg">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/k8s-arch.jpg">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551840932234.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551841031094.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551844009517.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115174122445.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108222956832.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108223045757.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114225536299.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114225653905.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114215421923.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114220715630.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114221430793.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114221127406.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115203204927.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115205626768.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115210018640.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115174901221.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115175558607.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231530048.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231740085.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231813394.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231851088.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114232414808.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114232526869.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114233931967.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114234101500.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115215750674.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115220103135.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115201737742.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115213549982.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115214009131.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115220412264.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/v2-784c512e37755bcfd6c4ebb63dcbb866_720w.jpg">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/v2-e11d1a3fef7f0bab2ce64a8f721360bd_r.jpg">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108220655920.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115221020820.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230301979.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230446082.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230811684.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108202423148.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201109005053678.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108203029458.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108213925801.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108234036126.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115001019175.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115022804654.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115173012548.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108222828848.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108223522500.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108164730437.png">
<meta property="og:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108165325479.png">
<meta property="og:updated_time" content="2022-02-20T15:52:53.676Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="K8s笔记">
<meta name="twitter:description" content="Kubernetes (K8s) is an open-source system for automating deployment, scaling, and management of containerized applications. Kubernetes (K8s) 是一个开源容器编排引擎，用于自动化容器化应用程序的部署，扩展和管理。">
<meta name="twitter:image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/container_evolution.svg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":true},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://lzzeng.github.io/2020/K8s-learning/">





  <title>K8s笔记 | Zeng's Page</title>
  








  <script src="/js/src/photoswipe.js?v=5.1.4"></script>
  <script src="/js/src/photoswipe-ui-default.js?v=5.1.4"></script>
</head>

<body itemscope itemtype="https://schema.org/WebPage" lang="default">

  

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="https://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zeng's Page</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-photos">
          <a href="/photos/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-photo"></i> <br>
            
            相册
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="https://schema.org/Article">
  
  
  
  <div class="post-block" id="container">
    <link itemprop="mainEntityOfPage" href="https://lzzeng.github.io/2020/K8s-learning/">

    <span hidden itemprop="author" itemscope itemtype="https://schema.org/Person">
      <meta itemprop="name" content="Lz. Zeng">
      <meta itemprop="description" content>
      <meta itemprop="image" content="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization">
      <meta itemprop="name" content="Zeng's Page">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">K8s笔记</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-29T22:55:40+00:00">
                2020-10-29
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/DevOps/" itemprop="url" rel="index">
                    <span itemprop="name">DevOps</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          		 

        </div>
      </header>
    	
	
	
		<script type="text/javascript">
			function showToc(){
				var toc_article = document.getElementById("toc-article");
				var show_toc_btn = document.getElementById("show-toc-btn");			
				toc_article.setAttribute("style","display:block");
				show_toc_btn.setAttribute("style","display:none");
			};
			function showBtn(){
				var toc_article = document.getElementById("toc-article");
				var show_toc_btn = document.getElementById("show-toc-btn");
				toc_article.setAttribute("style","display:none");
				show_toc_btn.setAttribute("style","display:block");
			};
		</script>
		
		<div id="my-toc">
			<p class="show-toc-btn" id="show-toc-btn" onclick="showToc();">
				<span class="btn-bg"></span>
				<span class="btn-text">目录</span>
			</p>
			<div id="toc-article" class="toc-article" style="display:none">
				<span id="toc-close" class="toc-close" title="隐藏" onclick="showBtn();">×</span>
				<strong class="toc-title">文章目录</strong>
				<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#安装K8s"><span class="toc-number">1.</span> <span class="toc-text">安装K8s</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm"><span class="toc-number">1.1.</span> <span class="toc-text">kubeadm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rancher"><span class="toc-number">1.2.</span> <span class="toc-text">rancher</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rke"><span class="toc-number">1.3.</span> <span class="toc-text">rke</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubespray"><span class="toc-number">1.4.</span> <span class="toc-text">kubespray</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装-kubernetes-dashboard"><span class="toc-number">2.</span> <span class="toc-text">安装 kubernetes dashboard</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#K8s基础"><span class="toc-number">3.</span> <span class="toc-text">K8s基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基础概念"><span class="toc-number">3.1.</span> <span class="toc-text">基础概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod"><span class="toc-number">3.1.1.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Namespace"><span class="toc-number">3.1.2.</span> <span class="toc-text">Namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Label"><span class="toc-number">3.1.3.</span> <span class="toc-text">Label</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Service"><span class="toc-number">3.1.4.</span> <span class="toc-text">Service</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Replication-Controller"><span class="toc-number">3.1.5.</span> <span class="toc-text">Replication Controller</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Deployment"><span class="toc-number">3.1.6.</span> <span class="toc-text">Deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#演示-——-Deployment-扩容"><span class="toc-number">3.1.6.1.</span> <span class="toc-text">演示 —— Deployment 扩容</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Horizontal-Pod-Autoscaler"><span class="toc-number">3.1.7.</span> <span class="toc-text">Horizontal Pod Autoscaler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#StatefulSet"><span class="toc-number">3.1.8.</span> <span class="toc-text">StatefulSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DaemonSet"><span class="toc-number">3.1.9.</span> <span class="toc-text">DaemonSet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Job"><span class="toc-number">3.1.10.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Volume"><span class="toc-number">3.1.11.</span> <span class="toc-text">Volume</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Persistent-Volume"><span class="toc-number">3.1.12.</span> <span class="toc-text">Persistent Volume</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Persistent-Volume-Claim"><span class="toc-number">3.1.13.</span> <span class="toc-text">Persistent Volume Claim</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Annotation"><span class="toc-number">3.1.14.</span> <span class="toc-text">Annotation</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigMap"><span class="toc-number">3.1.15.</span> <span class="toc-text">ConfigMap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RBAC"><span class="toc-number">3.1.16.</span> <span class="toc-text">RBAC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ingress"><span class="toc-number">3.1.17.</span> <span class="toc-text">ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#secret"><span class="toc-number">3.1.18.</span> <span class="toc-text">secret</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#组件"><span class="toc-number">3.2.</span> <span class="toc-text">组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#API-Server"><span class="toc-number">3.2.1.</span> <span class="toc-text">API Server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Controller-Manager"><span class="toc-number">3.2.2.</span> <span class="toc-text">Controller Manager</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Scheduler"><span class="toc-number">3.2.3.</span> <span class="toc-text">Scheduler</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubelet"><span class="toc-number">3.2.4.</span> <span class="toc-text">kubelet</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kube-proxy"><span class="toc-number">3.2.5.</span> <span class="toc-text">kube-proxy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#案例-——-部署myweb至K8s"><span class="toc-number">4.</span> <span class="toc-text">案例 —— 部署myweb至K8s</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#重制镜像"><span class="toc-number">4.1.</span> <span class="toc-text">重制镜像</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#推送镜像至harbor"><span class="toc-number">4.2.</span> <span class="toc-text">推送镜像至harbor</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建K8s资源对象"><span class="toc-number">4.3.</span> <span class="toc-text">创建K8s资源对象</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#namespace"><span class="toc-number">4.3.1.</span> <span class="toc-text">namespace</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#configmap"><span class="toc-number">4.3.2.</span> <span class="toc-text">configmap</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#secret-1"><span class="toc-number">4.3.3.</span> <span class="toc-text">secret</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#deployment、service和ingress"><span class="toc-number">4.3.4.</span> <span class="toc-text">deployment、service和ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubectl-create"><span class="toc-number">4.3.5.</span> <span class="toc-text">kubectl create</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#使用-helm-与-harbor"><span class="toc-number">5.</span> <span class="toc-text">使用 helm 与 harbor</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#使用helm"><span class="toc-number">5.1.</span> <span class="toc-text">使用helm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用harbor"><span class="toc-number">5.2.</span> <span class="toc-text">使用harbor</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#参考"><span class="toc-number">6.</span> <span class="toc-text">参考</span></a></li></ol>
			</div>
		</div>
	

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <hr>
<blockquote>
<p><em><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank">Kubernetes (K8s)</a> is an open-source system for automating deployment, scaling, and management of containerized applications.</em></p>
<p><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank"><strong>Kubernetes (K8s)</strong></a> 是一个开源容器编排引擎，用于自动化容器化应用程序的部署，扩展和管理。</p>
</blockquote>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/container_evolution.svg" alt="Deployment evolution"></p>
<a id="more"></a>
<p>应用部署方式的演变历史：物理机部署  =&gt; 虚拟机部署  =&gt; 容器化部署*</p>
<p>早期的应用是直接部署在物理机的，资源使用率不高。</p>
<p>举例来说，比如200qps，包含100个请求静态资源的请求和100个动态资源的请求，假设静态请求占用2M内存，动态请求占用10M内存，那么200qps占用内存约1200MB。如果服务器内存是4GB，那最高可以600qps左右，如果考虑CPU、带宽及其他资源的占用，可能实际最多支持300qps，按300qps的话，实际内存利用率就不高了。</p>
<p>虚拟机技术的出现，可以将高规格的物理服务器隔离成多个小规格的虚拟机，能更好地利用系统资源。而且，虚拟机之间有严格的隔离，为不同的应用提供了相对独立的运行环境，仅通过网络相互访问，安全性也更高了。</p>
<p>容器技术，是一种更加轻量级的虚拟化技术。尽管在资源隔离上不如虚拟机严格，但其它方面的优势也很明显。</p>
<p>容器可以运行在虚拟机里面。</p>
<p>似乎可以这么理解，以OpenStack为代表的云计算技术产生了公有云，而以K8s为代表的容器云技术则在公有云提供的基础设施之上构建出了容器云。</p>
<p>架构简图：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/k8s-arch.jpg" alt="img"></p>
<p>master节点包含的组件：</p>
<p><strong>API Server</strong>：是k8s最核心的组件，统一的资源操作入口，包括提供认证、授权、访问控制、API注册和 发现等机制，其他的组件运行依赖于api server，通过api接口可以对k8s资源对象进行curd以及监控，也能进行健康，日志等监控。</p>
<p><strong>Scheduler</strong>：属于调度器的角色，负责决策pod按照哪种算法调度到哪个node上，它会把决策的信息通过ap iserver发送给kubelet，让kubelet执行。</p>
<p><strong>Controller-Manger</strong>：为了管理集群中不同的资源，k8s为不同的资源建立了对应的controller。k8s中分了8个controller,不同的 Controller 负责对不同资源的监控和管理。</p>
<p><strong>ETCD</strong> 一般也部署在master节点上，是k8s的key-value数据库，集群的状态信息都持久化存储在ETCD中。</p>
<p>worker节点包含的组件：</p>
<p><strong>kubelet</strong>：真正的容器管理和维护者，它根据master节点上shcedule的调度决策去真正控制节点上的容器，维护 Container 的生命周期，同时也负责存储（CSI）和网络（CNI）的管理。</p>
<p><strong>kube-proxy</strong>：集群内部通过kube-proxy访问其他pod,其主要功能是提供集群内部的服务发现和负载均衡功能。</p>
<h1 id="安装K8s"><a href="#安装K8s" class="headerlink" title="安装K8s"></a>安装K8s</h1><p>尝试过以下四种安装方式：kubeadm，rancher，rke 及 kubespray。</p>
<h2 id="kubeadm"><a href="#kubeadm" class="headerlink" title="kubeadm"></a>kubeadm</h2><p>官网提供的方法。大致过程是：</p>
<ul>
<li><p>初始化环境，安装docker</p>
</li>
<li><p>先在各个节点yum安装kubelet、kubeadm、kubectl</p>
</li>
<li><p>在一个master节点kubeadm init 获得kubeadm join集群的命令</p>
</li>
<li>在其它节点上执行kubeadm join命令加入集群</li>
</ul>
<h2 id="rancher"><a href="#rancher" class="headerlink" title="rancher"></a>rancher</h2><p>先通过docker启动一个rancher管理界面，然后从管理界面复制添加节点的命令，在待加入集群的节点上执行命令，逐个添加节点创建K8s集群。界面如下：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551840932234.png" alt="1551840932234"></p>
<h2 id="rke"><a href="#rke" class="headerlink" title="rke"></a>rke</h2><p>rancher官方提供的一个安装工具，通过一个节点配置文件描述集群各个节点信息。</p>
<p>例如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.79</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,worker,etcd]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.80</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,worker,etcd]</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">address:</span> <span class="number">192.168</span><span class="number">.100</span><span class="number">.81</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">rancher</span></span><br><span class="line">    <span class="attr">role:</span> <span class="string">[controlplane,etcd]</span></span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rke up --config  &lt;节点配置文件&gt;</span><br></pre></td></tr></table></figure>
<p>即可完成集群的初步安装，相比其它方式更快捷，但能安装的版本滞后于官网，最新的K8s版本可能尚未被rancher支持。</p>
<p>rancher集群管理界面类似下图：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551841031094.png" alt="1551841031094"></p>
<p>3个master、etcd + 3个node:</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/1551844009517.png" alt="1551844009517"></p>
<h2 id="kubespray"><a href="#kubespray" class="headerlink" title="kubespray"></a>kubespray</h2><blockquote>
<p>官方github:  <a href="https://github.com/kubernetes-sigs/kubespray/tree/release-2.14" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kubernetes-sigs/kubespray/tree/release-2.14</a></p>
</blockquote>
<p>这是一种通过ansible-playbook自动安装K8s的方式。默认和kubeadm一样需要能访问国外网站，否则有点镜像或二进制文件获取不到。也可自行修改相关地址，主要涉及以下几个文件：</p>
<ul>
<li>roles/download/defaults/main.yml</li>
<li><p>inventory/sample/group_vars/k8s-cluster/k8s-cluster.yml</p>
</li>
<li><p>roles/kubespray-defaults/defaults/main.yaml</p>
</li>
</ul>
<p>修改其中的地址，替换成国内能访问到的镜像源，安装应该就能顺利进行了。默认会一并安装dashboard。</p>
<p>其主机清单（inventory）文件格式如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[all]</span></span><br><span class="line"><span class="string">m01</span>    <span class="string">ansible_host=192.168.19.135</span> <span class="string">ip=192.168.19.135</span></span><br><span class="line"><span class="string">m02</span>    <span class="string">ansible_host=192.168.19.136</span> <span class="string">ip=192.168.19.136</span></span><br><span class="line"><span class="string">m03</span>    <span class="string">ansible_host=192.168.19.137</span> <span class="string">ip=192.168.19.137</span></span><br><span class="line"><span class="string">n01</span>    <span class="string">ansible_host=192.168.19.138</span> <span class="string">ip=192.168.19.138</span></span><br><span class="line"><span class="string">n02</span>    <span class="string">ansible_host=192.168.19.139</span> <span class="string">ip=192.168.19.139</span></span><br><span class="line"><span class="string">n03</span>    <span class="string">ansible_host=192.168.19.140</span> <span class="string">ip=192.168.19.140</span></span><br><span class="line"></span><br><span class="line"><span class="string">[kube-master]</span></span><br><span class="line"><span class="string">m01</span></span><br><span class="line"><span class="string">m02</span></span><br><span class="line"><span class="string">m03</span></span><br><span class="line"></span><br><span class="line"><span class="string">[etcd]</span></span><br><span class="line"><span class="string">m01</span></span><br><span class="line"><span class="string">m02</span></span><br><span class="line"><span class="string">m03</span></span><br><span class="line"></span><br><span class="line"><span class="string">[kube-node]</span></span><br><span class="line"><span class="string">n01</span></span><br><span class="line"><span class="string">n02</span></span><br><span class="line"><span class="string">n03</span></span><br><span class="line"></span><br><span class="line"><span class="string">[calico-rr]</span></span><br><span class="line"></span><br><span class="line"><span class="string">[k8s-cluster:children]</span></span><br><span class="line"><span class="string">kube-master</span></span><br><span class="line"><span class="string">kube-node</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115174122445.png" alt="image-20201115174122445" style="zoom:50%;"></p>
<p>安装命令</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost opt]<span class="comment"># cd kubespray</span></span><br><span class="line">[root@localhost kubespray]<span class="comment"># cp -r inventory/sample inventory/mycluster</span></span><br><span class="line">(修改某些无法获取到的镜像地址)</span><br><span class="line">[root@localhost kubespray]<span class="comment"># pip install -U pip</span></span><br><span class="line">[root@localhost kubespray]<span class="comment"># pip install -r requirements.txt</span></span><br><span class="line">[root@localhost kubespray]<span class="comment"># ansible-playbook -i inventory/mycluster/hosts.ini --become --become-user=root cluster.yml</span></span><br></pre></td></tr></table></figure>
<h1 id="安装-kubernetes-dashboard"><a href="#安装-kubernetes-dashboard" class="headerlink" title="安装 kubernetes dashboard"></a>安装 kubernetes dashboard</h1><blockquote>
<p>参考官方文档：<a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>
</blockquote>
<p>在集群已经安装成功的前提下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>
<p>获取登录令牌</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep kubernetes-dashboard-token|awk <span class="string">'&#123;print $1&#125;'</span>)|grep token:|awk <span class="string">'&#123;print $2&#125;'</span></span><br></pre></td></tr></table></figure>
<p>访问</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://&lt;master节点ip&gt;:6443/api/v1/namespaces/kube-system/services/https:kubernetes-dashboard:/proxy/</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108222956832.png" alt="image-20201108222956832"></p>
<p>或者绑定域名访问（涉及ingress）</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108223045757.png" alt="image-20201108223045757"></p>
<p>首页</p>
<hr>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114225536299.png" alt="image-20201114225536299"></p>
<p>myweb名称空间</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114225653905.png" alt="image-20201114225653905"></p>
<h1 id="K8s基础"><a href="#K8s基础" class="headerlink" title="K8s基础"></a>K8s基础</h1><p>本文涉及K8s操作的部分是在如下K8s环境中进行的：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">[root@m01 ~]<span class="comment"># kubectl get nodes -o wide</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114215421923.png" alt="image-20201114215421923"></p>
<h2 id="基础概念"><a href="#基础概念" class="headerlink" title="基础概念"></a>基础概念</h2><p>Kubernetes里的所有资源对象都可以采用YAML或者JSON格式的文件来定义或描述。</p>
<h3 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h3><p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114220715630.png" alt="image-20201114220715630" style="zoom: 50%;"></p>
<p>Pod是Kubernetes最重要的基本概念。</p>
<p>每个Pod都有一个特殊的被称为“根容器”的Pause容器。Pause容器对应的镜像属于Kubernetes平台的一部分，除了Pause容器，每个Pod还包含一个或多个紧密相关的用户业务容器。</p>
<p>在初始化每一个pod容器的时候，都会生成一个pause容器。这个容器使得pod里面的子容器能够共享网络和存储，方便内部容器之间的调用。</p>
<font color="red">为什么Kubernetes把Pod设计成这样的特殊结构？</font>

<ul>
<li><p>在一组容器作为一个单元的情况下，我们难以简单地对“整体”进行判断及有效地行动。比如，一个容器死亡了，此时算是整体死亡么？是N/M的死亡率么？引入业务无关并且不易死亡的Pause容器作为Pod的根容器，以它的状态代表整个容器组的状态，就简单、巧妙地解决了这个难题。</p>
</li>
<li><p>Pod里的多个业务容器共享Pause容器的IP，共享Pause容器挂接的Volume，这样既简化了密切关联的业务容器之间的通信问题，也很好地解决了它们之间的文件共享问题。</p>
</li>
</ul>
<p>在Kubernetes系统中对长时间运行容器的要求是：其主程序需要一直在前台执行。对于无法改造为前台执行的应用，也可以使用开源工具Supervisor辅助进行前台运行的功能。Supervisor提供了一种可以同时启动多个后台应用，并保持Supervisor自身在前台执行的机制，可以满足Kubernetes对容器的启动要求。</p>
<p>Pod IP</p>
<p>Kubernetes为每个Pod都分配了唯一的IP地址，称之为Pod IP，一个Pod里的多个容器共享Pod IP地址。Kubernetes要求底层网络支持集群内任意两个Pod之间的TCP/IP直接通信，这通常采用虚拟二层网络技术来实现，例如Flannel、Open vSwitch等，因此在Kubernetes里一个Pod里的容器与另外主机上的Pod容器能够直接通信。</p>
<p>Pod事件</p>
<p>Event是一个事件的记录，记录了事件的最早产生时间、最后重现时间、重复次数、发起者、类型，以及导致此事件的原因等众多信息。</p>
<p>Pod资源配额</p>
<p>Kubernetes里通常以千分之一的CPU配额为最小单位，用m来表示。通常一个容器的CPU配额被定义为100～300m，即占用0.1～0.3个CPU。</p>
<p>在Kubernetes里，一个计算资源进行配额限定时需要设定以下两个参数：</p>
<ul>
<li>Requests：该资源的最小申请量，系统必须满足要求。</li>
<li>Limits：该资源最大允许使用的量，不能被突破，当容器试图使用超过这个量的资源时，可能会被Kubernetes“杀掉”并重启。</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114221430793.png" alt="image-20201114221430793" style="zoom: 67%;"></p>
<p>普通Pod</p>
<p>Pod其实有两种类型：普通的Pod及静态Pod（Static Pod）。后者比较特殊，它并没被存放在Kubernetes的etcd存储里，而是被存放在某个具体的Node上的一个具体文件中，并且只在此Node上启动、运行。而普通的Pod一旦被创建，就会被放入etcd中存储，随后会被Kubernetes Master调度到某个具体的Node上并进行绑定（Binding），随后该Pod被对应的Node上的kubelet进程实例化成一组相关的Docker容器并启动。在默认情况下，当Pod里的某个容器停止时，Kubernetes会自动检测到这个问题并且重新启动这个Pod（重启Pod里的所有容器），如果Pod所在的Node宕机，就会将这个Node上的所有Pod重新调度到其他节点上。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114221127406.png" alt="image-20201114221127406" style="zoom: 67%;"></p>
<p>静态Pod</p>
<blockquote>
<p>静态Pod是由kubelet进行管理的仅存在于特定Node上的Pod。它们不能通过API Server进行管理，无法与ReplicationController、Deployment或者DaemonSet进行关联，并且kubelet无法对它们进行健康检查。静态Pod总是由kubelet创建的，并且总在kubelet所在的Node上运行。</p>
<p>创建静态Pod有两种方式：配置文件方式和HTTP方式。</p>
</blockquote>
<p>Pod内的存储与通信</p>
<p>属于同一个Pod的多个容器应用之间相互访问时仅需要通过localhost就可以通信。</p>
<p>同一个Pod中的多个容器能够共享Pod级别的存储卷Volume。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115203204927.png" alt="image-20201115203204927" style="zoom:50%;"></p>
<p>Pod的几种状态</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115205626768.png" alt="image-20201115205626768"></p>
<p>Pod的重启策略包括Always、OnFailure 和 Never，默认值为Always。</p>
<ul>
<li>Always：当容器失效时，由kubelet自动重启该容器。</li>
<li>OnFailure：当容器终止运行且退出码不为0时，由kubelet自动重启该容器。</li>
<li>Never：不论容器运行状态如何，kubelet都不会重启该容器。</li>
</ul>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115210018640.png" alt="image-20201115210018640"></p>
<p>每种控制器对Pod的重启策略要求如下：</p>
<ul>
<li><p>RC和DaemonSet：必须设置为Always，需要保证该容器持续运行。</p>
</li>
<li><p>Job：OnFailure或Never，确保容器执行完成后不再重启。</p>
</li>
<li>kubelet（管理静态pod时）：在Pod失效时自动重启它，不论将RestartPolicy设置为什么值，也不会对Pod进行健康检查。</li>
</ul>
<p>Pod的健康状态可以通过两类探针来检查： LivenessProbe和ReadinessProbe，kubelet定期执行这两类探针来诊断容器的健康状况。</p>
<p>（1）LivenessProbe探针：用于判断容器是否存活（Running状态），如果LivenessProbe探针探测到容器不健康，则kubelet将杀掉该容器，并根据容器的重启策略做相应的处理。如果一个容器不包含LivenessProbe探针，那么kubelet认为该容器的LivenessProbe探针返回的值永远是Success。</p>
<p>（2）ReadinessProbe探针：用于判断容器服务是否可用（Ready状态），达到Ready状态的Pod才可以接收请求。</p>
<p>对于被Service管理的Pod，Service与Pod Endpoint的关联关系也将基于Pod是否Ready进行设置。如果在运行过程中Ready状态变为False，则系统自动将其从Service的后端Endpoint列表中隔离出去，后续再把恢复到Ready状态的Pod加回后端Endpoint列表。这样就能保证客户端在访问Service时不会被转发到服务不可用的Pod实例上。</p>
<p>LivenessProbe和ReadinessProbe均可配置以下三种实现方式。</p>
<p>（1）ExecAction：在容器内部执行一个命令，如果该命令的返回码为0，则表明容器健康。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">exec:</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/tmp/health</span></span><br><span class="line">    <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">    <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>（2）TCPSocketAction：通过容器的IP地址和端口号执行TCP检查，如果能够建立TCP连接，则表明容器健康。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">tcpSocket:</span></span><br><span class="line">	<span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>（3）HTTPGetAction：通过容器的IP地址、端口号及路径调用HTTP Get方法，如果响应的状态码大于等于200且小于400，则认为容器健康。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/_status/healthz</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">30</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>对于每种探测方式，都需要设置initialDelaySeconds和timeoutSeconds两个参数：</p>
<ul>
<li>initialDelaySeconds：启动容器后进行首次健康检查的等待时间，单位为s。</li>
<li>timeoutSeconds：健康检查发送请求后等待响应的超时时间，单位为s。当超时发生时，kubelet会认为容器已经无法提供服务，将会重启该容器。</li>
</ul>
<p>Kubernetes的ReadinessProbe机制可能无法满足某些复杂应用对容器内服务可用状态的判断。</p>
<p>通过Pod Readiness Gates机制，用户可以将自定义的ReadinessProbe探测方式设置在Pod上，辅助Kubernetes设置Pod何时达到服务可用状态（Ready）。为了使自定义的ReadinessProbe生效，用户需要提供一个外部的控制器（Controller）来设置相应的Condition状态。</p>
<h3 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h3><p>Namespace（命名空间）是Kubernetes系统中的另一个非常重要的概念，Namespace在很多情况下用于实现多租户的资源隔离。如果不特别指明Namespace，则用户创建的Pod、RC、Service都将被系统创建到这个默认的名为default的Namespace中。</p>
<h3 id="Label"><a href="#Label" class="headerlink" title="Label"></a>Label</h3><p>Label（标签）也是Kubernetes系统中一个核心概念。</p>
<p>一个Label是一个key=value的键值对，其中key与value由用户自己指定。Label可以被附加到各种资源对象上，例如Node、Pod、Service、RC等，一个资源对象可以定义任意数量的Label，同一个Label也可以被添加到任意数量的资源对象上。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure>
<p>给某个资源对象定义一个Label，就相当于给它打了一个标签，随后可以通过Label Selector（标签选择器）查询和筛选拥有某些Label的资源对象。一些具体的例子：</p>
<ul>
<li>name = redis-slave：匹配所有具有标签name=redis-slave的资源对象。</li>
<li>env != production：匹配所有不具有标签env=production的资源对象，比如env=test就是满足此条件的标签之一。</li>
<li>name in（redis-master, redis-slave）：匹配所有具有标签name=redis-master或者name= redis-slave的资源对象。</li>
<li>name not in（php-frontend）：匹配所有不具有标签name=php-frontend的资源对象。</li>
</ul>
<p>管理对象RC和Service则通过Selector字段设置需要关联Pod的Label，其他管理对象如Deployment、ReplicaSet、DaemonSet和Job则可以在Selector中使用基于集合的筛选条件定义。</p>
<p>基于集合的筛选示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">selector:</span></span><br><span class="line">  <span class="attr">matchLabels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">matchExpressions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;key:</span> <span class="string">tier,</span> <span class="attr">operator:</span> <span class="string">In,</span> <span class="attr">values:</span> <span class="string">[frontend]&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;key:</span> <span class="string">environment,</span> <span class="attr">operator:</span> <span class="string">NotIn,</span> <span class="attr">values:</span> <span class="string">[dev]&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果同时设置了matchLabels和matchExpressions，则两组条件为AND关系。</p>
<p>Label Selector在Kubernetes中的重要使用场景如下。</p>
<ul>
<li>kube-controller进程通过在资源对象RC上定义的Label Selector来筛选要监控的Pod副本数量，使Pod副本数量始终符合预期设定的全自动控制流程。</li>
<li>kube-proxy进程通过Service的Label Selector来选择对应的Pod，自动建立每个Service到对应Pod的请求转发路由表，从而实现Service的智能负载均衡机制。</li>
<li>通过对某些Node定义特定的Label，并且在Pod定义文件中使用NodeSelector这种标签调度策略，kube-scheduler进程可以实现Pod定向调度的特性。</li>
</ul>
<h3 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h3><p>Kubernetes里的每个Service其实就是我们经常提起的微服务架构中的一个微服务。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115174901221.png" alt="image-20201115174901221" style="zoom: 80%;"></p>
<p>Kubernetes的Service定义了一个服务的访问入口地址，前端的应用（Pod）通过这个入口地址访问其背后的一组由Pod副本组成的集群实例，Service与其后端Pod副本集群之间则是通过Label Selector来实现无缝对接的。</p>
<p>RC的作用实际上是保证Service的服务能力和服务质量始终符合预期标准。</p>
<p>运行在每个Node上的kube-proxy进程其实就是一个智能的软件负载均衡器，负责把对Service的请求转发到后端的某个Pod实例上，并在内部实现服务的负载均衡与会话保持机制。但Kubernetes发明了一种很巧妙又影响深远的设计：Service没有共用一个负载均衡器的IP地址，每个Service都被分配了一个全局唯一的虚拟IP地址，这个虚拟IP被称为Cluster IP。这样一来，每个服务就变成了具备唯一IP地址的通信节点，服务调用就变成了最基础的TCP网络通信问题。</p>
<p>Service一旦被创建，Kubernetes就会自动为它分配一个可用的Cluster IP，而且在Service的整个生命周期内，它的Cluster IP不会发生改变。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">tier:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115175558607.png" alt="image-20201115175558607" style="zoom: 67%;"></p>
<p>在spec.ports的定义中，targetPort属性用来确定提供该服务的容器所暴露（EXPOSE）的端口号，即具体业务进程在容器内的targetPort上提供TCP/IP接入；port属性则定义了Service的虚端口。前面定义Tomcat服务时没有指定targetPort，则默认targetPort与port相同。</p>
<p>Kubernetes Service支持多个Endpoint，在存在多个Endpoint的情况下，要求每个Endpoint都定义一个名称来区分。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">tomcat-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">service-port</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8005</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">shutdown-port</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">tier:</span> <span class="string">frontend</span></span><br></pre></td></tr></table></figure>
<font color="red">多端口为什么需要给每个端口都命名呢？</font>

<p>这就涉及Kubernetes的服务发现机制，Kubernetes通过Add-On增值包引入了DNS系统，把服务名作为DNS域名，这样程序就可以直接使用服务名来建立通信连接了。</p>
<p><strong>外部系统访问Service的问题</strong></p>
<p>为了更深入地理解和掌握Kubernetes，我们需要弄明白Kubernetes里的3种IP，这3种IP分别如下。</p>
<ul>
<li>Node IP：Node的IP地址</li>
<li>Pod IP：Pod的IP地址</li>
<li>Cluster IP：Service的IP地址</li>
</ul>
<p>Node IP是Kubernetes集群中每个节点的物理网卡的IP地址。</p>
<p>Pod IP是每个Pod的IP地址，它是Docker Engine根据docker0网桥的IP地址段进行分配的，通常是一个虚拟的二层网络。所以Kubernetes里一个Pod里的容器访问另外一个Pod里的容器时，就是通过Pod IP所在的<strong>虚拟二层网络</strong>进行通信的，而真实的TCP/IP流量是通过Node IP所在的物理网卡流出的。</p>
<p>Cluster IP，它也是一种虚拟的IP，但更像一个“伪造”的IP网络。</p>
<ul>
<li>Cluster IP仅仅作用于Kubernetes Service这个对象，并由Kubernetes管理和分配IP地址。</li>
<li>Cluster IP无法被Ping，因为没有一个“实体网络对象”来响应。</li>
<li>Cluster IP只能结合Service Port组成一个具体的通信端口，单独的Cluster IP不具备TCP/IP通信的基础，并且它们属于Kubernetes集群这样一个封闭的空间。</li>
</ul>
<p>Service的Cluster IP属于Kubernetes集群内部的地址，无法在集群外部直接使用这个地址。</p>
<font color="red">外部的应用或者用户怎么访问service？</font>

<p>采用NodePort是解决上述问题的最直接、有效的常见做法。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">nodePort:</span> <span class="number">30888</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">ui</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>
<p>NodePort的实现方式是在Kubernetes集群里的每个Node上都为需要外部访问的Service开启一个对应的TCP监听端口，外部系统只要用任意一个Node的IP地址+具体的NodePort端口号即可访问此服务。</p>
<p>NodePort还没有完全解决外部访问Service的所有问题，比如负载均衡问题。</p>
<p>如果我们的集群运行在公有云上，那么只要把Service的type=NodePort改为type=LoadBalancer，Kubernetes就会自动创建一个对应的Load balancer实例并返回它的IP地址供外部客户端使用。</p>
<h3 id="Replication-Controller"><a href="#Replication-Controller" class="headerlink" title="Replication Controller"></a>Replication Controller</h3><p>Replication Controller（简称RC）是Kubernetes系统中的核心概念之一，简单来说，它其实定义了一个期望的场景，即声明某种Pod的副本数量在任意时刻都符合某个预期值，所以RC的定义包括如下几个部分：</p>
<ul>
<li>Pod期待的副本数量</li>
<li>用于筛选目标Pod的Label Selector</li>
<li>当Pod的副本数量小于预期数量时，用于创建新Pod的Pod模板（template）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicationController</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">	<span class="attr">metadata:</span></span><br><span class="line">	  <span class="attr">labels:</span></span><br><span class="line">	  <span class="attr">app:</span> <span class="string">app-demo</span></span><br><span class="line">	  <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">	  <span class="attr">containers:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-demo</span></span><br><span class="line">	  <span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">	  <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">	  <span class="attr">env:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span></span><br><span class="line">		<span class="attr">value:</span> <span class="string">dns</span></span><br><span class="line">	  <span class="attr">ports:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>在定义一个RC并将其提交到Kubernetes集群中后，Master上的Controller Manager组件就得到通知，定期巡检系统中当前存活的目标Pod，并确保目标Pod实例的数量刚好等于此RC的期望值，如果有过多的Pod副本在运行，系统就会停掉一些Pod，否则系统会再自动创建一些Pod。</p>
<p>可以通过执行 kubectl scale 命令来实现Pod的动态缩放（Scaling）。删除RC并不会影响通过该RC已创建好的Pod。为了删除所有Pod，可以设置replicas的值为0，然后更新该RC。通过RC机制，Kubernetes很容易就实现了这种高级实用的特性，被称为“滚动升级” 。</p>
<p>RC目前已升级为另外一个新概念——Replica Set，官方解释其为“下一代的RC”。Replica Set与RC当前的唯一区别是，Replica Sets支持基于集合的Label selector（Set-based selector），而RC只支持基于等式的Label Selector（equality-based selector），这使得Replica Set的功能更强。</p>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>Deployment是Kubernetes在1.2版本中引入的新概念，用于更好地解决Pod的编排问题。为此，Deployment在内部使用了Replica Set来实现目的，无论从Deployment的作用与目的、YAML定义，还是从它的具体命令行操作来看，我们都可以把它看作RC的一次升级，两者的相似度超过90%。</p>
<p>Deployment相对于RC的一个最大升级是我们可以随时知道当前Pod“部署”的进度。实际上由于一个Pod的创建、调度、绑定节点及在目标Node上启动对应的容器这一完整过程需要一定的时间，所以我们期待系统启动N个Pod副本的目标状态，实际上是一个连续变化的“部署过程”导致的最终状态。</p>
<p>Deployment的典型使用场景有以下几个：</p>
<ul>
<li>创建一个Deployment对象来生成对应的Replica Set并完成Pod副本的创建</li>
<li>检查Deployment的状态来看部署动作是否完成（Pod副本数量是否达到预期的值）</li>
<li>更新Deployment以创建新的Pod（比如镜像升级）</li>
<li>如果当前Deployment不稳定，则回滚到一个早先的Deployment版本</li>
<li>暂停Deployment以便于一次性修改多个PodTemplateSpec的配置项，之后再恢复Deployment，进行新的发布</li>
<li>扩展Deployment以应对高负载</li>
<li><p>查看Deployment的状态，以此作为发布是否成功的指标</p>
</li>
<li><p>清理不再需要的旧版本ReplicaSets</p>
</li>
</ul>
<p>除了API声明与Kind类型等有所区别，Deployment的定义与Replica Set的定义很类似：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">frontend</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">	<span class="attr">matchLabels:</span></span><br><span class="line">	  <span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">	<span class="attr">matchExpressions:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="string">&#123;key:</span> <span class="string">tier,</span> <span class="attr">operator:</span> <span class="string">In,</span> <span class="attr">values:</span> <span class="string">[frontend]&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">	<span class="attr">metadata:</span></span><br><span class="line">	  <span class="attr">labels:</span></span><br><span class="line">		<span class="attr">app:</span> <span class="string">app-demo</span></span><br><span class="line">		<span class="attr">tier:</span> <span class="string">frontend</span></span><br><span class="line">	<span class="attr">spec:</span></span><br><span class="line">	  <span class="attr">containers:</span></span><br><span class="line">	  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat-demo</span></span><br><span class="line">		<span class="attr">image:</span> <span class="string">tomcat</span></span><br><span class="line">		<span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">		<span class="attr">ports:</span></span><br><span class="line">		<span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231530048.png" alt="image-20201114231530048" style="zoom: 80%;"></p>
<p>对上述输出中涉及的数量解释如下：</p>
<ul>
<li>DESIRED：Pod副本数量的期望值，即在Deployment里定义的Replica</li>
<li>CURRENT：当前Replica的值，实际上是Deployment创建的Replica Set里的Replica值，这个值不断增加，直到达到DESIRED为止，表明整个部署过程完成</li>
<li>UP-TO-DATE：最新版本的Pod的副本数量，用于指示在滚动升级的过程中，有多少个Pod副本已经成功升级</li>
<li>AVAILABLE：当前集群中可用的Pod副本数量，即集群中当前存活的Pod数量</li>
</ul>
<h4 id="演示-——-Deployment-扩容"><a href="#演示-——-Deployment-扩容" class="headerlink" title="演示 —— Deployment 扩容"></a>演示 —— Deployment 扩容</h4><p>扩容 myweb 为2个副本：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231740085.png" alt="image-20201114231740085"></p>
<p>扩容中 …</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231813394.png" alt="image-20201114231813394"></p>
<p>扩容完成</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114231851088.png" alt="image-20201114231851088"></p>
<p>为了区分访问的是哪个pod，可以进入容器修改 <code>myweb</code> 的html源码，比如可以将其中之一的 <code>h1</code> 标题增加 <code>(2)</code> 字样，保存后即可生效：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114232414808.png" alt="image-20201114232414808"></p>
<p>开2个窗口，多次刷新，会发现有时访问到的是<strong>修改版</strong>（右），有时访问到的是<strong>未修改版</strong>（左），说明扩容后的2个pod都能提供服务；并且被访问的几率差不多，这是service的负载均衡特性。这些符合预期。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114232526869.png" alt="image-20201114232526869"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114233931967.png" alt="image-20201114233931967" style="zoom: 67%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201114234101500.png" alt="image-20201114234101500" style="zoom: 67%;"></p>
<h3 id="Horizontal-Pod-Autoscaler"><a href="#Horizontal-Pod-Autoscaler" class="headerlink" title="Horizontal Pod Autoscaler"></a>Horizontal Pod Autoscaler</h3><p>通过手工执行 kubectl scale 命令，我们可以实现Pod扩容或缩容。如果仅仅到此为止，显然不符合谷歌对Kubernetes的定位目标——自动化、智能化。</p>
<p>Kubernetes从1.6版本开始，增强了根据应用自定义的指标进行自动扩容和缩容的功能，API版本为autoscaling/v2alpha1，并不断演进。</p>
<p>HPA与之前的RC、Deployment一样，也属于一种Kubernetes资源对象。</p>
<p>通过追踪分析指定RC控制的所有目标Pod的负载变化情况，来确定是否需要有针对性地调整目标Pod的副本数量，这是HPA的实现原理。当前，HPA有以下两种方式作为Pod负载的度量指标。</p>
<ul>
<li>CPUUtilizationPercentage</li>
<li>应用程序自定义的度量指标，比如服务在每秒内的相应请求数（TPS或QPS）</li>
</ul>
<p>CPUUtilizationPercentage 是一个算术平均值，即目标Pod所有副本自身的CPU利用率的平均值。</p>
<p>一个Pod自身的CPU利用率是该Pod当前CPU的使用量除以它的Pod Request的值。</p>
<p>在CPUUtilizationPercentage计算过程中使用到的Pod的CPU使用量通常是1min内的平均值。</p>
<p>如果目标Pod没有定义Pod Request的值，则无法使用CPUUtilizationPercentage实现Pod横向自动扩容。</p>
<p>Kubernetes从1.2版本开始也在尝试支持应用程序自定义的度量指标。</p>
<p>HPA示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">10</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">	<span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">	<span class="attr">name:</span> <span class="string">php-apache</span></span><br><span class="line">  <span class="attr">targetCPUUtilizationPercentage:</span> <span class="number">90</span></span><br></pre></td></tr></table></figure>
<p>等价于</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl autoscale deployment php-apache --cpu-percent=90--min=1--max=10</span><br></pre></td></tr></table></figure>
<h3 id="StatefulSet"><a href="#StatefulSet" class="headerlink" title="StatefulSet"></a>StatefulSet</h3><p>在Kubernetes系统中，Pod的管理对象RC、Deployment、DaemonSet和Job都面向无状态的服务。但现实中有很多服务是有状态的，特别是一些复杂的中间件集群，例如MySQL集群、MongoDB集群、Akka集群、ZooKeeper集群等，这些应用集群有4个共同点：</p>
<ul>
<li>每个节点都有固定的身份ID，通过这个ID，集群中的成员可以相互发现并通信。</li>
<li>集群的规模是比较固定的，集群规模不能随意变动。</li>
<li>集群中的每个节点都是有状态的，通常会持久化数据到永久存储中。</li>
<li>如果磁盘损坏，则集群里的某个节点无法正常运行，集群功能受损。</li>
</ul>
<p>如果通过RC或Deployment控制Pod副本数量来实现上述有状态的集群，就会发现第1点是无法满足的，因为Pod的名称是随机产生的，Pod的IP地址也是在运行期才确定且可能有变动的，我们事先无法为每个Pod都确定唯一不变的ID。</p>
<p>StatefulSet从本质上来说，可以看作Deployment/RC的一个特殊变种，它有如下特性：</p>
<ul>
<li><p>StatefulSet里的每个Pod都有稳定、唯一的网络标识，可以用来发现集群内的其他成员。假设StatefulSet的名称为kafka，那么第1个Pod叫kafka-0，第2个叫kafka-1，以此类推。</p>
</li>
<li><p>StatefulSet控制的Pod副本的启停顺序是受控的，操作第n个Pod时，前n-1个Pod已经是运行且准备好的状态。</p>
</li>
<li>StatefulSet里的Pod采用稳定的持久化存储卷，通过PV或PVC来实现，删除Pod时默认不会删除与StatefulSet相关的存储卷（为了保证数据的安全）。</li>
</ul>
<h3 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h3><p>在每个Node上都调度一个Pod。<br>DaemonSet 用于管理在集群中每个Node上仅运行一份Pod的副本实例。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115215750674.png" alt="image-20201115215750674" style="zoom:50%;"></p>
<p>使用场景：</p>
<ul>
<li>在每个Node上都运行一个GlusterFS存储或者Ceph存储的Daemon进程。</li>
<li>在每个Node上都运行一个日志采集程序，例如Fluentd或者Logstach。</li>
<li>在每个Node上都运行一个性能监控程序，采集该Node的运行性能数据，例如Prometheus Node Exporter、collectd、New Relic agent或者Ganglia gmond等。</li>
</ul>
<h3 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h3><p>批处理任务通常并行（或者串行）启动多个计算进程去处理一批工作项（work item），在处理完成后，整个批处理任务结束。</p>
<p>与RC、Deployment、ReplicaSet、DaemonSet类似，Job也控制一组Pod容器。从这个角度来看，Job也是一种特殊的Pod副本自动控制器。</p>
<p>（1）Job所控制的Pod副本是短暂运行的，可以将其视为一组Docker容器，其中的每个Docker容器都仅仅运行一次</p>
<p>（2）Job所控制的Pod副本的工作模式能够多实例并行计算</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115220103135.png" alt="image-20201115220103135"></p>
<h3 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h3><p>Volume（存储卷）是Pod中能够被多个容器访问的共享目录。</p>
<p>Kubernetes中的Volume与Pod的生命周期相同，但与容器的生命周期不相关，当容器终止或者重启时，Volume中的数据也不会丢失。</p>
<p>Volume的使用也比较简单，在大多数情况下，我们先在Pod上声明一个Volume，然后在容器里引用该Volume并挂载（Mount）到容器里的某个目录上。</p>
<p>Kubernetes提供了非常丰富的Volume类型，下面逐一进行说明：</p>
<p>1．emptyDir</p>
<p>一个emptyDir Volume是在Pod分配到Node时创建的。从它的名称就可以看出，它的初始内容为空，并且无须指定宿主机上对应的目录文件，因为这是Kubernetes自动分配的一个目录，当Pod从Node上移除时，emptyDir中的数据也会被永久删除。</p>
<p>emptyDir的一些用途如下：</p>
<ul>
<li>临时空间，例如用于某些应用程序运行时所需的临时目录，且无须永久保留。</li>
<li>长时间任务的中间过程CheckPoint的临时保存目录。</li>
<li>一个容器需要从另一个容器中获取数据的目录（多容器共享目录）。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">datavol</span></span><br><span class="line">	<span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br></pre></td></tr></table></figure>
<p>2．hostPath</p>
<p>hostPath为在Pod上挂载宿主机上的文件或目录，它通常可以用于以下几方面：</p>
<ul>
<li>容器应用程序生成的日志文件需要永久保存时，可以使用宿主机的高速文件系统进行存储。</li>
<li>需要访问宿主机上Docker引擎内部数据结构的容器应用时，可以通过定义hostPath为宿主机/var/lib/docker目录，使容器内部应用可以直接访问Docker的文件系统。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">"persistent-storage"</span></span><br><span class="line">  <span class="attr">hostPath:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">"/data"</span></span><br></pre></td></tr></table></figure>
<p>需要注意以下几点：</p>
<ul>
<li>在不同的Node上具有相同配置的Pod，可能会因为宿主机上的目录和文件不同而导致对Volume上目录和文件的访问结果不一致。</li>
<li>如果使用了资源配额管理，则Kubernetes无法将hostPath在宿主机上使用的资源纳入管理。</li>
</ul>
<p>3．NFS</p>
<p>使用NFS网络文件系统提供的共享目录存储数据时，我们需要在系统中部署一个NFS Server。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">	<span class="attr">server:</span> <span class="string">nfs服务器ip</span></span><br><span class="line">	<span class="attr">path:</span> <span class="string">"/"</span></span><br></pre></td></tr></table></figure>
<p>另外，configmap 和 secret 也可以volume来使用。</p>
<h3 id="Persistent-Volume"><a href="#Persistent-Volume" class="headerlink" title="Persistent Volume"></a>Persistent Volume</h3><p>之前提到的Volume是被定义在Pod上的，属于计算资源的一部分，而实际上，网络存储是相对独立于计算资源而存在的一种实体资源。</p>
<p>PV可以被理解成Kubernetes集群中的某个网络存储对应的一块存储，它与Volume类似，但有以下区别。</p>
<ul>
<li><p>PV只能是网络存储，不属于任何Node，但可以在每个Node上访问。</p>
</li>
<li><p>PV并不是被定义在Pod上的，而是独立于Pod之外定义的。</p>
</li>
<li>PV目前支持的类型包括：gcePersistentDisk、AWSElasticBlockStore、AzureFile、AzureDisk、FC（Fibre Channel）、Flocker、NFS、iSCSI、RBD（Rados Block Device）、CephFS、Cinder、GlusterFS、VsphereVolume、Quobyte Volumes、VMware Photon、Portworx Volumes、ScaleIO Volumes和HostPath（仅供单机测试）。</li>
</ul>
<p>NFS PV示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pv0003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">	<span class="attr">storage:</span> <span class="string">5Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">	<span class="attr">path:</span> <span class="string">/somepath</span></span><br><span class="line">	<span class="attr">server:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span></span><br></pre></td></tr></table></figure>
<p>PV的accessModes属性，目前有以下类型：</p>
<ul>
<li>ReadWriteOnce：读写权限，并且只能被单个Node挂载。</li>
<li>ReadOnlyMany：只读权限，允许被多个Node挂载。</li>
<li>ReadWriteMany：读写权限，允许被多个Node挂载。</li>
</ul>
<h3 id="Persistent-Volume-Claim"><a href="#Persistent-Volume-Claim" class="headerlink" title="Persistent Volume Claim"></a>Persistent Volume Claim</h3><p>如果某个Pod想申请某种类型的PV，则首先需要定义一个PersistentVolumeClaim对象：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myclaim</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">	<span class="attr">requests:</span></span><br><span class="line">	  <span class="attr">storage:</span> <span class="string">8Gi</span></span><br></pre></td></tr></table></figure>
<p>然后，在Pod的Volume定义中引用上述PVC</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypd</span></span><br><span class="line">  <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">    <span class="attr">claimName:</span> <span class="string">myclaim</span></span><br></pre></td></tr></table></figure>
<p>PV是有状态的对象，它的状态有以下几种：</p>
<ul>
<li>Available：空闲状态</li>
<li>Bound：已经绑定到某个PVC上</li>
<li>Released：对应的PVC已经被删除，但资源还没有被集群收回</li>
<li>Failed：PV自动回收失败。</li>
</ul>
<h3 id="Annotation"><a href="#Annotation" class="headerlink" title="Annotation"></a>Annotation</h3><p>Annotation（注解）与Label类似，也使用key/value键值对的形式进行定义。</p>
<p>不同的是Label具有严格的命名规则，它定义的是Kubernetes对象的元数据（Metadata），并且用于Label Selector。Annotation则是用户任意定义的附加信息，以便于外部工具查找。在很多时候，Kubernetes的模块自身会通过Annotation标记资源对象的一些特殊信息。</p>
<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><p>我们知道，Docker通过将程序、依赖库、数据及配置文件“打包固化”到一个不变的镜像文件中的做法，解决了应用的部署的难题，但这同时带来了棘手的问题，即配置文件中的参数在运行期如何修改的问题。</p>
<p>为了解决这个问题，Docker提供了两种方式：</p>
<ul>
<li>在运行时通过容器的环境变量来传递参数</li>
<li>通过Docker Volume将容器外的配置文件映射到容器内</li>
</ul>
<p>我们都希望能集中管理系统的配置参数，而不是管理一堆配置文件。</p>
<p>K8s把所有的配置项都当作key-value字符串，这些配置项可以作为Map表中的一个项，整个Map的数据可以被持久化存储在Kubernetes的etcd数据库中，然后提供API以方便Kubernetes相关组件或客户应用CRUD操作这些数据，上述专门用来保存配置参数的Map就是Kubernetes ConfigMap资源对象。</p>
<p>Kubernetes提供了一种内建机制，将存储在etcd中的ConfigMap通过Volume映射的方式变成目标Pod内的配置文件。</p>
<p>不管目标Pod被调度到哪台服务器上，都会完成自动映射。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115201737742.png" alt="image-20201115201737742" style="zoom: 67%;"></p>
<p>ConfigMap供容器使用的典型用途如下：</p>
<ul>
<li>生成为容器内的环境变量</li>
<li>设置容器启动命令的启动参数（需设置为环境变量）</li>
<li>以Volume的形式挂载为容器内部的文件或目录</li>
</ul>
<p>容器应用对ConfigMap的使用有以下两种方法：</p>
<ul>
<li>通过环境变量获取ConfigMap中的内容</li>
<li>通过Volume挂载的方式将ConfigMap中的内容挂载为容器内部的文件或目录</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cm-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">[</span> <span class="string">"/bin/sh"</span><span class="string">,</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"env | grep APP"</span> <span class="string">]</span></span><br><span class="line">    <span class="attr">env:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APPLOGLEVEL</span></span><br><span class="line">      <span class="attr">valueFrom:</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cm-appvars</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">apploglevel</span></span><br></pre></td></tr></table></figure>
<p>使用ConfigMap的限制条件如下：</p>
<ul>
<li><p>ConfigMap必须在Pod之前创建。</p>
</li>
<li><p>ConfigMap受Namespace限制，只有处于相同Namespace中的Pod才可以引用它。</p>
</li>
<li>ConfigMap中的配额管理还未能实现。</li>
<li>kubelet只支持可以被API Server管理的Pod使用ConfigMap。kubelet在本Node上通过–manifest-url或–config自动创建的静态Pod将无法引用ConfigMap。</li>
<li>在Pod对ConfigMap进行挂载（volumeMount）操作时，在容器内部只能挂载为“目录”，无法挂载为“文件”。</li>
</ul>
<h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><p>Role-Based Access Control，基于角色的访问控制。</p>
<p>RBAC引入了4个新的顶级资源对象： Role 、 ClusterRole 、 RoleBinding和ClusterRoleBinding。</p>
<p>1）角色（Role）<br>一个角色就是一组权限的集合，这里的权限都是许可形式的，不存在拒绝的规则。在一个命名空间中，可以用角色来定义一个角色，如果是集群级别的，就需要使用ClusterRole了。</p>
<p>2）集群角色（ClusterRole）<br>集群角色除了具有和角色一致的命名空间内资源的管理能力，因其集群级别的范围，还可以用于以下特殊元素的授权：</p>
<ul>
<li>集群范围的资源，例如Node</li>
<li>非资源型的路径，例如“/healthz”</li>
<li>包含全部命名空间的资源，例如pods（用于kubectl get pods –all-namespaces这样的操作授权）</li>
</ul>
<p>3）角色绑定（RoleBinding）和集群角色绑定（ClusterRoleBinding）<br>角色绑定或集群角色绑定用来把一个角色绑定到一个目标上，绑定目标可以是User（用户）、Group（组）或者Service Account。使用RoleBinding为某个命名空间授权，使用ClusterRoleBinding为集群范围内授权。</p>
<p>RoleBinding可以引用Role进行授权。</p>
<p>RoleBinding也可以引用ClusterRole，对属于同一命名空间内ClusterRole定义的资源主体进行授权。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115213549982.png" alt="image-20201115213549982" style="zoom:50%;"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard-minimal</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br></pre></td></tr></table></figure>
<p>绑定cluster-admin意味着具有超级用户权限。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115214009131.png" alt="image-20201115214009131"></p>
<h3 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h3><p>用于将不同URL的访问请求转发到后端不同的Service，以实现<strong>HTTP层</strong>的业务路由机制</p>
<p>Kubernetes使用了一个Ingress策略定义和一个具体的Ingress Controller，两者结合并实现了一个完整的Ingress负载均衡器。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115220412264.png" alt="image-20201115220412264" style="zoom:50%;"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/v2-784c512e37755bcfd6c4ebb63dcbb866_720w.jpg" alt="img"></p>
<p>为使用Ingress，需要创建Ingress Controller（带一个默认backend服务）和Ingress策略设置来共同完成。</p>
<p>Ingress Controller有多种：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/v2-e11d1a3fef7f0bab2ce64a8f721360bd_r.jpg" alt="preview"></p>
<p>helm 安装 ingress-nginx</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx</span><br><span class="line">helm install my-release ingress-nginx/ingress-nginx</span><br></pre></td></tr></table></figure>
<p>traefik ingress 界面效果图</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108220655920.png" alt="image-20201108220655920"></p>
<h3 id="secret"><a href="#secret" class="headerlink" title="secret"></a>secret</h3><p>一个Secret Volume用于为Pod提供加密的信息，你可以将定义在Kubernetes中的Secret直接挂载为文件让Pod访问。Secret Volume是通过TMFS（内存文件系统）实现的，这种类型的Volume不会被持久化。</p>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><p>在Master上运行着以下关键进程：</p>
<ul>
<li>Kubernetes API Server（kube-apiserver）：提供了HTTP Rest接口的关键服务进程，是Kubernetes里所有资源的增、删、改、查等操作的唯一入口，也是集群控制的入口进程。</li>
<li>Kubernetes Controller Manager（kube-controller-manager）：Kubernetes里所有资源对象的自动化控制中心，可以将其理解为资源对象的“大总管”。</li>
<li>Kubernetes Scheduler（kube-scheduler）：负责资源调度（Pod调度）的进程，相当于公交公司的“调度室”。</li>
<li>ETCD：etcd服务通常部署在master节点上，Kubernetes里的所有资源对象的数据都被保存在etcd。</li>
</ul>
<p>在每个Node上都运行着以下关键进程：</p>
<ul>
<li>kubelet：负责Pod对应的容器的创建、启停等任务，同时与Master密切协作，实现集群管理的基本功能。-</li>
<li>kube-proxy：实现Kubernetes Service的通信与负载均衡机制的重要组件。</li>
<li>Docker Engine（docker）：Docker引擎，负责本机的容器创建和管理工作。</li>
</ul>
<h3 id="API-Server"><a href="#API-Server" class="headerlink" title="API Server"></a>API Server</h3><p>Kubernetes API Server的核心功能是提供Kubernetes各类资源对象（如Pod、RC、Service等）的增、删、改、查及Watch等HTTP Rest接口，成为集群内各个功能模块之间数据交互和通信的中心枢纽，是整个系统的数据总线和数据中心。</p>
<p>除此之外，它还有以下一些功能特性：<br>（1）是集群管理的API入口。<br>（2）是资源配额控制的入口。<br>（3）提供了完备的集群安全机制。</p>
<p>通过命令行工具kubectl来与Kubernetes API Server交互，它们之间的接口是RESTful API。</p>
<p><strong>API Server架构解析</strong></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115221020820.png" alt="image-20201115221020820"></p>
<p>（1）API层：主要以REST方式提供各种API接口，除了有Kubernetes资源对象的CRUD和Watch等主要API，还有健康检查、UI、日志、性能指标等运维监控相关的API。Kubernetes从1.11版本开始废弃Heapster监控组件，转而使用Metrics Server提供Metrics API接口，进一步完善了自身的监控能力。<br>（2）访问控制层：当客户端访问API接口时，访问控制层负责对用户身份鉴权，验明用户身份，核准用户对Kubernetes资源对象的访问权限，然后根据配置的各种资源访问许可逻辑（Admission Control），判断是否允许访问。<br>（3）注册表层：Kubernetes把所有资源对象都保存在注册表（Registry）中，针对注册表中的各种资源对象都定义了：资源对象的类型、如何创建资源对象、如何转换资源的不同版本，以及如何将资源编码和解码为JSON或ProtoBuf格式进行存储。<br>（4）etcd数据库：用于持久化存储Kubernetes资源对象的KV数据库。etcd的watch API接口对于API Server来说至关重要，因为通过这个接口，API Server创新性地设计了List-Watch这种高性能的资源对象实时同步机制，使Kubernetes可以管理超大规模的集群，及时响应和快速处理集群中的各种事件。</p>
<h3 id="Controller-Manager"><a href="#Controller-Manager" class="headerlink" title="Controller Manager"></a>Controller Manager</h3><p>一般来说，智能系统和自动系统通常会通过一个“操作系统”来不断修正系统的工作状态。在Kubernetes集群中，每个Controller都是这样的一个“操作系统”，它们通过API Server提供的（List-Watch）接口实时监控集群中特定资源的状态变化，当发生各种故障导致某资源对象的状态发生变化时，Controller会尝试将其状态调整为期望的状态。比如当某个Node意外宕机时，Node Controller会及时发现此故障并执行自动化修复流程，确保集群始终处于预期的工作状态。Controller Manager是Kubernetes中各种操作系统的管理者，是集群内部的管理控制中心，也是Kubernetes自动化功能的核心。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230301979.png" alt="image-20201115230301979"></p>
<h3 id="Scheduler"><a href="#Scheduler" class="headerlink" title="Scheduler"></a>Scheduler</h3><p>前面深入分析了Controller Manager及它所包含的各个组件的运行机制，本节将继续对Kubernetes中负责Pod调度的重要功能模块——Kubernetes Scheduler的工作原理和运行机制做深入分析。</p>
<p>Kubernetes Scheduler在整个系统中承担了“承上启下”的重要功能，“承上”是指它负责接收Controller Manager创建的新Pod，为其安排一个落脚的“家”——目标Node；“启下”是指安置工作完成后，目标Node上的kubelet服务进程接管后继工作，负责Pod生命周期中的“下半生”。</p>
<p>具体来说，Kubernetes Scheduler的作用是将待调度的Pod（API新创建的Pod、Controller Manager为补足副本而创建的Pod等）按照特定的调度算法和调度策略绑定（Binding）到集群中某个合适的Node上，并将绑定信息写入etcd中。在整个调度过程中涉及三个对象，分别是待调度Pod列表、可用Node列表，以及调度算法和策略。简单地说，就是通过调度算法调度为待调度Pod列表中的每个Pod从Node列表中选择一个最适合的Node。</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230446082.png" alt="image-20201115230446082" style="zoom:67%;"></p>
<p>随后，目标节点上的kubelet通过API Server监听到Kubernetes Scheduler产生的Pod绑定事件，然后获取对应的Pod清单，下载Image镜像并启动容器。</p>
<p>Kubernetes Scheduler当前提供的默认调度流程分为以下两步：<br>（1）预选调度过程，即遍历所有目标Node，筛选出符合要求的候选节点。为此，Kubernetes内置了多种预选策略（xxx Predicates）供用户选择。<br>（2）确定最优节点，在第1步的基础上，采用优选策略（xxx Priority）计算出每个候选节点的积分，积分最高者胜出。</p>
<h3 id="kubelet"><a href="#kubelet" class="headerlink" title="kubelet"></a>kubelet</h3><p>在Kubernetes集群中，在每个Node（又称Minion）上都会启动一个kubelet服务进程。该进程用于处理Master下发到本节点的任务，管理Pod及Pod中的容器。每个kubelet进程都会在API Server上注册节点自身的信息，定期向Master汇报节点资源的使用情况，并通过cAdvisor监控容器和节点资源。</p>
<h3 id="kube-proxy"><a href="#kube-proxy" class="headerlink" title="kube-proxy"></a>kube-proxy</h3><p>我们在前面已经了解到，为了支持集群的水平扩展、高可用性，Kubernetes抽象出了Service的概念。Service是对一组Pod的抽象，它会根据访问策略（如负载均衡策略）来访问这组Pod。</p>
<p>Kubernetes在创建服务时会为服务分配一个虚拟的IP地址，客户端通过访问这个虚拟的IP地址来访问服务，服务则负责将请求转发到后端的Pod上。这不就是一个反向代理吗？没错，这就是一个反向代理。但是，它和普通的反向代理有一些不同：首先，它的IP地址是虚拟的，想从外面访问还需要一些技巧；其次，它的部署和启停是由Kubernetes统一自动管理的。</p>
<p>在很多情况下，Service只是一个概念，而真正将Service的作用落实的是它背后的kube-proxy服务进程。只有理解了kube-proxy的原理和机制，我们才能真正理解Service背后的实现逻辑。</p>
<p>在Kubernetes集群的每个Node上都会运行一个kube-proxy服务进程，我们可以把这个进程看作Service的透明代理兼负载均衡器，其核心功能是将到某个Service的访问请求转发到后端的多个Pod实例上。此外，Service的Cluster IP与NodePort等概念是kube-proxy服务通过iptables的NAT转换实现的，kube-proxy在运行过程中动态创建与Service相关的iptables规则，这些规则实现了将访问服务（Cluster IP或NodePort）的请求负载分发到后端Pod的功能。由于iptables机制针对的是本地的kube-proxy端口，所以在每个Node上都要运行kube-proxy组件，这样一来，在Kubernetes集群内部，我们可以在任意Node上发起对Service的访问请求。综上所述，由于kube-proxy的作用，在Service的调用过程中客户端无须关心后端有几个Pod，中间过程的通信、负载均衡及故障恢复都是透明的。</p>
<p>起初，kube-proxy进程是一个真实的TCP/UDP代理，类似HA Proxy，负责从Service到Pod的访问流量的转发，这种模式被称为userspace（用户空间代理）模式。如图5.13所示，当某个Pod以Cluster IP方式访问某个Service的时候，这个流量会被Pod所在本机的iptables转发到本机的kube-proxy进程，然后由kube-proxy建立起到后端Pod的TCP/UDP连接，随后将请求转发到某个后端Pod上，并在这个过程中实现负载均衡功能。</p>
<p>图：Service的负载均衡转发规则</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115230811684.png" alt="image-20201115230811684"></p>
<h1 id="案例-——-部署myweb至K8s"><a href="#案例-——-部署myweb至K8s" class="headerlink" title="案例 —— 部署myweb至K8s"></a>案例 —— 部署myweb至K8s</h1><h2 id="重制镜像"><a href="#重制镜像" class="headerlink" title="重制镜像"></a>重制镜像</h2><p>之前我们是使用docker运行myweb这个demo的，并且为了简单，将mysql的用户名、密码写死在settings.py里了。</p>
<p>现在改成如下，让name, user, password, host, port分别从环境变量DB_NAME, DB_USER, DB_PASSWORD, DB_HOST, DB_PORT 获取。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123; </span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: os.environ.get(<span class="string">'DB_NAME'</span>),</span><br><span class="line">        <span class="string">'USER'</span>: os.environ.get(<span class="string">'DB_USER'</span>)</span><br><span class="line">        <span class="string">'PASSWORD'</span>: os.environ.get(<span class="string">'DB_PASSWORD'</span>),</span><br><span class="line">        <span class="string">'HOST'</span>: os.environ.get(<span class="string">'DB_HOST'</span>),</span><br><span class="line">        <span class="string">'PORT'</span>: os.environ.get(<span class="string">'DB_PORT'</span>),</span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重新制作镜像 myweb:0.2，并上传至 harbor。</p>
<p>涉及到环境变量的传递，可以通过docker-compose验证一下新镜像是否正常。</p>
<p>docker-compose.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@localhost</span> <span class="string">demo]#</span> <span class="string">cat</span> <span class="string">docker-compose.yml</span> </span><br><span class="line"><span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">myweb:0.2</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">DB_NAME:</span> <span class="string">"testpv"</span></span><br><span class="line">      <span class="attr">DB_USER:</span> <span class="string">"root"</span></span><br><span class="line">      <span class="attr">DB_PASSWORD:</span> <span class="string">"mysql"</span></span><br><span class="line">      <span class="attr">DB_HOST:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.13</span></span><br><span class="line">      <span class="attr">DB_PORT:</span> <span class="number">3306</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="comment">#command: ['']</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/opt/log:/var/log</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8009</span><span class="string">:8000</span></span><br></pre></td></tr></table></figure>
<p>测试没问题：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost demo]<span class="comment"># docker-compose up -d</span></span><br><span class="line">Creating demo_db_1 ... <span class="keyword">done</span></span><br><span class="line">[root@localhost demo]<span class="comment"># docker-compose ps</span></span><br><span class="line">  Name                 Command               State           Ports         </span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">demo_db_1   supervisord -n -c /etc/sup ...   Up      0.0.0.0:8009-&gt;8000/tcp</span><br><span class="line">[root@localhost demo]<span class="comment"># curl http://localhost:8009/visit/add/</span></span><br><span class="line"></span><br><span class="line">&lt;link rel=<span class="string">"stylesheet"</span> <span class="built_in">type</span>=<span class="string">"text/css"</span> href=<span class="string">"/static/visit/style.css"</span>/&gt;</span><br><span class="line">&lt;div&gt;</span><br><span class="line">    &lt;table class=<span class="string">"gridtable"</span>&gt;</span><br><span class="line">        &lt;thead&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;th&gt;ID&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;date&lt;/th&gt;</span><br><span class="line">            &lt;th&gt;ip_addr&lt;/th&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;/thead&gt;</span><br><span class="line">        &lt;tbody&gt;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;47&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;2020-11-08 11:55:56&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;172.17.0.1&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">        &lt;/tbody&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>另外，也可以直接通过docker run启动，–env-file加载环境变量：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost demo]<span class="comment"># cat env</span></span><br><span class="line">DB_NAME=testpv</span><br><span class="line">DB_USER=root</span><br><span class="line">DB_PASSWORD=mysql</span><br><span class="line">DB_HOST=172.17.0.13</span><br><span class="line">DB_PORT=3306</span><br><span class="line">[root@localhost demo]<span class="comment"># docker run -d --name myweb -p 8009:8000 --env-file=env myweb:0.2</span></span><br></pre></td></tr></table></figure>
<h2 id="推送镜像至harbor"><a href="#推送镜像至harbor" class="headerlink" title="推送镜像至harbor"></a>推送镜像至harbor</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost demo]<span class="comment"># docker tag myweb:0.2 harbor.lzzeng.cn/devops/myweb:0.2</span></span><br><span class="line">[root@localhost demo]<span class="comment"># docker image ls myweb</span></span><br><span class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">myweb               0.2                 0245c29d6060        25 minutes ago      325MB</span><br><span class="line">[root@localhost demo]<span class="comment"># docker image ls |grep myweb</span></span><br><span class="line">myweb                            0.2                              0245c29d6060        25 minutes ago      325MB</span><br><span class="line">harbor.lzzeng.cn/devops/myweb    0.2                              0245c29d6060        25 minutes ago      325MB</span><br><span class="line">[root@localhost demo]<span class="comment"># </span></span><br><span class="line">[root@localhost demo]<span class="comment"># docker push harbor.lzzeng.cn/devops/myweb:0.2</span></span><br><span class="line">The push refers to repository [harbor.lzzeng.cn/devops/myweb]</span><br><span class="line">7615e9027750: Pushed </span><br><span class="line">8daa36f6b1b1: Pushed </span><br><span class="line">c4b9879e46c2: Pushed </span><br><span class="line">879c0d8666e3: Mounted from devops/alerts </span><br><span class="line">20a7b70bdf2f: Mounted from devops/alerts </span><br><span class="line">3fc750b41be7: Mounted from devops/alerts </span><br><span class="line">beee9f30bc1f: Mounted from devops/alerts </span><br><span class="line">0.2: digest: sha256:4a74959ea51a5834436ecda47f9e9d461d4ec43a68ff1976c555dc6ba2878842 size: 1788</span><br></pre></td></tr></table></figure>
<p>在Harbor上可以看到：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108202423148.png" alt="image-20201108202423148"></p>
<h2 id="创建K8s资源对象"><a href="#创建K8s资源对象" class="headerlink" title="创建K8s资源对象"></a>创建K8s资源对象</h2><p>假设我们仍使用已经独立部署好的mysql，现在只需要写myweb的k8s部署文件。</p>
<h3 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h3><p>先来创建一个namespace</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 myweb]<span class="comment"># kubectl create ns myweb</span></span><br><span class="line">namespace/myweb created</span><br></pre></td></tr></table></figure>
<h3 id="configmap"><a href="#configmap" class="headerlink" title="configmap"></a>configmap</h3><p>由于用到了supervisor，将其配置文件创建为一个configmap</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 myweb]<span class="comment"># ls</span></span><br><span class="line">myweb_supervisord.conf</span><br><span class="line">[root@m01 myweb]<span class="comment"># </span></span><br><span class="line">[root@m01 myweb]<span class="comment"># #创建configmap</span></span><br><span class="line">[root@m01 myweb]<span class="comment"># </span></span><br><span class="line">[root@m01 myweb]<span class="comment"># kubectl create -n myweb configmap myweb-supervisord-conf --from-file=myweb_supervisord.conf</span></span><br><span class="line">configmap/myweb-supervisord-conf created</span><br><span class="line">[root@m01 myweb]<span class="comment"># </span></span><br><span class="line">[root@m01 myweb]<span class="comment"># kubectl get cm -n myweb</span></span><br><span class="line">NAME                     DATA   AGE</span><br><span class="line">myweb-supervisord-conf   1      7s</span><br><span class="line">[root@m01 myweb]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>通过–from-file参数创建的myweb-supervisord-conf内容如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span></span><br><span class="line"><span class="comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span></span><br><span class="line"><span class="comment"># reopened with the relevant failures.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">data:</span><br><span class="line">  myweb_supervisord.conf: |</span><br><span class="line">    [program:myweb]</span><br><span class="line">    <span class="built_in">command</span>=/usr/<span class="built_in">local</span>/bin/python manage.py runserver 0.0.0.0:8000</span><br><span class="line">    directory=/opt/apps/myweb</span><br><span class="line">    user=root</span><br><span class="line">    startsecs=3</span><br><span class="line">    redirect_stderr=<span class="literal">true</span></span><br><span class="line">    stdout_logfile_maxbytes=20MB</span><br><span class="line">    stdout_logfile_backups=3</span><br><span class="line">    stdout_logfile=/var/<span class="built_in">log</span>/myweb_supervisor.log</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  creationTimestamp: <span class="string">"2020-11-08T10:11:46Z"</span></span><br><span class="line">  name: myweb-supervisord-conf</span><br><span class="line">  namespace: myweb</span><br><span class="line">  resourceVersion: <span class="string">"1135081"</span></span><br><span class="line">  selfLink: /api/v1/namespaces/myweb/configmaps/myweb-supervisord-conf</span><br><span class="line">  uid: 42cd4d5c-48c4-4845-b1a9-102eb78f591a</span><br></pre></td></tr></table></figure>
<p>也可以直接写一个yaml文件：</p>
<p>myweb-supervisord-conf.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">myweb_supervisord.conf:</span> <span class="string">|</span></span><br><span class="line">    <span class="string">[program:myweb]</span></span><br><span class="line">    <span class="string">command=/usr/local/bin/python</span> <span class="string">manage.py</span> <span class="string">runserver</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">:8000</span></span><br><span class="line">    <span class="string">directory=/opt/apps/myweb</span></span><br><span class="line">    <span class="string">user=root</span></span><br><span class="line">    <span class="string">startsecs=3</span></span><br><span class="line">    <span class="string">redirect_stderr=true</span></span><br><span class="line">    <span class="string">stdout_logfile_maxbytes=20MB</span></span><br><span class="line">    <span class="string">stdout_logfile_backups=3</span></span><br><span class="line">    <span class="string">stdout_logfile=/var/log/myweb_supervisor.log</span></span><br></pre></td></tr></table></figure>
<p>然后</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -n myweb configmap myweb-supervisord-conf -f myweb-supervisord-conf.yml</span><br></pre></td></tr></table></figure>
<h3 id="secret-1"><a href="#secret-1" class="headerlink" title="secret"></a>secret</h3><p>假设mysql连接参数如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user=root</span><br><span class="line">password=mysql</span><br><span class="line">host=192.168.100.200</span><br><span class="line">port=3306</span><br><span class="line">name=testpv</span><br></pre></td></tr></table></figure>
<p>可以通过命令行带参数的方式创建一个secret</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 myweb]<span class="comment"># kubectl create -n myweb secret generic db-secret --from-literal=name=testpv --from-literal=user=root --from-literal=host=192.168.100.200 --from-literal=port=3306 --from-literal=password=mysql</span></span><br><span class="line">secret/db-secret created</span><br></pre></td></tr></table></figure>
<p>也可以先编写一个secret文件（data字段采用base64编码），再创建secret</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">MTkyLjE2OC4xMDAuMjAwCg==</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dGVzdHB2</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">bXlzcWwK</span></span><br><span class="line">  <span class="attr">port:</span> <span class="string">MzMwNg==</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">cm9vdA==</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br></pre></td></tr></table></figure>
<p>从dashboard可以看到创建的保密字典db-secret内容：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201109005053678.png" alt="image-20201109005053678"></p>
<h3 id="deployment、service和ingress"><a href="#deployment、service和ingress" class="headerlink" title="deployment、service和ingress"></a>deployment、service和ingress</h3><p>myweb-dep.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">harbor.lzzeng.cn/devops/myweb:0.2</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">1</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1000Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">0.5</span> </span><br><span class="line">            <span class="attr">memory:</span> <span class="string">500Mi</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_NAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_USER</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">user</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PASSWORD</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">password</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_HOST</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">host</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">DB_PORT</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">db-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">port</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">ui</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br></pre></td></tr></table></figure>
<p>myweb-svc.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">ui</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30888</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure>
<p>myweb-ing.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">myweb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">myweb.lzzeng.cn</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">serviceName:</span> <span class="string">myweb</span></span><br><span class="line">          <span class="attr">servicePort:</span> <span class="number">8000</span></span><br></pre></td></tr></table></figure>
<h3 id="kubectl-create"><a href="#kubectl-create" class="headerlink" title="kubectl create"></a>kubectl create</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -n myweb -f myweb-def.yml</span><br><span class="line">kubectl create -n myweb -f myweb-svc.yml</span><br><span class="line">kubectl create -n myweb -f myweb-ing.yml</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108203029458.png" alt="image-20201108203029458"></p>
<p>是deployment文件中secret名称写错了，修改myweb-dep.yml，更新后正常：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -n myweb -f myweb-def.yml</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108213925801.png" alt="image-20201108213925801"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108234036126.png" alt="image-20201108234036126"></p>
<h1 id="使用-helm-与-harbor"><a href="#使用-helm-与-harbor" class="headerlink" title="使用 helm 与 harbor"></a>使用 helm 与 harbor</h1><p>helm是K8s的chart管理工具, harbor是docker镜像、helm charts托管平台。</p>
<h2 id="使用helm"><a href="#使用helm" class="headerlink" title="使用helm"></a>使用helm</h2><p>helm安装prometheus</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115001019175.png" alt="image-20201115001019175"></p>
<p>grafana效果图</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115022804654.png" alt="image-20201115022804654"></p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201115173012548.png" alt="image-20201115173012548"></p>
<p>编写helm chart，推送至harbor命令：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm create mychart</span><br><span class="line"><span class="comment"># 编写...</span></span><br><span class="line">helm push -u xxx -p xxxxxx  ./  &lt;上传至chart项目地址&gt;</span><br></pre></td></tr></table></figure>
<p>helm部署ELK</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install elastic/elasticsearch -n elk-es --namespace elk</span><br></pre></td></tr></table></figure>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108222828848.png" alt="image-20201108222828848"></p>
<h2 id="使用harbor"><a href="#使用harbor" class="headerlink" title="使用harbor"></a>使用harbor</h2><blockquote>
<p>官方github：<a href="https://github.com/goharbor/harbor" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/goharbor/harbor</a></p>
<p>官方文档：<a href="https://goharbor.io/docs/2.0.0/install-config/" rel="external nofollow noopener noreferrer" target="_blank">https://goharbor.io/docs/2.0.0/install-config/</a></p>
</blockquote>
<p>创建自签名证书（一年期）：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ./tls.key -out ./tls.crt -subj <span class="string">"/CN=你的自定义harbor域名"</span></span><br></pre></td></tr></table></figure>
<p>harbor.yml配置示例：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108223522500.png" alt="image-20201108223522500"></p>
<p>Harbor要启用helm charts管理功能，在安装时要添加<code>--with-chartmuseum</code>参数：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./install.sh --with-chartmuseum</span><br></pre></td></tr></table></figure>
<p>Harbor的charts管理界面：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108164730437.png" alt="image-20201108164730437"></p>
<p>可以通过web界面上传打包好的chart，也可以使用helm push命令推送。</p>
<p>在使用时：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 添加repo</span></span><br><span class="line">helm repo add --ca-file &lt;ca file&gt; --cert-file &lt;cert file&gt; --key-file &lt;key file&gt;     --username &lt;username&gt; --password &lt;password&gt; &lt;repo name&gt; https://&lt;harbor地址&gt;/chartrepo/&lt;项目名称&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 获取chart包</span></span><br><span class="line"><span class="comment"># helm fetch &lt;项目名称&gt;/&lt;chart名称&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 直接使用chart安装部署至K8s</span></span><br><span class="line">helm install --name &lt;自定义部署名&gt; --namespace &lt;指定部署到哪个名称空间&gt; [其它选项] &lt;项目名称&gt;/&lt;chart名称&gt;</span><br></pre></td></tr></table></figure>
<p>Harbor的镜像仓库管理界面：</p>
<p><img src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/2020/docker-k8s.assets/image-20201108165325479.png" alt="image-20201108165325479"></p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><p><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/</a></p>
</li>
<li><p><a href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a></p>
</li>
<li><p><a href="https://github.com/goharbor/harbor" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/goharbor/harbor</a></p>
</li>
<li><p><a href="https://doc.traefik.io/traefik/" rel="external nofollow noopener noreferrer" target="_blank">https://doc.traefik.io/traefik/</a></p>
</li>
<li><p><a href="https://rancher.com/docs/rancher/v2.x/en/" rel="external nofollow noopener noreferrer" target="_blank">https://rancher.com/docs/rancher/v2.x/en/</a></p>
</li>
<li><p><a href="https://github.com/kubernetes-sigs" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/kubernetes-sigs</a></p>
</li>
<li><p><a href="https://zhuanlan.zhihu.com/p/109458069" rel="external nofollow noopener noreferrer" target="_blank">https://zhuanlan.zhihu.com/p/109458069</a></p>
</li>
<li><p><a href="https://kubernetes.github.io/ingress-nginx/deploy/" rel="external nofollow noopener noreferrer" target="_blank">https://kubernetes.github.io/ingress-nginx/deploy/</a></p>
</li>
</ol>
<hr>
<p>End</p>

      
    </div>
    
    
    

    

    

    
      <div>
        

      </div>
    	

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/K8s/" rel="tag"><i class="fa fa-tag"></i> K8s</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/python/python-pretty-column/" rel="next" title="Python整齐输出多列">
                <i class="fa fa-chevron-left"></i> Python整齐输出多列
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/Docker-learning/" rel="prev" title="Docker笔记">
                Docker笔记 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  

  
    <div class="comments" id="comments">
      <div id="lv-container" data-id="city" data-uid="MTAyMC80MjA1NC8xODYwMQ=="></div>
    </div>

  
  

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
      <div id="sidebar-dimmer"></div>
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="https://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://aly-zlz.oss-cn-shenzhen.aliyuncs.com/images/avatar.jpg" alt="Lz. Zeng">
            
              <p class="site-author-name" itemprop="name">Lz. Zeng</p>
              <p class="site-description motion-element" itemprop="description">Continuous Self-Improvement</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">104</span>
                  <span class="site-state-item-name">发布</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">28</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#安装K8s"><span class="nav-number">1.</span> <span class="nav-text">安装K8s</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#kubeadm"><span class="nav-number">1.1.</span> <span class="nav-text">kubeadm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rancher"><span class="nav-number">1.2.</span> <span class="nav-text">rancher</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rke"><span class="nav-number">1.3.</span> <span class="nav-text">rke</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#kubespray"><span class="nav-number">1.4.</span> <span class="nav-text">kubespray</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装-kubernetes-dashboard"><span class="nav-number">2.</span> <span class="nav-text">安装 kubernetes dashboard</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#K8s基础"><span class="nav-number">3.</span> <span class="nav-text">K8s基础</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#基础概念"><span class="nav-number">3.1.</span> <span class="nav-text">基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod"><span class="nav-number">3.1.1.</span> <span class="nav-text">Pod</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Namespace"><span class="nav-number">3.1.2.</span> <span class="nav-text">Namespace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Label"><span class="nav-number">3.1.3.</span> <span class="nav-text">Label</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Service"><span class="nav-number">3.1.4.</span> <span class="nav-text">Service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Replication-Controller"><span class="nav-number">3.1.5.</span> <span class="nav-text">Replication Controller</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Deployment"><span class="nav-number">3.1.6.</span> <span class="nav-text">Deployment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#演示-——-Deployment-扩容"><span class="nav-number">3.1.6.1.</span> <span class="nav-text">演示 —— Deployment 扩容</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Horizontal-Pod-Autoscaler"><span class="nav-number">3.1.7.</span> <span class="nav-text">Horizontal Pod Autoscaler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StatefulSet"><span class="nav-number">3.1.8.</span> <span class="nav-text">StatefulSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DaemonSet"><span class="nav-number">3.1.9.</span> <span class="nav-text">DaemonSet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Job"><span class="nav-number">3.1.10.</span> <span class="nav-text">Job</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Volume"><span class="nav-number">3.1.11.</span> <span class="nav-text">Volume</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Persistent-Volume"><span class="nav-number">3.1.12.</span> <span class="nav-text">Persistent Volume</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Persistent-Volume-Claim"><span class="nav-number">3.1.13.</span> <span class="nav-text">Persistent Volume Claim</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Annotation"><span class="nav-number">3.1.14.</span> <span class="nav-text">Annotation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConfigMap"><span class="nav-number">3.1.15.</span> <span class="nav-text">ConfigMap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RBAC"><span class="nav-number">3.1.16.</span> <span class="nav-text">RBAC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ingress"><span class="nav-number">3.1.17.</span> <span class="nav-text">ingress</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#secret"><span class="nav-number">3.1.18.</span> <span class="nav-text">secret</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组件"><span class="nav-number">3.2.</span> <span class="nav-text">组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#API-Server"><span class="nav-number">3.2.1.</span> <span class="nav-text">API Server</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Controller-Manager"><span class="nav-number">3.2.2.</span> <span class="nav-text">Controller Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Scheduler"><span class="nav-number">3.2.3.</span> <span class="nav-text">Scheduler</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet"><span class="nav-number">3.2.4.</span> <span class="nav-text">kubelet</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kube-proxy"><span class="nav-number">3.2.5.</span> <span class="nav-text">kube-proxy</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#案例-——-部署myweb至K8s"><span class="nav-number">4.</span> <span class="nav-text">案例 —— 部署myweb至K8s</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#重制镜像"><span class="nav-number">4.1.</span> <span class="nav-text">重制镜像</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#推送镜像至harbor"><span class="nav-number">4.2.</span> <span class="nav-text">推送镜像至harbor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建K8s资源对象"><span class="nav-number">4.3.</span> <span class="nav-text">创建K8s资源对象</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#namespace"><span class="nav-number">4.3.1.</span> <span class="nav-text">namespace</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#configmap"><span class="nav-number">4.3.2.</span> <span class="nav-text">configmap</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#secret-1"><span class="nav-number">4.3.3.</span> <span class="nav-text">secret</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#deployment、service和ingress"><span class="nav-number">4.3.4.</span> <span class="nav-text">deployment、service和ingress</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubectl-create"><span class="nav-number">4.3.5.</span> <span class="nav-text">kubectl create</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#使用-helm-与-harbor"><span class="nav-number">5.</span> <span class="nav-text">使用 helm 与 harbor</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#使用helm"><span class="nav-number">5.1.</span> <span class="nav-text">使用helm</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用harbor"><span class="nav-number">5.2.</span> <span class="nav-text">使用harbor</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#参考"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lz. Zeng</span>
  
  
</div>






  <div class="theme-info"><i class="fa fa-life-ring" aria-hidden="true"></i><span></span>  NexT.Pisces</div>




<div class="theme-info">
  <span>&nbsp;|&nbsp;</span>
  <i class="fa fa-eye" aria-hidden="true"></i><span id="busuanzi_container_site_pv">&nbsp;<span id="busuanzi_value_site_pv">
  </span>&nbsp;</span>
  <i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">&nbsp;<span id="busuanzi_value_site_uv"></span>&nbsp;</span>
  <i class="fa fa-area-chart" aria-hidden="true"></i>
  <span class="post-count">Words: 97.2k</span>
</div>
        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/photoswipe.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/photoswipe-ui-default.js?v=5.1.4"></script>


  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  



  









  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
